C     MODULE            A  L  L  A  R  R           SUTRA VERSION 2.2     ALLARR.........100
C                                                                        ALLARR.........200
C *** PURPOSE :                                                          ALLARR.........300
C ***  TO DECLARE THE MAIN ALLOCATABLE ARRAYS.                           ALLARR.........400
C                                                                        ALLARR.........500
      MODULE ALLARR                                                      ALLARR.........600
      IMPLICIT NONE                                                      ALLARR.........700
      LOGICAL ALLO1, ALLO2, ALLO3                                        ALLARR.........800
      DOUBLE PRECISION, DIMENSION(:,:), ALLOCATABLE ::                   ALLARR.........900
     1   PMAT, UMAT                                                      ALLARR........1000
      DOUBLE PRECISION, DIMENSION(:), ALLOCATABLE ::                     ALLARR........1100
     1   PITER, UITER, PM1, DPDTITR, UM1, UM2, PVEL, SL, SR, X, Y, Z,    ALLARR........1200
     2   VOL, POR, CS1, CS2, CS3, SW, DSWDP, RHO, SOP, QIN, UIN, QUIN,   ALLARR........1300
     3   QINITR, RCIT, RCITM1, GNUP1, GNUU1                              ALLARR........1400
      DOUBLE PRECISION, DIMENSION(:), ALLOCATABLE ::                     ALLARR........1500
     1   PVEC, UVEC                                                      ALLARR........1600
      DOUBLE PRECISION, DIMENSION(:), ALLOCATABLE ::                     ALLARR........1700
     1   ALMAX, ALMIN, ATMAX, ATMIN, VMAG, VANG1,                        ALLARR........1800
     2   PERMXX, PERMXY, PERMYX, PERMYY, PANGL1                          ALLARR........1900
      DOUBLE PRECISION, DIMENSION(:), ALLOCATABLE ::                     ALLARR........2000
     1   ALMID, ATMID, VANG2, PERMXZ, PERMYZ,                            ALLARR........2100
     2   PERMZX, PERMZY, PERMZZ, PANGL2, PANGL3                          ALLARR........2200
      DOUBLE PRECISION, DIMENSION(:), ALLOCATABLE ::
     1   SM, SM1, WMA, SMA, POR1, REK, HAREA, VAREA, FAREA,DFR, PWFR,
     2   PCFR, TPT, QLX, QLY, YY, XX, QVYN,TPT1,
     3   HANN,VANN,FANN,HSS,QXF,QYF,SPF,RPF
      DOUBLE PRECISION, DIMENSION(:), ALLOCATABLE ::                     ALLARR........2300
     1   PBC, UBC, QPLITR                                                ALLARR........2400
      DOUBLE PRECISION, DIMENSION(:,:), ALLOCATABLE ::                   ALLARR........2500
     1   GXSI, GETA, GZET                                                ALLARR........2600
      DOUBLE PRECISION, DIMENSION(:), ALLOCATABLE ::                     ALLARR........2700
     1   FWK ,B                                                          ALLARR........2800
      INTEGER, DIMENSION(:), ALLOCATABLE ::                              ALLARR........2900
     1   IN, IQSOP, IQSOU, IPBC, IUBC,                                   ALLARR........3000
     2   NREG, LREG, IWK, IA, JA                                         ALLARR........3100
      INTEGER(1), DIMENSION(:), ALLOCATABLE ::                           ALLARR........3200
     1   IBCPBC, IBCUBC, IBCSOP, IBCSOU                                  ALLARR........3300
      INTEGER, DIMENSION(:), ALLOCATABLE :: 
     1   NDPT
      INTEGER, DIMENSION(:), ALLOCATABLE :: 
     1   NREF
      INTEGER, DIMENSION(:), ALLOCATABLE ::                              ALLARR........3400
     1   IIDPBC,IIDUBC,IIDSOP,IIDSOU                                     ALLARR........3500
      CHARACTER*40, DIMENSION(:), ALLOCATABLE ::                         ALLARR........3600
     1   CIDBCS                                                          ALLARR........3700
      LOGICAL, DIMENSION(:), ALLOCATABLE ::                              ALLARR........3800
     1   BCSFL, BCSTR                                                    ALLARR........3900
      TYPE OBSDAT                                                        ALLARR........4000
         CHARACTER*40 :: NAME                                            ALLARR........4100
         CHARACTER*10 :: SCHED                                           ALLARR........4200
         CHARACTER*3 :: FRMT                                             ALLARR........4300
         INTEGER :: L                                                    ALLARR........4400
         DOUBLE PRECISION :: X, Y, Z                                     ALLARR........4500
         DOUBLE PRECISION :: XSI, ETA, ZET                               ALLARR........4600
      END TYPE OBSDAT                                                    ALLARR........4700
      TYPE (OBSDAT), DIMENSION (:), ALLOCATABLE :: OBSPTS                ALLARR........4800
C.....ARRAY SCHDLS IS DECLARED IN MODULE SCHDEF.                         ALLARR........4900
C                                                                        ALLARR........5000
      END MODULE ALLARR                                                  ALLARR........5100
C                                                                        ALLARR........5200
C     MODULE            L  L  D  E  F              SUTRA VERSION 2.2     LLDEF..........100
C                                                                        LLDEF..........200
C *** PURPOSE :                                                          LLDEF..........300
C ***  TO DEFINE THE DERIVED TYPE "LLD" (LINKED LIST OF                  LLDEF..........400
C ***  DOUBLE-PRECISION NUMBERS).                                        LLDEF..........500
C                                                                        LLDEF..........600
      MODULE LLDEF                                                       LLDEF..........700
      IMPLICIT NONE                                                      LLDEF..........800
C                                                                        LLDEF..........900
C.....DEFINE DERIVED TYPE LLD (DOUBLE-PRECISION LINKED LIST) WITH        LLDEF.........1000
C        THREE COMPONENTS: DVALU1, DVALU2 (DOUBLE-PRECISION NUMBERS),    LLDEF.........1100
C        AND NENT (POINTER TO NEXT ENTRY).                               LLDEF.........1200
      TYPE LLD                                                           LLDEF.........1300
         DOUBLE PRECISION :: DVALU1, DVALU2                              LLDEF.........1400
         TYPE (LLD), POINTER :: NENT                                     LLDEF.........1500
      END TYPE LLD                                                       LLDEF.........1600
C                                                                        LLDEF.........1700
      END MODULE LLDEF                                                   LLDEF.........1800
C                                                                        LLDEF.........1900
C     MODULE            E  X  P  I  N  T           SUTRA VERSION 2.2     EXPINT.........100
C                                                                        EXPINT.........200
C *** PURPOSE :                                                          EXPINT.........300
C ***  TO PROVIDE EXPLICIT INTERFACES FOR PROCEDURES THAT NEED THEM.     EXPINT.........400
C                                                                        EXPINT.........500
      MODULE EXPINT                                                      EXPINT.........600
      IMPLICIT NONE                                                      EXPINT.........700
C                                                                        EXPINT.........800
C.....EXPLICIT INTERFACE FOR SUBROUTINE LLD2AR                           EXPINT.........900
      INTERFACE                                                          EXPINT........1000
         SUBROUTINE LLD2AR(LSTLEN, DLIST, DARR1, DARR2)                  EXPINT........1100
            USE LLDEF                                                    EXPINT........1200
            INTEGER LSTLEN                                               EXPINT........1300
            TYPE (LLD), POINTER :: DLIST                                 EXPINT........1400
            DOUBLE PRECISION DARR1(*), DARR2(*)                          EXPINT........1500
         END SUBROUTINE LLD2AR                                           EXPINT........1600
      END INTERFACE                                                      EXPINT........1700
C                                                                        EXPINT........1800
C.....EXPLICIT INTERFACE FOR SUBROUTINE LLDINS                           EXPINT........1900
      INTERFACE                                                          EXPINT........2000
         SUBROUTINE LLDINS(LSTLEN, DLIST, DNUM1, DNUM2, DLAST)           EXPINT........2100
            USE LLDEF                                                    EXPINT........2200
            INTEGER LSTLEN                                               EXPINT........2300
            TYPE (LLD), POINTER :: DEN, DENPV, DENNW, DLIST, DLAST       EXPINT........2400
            DOUBLE PRECISION DNUM1, DNUM2                                EXPINT........2500
         END SUBROUTINE LLDINS                                           EXPINT........2600
      END INTERFACE                                                      EXPINT........2700
C                                                                        EXPINT........2800
C.....EXPLICIT INTERFACE FOR FUNCTION PUSWF                              EXPINT........2900
      INTERFACE                                                          EXPINT........3000
         FUNCTION PUSWF(L,XLOC,YLOC,ZLOC,SFRAC,PM1,UM1,PVEC,UVEC,        EXPINT........3100
     1      IN,LREG)                                                     EXPINT........3200
            DOUBLE PRECISION PUSWF(3),XLOC,YLOC,ZLOC,SFRAC               EXPINT........3300
            DOUBLE PRECISION PM1(NN),UM1(NN),PVEC(NN),UVEC(NN)           EXPINT........3400
            INTEGER L,IN(NIN),LREG(NE)                                   EXPINT........3500
            INTEGER NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              EXPINT........3600
     1         NSOP,NSOU,NBCN                                            EXPINT........3700
            COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,        EXPINT........3800
     1         NSOP,NSOU,NBCN,NCIDB                                      EXPINT........3900
         END FUNCTION                                                    EXPINT........4000
      END INTERFACE                                                      EXPINT........4100
C                                                                        EXPINT........4200
C.....EXPLICIT INTERFACE FOR FUNCTION DP3STR                             EXPINT........4300
      INTERFACE                                                          EXPINT........4400
         FUNCTION DP3STR(DPA)                                            EXPINT........4500
         DOUBLE PRECISION DPA(3)                                         EXPINT........4600
         CHARACTER DP3STR*45                                             EXPINT........4700
         END FUNCTION                                                    EXPINT........4800
      END INTERFACE                                                      EXPINT........4900
C                                                                        EXPINT........5000
C.....EXPLICIT INTERFACE FOR SUBROUTINE READIF                           EXPINT........5100
      INTERFACE                                                          EXPINT........5200
         SUBROUTINE READIF(KUU, NFB, INTFIL, ERRIN, CHERIN)              EXPINT........5300
            PARAMETER (KINMIN=10)                                        EXPINT........5400
            CHARACTER INTFIL*1000                                        EXPINT........5500
            CHARACTER*80 ERRCOD,ERRIN,CHERR(10)                          EXPINT........5600
            CHARACTER*80, DIMENSION(10), OPTIONAL :: CHERIN              EXPINT........5700
            CHARACTER*80 UNAME,FNAME                                     EXPINT........5800
            CHARACTER ERRF*3, FINS*80                                    EXPINT........5900
            LOGICAL IS                                                   EXPINT........6000
            DIMENSION INERR(10),RLERR(10)                                EXPINT........6100
            DIMENSION IUNIT(0:13)                                        EXPINT........6200
            DIMENSION FNAME(0:13)                                        EXPINT........6300
            COMMON /FNAMES/ UNAME,FNAME                                  EXPINT........6400
            COMMON /FUNIB/ NFBCS                                         EXPINT........6500
            COMMON /FUNITA/ IUNIT                                        EXPINT........6600
            COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,           EXPINT........6700
     1         K10,K11,K12,K13                                           EXPINT........6800
            COMMON /OBS/ NOBSN,NTOBS,NOBCYC,NOBLIN,NFLOMX                EXPINT........6900
         END SUBROUTINE READIF                                           EXPINT........7000
      END INTERFACE                                                      EXPINT........7100
C                                                                        EXPINT........7200
      END MODULE EXPINT                                                  EXPINT........7300
C                                                                        EXPINT........7400
C     MODULE            P  T  R  D  E  F           SUTRA VERSION 2.2     PTRDEF.........100
C                                                                        PTRDEF.........200
C *** PURPOSE :                                                          PTRDEF.........300
C ***  TO DEFINE POINTERS AND ARRAYS NEEDED TO CONSTRUCT THE             PTRDEF.........400
C ***  IA AND JA ARRAYS.                                                 PTRDEF.........500
C                                                                        PTRDEF.........600
      MODULE PTRDEF                                                      PTRDEF.........700
      IMPLICIT NONE                                                      PTRDEF.........800
C.....DEFINE DERIVED TYPE LNKLST (LINKED LIST) WITH TWO COMPONENTS:      PTRDEF.........900
C        NODNUM (NODE NUMBER) AND NENT (POINTER TO NEXT ENTRY).          PTRDEF........1000
      TYPE LNKLST                                                        PTRDEF........1100
         INTEGER :: NODNUM                                               PTRDEF........1200
         TYPE (LNKLST), POINTER :: NENT                                  PTRDEF........1300
      END TYPE LNKLST                                                    PTRDEF........1400
C.....DECLARE DENT, DENTPV, DENTPI, AND DENTNW AS GENERAL-PURPOSE        PTRDEF........1500
C        POINTERS OF TYPE LNKLST.                                        PTRDEF........1600
      TYPE (LNKLST), POINTER :: DENT, DENTPV, DENTNW
C      TYPE (LNKLST), POINTER :: DENT, DENTPV, DENTPI, DENTNW             PTRDEF........1700
C.....DEFINE DERIVED TYPE IPOINT WITH ONE COMPONENT: A POINTER, PL,      PTRDEF........1800
C        OF TYPE LNKLST.                                                 PTRDEF........1900
      TYPE IPOINT                                                        PTRDEF........2000
         TYPE (LNKLST), POINTER :: PL                                    PTRDEF........2100
      END TYPE IPOINT                                                    PTRDEF........2200
C.....DECLARE HLIST, AN ARRAY OF POINTERS THAT WILL POINT TO THE HEAD    PTRDEF........2300
C        OF THE LINKED LIST OF NEIGHBORS FOR EACH NODE.                  PTRDEF........2400
      TYPE (IPOINT), ALLOCATABLE :: HLIST(:)                             PTRDEF........2500
C.....DECLARE ARRAY LLIST.                                               PTRDEF........2600
      INTEGER, DIMENSION(:), ALLOCATABLE :: LLIST                        PTRDEF........2700
C                                                                        PTRDEF........2800
      END MODULE PTRDEF                                                  PTRDEF........2900
C                                                                        PTRDEF........3000
C     MODULE            S  C  H  D  E  F           SUTRA VERSION 2.2     SCHDEF.........100
C                                                                        SCHDEF.........200
C *** PURPOSE :                                                          SCHDEF.........300
C ***  TO DEFINE POINTERS AND ARRAYS ASSOCIATED WITH SCHEDULES.          SCHDEF.........400
C                                                                        SCHDEF.........500
      MODULE SCHDEF                                                      SCHDEF.........600
      USE LLDEF                                                          SCHDEF.........700
      IMPLICIT NONE                                                      SCHDEF.........800
C                                                                        SCHDEF.........900
C.....DEFINE DERIVED TYPE SCHLST WITH FIVE COMPONENTS:                   SCHDEF........1000
C        NAME (SCHEDULE NAME)                                            SCHDEF........1100
C        LLEN (LIST LENGTH)                                              SCHDEF........1200
C        SLAST (POINTER TO TAIL OF LIST)                                 SCHDEF........1300
C        SLIST (POINTER TO HEAD OF LIST)                                 SCHDEF........1400
      TYPE SCHLST                                                        SCHDEF........1500
         CHARACTER*10 NAME                                               SCHDEF........1600
         INTEGER :: LLEN                                                 SCHDEF........1700
         TYPE (LLD), POINTER :: SLAST                                    SCHDEF........1800
         TYPE (LLD), POINTER :: SLIST                                    SCHDEF........1900
      END TYPE SCHLST                                                    SCHDEF........2000
C                                                                        SCHDEF........2100
C.....DECLARE SCHDLS, AN ARRAY OF INFORMATION ABOUT EACH SCHEDULE.       SCHDEF........2200
      TYPE (SCHLST), ALLOCATABLE :: SCHDLS(:)                            SCHDEF........2300
C                                                                        SCHDEF........2400
C.....DEFINE DERIVED TYPE OBSFM                                          SCHDEF........2500
      TYPE OBSFM                                                         SCHDEF........2600
         INTEGER :: ISCHED                                               SCHDEF........2700
         CHARACTER*3 :: FRMT                                             SCHDEF........2800
      END TYPE OBSFM                                                     SCHDEF........2900
C                                                                        SCHDEF........3000
C.....DEFINE DERIVED TYPE BCSFM                                          SCHDEF........3100
      TYPE BCSFM                                                         SCHDEF........3200
         INTEGER :: ISCHED                                               SCHDEF........3300
      END TYPE BCSFM                                                     SCHDEF........3400
C                                                                        SCHDEF........3500
C.....DECLARE MORE ARRAYS                                                SCHDEF........3600
      TYPE (OBSFM), ALLOCATABLE :: OFP(:)                                SCHDEF........3700
      TYPE (BCSFM), ALLOCATABLE :: BFP(:)                                SCHDEF........3800
      INTEGER, ALLOCATABLE :: IUNIO(:)                                   SCHDEF........3900
      CHARACTER*80, ALLOCATABLE :: FNAMO(:)                              SCHDEF........4000
      LOGICAL, ALLOCATABLE :: ONCK78(:)                                  SCHDEF........4100
C                                                                        SCHDEF........4200
      END MODULE SCHDEF                                                  SCHDEF........4300
C                                                                        SCHDEF........4400
C     MODULE            B  C  S  D  E  F           SUTRA VERSION 2.2     BCSDEF.........100
C                                                                        BCSDEF.........200
C *** PURPOSE :                                                          BCSDEF.........300
C ***  TO DEFINE ARRAYS ASSOCIATED WITH BCS FILES.                       BCSDEF.........400
C                                                                        BCSDEF.........500
      MODULE BCSDEF                                                      BCSDEF.........600
      USE LLDEF                                                          BCSDEF.........700
      IMPLICIT NONE                                                      BCSDEF.........800
C                                                                        BCSDEF.........900
C.....DECLARE ARRAYS                                                     BCSDEF........1000
      INTEGER, ALLOCATABLE :: IUNIB(:)                                   BCSDEF........1100
      CHARACTER*80, ALLOCATABLE :: FNAMB(:)                              BCSDEF........1200
      INTEGER, ALLOCATABLE :: LCNT(:)                                    BCSDEF........1300
      TYPE (LLD), ALLOCATABLE :: DENBCS(:)                               BCSDEF........1400
C                                                                        BCSDEF........1500
      END MODULE BCSDEF                                                  BCSDEF........1600
C                                                                        BCSDEF........1700
C     MODULE            F  I  N  D  E  F           SUTRA VERSION 2.2     FINDEF.........100
C                                                                        FINDEF.........200
C *** PURPOSE :                                                          FINDEF.........300
C ***  TO DEFINE ARRAYS ASSOCIATED FILE INSERTION.                       FINDEF.........400
C                                                                        FINDEF.........500
      MODULE FINDEF                                                      FINDEF.........600
      IMPLICIT NONE                                                      FINDEF.........700
C                                                                        FINDEF.........800
C.....DECLARE ARRAYS                                                     FINDEF.........900
      INTEGER, ALLOCATABLE :: NKS(:), KLIST(:,:)                         FINDEF........1000
      CHARACTER*80, ALLOCATABLE :: FNAIN(:,:)                            FINDEF........1100
C                                                                        FINDEF........1200
      END MODULE FINDEF                                                  FINDEF........1300


C     MAIN PROGRAM       S U T R A _ M A I N       SUTRA VERSION 2.2     SUTRA_MAIN.....100
C_______________________________________________________________________ SUTRA_MAIN.....200
C|                                                                     | SUTRA_MAIN.....300
C|                                                                     | SUTRA_MAIN.....400
C|                   UNITED STATES GEOLOGICAL SURVEY                   | SUTRA_MAIN.....500
C|          MODEL FOR SATURATED-UNSATURATED, VARIABLE-DENSITY          | SUTRA_MAIN.....600
C|          GROUND-WATER FLOW WITH SOLUTE OR ENERGY TRANSPORT          | SUTRA_MAIN.....700
C|                                                                     | SUTRA_MAIN.....800
C|                                                                     | SUTRA_MAIN.....900
C|                                                                     | SUTRA_MAIN....1000
C|                                                                     | SUTRA_MAIN....1100
C|                       _______________________                       | SUTRA_MAIN....1200
C|                      |                       |                      | SUTRA_MAIN....1300
C|                      |   S   U   T   R   A   |                      | SUTRA_MAIN....1400
C|                      |_______________________|                      | SUTRA_MAIN....1500
C|                                                                     | SUTRA_MAIN....1600
C|                                                                     | SUTRA_MAIN....1700
C|                Saturated    Unsaturated    TRAnsport                | SUTRA_MAIN....1800
C|                =            =              ===                      | SUTRA_MAIN....1900
C|                                                                     | SUTRA_MAIN....2000
C|                                                                     | SUTRA_MAIN....2100
C|                                                                     | SUTRA_MAIN....2200
C|    * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *    | SUTRA_MAIN....2300
C|    *                                                           *    | SUTRA_MAIN....2400
C|    *  PHYSICS OPTIONS:                                         *    | SUTRA_MAIN....2500
C|    *  -> Saturated and/or unsaturated ground-water flow        *    | SUTRA_MAIN....2600
C|    *  -> Either single species reactive solute transport       *    | SUTRA_MAIN....2700
C|    *     or thermal energy transport                           *    | SUTRA_MAIN....2800
C|    *  GEOMETRY OPTIONS:                                        *    | SUTRA_MAIN....2900
C|    *  -> Two-dimensional areal or cross-sectional simulation   *    | SUTRA_MAIN....3000
C|    *  -> Fully three-dimensional simulation                    *    | SUTRA_MAIN....3100
C|    *  -> Either two- or three-dimensional Cartesian or         *    | SUTRA_MAIN....3200
C|    *     two-dimensional radial coordinates                    *    | SUTRA_MAIN....3300
C|    *  NUMERICAL METHODS:                                       *    | SUTRA_MAIN....3400
C|    *  -> Hybrid Galerkin-finite-element method and             *    | SUTRA_MAIN....3500
C|    *     integrated-finite-difference method                   *    | SUTRA_MAIN....3600
C|    *     with two-dimensional quadrilateral or                 *    | SUTRA_MAIN....3700
C|    *     three-dimensional generalized hexahedral              *    | SUTRA_MAIN....3800
C|    *     finite elements                                       *    | SUTRA_MAIN....3900
C|    *  -> Finite-difference time discretization                 *    | SUTRA_MAIN....4000
C|    *  -> Nonlinear iterative, sequential or steady-state       *    | SUTRA_MAIN....4100
C|    *     solution modes                                        *    | SUTRA_MAIN....4200
C|    *  -> Direct and iterative solvers                          *    | SUTRA_MAIN....4300
C|    *  OUTPUT OPTIONS:                                          *    | SUTRA_MAIN....4400
C|    *  -> Optional fluid velocity calculation                   *    | SUTRA_MAIN....4500
C|    *  -> Optional observation well output                      *    | SUTRA_MAIN....4600
C|    *  -> Optional fluid mass and solute mass or energy budget  *    | SUTRA_MAIN....4700
C|    *  -> Flexible, columnwise output of solution               *    | SUTRA_MAIN....4800
C|    *                                                           *    | SUTRA_MAIN....4900
C|    * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *    | SUTRA_MAIN....5000
C|                                                                     | SUTRA_MAIN....5100
C|                                                                     | SUTRA_MAIN....5200
C|                                                                     | SUTRA_MAIN....5300
C|       Complete explanation of the function and use of this code     | SUTRA_MAIN....5400
C|       is given in :                                                 | SUTRA_MAIN....5500
C|                                                                     | SUTRA_MAIN....5600
C|       Voss, Clifford I., and Provost, Alden M., 2002,               | SUTRA_MAIN....5700
C|            SUTRA - A model for saturated-unsaturated                | SUTRA_MAIN....5800
C|            variable-density ground-water flow with                  | SUTRA_MAIN....5900
C|            solute or energy transport: U.S. Geological              | SUTRA_MAIN....6000
C|            Survey Water-Resources Investigations Report             | SUTRA_MAIN....6100
C|            02-4231, 291 p. (Version of Sept 22, 2010)               | SUTRA_MAIN....6200
C|                                                                     | SUTRA_MAIN....6300
C|                                                                     | SUTRA_MAIN....6400
C|                                                                     | SUTRA_MAIN....6500
C|       Users who wish to be notified of updates of the SUTRA         | SUTRA_MAIN....6600
C|       code and documentation may be added to the mailing list       | SUTRA_MAIN....6700
C|       by sending a request to :                                     | SUTRA_MAIN....6800
C|                                                                     | SUTRA_MAIN....6900
C|                           SUTRA Support                             | SUTRA_MAIN....7000
C|                       U.S. Geological Survey                        | SUTRA_MAIN....7100
C|                        411 National Center                          | SUTRA_MAIN....7200
C|                       Reston, Virginia 20192                        | SUTRA_MAIN....7300
C|                                USA                                  | SUTRA_MAIN....7400
C|                                                                     | SUTRA_MAIN....7500
C|    * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *    | SUTRA_MAIN....7600
C|    *                                                           *    | SUTRA_MAIN....7700
C|    *  The SUTRA code and documentation were originally         *    | SUTRA_MAIN....7800
C|    *  prepared under a joint research project of the U.S.      *    | SUTRA_MAIN....7900
C|    *  Geological Survey, Department of the Interior, Reston,   *    | SUTRA_MAIN....8000
C|    *  Virginia, and the Engineering and Services Laboratory,   *    | SUTRA_MAIN....8100
C|    *  U.S. Air Force Engineering and Services Center, Tyndall  *    | SUTRA_MAIN....8200
C|    *  A.F.B., Florida.  The SUTRA code and documentation are   *    | SUTRA_MAIN....8300
C|    *  available for unlimited distribution.                    *    | SUTRA_MAIN....8400
C|    *                                                           *    | SUTRA_MAIN....8500
C|    * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *    | SUTRA_MAIN....8600
C|                                                                     | SUTRA_MAIN....8700
C|    * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *    | SUTRA_MAIN....8800
C|    *                                                           *    | SUTRA_MAIN....8900
C|    *  Original Release: 1984, Version 1.0                      *    | SUTRA_MAIN....9000
C|    *  by: Clifford I. Voss, U.S. Geological Survey             *    | SUTRA_MAIN....9100
C|    *                                                           *    | SUTRA_MAIN....9200
C|    *  First Revision: June 1990, Version 1.1 (V06902D)         *    | SUTRA_MAIN....9300
C|    *  by: Clifford I. Voss, U.S. Geological Survey             *    | SUTRA_MAIN....9400
C|    *                                                           *    | SUTRA_MAIN....9500
C|    *  Second Revision: September 1997, Version 1.2 (V09972D)   *    | SUTRA_MAIN....9600
C|    *  by: C.I. Voss and David Boldt, U.S. Geological Survey    *    | SUTRA_MAIN....9700
C|    *                                                           *    | SUTRA_MAIN....9800
C|    *  Third Revision: September 2003, Version 2.0 (2D3D.1)     *    | SUTRA_MAIN....9900
C|    *  by: A.M. Provost & C.I. Voss, U.S. Geological Survey     *    | SUTRA_MAIN...10000
C|    *                                                           *    | SUTRA_MAIN...10100
C|    *  Fourth Revision: June 2008, Version 2.1                  *    | SUTRA_MAIN...10200
C|    *  by: A.M. Provost & C.I. Voss, U.S. Geological Survey     *    | SUTRA_MAIN...10300
C|    *                                                           *    | SUTRA_MAIN...10400
C|    *  Fifth Revision: September 2010, Version 2.2              *    | SUTRA_MAIN...10500
C|    *  by: A.M. Provost & C.I. Voss, U.S. Geological Survey     *    | SUTRA_MAIN...10600
C|    *                                                           *    | SUTRA_MAIN...10700
C|    * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *    | SUTRA_MAIN...10800
C|                                                                     | SUTRA_MAIN...10900
C|                                                                     | SUTRA_MAIN...11000
C|_____________________________________________________________________| SUTRA_MAIN...11100
C                                                                        SUTRA_MAIN...11200
C                                                                        SUTRA_MAIN...11300
C                                                                        SUTRA_MAIN...11400
      PROGRAM SUTRA_MAIN                                                 SUTRA_MAIN...11500
      USE ALLARR                                                         SUTRA_MAIN...11600
      USE PTRDEF                                                         SUTRA_MAIN...11700
      USE EXPINT                                                         SUTRA_MAIN...11800
      USE SCHDEF                                                         SUTRA_MAIN...11900
      USE BCSDEF                                                         SUTRA_MAIN...12000
      USE FINDEF                                                         SUTRA_MAIN...12100
      USE LLDEF                                                          SUTRA_MAIN...12200
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                SUTRA_MAIN...12300
      PARAMETER (NCOLMX=9)                                               SUTRA_MAIN...12400
C                                                                        SUTRA_MAIN...12500
C.....PROGRAMMERS SET SUTRA VERSION NUMBER HERE (8 CHARACTERS MAXIMUM)   SUTRA_MAIN...12600
      CHARACTER*8, PARAMETER :: VERN='2.2'                               SUTRA_MAIN...12700
C                                                                        SUTRA_MAIN...12800
      CHARACTER*8 VERNUM, VERNIN                                         SUTRA_MAIN...12900
      CHARACTER*1 TITLE1(80),TITLE2(80)                                  SUTRA_MAIN...13000
      CHARACTER*80 SIMULA(5),MSHTYP(2),LAYNOR(2),SIMSTR,MSHSTR,LAYSTR    SUTRA_MAIN...13100
      CHARACTER*80 CUNSAT, CSSFLO ,CSSTRA, CREAD                         SUTRA_MAIN...13200
      CHARACTER*80 UNSSTR, SSFSTR ,SSTSTR, RDSTR                         SUTRA_MAIN...13300
      CHARACTER*80 UNAME,FNAME,FNINP,FNICS,FNBCS                         SUTRA_MAIN...13400
      CHARACTER*80 ERRCOD,CHERR(10)                                      SUTRA_MAIN...13500
      CHARACTER*40 SOLNAM(0:10)                                          SUTRA_MAIN...13600
      CHARACTER*10 SOLWRD(0:10)                                          SUTRA_MAIN...13700
      CHARACTER*10 ADSMOD                                                SUTRA_MAIN...13800
      CHARACTER INTFIL*1000                                              SUTRA_MAIN...13900
      CHARACTER*10 BCSSCH                                                SUTRA_MAIN...14000
      CHARACTER*80 CDUM80                                                SUTRA_MAIN...14100
      INTEGER RMVDIM,IMVDIM,CMVDIM,PMVDIM,LMVDIM                         SUTRA_MAIN...14200
      LOGICAL ONCEK5,ONCEK6,ONCEK7,ONCEK8                                SUTRA_MAIN...14300
      LOGICAL ONCEK10,ONCEK11,ONCEK12,ONCEK13                            SUTRA_MAIN...14400
      LOGICAL ONCEFO                                                     SUTRA_MAIN...14500
      LOGICAL ONCEBCS, SETBCS                                            SUTRA_MAIN...14600
      LOGICAL ALCBCS,ALCFIN,ALCOBS                                       SUTRA_MAIN...14700
      DIMENSION FNAME(0:13),IUNIT(0:13)                                  SUTRA_MAIN...14800
      DIMENSION INERR(10), RLERR(10)                                     SUTRA_MAIN...14900
      DIMENSION J5COL(NCOLMX), J6COL(NCOLMX)                             SUTRA_MAIN...15000
      ALLOCATABLE :: FNBCS(:), IUBCS(:)                                  SUTRA_MAIN...15100
      DIMENSION KTYPE(2)                                                 SUTRA_MAIN...15200
      TYPE (LLD), POINTER :: DENB                                        SUTRA_MAIN...15300
      COMMON /ALC/ ALCBCS,ALCFIN,ALCOBS                                  SUTRA_MAIN...15400
      COMMON /BCSL/ ONCEBCS                                              SUTRA_MAIN...15500
      COMMON /CLAY/ LAYSTR                                               SUTRA_MAIN...15600
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  SUTRA_MAIN...15700
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           SUTRA_MAIN...15800
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      SUTRA_MAIN...15900
      COMMON /DIMLAY/ NLAYS,NNLAY,NELAY                                  SUTRA_MAIN...16000
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              SUTRA_MAIN...16100
     1   NSOP,NSOU,NBCN,NCIDB                                            SUTRA_MAIN...16200
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        SUTRA_MAIN...16300
      COMMON /DIMX2/ NELTA, NNVEC, NDIMIA, NDIMJA                        SUTRA_MAIN...16400
      COMMON /FNAMES/ UNAME,FNAME                                        SUTRA_MAIN...16500
      COMMON /FO/ONCEFO                                                  SUTRA_MAIN...16600
      COMMON /FUNIB/ NFBCS                                               SUTRA_MAIN...16700
      COMMON /FUNITA/ IUNIT                                              SUTRA_MAIN...16800
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 SUTRA_MAIN...16900
     1   K10,K11,K12,K13                                                 SUTRA_MAIN...17000
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS      SUTRA_MAIN...17100
      COMMON /ITSOLI/ ITRMXP,ITOLP,NSAVEP,ITRMXU,ITOLU,NSAVEU            SUTRA_MAIN...17200
      COMMON /ITSOLR/ TOLP,TOLU                                          SUTRA_MAIN...17300
      COMMON /JCOLS/ NCOLPR, LCOLPR, NCOLS5, NCOLS6, J5COL, J6COL        SUTRA_MAIN...17400
      COMMON /KPRBCS/ KINACT                                             SUTRA_MAIN...17500
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                SUTRA_MAIN...17600
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            SUTRA_MAIN...17700
      COMMON /MODSOR/ ADSMOD                                             SUTRA_MAIN...17800
      COMMON /OBS/ NOBSN,NTOBS,NOBCYC,NOBLIN,NFLOMX                      SUTRA_MAIN...17900
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,      SUTRA_MAIN...18000
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2        SUTRA_MAIN...18100
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /PLT1/ ONCEK5, ONCEK6, ONCEK7, ONCEK8                       SUTRA_MAIN...18200
      COMMON /PLT2/ ONCEK10, ONCEK11, ONCEK12, ONCEK13                   SUTRA_MAIN...18300
      COMMON /SCH/ NSCH,ISCHTS,NSCHAU                                    SUTRA_MAIN...18400
      COMMON /SOLVC/ SOLWRD, SOLNAM                                      SUTRA_MAIN...18500
      COMMON /SOLVN/ NSLVRS                                              SUTRA_MAIN...18600
      COMMON /SOLVI/ KSOLVP, KSOLVU, NN1, NN2, NN3                       SUTRA_MAIN...18700
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       SUTRA_MAIN...18800
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      SUTRA_MAIN...18900
      COMMON /VER/ VERNUM, VERNIN                                        SUTRA_MAIN...19000
      COMMON /ET/ QET,UET,PET,UVM,NGT,ITE,TMA,TMI,ALF,RS,RH,AP,BP,U2,
     1   TSD,SCF
C....."NSLVRS" AND THE ARRAYS "SOLWRD" AND "SOLNAM" ARE INITIALIZED      SUTRA_MAIN...19100
C        IN THE BLOCK-DATA SUBPROGRAM "BDINIT"                           SUTRA_MAIN...19200
C                                                                        SUTRA_MAIN...19300
C                                                                        SUTRA_MAIN...19400
C.....COPY PARAMETER VERN (SUTRA VERSION NUMBER) TO VARIABLE VERNUM,     SUTRA_MAIN...19500
C        WHICH IS PASSED THROUGH COMMON BLOCK VER.                       SUTRA_MAIN...19600
      VERNUM = VERN                                                      SUTRA_MAIN...19700
C                                                                        SUTRA_MAIN...19800
C.....SET THE ALLOCATION FLAGS TO FALSE                                  SUTRA_MAIN...19900
      ALLO1 = .FALSE.                                                    SUTRA_MAIN...20000
      ALLO2 = .FALSE.                                                    SUTRA_MAIN...20100
      ALLO3 = .FALSE.                                                    SUTRA_MAIN...20200
C                                                                        SUTRA_MAIN...20300
C.....INITIALIZE FLAG TO INDICATE THAT BCSTEP HAS NOT YET BEEN CALLED    SUTRA_MAIN...20400
C        IN THE MAIN PROGRAM                                             SUTRA_MAIN...20500
      ONCEBCS = .FALSE.                                                  SUTRA_MAIN...20600
C                                                                        SUTRA_MAIN...20700
C_______________________________________________________________________ SUTRA_MAIN...20800
C|                                                                     | SUTRA_MAIN...20900
C|  *****************************************************************  | SUTRA_MAIN...21000
C|  *                                                               *  | SUTRA_MAIN...21100
C|  *   **********  M E M O R Y   A L L O C A T I O N  **********   *  | SUTRA_MAIN...21200
C|  *                                                               *  | SUTRA_MAIN...21300
C|  *   The main arrays used by SUTRA are dimensioned dynamically   *  | SUTRA_MAIN...21400
C|  *   in the main program, SUTRA_MAIN.  The amount of storage     *  | SUTRA_MAIN...21500
C|  *   required by these arrays depends on the dimensionality of   *  | SUTRA_MAIN...21600
C|  *   the problem (2D or 3D) and the particular solver(s) used.   *  | SUTRA_MAIN...21700
C|  *                                                               *  | SUTRA_MAIN...21800
C|  *               |---------------------|---------------------|   *  | SUTRA_MAIN...21900
C|  *               |     sum of real     |    sum of integer   |   *  | SUTRA_MAIN...22000
C|  *               |   array dimensions  |   array dimensions  |   *  | SUTRA_MAIN...22100
C|  *   |-----------|---------------------|---------------------|   *  | SUTRA_MAIN...22200
C|  *   | 2D,       | (2*NBI+27)*NN+19*NE |   NN+5*NE+2*NSOP    |   *  | SUTRA_MAIN...22300
C|  *   | direct    |    +3*NBCN+6*NOBS   | +2*NSOU+4*NBCN+NOBS |   *  | SUTRA_MAIN...22400
C|  *   | solver    |   +2*NSCH+22+NRBCS  |  +3*NSCH+4+NI1BCS   |   *  | SUTRA_MAIN...22500
C|  *   |-----------|---------------------|---------------------|   *  | SUTRA_MAIN...22600
C|  *   | 2D,       | 2*NELT+28*NN+19*NE  |   NELT+2*NN+5*NE    |   *  | SUTRA_MAIN...22700
C|  *   | iterative |   +3*NBCN+6*NOBS    |   +2*NSOP+2*NSOU    |   *  | SUTRA_MAIN...22800
C|  *   | solver(s) |   +2*NSCH+NWF+220   | +4*NBCN+NOBS+3*NSCH |   *  | SUTRA_MAIN...22900
C|  *   |           |       +NRBCS        |   +NWI+2+NI1BCS     |   *  | SUTRA_MAIN...23000
C|  *   |-----------|---------------------|---------------------|   *  | SUTRA_MAIN...23100
C|  *   | 3D,       | (2*NBI+27)*NN+45*NE |   NN+9*NE+2*NSOP    |   *  | SUTRA_MAIN...23200
C|  *   | direct    |    +3*NBCN+6*NOBS   | +2*NSOU+4*NBCN+NOBS |   *  | SUTRA_MAIN...23300
C|  *   | solver    |   +2*NSCH+8+NRBCS   |  +3*NSCH+4+NI1BCS   |   *  | SUTRA_MAIN...23400
C|  *   |-----------|---------------------|---------------------|   *  | SUTRA_MAIN...23500
C|  *   | 3D,       | 2*NELT+28*NN+45*NE  |   NELT+2*NN+9*NE    |   *  | SUTRA_MAIN...23600
C|  *   | iterative |   +3*NBCN+6*NOBS    |   +2*NSOP+2*NSOU    |   *  | SUTRA_MAIN...23700
C|  *   | solver(s) |   +2*NSCH+NWF+6     | +4*NBCN+NOBS+3*NSCH |   *  | SUTRA_MAIN...23800
C|  *   |           |       +NRBCS        |   +NWI+2+NI1BCS     |   *  | SUTRA_MAIN...23900
C|  *   |-----------|---------------------|---------------------|   *  | SUTRA_MAIN...24000
C|  *                                                               *  | SUTRA_MAIN...24100
C|  *               |---------------------|---------------------|   *  | SUTRA_MAIN...24200
C|  *               |  sum of character   |  sum of dimensions  |   *  | SUTRA_MAIN...24300
C|  *               |   array effective   |     of arrays of    |   *  | SUTRA_MAIN...24400
C|  *               |     dimensions      |       pointers      |   *  | SUTRA_MAIN...24500
C|  *   |-----------|---------------------|---------------------|   *  | SUTRA_MAIN...24600
C|  *   | all cases |   73*NOBS+89*NSCH   |        2*NSCH       |   *  | SUTRA_MAIN...24700
C|  *   |           |       +NCIDB        |                     |   *  | SUTRA_MAIN...24800
C|  *   |-----------|---------------------|---------------------|   *  | SUTRA_MAIN...24900
C|  *                                                               *  | SUTRA_MAIN...25000
C|  *               |---------------------|                         *  | SUTRA_MAIN...25100
C|  *               |    sum of logical   |                         *  | SUTRA_MAIN...25200
C|  *               |   array dimensions  |                         *  | SUTRA_MAIN...25300
C|  *   |-----------|---------------------|                         *  | SUTRA_MAIN...25400
C|  *   | all cases |        ITMAX        |                         *  | SUTRA_MAIN...25500
C|  *   |-----------|---------------------|                         *  | SUTRA_MAIN...25600
C|  *                                                               *  | SUTRA_MAIN...25700
C|  *   Quantities in the tables above are defined in Section 7.3   *  | SUTRA_MAIN...25800
C|  *   of the published documentation (Voss & Provost, 2002,       *  | SUTRA_MAIN...25900
C|  *   USGS Water-Resources Investigations Report 02-4231,         *  | SUTRA_MAIN...26000
C|  *   Version of Oct 22, 2009).                                   *  | SUTRA_MAIN...26100
C|  *                                                               *  | SUTRA_MAIN...26200
C|  *   During each run, SUTRA writes memory usage information to   *  | SUTRA_MAIN...26300
C|  *   the LST output file.                                        *  | SUTRA_MAIN...26400
C|  *                                                               *  | SUTRA_MAIN...26500
C|  *****************************************************************  | SUTRA_MAIN...26600
C|_____________________________________________________________________| SUTRA_MAIN...26700
C                                                                        SUTRA_MAIN...26800
C                                                                        SUTRA_MAIN...26900
C_______________________________________________________________________ SUTRA_MAIN...27000
C|                                                                     | SUTRA_MAIN...27100
C|  *****************************************************************  | SUTRA_MAIN...27200
C|  *                                                               *  | SUTRA_MAIN...27300
C|  *   ***********  F I L E   A S S I G N M E N T S  ***********   *  | SUTRA_MAIN...27400
C|  *                                                               *  | SUTRA_MAIN...27500
C|  *   Unit K0 contains the FORTRAN unit number and filename       *  | SUTRA_MAIN...27600
C|  *   assignments for the various SUTRA input and output files.   *  | SUTRA_MAIN...27700
C|  *   Each line of Unit K0 begins with a file type, followed by   *  | SUTRA_MAIN...27800
C|  *   a unit number and a filename for that type, all in free     *  | SUTRA_MAIN...27900
C|  *   format. Permitted file types are INP, BCS, ICS, LST, RST,   *  | SUTRA_MAIN...28000
C|  *   NOD, ELE, BCOF, BCOP, BCOS, BCOU, OBS, OBC, and SMY.        *  | SUTRA_MAIN...28100
C|  *   Assignments may be listed in any order.                     *  | SUTRA_MAIN...28200
C|  *   Example ("#" indicates a comment):                          *  | SUTRA_MAIN...28300
C|  *   'INP'  50  'project.inp'   # required                       *  | SUTRA_MAIN...28400
C|  *   'BCS'  52  'project.bcs'   # optional                       *  | SUTRA_MAIN...28500
C|  *   'ICS'  55  'project.ics'   # required                       *  | SUTRA_MAIN...28600
C|  *   'LST'  60  'project.lst'   # required                       *  | SUTRA_MAIN...28700
C|  *   'RST'  66  'project.rst'   # optional                       *  | SUTRA_MAIN...28800
C|  *   'NOD'  70  'project.nod'   # optional                       *  | SUTRA_MAIN...28900
C|  *   'ELE'  80  'project.ele'   # optional                       *  | SUTRA_MAIN...29000
C|  *   'OBS'  90  'project.obs'   # optional                       *  | SUTRA_MAIN...29100
C|  *   'OBC'  90  'project.obc'   # optional                       *  | SUTRA_MAIN...29200
C|  *   'BCOF' 95  'project.bcof'  # optional                       *  | SUTRA_MAIN...29300
C|  *   'BCOP' 96  'project.bcop'  # optional                       *  | SUTRA_MAIN...29400
C|  *   'BCOS' 97  'project.bcos'  # optional                       *  | SUTRA_MAIN...29500
C|  *   'BCOU' 98  'project.bcou'  # optional                       *  | SUTRA_MAIN...29600
C|  *   'SMY'  40  'project.smy'   # optional; defaults to          *  | SUTRA_MAIN...29700
C|  *                              #           filename="SUTRA.SMY" *  | SUTRA_MAIN...29800
C|  *                                                               *  | SUTRA_MAIN...29900
C|  *   Note that the filenames for types OBS and OBC are actually  *  | SUTRA_MAIN...30000
C|  *   root names from which SUTRA will automatically generate     *  | SUTRA_MAIN...30100
C|  *   observation output filenames based on the combinations of   *  | SUTRA_MAIN...30200
C|  *   schedules and output formats that appear in the observation *  | SUTRA_MAIN...30300
C|  *   specifications.  If a unit number of zero is specified for  *  | SUTRA_MAIN...30400
C|  *   a file, SUTRA will automatically assign a valid unit number *  | SUTRA_MAIN...30500
C|  *   to that file.                                               *  | SUTRA_MAIN...30600
C|  *                                                               *  | SUTRA_MAIN...30700
C|  *****************************************************************  | SUTRA_MAIN...30800
C|_____________________________________________________________________| SUTRA_MAIN...30900
C                                                                        SUTRA_MAIN...31000
C.....SET FILENAME AND FORTRAN UNIT NUMBER FOR UNIT K0                   SUTRA_MAIN...31100
      UNAME = 'SUTRA.FIL'                                                SUTRA_MAIN...31200
      K0 = 10                                                            SUTRA_MAIN...31300
C.....INITIALIZE NFLOMX TO ZERO NOW IN CASE TERMINATION SEQUENCE IS      SUTRA_MAIN...31400
C        CALLED BEFORE NFLOMX GETS SET.                                  SUTRA_MAIN...31500
      NFLOMX = 0                                                         SUTRA_MAIN...31600
C.....ASSIGN UNIT NUMBERS AND OPEN FILE UNITS FOR THIS SIMULATION,       SUTRA_MAIN...31700
C        EXCEPT OBSERVATION OUTPUT FILES.                                SUTRA_MAIN...31800
      ONCEFO = .FALSE.                                                   SUTRA_MAIN...31900
      CALL FOPEN()                                                       SUTRA_MAIN...32000
C.....STORE INP, BCS, AND ICS FILENAMES FOR LATER REFERENCE, SINCE THE   SUTRA_MAIN...32100
C        CORRESPONDING ENTRIES IN FNAME MAY BE OVERWRITTEN BY FILE       SUTRA_MAIN...32200
C        INSERTION.                                                      SUTRA_MAIN...32300
      FNINP = FNAME(1)                                                   SUTRA_MAIN...32400
      FNICS = FNAME(2)                                                   SUTRA_MAIN...32500
      ALLOCATE (FNBCS(NFBCS), IUBCS(NFBCS))                              SUTRA_MAIN...32600
      DO 30 NFB=1,NFBCS                                                  SUTRA_MAIN...32700
         FNBCS(NFB) = FNAMB(NFB)                                         SUTRA_MAIN...32800
         IUBCS(NFB) = IUNIB(NFB)                                         SUTRA_MAIN...32900
   30 CONTINUE                                                           SUTRA_MAIN...33000
C                                                                        SUTRA_MAIN...33100
C                                                                        SUTRA_MAIN...33200
C.....OUTPUT BANNER                                                      SUTRA_MAIN...33300
      WRITE(K3,110) TRIM(VERNUM)                                         SUTRA_MAIN...33400
  110 FORMAT('1',131('*')////3(132('*')////)////                         SUTRA_MAIN...33500
     1   47X,' SSSS   UU  UU  TTTTTT  RRRRR     AA  '/                   SUTRA_MAIN...33600
     2   47X,'SS   S  UU  UU  T TT T  RR  RR   AAAA '/                   SUTRA_MAIN...33700
     3   47X,'SSSS    UU  UU    TT    RRRRR   AA  AA'/                   SUTRA_MAIN...33800
     4   47X,'    SS  UU  UU    TT    RR R    AAAAAA'/                   SUTRA_MAIN...33900
     5   47X,'SS  SS  UU  UU    TT    RR RR   AA  AA'/                   SUTRA_MAIN...34000
     6   47X,' SSSS    UUUU     TT    RR  RR  AA  AA'/                   SUTRA_MAIN...34100
     7   7(/),37X,'U N I T E D    S T A T E S   ',                       SUTRA_MAIN...34200
     8   'G E O L O G I C A L   S U R V E Y'////                         SUTRA_MAIN...34300
     9   45X,'SUBSURFACE FLOW AND TRANSPORT SIMULATION MODEL'/           SUTRA_MAIN...34400
     *   //58X,'-SUTRA VERSION ',A,'-'///                                SUTRA_MAIN...34500
     A   36X,'*  SATURATED-UNSATURATED FLOW AND SOLUTE OR ENERGY',       SUTRA_MAIN...34600
     B   ' TRANSPORT  *'////4(////132('*')))                             SUTRA_MAIN...34700
C                                                                        SUTRA_MAIN...34800
C_______________________________________________________________________ SUTRA_MAIN...34900
C|                                                                     | SUTRA_MAIN...35000
C|  *****************************************************************  | SUTRA_MAIN...35100
C|  *                                                               *  | SUTRA_MAIN...35200
C|  *   *********  R E A D I N G   I N P U T   D A T A  *********   *  | SUTRA_MAIN...35300
C|  *   *********  A N D   E R R O R   H A N D L I N G  *********   *  | SUTRA_MAIN...35400
C|  *                                                               *  | SUTRA_MAIN...35500
C|  *   SUTRA typically reads input data line by line as follows.   *  | SUTRA_MAIN...35600
C|  *   Subroutine READIF is called to skip over any comment        *  | SUTRA_MAIN...35700
C|  *   lines and read a single line of input data (up to 1000      *  | SUTRA_MAIN...35800
C|  *   characters) into internal file INTFIL. The input data       *  | SUTRA_MAIN...35900
C|  *   are then read from INTFIL. In case of an error, subroutine  *  | SUTRA_MAIN...36000
C|  *   SUTERR is called to report it, and control passes to the    *  | SUTRA_MAIN...36100
C|  *   termination sequence in subroutine TERSEQ.  The variable    *  | SUTRA_MAIN...36200
C|  *   ERRCOD is used to identify the nature of the error and is   *  | SUTRA_MAIN...36300
C|  *   set prior to calling READIF. The variables CHERR, INERR,    *  | SUTRA_MAIN...36400
C|  *   and RLERR can be used to send character, integer, or real   *  | SUTRA_MAIN...36500
C|  *   error information to subroutine SUTERR.                     *  | SUTRA_MAIN...36600
C|  *   Example from the main program:                              *  | SUTRA_MAIN...36700
C|  *                                                               *  | SUTRA_MAIN...36800
C|  *   ERRCOD = 'REA-INP-3'                                        *  | SUTRA_MAIN...36900
C|  *   CALL READIF(K1, 0, INTFIL, ERRCOD)                          *  | SUTRA_MAIN...37000
C|  *   READ(INTFIL,*,IOSTAT=INERR(1)) NN,NE,NPBC,NUBC,             *  | SUTRA_MAIN...37100
C|  *  1   NSOP,NSOU,NOBS                                           *  | SUTRA_MAIN...37200
C|  *   IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR) *  | SUTRA_MAIN...37300
C|  *                                                               *  | SUTRA_MAIN...37400
C|  *****************************************************************  | SUTRA_MAIN...37500
C|_____________________________________________________________________| SUTRA_MAIN...37600
C                                                                        SUTRA_MAIN...37700
C.....INPUT DATASET 1:  OUTPUT HEADING                                   SUTRA_MAIN...37800
      ERRCOD = 'REA-INP-1'                                               SUTRA_MAIN...37900
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 SUTRA_MAIN...38000
      READ(INTFIL,117,IOSTAT=INERR(1)) TITLE1                            SUTRA_MAIN...38100
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        SUTRA_MAIN...38200
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 SUTRA_MAIN...38300
      READ(INTFIL,117,IOSTAT=INERR(1)) TITLE2                            SUTRA_MAIN...38400
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        SUTRA_MAIN...38500
  117 FORMAT(80A1)                                                       SUTRA_MAIN...38600
C                                                                        SUTRA_MAIN...38700
C.....INPUT DATASET 2A:  SIMULATION TYPE (TYPE OF TRANSPORT)             SUTRA_MAIN...38800
C        (SET ME=-1 FOR SOLUTE TRANSPORT, ME=+1 FOR ENERGY TRANSPORT)    SUTRA_MAIN...38900
      ERRCOD = 'REA-INP-2A'                                              SUTRA_MAIN...39000
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 SUTRA_MAIN...39100
      READ(INTFIL,*,IOSTAT=INERR(1)) SIMSTR                              SUTRA_MAIN...39200
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        SUTRA_MAIN...39300
      CALL PRSWDS(SIMSTR, ' ', 5, SIMULA, NWORDS)                        SUTRA_MAIN...39400
      IF(SIMULA(1).NE.'SUTRA     ') THEN                                 SUTRA_MAIN...39500
         ERRCOD = 'INP-2A-1'                                             SUTRA_MAIN...39600
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SUTRA_MAIN...39700
      END IF                                                             SUTRA_MAIN...39800
      IF (SIMULA(2).EQ.'VERSION   ') THEN                                SUTRA_MAIN...39900
         VERNIN = SIMULA(3)                                              SUTRA_MAIN...40000
         IF (VERNIN.EQ.'2D3D.1 ') THEN                                   SUTRA_MAIN...40100
            VERNIN = '2.0'                                               SUTRA_MAIN...40200
         ELSE IF ((VERNIN.NE.'2.0 ').AND.(VERNIN.NE.'2.1 ').AND.         SUTRA_MAIN...40300
     1            (VERNIN.NE.'2.2 ')) THEN                               SUTRA_MAIN...40400
            ERRCOD = 'INP-2A-4'                                          SUTRA_MAIN...40500
            CHERR(1) = VERNIN                                            SUTRA_MAIN...40600
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     SUTRA_MAIN...40700
         END IF                                                          SUTRA_MAIN...40800
         IOFF = 2                                                        SUTRA_MAIN...40900
      ELSE                                                               SUTRA_MAIN...41000
         VERNIN = '2.0'                                                  SUTRA_MAIN...41100
         IOFF = 0                                                        SUTRA_MAIN...41200
      END IF                                                             SUTRA_MAIN...41300
      IF(SIMULA(2+IOFF).EQ.'SOLUTE    ') GOTO 120                        SUTRA_MAIN...41400
      IF(SIMULA(2+IOFF).EQ.'ENERGY    ') GOTO 140                        SUTRA_MAIN...41500
      IF (IOFF.EQ.0) THEN                                                SUTRA_MAIN...41600
         ERRCOD = 'INP-2A-2'                                             SUTRA_MAIN...41700
      ELSE                                                               SUTRA_MAIN...41800
         ERRCOD = 'INP-2A-3'                                             SUTRA_MAIN...41900
      END IF                                                             SUTRA_MAIN...42000
      CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                           SUTRA_MAIN...42100
  120 ME=-1                                                              SUTRA_MAIN...42200
      WRITE(K3,130)                                                      SUTRA_MAIN...42300
  130 FORMAT('1'//132('*')///20X,'* * * * *   S U T R A   S O L U ',     SUTRA_MAIN...42400
     1   'T E   T R A N S P O R T   S I M U L A T I O N   * * * * *'//   SUTRA_MAIN...42500
     2   /132('*')/)                                                     SUTRA_MAIN...42600
      GOTO 160                                                           SUTRA_MAIN...42700
  140 ME=+1                                                              SUTRA_MAIN...42800
      WRITE(K3,150)                                                      SUTRA_MAIN...42900
  150 FORMAT('1'//132('*')///20X,'* * * * *   S U T R A   E N E R ',     SUTRA_MAIN...43000
     1   'G Y   T R A N S P O R T   S I M U L A T I O N   * * * * *'//   SUTRA_MAIN...43100
     2   /132('*')/)                                                     SUTRA_MAIN...43200
  160 CONTINUE                                                           SUTRA_MAIN...43300
C                                                                        SUTRA_MAIN...43400
C.....INPUT DATASET 2B:  MESH STRUCTURE                                  SUTRA_MAIN...43500
      ERRCOD = 'REA-INP-2B'                                              SUTRA_MAIN...43600
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 SUTRA_MAIN...43700
      READ(INTFIL,*,IOSTAT=INERR(1)) MSHSTR                              SUTRA_MAIN...43800
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        SUTRA_MAIN...43900
      CALL PRSWDS(MSHSTR, ' ', 2, MSHTYP, NWORDS)                        SUTRA_MAIN...44000
C.....KTYPE SET ACCORDING TO THE TYPE OF FINITE-ELEMENT MESH:            SUTRA_MAIN...44100
C        2D MESH          ==>   KTYPE(1) = 2                             SUTRA_MAIN...44200
C        3D MESH          ==>   KTYPE(1) = 3                             SUTRA_MAIN...44300
C        IRREGULAR MESH   ==>   KTYPE(2) = 0                             SUTRA_MAIN...44400
C        LAYERED MESH     ==>   KTYPE(2) = 1                             SUTRA_MAIN...44500
C        REGULAR MESH     ==>   KTYPE(2) = 2                             SUTRA_MAIN...44600
C        BLOCKWISE MESH   ==>   KTYPE(2) = 3                             SUTRA_MAIN...44700
      IF (MSHTYP(1).EQ.'2D        ') THEN                                SUTRA_MAIN...44800
         KTYPE(1) = 2                                                    SUTRA_MAIN...44900
      ELSE IF (MSHTYP(1).EQ.'3D        ') THEN                           SUTRA_MAIN...45000
         KTYPE(1) = 3                                                    SUTRA_MAIN...45100
      ELSE                                                               SUTRA_MAIN...45200
         ERRCOD = 'INP-2B-1'                                             SUTRA_MAIN...45300
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SUTRA_MAIN...45400
      END IF                                                             SUTRA_MAIN...45500
      IF ((MSHTYP(2).EQ.'REGULAR   ').OR.                                SUTRA_MAIN...45600
     1    (MSHTYP(2).EQ.'BLOCKWISE ')) THEN                              SUTRA_MAIN...45700
         ERRCOD = 'REA-INP-2B'                                           SUTRA_MAIN...45800
         IF (KTYPE(1).EQ.2) THEN                                         SUTRA_MAIN...45900
            READ(INTFIL,*,IOSTAT=INERR(1)) MSHSTR, NN1, NN2              SUTRA_MAIN...46000
            NN3 = 1                                                      SUTRA_MAIN...46100
         ELSE                                                            SUTRA_MAIN...46200
            READ(INTFIL,*,IOSTAT=INERR(1)) MSHSTR, NN1, NN2, NN3         SUTRA_MAIN...46300
         END IF                                                          SUTRA_MAIN...46400
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     SUTRA_MAIN...46500
         IF ((NN1.LT.2).OR.(NN2.LT.2).OR.                                SUTRA_MAIN...46600
     1      ((KTYPE(1).EQ.3).AND.(NN3.LT.2))) THEN                       SUTRA_MAIN...46700
            ERRCOD = 'INP-2B-3'                                          SUTRA_MAIN...46800
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     SUTRA_MAIN...46900
         END IF                                                          SUTRA_MAIN...47000
         IF (MSHTYP(2).EQ.'BLOCKWISE ') THEN                             SUTRA_MAIN...47100
            KTYPE(2) = 3                                                 SUTRA_MAIN...47200
            ERRCOD = 'REA-INP-2B'                                        SUTRA_MAIN...47300
            DO 177 I1=1,KTYPE(1)                                         SUTRA_MAIN...47400
               CALL READIF(K1, 0, INTFIL, ERRCOD)                        SUTRA_MAIN...47500
               READ(INTFIL,*,IOSTAT=INERR(1)) IDUM1, (IDUM2, I2=1,IDUM1) SUTRA_MAIN...47600
               IF (INERR(1).NE.0) CALL SUTERR(ERRCOD,CHERR,INERR,RLERR)  SUTRA_MAIN...47700
  177       CONTINUE                                                     SUTRA_MAIN...47800
         ELSE                                                            SUTRA_MAIN...47900
            KTYPE(2) = 2                                                 SUTRA_MAIN...48000
         END IF                                                          SUTRA_MAIN...48100
      ELSE IF (MSHTYP(2).EQ.'LAYERED   ') THEN                           SUTRA_MAIN...48200
         IF (KTYPE(1).EQ.2) THEN                                         SUTRA_MAIN...48300
            ERRCOD = 'INP-2B-5'                                          SUTRA_MAIN...48400
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     SUTRA_MAIN...48500
         END IF                                                          SUTRA_MAIN...48600
         KTYPE(2) = 1                                                    SUTRA_MAIN...48700
         ERRCOD = 'REA-INP-2B'                                           SUTRA_MAIN...48800
         READ(INTFIL,*,IOSTAT=INERR(1)) MSHSTR,NLAYS,NNLAY,NELAY,LAYSTR  SUTRA_MAIN...48900
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD,CHERR,INERR,RLERR)        SUTRA_MAIN...49000
         CALL PRSWDS(LAYSTR, ' ', 1, LAYNOR, NWORDS)                     SUTRA_MAIN...49100
         IF ((LAYNOR(1).NE.'ACROSS').AND.(LAYNOR(1).NE.'WITHIN')) THEN   SUTRA_MAIN...49200
            ERRCOD = 'INP-2B-6'                                          SUTRA_MAIN...49300
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     SUTRA_MAIN...49400
         END IF                                                          SUTRA_MAIN...49500
         IF ((NLAYS.LT.2).OR.(NNLAY.LT.4).OR.(NELAY.LT.1)) THEN          SUTRA_MAIN...49600
            ERRCOD = 'INP-2B-7'                                          SUTRA_MAIN...49700
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     SUTRA_MAIN...49800
         END IF                                                          SUTRA_MAIN...49900
      ELSE IF (MSHTYP(2).EQ.'IRREGULAR ') THEN                           SUTRA_MAIN...50000
         KTYPE(2) = 0                                                    SUTRA_MAIN...50100
      ELSE                                                               SUTRA_MAIN...50200
         ERRCOD = 'INP-2B-4'                                             SUTRA_MAIN...50300
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SUTRA_MAIN...50400
      END IF                                                             SUTRA_MAIN...50500
C                                                                        SUTRA_MAIN...50600
C.....OUTPUT DATASET 1                                                   SUTRA_MAIN...50700
      WRITE(K3,180) TITLE1,TITLE2                                        SUTRA_MAIN...50800
  180 FORMAT(////1X,131('-')//26X,80A1//26X,80A1//1X,131('-'))           SUTRA_MAIN...50900
C                                                                        SUTRA_MAIN...51000
C.....OUTPUT FILE UNIT ASSIGNMENTS                                       SUTRA_MAIN...51100
      WRITE(K3,200) IUNIT(1),FNINP,IUNIT(2),FNICS                        SUTRA_MAIN...51200
  200 FORMAT(/////11X,'F I L E   U N I T   A S S I G N M E N T S'//      SUTRA_MAIN...51300
     1   13X,'INPUT UNITS:'/                                             SUTRA_MAIN...51400
     2   13X,' INP FILE (MAIN INPUT)          ',I7,4X,                   SUTRA_MAIN...51500
     3      'ASSIGNED TO ',A80/                                          SUTRA_MAIN...51600
     4   13X,' ICS FILE (INITIAL CONDITIONS)  ',I7,4X,                   SUTRA_MAIN...51700
     5      'ASSIGNED TO ',A80)                                          SUTRA_MAIN...51800
      IF(IUNIT(9).NE.-1) THEN                                            SUTRA_MAIN...51900
         DO 202 NFB=1,NFBCS                                              SUTRA_MAIN...52000
            WRITE(K3,201) IUBCS(NFB),FNBCS(NFB)                          SUTRA_MAIN...52100
  201       FORMAT(13X,' BCS FILE (TIME-VAR. BND. COND.)',I7,4X,         SUTRA_MAIN...52200
     1      'ASSIGNED TO ',A80)                                          SUTRA_MAIN...52300
  202    CONTINUE                                                        SUTRA_MAIN...52400
      END IF                                                             SUTRA_MAIN...52500
      WRITE(K3,203) IUNIT(0),FNAME(0),IUNIT(3),FNAME(3)                  SUTRA_MAIN...52600
  203 FORMAT(/                                                           SUTRA_MAIN...52700
     6   13X,'OUTPUT UNITS:'/                                            SUTRA_MAIN...52800
     7   13X,' SMY FILE (RUN SUMMARY)         ',I7,4X,                   SUTRA_MAIN...52900
     8      'ASSIGNED TO ',A80/                                          SUTRA_MAIN...53000
     9   13X,' LST FILE (GENERAL OUTPUT)      ',I7,4X,                   SUTRA_MAIN...53100
     T      'ASSIGNED TO ',A80)                                          SUTRA_MAIN...53200
      IF(IUNIT(4).NE.-1) WRITE(K3,204) IUNIT(4),FNAME(4)                 SUTRA_MAIN...53300
  204 FORMAT(13X,' RST FILE (RESTART DATA)        ',I7,4X,               SUTRA_MAIN...53400
     1   'ASSIGNED TO ',A80)                                             SUTRA_MAIN...53500
      IF(IUNIT(5).NE.-1) WRITE(K3,205) IUNIT(5),FNAME(5)                 SUTRA_MAIN...53600
  205 FORMAT(13X,' NOD FILE (NODEWISE OUTPUT)     ',I7,4X,               SUTRA_MAIN...53700
     1   'ASSIGNED TO ',A80)                                             SUTRA_MAIN...53800
      IF(IUNIT(6).NE.-1) WRITE(K3,206) IUNIT(6),FNAME(6)                 SUTRA_MAIN...53900
  206 FORMAT(13X,' ELE FILE (VELOCITY OUTPUT)     ',I7,4X,               SUTRA_MAIN...54000
     1   'ASSIGNED TO ',A80)                                             SUTRA_MAIN...54100
      IF(IUNIT(7).NE.-1) WRITE(K3,207) IUNIT(7),                         SUTRA_MAIN...54200
     1   TRIM(FNAME(7)) // " (BASE FILENAME)"                            SUTRA_MAIN...54300
  207 FORMAT(13X,' OBS FILE (OBSERVATION OUTPUT) (',I7,')',3X,           SUTRA_MAIN...54400
     1   'ASSIGNED TO ',A)                                               SUTRA_MAIN...54500
      IF(IUNIT(8).NE.-1) WRITE(K3,208) IUNIT(8),                         SUTRA_MAIN...54600
     1   TRIM(FNAME(8)) // " (BASE FILENAME)"                            SUTRA_MAIN...54700
  208 FORMAT(13X,' OBC FILE (OBSERVATION OUTPUT) (',I7,')',3X,           SUTRA_MAIN...54800
     1   'ASSIGNED TO ',A)                                               SUTRA_MAIN...54900
      IF(IUNIT(10).NE.-1) WRITE(K3,209) IUNIT(10),FNAME(10)              SUTRA_MAIN...55000
  209 FORMAT(13X,' BCOF FILE (BND. COND. OUTPUT)  ',I7,4X,               SUTRA_MAIN...55100
     1   'ASSIGNED TO ',A80)                                             SUTRA_MAIN...55200
      IF(IUNIT(11).NE.-1) WRITE(K3,210) IUNIT(11),FNAME(11)              SUTRA_MAIN...55300
  210 FORMAT(13X,' BCOS FILE (BND. COND. OUTPUT)  ',I7,4X,               SUTRA_MAIN...55400
     1   'ASSIGNED TO ',A80)                                             SUTRA_MAIN...55500
      IF(IUNIT(12).NE.-1) WRITE(K3,211) IUNIT(12),FNAME(12)              SUTRA_MAIN...55600
  211 FORMAT(13X,' BCOP FILE (BND. COND. OUTPUT)  ',I7,4X,               SUTRA_MAIN...55700
     1   'ASSIGNED TO ',A80)                                             SUTRA_MAIN...55800
      IF(IUNIT(13).NE.-1) WRITE(K3,212) IUNIT(13),FNAME(13)              SUTRA_MAIN...55900
  212 FORMAT(13X,' BCOU FILE (BND. COND. OUTPUT)  ',I7,4X,               SUTRA_MAIN...56000
     1   'ASSIGNED TO ',A80)                                             SUTRA_MAIN...56100
      IF ((IUNIT(7).NE.-1).OR.(IUNIT(8).NE.-1)) WRITE(K3,213)            SUTRA_MAIN...56200
  213 FORMAT(/14X,'NAMES FOR OBS AND OBC FILES WILL BE GENERATED',       SUTRA_MAIN...56300
     1   ' AUTOMATICALLY FROM THE BASE NAMES LISTED ABOVE AND SCHEDULE', SUTRA_MAIN...56400
     2   ' NAMES'/14X,'LISTED LATER IN THIS FILE.  UNIT NUMBERS',        SUTRA_MAIN...56500
     3   ' ASSIGNED TO THESE FILES WILL BE THE FIRST AVAILABLE',         SUTRA_MAIN...56600
     4   ' NUMBERS GREATER THAN'/14X,'OR EQUAL TO THE VALUES LISTED',    SUTRA_MAIN...56700
     5   ' ABOVE IN PARENTHESES.')                                       SUTRA_MAIN...56800
C                                                                        SUTRA_MAIN...56900
C.....INPUT DATASET 3:  SIMULATION CONTROL NUMBERS                       SUTRA_MAIN...57000
      ERRCOD = 'REA-INP-3'                                               SUTRA_MAIN...57100
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 SUTRA_MAIN...57200
      READ(INTFIL,*,IOSTAT=INERR(1)) NN,NE,NPBC,NUBC,NSOP,NSOU,NOBS      SUTRA_MAIN...57300
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        SUTRA_MAIN...57400
      IF (KTYPE(2).GT.1) THEN                                            SUTRA_MAIN...57500
         NN123 = NN1*NN2*NN3                                             SUTRA_MAIN...57600
         IF(NN123.NE.NN) THEN                                            SUTRA_MAIN...57700
           ERRCOD = 'INP-2B,3-1'                                         SUTRA_MAIN...57800
           CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                      SUTRA_MAIN...57900
         END IF                                                          SUTRA_MAIN...58000
         IF (KTYPE(1).EQ.3) THEN                                         SUTRA_MAIN...58100
            NE123 = (NN1 - 1)*(NN2 - 1)*(NN3 - 1)                        SUTRA_MAIN...58200
         ELSE                                                            SUTRA_MAIN...58300
            NE123 = (NN1 - 1)*(NN2 - 1)                                  SUTRA_MAIN...58400
         END IF                                                          SUTRA_MAIN...58500
         IF(NE123.NE.NE) THEN                                            SUTRA_MAIN...58600
           ERRCOD = 'INP-2B,3-2'                                         SUTRA_MAIN...58700
           CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                      SUTRA_MAIN...58800
         END IF                                                          SUTRA_MAIN...58900
      ELSE IF (MSHTYP(2).EQ.'LAYERED   ') THEN                           SUTRA_MAIN...59000
         NNTOT = NLAYS*NNLAY                                             SUTRA_MAIN...59100
         IF(NNTOT.NE.NN) THEN                                            SUTRA_MAIN...59200
           ERRCOD = 'INP-2B,3-3'                                         SUTRA_MAIN...59300
           CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                      SUTRA_MAIN...59400
         END IF                                                          SUTRA_MAIN...59500
         NETOT = (NLAYS - 1)*NELAY                                       SUTRA_MAIN...59600
         IF(NETOT.NE.NE) THEN                                            SUTRA_MAIN...59700
           ERRCOD = 'INP-2B,3-4'                                         SUTRA_MAIN...59800
           CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                      SUTRA_MAIN...59900
         END IF                                                          SUTRA_MAIN...60000
      ENDIF                                                              SUTRA_MAIN...60100
C                                                                        SUTRA_MAIN...60200
C.....INPUT AND OUTPUT DATASET 4:  SIMULATION MODE OPTIONS               SUTRA_MAIN...60300
      ERRCOD = 'REA-INP-4'                                               SUTRA_MAIN...60400
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 SUTRA_MAIN...60500
      READ(INTFIL,*,IOSTAT=INERR(1)) UNSSTR,SSFSTR,SSTSTR,RDSTR,ISTORE   SUTRA_MAIN...60600
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        SUTRA_MAIN...60700
      CALL PRSWDS(UNSSTR, ' ', 1, CUNSAT, NWORDS)                        SUTRA_MAIN...60800
      CALL PRSWDS(SSFSTR, ' ', 1, CSSFLO, NWORDS)                        SUTRA_MAIN...60900
      CALL PRSWDS(SSTSTR, ' ', 1, CSSTRA, NWORDS)                        SUTRA_MAIN...61000
      CALL PRSWDS(RDSTR,  ' ', 1, CREAD,  NWORDS)                        SUTRA_MAIN...61100
      ISMERR = 0                                                         SUTRA_MAIN...61200
      IF (CUNSAT.EQ.'UNSATURATED') THEN                                  SUTRA_MAIN...61300
         IUNSAT = +1                                                     SUTRA_MAIN...61400
      ELSE IF (CUNSAT.EQ.'SATURATED') THEN                               SUTRA_MAIN...61500
         IUNSAT = 0                                                      SUTRA_MAIN...61600
      ELSE                                                               SUTRA_MAIN...61700
         ERRCOD = 'INP-4-1'                                              SUTRA_MAIN...61800
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SUTRA_MAIN...61900
      END IF                                                             SUTRA_MAIN...62000
      IF (CSSFLO.EQ.'TRANSIENT') THEN                                    SUTRA_MAIN...62100
         ISSFLO = 0                                                      SUTRA_MAIN...62200
      ELSE IF (CSSFLO.EQ.'STEADY') THEN                                  SUTRA_MAIN...62300
         ISSFLO = +1                                                     SUTRA_MAIN...62400
      ELSE                                                               SUTRA_MAIN...62500
         ERRCOD = 'INP-4-2'                                              SUTRA_MAIN...62600
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SUTRA_MAIN...62700
      END IF                                                             SUTRA_MAIN...62800
      IF (CSSTRA.EQ.'TRANSIENT') THEN                                    SUTRA_MAIN...62900
         ISSTRA = 0                                                      SUTRA_MAIN...63000
      ELSE IF (CSSTRA.EQ.'STEADY') THEN                                  SUTRA_MAIN...63100
         ISSTRA = +1                                                     SUTRA_MAIN...63200
      ELSE                                                               SUTRA_MAIN...63300
         ERRCOD = 'INP-4-3'                                              SUTRA_MAIN...63400
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SUTRA_MAIN...63500
      END IF                                                             SUTRA_MAIN...63600
      IF (CREAD.EQ.'COLD') THEN                                          SUTRA_MAIN...63700
         IREAD = +1                                                      SUTRA_MAIN...63800
      ELSE IF (CREAD.EQ.'WARM') THEN                                     SUTRA_MAIN...63900
         IREAD = -1                                                      SUTRA_MAIN...64000
      ELSE                                                               SUTRA_MAIN...64100
         ERRCOD = 'INP-4-4'                                              SUTRA_MAIN...64200
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SUTRA_MAIN...64300
      END IF                                                             SUTRA_MAIN...64400
      WRITE(K3,214)                                                      SUTRA_MAIN...64500
  214 FORMAT(////11X,'S I M U L A T I O N   M O D E   ',                 SUTRA_MAIN...64600
     1   'O P T I O N S'/)                                               SUTRA_MAIN...64700
      IF(ISSTRA.EQ.1.AND.ISSFLO.NE.1) THEN                               SUTRA_MAIN...64800
         ERRCOD = 'INP-4-5'                                              SUTRA_MAIN...64900
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SUTRA_MAIN...65000
      ENDIF                                                              SUTRA_MAIN...65100
      IF(IUNSAT.EQ.+1) WRITE(K3,215)                                     SUTRA_MAIN...65200
      IF(IUNSAT.EQ.0) WRITE(K3,216)                                      SUTRA_MAIN...65300
  215 FORMAT(11X,'- ALLOW UNSATURATED AND SATURATED FLOW:  UNSATURATED', SUTRA_MAIN...65400
     1   ' PROPERTIES ARE USER-PROGRAMMED IN SUBROUTINE   U N S A T')    SUTRA_MAIN...65500
  216 FORMAT(11X,'- ASSUME SATURATED FLOW ONLY')                         SUTRA_MAIN...65600
      IF(ISSFLO.EQ.+1.AND.ME.EQ.-1) WRITE(K3,219)                        SUTRA_MAIN...65700
      IF(ISSFLO.EQ.+1.AND.ME.EQ.+1) WRITE(K3,220)                        SUTRA_MAIN...65800
      IF(ISSFLO.EQ.0) WRITE(K3,221)                                      SUTRA_MAIN...65900
  219 FORMAT(11X,'- ASSUME STEADY-STATE FLOW FIELD CONSISTENT WITH ',    SUTRA_MAIN...66000
     1   'INITIAL CONCENTRATION CONDITIONS')                             SUTRA_MAIN...66100
  220 FORMAT(11X,'- ASSUME STEADY-STATE FLOW FIELD CONSISTENT WITH ',    SUTRA_MAIN...66200
     1   'INITIAL TEMPERATURE CONDITIONS')                               SUTRA_MAIN...66300
  221 FORMAT(11X,'- ALLOW TIME-DEPENDENT FLOW FIELD')                    SUTRA_MAIN...66400
      IF(ISSTRA.EQ.+1) WRITE(K3,225)                                     SUTRA_MAIN...66500
      IF(ISSTRA.EQ.0) WRITE(K3,226)                                      SUTRA_MAIN...66600
  225 FORMAT(11X,'- ASSUME STEADY-STATE TRANSPORT')                      SUTRA_MAIN...66700
  226 FORMAT(11X,'- ALLOW TIME-DEPENDENT TRANSPORT')                     SUTRA_MAIN...66800
      IF(IREAD.EQ.-1) WRITE(K3,230)                                      SUTRA_MAIN...66900
      IF(IREAD.EQ.+1) WRITE(K3,231)                                      SUTRA_MAIN...67000
  230 FORMAT(11X,'- WARM START - SIMULATION IS TO BE ',                  SUTRA_MAIN...67100
     1   'CONTINUED FROM PREVIOUSLY-STORED DATA')                        SUTRA_MAIN...67200
  231 FORMAT(11X,'- COLD START - BEGIN NEW SIMULATION')                  SUTRA_MAIN...67300
      IF(ISTORE.GT.0) WRITE(K3,240) ISTORE                               SUTRA_MAIN...67400
      IF(ISTORE.EQ.0) WRITE(K3,241)                                      SUTRA_MAIN...67500
  240 FORMAT(11X,'- STORE RESULTS AFTER EVERY',I9,' TIME STEPS IN',      SUTRA_MAIN...67600
     1   ' RESTART FILE AS BACKUP AND FOR USE IN A SIMULATION RESTART')  SUTRA_MAIN...67700
  241 FORMAT(11X,'- DO NOT STORE RESULTS FOR USE IN A',                  SUTRA_MAIN...67800
     1   ' RESTART OF SIMULATION')                                       SUTRA_MAIN...67900
C.....OUTPUT DATASET 3                                                   SUTRA_MAIN...68000
      IF(ME.EQ.-1)                                                       SUTRA_MAIN...68100
     1   WRITE(K3,245) NN,NE,NPBC,NUBC,NSOP,NSOU,NOBS                    SUTRA_MAIN...68200
  245 FORMAT(////11X,'S I M U L A T I O N   C O N T R O L   ',           SUTRA_MAIN...68300
     1   'N U M B E R S'// 8X,I9,5X,'NUMBER OF NODES IN FINITE-',        SUTRA_MAIN...68400
     2   'ELEMENT MESH'/ 8X,I9,5X,'NUMBER OF ELEMENTS IN MESH'//         SUTRA_MAIN...68500
     3    8X,I9,5X,'EXACT NUMBER OF NODES IN MESH AT WHICH ',            SUTRA_MAIN...68600
     4   'PRESSURE IS A SPECIFIED CONSTANT OR FUNCTION OF TIME'/         SUTRA_MAIN...68700
     5    8X,I9,5X,'EXACT NUMBER OF NODES IN MESH AT WHICH ',            SUTRA_MAIN...68800
     6   'SOLUTE CONCENTRATION IS A SPECIFIED CONSTANT OR ',             SUTRA_MAIN...68900
     7   'FUNCTION OF TIME'// 8X,I9,5X,'EXACT NUMBER OF NODES AT',       SUTRA_MAIN...69000
     8   ' WHICH FLUID INFLOW OR OUTFLOW IS A SPECIFIED CONSTANT',       SUTRA_MAIN...69100
     9   ' OR FUNCTION OF TIME'/ 8X,I9,5X,'EXACT NUMBER OF NODES AT',    SUTRA_MAIN...69200
     A   ' WHICH A SOURCE OR SINK OF SOLUTE MASS IS A SPECIFIED ',       SUTRA_MAIN...69300
     B   'CONSTANT OR FUNCTION OF TIME'// 8X,I9,5X,'EXACT NUMBER OF ',   SUTRA_MAIN...69400
     C   'NODES AT WHICH PRESSURE AND CONCENTRATION WILL BE OBSERVED')   SUTRA_MAIN...69500
C                                                                        SUTRA_MAIN...69600
      IF(ME.EQ.+1)                                                       SUTRA_MAIN...69700
     1    WRITE(K3,247) NN,NE,NPBC,NUBC,NSOP,NSOU,NOBS                   SUTRA_MAIN...69800
  247 FORMAT(////11X,'S I M U L A T I O N   C O N T R O L   ',           SUTRA_MAIN...69900
     1   'N U M B E R S'// 8X,I9,5X,'NUMBER OF NODES IN FINITE-',        SUTRA_MAIN...70000
     2   'ELEMENT MESH'/ 8X,I9,5X,'NUMBER OF ELEMENTS IN MESH'//         SUTRA_MAIN...70100
     3    8X,I9,5X,'EXACT NUMBER OF NODES IN MESH AT WHICH ',            SUTRA_MAIN...70200
     4   'PRESSURE IS A SPECIFIED CONSTANT OR FUNCTION OF TIME'/         SUTRA_MAIN...70300
     5    8X,I9,5X,'EXACT NUMBER OF NODES IN MESH AT WHICH ',            SUTRA_MAIN...70400
     6   'TEMPERATURE IS A SPECIFIED CONSTANT OR ',                      SUTRA_MAIN...70500
     7   'FUNCTION OF TIME'// 8X,I9,5X,'EXACT NUMBER OF NODES AT',       SUTRA_MAIN...70600
     8   ' WHICH FLUID INFLOW OR OUTFLOW IS A SPECIFIED CONSTANT',       SUTRA_MAIN...70700
     9   ' OR FUNCTION OF TIME'/ 8X,I9,5X,'EXACT NUMBER OF NODES AT',    SUTRA_MAIN...70800
     A   ' WHICH A SOURCE OR SINK OF ENERGY IS A SPECIFIED CONSTANT',    SUTRA_MAIN...70900
     B   ' OR FUNCTION OF TIME'// 8X,I9,5X,'EXACT NUMBER OF NODES ',     SUTRA_MAIN...71000
     C   'AT WHICH PRESSURE AND TEMPERATURE WILL BE OBSERVED')           SUTRA_MAIN...71100
C                                                                        SUTRA_MAIN...71200
C.....INPUT DATASETS 5 - 7 (NUMERICAL, TEMPORAL, AND ITERATION CONTROLS) SUTRA_MAIN...71300
      CALL INDAT0()                                                      SUTRA_MAIN...71400
C.....KSOLVP AND KSOLVU HAVE BEEN SET ACCORDING TO THE SOLVERS SELECTED: SUTRA_MAIN...71500
C        BANDED GAUSSIAN ELIMINATION (DIRECT)   ==>   0                  SUTRA_MAIN...71600
C        IC-PRECONDITIONED CG                   ==>   1                  SUTRA_MAIN...71700
C        ILU-PRECONDITIONED GMRES               ==>   2                  SUTRA_MAIN...71800
C        ILU-PRECONDITIONED ORTHOMIN            ==>   3                  SUTRA_MAIN...71900
C                                                                        SUTRA_MAIN...72000
C.....OUTPUT DATASETS 7B & 7C                                            SUTRA_MAIN...72100
      WRITE(K3,261)                                                      SUTRA_MAIN...72200
  261 FORMAT(////11X,'S O L V E R - R E L A T E D   ',                   SUTRA_MAIN...72300
     1   'P A R A M E T E R S')                                          SUTRA_MAIN...72400
C.....OUTPUT DATASETS 3B & 3C                                            SUTRA_MAIN...72500
  266 IF (KSOLVP.NE.0) THEN                                              SUTRA_MAIN...72600
         WRITE(K3,268)                                                   SUTRA_MAIN...72700
     1      SOLNAM(KSOLVP), ITRMXP, TOLP,                                SUTRA_MAIN...72800
     2      SOLNAM(KSOLVU), ITRMXU, TOLU                                 SUTRA_MAIN...72900
  268    FORMAT(                                                         SUTRA_MAIN...73000
     1      /13X,'SOLVER FOR P: ',A40                                    SUTRA_MAIN...73100
     2      //20X,I6,5X,'MAXIMUM NUMBER OF MATRIX SOLVER ITERATIONS',    SUTRA_MAIN...73200
     3           ' DURING P SOLUTION'                                    SUTRA_MAIN...73300
     4      /11X,1PE15.4,5X,'CONVERGENCE TOLERANCE FOR MATRIX',          SUTRA_MAIN...73400
     5           ' SOLVER ITERATIONS DURING P SOLUTION'                  SUTRA_MAIN...73500
     6      //13X,'SOLVER FOR U: ',A40                                   SUTRA_MAIN...73600
     7      //20X,I6,5X,'MAXIMUM NUMBER OF MATRIX SOLVER ITERATIONS',    SUTRA_MAIN...73700
     8           ' DURING U SOLUTION'                                    SUTRA_MAIN...73800
     9      /11X,1PE15.4,5X,'CONVERGENCE TOLERANCE FOR MATRIX',          SUTRA_MAIN...73900
     A           ' SOLVER ITERATIONS DURING U SOLUTION' )                SUTRA_MAIN...74000
      ELSE                                                               SUTRA_MAIN...74100
         WRITE(K3,269) SOLNAM(KSOLVP)                                    SUTRA_MAIN...74200
  269    FORMAT(/13X,'SOLVER FOR P AND U: ',A40)                         SUTRA_MAIN...74300
      END IF                                                             SUTRA_MAIN...74400
C                                                                        SUTRA_MAIN...74500
C.....CALCULATE ARRAY DIMENSIONS, EXCEPT THOSE THAT DEPEND ON            SUTRA_MAIN...74600
C        BANDWIDTH OR NELT                                               SUTRA_MAIN...74700
C                                                                        SUTRA_MAIN...74800
      IF (KSOLVP.EQ.0) THEN                                              SUTRA_MAIN...74900
C........SET DIMENSIONS FOR DIRECT SOLVER                                SUTRA_MAIN...75000
         NNNX = 1                                                        SUTRA_MAIN...75100
         NDIMJA = 1                                                      SUTRA_MAIN...75200
         NNVEC = NN                                                      SUTRA_MAIN...75300
      ELSE                                                               SUTRA_MAIN...75400
C........SET DIMENSIONS FOR ITERATIVE SOLVER(S)                          SUTRA_MAIN...75500
         NNNX = NN                                                       SUTRA_MAIN...75600
         NDIMJA = NN + 1                                                 SUTRA_MAIN...75700
         NNVEC = NN                                                      SUTRA_MAIN...75800
      END IF                                                             SUTRA_MAIN...75900
      NBCN=NPBC+NUBC+1                                                   SUTRA_MAIN...76000
      NSOP=NSOP+1                                                        SUTRA_MAIN...76100
      NSOU=NSOU+1                                                        SUTRA_MAIN...76200
      NOBSN=NOBS+1                                                       SUTRA_MAIN...76300
      IF (KTYPE(1).EQ.3) THEN                                            SUTRA_MAIN...76400
         N48 = 8                                                         SUTRA_MAIN...76500
         NEX = NE                                                        SUTRA_MAIN...76600
      ELSE                                                               SUTRA_MAIN...76700
         N48 = 4                                                         SUTRA_MAIN...76800
         NEX = 1                                                         SUTRA_MAIN...76900
      END IF                                                             SUTRA_MAIN...77000
      NIN=NE*N48                                                         SUTRA_MAIN...77100
C                                                                        SUTRA_MAIN...77200
C.....ALLOCATE REAL ARRAYS, EXCEPT THOSE THAT DEPEND ON BANDWIDTH        SUTRA_MAIN...77300
      ALLOCATE(PITER(NN),UITER(NN),PM1(NN),DPDTITR(NN),UM1(NN),UM2(NN),  SUTRA_MAIN...77400
     1   PVEL(NN),SL(NN),SR(NN),X(NN),Y(NN),Z(NN),VOL(NN),POR(NN),       SUTRA_MAIN...77500
     2   CS1(NN),CS2(NN),CS3(NN),SW(NN),DSWDP(NN),RHO(NN),SOP(NN),       SUTRA_MAIN...77600
     3   QIN(NN),UIN(NN),QUIN(NN),QINITR(NN),RCIT(NN),RCITM1(NN))        SUTRA_MAIN...77700
      ALLOCATE(PVEC(NNVEC),UVEC(NNVEC))                                  SUTRA_MAIN...77800
      ALLOCATE(ALMAX(NE),ALMIN(NE),ATMAX(NE),ATMIN(NE),VMAG(NE),         SUTRA_MAIN...77900
     1   VANG1(NE),PERMXX(NE),PERMXY(NE),PERMYX(NE),PERMYY(NE),          SUTRA_MAIN...78000
     2   PANGL1(NE))                                                     SUTRA_MAIN...78100
      ALLOCATE(ALMID(NEX),ATMID(NEX),                                    SUTRA_MAIN...78200
     1   VANG2(NEX),PERMXZ(NEX),PERMYZ(NEX),PERMZX(NEX),                 SUTRA_MAIN...78300
     2   PERMZY(NEX),PERMZZ(NEX),PANGL2(NEX),PANGL3(NEX))                SUTRA_MAIN...78400
      ALLOCATE(PBC(NBCN),UBC(NBCN),QPLITR(NBCN),GNUP1(NBCN),GNUU1(NBCN)) SUTRA_MAIN...78500
      ALLOCATE(GXSI(NE,N48),GETA(NE,N48),GZET(NEX,N48))                  SUTRA_MAIN...78600
      ALLOCATE(B(NNNX))                                                  SUTRA_MAIN...78700
C.....ALLOCATE INTEGER ARRAYS, EXCEPT THOSE THAT DEPEND ON BANDWIDTH     SUTRA_MAIN...78800
C        OR NELT                                                         SUTRA_MAIN...78900
      ALLOCATE(IN(NIN),IQSOP(NSOP),IQSOU(NSOU),IPBC(NBCN),IUBC(NBCN),    SUTRA_MAIN...79000
     1   NREG(NN),LREG(NE),JA(NDIMJA))                                   SUTRA_MAIN...79100
      ALLOCATE(NDPT(NSOP),NREF(NSOP),HAREA(NSOP),VAREA(NSOP),
     1   FAREA(NSOP))
      ALLOCATE(HANN(NN),VANN(NN),FANN(NN))
      ALLOCATE(WMA(NN),SMA(NN),POR1(NN),REK(NE),TPT(NN),QLY(NE),YY(NN),
     1   XX(NN),QLX(NE),TPT1(NN),QXF(NE),QYF(NE),SPF(NE),RPF(NE))
      ALLOCATE(HSS(NN1))
      ALLOCATE(DFR(NSOP),PWFR(NSOP),PCFR(NSOP))
C     QVYN FOR VAPOR FLUX, USED IN ENERGY TRANSPORT EQUATION HEAT 
      ALLOCATE(QVYN(NN1-1))
C      TPT(1-NN) TEMPERATURE AT EACH CELL/NODE
C       TPT1(1-NN) TEMPERATURE OF THE LAST TIME STEP AT EACH NODE
      ALLOCATE(IIDPBC(NBCN),IIDUBC(NBCN),IIDSOP(NSOP),IIDSOU(NSOU))      SUTRA_MAIN...79200
C.....ALLOCATE INTEGER(1) ARRAYS, EXCEPT THOSE THAT DEPEND ON BANDWIDTH  SUTRA_MAIN...79300
C        OR NELT                                                         SUTRA_MAIN...79400
      ALLOCATE(IBCPBC(NBCN),IBCUBC(NBCN),IBCSOP(NSOP),IBCSOU(NSOU))      SUTRA_MAIN...79500
C.....ALLOCATE ARRAYS OF DERIVED TYPE, EXCEPT THOSE THAT DEPEND ON       SUTRA_MAIN...79600
C        BANDWIDTH OR NELT                                               SUTRA_MAIN...79700
      ALLOCATE(BCSFL(0:ITMAX),BCSTR(0:ITMAX))                            SUTRA_MAIN...79800
C.....ALLOCATE ARRAYS OF DERIVED TYPE, EXCEPT THOSE THAT DEPEND ON       SUTRA_MAIN...79900
C        BANDWIDTH OR NELT                                               SUTRA_MAIN...80000
      ALLOCATE(OBSPTS(NOBSN))                                            SUTRA_MAIN...80100
      ALLO1 = .TRUE.                                                     SUTRA_MAIN...80200
C                                                                        SUTRA_MAIN...80300
C.....INPUT DATASETS 8 - 15 (OUTPUT CONTROLS; FLUID AND SOLID MATRIX     SUTRA_MAIN...80400
C        PROPERTIES; ADSORPTION PARAMETERS; PRODUCTION OF ENERGY OR      SUTRA_MAIN...80500
C        SOLUTE MASS; GRAVITY; AND NODEWISE AND ELEMENTWISE DATA)        SUTRA_MAIN...80600
      CALL INDAT1(X,Y,Z,POR,ALMAX,ALMID,ALMIN,ATMAX,ATMID,ATMIN,         SUTRA_MAIN...80700
     1   PERMXX,PERMXY,PERMXZ,PERMYX,PERMYY,PERMYZ,                      SUTRA_MAIN...80800
     2   PERMZX,PERMZY,PERMZZ,PANGL1,PANGL2,PANGL3,SOP,NREG,LREG,        SUTRA_MAIN...80900
     3   OBSPTS,POR1)
C     3   OBSPTS)                                                         SUTRA_MAIN...81000
C                                                                        SUTRA_MAIN...81100
C     HERE SHOULD NOT HAVE ANY GENERAL CALCULATIONS BECAUSE SUTRA_MAIN IS FOR 
C     LARGE SUBROUTINES
      IF (UVM.NE.0.) ALLOCATE(SM(NNVEC),SM1(NNVEC))
      CALL ZERO(SM,NNVEC,0.0D0)
      CALL ZERO(SM1,NNVEC,0.0D0)
      CALL ZERO(REK,NE,0.0D0)
      CALL ZERO(TPT,NN,0.D0)
      CALL ZERO(TPT1,NN,0.D0)
C.....SETTING TPT AS INITIAL TEMPERATURE TMA
C.....KEEP TRACK IF OUTPUT ROUTINES HAVE BEEN EXECUTED, TO PRINT         SUTRA_MAIN...81200
C        HEADERS ONLY ONCE.                                              SUTRA_MAIN...81300
      ONCEK5 = .FALSE.                                                   SUTRA_MAIN...81400
      ONCEK6 = .FALSE.                                                   SUTRA_MAIN...81500
      ONCEK7 = .FALSE.                                                   SUTRA_MAIN...81600
      ONCEK8 = .FALSE.                                                   SUTRA_MAIN...81700
      ALLOCATE(ONCK78(NFLOMX))                                           SUTRA_MAIN...81800
      DO 400 J=1,NFLOMX                                                  SUTRA_MAIN...81900
         ONCK78(J) = .FALSE.                                             SUTRA_MAIN...82000
  400 CONTINUE                                                           SUTRA_MAIN...82100
      ONCEK10 = .FALSE.                                                  SUTRA_MAIN...82200
      ONCEK11 = .FALSE.                                                  SUTRA_MAIN...82300
      ONCEK12 = .FALSE.                                                  SUTRA_MAIN...82400
      ONCEK13 = .FALSE.                                                  SUTRA_MAIN...82500
C                                                                        SUTRA_MAIN...82600
C.....INITIALIZE BCTIME CONDITION FLAGS                                  SUTRA_MAIN...82610
      IQSOPT = 1                                                         SUTRA_MAIN...82620
      IQSOUT = 1                                                         SUTRA_MAIN...82630
      IPBCT = 1                                                          SUTRA_MAIN...82640
      IUBCT = 1                                                          SUTRA_MAIN...82650
C                                                                        SUTRA_MAIN...82600
C.....INPUT DATASETS 17 & 18 (SOURCES OF FLUID MASS AND ENERGY OR        SUTRA_MAIN...82700
C        SOLUTE MASS)                                                    SUTRA_MAIN...82800
      CALL ZERO(QIN,NN,0.0D0)                                            SUTRA_MAIN...82900
      CALL ZERO(UIN,NN,0.0D0)                                            SUTRA_MAIN...83000
      CALL ZERO(QUIN,NN,0.0D0)                                           SUTRA_MAIN...83100
      CALL ZERO(DFR,NSOP,0.0D0)
      CALL ZERO(PWFR,NSOP,0.0D0)
      CALL ZERO(PCFR,NSOP,0.0D0)
      NDPT=0
      NREF=0
      IF(NSOP-1.GT.0.OR.NSOU-1.GT.0)                                     SUTRA_MAIN...83200
     1   CALL SOURCE(QIN,UIN,IQSOP,QUIN,IQSOU,IQSOPT,IQSOUT,             SUTRA_MAIN...83300
     2      IBCSOP,IBCSOU,NDPT,NREF)
C    SINKAREA NOLONGER SITS HERE BECAUSE HAREA,VAREA AND FAREA ARE DEPENDENT ON THE RESULT OF 
C   VOL
C      IF (IQSOPT.EQ.-1) CALL SINKAREA(X,Y,Z,HAREA,VAREA,FAREA,IQSOP
C     1,NDPT,NREF,YY, XX)
C     2      IBCSOP,IBCSOU)                                               SUTRA_MAIN...83400
C                                                                        SUTRA_MAIN...83500
C.....INPUT DATASETS 19 & 20 (SPECIFIED P AND U BOUNDARY CONDITIONS)     SUTRA_MAIN...83600
      IF(NBCN-1.GT.0) CALL BOUND(IPBC,PBC,IUBC,UBC,IPBCT,IUBCT,          SUTRA_MAIN...83700
     1   IBCPBC,IBCUBC,GNUP1,GNUU1)                                      SUTRA_MAIN...83800
C                                                                        SUTRA_MAIN...83900
C.....INPUT DATASET 22 (ELEMENT INCIDENCE [MESH CONNECTION] DATA)        SUTRA_MAIN...84000
      CALL CONNEC(IN)                                                    SUTRA_MAIN...84100
C                                                                        SUTRA_MAIN...84200
C.....IF USING OLD (VERSION 2D3D.1) OBSERVATION INPUT FORMAT, LOOK UP    SUTRA_MAIN...84300
C        COORDINATES FOR OBSERVATION POINTS (NODES).                     SUTRA_MAIN...84400
      IF (NOBCYC.NE.-1) THEN                                             SUTRA_MAIN...84500
         DO 710 K=1,NOBS                                                 SUTRA_MAIN...84600
            I = OBSPTS(K)%L                                              SUTRA_MAIN...84700
            OBSPTS(K)%X = X(I)                                           SUTRA_MAIN...84800
            OBSPTS(K)%Y = Y(I)                                           SUTRA_MAIN...84900
            IF (N48.EQ.8) OBSPTS(K)%Z = Z(I)                             SUTRA_MAIN...85000
  710    CONTINUE                                                        SUTRA_MAIN...85100
      END IF                                                             SUTRA_MAIN...85200
C                                                                        SUTRA_MAIN...85300
C.....FIND THE ELEMENT EACH OBSERVATION POINT IS IN.  IN COMPONENTS OF   SUTRA_MAIN...85400
C        OBSPTS, OVERWRITE NODE NUMBERS AND GLOBAL COORDINATES WITH      SUTRA_MAIN...85500
C        ELEMENT NUMBERS AND LOCAL COORDINATES.                          SUTRA_MAIN...85600
      DO 900 K=1,NOBS                                                    SUTRA_MAIN...85700
         XK = OBSPTS(K)%X                                                SUTRA_MAIN...85800
         YK = OBSPTS(K)%Y                                                SUTRA_MAIN...85900
         IF (N48.EQ.8) ZK = OBSPTS(K)%Z                                  SUTRA_MAIN...86000
         DO 800 LL=1,NE                                                  SUTRA_MAIN...86100
            IF (N48.EQ.8) THEN                                           SUTRA_MAIN...86200
               CALL FINDL3(X,Y,Z,IN,LL,XK,YK,ZK,XSI,ETA,ZET,INOUT)       SUTRA_MAIN...86300
            ELSE                                                         SUTRA_MAIN...86400
               CALL FINDL2(X,Y,IN,LL,XK,YK,XSI,ETA,INOUT)                SUTRA_MAIN...86500
            END IF                                                       SUTRA_MAIN...86600
            IF (INOUT.EQ.1) THEN                                         SUTRA_MAIN...86700
               L = LL                                                    SUTRA_MAIN...86800
               GOTO 820                                                  SUTRA_MAIN...86900
            END IF                                                       SUTRA_MAIN...87000
  800    CONTINUE                                                        SUTRA_MAIN...87100
         ERRCOD = 'INP-8D-3'                                             SUTRA_MAIN...87200
         CHERR(1) = OBSPTS(K)%NAME                                       SUTRA_MAIN...87300
         WRITE(UNIT=CHERR(2), FMT=805)                                   SUTRA_MAIN...87400
     1      OBSPTS(K)%X, OBSPTS(K)%Y, OBSPTS(K)%Z                        SUTRA_MAIN...87500
  805    FORMAT('(',2(1PE14.7,','),1PE14.7,')')                          SUTRA_MAIN...87600
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SUTRA_MAIN...87700
  820    OBSPTS(K)%L = L                                                 SUTRA_MAIN...87800
         OBSPTS(K)%XSI = XSI                                             SUTRA_MAIN...87900
         OBSPTS(K)%ETA = ETA                                             SUTRA_MAIN...88000
         IF (N48.EQ.8) OBSPTS(K)%ZET = ZET                               SUTRA_MAIN...88100
  900 CONTINUE                                                           SUTRA_MAIN...88200
C                                                                        SUTRA_MAIN...88300
C.....IF ITERATIVE SOLVER IS USED, SET UP POINTER ARRAYS IA AND JA THAT  SUTRA_MAIN...88400
C        SPECIFY MATRIX STRUCTURE IN "SLAP COLUMN" FORMAT.  DIMENSION    SUTRA_MAIN...88500
C        NELT GETS SET HERE.                                             SUTRA_MAIN...88600
      IF (KSOLVP.NE.0) THEN                                              SUTRA_MAIN...88700
         CALL PTRSET()                                                   SUTRA_MAIN...88800
      ELSE                                                               SUTRA_MAIN...88900
         NELT = NN                                                       SUTRA_MAIN...89000
         NDIMIA = 1                                                      SUTRA_MAIN...89100
         ALLOCATE(IA(NDIMIA))                                            SUTRA_MAIN...89200
      END IF                                                             SUTRA_MAIN...89300
      ALLO3 = .TRUE.                                                     SUTRA_MAIN...89400
C                                                                        SUTRA_MAIN...89500
C.....CALCULATE BANDWIDTH                                                SUTRA_MAIN...89600
      CALL BANWID(IN)                                                    SUTRA_MAIN...89700
C                                                                        SUTRA_MAIN...89800
C.....CALCULATE ARRAY DIMENSIONS THAT DEPEND ON BANDWIDTH OR NELT        SUTRA_MAIN...89900
      IF (KSOLVP.EQ.0) THEN                                              SUTRA_MAIN...90000
C........SET DIMENSIONS FOR DIRECT SOLVER                                SUTRA_MAIN...90100
         NCBI = NBI                                                      SUTRA_MAIN...90200
         NELTA = NELT                                                    SUTRA_MAIN...90300
         NWI = 1                                                         SUTRA_MAIN...90400
         NWF = 1                                                         SUTRA_MAIN...90500
      ELSE                                                               SUTRA_MAIN...90600
C........SET DIMENSIONS FOR ITERATIVE SOLVER(S)                          SUTRA_MAIN...90700
         NCBI = 1                                                        SUTRA_MAIN...90800
         NELTA = NELT                                                    SUTRA_MAIN...90900
         KSOLVR = KSOLVP                                                 SUTRA_MAIN...91000
         NSAVE = NSAVEP                                                  SUTRA_MAIN...91100
         CALL DIMWRK(KSOLVR, NSAVE, NN, NELTA, NWIP, NWFP)               SUTRA_MAIN...91200
         KSOLVR = KSOLVU                                                 SUTRA_MAIN...91300
         NSAVE = NSAVEU                                                  SUTRA_MAIN...91400
         CALL DIMWRK(KSOLVR, NSAVE, NN, NELTA, NWIU, NWFU)               SUTRA_MAIN...91500
         NWI = MAX(NWIP, NWIU)                                           SUTRA_MAIN...91600
         NWF = MAX(NWFP, NWFU)                                           SUTRA_MAIN...91700
      END IF                                                             SUTRA_MAIN...91800
      MATDIM=NELT*NCBI                                                   SUTRA_MAIN...91900
C                                                                        SUTRA_MAIN...92000
C.....ALLOCATE REAL AND INTEGER ARRAYS THAT DEPEND ON BANDWIDTH OR NELT  SUTRA_MAIN...92100
      ALLOCATE(PMAT(NELT,NCBI),UMAT(NELT,NCBI),FWK(NWF))                 SUTRA_MAIN...92200
      ALLOCATE(IWK(NWI))                                                 SUTRA_MAIN...92300
      ALLO2 = .TRUE.                                                     SUTRA_MAIN...92400
C                                                                        SUTRA_MAIN...92500
C.....READ BCS SCHEDULES AND CHECK BCS BOUNDARY CONDITIONS FOR           SUTRA_MAIN...92600
C        INPUT ERRORS.  DETERMINE SIZE OF BCS IDENTIFIER ARRAY.          SUTRA_MAIN...92700
      NCIDB = 1                                                          SUTRA_MAIN...92800
      ALLOCATE(CIDBCS(NCIDB))                                            SUTRA_MAIN...92900
      IF (K9.NE.-1) THEN                                                 SUTRA_MAIN...93000
C........SET UP ARRAY OF SCHEDULE NUMBERS, BCP                           SUTRA_MAIN...93100
         ALLOCATE (BFP(NFBCS))                                           SUTRA_MAIN...93200
         DO 2100 NFB=1,NFBCS                                             SUTRA_MAIN...93300
            K9 = IUNIB(NFB)                                              SUTRA_MAIN...93400
C...........SET FNAME(9) EQUAL TO FNAMB(NFB) FOR CONVENIENCE IN          SUTRA_MAIN...93500
C              ERROR HANDLING                                            SUTRA_MAIN...93600
            FNAME(9) = FNAMB(NFB)                                        SUTRA_MAIN...93700
C...........READ SCHEDULE NAME FOR CURRENT BCS FILE.                     SUTRA_MAIN...93800
            ERRCOD = 'REA-BCS-1'                                         SUTRA_MAIN...93900
            CHERR(1) = 'n/a'                                             SUTRA_MAIN...94000
            CHERR(2) = 'n/a'                                             SUTRA_MAIN...94100
            CALL READIF(K9, NFB, INTFIL, ERRCOD, CHERR)                  SUTRA_MAIN...94200
            READ(INTFIL,*,IOSTAT=INERR(1)) CDUM80                        SUTRA_MAIN...94300
            IF (LEN_TRIM(CDUM80).GT.10) THEN                             SUTRA_MAIN...94400
               ERRCOD = 'BCS-1-4'                                        SUTRA_MAIN...94500
               CHERR(1) = CDUM80                                         SUTRA_MAIN...94600
               CHERR(2) = FNAME(9)                                       SUTRA_MAIN...94700
               CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                  SUTRA_MAIN...94800
            END IF                                                       SUTRA_MAIN...94900
            READ(INTFIL,*,IOSTAT=INERR(1)) BCSSCH                        SUTRA_MAIN...95000
            IF (INERR(1).NE.0)                                           SUTRA_MAIN...95100
     1            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)               SUTRA_MAIN...95200
C...........FIND SCHEDULE NUMBER IN LIST.  IF NOT FOUND, ERROR.          SUTRA_MAIN...95300
            DO 2050 NS=1,NSCH                                            SUTRA_MAIN...95400
               IF (BCSSCH.EQ.SCHDLS(NS)%NAME) THEN                       SUTRA_MAIN...95500
                  BFP(NFB)%ISCHED = NS                                   SUTRA_MAIN...95600
                  DENB => SCHDLS(BFP(NFB)%ISCHED)%SLIST                  SUTRA_MAIN...95700
                  LENSCH = SCHDLS(BFP(NFB)%ISCHED)%LLEN                  SUTRA_MAIN...95800
                  DO 2000 LC=1,LENSCH                                    SUTRA_MAIN...95900
                     DITBCS = DENB%DVALU2                                SUTRA_MAIN...96000
                     ITBCS = INT(DITBCS)                                 SUTRA_MAIN...96100
                     IF (DBLE(ITBCS).NE.DITBCS) THEN                     SUTRA_MAIN...96200
                        ERRCOD = 'BCS-1-2'                               SUTRA_MAIN...96300
                        CHERR(1) = BCSSCH                                SUTRA_MAIN...96400
                        CHERR(2) = FNAME(9)                              SUTRA_MAIN...96500
                        RLERR(1) = DITBCS                                SUTRA_MAIN...96600
                        CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)         SUTRA_MAIN...96700
                     END IF                                              SUTRA_MAIN...96800
                     IF (LC.LT.LENSCH) DENB => DENB%NENT                 SUTRA_MAIN...96900
 2000             CONTINUE                                               SUTRA_MAIN...97000
                  GOTO 2100                                              SUTRA_MAIN...97100
               END IF                                                    SUTRA_MAIN...97200
 2050       CONTINUE                                                     SUTRA_MAIN...97300
            IF (ISSTRA.NE.1) THEN                                        SUTRA_MAIN...97400
               ERRCOD = 'BCS-1-1'                                        SUTRA_MAIN...97500
            ELSE                                                         SUTRA_MAIN...97600
               ERRCOD = 'BCS-1-3'                                        SUTRA_MAIN...97700
            END IF                                                       SUTRA_MAIN...97800
            CHERR(1) = BCSSCH                                            SUTRA_MAIN...97900
            CHERR(2) = FNAME(9)                                          SUTRA_MAIN...98000
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     SUTRA_MAIN...98100
 2100    CONTINUE                                                        SUTRA_MAIN...98200
C........READ THROUGH FILES TO SEARCH FOR INPUT ERRORS, BUT DO NOT       SUTRA_MAIN...98300
C           ACTUALLY SET THE BOUNDARY CONDITIONS (SETBCS = .FALSE.)      SUTRA_MAIN...98400
         SETBCS = .FALSE.                                                SUTRA_MAIN...98500
         DENB => SCHDLS(ISCHTS)%SLIST                                    SUTRA_MAIN...98600
         LENSCH = SCHDLS(ISCHTS)%LLEN                                    SUTRA_MAIN...98700
         DO 2200 LC=1,LENSCH                                             SUTRA_MAIN...98800
            DITBCS = DENB%DVALU2                                         SUTRA_MAIN...98900
            ITBCS = INT(DITBCS)                                          SUTRA_MAIN...99000
            CALL BCSTEP(SETBCS,IPBC,PBC,IUBC,UBC,QIN,UIN,QUIN,IQSOP,     SUTRA_MAIN...99100
     1         IQSOU,IPBCT1,IUBCT1,IQSOPT1,IQSOUT1,GNUP1,GNUU1,          SUTRA_MAIN...99200
     2         IBCPBC,IBCUBC,IBCSOP,IBCSOU,IIDPBC,IIDUBC,IIDSOP,         SUTRA_MAIN...99300
     3         IIDSOU,NCID,BCSFL,BCSTR)                                  SUTRA_MAIN...99400
            NCIDB = MAX(NCIDB, NCID)                                     SUTRA_MAIN...99500
            IF (LC.LT.LENSCH) DENB => DENB%NENT                          SUTRA_MAIN...99600
 2200    CONTINUE                                                        SUTRA_MAIN...99700
C........TO CLOSE ALL INSERTED FILES, KEEP READING UNTIL END OF ZERO-    SUTRA_MAIN...99800
C           LEVEL FILE IS ENCOUNTERED.  THEN REWIND ZERO-LEVEL FILE      SUTRA_MAIN...99900
C           AND RE-READ THE SCHEDULE NAME.                               SUTRA_MAIN..100000
         DO 2300 NFB=1,NFBCS                                             SUTRA_MAIN..100100
            K9 = IUNIB(NFB)                                              SUTRA_MAIN..100200
            ERRCOD = 'NO_EOF_ERR'                                        SUTRA_MAIN..100300
            CHERR(1) = 'n/a'                                             SUTRA_MAIN..100400
            CHERR(2) = 'n/a'                                             SUTRA_MAIN..100500
            DO WHILE (ERRCOD.NE.'EOF')                                   SUTRA_MAIN..100600
               CALL READIF(K9, NFB, INTFIL, ERRCOD, CHERR)               SUTRA_MAIN..100700
            END DO                                                       SUTRA_MAIN..100800
            REWIND (K9)                                                  SUTRA_MAIN..100900
            CALL READIF(K9, NFB, INTFIL, ERRCOD, CHERR)                  SUTRA_MAIN..101000
            READ(INTFIL,*,IOSTAT=INERR(1)) BCSSCH                        SUTRA_MAIN..101100
 2300    CONTINUE                                                        SUTRA_MAIN..101200
      ELSE                                                               SUTRA_MAIN..101300
C........IF NO BCS FILES, ZERO OUT BCS ID ARRAYS FOR NEATNESS.           SUTRA_MAIN..101400
         IIDSOP = 0                                                      SUTRA_MAIN..101500
         IIDSOU = 0                                                      SUTRA_MAIN..101600
         IIDPBC = 0                                                      SUTRA_MAIN..101700
         IIDUBC = 0                                                      SUTRA_MAIN..101800
      END IF                                                             SUTRA_MAIN..101900
C.....ALLOCATION OF BCS IDENTIFIER ARRAY IS DONE IN SUBROUTINE INDAT2.   SUTRA_MAIN..102000
C                                                                        SUTRA_MAIN..102100
C.....INPUT INITIAL OR RESTART CONDITIONS FROM THE ICS FILE AND          SUTRA_MAIN..102200
C        INITIALIZE PARAMETERS                                           SUTRA_MAIN..102300
      CALL INDAT2(PVEC,UVEC,PM1,UM1,UM2,CS1,CS2,CS3,SL,SR,RCIT,SW,DSWDP, SUTRA_MAIN..102400
     1   PBC,IPBC,IPBCT,NREG,QIN,DPDTITR,GNUP1,GNUU1,UIN,UBC,QUIN,       SUTRA_MAIN..102500
     2   IBCPBC,IBCUBC,IBCSOP,IBCSOU,IIDPBC,IIDUBC,IIDSOP,IIDSOU,TPT)
C     2   IBCPBC,IBCUBC,IBCSOP,IBCSOU,IIDPBC,IIDUBC,IIDSOP,IIDSOU)        SUTRA_MAIN..102600
C                                                                        SUTRA_MAIN..102700
C.....COMPUTE AND OUTPUT DIMENSIONS OF SIMULATION                        SUTRA_MAIN..102800
      IF (K9.NE.-1) THEN                                                 SUTRA_MAIN..102900
         NRBCS = 3*NN + 4*NBCN                                           SUTRA_MAIN..103000
         NI1BCS = 2*NBCN + NSOP + NSOU                                   SUTRA_MAIN..103100
      ELSE                                                               SUTRA_MAIN..103200
         NRBCS = 7                                                       SUTRA_MAIN..103300
         NI1BCS = 4                                                      SUTRA_MAIN..103400
      END IF                                                             SUTRA_MAIN..103500
      RMVDIM = 27*NN + 11*NE + 10*NEX + 3*NBCN + N48*(2*NE + NEX)        SUTRA_MAIN..103600
     1   + NNNX + 2*NELT*NCBI + NWF + 6*NOBSN + 3*NSCH + NRBCS           SUTRA_MAIN..103700
      IMVDIM = NIN + 2*NSOP + 2*NSOU + 4*NBCN + NN + NE                  SUTRA_MAIN..103800
     1   + NDIMJA + NDIMIA + NWI + NOBSN + 3*NSCH                        SUTRA_MAIN..103900
      I1VDIM = NI1BCS                                                    SUTRA_MAIN..104000
      CMVDIM = 73*NOBS + 89*NSCH + NCIDB                                 SUTRA_MAIN..104100
      PMVDIM = 2*NSCH                                                    SUTRA_MAIN..104200
      LMVDIM = ITMAX                                                     SUTRA_MAIN..104300
      TOTMB = (DBLE(RMVDIM)*8D0 + DBLE(IMVDIM)*4D0 + DBLE(I1VDIM)        SUTRA_MAIN..104400
     1   + DBLE(CMVDIM) + DBLE(LMVDIM)*4D0)/1D6                          SUTRA_MAIN..104500
      WRITE(K3,3000) RMVDIM,IMVDIM,I1VDIM,CMVDIM,LMVDIM,PMVDIM,TOTMB     SUTRA_MAIN..104600
 3000 FORMAT(////11X,'S I M U L A T I O N   D I M E N S I O N S'//       SUTRA_MAIN..104700
     1   13X,'REAL        ARRAYS WERE ALLOCATED ',I12/                   SUTRA_MAIN..104800
     2   13X,'INTEGER     ARRAYS WERE ALLOCATED ',I12/                   SUTRA_MAIN..104900
     3   13X,'INTEGER(1)  ARRAYS WERE ALLOCATED ',I12/                   SUTRA_MAIN..105000
     4   13X,'CHARACTER   ARRAYS WERE ALLOCATED ',I12,                   SUTRA_MAIN..105100
     5       ' (SUM OF ARRAY_DIMENSION*CHARACTER_LENGTH)'/               SUTRA_MAIN..105200
     6   13X,'LOGICAL     ARRAYS WERE ALLOCATED ',I12/                   SUTRA_MAIN..105300
     7   13X,'ARRAYS OF POINTERS WERE ALLOCATED ',I12//                  SUTRA_MAIN..105400
     8   13X,F10.3,' Mbytes MEMORY USED FOR MAIN ARRAYS'/                SUTRA_MAIN..105500
     9   13X,'- assuming 1 byte/character'/                              SUTRA_MAIN..105600
     1   13X,'- assuming 4-byte logical variables'/                      SUTRA_MAIN..105700
     2   13X,'- pointer storage not included')                           SUTRA_MAIN..105800
C                                                                        SUTRA_MAIN..105900
      WRITE(K3,4000)                                                     SUTRA_MAIN..106000
 4000 FORMAT(////////8(132("-")/))                                       SUTRA_MAIN..106100
C                                                                        SUTRA_MAIN..106200
C.....CALL MAIN CONTROL ROUTINE, SUTRA                                   SUTRA_MAIN..106300
      CALL SUTRA(TITLE1,TITLE2,PMAT,UMAT,PITER,UITER,PM1,DPDTITR,        SUTRA_MAIN..106400
     1   UM1,UM2,PVEL,SL,SR,X,Y,Z,VOL,POR,CS1,CS2,CS3,SW,DSWDP,RHO,SOP,  SUTRA_MAIN..106500
     2   QIN,UIN,QUIN,QINITR,RCIT,RCITM1,PVEC,UVEC,                      SUTRA_MAIN..106600
     3   ALMAX,ALMID,ALMIN,ATMAX,ATMID,ATMIN,VMAG,VANG1,VANG2,           SUTRA_MAIN..106700
     4   PERMXX,PERMXY,PERMXZ,PERMYX,PERMYY,PERMYZ,PERMZX,PERMZY,PERMZZ, SUTRA_MAIN..106800
     5   PANGL1,PANGL2,PANGL3,PBC,UBC,QPLITR,GXSI,GETA,GZET,FWK,B,       SUTRA_MAIN..106900
     6   GNUP1,GNUU1,IN,IQSOP,IQSOU,IPBC,IUBC,OBSPTS,NREG,LREG,IWK,      SUTRA_MAIN..107000
     7   IA,JA,IBCPBC,IBCUBC,IBCSOP,IBCSOU,IIDPBC,IIDUBC,IIDSOP,IIDSOU,  SUTRA_MAIN..107100
     8   IQSOPT,IQSOUT,IPBCT,IUBCT,BCSFL,BCSTR,SM,NDPT,NREF,WMA,SMA
     9   ,POR1,REK,HAREA,VAREA,FAREA,TPT,QLX,QLY,YY,XX,QVYN,TPT1,HANN,
     1   VANN,FANN,HSS,QXF,QYF,SPF,RPF)                       
C     8   IQSOPT,IQSOUT,IPBCT,IUBCT,BCSFL,BCSTR)                          SUTRA_MAIN..107200
C                                                                        SUTRA_MAIN..107300
C.....TERMINATION SEQUENCE: DEALLOCATE ARRAYS, CLOSE FILES, AND END      SUTRA_MAIN..107400
9000  CONTINUE                                                           SUTRA_MAIN..107500
      CALL TERSEQ()                                                      SUTRA_MAIN..107600
      END                                                                SUTRA_MAIN..107700
C                                                                        SUTRA_MAIN..107800
C     SUBROUTINE        A  D  S  O  R  B           SUTRA VERSION 2.2     ADSORB.........100
C                                                                        ADSORB.........200
C *** PURPOSE :                                                          ADSORB.........300
C ***  TO CALCULATE VALUES OF EQUILIBRIUM SORPTION PARAMETERS FOR        ADSORB.........400
C ***  LINEAR, FREUNDLICH, AND LANGMUIR MODELS.                          ADSORB.........500
C                                                                        ADSORB.........600
      SUBROUTINE ADSORB(CS1,CS2,CS3,SL,SR,U)                             ADSORB.........700
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                ADSORB.........800
      CHARACTER*10 ADSMOD                                                ADSORB.........900
      DIMENSION CS1(NN),CS2(NN),CS3(NN),SL(NN),SR(NN),U(NN)              ADSORB........1000
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              ADSORB........1100
     1   NSOP,NSOU,NBCN,NCIDB                                            ADSORB........1200
      COMMON /MODSOR/ ADSMOD                                             ADSORB........1300
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,      ADSORB........1400
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2        ADSORB........1500
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /ET/ QET,UET,PET,UVM,NGT,ITE,TMA,TMI,ALF,RS,RH,AP,BP,U2,
     1   TSD,SCF
C                                                                        ADSORB........1600
C.....NOTE THAT THE CONCENTRATION OF ADSORBATE, CS(I), IS GIVEN BY       ADSORB........1700
C        CS(I) = SL(I)*U(I) + SR(I)                                      ADSORB........1800
C                                                                        ADSORB........1900
C.....NO SORPTION                                                        ADSORB........2000
      IF(ADSMOD.NE.'NONE      ') GOTO 450                                ADSORB........2100
      DO 250 I=1,NN                                                      ADSORB........2200
      CS1(I)=0.D0                                                        ADSORB........2300
      CS2(I)=0.D0                                                        ADSORB........2400
      CS3(I)=0.D0                                                        ADSORB........2500
      SL(I)=0.D0                                                         ADSORB........2600
      SR(I)=0.D0                                                         ADSORB........2700
  250 CONTINUE                                                           ADSORB........2800
      GOTO 2000                                                          ADSORB........2900
C                                                                        ADSORB........3000
C.....LINEAR SORPTION MODEL                                              ADSORB........3100
  450 IF(ADSMOD.NE.'LINEAR    ') GOTO 700                                ADSORB........3200
      DO 500 I=1,NN                                                      ADSORB........3300
      CS1(I)=CHI1*RHOW0                                                  ADSORB........3400
      CS2(I)=0.D0                                                        ADSORB........3500
      CS3(I)=0.D0                                                        ADSORB........3600
      SL(I)=CHI1*RHOW0                                                   ADSORB........3700
      SR(I)=0.D0                                                         ADSORB........3800
  500 CONTINUE                                                           ADSORB........3900
      GOTO 2000                                                          ADSORB........4000
C                                                                        ADSORB........4100
C.....FREUNDLICH SORPTION MODEL                                          ADSORB........4200
  700 IF(ADSMOD.NE.'FREUNDLICH') GOTO 950                                ADSORB........4300
      CHCH=CHI1/CHI2                                                     ADSORB........4400
      DCHI2=1.D0/CHI2                                                    ADSORB........4500
      RH2=RHOW0**DCHI2                                                   ADSORB........4600
      CHI2F=((1.D0-CHI2)/CHI2)                                           ADSORB........4700
      DO 750 I=1,NN                                                      ADSORB........4800
      IF(U(I)) 720,720,730                                               ADSORB........4900
  720 UCH=1.0D0                                                          ADSORB........5000
      GOTO 740                                                           ADSORB........5100
  730 UCH=U(I)**CHI2F                                                    ADSORB........5200
  740 RU=RH2*UCH                                                         ADSORB........5300
      CS1(I)=CHCH*RU                                                     ADSORB........5400
      CS2(I)=0.D0                                                        ADSORB........5500
      CS3(I)=0.D0                                                        ADSORB........5600
      SL(I)=CHI1*RU                                                      ADSORB........5700
      SR(I)=0.D0                                                         ADSORB........5800
  750 CONTINUE                                                           ADSORB........5900
      GOTO 2000                                                          ADSORB........6000
C                                                                        ADSORB........6100
C.....LANGMUIR SORPTION MODEL                                            ADSORB........6200
C  950 IF(ADSMOD.NE.'LANGMUIR  ') GOTO 2000                               ADSORB........6300
950   IF(ADSMOD.NE.'LANGMUIR  ') GOTO 1
      DO 1000 I=1,NN                                                     ADSORB........6400
      DD=1.D0+CHI2*RHOW0*U(I)                                            ADSORB........6500
      CS1(I)=(CHI1*RHOW0)/(DD*DD)                                        ADSORB........6600
      CS2(I)=0.D0                                                        ADSORB........6700
      CS3(I)=0.D0                                                        ADSORB........6800
      SL(I)=CS1(I)                                                       ADSORB........6900
      SR(I)=CS1(I)*CHI2*RHOW0*U(I)*U(I)                                  ADSORB........7000
 1000 CONTINUE                                                           ADSORB........7100
      GOTO 2000

C.....SOLID MODEL
    1 IF(ADSMOD.NE.'SOLID') GOTO 2000
      DO 2 I=1,NN
      IF (U(I).LT.UVM)THEN
      CS1(I)=0.D0
      ELSE
      CS1(I)=CHI1*RHOW0
      ENDIF
      CS2(I)=0.D0
      CS3(I)=0.D0
      SL(I)=0.D0
2     SR(I)=0.D0
C                                                                        ADSORB........7200
 2000 RETURN                                                             ADSORB........7300
      END                                                                ADSORB........7400
C                                                                        ADSORB........7500
C     SUBROUTINE        B  A  N  W  I  D           SUTRA VERSION 2.2     BANWID.........100
C                                                                        BANWID.........200
C *** PURPOSE :                                                          BANWID.........300
C ***  TO CALCULATE THE BANDWIDTH OF THE FINITE ELEMENT MESH.            BANWID.........400
C                                                                        BANWID.........500
      SUBROUTINE BANWID(IN)                                              BANWID.........600
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                BANWID.........700
      CHARACTER*80 UNAME,FNAME(0:13)                                     BANWID.........800
      DIMENSION IN(NIN)                                                  BANWID.........900
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              BANWID........1000
     1   NSOP,NSOU,NBCN,NCIDB                                            BANWID........1100
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        BANWID........1200
      COMMON /FNAMES/ UNAME,FNAME                                        BANWID........1300
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 BANWID........1400
     1   K10,K11,K12,K13                                                 BANWID........1500
      COMMON /SOLVI/ KSOLVP, KSOLVU, NN1, NN2, NN3                       BANWID........1600
C                                                                        BANWID........1700
      NDIF=0                                                             BANWID........1800
      II=0                                                               BANWID........1900
      WRITE(K3,100)                                                      BANWID........2000
  100 FORMAT(////11X,'**** MESH ANALYSIS ****'//)                        BANWID........2100
C                                                                        BANWID........2200
C.....FIND ELEMENT WITH MAXIMUM DIFFERENCE IN NODE NUMBERS               BANWID........2300
      DO 2000 L=1,NE                                                     BANWID........2400
      II=II+1                                                            BANWID........2500
      IELO=IN(II)                                                        BANWID........2600
      IEHI=IN(II)                                                        BANWID........2700
      DO 1000 I=2,N48                                                    BANWID........2800
      II=II+1                                                            BANWID........2900
      IF(IN(II).LT.IELO) IELO=IN(II)                                     BANWID........3000
 1000 IF(IN(II).GT.IEHI) IEHI=IN(II)                                     BANWID........3100
      NDIFF=IEHI-IELO                                                    BANWID........3200
      IF(NDIFF.GT.NDIF) THEN                                             BANWID........3300
       NDIF=NDIFF                                                        BANWID........3400
       LEM=L                                                             BANWID........3500
      ENDIF                                                              BANWID........3600
 2000 CONTINUE                                                           BANWID........3700
C                                                                        BANWID........3800
C.....CALCULATE FULL BANDWIDTH, NB.                                      BANWID........3900
      NB=2*NDIF+1                                                        BANWID........4000
      NBHALF=NDIF+1                                                      BANWID........4100
C.....NBI IS USED TO DIMENSION ARRAYS WHOSE SIZE DEPENDS ON THE          BANWID........4200
C        BANDWIDTH.  IT IS THE SAME AS THE ACTUAL BANDWIDTH, NB.         BANWID........4300
      NBI = NB                                                           BANWID........4400
      WRITE(K3,2500) NB,LEM                                              BANWID........4500
 2500 FORMAT(//13X,'MAXIMUM FULL BANDWIDTH, ',I9,                        BANWID........4600
     1   ', WAS CALCULATED IN ELEMENT ',I9)                              BANWID........4700
C                                                                        BANWID........4800
      RETURN                                                             BANWID........4900
      END                                                                BANWID........5000
C                                                                        BANWID........5100
C     SUBROUTINE        B  A  S  I  S  2           SUTRA VERSION 2.2     BASIS2.........100
C                                                                        BASIS2.........200
C *** PURPOSE :                                                          BASIS2.........300
C ***  TO CALCULATE VALUES OF BASIS AND WEIGHTING FUNCTIONS AND THEIR    BASIS2.........400
C ***  DERIVATIVES, TRANSFORMATION MATRICES BETWEEN LOCAL AND GLOBAL     BASIS2.........500
C ***  COORDINATES AND PARAMETER VALUES AT A SPECIFIED POINT IN A        BASIS2.........600
C ***  QUADRILATERAL FINITE ELEMENT.  THIS SUBROUTINE HANDLES 2D         BASIS2.........700
C ***  CALCULATIONS ONLY; 3D CALCULATIONS ARE PERFORMED IN SUBROUTINE    BASIS2.........800
C ***  BASIS3.                                                           BASIS2.........900
C                                                                        BASIS2........1000
      SUBROUTINE BASIS2(ICALL,L,XLOC,YLOC,IN,X,Y,F,W,DET,                BASIS2........1100
     1   DFDXG,DFDYG,DWDXG,DWDYG,PITER,UITER,PVEL,POR,THICK,THICKG,      BASIS2........1200
     2   VXG,VYG,SWG,RHOG,VISCG,PORG,VGMAG,RELKG,                        BASIS2........1300
     3   PERMXX,PERMXY,PERMYX,PERMYY,CJ11,CJ12,CJ21,CJ22,                BASIS2........1400
     4   GXSI,GETA,RCIT,RCITM1,RGXG,RGYG,LREG,POR1,QXG,QYG,TPT,QXFG,
     5   QYFG,SPFG,RPFG) 
C     4   GXSI,GETA,RCIT,RCITM1,RGXG,RGYG,LREG)                           BASIS2........1500
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                BASIS2........1600
      DOUBLE PRECISION XLOC,YLOC                                         BASIS2........1700
      DIMENSION IN(NIN),X(NN),Y(NN),UITER(NN),PITER(NN),PVEL(NN),        BASIS2........1800
     1   POR(NN),PERMXX(NE),PERMXY(NE),PERMYX(NE),PERMYY(NE),THICK(NN)   BASIS2........1900
      DIMENSION GXSI(NE,4),GETA(NE,4),RCIT(NN),RCITM1(NN),LREG(NE)       BASIS2........2000
      DIMENSION F(4),W(4),DFDXG(4),DFDYG(4),DWDXG(4),DWDYG(4)            BASIS2........2100
      DIMENSION FX(4),FY(4),AFX(4),AFY(4),                               BASIS2........2200
     1   DFDXL(4),DFDYL(4),DWDXL(4),DWDYL(4),                            BASIS2........2300
     2   XDW(4),YDW(4),XIIX(4),YIIY(4)                                   BASIS2........2400
      DIMENSION POR1(NN),TPT(NN)
      DIMENSION KTYPE(2)                                                 BASIS2........2500
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  BASIS2........2600
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           BASIS2........2700
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      BASIS2........2800
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              BASIS2........2900
     1   NSOP,NSOU,NBCN,NCIDB                                            BASIS2........3000
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,      BASIS2........3100
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2        BASIS2........3200
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /FILMFLOW/ CORF,AGR,SWM3,SWM4,PHICM,ASVL
      DATA XIIX/-1.D0,+1.D0,+1.D0,-1.D0/,                                BASIS2........3300
     1     YIIY/-1.D0,-1.D0,+1.D0,+1.D0/                                 BASIS2........3400
      SAVE XIIX,YIIY                                                     BASIS2........3500
C                                                                        BASIS2........3600
C                                                                        BASIS2........3700
C.....AT THIS LOCATION IN LOCAL COORDINATES, (XLOC,YLOC),                BASIS2........3800
C        CALCULATE SYMMETRIC WEIGHTING FUNCTIONS, F(I),                  BASIS2........3900
C        SPACE DERIVATIVES, DFDXG(I) AND DFDYG(I), AND                   BASIS2........4000
C        DETERMINANT OF JACOBIAN, DET.                                   BASIS2........4100
C                                                                        BASIS2........4200
      XF1=1.D0-XLOC                                                      BASIS2........4300
      XF2=1.D0+XLOC                                                      BASIS2........4400
      YF1=1.D0-YLOC                                                      BASIS2........4500
      YF2=1.D0+YLOC                                                      BASIS2........4600
C                                                                        BASIS2........4700
C.....CALCULATE BASIS FUNCTION, F.                                       BASIS2........4800
      FX(1)=XF1                                                          BASIS2........4900
      FX(2)=XF2                                                          BASIS2........5000
      FX(3)=XF2                                                          BASIS2........5100
      FX(4)=XF1                                                          BASIS2........5200
      FY(1)=YF1                                                          BASIS2........5300
      FY(2)=YF1                                                          BASIS2........5400
      FY(3)=YF2                                                          BASIS2........5500
      FY(4)=YF2                                                          BASIS2........5600
      DO 10 I=1,4                                                        BASIS2........5700
   10 F(I)=0.250D0*FX(I)*FY(I)                                           BASIS2........5800
C                                                                        BASIS2........5900
C.....CALCULATE DERIVATIVES WITH RESPECT TO LOCAL COORDINATES.           BASIS2........6000
      DO 20 I=1,4                                                        BASIS2........6100
      DFDXL(I)=XIIX(I)*0.250D0*FY(I)                                     BASIS2........6200
   20 DFDYL(I)=YIIY(I)*0.250D0*FX(I)                                     BASIS2........6300
C                                                                        BASIS2........6400
C.....CALCULATE ELEMENTS OF JACOBIAN MATRIX, CJ.                         BASIS2........6500
      CJ11=0.D0                                                          BASIS2........6600
      CJ12=0.D0                                                          BASIS2........6700
      CJ21=0.D0                                                          BASIS2........6800
      CJ22=0.D0                                                          BASIS2........6900
      DO 100 IL=1,4                                                      BASIS2........7000
      II=(L-1)*4+IL                                                      BASIS2........7100
      I=IN(II)                                                           BASIS2........7200
      CJ11=CJ11+DFDXL(IL)*X(I)                                           BASIS2........7300
      CJ12=CJ12+DFDXL(IL)*Y(I)                                           BASIS2........7400
      CJ21=CJ21+DFDYL(IL)*X(I)                                           BASIS2........7500
  100 CJ22=CJ22+DFDYL(IL)*Y(I)                                           BASIS2........7600
C                                                                        BASIS2........7700
C.....CALCULATE DETERMINANT OF JACOBIAN MATRIX.                          BASIS2........7800
      DET=CJ11*CJ22-CJ21*CJ12                                            BASIS2........7900
C                                                                        BASIS2........8000
C.....RETURN TO ELEMEN2 WITH JACOBIAN MATRIX ON FIRST TIME STEP.         BASIS2........8100
      IF(ICALL.EQ.0) RETURN                                              BASIS2........8200
C                                                                        BASIS2........8300
C.....CALCULATE ELEMENTS OF INVERSE JACOBIAN MATRIX, CIJ.                BASIS2........8400
      ODET=1.D0/DET                                                      BASIS2........8500
      CIJ11=+ODET*CJ22                                                   BASIS2........8600
      CIJ12=-ODET*CJ12                                                   BASIS2........8700
      CIJ21=-ODET*CJ21                                                   BASIS2........8800
      CIJ22=+ODET*CJ11                                                   BASIS2........8900
C                                                                        BASIS2........9000
C.....CALCULATE DERIVATIVES WITH RESPECT TO GLOBAL COORDINATES           BASIS2........9100
      DO 200 I=1,4                                                       BASIS2........9200
      DFDXG(I)=CIJ11*DFDXL(I)+CIJ12*DFDYL(I)                             BASIS2........9300
  200 DFDYG(I)=CIJ21*DFDXL(I)+CIJ22*DFDYL(I)                             BASIS2........9400
C                                                                        BASIS2........9500
C.....CALCULATE CONSISTENT COMPONENTS OF (RHO*GRAV) TERM IN LOCAL        BASIS2........9600
C        COORDINATES AT THIS LOCATION, (XLOC,YLOC)                       BASIS2........9700
      RGXL=0.D0                                                          BASIS2........9800
      RGYL=0.D0                                                          BASIS2........9900
      RGXLM1=0.D0                                                        BASIS2.......10000
      RGYLM1=0.D0                                                        BASIS2.......10100
      DO 800 IL=1,4                                                      BASIS2.......10200
      II=(L-1)*4+IL                                                      BASIS2.......10300
      I=IN(II)                                                           BASIS2.......10400
      ADFDXL=DABS(DFDXL(IL))                                             BASIS2.......10500
      ADFDYL=DABS(DFDYL(IL))                                             BASIS2.......10600
      RGXL=RGXL+RCIT(I)*GXSI(L,IL)*ADFDXL                                BASIS2.......10700
      RGYL=RGYL+RCIT(I)*GETA(L,IL)*ADFDYL                                BASIS2.......10800
      RGXLM1=RGXLM1+RCITM1(I)*GXSI(L,IL)*ADFDXL                          BASIS2.......10900
      RGYLM1=RGYLM1+RCITM1(I)*GETA(L,IL)*ADFDYL                          BASIS2.......11000
  800 CONTINUE                                                           BASIS2.......11100
C                                                                        BASIS2.......11200
C.....TRANSFORM CONSISTENT COMPONENTS OF (RHO*GRAV) TERM TO              BASIS2.......11300
C        GLOBAL COORDINATES                                              BASIS2.......11400
      RGXG=CIJ11*RGXL+CIJ12*RGYL                                         BASIS2.......11500
      RGYG=CIJ21*RGXL+CIJ22*RGYL                                         BASIS2.......11600
      RGXGM1=CIJ11*RGXLM1+CIJ12*RGYLM1                                   BASIS2.......11700
      RGYGM1=CIJ21*RGXLM1+CIJ22*RGYLM1                                   BASIS2.......11800
C                                                                        BASIS2.......11900
C.....CALCULATE PARAMETER VALUES AT THIS LOCATION, (XLOC,YLOC)           BASIS2.......12000
      PITERG=0.D0                                                        BASIS2.......12100
      UITERG=0.D0                                                        BASIS2.......12200
      DPDXG=0.D0                                                         BASIS2.......12300
      DPDYG=0.D0                                                         BASIS2.......12400
      PORG=0.D0                                                          BASIS2.......12500
      THICKG=0.0D0                                                       BASIS2.......12600
      TMPG=0.0D0
      DO 1000 IL=1,4                                                     BASIS2.......12700
      II=(L-1)*4 +IL                                                     BASIS2.......12800
      I=IN(II)                                                           BASIS2.......12900
      DPDXG=DPDXG+PVEL(I)*DFDXG(IL)                                      BASIS2.......13000
      DPDYG=DPDYG+PVEL(I)*DFDYG(IL)                                      BASIS2.......13100
      PORG=PORG+POR(I)*F(IL)                                             BASIS2.......13200
      THICKG=THICKG+THICK(I)*F(IL)                                       BASIS2.......13300
      PITERG=PITERG+PITER(I)*F(IL)                                       BASIS2.......13400
      UITERG=UITERG+UITER(I)*F(IL)                                       BASIS2.......13500
      TMPG=TMPG+TPT(I)*F(IL)
 1000 CONTINUE                                                           BASIS2.......13600
C                                                                        BASIS2.......13700
C.....SET VALUES FOR DENSITY AND VISCOSITY.                              BASIS2.......13800
C.....RHOG = FUNCTION(UITER)                                             BASIS2.......13900
      RHOG=RHOW0+DRWDU*(UITERG-URHOW0)                                   BASIS2.......14000
C.....VISCG = FUNCTION(UITER); VISCOSITY IN UNITS OF VISC0*(KG/(M*SEC))  BASIS2.......14100
      IF(ME) 1300,1300,1200                                              BASIS2.......14200
 1200 VISCG=VISC0*239.4D-7*(10.D0**(248.37D0/(UITERG+133.15D0)))         BASIS2.......14300
      GOTO 1400                                                          BASIS2.......14400
C.....FOR SOLUTE TRANSPORT, VISCG IS TAKEN TO BE CONSTANT                BASIS2.......14500
C 1300 VISCG=VISC0                                                        BASIS2.......14600
1300      VISCG=VISC0*239.4D-7*(10.D0**(248.37D0/(TMPG-140.D0)))
     1 +DVIDU*UITERG
 1400 CONTINUE                                                           BASIS2.......14700
C                                                                        BASIS2.......14800
C.....SET UNSATURATED FLOW PARAMETERS SWG AND RELKG                      BASIS2.......14900
      IF(IUNSAT-2) 1600,1500,1600                                        BASIS2.......15000
 1500 IF(PITERG) 1550,1600,1600                                          BASIS2.......15100
 1550 CALL UNSAT(SWG,DSWDPG,RELKG,PITERG,LREG(L))                        BASIS2.......15200
      GOTO 1700                                                          BASIS2.......15300
 1600 SWG=1.0D0                                                          BASIS2.......15400
      RELKG=1.0D0                                                        BASIS2.......15500
 1700 CONTINUE                                                           BASIS2.......15600
C     CALCULATE SATURATED PREABILITY DUE TO FILM FLOW AT THE GAUSS POINT (SPFG)
C     AND RELATIVE PERMEABILITY DUE TO FILM FLOW AT THE GAUSS POINT (RPFG)
C     SEE PAGE 165 FOR REFERENCE
C     MFT...(F)ILM (T)RANSPORT SWICH SEE PAGE 165 SEE PAGE 166 FOR REFERENCE
C      MFT=0, FILM TRANSPORT DISABLED
C      MFT=1, FILM TRANSPORT IS ENABLED BASED ON TOKUNAKA (2009) AND ZHANG(2010) 
C      MFT=2, FILM TRANSPORT IS CALCULATED BY MUALEM (1976) BASED ON TOTAL SATURATION.
C             THIS IS DONE NOT BY PERFILM, BUT BY UNSAT. ONLY APPLY WHEN BROOKS AND COREY
C             WATER RETENTION CURVE IS APPLIED SEE PAGE 170
C      MFT=3, FILM TRANSPORT IS ENABLED BASED ON LEBEAU AND KONRAD (2010) SEE PAGE 178
C             AND 179
      IF(MFT.EQ.1.OR.MFT.EQ.3) CALL PERFILM(SPFG,RPFG,PORG,TMPG,PITERG,
     1  SWG,LREG(L),MFT)
C                                                                        BASIS2.......15700
C.....CALCULATE CONSISTENT FLUID VELOCITIES WITH RESPECT TO GLOBAL       BASIS2.......15800
C        COORDINATES, VXG, VYG, AND VGMAG, AT THIS LOCATION, (XLOC,YLOC) BASIS2.......15900
      DENOM=1.D0/(PORG*SWG*VISCG)                                        BASIS2.......16000
      PGX=DPDXG-RGXGM1                                                   BASIS2.......16100
      PGY=DPDYG-RGYGM1                                                   BASIS2.......16200
C.....ZERO OUT RANDOM BOUYANT DRIVING FORCES DUE TO DIFFERENCING         BASIS2.......16300
C        NUMBERS PAST PRECISION LIMIT.  MINIMUM DRIVING FORCE IS         BASIS2.......16400
C        1.D-10 OF PRESSURE GRADIENT.  (THIS VALUE MAY BE CHANGED        BASIS2.......16500
C        DEPENDING ON MACHINE PRECISION.)                                BASIS2.......16600
      IF(DPDXG) 1720,1730,1720                                           BASIS2.......16700
 1720 IF(DABS(PGX/DPDXG)-1.0D-10) 1725,1725,1730                         BASIS2.......16800
 1725 PGX=0.0D0                                                          BASIS2.......16900
 1730 IF(DPDYG) 1750,1760,1750                                           BASIS2.......17000
 1750 IF(DABS(PGY/DPDYG)-1.0D-10) 1755,1755,1760                         BASIS2.......17100
 1755 PGY=0.0D0                                                          BASIS2.......17200
C ....PORE WATER VELOCITY DUE TO CAPILLARY FLOW AT THE CAUSS POINT
 1760 VXG=-DENOM*(PERMXX(L)*PGX+PERMXY(L)*PGY)*RELKG                     BASIS2.......17300
      VYG=-DENOM*(PERMYX(L)*PGX+PERMYY(L)*PGY)*RELKG                     BASIS2.......17400
      QXG=VXG*PORG*SWG
      QYG=VYG*PORG*SWG
      IF (MFT.EQ.1.OR.MFT.EQ.3)THEN
C      (V)ELOCITY ON THE (X) DIRECTION DUE TO (F)ILM FLOW AT THE (G)AUSS POINT (VXFG) [M/S]
        VXFG=-DENOM*SPFG*PGX*RPFG
        VYFG=-DENOM*SPFG*PGY*RPFG
        VXG=VXG+VXFG
        VYG=VYG+VYFG
        QXFG=VXFG*PORG*SWG
        QYFG=VYFG*PORG*SWG
      ELSE
        QXFG=0.D0
        QYFG=0.D0
      ENDIF
      VXG2=VXG*VXG                                                       BASIS2.......17500
      VYG2=VYG*VYG                                                       BASIS2.......17600
      VGMAG=DSQRT(VXG2+VYG2)                                             BASIS2.......17700
C                                                                        BASIS2.......17800
C.....AT THIS POINT IN LOCAL COORDINATES, (XLOC,YLOC),                   BASIS2.......17900
C        CALCULATE ASYMMETRIC WEIGHTING FUNCTIONS, W(I),                 BASIS2.......18000
C        AND SPACE DERIVATIVES, DWDXG(I) AND DWDYG(I).                   BASIS2.......18100
C                                                                        BASIS2.......18200
C.....ASYMMETRIC FUNCTIONS SIMPLIFY WHEN  UP=0.0                         BASIS2.......18300
      IF(UP.GT.1.0D-6.AND.NOUMAT.EQ.0) GOTO 1790                         BASIS2.......18400
      DO 1780 I=1,4                                                      BASIS2.......18500
      W(I)=F(I)                                                          BASIS2.......18600
      DWDXG(I)=DFDXG(I)                                                  BASIS2.......18700
      DWDYG(I)=DFDYG(I)                                                  BASIS2.......18800
 1780 CONTINUE                                                           BASIS2.......18900
C.....RETURN WHEN ONLY SYMMETRIC WEIGHTING FUNCTIONS ARE USED            BASIS2.......19000
      RETURN                                                             BASIS2.......19100
C                                                                        BASIS2.......19200
C.....CALCULATE FLUID VELOCITIES WITH RESPECT TO LOCAL COORDINATES,      BASIS2.......19300
C        VXL, VYL, AND VLMAG, AT THIS LOCATION, (XLOC,YLOC).             BASIS2.......19400
 1790 VXL=CIJ11*VXG+CIJ21*VYG                                            BASIS2.......19500
      VYL=CIJ12*VXG+CIJ22*VYG                                            BASIS2.......19600
      VLMAG=DSQRT(VXL*VXL+VYL*VYL)                                       BASIS2.......19700
C                                                                        BASIS2.......19800
      AA=0.0D0                                                           BASIS2.......19900
      BB=0.0D0                                                           BASIS2.......20000
      IF(VLMAG) 1900,1900,1800                                           BASIS2.......20100
 1800 AA=UP*VXL/VLMAG                                                    BASIS2.......20200
      BB=UP*VYL/VLMAG                                                    BASIS2.......20300
C                                                                        BASIS2.......20400
 1900 XIXI=.750D0*AA*XF1*XF2                                             BASIS2.......20500
      YIYI=.750D0*BB*YF1*YF2                                             BASIS2.......20600
      DO 2000 I=1,4                                                      BASIS2.......20700
      AFX(I)=.50D0*FX(I)+XIIX(I)*XIXI                                    BASIS2.......20800
 2000 AFY(I)=.50D0*FY(I)+YIIY(I)*YIYI                                    BASIS2.......20900
C                                                                        BASIS2.......21000
C.....CALCULATE ASYMMETRIC WEIGHTING FUNCTION, W.                        BASIS2.......21100
      DO 3000 I=1,4                                                      BASIS2.......21200
 3000 W(I)=AFX(I)*AFY(I)                                                 BASIS2.......21300
C                                                                        BASIS2.......21400
      THAAX=0.50D0-1.50D0*AA*XLOC                                        BASIS2.......21500
      THBBY=0.50D0-1.50D0*BB*YLOC                                        BASIS2.......21600
      DO 4000 I=1,4                                                      BASIS2.......21700
      XDW(I)=XIIX(I)*THAAX                                               BASIS2.......21800
 4000 YDW(I)=YIIY(I)*THBBY                                               BASIS2.......21900
C                                                                        BASIS2.......22000
C.....CALCULATE DERIVATIVES WITH RESPECT TO LOCAL COORDINATES.           BASIS2.......22100
      DO 5000 I=1,4                                                      BASIS2.......22200
      DWDXL(I)=XDW(I)*AFY(I)                                             BASIS2.......22300
 5000 DWDYL(I)=YDW(I)*AFX(I)                                             BASIS2.......22400
C                                                                        BASIS2.......22500
C.....CALCULATE DERIVATIVES WITH RESPECT TO GLOBAL COORDINATES.          BASIS2.......22600
      DO 6000 I=1,4                                                      BASIS2.......22700
      DWDXG(I)=CIJ11*DWDXL(I)+CIJ12*DWDYL(I)                             BASIS2.......22800
 6000 DWDYG(I)=CIJ21*DWDXL(I)+CIJ22*DWDYL(I)                             BASIS2.......22900
C                                                                        BASIS2.......23000
C                                                                        BASIS2.......23100
      RETURN                                                             BASIS2.......23200
      END                                                                BASIS2.......23300
C                                                                        BASIS2.......23400
C     SUBROUTINE        B  A  S  I  S  3           SUTRA VERSION 2.2     BASIS3.........100
C                                                                        BASIS3.........200
C *** PURPOSE :                                                          BASIS3.........300
C ***  TO CALCULATE VALUES OF BASIS AND WEIGHTING FUNCTIONS AND THEIR    BASIS3.........400
C ***  DERIVATIVES, TRANSFORMATION MATRICES BETWEEN LOCAL AND GLOBAL     BASIS3.........500
C ***  COORDINATES AND PARAMETER VALUES AT A SPECIFIED POINT IN A        BASIS3.........600
C ***  QUADRILATERAL FINITE ELEMENT.  THIS SUBROUTINE HANDLES 3D         BASIS3.........700
C ***  CALCULATIONS ONLY; 2D CALCULATIONS ARE PERFORMED IN SUBROUTINE    BASIS3.........800
C ***  BASIS2.                                                           BASIS3.........900
C                                                                        BASIS3........1000
      SUBROUTINE BASIS3(ICALL,L,XLOC,YLOC,ZLOC,IN,X,Y,Z,F,W,DET,         BASIS3........1100
     1   DFDXG,DFDYG,DFDZG,DWDXG,DWDYG,DWDZG,PITER,UITER,PVEL,POR,       BASIS3........1200
     2   VXG,VYG,VZG,SWG,RHOG,VISCG,PORG,VGMAG,RELKG,                    BASIS3........1300
     3   PERMXX,PERMXY,PERMXZ,PERMYX,PERMYY,PERMYZ,PERMZX,PERMZY,PERMZZ, BASIS3........1400
     4   CJ11,CJ12,CJ13,CJ21,CJ22,CJ23,CJ31,CJ32,CJ33,                   BASIS3........1500
     4   GXSI,GETA,GZET,RCIT,RCITM1,RGXG,RGYG,RGZG,LREG,POR1)
C     4   GXSI,GETA,GZET,RCIT,RCITM1,RGXG,RGYG,RGZG,LREG)                 BASIS3........1600
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                BASIS3........1700
      DOUBLE PRECISION XLOC,YLOC,ZLOC                                    BASIS3........1800
      DIMENSION IN(NIN),X(NN),Y(NN),Z(NN),UITER(NN),PITER(NN),PVEL(NN),  BASIS3........1900
     1   POR(NN),PERMXX(NE),PERMXY(NE),PERMXZ(NE),PERMYX(NE),            BASIS3........2000
     2   PERMYY(NE),PERMYZ(NE),PERMZX(NE),PERMZY(NE),PERMZZ(NE)          BASIS3........2100
      DIMENSION POR1(NN)
      DIMENSION GXSI(NE,8),GETA(NE,8),GZET(NE,8)                         BASIS3........2200
      DIMENSION RCIT(NN),RCITM1(NN),LREG(NE)                             BASIS3........2300
      DIMENSION F(8),DFDXG(8),DFDYG(8),DFDZG(8)                          BASIS3........2400
      DIMENSION W(8),DWDXG(8),DWDYG(8),DWDZG(8)                          BASIS3........2500
      DIMENSION FX(8),FY(8),FZ(8),AFX(8),AFY(8),AFZ(8),                  BASIS3........2600
     1   DFDXL(8),DFDYL(8),DFDZL(8),DWDXL(8),DWDYL(8),DWDZL(8),          BASIS3........2700
     2   XDW(8),YDW(8),ZDW(8),XIIX(8),YIIY(8),ZIIZ(8)                    BASIS3........2800
      DIMENSION KTYPE(2)                                                 BASIS3........2900
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  BASIS3........3000
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           BASIS3........3100
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      BASIS3........3200
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              BASIS3........3300
     1   NSOP,NSOU,NBCN,NCIDB                                            BASIS3........3400
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,      BASIS3........3500
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2        BASIS3........3600
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      DATA XIIX/-1.D0,+1.D0,+1.D0,-1.D0,-1.D0,+1.D0,+1.D0,-1.D0/         BASIS3........3700
      DATA YIIY/-1.D0,-1.D0,+1.D0,+1.D0,-1.D0,-1.D0,+1.D0,+1.D0/         BASIS3........3800
      DATA ZIIZ/-1.D0,-1.D0,-1.D0,-1.D0,+1.D0,+1.D0,+1.D0,+1.D0/         BASIS3........3900
      SAVE XIIX,YIIY,ZIIZ                                                BASIS3........4000
C                                                                        BASIS3........4100
C                                                                        BASIS3........4200
C.....AT THIS LOCATION IN LOCAL COORDINATES, (XLOC,YLOC,ZLOC),           BASIS3........4300
C        CALCULATE SYMMETRIC WEIGHTING FUNCTIONS, F(I),                  BASIS3........4400
C        SPACE DERIVATIVES, DFDXG(I), DFDYX(I), AND DFDZG(I),            BASIS3........4500
C        AND DETERMINANT OF JACOBIAN, DET.                               BASIS3........4600
C                                                                        BASIS3........4700
      XF1=1.D0-XLOC                                                      BASIS3........4800
      XF2=1.D0+XLOC                                                      BASIS3........4900
      YF1=1.D0-YLOC                                                      BASIS3........5000
      YF2=1.D0+YLOC                                                      BASIS3........5100
      ZF1=1.D0-ZLOC                                                      BASIS3........5200
      ZF2=1.D0+ZLOC                                                      BASIS3........5300
C                                                                        BASIS3........5400
C.....CALCULATE BASIS FUNCTION, F.                                       BASIS3........5500
      FX(1)=XF1                                                          BASIS3........5600
      FX(2)=XF2                                                          BASIS3........5700
      FX(3)=XF2                                                          BASIS3........5800
      FX(4)=XF1                                                          BASIS3........5900
      FX(5)=XF1                                                          BASIS3........6000
      FX(6)=XF2                                                          BASIS3........6100
      FX(7)=XF2                                                          BASIS3........6200
      FX(8)=XF1                                                          BASIS3........6300
      FY(1)=YF1                                                          BASIS3........6400
      FY(2)=YF1                                                          BASIS3........6500
      FY(3)=YF2                                                          BASIS3........6600
      FY(4)=YF2                                                          BASIS3........6700
      FY(5)=YF1                                                          BASIS3........6800
      FY(6)=YF1                                                          BASIS3........6900
      FY(7)=YF2                                                          BASIS3........7000
      FY(8)=YF2                                                          BASIS3........7100
      FZ(1)=ZF1                                                          BASIS3........7200
      FZ(2)=ZF1                                                          BASIS3........7300
      FZ(3)=ZF1                                                          BASIS3........7400
      FZ(4)=ZF1                                                          BASIS3........7500
      FZ(5)=ZF2                                                          BASIS3........7600
      FZ(6)=ZF2                                                          BASIS3........7700
      FZ(7)=ZF2                                                          BASIS3........7800
      FZ(8)=ZF2                                                          BASIS3........7900
      DO 10 I=1,8                                                        BASIS3........8000
   10 F(I)=0.125D0*FX(I)*FY(I)*FZ(I)                                     BASIS3........8100
C                                                                        BASIS3........8200
C.....CALCULATE DERIVATIVES WITH RESPECT TO LOCAL COORDINATES.           BASIS3........8300
      DO 20 I=1,8                                                        BASIS3........8400
      DFDXL(I)=XIIX(I)*0.125D0*FY(I)*FZ(I)                               BASIS3........8500
      DFDYL(I)=YIIY(I)*0.125D0*FX(I)*FZ(I)                               BASIS3........8600
   20 DFDZL(I)=ZIIZ(I)*0.125D0*FX(I)*FY(I)                               BASIS3........8700
C                                                                        BASIS3........8800
C.....CALCULATE ELEMENTS OF JACOBIAN MATRIX, CJ.                         BASIS3........8900
      CJ11=0.D0                                                          BASIS3........9000
      CJ12=0.D0                                                          BASIS3........9100
      CJ13=0.D0                                                          BASIS3........9200
      CJ21=0.D0                                                          BASIS3........9300
      CJ22=0.D0                                                          BASIS3........9400
      CJ23=0.D0                                                          BASIS3........9500
      CJ31=0.D0                                                          BASIS3........9600
      CJ32=0.D0                                                          BASIS3........9700
      CJ33=0.D0                                                          BASIS3........9800
      DO 100 IL=1,8                                                      BASIS3........9900
      II=(L-1)*8+IL                                                      BASIS3.......10000
      I=IN(II)                                                           BASIS3.......10100
      CJ11=CJ11+DFDXL(IL)*X(I)                                           BASIS3.......10200
      CJ12=CJ12+DFDXL(IL)*Y(I)                                           BASIS3.......10300
      CJ13=CJ13+DFDXL(IL)*Z(I)                                           BASIS3.......10400
      CJ21=CJ21+DFDYL(IL)*X(I)                                           BASIS3.......10500
      CJ22=CJ22+DFDYL(IL)*Y(I)                                           BASIS3.......10600
      CJ23=CJ23+DFDYL(IL)*Z(I)                                           BASIS3.......10700
      CJ31=CJ31+DFDZL(IL)*X(I)                                           BASIS3.......10800
      CJ32=CJ32+DFDZL(IL)*Y(I)                                           BASIS3.......10900
  100 CJ33=CJ33+DFDZL(IL)*Z(I)                                           BASIS3.......11000
C                                                                        BASIS3.......11100
C.....CALCULATE DETERMINANT OF JACOBIAN MATRIX.                          BASIS3.......11200
      DET=CJ11*(CJ22*CJ33-CJ32*CJ23)                                     BASIS3.......11300
     1   -CJ21*(CJ12*CJ33-CJ32*CJ13)                                     BASIS3.......11400
     2   +CJ31*(CJ12*CJ23-CJ22*CJ13)                                     BASIS3.......11500
C                                                                        BASIS3.......11600
C.....RETURN TO ELEMEN3 WITH JACOBIAN MATRIX ON FIRST TIME STEP.         BASIS3.......11700
      IF(ICALL.EQ.0) RETURN                                              BASIS3.......11800
C                                                                        BASIS3.......11900
C                                                                        BASIS3.......12000
C.....CALCULATE ELEMENTS OF INVERSE JACOBIAN MATRIX, CIJ.                BASIS3.......12100
      ODET=1.D0/DET                                                      BASIS3.......12200
      CIJ11=+ODET*(CJ22*CJ33-CJ32*CJ23)                                  BASIS3.......12300
      CIJ12=-ODET*(CJ12*CJ33-CJ32*CJ13)                                  BASIS3.......12400
      CIJ13=+ODET*(CJ12*CJ23-CJ22*CJ13)                                  BASIS3.......12500
      CIJ21=-ODET*(CJ21*CJ33-CJ31*CJ23)                                  BASIS3.......12600
      CIJ22=+ODET*(CJ11*CJ33-CJ31*CJ13)                                  BASIS3.......12700
      CIJ23=-ODET*(CJ11*CJ23-CJ21*CJ13)                                  BASIS3.......12800
      CIJ31=+ODET*(CJ21*CJ32-CJ31*CJ22)                                  BASIS3.......12900
      CIJ32=-ODET*(CJ11*CJ32-CJ31*CJ12)                                  BASIS3.......13000
      CIJ33=+ODET*(CJ11*CJ22-CJ21*CJ12)                                  BASIS3.......13100
C                                                                        BASIS3.......13200
C.....CALCULATE DERIVATIVES WITH RESPECT TO GLOBAL COORDINATES           BASIS3.......13300
      DO 200 I=1,8                                                       BASIS3.......13400
      DFDXG(I)=CIJ11*DFDXL(I)+CIJ12*DFDYL(I)+CIJ13*DFDZL(I)              BASIS3.......13500
      DFDYG(I)=CIJ21*DFDXL(I)+CIJ22*DFDYL(I)+CIJ23*DFDZL(I)              BASIS3.......13600
  200 DFDZG(I)=CIJ31*DFDXL(I)+CIJ32*DFDYL(I)+CIJ33*DFDZL(I)              BASIS3.......13700
C                                                                        BASIS3.......13800
C.....CALCULATE CONSISTENT COMPONENTS OF (RHO*GRAV) TERM IN LOCAL        BASIS3.......13900
C        COORDINATES AT THIS LOCATION, (XLOC,YLOC,ZLOC)                  BASIS3.......14000
      RGXL=0.D0                                                          BASIS3.......14100
      RGYL=0.D0                                                          BASIS3.......14200
      RGZL=0.D0                                                          BASIS3.......14300
      RGXLM1=0.D0                                                        BASIS3.......14400
      RGYLM1=0.D0                                                        BASIS3.......14500
      RGZLM1=0.D0                                                        BASIS3.......14600
      DO 800 IL=1,8                                                      BASIS3.......14700
      II=(L-1)*8+IL                                                      BASIS3.......14800
      I=IN(II)                                                           BASIS3.......14900
      ADFDXL=DABS(DFDXL(IL))                                             BASIS3.......15000
      ADFDYL=DABS(DFDYL(IL))                                             BASIS3.......15100
      ADFDZL=DABS(DFDZL(IL))                                             BASIS3.......15200
      RGXL=RGXL+RCIT(I)*GXSI(L,IL)*ADFDXL                                BASIS3.......15300
      RGYL=RGYL+RCIT(I)*GETA(L,IL)*ADFDYL                                BASIS3.......15400
      RGZL=RGZL+RCIT(I)*GZET(L,IL)*ADFDZL                                BASIS3.......15500
      RGXLM1=RGXLM1+RCITM1(I)*GXSI(L,IL)*ADFDXL                          BASIS3.......15600
      RGYLM1=RGYLM1+RCITM1(I)*GETA(L,IL)*ADFDYL                          BASIS3.......15700
      RGZLM1=RGZLM1+RCITM1(I)*GZET(L,IL)*ADFDZL                          BASIS3.......15800
  800 CONTINUE                                                           BASIS3.......15900
C                                                                        BASIS3.......16000
C.....TRANSFORM CONSISTENT COMPONENTS OF (RHO*GRAV) TERM TO              BASIS3.......16100
C        GLOBAL COORDINATES                                              BASIS3.......16200
      RGXG=CIJ11*RGXL+CIJ12*RGYL+CIJ13*RGZL                              BASIS3.......16300
      RGYG=CIJ21*RGXL+CIJ22*RGYL+CIJ23*RGZL                              BASIS3.......16400
      RGZG=CIJ31*RGXL+CIJ32*RGYL+CIJ33*RGZL                              BASIS3.......16500
      RGXGM1=CIJ11*RGXLM1+CIJ12*RGYLM1+CIJ13*RGZLM1                      BASIS3.......16600
      RGYGM1=CIJ21*RGXLM1+CIJ22*RGYLM1+CIJ23*RGZLM1                      BASIS3.......16700
      RGZGM1=CIJ31*RGXLM1+CIJ32*RGYLM1+CIJ33*RGZLM1                      BASIS3.......16800
C                                                                        BASIS3.......16900
C.....CALCULATE PARAMETER VALUES AT THIS LOCATION, (XLOC,YLOC,ZLOC)      BASIS3.......17000
      PITERG=0.D0                                                        BASIS3.......17100
      UITERG=0.D0                                                        BASIS3.......17200
      DPDXG=0.D0                                                         BASIS3.......17300
      DPDYG=0.D0                                                         BASIS3.......17400
      DPDZG=0.D0                                                         BASIS3.......17500
      PORG=0.D0                                                          BASIS3.......17600
      DO 1000 IL=1,8                                                     BASIS3.......17700
      II=(L-1)*8 +IL                                                     BASIS3.......17800
      I=IN(II)                                                           BASIS3.......17900
      DPDXG=DPDXG+PVEL(I)*DFDXG(IL)                                      BASIS3.......18000
      DPDYG=DPDYG+PVEL(I)*DFDYG(IL)                                      BASIS3.......18100
      DPDZG=DPDZG+PVEL(I)*DFDZG(IL)                                      BASIS3.......18200
      PORG=PORG+POR(I)*F(IL)                                             BASIS3.......18300
      PITERG=PITERG+PITER(I)*F(IL)                                       BASIS3.......18400
      UITERG=UITERG+UITER(I)*F(IL)                                       BASIS3.......18500
 1000 CONTINUE                                                           BASIS3.......18600
C                                                                        BASIS3.......18700
C.....SET VALUES FOR DENSITY AND VISCOSITY.                              BASIS3.......18800
C.....RHOG = FUNCTION(UITER)                                             BASIS3.......18900
      RHOG=RHOW0+DRWDU*(UITERG-URHOW0)                                   BASIS3.......19000
C.....VISCG = FUNCTION(UITER); VISCOSITY IN UNITS OF VISC0*(KG/(M*SEC))  BASIS3.......19100
      IF(ME) 1300,1300,1200                                              BASIS3.......19200
 1200 VISCG=VISC0*239.4D-7*(10.D0**(248.37D0/(UITERG+133.15D0)))         BASIS3.......19300
      GOTO 1400                                                          BASIS3.......19400
C.....FOR SOLUTE TRANSPORT, VISCG IS TAKEN TO BE CONSTANT                BASIS3.......19500
 1300 VISCG=VISC0                                                        BASIS3.......19600
 1400 CONTINUE                                                           BASIS3.......19700
C                                                                        BASIS3.......19800
C.....SET UNSATURATED FLOW PARAMETERS SWG AND RELKG                      BASIS3.......19900
      IF(IUNSAT-2) 1600,1500,1600                                        BASIS3.......20000
 1500 IF(PITERG) 1550,1600,1600                                          BASIS3.......20100
 1550 CALL UNSAT(SWG,DSWDPG,RELKG,PITERG,LREG(L))                        BASIS3.......20200
      GOTO 1700                                                          BASIS3.......20300
 1600 SWG=1.0D0                                                          BASIS3.......20400
      RELKG=1.0D0                                                        BASIS3.......20500
 1700 CONTINUE                                                           BASIS3.......20600
C                                                                        BASIS3.......20700
C.....CALCULATE CONSISTENT FLUID VELOCITIES WITH RESPECT TO GLOBAL       BASIS3.......20800
C        COORDINATES, VXG, VYG, VZG, AND VGMAG, AT THIS LOCATION,        BASIS3.......20900
C        (XLOC,YLOC,ZLOC)                                                BASIS3.......21000
      DENOM=1.D0/(PORG*SWG*VISCG)                                        BASIS3.......21100
      PGX=DPDXG-RGXGM1                                                   BASIS3.......21200
      PGY=DPDYG-RGYGM1                                                   BASIS3.......21300
      PGZ=DPDZG-RGZGM1                                                   BASIS3.......21400
C.....ZERO OUT RANDOM BOUYANT DRIVING FORCES DUE TO DIFFERENCING         BASIS3.......21500
C        NUMBERS PAST PRECISION LIMIT.  MINIMUM DRIVING FORCE IS         BASIS3.......21600
C        1.D-10 OF PRESSURE GRADIENT.  (THIS VALUE MAY BE CHANGED        BASIS3.......21700
C        DEPENDING ON MACHINE PRECISION.)                                BASIS3.......21800
      IF(DPDXG) 1720,1727,1720                                           BASIS3.......21900
 1720 IF(DABS(PGX/DPDXG)-1.0D-10) 1725,1725,1727                         BASIS3.......22000
 1725 PGX=0.0D0                                                          BASIS3.......22100
 1727 IF(DPDYG) 1730,1737,1730                                           BASIS3.......22200
 1730 IF(DABS(PGY/DPDYG)-1.0D-10) 1735,1735,1737                         BASIS3.......22300
 1735 PGY=0.0D0                                                          BASIS3.......22400
 1737 IF(DPDZG) 1740,1760,1740                                           BASIS3.......22500
 1740 IF(DABS(PGZ/DPDZG)-1.0D-10) 1745,1745,1760                         BASIS3.......22600
 1745 PGZ=0.0D0                                                          BASIS3.......22700
 1760 VXG=-DENOM*(PERMXX(L)*PGX+PERMXY(L)*PGY+PERMXZ(L)*PGZ)*RELKG       BASIS3.......22800
      VYG=-DENOM*(PERMYX(L)*PGX+PERMYY(L)*PGY+PERMYZ(L)*PGZ)*RELKG       BASIS3.......22900
      VZG=-DENOM*(PERMZX(L)*PGX+PERMZY(L)*PGY+PERMZZ(L)*PGZ)*RELKG       BASIS3.......23000
      VXG2=VXG*VXG                                                       BASIS3.......23100
      VYG2=VYG*VYG                                                       BASIS3.......23200
      VZG2=VZG*VZG                                                       BASIS3.......23300
      VGMAG=DSQRT(VXG2+VYG2+VZG2)                                        BASIS3.......23400
C                                                                        BASIS3.......23500
C.....AT THIS POINT IN LOCAL COORDINATES, (XLOC,YLOC,ZLOC),              BASIS3.......23600
C        CALCULATE ASYMMETRIC WEIGHTING FUNCTIONS, W(I),                 BASIS3.......23700
C        AND SPACE DERIVATIVES, DWDXG(I), DWDYG(I), AND DWDZG(I).        BASIS3.......23800
C                                                                        BASIS3.......23900
C.....ASYMMETRIC FUNCTIONS SIMPLIFY WHEN  UP=0.0                         BASIS3.......24000
      IF(UP.GT.1.0D-6.AND.NOUMAT.EQ.0) GOTO 1790                         BASIS3.......24100
      DO 1780 I=1,8                                                      BASIS3.......24200
      W(I)=F(I)                                                          BASIS3.......24300
      DWDXG(I)=DFDXG(I)                                                  BASIS3.......24400
      DWDYG(I)=DFDYG(I)                                                  BASIS3.......24500
      DWDZG(I)=DFDZG(I)                                                  BASIS3.......24600
 1780 CONTINUE                                                           BASIS3.......24700
C.....RETURN WHEN ONLY SYMMETRIC WEIGHTING FUNCTIONS ARE USED            BASIS3.......24800
      RETURN                                                             BASIS3.......24900
C                                                                        BASIS3.......25000
C.....CALCULATE FLUID VELOCITIES WITH RESPECT TO LOCAL COORDINATES,      BASIS3.......25100
C        VXL, VYL, VZL, AND VLMAG, AT THIS LOCATION, (XLOC,YLOC,ZLOC).   BASIS3.......25200
 1790 VXL=CIJ11*VXG+CIJ21*VYG+CIJ31*VZG                                  BASIS3.......25300
      VYL=CIJ12*VXG+CIJ22*VYG+CIJ32*VZG                                  BASIS3.......25400
      VZL=CIJ13*VXG+CIJ23*VYG+CIJ33*VZG                                  BASIS3.......25500
      VLMAG=DSQRT(VXL*VXL+VYL*VYL+VZL*VZL)                               BASIS3.......25600
C                                                                        BASIS3.......25700
      AA=0.0D0                                                           BASIS3.......25800
      BB=0.0D0                                                           BASIS3.......25900
      GG=0.0D0                                                           BASIS3.......26000
      IF(VLMAG) 1900,1900,1800                                           BASIS3.......26100
 1800 AA=UP*VXL/VLMAG                                                    BASIS3.......26200
      BB=UP*VYL/VLMAG                                                    BASIS3.......26300
      GG=UP*VZL/VLMAG                                                    BASIS3.......26400
C                                                                        BASIS3.......26500
 1900 XIXI=.750D0*AA*XF1*XF2                                             BASIS3.......26600
      YIYI=.750D0*BB*YF1*YF2                                             BASIS3.......26700
      ZIZI=.750D0*GG*ZF1*ZF2                                             BASIS3.......26800
      DO 2000 I=1,8                                                      BASIS3.......26900
      AFX(I)=.50D0*FX(I)+XIIX(I)*XIXI                                    BASIS3.......27000
      AFY(I)=.50D0*FY(I)+YIIY(I)*YIYI                                    BASIS3.......27100
 2000 AFZ(I)=.50D0*FZ(I)+ZIIZ(I)*ZIZI                                    BASIS3.......27200
C                                                                        BASIS3.......27300
C.....CALCULATE ASYMMETRIC WEIGHTING FUNCTION, W.                        BASIS3.......27400
      DO 3000 I=1,8                                                      BASIS3.......27500
 3000 W(I)=AFX(I)*AFY(I)*AFZ(I)                                          BASIS3.......27600
C                                                                        BASIS3.......27700
      THAAX=0.50D0-1.50D0*AA*XLOC                                        BASIS3.......27800
      THBBY=0.50D0-1.50D0*BB*YLOC                                        BASIS3.......27900
      THGGZ=0.50D0-1.50D0*GG*ZLOC                                        BASIS3.......28000
      DO 4000 I=1,8                                                      BASIS3.......28100
      XDW(I)=XIIX(I)*THAAX                                               BASIS3.......28200
      YDW(I)=YIIY(I)*THBBY                                               BASIS3.......28300
 4000 ZDW(I)=ZIIZ(I)*THGGZ                                               BASIS3.......28400
C                                                                        BASIS3.......28500
C.....CALCULATE DERIVATIVES WITH RESPECT TO LOCAL COORDINATES.           BASIS3.......28600
      DO 5000 I=1,8                                                      BASIS3.......28700
      DWDXL(I)=XDW(I)*AFY(I)*AFZ(I)                                      BASIS3.......28800
      DWDYL(I)=YDW(I)*AFX(I)*AFZ(I)                                      BASIS3.......28900
 5000 DWDZL(I)=ZDW(I)*AFX(I)*AFY(I)                                      BASIS3.......29000
C                                                                        BASIS3.......29100
C.....CALCULATE DERIVATIVES WITH RESPECT TO GLOBAL COORDINATES.          BASIS3.......29200
      DO 6000 I=1,8                                                      BASIS3.......29300
      DWDXG(I)=CIJ11*DWDXL(I)+CIJ12*DWDYL(I)+CIJ13*DWDZL(I)              BASIS3.......29400
      DWDYG(I)=CIJ21*DWDXL(I)+CIJ22*DWDYL(I)+CIJ23*DWDZL(I)              BASIS3.......29500
 6000 DWDZG(I)=CIJ31*DWDXL(I)+CIJ32*DWDYL(I)+CIJ33*DWDZL(I)              BASIS3.......29600
C                                                                        BASIS3.......29700
C                                                                        BASIS3.......29800
      RETURN                                                             BASIS3.......29900
      END                                                                BASIS3.......30000
C                                                                        BASIS3.......30100
C     SUBROUTINE        B  C                       SUTRA VERSION 2.2     BC.............100
C                                                                        BC.............200
C *** PURPOSE :                                                          BC.............300
C ***  TO IMPLEMENT SPECIFIED PRESSURE AND SPECIFIED TEMPERATURE OR      BC.............400
C ***  CONCENTRATION CONDITIONS BY MODIFYING THE GLOBAL FLOW AND         BC.............500
C ***  TRANSPORT MATRIX EQUATIONS.                                       BC.............600
C                                                                        BC.............700
      SUBROUTINE BC(ML,PMAT,PVEC,UMAT,UVEC,IPBC,PBC,IUBC,UBC,QPLITR,JA,  BC.............800
     1   GNUP1,GNUU1)                                                    BC.............900
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                BC............1000
      DIMENSION PMAT(NELT,NCBI),PVEC(NNVEC),UMAT(NELT,NCBI),UVEC(NNVEC), BC............1100
     1   IPBC(NBCN),PBC(NBCN),IUBC(NBCN),UBC(NBCN),QPLITR(NBCN),         BC............1200
     2   GNUP1(NBCN),GNUU1(NBCN)                                         BC............1300
      DIMENSION JA(NDIMJA)                                               BC............1400
      DIMENSION KTYPE(2)                                                 BC............1500
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  BC............1600
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           BC............1700
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      BC............1800
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              BC............1900
     1   NSOP,NSOU,NBCN,NCIDB                                            BC............2000
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        BC............2100
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA                           BC............2200
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,      BC............2300
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2        BC............2400
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                           BC............2500
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       BC............2600
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      BC............2700
C                                                                        BC............2800
C                                                                        BC............2900
C.....SET UP MATRIX STRUCTURE INFORMATION                                BC............3000
      IF (KSOLVP.EQ.0) THEN                                              BC............3100
         JMID = NBHALF                                                   BC............3200
      ELSE                                                               BC............3300
         JMID = 1                                                        BC............3400
      END IF                                                             BC............3500
C                                                                        BC............3600
      IF(NPBC.EQ.0) GOTO 1050                                            BC............3700
C.....SPECIFIED P BOUNDARY CONDITIONS                                    BC............3800
      DO 1000 IP=1,NPBC                                                  BC............3900
      I=IABS(IPBC(IP))                                                   BC............4000
      IF (KSOLVP.EQ.0) THEN                                              BC............4100
         IMID = I                                                        BC............4200
      ELSE                                                               BC............4300
         IMID = JA(I)                                                    BC............4400
      END IF                                                             BC............4500
C                                                                        BC............4600
      IF(ML-1) 100,100,200                                               BC............4700
C.....MODIFY EQUATION FOR P BY ADDING FLUID SOURCE AT SPECIFIED          BC............4800
C        PRESSURE NODE                                                   BC............4900
  100 GPINL=-GNUP1(IP)                                                   BC............5000
      GPINR=GNUP1(IP)*PBC(IP)                                            BC............5100
      PMAT(IMID,JMID)=PMAT(IMID,JMID)-GPINL                              BC............5200
      PVEC(I)=PVEC(I)+GPINR                                              BC............5300
C                                                                        BC............5400
      IF(ML-1) 200,1000,200                                              BC............5500
C.....MODIFY EQUATION FOR U BY ADDING U SOURCE WHEN FLUID FLOWS IN       BC............5600
C        AT SPECIFIED PRESSURE NODE                                      BC............5700
  200 GUR=0.0D0                                                          BC............5800
      GUL=0.0D0                                                          BC............5900
      IF(QPLITR(IP)) 360,360,340                                         BC............6000
  340 GUL=-CW*QPLITR(IP)                                                 BC............6100
      GUR=-GUL*UBC(IP)                                                   BC............6200
  360 IF(NOUMAT) 370,370,380                                             BC............6300
  370 UMAT(IMID,JMID)=UMAT(IMID,JMID)-GUL                                BC............6400
  380 UVEC(I)=UVEC(I)+GUR                                                BC............6500
 1000 CONTINUE                                                           BC............6600
C                                                                        BC............6700
C                                                                        BC............6800
 1050 IF(ML-1) 1100,3000,1100                                            BC............6900
 1100 IF(NUBC.EQ.0) GOTO 3000                                            BC............7000
C.....SPECIFIED U BOUNDARY CONDITIONS.                                   BC............7100
C        MODIFY EQUATION FOR U BY ADDING ENERGY/SOLUTE MASS SOURCE       BC............7200
C        AT SPECIFIED U NODE                                             BC............7300
      DO 2500 IU=1,NUBC                                                  BC............7400
      IUP=IU+NPBC                                                        BC............7500
      I=IABS(IUBC(IUP))                                                  BC............7600
      IF (KSOLVP.EQ.0) THEN                                              BC............7700
         IMID = I                                                        BC............7800
      ELSE                                                               BC............7900
         IMID = JA(I)                                                    BC............8000
      END IF                                                             BC............8100
      IF(NOUMAT) 1200,1200,2000                                          BC............8200
 1200 GUINL=-GNUU1(IUP)                                                  BC............8300
      UMAT(IMID,JMID)=UMAT(IMID,JMID)-GUINL                              BC............8400
 2000 GUINR=GNUU1(IUP)*UBC(IUP)                                          BC............8500
 2500 UVEC(I)=UVEC(I)+GUINR                                              BC............8600
C                                                                        BC............8700
 3000 CONTINUE                                                           BC............8800
C                                                                        BC............8900
C                                                                        BC............9000
      RETURN                                                             BC............9100
      END                                                                BC............9200
C                                                                        BC............9300
C     SUBROUTINE        B  C  S  T  E  P           SUTRA VERSION 2.2     BCSTEP.........100
C                                                                        BCSTEP.........200
C *** PURPOSE :                                                          BCSTEP.........300
C ***  TO READ TIME-DEPENDENT BOUNDARY CONDITIONS FROM THE BCS FILES     BCSTEP.........400
c ***  AND UPDATE THE ARRAYS IN WHICH THEY ARE STORED.                   BCSTEP.........500
C                                                                        BCSTEP.........600
      SUBROUTINE BCSTEP(SETBCS,IPBC,PBC,IUBC,UBC,QIN,UIN,QUIN,IQSOP,     BCSTEP.........700
     1   IQSOU,IPBCT1,IUBCT1,IQSOPT1,IQSOUT1,GNUP1,GNUU1,                BCSTEP.........800
     2   IBCPBC,IBCUBC,IBCSOP,IBCSOU,IIDPBC,IIDUBC,IIDSOP,IIDSOU,        BCSTEP.........900
     3   NCID,BCSFL,BCSTR)                                               BCSTEP........1000
      USE ALLARR, ONLY : CIDBCS                                          BCSTEP........1100
      USE BCSDEF                                                         BCSTEP........1200
      USE EXPINT                                                         BCSTEP........1300
      USE LLDEF                                                          BCSTEP........1400
      USE SCHDEF                                                         BCSTEP........1500
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                BCSTEP........1600
      CHARACTER INTFIL*1000                                              BCSTEP........1700
      CHARACTER*80 ERRCOD,CHERR(10),UNAME,FNAME(0:13)                    BCSTEP........1800
      CHARACTER*40 BCSID                                                 BCSTEP........1900
      LOGICAL ONCEBCS,SETBCS,SETFL,SETTR,BCSFL(0:ITMAX),BCSTR(0:ITMAX)   BCSTEP........2000
      LOGICAL USEFL,ANYFL,ANYTR                                          BCSTEP........2100
      INTEGER(1) IBCPBC(NBCN),IBCUBC(NBCN),IBCSOP(NSOP),IBCSOU(NSOU)     BCSTEP........2200
      INTEGER IIDPBC(NBCN),IIDUBC(NBCN),IIDSOP(NSOP),IIDSOU(NSOU)        BCSTEP........2300
      DIMENSION INERR(10),RLERR(10)                                      BCSTEP........2400
      DIMENSION IPBC(NBCN),PBC(NBCN),IUBC(NBCN),UBC(NBCN),               BCSTEP........2500
     1   GNUP1(NBCN),GNUU1(NBCN),                                        BCSTEP........2600
     2   QIN(NN),UIN(NN),QUIN(NN),IQSOP(NSOP),IQSOU(NSOU)                BCSTEP........2700
      DIMENSION KTYPE(2)                                                 BCSTEP........2800
      ALLOCATABLE :: IPBC1(:),PBC1(:),IUBC1(:),UBC1(:),                  BCSTEP........2900
     1   QIN1(:),UIN1(:),QUIN1(:),IQSOP1(:),IQSOU1(:)                    BCSTEP........3000
      COMMON /BCSL/ ONCEBCS                                              BCSTEP........3100
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  BCSTEP........3200
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           BCSTEP........3300
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      BCSTEP........3400
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              BCSTEP........3500
     1   NSOP,NSOU,NBCN,NCIDB                                            BCSTEP........3600
      COMMON /FUNIB/ NFBCS                                               BCSTEP........3700
      COMMON /FNAMES/ UNAME,FNAME                                        BCSTEP........3800
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 BCSTEP........3900
     1   K10,K11,K12,K13                                                 BCSTEP........4000
      COMMON /SCH/ NSCH,ISCHTS,NSCHAU                                    BCSTEP........4100
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       BCSTEP........4200
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      BCSTEP........4300
C                                                                        BCSTEP........4400
C.....IF THIS IS THE FIRST IN A SERIES OF CALLS, INITIALIZE BCS          BCSTEP........4500
C        SCHEDULES                                                       BCSTEP........4600
      IF (.NOT.ONCEBCS) THEN                                             BCSTEP........4700
         IF (.NOT.ALLOCATED(LCNT)) ALLOCATE (LCNT(NFBCS),DENBCS(NFBCS))  BCSTEP........4800
         DO 20 NFB=1,NFBCS                                               BCSTEP........4900
            DENBCS(NFB)%NENT => SCHDLS(BFP(NFB)%ISCHED)%SLIST            BCSTEP........5000
            LCNT(NFB) = 1                                                BCSTEP........5100
   20    CONTINUE                                                        BCSTEP........5200
         ONCEBCS = .TRUE.                                                BCSTEP........5300
      END IF                                                             BCSTEP........5400
C                                                                        BCSTEP........5500
C.....INITIALIZE FLAGS THAT INDICATE WHETHER BOUNDARY CONDITIONS ARE     BCSTEP........5600
C        ACTUALLY SET ON THIS TIME STEP.  THESE FLAGS ARE USED IN        BCSTEP........5700
C        DETERMINING SOLUTION CYCLING.  INITIALIZE COUNTER FOR BCS       BCSTEP........5800
C        IDENTIFIERS.                                                    BCSTEP........5900
      IF (ITBCS.NE.0) THEN                                               BCSTEP........6000
         BCSFL(ITBCS) = .FALSE.                                          BCSTEP........6100
         BCSTR(ITBCS) = .FALSE.                                          BCSTEP........6200
      END IF                                                             BCSTEP........6300
      IF (.NOT.((ISSTRA.NE.0).AND.(ITBCS.EQ.1))) NCID = 0                BCSTEP........6400
C                                                                        BCSTEP........6500
C.....LOOP OVER ALL BCS FILES                                            BCSTEP........6600
      DO 1000 NFB=1,NFBCS                                                BCSTEP........6700
         K9 = IUNIB(NFB)                                                 BCSTEP........6800
C........SET FNAME(9) EQUAL TO FNAMB(NFB) FOR CONVENIENCE IN             BCSTEP........6900
C           ERROR HANDLING                                               BCSTEP........7000
         FNAME(9) = FNAMB(NFB)                                           BCSTEP........7100
         LENSCH = SCHDLS(BFP(NFB)%ISCHED)%LLEN                           BCSTEP........7200
C                                                                        BCSTEP........7300
C...,,FIND BOUNDARY CONDITIONS FOR THE CURRENT TIME STEP, IF ANY.        BCSTEP........7400
C        (IF THIS BCS SCHEDULE IS EXHAUSTED, SKIP TO NEXT FILE.)         BCSTEP........7500
  100 IF (LCNT(NFB).GT.LENSCH) GOTO 1000                                 BCSTEP........7600
      ITNBCS = INT(DENBCS(NFB)%NENT%DVALU2)                              BCSTEP........7700
      IF (ITBCS.LT.ITNBCS) THEN                                          BCSTEP........7800
C........THE CURRENT TIME STEP PRECEDES THIS BCS SCHEDULE ENTRY.         BCSTEP........7900
C          SKIP TO NEXT FILE.                                            BCSTEP........8000
         GOTO 1000                                                       BCSTEP........8100
      ELSE                                                               BCSTEP........8200
         WRITE(CHERR(1),*) ITNBCS                                        BCSTEP........8300
         ERRCOD = 'REA-BCS-2'                                            BCSTEP........8400
         CHERR(2) = 'unknown'                                            BCSTEP........8500
         CALL READIF(K9, NFB, INTFIL, ERRCOD, CHERR)                     BCSTEP........8600
         READ(INTFIL,*,IOSTAT=INERR(1)) BCSID,NSOP1,NSOU1,NPBC1,NUBC1    BCSTEP........8700
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     BCSTEP........8800
         IF ((ITNBCS.EQ.0).AND.(NSOU1+NUBC1.GT.0)) THEN                  BCSTEP........8900
            ERRCOD = 'BCS-2-1'                                           BCSTEP........9000
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     BCSTEP........9100
         END IF                                                          BCSTEP........9200
         IF (ITBCS.GT.ITNBCS) THEN                                       BCSTEP........9300
C...........THE CURRENT TIME STEP IS PAST THIS BCS SCHEDULE ENTRY,       BCSTEP........9400
C             READ PAST THIS SPECIFICATION AND ADVANCE TO THE NEXT       BCSTEP........9500
C             SCHEDULE ENTRY.                                            BCSTEP........9600
            CHERR(2) = BCSID                                             BCSTEP........9700
            ERRCOD = 'REA-BCS-3'                                         BCSTEP........9800
            IF (NSOP1.GT.0) THEN                                         BCSTEP........9900
               DO 120 N=1,NSOP1+1                                        BCSTEP.......10000
                  CALL READIF(K9, NFB, INTFIL, ERRCOD, CHERR)            BCSTEP.......10100
  120          CONTINUE                                                  BCSTEP.......10200
            END IF                                                       BCSTEP.......10300
            ERRCOD = 'REA-BCS-4'                                         BCSTEP.......10400
            IF (NSOU1.GT.0) THEN                                         BCSTEP.......10500
               DO 122 N=1,NSOU1+1                                        BCSTEP.......10600
                  CALL READIF(K9, NFB, INTFIL, ERRCOD, CHERR)            BCSTEP.......10700
  122          CONTINUE                                                  BCSTEP.......10800
            END IF                                                       BCSTEP.......10900
            ERRCOD = 'REA-BCS-5'                                         BCSTEP.......11000
            IF (NPBC1.GT.0) THEN                                         BCSTEP.......11100
               DO 124 N=1,NPBC1+1                                        BCSTEP.......11200
                  CALL READIF(K9, NFB, INTFIL, ERRCOD, CHERR)            BCSTEP.......11300
  124          CONTINUE                                                  BCSTEP.......11400
            END IF                                                       BCSTEP.......11500
            ERRCOD = 'REA-BCS-6'                                         BCSTEP.......11600
            IF (NUBC1.GT.0) THEN                                         BCSTEP.......11700
               DO 126 N=1,NUBC1+1                                        BCSTEP.......11800
                  CALL READIF(K9, NFB, INTFIL, ERRCOD, CHERR)            BCSTEP.......11900
  126          CONTINUE                                                  BCSTEP.......12000
            END IF                                                       BCSTEP.......12100
            LCNT(NFB) = LCNT(NFB) + 1                                    BCSTEP.......12200
            IF (LCNT(NFB).LE.LENSCH)                                     BCSTEP.......12300
     1         DENBCS(NFB)%NENT => DENBCS(NFB)%NENT%NENT                 BCSTEP.......12400
            GOTO 100                                                     BCSTEP.......12500
         END IF                                                          BCSTEP.......12600
      END IF                                                             BCSTEP.......12700
C                                                                        BCSTEP.......12800
C.....SET NBCN1, AND INCREMENT NSOP1 AND NSOU1 TO ACCOMMODATE FINAL      BCSTEP.......12900
C        ZERO WHEN READING.  COUNTS OF TIME-DEPENDENT NODES REFER TO     BCSTEP.......13000
C        THE BCS FILE CURRENTLY BEING READ.                              BCSTEP.......13100
      NBCN1 = NPBC1 + NUBC1 + 1                                          BCSTEP.......13200
      NSOP1 = NSOP1 + 1                                                  BCSTEP.......13300
      NSOU1 = NSOU1 + 1                                                  BCSTEP.......13400
C.....NSOPI IS ACTUAL NUMBER OF POSSIBLE FLUID SOURCE NODES              BCSTEP.......13500
      NSOPI = NSOP - 1                                                   BCSTEP.......13600
C.....NSOUI IS ACTUAL NUMBER OF POSSIBLE ENERGY OR SOLUTE MASS           BCSTEP.......13700
C        SOURCE NODES                                                    BCSTEP.......13800
      NSOUI = NSOU - 1                                                   BCSTEP.......13900
C.....NSOPI1 IS ACTUAL NUMBER OF TIME-STEP-DEPENDENT FLUID SOURCE NODES  BCSTEP.......14000
C        ON THIS TIME STEP                                               BCSTEP.......14100
      NSOPI1 = NSOP1 - 1                                                 BCSTEP.......14200
C.....NSOUI1 IS ACTUAL NUMBER OF TIME-STEP-DEPENDENT ENERGY OR SOLUTE    BCSTEP.......14300
C        MASS SOURCE NODES ON THIS TIME STEP                             BCSTEP.......14400
      NSOUI1 = NSOU1 - 1                                                 BCSTEP.......14500
C                                                                        BCSTEP.......14600
C.....SET FLAGS THAT DETERMINE WHETHER TO SET FLOW AND/OR TRANSPORT      BCSTEP.......14700
C        BOUNDARY CONDITIONS (IF ANY) AND THAT INDICATE WHETHER BOUNDARY BCSTEP.......14800
C        CONDITIONS ARE ACTUALLY SET ON THIS TIME STEP                   BCSTEP.......14900
      USEFL = ((ISSFLO.NE.0).AND.(ITBCS.EQ.0)).OR.                       BCSTEP.......15000
     1   ((ISSFLO.EQ.0).AND.(ITBCS.NE.0))                                BCSTEP.......15100
      ANYFL = NSOPI1+NPBC1.GT.0                                          BCSTEP.......15200
      ANYTR = NSOUI1+NUBC1.GT.0                                          BCSTEP.......15300
      BCSFL(ITBCS) = USEFL.AND.ANYFL                                     BCSTEP.......15400
      BCSTR(ITBCS) = ANYTR                                               BCSTEP.......15500
      SETFL = SETBCS.AND.BCSFL(ITBCS)                                    BCSTEP.......15600
      SETTR = SETBCS.AND.BCSTR(ITBCS)                                    BCSTEP.......15700
      IF (BCSFL(ITBCS).OR.BCSTR(ITBCS)) THEN                             BCSTEP.......15800
         NCID = NCID + 1                                                 BCSTEP.......15900
         IF (SETBCS) CIDBCS(NCID) = BCSID                                BCSTEP.......16000
      END IF                                                             BCSTEP.......16100
C                                                                        BCSTEP.......16200
C.....IF NO TIME-DEPENDENT SOURCE/SINK CONDITIONS, SKIP THIS SECTION     BCSTEP.......16300
      IF ((NSOPI1+NSOUI1).EQ.0) GOTO 500                                 BCSTEP.......16400
C                                                                        BCSTEP.......16500
C.....ALLOCATE ARRAYS FOR SOURCE/SINK CONDITIONS                         BCSTEP.......16600
      ALLOCATE(QIN1(NN),UIN1(NN),QUIN1(NN),IQSOP1(NSOP1),IQSOU1(NSOU1))  BCSTEP.......16700
C                                                                        BCSTEP.......16800
C.....INPUT BCS DATASETS 3 & 4 (SOURCES OF FLUID MASS AND ENERGY OR      BCSTEP.......16900
C        SOLUTE MASS) FOR CURRENT TIME STEP                              BCSTEP.......17000
      CALL SOURCE1(QIN1,UIN1,IQSOP1,QUIN1,IQSOU1,IQSOPT1,IQSOUT1,        BCSTEP.......17100
     1   NSOP1,NSOU1,NFB,BCSID)                                          BCSTEP.......17200
C                                                                        BCSTEP.......17300
C.....SET TIME-STEP-DEPENDENT FLUID SOURCES/SINKS,                       BCSTEP.......17400
C      OR CONCENTRATIONS (TEMPERATURES) OF SOURCE FLUID                  BCSTEP.......17500
C                                                                        BCSTEP.......17600
      IF (NSOPI1.GT.0) THEN                                              BCSTEP.......17700
      DO 200 IQP1=1,NSOPI1                                               BCSTEP.......17800
         I=IQSOP1(IQP1)                                                  BCSTEP.......17900
         DO 150 IQP0=1,NSOPI                                             BCSTEP.......18000
            I0 = IQSOP(IQP0)                                             BCSTEP.......18100
            IF (IABS(I0).EQ.IABS(I)) THEN                                BCSTEP.......18200
               IQP = IQP0                                                BCSTEP.......18300
               GOTO 180                                                  BCSTEP.......18400
            END IF                                                       BCSTEP.......18500
  150    CONTINUE                                                        BCSTEP.......18600
         ERRCOD = 'BCS-3-2'                                              BCSTEP.......18700
         INERR(1) = IABS(I)                                              BCSTEP.......18800
         INERR(2) = ITBCS                                                BCSTEP.......18900
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        BCSTEP.......19000
  180    CONTINUE                                                        BCSTEP.......19100
         IF (SETFL) THEN                                                 BCSTEP.......19200
            IF (I.GT.0) THEN                                             BCSTEP.......19300
               QIN(I) = QIN1(I)                                          BCSTEP.......19400
               IF (QIN(I).GT.0D0) UIN(I) = UIN1(I)                       BCSTEP.......19500
               IBCSOP(IQP) = 1                                           BCSTEP.......19600
            ELSE                                                         BCSTEP.......19700
               QIN(-I) = 0D0                                             BCSTEP.......19800
               IBCSOP(IQP) = 2                                           BCSTEP.......19900
            END IF                                                       BCSTEP.......20000
            IIDSOP(IQP) = NCID                                           BCSTEP.......20100
         END IF                                                          BCSTEP.......20200
  200 CONTINUE                                                           BCSTEP.......20300
      END IF                                                             BCSTEP.......20400
C                                                                        BCSTEP.......20500
C.....SET TIME-STEP-DEPENDENT SOURCES/SINKS                              BCSTEP.......20600
C     OF SOLUTE MASS OR ENERGY                                           BCSTEP.......20700
C                                                                        BCSTEP.......20800
      IF (NSOUI1.GT.0) THEN                                              BCSTEP.......20900
      DO 400 IQU1=1,NSOUI1                                               BCSTEP.......21000
         I=IQSOU1(IQU1)                                                  BCSTEP.......21100
         DO 350 IQU0=1,NSOUI                                             BCSTEP.......21200
            I0 = IQSOU(IQU0)                                             BCSTEP.......21300
            IF (IABS(I0).EQ.IABS(I)) THEN                                BCSTEP.......21400
               IQU = IQU0                                                BCSTEP.......21500
               GOTO 380                                                  BCSTEP.......21600
            END IF                                                       BCSTEP.......21700
  350    CONTINUE                                                        BCSTEP.......21800
         ERRCOD = 'BCS-4-2'                                              BCSTEP.......21900
         INERR(1) = IABS(I)                                              BCSTEP.......22000
         INERR(2) = ITBCS                                                BCSTEP.......22100
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        BCSTEP.......22200
  380    CONTINUE                                                        BCSTEP.......22300
         IF (SETTR) THEN                                                 BCSTEP.......22400
            IF (I.GT.0) THEN                                             BCSTEP.......22500
               QUIN(I) = QUIN1(I)                                        BCSTEP.......22600
               IBCSOU(IQU) = 1                                           BCSTEP.......22700
            ELSE                                                         BCSTEP.......22800
               QUIN(-I) = 0D0                                            BCSTEP.......22900
               IBCSOU(IQU) = 2                                           BCSTEP.......23000
            END IF                                                       BCSTEP.......23100
            IIDSOU(IQU) = NCID                                           BCSTEP.......23200
         END IF                                                          BCSTEP.......23300
  400 CONTINUE                                                           BCSTEP.......23400
      END IF                                                             BCSTEP.......23500
C                                                                        BCSTEP.......23600
C.....DEALLOCATE ARRAYS FOR SOURCE/SINK CONDITIONS                       BCSTEP.......23700
      DEALLOCATE(QIN1,UIN1,QUIN1,IQSOP1,IQSOU1)                          BCSTEP.......23800
C                                                                        BCSTEP.......23900
C.....IF NO TIME-DEPENDENT SPECIFIED P OR U BOUNDARY CONDITIONS, SKIP    BCSTEP.......24000
C        THIS SECTION                                                    BCSTEP.......24100
  500 IF (NBCN1-1.EQ.0) GOTO 900                                         BCSTEP.......24200
C                                                                        BCSTEP.......24300
C.....ALLOCATE ARRAYS FOR SPECIFIED P AND U BOUNDARY CONDITIONS          BCSTEP.......24400
      ALLOCATE(IPBC1(NBCN1),PBC1(NBCN1),IUBC1(NBCN1),UBC1(NBCN1))        BCSTEP.......24500
C                                                                        BCSTEP.......24600
C.....INPUT BCS DATASETS 5 & 6 (SPECIFIED P AND U BOUNDARY CONDITIONS)   BCSTEP.......24700
C        FOR CURRENT TIME STEP                                           BCSTEP.......24800
      CALL BOUND1(IPBC1,PBC1,IUBC1,UBC1,IPBCT1,IUBCT1,                   BCSTEP.......24900
     1   NPBC1,NUBC1,NBCN1,NFB,BCSID)                                    BCSTEP.......25000
C                                                                        BCSTEP.......25100
C.....SET TIME-STEP-DEPENDENT SPECIFIED PRESSURES OR                     BCSTEP.......25200
C     CONCENTRATIONS (TEMPERATURES) OF INFLOWS AT SPECIFIED              BCSTEP.......25300
C     PRESSURE NODES                                                     BCSTEP.......25400
C                                                                        BCSTEP.......25500
      IF (NPBC1.GT.0) THEN                                               BCSTEP.......25600
      DO 600 IP1=1,NPBC1                                                 BCSTEP.......25700
         I = IPBC1(IP1)                                                  BCSTEP.......25800
         DO 550 IP0=1,NPBC                                               BCSTEP.......25900
            I0 = IPBC(IP0)                                               BCSTEP.......26000
            IF (IABS(I0).EQ.IABS(I)) THEN                                BCSTEP.......26100
               IP = IP0                                                  BCSTEP.......26200
               GOTO 580                                                  BCSTEP.......26300
            END IF                                                       BCSTEP.......26400
  550    CONTINUE                                                        BCSTEP.......26500
         ERRCOD = 'BCS-5-2'                                              BCSTEP.......26600
         INERR(1) = IABS(I)                                              BCSTEP.......26700
         INERR(2) = ITBCS                                                BCSTEP.......26800
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        BCSTEP.......26900
  580    CONTINUE                                                        BCSTEP.......27000
         IF (SETFL) THEN                                                 BCSTEP.......27100
            IF (I.GT.0) THEN                                             BCSTEP.......27200
               PBC(IP) = PBC1(IP1)                                       BCSTEP.......27300
               UBC(IP) = UBC1(IP1)                                       BCSTEP.......27400
               GNUP1(IP) = GNUP                                          BCSTEP.......27500
               IBCPBC(IP) = 1                                            BCSTEP.......27600
            ELSE                                                         BCSTEP.......27700
               GNUP1(IP) = 0D0                                           BCSTEP.......27800
               IBCPBC(IP) = 2                                            BCSTEP.......27900
            END IF                                                       BCSTEP.......28000
            IIDPBC(IP) = NCID                                            BCSTEP.......28100
         END IF                                                          BCSTEP.......28200
  600 CONTINUE                                                           BCSTEP.......28300
      END IF                                                             BCSTEP.......28400
C                                                                        BCSTEP.......28500
C.....SET TIME-STEP-DEPENDENT SPECIFIED                                  BCSTEP.......28600
C     CONCENTRATIONS (TEMPERATURES)                                      BCSTEP.......28700
C                                                                        BCSTEP.......28800
      IF (NUBC1.GT.0) THEN                                               BCSTEP.......28900
      DO 800 IU1=1,NUBC1                                                 BCSTEP.......29000
         IUP1 = IU1 + NPBC1                                              BCSTEP.......29100
         I=IUBC1(IUP1)                                                   BCSTEP.......29200
         DO 700 IU0=1,NUBC                                               BCSTEP.......29300
            IUP0 = IU0 + NPBC                                            BCSTEP.......29400
            I0 = IUBC(IUP0)                                              BCSTEP.......29500
            IF (IABS(I0).EQ.IABS(I)) THEN                                BCSTEP.......29600
               IUP = IUP0                                                BCSTEP.......29700
               GOTO 750                                                  BCSTEP.......29800
            END IF                                                       BCSTEP.......29900
  700    CONTINUE                                                        BCSTEP.......30000
         ERRCOD = 'BCS-6-2'                                              BCSTEP.......30100
         INERR(1) = IABS(I)                                              BCSTEP.......30200
         INERR(2) = ITBCS                                                BCSTEP.......30300
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        BCSTEP.......30400
  750    CONTINUE                                                        BCSTEP.......30500
         IF (SETTR) THEN                                                 BCSTEP.......30600
            IF (I.GT.0) THEN                                             BCSTEP.......30700
               UBC(IUP) = UBC1(IUP1)                                     BCSTEP.......30800
               GNUU1(IUP) = GNUU                                         BCSTEP.......30900
               IBCUBC(IUP) = 1                                           BCSTEP.......31000
            ELSE                                                         BCSTEP.......31100
               GNUU1(IUP) = 0D0                                          BCSTEP.......31200
               IBCUBC(IUP) = 2                                           BCSTEP.......31300
            END IF                                                       BCSTEP.......31400
            IIDUBC(IUP) = NCID                                           BCSTEP.......31500
         END IF                                                          BCSTEP.......31600
  800 CONTINUE                                                           BCSTEP.......31700
      END IF                                                             BCSTEP.......31800
C                                                                        BCSTEP.......31900
C.....DEALLOCATE ARRAYS FOR SPECIFIED P AND U BOUNDARY CONDITIONS        BCSTEP.......32000
      DEALLOCATE(IPBC1,PBC1,IUBC1,UBC1)                                  BCSTEP.......32100
C                                                                        BCSTEP.......32200
C.....ADVANCE TO NEXT SCHEDULE ENTRY FOR THIS FILE (IF THERE IS ONE).    BCSTEP.......32300
  900 LCNT(NFB) = LCNT(NFB) + 1                                          BCSTEP.......32400
      IF (LCNT(NFB).LE.LENSCH)                                           BCSTEP.......32500
     1   DENBCS(NFB)%NENT => DENBCS(NFB)%NENT%NENT                       BCSTEP.......32600
C                                                                        BCSTEP.......32700
 1000 CONTINUE                                                           BCSTEP.......32800
      RETURN                                                             BCSTEP.......32900
      END                                                                BCSTEP.......33000
C                                                                        BCSTEP.......33100
C     SUBPROGRAM        B  D  I  N  I  T           SUTRA VERSION 2.2     BDINIT.........100
C                                                                        BDINIT.........200
C *** PURPOSE :                                                          BDINIT.........300
C ***  BLOCK-DATA SUBPROGRAM FOR INITIALIZING VARIABLES NAMED IN         BDINIT.........400
C ***  COMMON BLOCKS.                                                    BDINIT.........500
C                                                                        BDINIT.........600
      BLOCK DATA BDINIT                                                  BDINIT.........700
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                BDINIT.........800
      CHARACTER*40 SOLNAM(0:10)                                          BDINIT.........900
      CHARACTER*10 SOLWRD(0:10)                                          BDINIT........1000
      COMMON /SOLVC/ SOLWRD, SOLNAM                                      BDINIT........1100
      COMMON /SOLVN/ NSLVRS                                              BDINIT........1200
C.....SET THE NUMBER OF SOLVERS AVAILABLE                                BDINIT........1300
      DATA NSLVRS /4/                                                    BDINIT........1400
C.....DEFINE KEYWORDS AND NAMES FOR SOLVERS                              BDINIT........1500
      DATA (SOLWRD(M),SOLNAM(M),M=0,10) /                                BDINIT........1600
     1   'DIRECT', 'BANDED GAUSSIAN ELIMINATION (DIRECT)',               BDINIT........1700
     2   'CG', 'IC-PRECONDITIONED CONJUGATE GRADIENT',                   BDINIT........1800
     3   'GMRES', 'ILU-PRECONDITIONED GMRES',                            BDINIT........1900
     4   'ORTHOMIN', 'ILU-PRECONDITIONED ORTHOMIN',                      BDINIT........2000
     5   '', '',                                                         BDINIT........2100
     6   '', '',                                                         BDINIT........2200
     7   '', '',                                                         BDINIT........2300
     8   '', '',                                                         BDINIT........2400
     9   '', '',                                                         BDINIT........2500
     T   '', '',                                                         BDINIT........2600
     1   '', ''/                                                         BDINIT........2700
      END                                                                BDINIT........2800
C                                                                        BDINIT........2900
C     SUBROUTINE        B  O  U  N  D              SUTRA VERSION 2.2     BOUND..........100
C                                                                        BOUND..........200
C *** PURPOSE :                                                          BOUND..........300
C ***  TO READ AND ORGANIZE DEFAULT VALUES FOR SPECIFIED PRESSURE DATA   BOUND..........400
C ***  AND SPECIFIED TEMPERATURE OR CONCENTRATION DATA.                  BOUND..........500
C                                                                        BOUND..........600
      SUBROUTINE BOUND(IPBC,PBC,IUBC,UBC,IPBCT,IUBCT,IBCPBC,IBCUBC,      BOUND..........700
     1   GNUP1,GNUU1)                                                    BOUND..........800
      USE EXPINT                                                         BOUND..........900
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                BOUND.........1000
      CHARACTER INTFIL*1000                                              BOUND.........1100
      CHARACTER*80 ERRCOD,CHERR(10),UNAME,FNAME(0:13)                    BOUND.........1200
      DIMENSION IPBC(NBCN),PBC(NBCN),IUBC(NBCN),UBC(NBCN)                BOUND.........1300
      DIMENSION GNUP1(NBCN),GNUU1(NBCN)                                  BOUND.........1400
      DIMENSION INERR(10),RLERR(10)                                      BOUND.........1500
      INTEGER(1) IBCPBC(NBCN),IBCUBC(NBCN)                               BOUND.........1600
      DIMENSION KTYPE(2)                                                 BOUND.........1700
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  BOUND.........1800
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           BOUND.........1900
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      BOUND.........2000
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              BOUND.........2100
     1   NSOP,NSOU,NBCN,NCIDB                                            BOUND.........2200
      COMMON /FNAMES/ UNAME,FNAME                                        BOUND.........2300
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 BOUND.........2400
     1   K10,K11,K12,K13                                                 BOUND.........2500
C                                                                        BOUND.........2600
C                                                                        BOUND.........2700
      IP=0                                                               BOUND.........3000
      IPU=0                                                              BOUND.........3100
      IF(NPBC.EQ.0) GOTO 400                                             BOUND.........3200
      WRITE(K3,100)                                                      BOUND.........3300
  100 FORMAT('1'////11X,'S P E C I F I E D   P R E S S U R E   D A T A'  BOUND.........3400
     1   ////11X,'**** NODES AT WHICH PRESSURES ARE SPECIFIED ****'/)    BOUND.........3500
      IF(ME) 107,107,114                                                 BOUND.........3600
  107 WRITE(K3,108)                                                      BOUND.........3700
  108 FORMAT(16X,'(AS WELL AS SOLUTE CONCENTRATION OF ANY'               BOUND.........3800
     1   /16X,' FLUID INFLOW WHICH MAY OCCUR AT THE POINT'               BOUND.........3900
     2   /16X,' OF SPECIFIED PRESSURE)'                                  BOUND.........4000
     3  //12X,'NODE',10X,'DEFAULT PRESSURE',                             BOUND.........4100
     4     5X,'DEFAULT CONCENTRATION'//)                                 BOUND.........4200
      GOTO 125                                                           BOUND.........4300
  114 WRITE(K3,115)                                                      BOUND.........4400
  115 FORMAT(16X,'(AS WELL AS TEMPERATURE {DEGREES CELSIUS} OF ANY'      BOUND.........4500
     1   /16X,' FLUID INFLOW WHICH MAY OCCUR AT THE POINT'               BOUND.........4600
     2   /16X,' OF SPECIFIED PRESSURE)'                                  BOUND.........4700
     3  //12X,'NODE',10X,'DEFAULT PRESSURE',                             BOUND.........4800
     4     5X,'  DEFAULT TEMPERATURE'//)                                 BOUND.........4900
C                                                                        BOUND.........5000
C.....INPUT DATASET 19:  DATA FOR SPECIFIED PRESSURE NODES               BOUND.........5100
  125 IPU=IPU+1                                                          BOUND.........5200
      ERRCOD = 'REA-INP-19'                                              BOUND.........5300
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 BOUND.........5400
      READ(INTFIL,*,IOSTAT=INERR(1)) IDUM                                BOUND.........5500
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        BOUND.........5600
      IDUMA = IABS(IDUM)                                                 BOUND.........5700
      IF (IDUM.EQ.0) THEN                                                BOUND.........5800
         GOTO 180                                                        BOUND.........5900
      ELSE IF (IDUMA.GT.NN) THEN                                         BOUND.........6000
         ERRCOD = 'INP-19-1'                                             BOUND.........6100
         INERR(1) = IDUMA                                                BOUND.........6200
         INERR(2) = NN                                                   BOUND.........6300
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        BOUND.........6400
      ELSE IF (IPU.GT.NPBC) THEN                                         BOUND.........6500
         GOTO 125                                                        BOUND.........6600
      END IF                                                             BOUND.........6700
      IPBC(IPU) = IDUM                                                   BOUND.........6800
      IF (IPBC(IPU).GT.0) THEN                                           BOUND.........6900
         ERRCOD = 'REA-INP-19'                                           BOUND.........7000
         READ(INTFIL,*,IOSTAT=INERR(1)) IPBC(IPU),PBC(IPU),UBC(IPU)      BOUND.........7100
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     BOUND.........7200
         WRITE(K3,160) IPBC(IPU),PBC(IPU),UBC(IPU)                       BOUND.........7300
      ELSE IF (IPBC(IPU).LT.0) THEN                                      BOUND.........7400
         IPBCT = -1                                                      BOUND.........7500
         WRITE(K3,160) IPBC(IPU)                                         BOUND.........7600
      ELSE                                                               BOUND.........7700
         PBC(NBCN) = 0D0                                                 BOUND.........7750
         GOTO 180                                                        BOUND.........7800
      END IF                                                             BOUND.........7900
  160 FORMAT(7X,I9,6X,1PE20.13,6X,1PE20.13)                              BOUND.........8000
      GOTO 125                                                           BOUND.........8100
  180 IPU=IPU-1                                                          BOUND.........8200
      IP=IPU                                                             BOUND.........8300
      IF(IP.EQ.NPBC) GOTO 200                                            BOUND.........8400
      ERRCOD = 'INP-3,19-1'                                              BOUND.........8500
      INERR(1) = IP                                                      BOUND.........8600
      INERR(2) = NPBC                                                    BOUND.........8700
      CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                           BOUND.........8800
  200 IF(IPBCT.NE.-1) GOTO 250                                           BOUND.........8900
      IF(ME) 205,205,215                                                 BOUND.........9000
  205 WRITE(K3,206)                                                      BOUND.........9100
  206 FORMAT(//12X,'TIME-DEPENDENT SPECIFIED PRESSURE OR INFLOW ',       BOUND.........9200
     1   'CONCENTRATION'/12X,'SET IN SUBROUTINE BCTIME IS INDICATED ',   BOUND.........9300
     2   'BY NEGATIVE NODE NUMBER')                                      BOUND.........9400
      GOTO 250                                                           BOUND.........9500
  215 WRITE(K3,216)                                                      BOUND.........9600
  216 FORMAT(//12X,'TIME-DEPENDENT SPECIFIED PRESSURE OR INFLOW ',       BOUND.........9700
     1   'TEMPERATURE'/12X,'SET IN SUBROUTINE BCTIME IS INDICATED ',     BOUND.........9800
     2   'BY NEGATIVE NODE NUMBER')                                      BOUND.........9900
  250 WRITE(K3,252)                                                      BOUND........10000
  252 FORMAT(/11X,'SPECIFICATIONS MADE IN (OPTIONAL) ',                  BOUND........10100
     1   'BCS INPUT FILES TAKE PRECEDENCE OVER THE'/11X,                 BOUND........10200
     2   'DEFAULT VALUES LISTED ABOVE AND ANY VALUES ',                  BOUND........10300
     3   'SET IN SUBROUTINE BCTIME.')                                    BOUND........10400
C.....INITIALIZE GNUP1 ARRAY                                             BOUND........10500
      GNUP1 = GNUP                                                       BOUND........10600
C.....INITIALIZE ARRAY THAT INDICATES WHERE SPECIFIED-PRESSURE           BOUND........10700
C        CONDITIONS WERE SET (0 = INP FILE)                              BOUND........10800
      IBCPBC = 0                                                         BOUND........10900
C                                                                        BOUND........11000
  400 IF(NUBC.EQ.0) GOTO 9000                                            BOUND........11100
      IF(ME) 500,500,550                                                 BOUND........11200
  500 WRITE(K3,1000)                                                     BOUND........11300
 1000 FORMAT('1'////11X,'S P E C I F I E D   C O N C E N T R A T I O N', BOUND........11400
     1   '   D A T A'                                                    BOUND........11500
     2   ////11X,'**** NODES AT WHICH SOLUTE CONCENTRATIONS ARE ',       BOUND........11600
     3   'SPECIFIED TO BE INDEPENDENT OF LOCAL FLOWS AND FLUID SOURCES', BOUND........11700
     4   ' ****'//12X,'NODE',5X,'DEFAULT CONCENTRATION'//)               BOUND........11800
      GOTO 1125                                                          BOUND........11900
  550 WRITE(K3,1001)                                                     BOUND........12000
 1001 FORMAT('1'////11X,'S P E C I F I E D   T E M P E R A T U R E',     BOUND........12100
     1   '   D A T A'                                                    BOUND........12200
     2   ////11X,'**** NODES AT WHICH TEMPERATURES ARE ',                BOUND........12300
     3   'SPECIFIED TO BE INDEPENDENT OF LOCAL FLOWS AND FLUID SOURCES', BOUND........12400
     4   ' ****'//12X,'NODE',5X,'  DEFAULT TEMPERATURE'//)               BOUND........12500
C                                                                        BOUND........12600
C.....INPUT DATASET 20:  DATA FOR SPECIFIED CONCENTRATION OR             BOUND........12700
C        TEMPERATURE NODES                                               BOUND........12800
 1125 IPU=IPU+1                                                          BOUND........12900
      ERRCOD = 'REA-INP-20'                                              BOUND........13000
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 BOUND........13100
      READ(INTFIL,*,IOSTAT=INERR(1)) IDUM                                BOUND........13200
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        BOUND........13300
      IDUMA = IABS(IDUM)                                                 BOUND........13400
      IF (IDUM.EQ.0) THEN                                                BOUND........13500
         GOTO 1180                                                       BOUND........13600
      ELSE IF (IDUMA.GT.NN) THEN                                         BOUND........13700
         ERRCOD = 'INP-20-1'                                             BOUND........13800
         INERR(1) = IDUMA                                                BOUND........13900
         INERR(2) = NN                                                   BOUND........14000
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        BOUND........14100
      ELSE IF (IPU.GT.NPBC+NUBC) THEN                                    BOUND........14200
         GOTO 1125                                                       BOUND........14300
      END IF                                                             BOUND........14400
      IUBC(IPU) = IDUM                                                   BOUND........14500
      IF (IUBC(IPU).GT.0) THEN                                           BOUND........14600
         ERRCOD = 'REA-INP-20'                                           BOUND........14700
         READ(INTFIL,*,IOSTAT=INERR(1)) IUBC(IPU),UBC(IPU)               BOUND........14800
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     BOUND........14900
         WRITE(K3,1150) IUBC(IPU),UBC(IPU)                               BOUND........15000
      ELSE IF (IUBC(IPU).LT.0) THEN                                      BOUND........15100
         IUBCT = -1                                                      BOUND........15200
         WRITE(K3,1150) IUBC(IPU)                                        BOUND........15300
      ELSE                                                               BOUND........15400
         GOTO 1180                                                       BOUND........15500
      END IF                                                             BOUND........15600
 1150 FORMAT(7X,I9,6X,1PE20.13)                                          BOUND........15700
      GOTO 1125                                                          BOUND........15800
 1180 IPU=IPU-1                                                          BOUND........15900
      IU=IPU-IP                                                          BOUND........16000
      IF(IU.EQ.NUBC) GOTO 1200                                           BOUND........16100
      IF (ME.EQ.1) THEN                                                  BOUND........16200
         ERRCOD = 'INP-3,20-2'                                           BOUND........16300
      ELSE                                                               BOUND........16400
         ERRCOD = 'INP-3,20-1'                                           BOUND........16500
      END IF                                                             BOUND........16600
      INERR(1) = IU                                                      BOUND........16700
      INERR(2) = NUBC                                                    BOUND........16800
      CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                           BOUND........16900
 1200 IF(IUBCT.NE.-1) GOTO 6000                                          BOUND........17000
      IF(ME) 1205,1205,1215                                              BOUND........17100
 1205 WRITE(K3,1206)                                                     BOUND........17200
 1206 FORMAT(//11X,'TIME-DEPENDENT SPECIFIED CONCENTRATIONS USER-',      BOUND........17300
     1   'PROGRAMMED IN'/12X,'SUBROUTINE BCTIME ARE INDICATED BY ',      BOUND........17400
     2   'A NEGATIVE NODE NUMBER.')                                      BOUND........17500
      GOTO 6000                                                          BOUND........17600
 1215 WRITE(K3,1216)                                                     BOUND........17700
 1216 FORMAT(//11X,'TIME-DEPENDENT SPECIFIED TEMPERATURES USER-',        BOUND........17800
     1   'PROGRAMMED IN'/12X,'SUBROUTINE BCTIME ARE INDICATED BY ',      BOUND........17900
     2   'A NEGATIVE NODE NUMBER.')                                      BOUND........18000
 6000 WRITE(K3,252)                                                      BOUND........18100
C.....INITIALIZE GNUU1 ARRAY                                             BOUND........18200
      GNUU1 = GNUU                                                       BOUND........18300
C.....INITIALIZE ARRAY THAT INDICATES WHERE SPECIFIED-CONC OR TEMP       BOUND........18400
C        CONDITIONS WERE SET (0 = INP FILE)                              BOUND........18500
      IBCUBC = 0                                                         BOUND........18600
C                                                                        BOUND........18700
C                                                                        BOUND........18800
 9000 RETURN                                                             BOUND........18900
      END                                                                BOUND........19000
C                                                                        BOUND........19100
C     SUBROUTINE        B  O  U  N  D  1           SUTRA VERSION 2.2     BOUND1.........100
C                                                                        BOUND1.........200
C *** PURPOSE :                                                          BOUND1.........300
C ***  TO READ AND ORGANIZE TIME-DEPENDENT SPECIFIED PRESSURE DATA AND   BOUND1.........400
C ***  SPECIFIED TEMPERATURE OR CONCENTRATION DATA SPECIFIED IN THE      BOUND1.........500
C ***  OPTIONAL BCS INPUT FILE.                                          BOUND1.........600
C                                                                        BOUND1.........700
      SUBROUTINE BOUND1(IPBC1,PBC1,IUBC1,UBC1,IPBCT1,IUBCT1,             BOUND1.........800
     1   NPBC1,NUBC1,NBCN1,NFB,BCSID)                                    BOUND1.........900
      USE EXPINT                                                         BOUND1........1000
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                BOUND1........1100
      CHARACTER INTFIL*1000                                              BOUND1........1200
      CHARACTER*80 ERRCOD,CHERR(10),UNAME,FNAME(0:13)                    BOUND1........1300
      CHARACTER*40 BCSID                                                 BOUND1........1400
      DIMENSION IPBC1(NBCN1),PBC1(NBCN1),IUBC1(NBCN1),UBC1(NBCN1)        BOUND1........1500
      DIMENSION INERR(10),RLERR(10)                                      BOUND1........1600
      DIMENSION KTYPE(2)                                                 BOUND1........1700
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  BOUND1........1800
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           BOUND1........1900
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      BOUND1........2000
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              BOUND1........2100
     1   NSOP,NSOU,NBCN,NCIDB                                            BOUND1........2200
      COMMON /FNAMES/ UNAME,FNAME                                        BOUND1........2300
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 BOUND1........2400
     1   K10,K11,K12,K13                                                 BOUND1........2500
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       BOUND1........2600
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      BOUND1........2700
C                                                                        BOUND1........2800
C                                                                        BOUND1........2900
      IP = 0                                                             BOUND1........3000
      IPU = 0                                                            BOUND1........3100
      IPBCT1 = +1                                                        BOUND1........3200
      IUBCT1 = +1                                                        BOUND1........3300
C                                                                        BOUND1........3400
      IF (NPBC1.EQ.0) GOTO 400                                           BOUND1........3500
C                                                                        BOUND1........3600
C.....INPUT BCS DATASET 5:  DATA FOR SPECIFIED PRESSURE NODES            BOUND1........3700
      IPBCT1 = -1                                                        BOUND1........3800
  125 IPU = IPU + 1                                                      BOUND1........3900
      ERRCOD = 'REA-BCS-5'                                               BOUND1........4000
      WRITE(CHERR(1),*) ITBCS                                            BOUND1........4100
      CHERR(2) = BCSID                                                   BOUND1........4200
      CALL READIF(K9, NFB, INTFIL, ERRCOD, CHERR)                        BOUND1........4300
      READ(INTFIL,*,IOSTAT=INERR(1)) IDUM                                BOUND1........4400
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        BOUND1........4500
      IDUMA = IABS(IDUM)                                                 BOUND1........4600
      IF (IDUM.EQ.0) THEN                                                BOUND1........4700
         GOTO 180                                                        BOUND1........4800
      ELSE IF (IDUMA.GT.NN) THEN                                         BOUND1........4900
         ERRCOD = 'BCS-5-1'                                              BOUND1........5000
         INERR(1) = IDUMA                                                BOUND1........5100
         INERR(2) = NN                                                   BOUND1........5200
         INERR(3) = ITBCS                                                BOUND1........5300
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        BOUND1........5400
      ELSE IF (IPU.GT.NPBC1) THEN                                        BOUND1........5500
         GOTO 125                                                        BOUND1........5600
      END IF                                                             BOUND1........5700
      IPBC1(IPU) = IDUM                                                  BOUND1........5800
      IF (IPBC1(IPU).GT.0) THEN                                          BOUND1........5900
         ERRCOD = 'REA-BCS-5'                                            BOUND1........6000
         WRITE(CHERR(1),*) ITBCS                                         BOUND1........6100
         CHERR(2) = BCSID                                                BOUND1........6200
         READ(INTFIL,*,IOSTAT=INERR(1))                                  BOUND1........6300
     1      IPBC1(IPU),PBC1(IPU),UBC1(IPU)                               BOUND1........6400
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     BOUND1........6500
      ELSE IF (IPBC1(IPU).LT.0) THEN                                     BOUND1........6600
         CONTINUE                                                        BOUND1........6700
      ELSE                                                               BOUND1........6800
         GOTO 180                                                        BOUND1........6900
      END IF                                                             BOUND1........7000
      GOTO 125                                                           BOUND1........7100
  180 IPU = IPU - 1                                                      BOUND1........7200
      IP = IPU                                                           BOUND1........7300
      IF (IP.EQ.NPBC1) GOTO 400                                          BOUND1........7400
      ERRCOD = 'BCS-2,5-1'                                               BOUND1........7500
      INERR(1) = IP                                                      BOUND1........7600
      INERR(2) = NPBC1                                                   BOUND1........7700
      INERR(3) = ITBCS                                                   BOUND1........7800
      CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                           BOUND1........7900
C                                                                        BOUND1........8000
  400 IF(NUBC1.EQ.0) GOTO 8000                                           BOUND1........8100
C                                                                        BOUND1........8200
C.....INPUT BCS DATASET 6:  DATA FOR SPECIFIED CONCENTRATION OR          BOUND1........8300
C        TEMPERATURE NODES                                               BOUND1........8400
      IUBCT1 = -1                                                        BOUND1........8500
 1125 IPU = IPU + 1                                                      BOUND1........8600
      ERRCOD = 'REA-BCS-6'                                               BOUND1........8700
      WRITE(CHERR(1),*) ITBCS                                            BOUND1........8800
      CHERR(2) = BCSID                                                   BOUND1........8900
      CALL READIF(K9, NFB, INTFIL, ERRCOD, CHERR)                        BOUND1........9000
      READ(INTFIL,*,IOSTAT=INERR(1)) IDUM                                BOUND1........9100
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        BOUND1........9200
      IDUMA = IABS(IDUM)                                                 BOUND1........9300
      IF (IDUM.EQ.0) THEN                                                BOUND1........9400
         GOTO 1180                                                       BOUND1........9500
      ELSE IF (IDUMA.GT.NN) THEN                                         BOUND1........9600
         ERRCOD = 'BCS-6-1'                                              BOUND1........9700
         INERR(1) = IDUMA                                                BOUND1........9800
         INERR(2) = NN                                                   BOUND1........9900
         INERR(3) = ITBCS                                                BOUND1.......10000
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        BOUND1.......10100
      ELSE IF (IPU.GT.NPBC1+NUBC1) THEN                                  BOUND1.......10200
         GOTO 1125                                                       BOUND1.......10300
      END IF                                                             BOUND1.......10400
      IUBC1(IPU) = IDUM                                                  BOUND1.......10500
      IF (IUBC1(IPU).GT.0) THEN                                          BOUND1.......10600
         ERRCOD = 'REA-BCS-6'                                            BOUND1.......10700
         WRITE(CHERR(1),*) ITBCS                                         BOUND1.......10800
         CHERR(2) = BCSID                                                BOUND1.......10900
         READ(INTFIL,*,IOSTAT=INERR(1)) IUBC1(IPU),UBC1(IPU)             BOUND1.......11000
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     BOUND1.......11100
      ELSE IF (IUBC1(IPU).LT.0) THEN                                     BOUND1.......11200
         CONTINUE                                                        BOUND1.......11300
      ELSE                                                               BOUND1.......11400
         GOTO 1180                                                       BOUND1.......11500
      END IF                                                             BOUND1.......11600
      GOTO 1125                                                          BOUND1.......11700
 1180 IPU = IPU - 1                                                      BOUND1.......11800
      IU = IPU - IP                                                      BOUND1.......11900
      IF (IU.EQ.NUBC1) GOTO 8000                                         BOUND1.......12000
         ERRCOD = 'BCS-2,6-1'                                            BOUND1.......12100
         IF (ME.EQ.1) THEN                                               BOUND1.......12200
            CHERR(1) = ' temperature '                                   BOUND1.......12300
         ELSE                                                            BOUND1.......12400
            CHERR(1) = 'concentration'                                   BOUND1.......12500
         END IF                                                          BOUND1.......12600
         INERR(1) = IU                                                   BOUND1.......12700
         INERR(2) = NUBC1                                                BOUND1.......12800
         INERR(3) = ITBCS                                                BOUND1.......12900
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        BOUND1.......13000
C                                                                        BOUND1.......13100
 8000 CONTINUE                                                           BOUND1.......13200
C                                                                        BOUND1.......13300
      RETURN                                                             BOUND1.......13400
      END                                                                BOUND1.......13500
C                                                                        BOUND1.......13600
C     SUBROUTINE        B  U  D  G  E  T           SUTRA VERSION 2.2     BUDGET.........100
C                                                                        BUDGET.........200
C *** PURPOSE :                                                          BUDGET.........300
C ***  TO CALCULATE AND OUTPUT FLUID MASS AND SOLUTE MASS OR             BUDGET.........400
C ***  ENERGY BUDGETS.                                                   BUDGET.........500
C                                                                        BUDGET.........600
      SUBROUTINE BUDGET(ML,IBCT,VOL,SW,DSWDP,RHO,SOP,QIN,PVEC,PM1,       BUDGET.........700
     1   DPDTITR,PBC,QPLITR,IPBC,IQSOP,POR,UVEC,UM1,UM2,UIN,QUIN,QINITR, BUDGET.........800
     2   IQSOU,UBC,IUBC,CS1,CS2,CS3,SL,SR,NREG,GNUP1,GNUU1,              BUDGET.........900
     3   IBCSOP,IBCSOU,SM,SM1)
c     3   IBCSOP,IBCSOU)                                                  BUDGET........1000
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                BUDGET........1100
      CHARACTER*10 ADSMOD                                                BUDGET........1200
      CHARACTER*13 ULABL(2)                                              BUDGET........1300
      INTEGER(1) IBCSOP(NSOP),IBCSOU(NSOU)                               BUDGET........1400
      DIMENSION QIN(NN),UIN(NN),IQSOP(NSOP),QUIN(NN),QINITR(NN),         BUDGET........1500
     1   IQSOU(NSOU)                                                     BUDGET........1600
      DIMENSION IPBC(NBCN),IUBC(NBCN),UBC(NBCN),QPLITR(NBCN),PBC(NBCN),  BUDGET........1700
     1   GNUP1(NBCN),GNUU1(NBCN)                                         BUDGET........1800
      DIMENSION POR(NN),VOL(NN),PVEC(NNVEC),UVEC(NNVEC),SW(NN),          BUDGET........1900
     1   DSWDP(NN),RHO(NN),SOP(NN),PM1(NN),DPDTITR(NN),UM1(NN),UM2(NN),  BUDGET........2000
     2   CS1(NN),CS2(NN),CS3(NN),SL(NN),SR(NN),NREG(NN)                  BUDGET........2100
      DIMENSION KTYPE(2)                                                 BUDGET........2200
      DIMENSION SM(NNVEC),SM1(NNVEC)
      COMMON /ET/ QET,UET,PET,UVM,NGT,ITE,TMA,TMI,ALF,RS,RH,AP,BP,U2,
     1   TSD,SCF
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  BUDGET........2300
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           BUDGET........2400
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      BUDGET........2500
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              BUDGET........2600
     1   NSOP,NSOU,NBCN,NCIDB                                            BUDGET........2700
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA                           BUDGET........2800
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 BUDGET........2900
     1   K10,K11,K12,K13                                                 BUDGET........3000
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS      BUDGET........3100
      COMMON /MODSOR/ ADSMOD                                             BUDGET........3200
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,      BUDGET........3300
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2        BUDGET........3400
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       BUDGET........3500
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      BUDGET........3600
      DATA ULABL(1)/'CONCENTRATION'/,ULABL(2)/' TEMPERATURE '/           BUDGET........3700
      SAVE ULABL                                                         BUDGET........3800
C                                                                        BUDGET........3900
C                                                                        BUDGET........4000
      MN=2                                                               BUDGET........4100
      IF(IUNSAT.NE.0) IUNSAT=1                                           BUDGET........4200
      IF(ME.EQ.-1) MN=1                                                  BUDGET........4300
      WRITE(K3,10)                                                       BUDGET........4400
   10 FORMAT('1')                                                        BUDGET........4500
C.....SET UNSATURATED FLOW PARAMETERS, SW(I) AND DSWDP(I)                BUDGET........4600
      IF(IUNSAT-1) 40,20,40                                              BUDGET........4700
   20 DO 30 I=1,NN                                                       BUDGET........4800
      IF(PVEC(I)) 25,27,27                                               BUDGET........4900
   25 CALL UNSAT(SW(I),DSWDP(I),RELK,PVEC(I),NREG(I))                    BUDGET........5000
      GOTO 30                                                            BUDGET........5100
   27 SW(I)=1.0D0                                                        BUDGET........5200
      DSWDP(I)=0.0D0                                                     BUDGET........5300
   30 CONTINUE                                                           BUDGET........5400
C                                                                        BUDGET........5500
C.....CALCULATE COMPONENTS OF FLUID MASS BUDGET                          BUDGET........5600
   40 IF(ML-1) 50,50,1000                                                BUDGET........5700
   50 CONTINUE                                                           BUDGET........5800
      STPPOS = 0D0                                                       BUDGET........5900
      STPNEG = 0D0                                                       BUDGET........6000
      STUPOS = 0D0                                                       BUDGET........6100
      STUNEG = 0D0                                                       BUDGET........6200
      QINPOS = 0D0                                                       BUDGET........6300
      QINNEG = 0D0                                                       BUDGET........6400
      DO 100 I=1,NN                                                      BUDGET........6500
      TERM = (1-ISSFLO/2)*RHO(I)*VOL(I)*                                 BUDGET........6600
     1   (SW(I)*SOP(I)+POR(I)*DSWDP(I))*(PVEC(I)-PM1(I))/DELTP           BUDGET........6700
      STPPOS = STPPOS + MAX(0D0, TERM)                                   BUDGET........6800
      STPNEG = STPNEG + MIN(0D0, TERM)                                   BUDGET........6900
      TERM = (1-ISSFLO/2)*POR(I)*SW(I)*DRWDU*VOL(I)*                     BUDGET........7000
     1   (UM1(I)-UM2(I))/DLTUM1                                          BUDGET........7100
      STUPOS = STUPOS + MAX(0D0, TERM)                                   BUDGET........7200
      STUNEG = STUNEG + MIN(0D0, TERM)                                   BUDGET........7300
      TERM = QIN(I)                                                      BUDGET........7400
      QINPOS = QINPOS + MAX(0D0, TERM)                                   BUDGET........7500
      QINNEG = QINNEG + MIN(0D0, TERM)                                   BUDGET........7600
  100 CONTINUE                                                           BUDGET........7700
      STPTOT = STPPOS + STPNEG                                           BUDGET........7800
      STUTOT = STUPOS + STUNEG                                           BUDGET........7900
      STFPOS = STPPOS + STUPOS                                           BUDGET........8000
      STFNEG = STPNEG + STUNEG                                           BUDGET........8100
      STFTOT = STPTOT + STUTOT                                           BUDGET........8200
      QINTOT = QINPOS + QINNEG                                           BUDGET........8300
C                                                                        BUDGET........8400
      QPLPOS = 0D0                                                       BUDGET........8500
      QPLNEG = 0D0                                                       BUDGET........8600
      DO 200 IP=1,NPBC                                                   BUDGET........8700
      I=IABS(IPBC(IP))                                                   BUDGET........8800
      TERM = GNUP1(IP)*(PBC(IP)-PVEC(I))                                 BUDGET........8900
      QPLPOS = QPLPOS + MAX(0D0, TERM)                                   BUDGET........9000
      QPLNEG = QPLNEG + MIN(0D0, TERM)                                   BUDGET........9100
  200 CONTINUE                                                           BUDGET........9200
      QPLTOT = QPLPOS + QPLNEG                                           BUDGET........9300
      QFFPOS = QINPOS + QPLPOS                                           BUDGET........9400
      QFFNEG = QINNEG + QPLNEG                                           BUDGET........9500
      QFFTOT = QINTOT + QPLTOT                                           BUDGET........9600
C                                                                        BUDGET........9700
C.....OUTPUT FLUID MASS BUDGET                                           BUDGET........9800
      ACTFMB = 5D-1*(STFPOS - STFNEG + QFFPOS - QFFNEG)                  BUDGET........9900
      ERFMBA = STFTOT - QFFTOT                                           BUDGET.......10000
      WRITE(K3,300) IT,STPPOS,STPNEG,STPTOT,                             BUDGET.......10100
     1   ULABL(MN),STUPOS,STUNEG,STUTOT,STFPOS,STFNEG,STFTOT,            BUDGET.......10200
     2   QINPOS,QINNEG,QINTOT,QPLPOS,QPLNEG,QPLTOT,                      BUDGET.......10300
     3   QFFPOS,QFFNEG,QFFTOT,ACTFMB,ERFMBA                              BUDGET.......10400
  300 FORMAT(//11X,'F L U I D   M A S S   B U D G E T      AFTER TIME',  BUDGET.......10500
     1   ' STEP ',I8,',     IN (MASS/SECOND)'                            BUDGET.......10600
     2   //89X,'SUM OF',10X,'SUM OF',12X,'NET'/87X,'INCREASES(+)',4X,    BUDGET.......10700
     3   'DECREASES(-)',7X,'CHANGE'/84X,3(2X,14('='))                    BUDGET.......10800
     4   /13X,'RATE OF CHANGE IN TOTAL STORED FLUID DUE TO PRESSURE',    BUDGET.......10900
     5   ' CHANGE',12X,3(1X,1PE15.7)                                     BUDGET.......11000
     6   /13X,'RATE OF CHANGE IN TOTAL STORED FLUID DUE TO ',A13,        BUDGET.......11100
     7   ' CHANGE',7X,3(1X,1PE15.7)/84X,3(2X,14('-'))                    BUDGET.......11200
     8   /13X,'TOTAL RATE OF CHANGE IN STORED FLUID [ S+, S-, S ]',      BUDGET.......11300
     9   21X,3(1X,1PE15.7)                                               BUDGET.......11400
     T   //89X,'SUM OF',10X,'SUM OF',12X,'NET'/89X,'GAINS(+)',7X,        BUDGET.......11500
     1   'LOSSES(-)',7X,'GAIN/LOSS'/84X,3(2X,14('='))                    BUDGET.......11600
     2   /13X,'GAIN/LOSS OF FLUID THROUGH FLUID SOURCES AND SINKS',      BUDGET.......11700
     3   21X,3(1X,1PE15.7)                                               BUDGET.......11800
     4   /13X,'GAIN/LOSS OF FLUID THROUGH INFLOWS/OUTFLOWS AT'           BUDGET.......11900
     5   ' SPECIFIED P NODES',7X,3(1X,1PE15.7)/84X,3(2X,14('-'))         BUDGET.......12000
     6   /13X,'TOTAL RATE OF GAIN/LOSS OF FLUID THROUGH FLOWS',          BUDGET.......12100
     7   ' [ F+, F-, F ]',11X,3(1X,1PE15.7)                              BUDGET.......12200
     8   ///13X,'FLUID MASS BALANCE ACTIVITY',                           BUDGET.......12300
     9   ' [ A = ((S+) - (S-) + (F+) - (F-))/2 ]',14X,1PE15.7            BUDGET.......12400
     T   /13X,'ABSOLUTE FLUID MASS BALANCE ERROR [ S - F ]',36X,1PE15.7) BUDGET.......12500
      IF (ACTFMB.NE.0D0) THEN                                            BUDGET.......12600
         ERFMBR = 1D2*ERFMBA/ACTFMB                                      BUDGET.......12700
         WRITE(K3,301) ERFMBR                                            BUDGET.......12800
      ELSE                                                               BUDGET.......12900
         WRITE(K3,302)                                                   BUDGET.......13000
      END IF                                                             BUDGET.......13100
  301 FORMAT(13X,'RELATIVE FLUID MASS BALANCE ERROR',                    BUDGET.......13200
     1   ' [ 100*(S - F)/A ]',28X,1PE15.7,' (PERCENT)')                  BUDGET.......13300
  302 FORMAT(13X,'RELATIVE FLUID MASS BALANCE ERROR',                    BUDGET.......13400
     1   ' [ 100*(S - F)/A ]',28X,'  UNDEFINED')                         BUDGET.......13500
C                                                                        BUDGET.......13600
      GOTO 600
      IF(IBCT.EQ.4) GOTO 600                                             BUDGET.......13700
      NSOPI=NSOP-1                                                       BUDGET.......13800
      INEGCT=0                                                           BUDGET.......13900
      DO 500 IQP=1,NSOPI                                                 BUDGET.......14000
      I=IQSOP(IQP)                                                       BUDGET.......14100
      IF (IBCSOP(IQP).EQ.-1) THEN                                        BUDGET.......14200
         INEGCT = INEGCT + 1                                             BUDGET.......14300
         IF (INEGCT.EQ.1) WRITE(K3,350)                                  BUDGET.......14400
  350    FORMAT(///22X,'TIME-DEPENDENT FLUID SOURCES OR SINKS SET IN ',  BUDGET.......14500
     1      'SUBROUTINE BCTIME'//22X,' NODE',5X,'INFLOW(+)/OUTFLOW(-)'   BUDGET.......14600
     2      /37X,'  (MASS/SECOND)'//)                                    BUDGET.......14700
         WRITE(K3,450) -I,QIN(-I)                                        BUDGET.......14800
  450    FORMAT(18X,I9,10X,1PE15.7)                                      BUDGET.......14900
      END IF                                                             BUDGET.......15000
  500 CONTINUE                                                           BUDGET.......15100
C                                                                        BUDGET.......15200
C  600 IF(NPBC.EQ.0) GOTO 800                                             BUDGET.......15300
  600 GOTO 800
      WRITE(K3,650)                                                      BUDGET.......15400
  650 FORMAT(///22X,'FLUID SOURCES OR SINKS DUE TO SPECIFIED PRESSURES', BUDGET.......15500
     1   //22X,' NODE',5X,'INFLOW(+)/OUTFLOW(-)'/37X,'  (MASS/SECOND)'/) BUDGET.......15600
      DO 700 IP=1,NPBC                                                   BUDGET.......15700
      I=IABS(IPBC(IP))                                                   BUDGET.......15800
      WRITE(K3,450) I, GNUP1(IP)*(PBC(IP)-PVEC(I))                       BUDGET.......15900
  700 CONTINUE                                                           BUDGET.......16000
C                                                                        BUDGET.......16100
C.....CALCULATE COMPONENTS OF ENERGY OR SOLUTE MASS BUDGET               BUDGET.......16200
  800 IF(ML-1) 1000,5500,1000                                            BUDGET.......16300
 1000 CONTINUE                                                           BUDGET.......16400
      FLDPOS = 0D0                                                       BUDGET.......16500
      FLDNEG = 0D0                                                       BUDGET.......16600
      SLDPOS = 0D0                                                       BUDGET.......16700
      SLDNEG = 0D0                                                       BUDGET.......16800
      DNSPOS = 0D0                                                       BUDGET.......16900
      DNSNEG = 0D0                                                       BUDGET.......17000
      P1FPOS = 0D0                                                       BUDGET.......17100
      P1FNEG = 0D0                                                       BUDGET.......17200
      P1SPOS = 0D0                                                       BUDGET.......17300
      P1SNEG = 0D0                                                       BUDGET.......17400
      P0FPOS = 0D0                                                       BUDGET.......17500
      P0FNEG = 0D0                                                       BUDGET.......17600
      P0SPOS = 0D0                                                       BUDGET.......17700
      P0SNEG = 0D0                                                       BUDGET.......17800
      QQUPOS = 0D0                                                       BUDGET.......17900
      QQUNEG = 0D0                                                       BUDGET.......18000
      QIUPOS = 0D0                                                       BUDGET.......18100
      QIUNEG = 0D0                                                       BUDGET.......18200
C.....SET ADSORPTION PARAMETERS                                          BUDGET.......18300
      IF(ME.EQ.-1.AND.ADSMOD.NE.'NONE      ')                            BUDGET.......18400
     1   CALL ADSORB(CS1,CS2,CS3,SL,SR,UVEC)                             BUDGET.......18500
      DO 1300 I=1,NN                                                     BUDGET.......18600
      ESRV=POR(I)*SW(I)*RHO(I)*VOL(I)                                    BUDGET.......18700
      EPRSV=(1.D0-POR(I))*RHOS*VOL(I)                                    BUDGET.......18800
      DUDT=(1-ISSTRA)*(UVEC(I)-UM1(I))/DELTU                             BUDGET.......18900
      TERM = ESRV*CW*DUDT                                                BUDGET.......19000
      FLDPOS = FLDPOS + MAX(0D0, TERM)                                   BUDGET.......19100
      FLDNEG = FLDNEG + MIN(0D0, TERM)                                   BUDGET.......19200
      TERM = EPRSV*CS1(I)*DUDT                                           BUDGET.......19300
      SLDPOS = SLDPOS + MAX(0D0, TERM)                                   BUDGET.......19400
      SLDNEG = SLDNEG + MIN(0D0, TERM)                                   BUDGET.......19500
      TERM = CW*UVEC(I)*(1-ISSFLO/2)*VOL(I)*                             BUDGET.......19600
     1   (RHO(I)*(SW(I)*SOP(I)+POR(I)*DSWDP(I))*DPDTITR(I)               BUDGET.......19700
     2   +POR(I)*SW(I)*DRWDU*(UM1(I)-UM2(I))/DLTUM1)                     BUDGET.......19800
      DNSPOS = DNSPOS + MAX(0D0, TERM)                                   BUDGET.......19900
      DNSNEG = DNSNEG + MIN(0D0, TERM)                                   BUDGET.......20000
      TERM = ESRV*PRODF1*UVEC(I)                                         BUDGET.......20100
      P1FPOS = P1FPOS + MAX(0D0, TERM)                                   BUDGET.......20200
      P1FNEG = P1FNEG + MIN(0D0, TERM)                                   BUDGET.......20300
      TERM = EPRSV*PRODS1*(SL(I)*UVEC(I)+SR(I))                          BUDGET.......20400
      P1SPOS = P1SPOS + MAX(0D0, TERM)                                   BUDGET.......20500
      P1SNEG = P1SNEG + MIN(0D0, TERM)                                   BUDGET.......20600
      TERM = ESRV*PRODF0                                                 BUDGET.......20700
      P0FPOS = P0FPOS + MAX(0D0, TERM)                                   BUDGET.......20800
      P0FNEG = P0FNEG + MIN(0D0, TERM)                                   BUDGET.......20900
      TERM = EPRSV*PRODS0                                                BUDGET.......21000
      P0SPOS = P0SPOS + MAX(0D0, TERM)                                   BUDGET.......21100
      P0SNEG = P0SNEG + MIN(0D0, TERM)                                   BUDGET.......21200
      TERM = QUIN(I)                                                     BUDGET.......21300
      QQUPOS = QQUPOS + MAX(0D0, TERM)                                   BUDGET.......21400
      QQUNEG = QQUNEG + MIN(0D0, TERM)                                   BUDGET.......21500
C      IF (QINITR(I).LE.0D0) THEN                                         BUDGET.......21600
C         TERM = QINITR(I)*CW*UVEC(I)                                     BUDGET.......21700
C      ELSE                                                               BUDGET.......21800
         TERM = QINITR(I)*CW*UIN(I)                                      BUDGET.......21900
C      END IF                                                             BUDGET.......22000
      QIUPOS = QIUPOS + MAX(0D0, TERM)                                   BUDGET.......22100
      QIUNEG = QIUNEG + MIN(0D0, TERM)                                   BUDGET.......22200
 1300 CONTINUE                                                           BUDGET.......22300
      FLDTOT = FLDPOS + FLDNEG                                           BUDGET.......22400
      SLDTOT = SLDPOS + SLDNEG                                           BUDGET.......22500
      DNSTOT = DNSPOS + DNSNEG                                           BUDGET.......22600
      STSPOS = FLDPOS + SLDPOS + DNSPOS                                  BUDGET.......22700
      STSNEG = FLDNEG + SLDNEG + DNSNEG                                  BUDGET.......22800
      STSTOT = FLDTOT + SLDTOT + DNSTOT                                  BUDGET.......22900
      P1FTOT = P1FPOS + P1FNEG                                           BUDGET.......23000
      P1STOT = P1SPOS + P1SNEG                                           BUDGET.......23100
      P0FTOT = P0FPOS + P0FNEG                                           BUDGET.......23200
      P0STOT = P0SPOS + P0SNEG                                           BUDGET.......23300
      PRSPOS = P1FPOS + P1SPOS + P0FPOS + P0SPOS                         BUDGET.......23400
      PRSNEG = P1FNEG + P1SNEG + P0FNEG + P0SNEG                         BUDGET.......23500
      PRSTOT = P1FTOT + P1STOT + P0FTOT + P0STOT                         BUDGET.......23600
      QQUTOT = QQUPOS + QQUNEG                                           BUDGET.......23700
      QIUTOT = QIUPOS + QIUNEG                                           BUDGET.......23800
C                                                                        BUDGET.......23900
      QPUPOS = 0D0                                                       BUDGET.......24000
      QPUNEG = 0D0                                                       BUDGET.......24100
      DO 1500 IP=1,NPBC                                                  BUDGET.......24200
      IF (QPLITR(IP).LE.0D0) THEN                                        BUDGET.......24300
         I=IABS(IPBC(IP))                                                BUDGET.......24400
         TERM = QPLITR(IP)*CW*UVEC(I)                                    BUDGET.......24500
      ELSE                                                               BUDGET.......24600
         TERM = QPLITR(IP)*CW*UBC(IP)                                    BUDGET.......24700
      END IF                                                             BUDGET.......24800
      QPUPOS = QPUPOS + MAX(0D0, TERM)                                   BUDGET.......24900
      QPUNEG = QPUNEG + MIN(0D0, TERM)                                   BUDGET.......25000
 1500 CONTINUE                                                           BUDGET.......25100
      QPUTOT = QPUPOS + QPUNEG                                           BUDGET.......25200
C                                                                        BUDGET.......25300
      QULPOS = 0D0                                                       BUDGET.......25400
      QULNEG = 0D0                                                       BUDGET.......25500
      QULTOT = 0D0                                                       BUDGET.......25600
      IF(NUBC.EQ.0) GOTO 1520                                            BUDGET.......25700
      DO 1510 IU=1,NUBC                                                  BUDGET.......25800
      IUP=IU+NPBC                                                        BUDGET.......25900
      I=IABS(IUBC(IUP))                                                  BUDGET.......26000
      QPLITR(IUP)=GNUU1(IUP)*(UBC(IUP)-UVEC(I))                          BUDGET.......26100
      TERM = QPLITR(IUP)                                                 BUDGET.......26200
      QULPOS = QULPOS + MAX(0D0, TERM)                                   BUDGET.......26300
      QULNEG = QULNEG + MIN(0D0, TERM)                                   BUDGET.......26400
 1510 CONTINUE                                                           BUDGET.......26500
 1520 QULTOT = QULPOS + QULNEG                                           BUDGET.......26600
      QFSPOS = QIUPOS + QPUPOS + QQUPOS + QULPOS                         BUDGET.......26700
      QFSNEG = QIUNEG + QPUNEG + QQUNEG + QULNEG                         BUDGET.......26800
      QFSTOT = QIUTOT + QPUTOT + QQUTOT + QULTOT                         BUDGET.......26900
C                                                                        BUDGET.......27000
 1540 IF(ME) 1550,1550,1615                                              BUDGET.......27100
C                                                                        BUDGET.......27200
C.....OUTPUT SOLUTE MASS BUDGET                                          BUDGET.......27300
 1550 ACTSMB = 5D-1*(STSPOS - STSNEG + PRSPOS - PRSNEG                   BUDGET.......27400
     1   + QFSPOS - QFSNEG)                                              BUDGET.......27500
      ERSMBA = STSTOT - PRSTOT - QFSTOT                                  BUDGET.......27600
      WRITE(K3,1600) IT,FLDPOS,FLDNEG,FLDTOT,SLDPOS,SLDNEG,SLDTOT,       BUDGET.......27700
     1   DNSPOS,DNSNEG,DNSTOT,STSPOS,STSNEG,STSTOT,                      BUDGET.......27800
     2   P1FPOS,P1FNEG,P1FTOT,P1SPOS,P1SNEG,P1STOT,                      BUDGET.......27900
     3   P0FPOS,P0FNEG,P0FTOT,P0SPOS,P0SNEG,P0STOT,PRSPOS,PRSNEG,PRSTOT, BUDGET.......28000
     4   QIUPOS,QIUNEG,QIUTOT,QPUPOS,QPUNEG,QPUTOT,                      BUDGET.......28100
     5   QQUPOS,QQUNEG,QQUTOT,QULPOS,QULNEG,QULTOT,QFSPOS,QFSNEG,QFSTOT, BUDGET.......28200
     6   ACTSMB,ERSMBA                                                   BUDGET.......28300
 1600 FORMAT(//11X,'S O L U T E   B U D G E T      AFTER TIME STEP ',I8, BUDGET.......28400
     1   ',   IN (SOLUTE MASS/SECOND)'                                   BUDGET.......28500
     2   //89X,'SUM OF',10X,'SUM OF',12X,'NET'/87X,'INCREASES(+)',4X,    BUDGET.......28600
     3   'DECREASES(-)',7X,'CHANGE'/84X,3(2X,14('='))                    BUDGET.......28700
     4   /13X,'RATE OF CHANGE IN SOLUTE DUE TO CONCENTRATION CHANGE',    BUDGET.......28800
     5   19X,3(1X,1PE15.7)                                               BUDGET.......28900
     6   /13X,'RATE OF CHANGE OF ADSORBATE',44X,3(1X,1PE15.7)            BUDGET.......29000
     7   /13X,'RATE OF CHANGE IN SOLUTE DUE TO CHANGE IN MASS OF FLUID', BUDGET.......29100
     8   16X,3(1X,1PE15.7)/84X,3(2X,14('-'))                             BUDGET.......29200
     9   /13X,'TOTAL RATE OF CHANGE OF SOLUTE [ S+, S-, S ]',            BUDGET.......29300
     T   27X,3(1X,1PE15.7)                                               BUDGET.......29400
     1   //89X,'SUM OF',10X,'SUM OF',12X,'NET'/87X,'PRODUCTION(+)',5X,   BUDGET.......29500
     2   'DECAY(-)',7X,'PROD./DECAY'/84X,3(2X,14('='))                   BUDGET.......29600
     3   /13X,'FIRST-ORDER PRODUCTION/DECAY OF SOLUTE',33X,3(1X,1PE15.7) BUDGET.......29700
     4   /13X,'FIRST-ORDER PRODUCTION/DECAY OF ADSORBATE',               BUDGET.......29800
     5   30X,3(1X,1PE15.7)                                               BUDGET.......29900
     6   /13X,'ZERO-ORDER PRODUCTION/DECAY OF SOLUTE',34X,3(1X,1PE15.7)  BUDGET.......30000
     7   /13X,'ZERO-ORDER PRODUCTION/DECAY OF ADSORBATE',                BUDGET.......30100
     8   31X,3(1X,1PE15.7)/84X,3(2X,14('-'))                             BUDGET.......30200
     9   /13X,'TOTAL RATE OF PRODUCTION/DECAY OF SOLUTE AND ADSORBATE',  BUDGET.......30300
     T   ' [ P+, P-, P ]',3X,3(1X,1PE15.7)                               BUDGET.......30400
     1   //89X,'SUM OF',10X,'SUM OF',12X,'NET'/89X,'GAINS(+)',7X,        BUDGET.......30500
     2   'LOSSES(-)',7X,'GAIN/LOSS'/84X,3(2X,14('='))                    BUDGET.......30600
     3   /13X,'GAIN/LOSS OF SOLUTE THROUGH FLUID SOURCES AND SINKS',     BUDGET.......30700
     4   20X,3(1X,1PE15.7)                                               BUDGET.......30800
     5   /13X,'GAIN/LOSS OF SOLUTE THROUGH INFLOWS/OUTFLOWS AT'          BUDGET.......30900
     6   ' SPECIFIED P NODES',6X,3(1X,1PE15.7)                           BUDGET.......31000
     7   /13X,'GAIN/LOSS OF SOLUTE THROUGH SOLUTE SOURCES AND SINKS',    BUDGET.......31100
     8   19X,3(1X,1PE15.7)                                               BUDGET.......31200
     9   /13X,'GAIN/LOSS OF SOLUTE AT SPECIFIED CONCENTRATION NODES',    BUDGET.......31300
     T   19X,3(1X,1PE15.7)/84X,3(2X,14('-'))                             BUDGET.......31400
     1   /13X,'TOTAL RATE OF GAIN/LOSS OF SOLUTE',38X,3(1X,1PE15.7)      BUDGET.......31500
     2   /16X,' THROUGH FLOWS & SOURCES/SINKS [ F+, F-, F ]'             BUDGET.......31600
     3   ///13X,'SOLUTE MASS BAL. ACTIVITY [ A = ((S+) - (S-)',          BUDGET.......31700
     4   ' + (P+) - (P-) + (F+) - (F-))/2 ]',2X,1PE15.7                  BUDGET.......31800
     5   /13X,'ABSOLUTE SOLUTE MASS BALANCE ERROR [ S - P - F ]',        BUDGET.......31900
     6   31X,1PE15.7)                                                    BUDGET.......32000
      IF (ACTSMB.NE.0D0) THEN                                            BUDGET.......32100
         ERSMBR = 1D2*ERSMBA/ACTSMB                                      BUDGET.......32200
         WRITE(K3,1601) ERSMBR                                           BUDGET.......32300
      ELSE                                                               BUDGET.......32400
         WRITE(K3,1602)                                                  BUDGET.......32500
      END IF                                                             BUDGET.......32600
 1601 FORMAT(13X,'RELATIVE SOLUTE MASS BALANCE ERROR',                   BUDGET.......32700
     1   ' [ 100*(S - P - F)/A ]',23X,1PE15.7,' (PERCENT)')              BUDGET.......32800
 1602 FORMAT(13X,'RELATIVE SOLUTE MASS BALANCE ERROR',                   BUDGET.......32900
     1   ' [ 100*(S - P - F)/A ]',23X,'  UNDEFINED')                     BUDGET.......33000
      GOTO 1645                                                          BUDGET.......33100
C                                                                        BUDGET.......33200
C.....OUTPUT ENERGY BUDGET                                               BUDGET.......33300
 1615 ACTSMB = 5D-1*(STSPOS - STSNEG + PRSPOS - PRSNEG                   BUDGET.......33400
     1   + QFSPOS - QFSNEG)                                              BUDGET.......33500
      ERSMBA = STSTOT - PRSTOT - QFSTOT                                  BUDGET.......33600
      WRITE(K3,1635) IT,FLDPOS,FLDNEG,FLDTOT,SLDPOS,SLDNEG,SLDTOT,       BUDGET.......33700
     1   DNSPOS,DNSNEG,DNSTOT,STSPOS,STSNEG,STSTOT,                      BUDGET.......33800
     2   P0FPOS,P0FNEG,P0FTOT,P0SPOS,P0SNEG,P0STOT,PRSPOS,PRSNEG,PRSTOT, BUDGET.......33900
     3   QIUPOS,QIUNEG,QIUTOT,QPUPOS,QPUNEG,QPUTOT,                      BUDGET.......34000
     4   QQUPOS,QQUNEG,QQUTOT,QULPOS,QULNEG,QULTOT,QFSPOS,QFSNEG,QFSTOT, BUDGET.......34100
     5   ACTSMB,ERSMBA                                                   BUDGET.......34200
 1635 FORMAT(//11X,'E N E R G Y   B U D G E T      AFTER TIME STEP ',I8, BUDGET.......34300
     1   ',   IN (ENERGY/SECOND)'                                        BUDGET.......34400
     2   //89X,'SUM OF',10X,'SUM OF',12X,'NET'/87X,'INCREASES(+)',4X,    BUDGET.......34500
     3   'DECREASES(-)',7X,'CHANGE'/84X,3(2X,14('='))                    BUDGET.......34600
     4   /13X,'RATE OF CHANGE OF ENERGY IN FLUID DUE TO TEMPERATURE',    BUDGET.......34700
     5   ' CHANGE',12X,3(1X,1PE15.7)                                     BUDGET.......34800
     6   /13X,'RATE OF CHANGE OF ENERGY IN SOLID GRAINS',                BUDGET.......34900
     7   31X,3(1X,1PE15.7)                                               BUDGET.......35000
     8   /13X,'RATE OF CHANGE OF ENERGY DUE TO CHANGE IN MASS OF FLUID', BUDGET.......35100
     9   16X,3(1X,1PE15.7)/84X,3(2X,14('-'))                             BUDGET.......35200
     T   /13X,'TOTAL RATE OF CHANGE OF ENERGY [ S+, S-, S ]',            BUDGET.......35300
     1   27X,3(1X,1PE15.7)                                               BUDGET.......35400
     2   //89X,'SUM OF',10X,'SUM OF',12X,'NET'/87X,'PRODUCTION(+)',5X,   BUDGET.......35500
     3   'DECAY(-)',7X,'PROD./DECAY'/84X,3(2X,14('='))                   BUDGET.......35600
     4   /13X,'ZERO-ORDER PRODUCTION/DECAY OF ENERGY IN FLUID',          BUDGET.......35700
     5   25X,3(1X,1PE15.7)                                               BUDGET.......35800
     6   /13X,'ZERO-ORDER PRODUCTION/DECAY OF ENERGY IN SOLID GRAINS',   BUDGET.......35900
     7   18X,3(1X,1PE15.7)/84X,3(2X,14('-'))                             BUDGET.......36000
     8   /13X,'TOTAL RATE OF PRODUCTION/DECAY OF ENERGY',                BUDGET.......36100
     9   ' [ P+, P-, P ]',17X,3(1X,1PE15.7)                              BUDGET.......36200
     T   //89X,'SUM OF',10X,'SUM OF',12X,'NET'/89X,'GAINS(+)',7X,        BUDGET.......36300
     1   'LOSSES(-)',7X,'GAIN/LOSS'/84X,3(2X,14('='))                    BUDGET.......36400
     2   /13X,'GAIN/LOSS OF ENERGY THROUGH FLUID SOURCES AND SINKS',     BUDGET.......36500
     3   20X,3(1X,1PE15.7)                                               BUDGET.......36600
     4   /13X,'GAIN/LOSS OF ENERGY THROUGH INFLOWS/OUTFLOWS AT'          BUDGET.......36700
     5   ' SPECIFIED P NODES',6X,3(1X,1PE15.7)                           BUDGET.......36800
     6   /13X,'GAIN/LOSS OF ENERGY THROUGH ENERGY SOURCES AND SINKS',    BUDGET.......36900
     7   19X,3(1X,1PE15.7)                                               BUDGET.......37000
     8   /13X,'GAIN/LOSS OF ENERGY AT SPECIFIED TEMPERATURE NODES',      BUDGET.......37100
     9   21X,3(1X,1PE15.7)/84X,3(2X,14('-'))                             BUDGET.......37200
     T   /13X,'TOTAL RATE OF GAIN/LOSS OF ENERGY',38X,3(1X,1PE15.7)      BUDGET.......37300
     1   /16X,' THROUGH FLOWS & SOURCES/SINKS [ F+, F-, F ]'             BUDGET.......37400
     2   ///13X,'ENERGY BALANCE ACTIVITY [ A = ((S+) - (S-)',            BUDGET.......37500
     3   ' + (P+) - (P-) + (F+) - (F-))/2 ]',4X,1PE15.7                  BUDGET.......37600
     4   /13X,'ABSOLUTE ENERGY BALANCE ERROR [ S - P - F ]',             BUDGET.......37700
     5   36X,1PE15.7)                                                    BUDGET.......37800
      IF (ACTSMB.NE.0D0) THEN                                            BUDGET.......37900
         ERSMBR = 1D2*ERSMBA/ACTSMB                                      BUDGET.......38000
         WRITE(K3,1641) ERSMBR                                           BUDGET.......38100
      ELSE                                                               BUDGET.......38200
         WRITE(K3,1642)                                                  BUDGET.......38300
      END IF                                                             BUDGET.......38400
 1641 FORMAT(13X,'RELATIVE ENERGY BALANCE ERROR',                        BUDGET.......38500
     1   ' [ 100*(S - P - F)/A ]',28X,1PE15.7,' (PERCENT)')              BUDGET.......38600
 1642 FORMAT(13X,'RELATIVE ENERGY BALANCE ERROR',                        BUDGET.......38700
     1   ' [ 100*(S - P - F)/A ]',28X,'  UNDEFINED')                     BUDGET.......38800
C                                                                        BUDGET.......38900
 1645 IF ((IT.EQ.1).AND.(ITER.EQ.1).AND.(ISSTRA.NE.1)) WRITE(K3,1646)    BUDGET.......39000
 1646 FORMAT(/13X,'******** NOTE: ON THE FIRST ITERATION OF THE ',       BUDGET.......39100
     1   'FIRST TIME STEP, A LARGE RELATIVE ERROR IN THE  ********'      BUDGET.......39200
     2   /13X,'******** SOLUTE MASS OR ENERGY BUDGET DOES NOT ',         BUDGET.......39300
     3   'NECESSARILY INDICATE AN INACCURATE TRANSPORT  ********'        BUDGET.......39400
     4   /13X,'******** SOLUTION. THE BUDGET CALCULATION WILL ',         BUDGET.......39500
     5   'NOT YIELD A MEANINGFUL RESULT UNLESS THE      ********'        BUDGET.......39600
     6   /13X,'******** INITIAL CONDITIONS REPRESENT MUTUALLY ',         BUDGET.......39700
     7   'CONSISTENT SOLUTIONS FOR FLOW AND TRANSPORT   ********'        BUDGET.......39800
     8   /13X,'******** FROM A PREVIOUS SUTRA SIMULATION THAT ',         BUDGET.......39900
     9   'ARE ALSO CONSISTENT WITH THE PRESENT SOURCES  ********'        BUDGET.......40000
     T   /13X,'******** AND BOUNDARY CONDITIONS.',60X,'********')        BUDGET.......40100
C                                                                        BUDGET.......40200
      NSOPI=NSOP-1                                                       BUDGET.......40300
      GOTO 2000       !DATASET 17 IN BCTIME
      IF(NSOPI.EQ.0) GOTO 2000                                           BUDGET.......40400
      IF(ME) 1649,1649,1659                                              BUDGET.......40500
 1649 WRITE(K3,1650)                                                     BUDGET.......40600
 1650 FORMAT(///22X,'SOLUTE SOURCES OR SINKS AT FLUID SOURCES AND ',     BUDGET.......40700
     1   'SINKS'//22X,' NODE',8X,'SOURCE(+)/SINK(-)'/32X,                BUDGET.......40800
     2   '(SOLUTE MASS/SECOND)'/)                                        BUDGET.......40900
      GOTO 1680                                                          BUDGET.......41000
 1659 WRITE(K3,1660)                                                     BUDGET.......41100
 1660 FORMAT(///22X,'ENERGY SOURCES OR SINKS AT FLUID SOURCES AND ',     BUDGET.......41200
     1   'SINKS'//22X,' NODE',8X,'SOURCE(+)/SINK(-)'/37X,                BUDGET.......41300
     2   '(ENERGY/SECOND)'/)                                             BUDGET.......41400
 1680 DO 1900 IQP=1,NSOPI                                                BUDGET.......41500
      I=IABS(IQSOP(IQP))                                                 BUDGET.......41600
C      IF(QINITR(I)) 1700,1700,1750                                       BUDGET.......41700
C 1700 QU=QINITR(I)*CW*UVEC(I)                                            BUDGET.......41800
C      GOTO 1800                                                          BUDGET.......41900
 1750 QU=QINITR(I)*CW*UIN(I)                                             BUDGET.......42000
 1800 WRITE(K3,450) I,QU                                                 BUDGET.......42100
 1900 CONTINUE                                                           BUDGET.......42200
C                                                                        BUDGET.......42300
 2000 GOTO 4500      ! DATASET 19 IN BCTIME
C 2000 IF(NPBC.EQ.0) GOTO 4500                                            BUDGET.......42400
      IF(ME) 2090,2090,2150                                              BUDGET.......42500
 2090 WRITE(K3,2100)                                                     BUDGET.......42600
 2100 FORMAT(///22X,'SOLUTE SOURCES OR SINKS DUE TO FLUID INFLOWS OR ',  BUDGET.......42700
     1   'OUTFLOWS AT POINTS OF SPECIFIED PRESSURE'//22X,' NODE',8X,     BUDGET.......42800
     2   'SOURCE(+)/SINK(-)'/32X,'(SOLUTE MASS/SECOND)'/)                BUDGET.......42900
      GOTO 2190                                                          BUDGET.......43000
 2150 WRITE(K3,2160)                                                     BUDGET.......43100
 2160 FORMAT(///22X,'ENERGY SOURCES OR SINKS DUE TO FLUID INFLOWS OR ',  BUDGET.......43200
     1   'OUTFLOWS AT POINTS OF SPECIFIED PRESSURE'//22X,' NODE',8X,     BUDGET.......43300
     2   'SOURCE(+)/SINK(-)'/37X,'(ENERGY/SECOND)'/)                     BUDGET.......43400
 2190 DO 2400 IP=1,NPBC                                                  BUDGET.......43500
      I=IABS(IPBC(IP))                                                   BUDGET.......43600
      IF(QPLITR(IP)) 2200,2200,2250                                      BUDGET.......43700
 2200 QPU=QPLITR(IP)*CW*UVEC(I)                                          BUDGET.......43800
      GOTO 2300                                                          BUDGET.......43900
 2250 QPU=QPLITR(IP)*CW*UBC(IP)                                          BUDGET.......44000
 2300 WRITE(K3,450) I,QPU                                                BUDGET.......44100
 2400 CONTINUE                                                           BUDGET.......44200
C                                                                        BUDGET.......44300
C      IF(IBCT.EQ.4) GOTO 4500                                            BUDGET.......44400
      GOTO 4500        !DATASET 18 IN BCTIME
      NSOUI=NSOU-1                                                       BUDGET.......44500
      INEGCT=0                                                           BUDGET.......44600
      DO 3500 IQU=1,NSOUI                                                BUDGET.......44700
      I=IQSOU(IQU)                                                       BUDGET.......44800
      IF (IBCSOU(IQU).EQ.-1) THEN                                        BUDGET.......44900
         INEGCT = INEGCT + 1                                             BUDGET.......45000
         IF (INEGCT.EQ.1) THEN                                           BUDGET.......45100
            IF (ME.EQ.-1) THEN                                           BUDGET.......45200
               WRITE(K3,3455)                                            BUDGET.......45300
 3455          FORMAT(///22X,'TIME-DEPENDENT SOLUTE SOURCES OR SINKS ',  BUDGET.......45400
     1            'SET IN SUBROUTINE BCTIME'//22X,' NODE',10X,           BUDGET.......45500
     2            'GAIN(+)/LOSS(-)'/30X,'  (SOLUTE MASS/SECOND)'//)      BUDGET.......45600
            ELSE                                                         BUDGET.......45700
               WRITE(K3,3456)                                            BUDGET.......45800
 3456          FORMAT(///22X,'TIME-DEPENDENT ENERGY SOURCES OR SINKS ',  BUDGET.......45900
     1            'SET IN SUBROUTINE BCTIME'//22X,' NODE',10X,           BUDGET.......46000
     2            'GAIN(+)/LOSS(-)'/30X,'  (ENERGY/SECOND)'//)           BUDGET.......46100
            END IF                                                       BUDGET.......46200
         END IF                                                          BUDGET.......46300
         WRITE(K3,3490) -I,QUIN(-I)                                      BUDGET.......46400
 3490    FORMAT(22X,I9,10X,1PE15.7)                                      BUDGET.......46500
      END IF                                                             BUDGET.......46600
 3500 CONTINUE                                                           BUDGET.......46700
C                                                                        BUDGET.......46800
 4500 IF(NUBC.EQ.0) GOTO 5500                                            BUDGET.......46900
      IF(ME) 4600,4600,4655                                              BUDGET.......47000
 4600 WRITE(K3,4650)                                                     BUDGET.......47100
 4650 FORMAT(///22X,'SOLUTE SOURCES OR SINKS DUE TO SPECIFIED ',         BUDGET.......47200
     1   'CONCENTRATIONS'//22X,' NODE',10X,'GAIN(+)/LOSS(-)'/30X,        BUDGET.......47300
     2   '  (SOLUTE MASS/SECOND)'/)                                      BUDGET.......47400
      GOTO 4690                                                          BUDGET.......47500
 4655 WRITE(K3,4660)                                                     BUDGET.......47600
 4660 FORMAT(///22X,'ENERGY SOURCES OR SINKS DUE TO SPECIFIED ',         BUDGET.......47700
     1   'TEMPERATURES'//22X,' NODE',10X,'GAIN(+)/LOSS(-)'/35X,          BUDGET.......47800
     2   '  (ENERGY/SECOND)'/)                                           BUDGET.......47900
 4690 CONTINUE                                                           BUDGET.......48000
      DO 4700 IU=1,NUBC                                                  BUDGET.......48100
      IUP=IU+NPBC                                                        BUDGET.......48200
      I=IABS(IUBC(IUP))                                                  BUDGET.......48300
      WRITE(K3,450) I,QPLITR(IUP)                                        BUDGET.......48400
 4700 CONTINUE                                                           BUDGET.......48500
C                                                                        BUDGET.......48600
C                                                                        BUDGET.......48700
 5500 CONTINUE                                                           BUDGET.......48800
C                                                                        BUDGET.......48900
      RETURN                                                             BUDGET.......49000
      END                                                                BUDGET.......49100
C                                                                        BUDGET.......49200
C     SUBROUTINE        C  O  N  N  E  C           SUTRA VERSION 2.2     CONNEC.........100
C                                                                        CONNEC.........200
C *** PURPOSE :                                                          CONNEC.........300
C ***  TO READ, ORGANIZE, AND CHECK DATA ON NODE INCIDENCES.             CONNEC.........400
C                                                                        CONNEC.........500
      SUBROUTINE CONNEC(IN)                                              CONNEC.........600
      USE EXPINT                                                         CONNEC.........700
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                CONNEC.........800
      CHARACTER INTFIL*1000                                              CONNEC.........900
      CHARACTER CDUM10*10                                                CONNEC........1000
      CHARACTER*80 ERRCOD,CHERR(10),UNAME,FNAME(0:13)                    CONNEC........1100
      DIMENSION IN(NIN)                                                  CONNEC........1200
      DIMENSION IIN(8)                                                   CONNEC........1300
      DIMENSION INERR(10),RLERR(10)                                      CONNEC........1400
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              CONNEC........1500
     1   NSOP,NSOU,NBCN,NCIDB                                            CONNEC........1600
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        CONNEC........1700
      COMMON /FNAMES/ UNAME,FNAME                                        CONNEC........1800
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 CONNEC........1900
     1   K10,K11,K12,K13                                                 CONNEC........2000
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                CONNEC........2100
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            CONNEC........2200
C                                                                        CONNEC........2300
      IPIN=0                                                             CONNEC........2400
      IF(KINCID.EQ.0) WRITE(K3,1)                                        CONNEC........2500
    1 FORMAT('1'////11X,'M E S H   C O N N E C T I O N   D A T A'//      CONNEC........2600
     1   16X,'PRINTOUT OF NODAL INCIDENCES CANCELLED.')                  CONNEC........2700
      IF(KINCID.EQ.+1) WRITE(K3,2)                                       CONNEC........2800
    2 FORMAT('1'////11X,'M E S H   C O N N E C T I O N   D A T A',       CONNEC........2900
     1   ///11X,'**** NODAL INCIDENCES ****'///)                         CONNEC........3000
C                                                                        CONNEC........3100
C.....INPUT DATASET 22 AND CHECK FOR ERRORS                              CONNEC........3200
      ERRCOD = 'REA-INP-22'                                              CONNEC........3300
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 CONNEC........3400
      READ(INTFIL,*,IOSTAT=INERR(1)) CDUM10                              CONNEC........3500
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        CONNEC........3600
      IF (CDUM10.NE.'INCIDENCE ') THEN                                   CONNEC........3700
         ERRCOD = 'INP-22-1'                                             CONNEC........3800
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        CONNEC........3900
      END IF                                                             CONNEC........4000
      DO 1000 L=1,NE                                                     CONNEC........4100
      ERRCOD = 'REA-INP-22'                                              CONNEC........4200
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 CONNEC........4300
      READ(INTFIL,*,IOSTAT=INERR(1)) LL,(IIN(II),II=1,N48)               CONNEC........4400
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        CONNEC........4500
C.....PREPARE NODE INCIDENCE LIST FOR MESH, IN.                          CONNEC........4600
      DO 5 II=1,N48                                                      CONNEC........4700
      III=II+(L-1)*N48                                                   CONNEC........4800
    5 IN(III)=IIN(II)                                                    CONNEC........4900
      IF(IABS(LL).EQ.L) GOTO 500                                         CONNEC........5000
      ERRCOD = 'INP-22-2'                                                CONNEC........5100
      INERR(1) = LL                                                      CONNEC........5200
      CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                           CONNEC........5300
C                                                                        CONNEC........5400
C                                                                        CONNEC........5500
  500 M1=(L-1)*N48+1                                                     CONNEC........5600
      M8=M1+N48-1                                                        CONNEC........5700
      IF(KINCID.EQ.0) GOTO 1000                                          CONNEC........5800
      WRITE(K3,650) L,(IN(M),M=M1,M8)                                    CONNEC........5900
  650 FORMAT(11X,'ELEMENT',I9,5X,' NODES AT : ',6X,'CORNERS ',           CONNEC........6000
     1   5('*'),8I9,1X,5('*'))                                           CONNEC........6100
C                                                                        CONNEC........6200
 1000 CONTINUE                                                           CONNEC........6300
C                                                                        CONNEC........6400
C                                                                        CONNEC........6500
 5000 RETURN                                                             CONNEC........6600
      END                                                                CONNEC........6700
C                                                                        CONNEC........6800
C     FUNCTION          C  U  T  S  M  L           SUTRA VERSION 2.2     CUTSML.........100
C                                                                        CUTSML.........200
C *** PURPOSE :                                                          CUTSML.........300
C ***  TO RETURN ARGUMENT DPNUM IF ITS MAGNITUDE IS GREATER THAN OR      CUTSML.........400
C ***  EQUAL TO 1.D-99, AND ZERO OTHERWISE.                              CUTSML.........500
C                                                                        CUTSML.........600
      DOUBLE PRECISION FUNCTION CUTSML(DPNUM)                            CUTSML.........700
      IMPLICIT DOUBLE PRECISION (A-H, O-Z)                               CUTSML.........800
C                                                                        CUTSML.........900
C.....RETURN DPNUM IF ITS ABSOLUTE VALUE IS >= 1.D-99, OTHERWISE         CUTSML........1000
C        RETURN ZERO                                                     CUTSML........1100
      IF (DABS(DPNUM).LT.1.D-99) THEN                                    CUTSML........1200
         CUTSML = 0D0                                                    CUTSML........1300
      ELSE                                                               CUTSML........1400
         CUTSML = DPNUM                                                  CUTSML........1500
      END IF                                                             CUTSML........1600
C                                                                        CUTSML........1700
      RETURN                                                             CUTSML........1800
      END                                                                CUTSML........1900
C                                                                        CUTSML........2000
C     SUBROUTINE        D  I  M  W  R  K           SUTRA VERSION 2.2     DIMWRK.........100
C                                                                        DIMWRK.........200
C *** PURPOSE :                                                          DIMWRK.........300
C ***  TO RETURN DIMENSIONS FOR THE SOLVER WORK ARRAYS, WHICH DEPEND ON  DIMWRK.........400
C ***  THE PARTICULAR SOLVER CHOSEN.                                     DIMWRK.........500
C                                                                        DIMWRK.........600
      SUBROUTINE DIMWRK(KSOLVR, NSAVE, NN, NELT, NWI, NWF)               DIMWRK.........700
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                DIMWRK.........800
C                                                                        DIMWRK.........900
C.....COMPUTE SOLVER WORK ARRAY DIMENSIONS                               DIMWRK........1000
      IF (KSOLVR.EQ.1) THEN                                              DIMWRK........1100
         NL = (NELT + NN)/2                                              DIMWRK........1200
         NWI = 11 + 2*NL                                                 DIMWRK........1300
         NWF = NL + 5*NN + 1                                             DIMWRK........1400
      ELSE IF (KSOLVR.EQ.2) THEN                                         DIMWRK........1500
         NWI = 31 + 2*NELT                                               DIMWRK........1600
         NWF = 2 + NN*(NSAVE + 7) + NSAVE*(NSAVE + 3) + (NELT - NN)      DIMWRK........1700
      ELSE IF (KSOLVR.EQ.3) THEN                                         DIMWRK........1800
         NWI = 11 + 2*NELT                                               DIMWRK........1900
         NWF = 1 + 3*NN*(NSAVE + 1) + 7*NN + NSAVE + (NELT - NN)         DIMWRK........2000
      END IF                                                             DIMWRK........2100
C                                                                        DIMWRK........2200
      RETURN                                                             DIMWRK........2300
      END                                                                DIMWRK........2400
C                                                                        DIMWRK........2500
C     SUBROUTINE        D  I  S  P  R  3           SUTRA VERSION 2.2     DISPR3.........100
C                                                                        DISPR3.........200
C *** PURPOSE :                                                          DISPR3.........300
C ***  TO COMPUTE THE COMPONENTS OF THE 3D DISPERSION TENSOR IN          DISPR3.........400
C ***  X,Y,Z-COORDINATES USING AN AD HOC, 3D ANISOTROPIC DISPERSION      DISPR3.........500
C ***  MODEL.                                                            DISPR3.........600
C                                                                        DISPR3.........700
      SUBROUTINE DISPR3(VX,VY,VZ,VMAG,ANG1,ANG2,ANG3,ALMAX,ALMID,ALMIN,  DISPR3.........800
     1   ATMAX,ATMID,ATMIN,DXX,DXY,DXZ,DYX,DYY,DYZ,DZX,DZY,DZZ)          DISPR3.........900
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                DISPR3........1000
      LOGICAL LISO,TISO                                                  DISPR3........1100
      DIMENSION AL(3),AT(3),VN(3),UN(3),WN(3)                            DISPR3........1200
      DIMENSION J(3)                                                     DISPR3........1300
C                                                                        DISPR3........1400
C.....HANDLE CASE OF ZERO VELOCITY.  (THIS CASE IS ALREADY HANDLED       DISPR3........1500
C        BY SUBROUTINE ELEMN3.  THE BLOCK IF STATEMENT BELOW CAN BE      DISPR3........1600
C        UNCOMMENTED IF NEEDED IN THE FUTURE.)                           DISPR3........1700
C     IF (VMAG.EQ.0D0) THEN                                              DISPR3........1800
C        DXX = 0D0                                                       DISPR3........1900
C        DXY = 0D0                                                       DISPR3........2000
C        DXZ = 0D0                                                       DISPR3........2100
C        DYX = 0D0                                                       DISPR3........2200
C        DYY = 0D0                                                       DISPR3........2300
C        DYZ = 0D0                                                       DISPR3........2400
C        DZX = 0D0                                                       DISPR3........2500
C        DZY = 0D0                                                       DISPR3........2600
C        DZZ = 0D0                                                       DISPR3........2700
C        RETURN                                                          DISPR3........2800
C     END IF                                                             DISPR3........2900
C                                                                        DISPR3........3000
C.....SET TOLERANCES USED TO DETERMINE WHETHER CERTAIN DEGENERATE        DISPR3........3100
C        CONDITIONS ARE TRUE:                                            DISPR3........3200
C        TOLISO -- IS DISPERSION ESSENTIALLY ISOTROPIC?                  DISPR3........3300
C        TOLVRT -- IS FLOW ESSENTIALLY VERTICAL?                         DISPR3........3400
C        TOLCIR -- IS SLICING ELLIPSE ESSENTIALLY A CIRCLE?              DISPR3........3500
      TOLISO = 1D-7                                                      DISPR3........3600
      TOLVRT = 1D-7                                                      DISPR3........3700
      TOLCIR = 9.999999D-1                                               DISPR3........3800
C                                                                        DISPR3........3900
C.....NORMALIZE THE VELOCITY VECTOR.                                     DISPR3........4000
      VNX = VX/VMAG                                                      DISPR3........4100
      VNY = VY/VMAG                                                      DISPR3........4200
      VNZ = VZ/VMAG                                                      DISPR3........4300
C                                                                        DISPR3........4400
C.....DETERMINE WHETHER LONGITUDINAL DISPERSION IS ESSENTIALLY           DISPR3........4500
C        ISOTROPIC.                                                      DISPR3........4600
      AL(1) = ALMAX                                                      DISPR3........4700
      AL(2) = ALMID                                                      DISPR3........4800
      AL(3) = ALMIN                                                      DISPR3........4900
      ALMXVL = MAXVAL(AL)                                                DISPR3........5000
      ALMNVL = MINVAL(AL)                                                DISPR3........5100
      IF (ALMXVL.EQ.0D0) THEN                                            DISPR3........5200
         LISO = .TRUE.                                                   DISPR3........5300
      ELSE                                                               DISPR3........5400
         LISO = ((ALMXVL - ALMNVL)/ALMXVL.LT.TOLISO)                     DISPR3........5500
      END IF                                                             DISPR3........5600
C                                                                        DISPR3........5700
C.....COMPUTE THE LONGITUDINAL DISPERSION COEFFICIENT.                   DISPR3........5800
      IF (LISO) THEN                                                     DISPR3........5900
C........ISOTROPIC CASE.                                                 DISPR3........6000
         DL = ALMAX*VMAG                                                 DISPR3........6100
      ELSE                                                               DISPR3........6200
C........ANISOTROPIC CASE.                                               DISPR3........6300
C........ROTATE V TO "MAX-MID-MIN" COORDINATES.                          DISPR3........6400
         CALL ROTMAT(ANG1,ANG2,ANG3,G11,G12,G13,G21,G22,G23,             DISPR3........6500
     1      G31,G32,G33)                                                 DISPR3........6600
         CALL ROTATE(G11,G21,G31,G12,G22,G32,G13,G23,G33,                DISPR3........6700
     1      VNX,VNY,VNZ,VNXX,VNYY,VNZZ)                                  DISPR3........6800
C........EVALUATE DL FROM THE LONGITUDINAL DISPERSIVITY ELLIPSOID.       DISPR3........6900
         DL = VMAG/(VNXX*VNXX/ALMAX+VNYY*VNYY/ALMID+VNZZ*VNZZ/ALMIN)     DISPR3........7000
      END IF                                                             DISPR3........7100
C                                                                        DISPR3........7200
C.....DETERMINE WHETHER TRANSVERSE DISPERSION IS ESSENTIALLY             DISPR3........7300
C        ISOTROPIC.                                                      DISPR3........7400
      AT(1) = ATMAX                                                      DISPR3........7500
      AT(2) = ATMID                                                      DISPR3........7600
      AT(3) = ATMIN                                                      DISPR3........7700
      ATMXVL = MAXVAL(AT)                                                DISPR3........7800
      ATMNVL = MINVAL(AT)                                                DISPR3........7900
      IF (ATMXVL.EQ.0D0) THEN                                            DISPR3........8000
         TISO = .TRUE.                                                   DISPR3........8100
      ELSE                                                               DISPR3........8200
         TISO = ((ATMXVL - ATMNVL)/ATMXVL.LT.TOLISO)                     DISPR3........8300
      END IF                                                             DISPR3........8400
C                                                                        DISPR3........8500
C.....COMPUTE THE TRANSVERSE DISPERSION DIRECTIONS AND COEFFICIENTS.     DISPR3........8600
      IF (TISO) THEN                                                     DISPR3........8700
C........ISOTROPIC CASE.                                                 DISPR3........8800
         TERM = 1D0 - VNZ*VNZ                                            DISPR3........8900
         IF (TERM.LT.TOLVRT) THEN                                        DISPR3........9000
C...........FLOW IS ESSENTIALLY IN Z-DIRECTION (VERTICAL)                DISPR3........9100
            UNX = 1D0                                                    DISPR3........9200
            UNY = 0D0                                                    DISPR3........9300
            UNZ = 0D0                                                    DISPR3........9400
            WNX = 0D0                                                    DISPR3........9500
            WNY = 1D0                                                    DISPR3........9600
            WNZ = 0D0                                                    DISPR3........9700
         ELSE                                                            DISPR3........9800
C...........FLOW IS NOT IN Z-DIRECTION (NOT VERTICAL)                    DISPR3........9900
            TERMH = DSQRT(TERM)                                          DISPR3.......10000
            UNX = -VNY/TERMH                                             DISPR3.......10100
            UNY = VNX/TERMH                                              DISPR3.......10200
            UNZ = 0D0                                                    DISPR3.......10300
            WNX = -VNZ*UNY                                               DISPR3.......10400
            WNY = VNZ*UNX                                                DISPR3.......10500
            WNZ = TERMH                                                  DISPR3.......10600
         END IF                                                          DISPR3.......10700
         AT1 = ATMAX                                                     DISPR3.......10800
         AT2 = AT1                                                       DISPR3.......10900
      ELSE                                                               DISPR3.......11000
C........ANISOTROPIC CASE.                                               DISPR3.......11100
C........ROTATE V TO "MAX-MID-MIN" COORDINATES, IF NOT DONE PREVIOUSLY.  DISPR3.......11200
         IF (LISO) THEN                                                  DISPR3.......11300
            CALL ROTMAT(ANG1,ANG2,ANG3,G11,G12,G13,G21,G22,G23,          DISPR3.......11400
     1         G31,G32,G33)                                              DISPR3.......11500
            CALL ROTATE(G11,G21,G31,G12,G22,G32,G13,G23,G33,             DISPR3.......11600
     1         VNX,VNY,VNZ,VNXX,VNYY,VNZZ)                               DISPR3.......11700
         END IF                                                          DISPR3.......11800
C........TRANSPOSE AXES SO THAT THE LONGEST AXIS OF THE TRANSVERSE       DISPR3.......11900
C           DISPERSIVITY ELLIPSOID IS "MAX", THE SECOND LONGEST IS       DISPR3.......12000
C           "MID", AND THE SHORTEST IS "MIN".                            DISPR3.......12100
         J(1:1) = MAXLOC(AT)                                             DISPR3.......12200
         J(3:3) = MINLOC(AT)                                             DISPR3.......12300
         J(2) = 6 - J(1) - J(3)                                          DISPR3.......12400
         VN(1) = VNXX                                                    DISPR3.......12500
         VN(2) = VNYY                                                    DISPR3.......12600
         VN(3) = VNZZ                                                    DISPR3.......12700
         VNTXX = VN(J(1))                                                DISPR3.......12800
         VNTYY = VN(J(2))                                                DISPR3.......12900
         VNTZZ = VN(J(3))                                                DISPR3.......13000
         A2 = AT(J(1))                                                   DISPR3.......13100
         B2 = AT(J(2))                                                   DISPR3.......13200
         C2 = AT(J(3))                                                   DISPR3.......13300
C........APPLY THE BIOT-FRESNEL CONSTRUCTION TO THE TRANSVERSE           DISPR3.......13400
C           DISPERSIVITY ELLIPSOID.                                      DISPR3.......13500
         A2B2 = A2*B2                                                    DISPR3.......13600
         A2C2 = A2*C2                                                    DISPR3.......13700
         B2C2 = B2*C2                                                    DISPR3.......13800
         COS2AV = (A2C2 - B2C2)/(A2B2 - B2C2)                            DISPR3.......13900
         SIN2AV = 1D0 - COS2AV                                           DISPR3.......14000
         COSAV = DSQRT(COS2AV)                                           DISPR3.......14100
         SINAV = DSQRT(SIN2AV)                                           DISPR3.......14200
         TERM1 = COSAV*VNTXX                                             DISPR3.......14300
         TERM2 = SINAV*VNTZZ                                             DISPR3.......14400
         OA1V = TERM1 + TERM2                                            DISPR3.......14500
         OA2V = TERM1 - TERM2                                            DISPR3.......14600
         IF (MAX(DABS(OA1V),DABS(OA2V)).GT.TOLCIR) THEN                  DISPR3.......14700
C...........SLICING ELLIPSE IS ESSENTIALLY A CIRCLE                      DISPR3.......14800
            UNTXX = -VNTZZ                                               DISPR3.......14900
            UNTYY = 0D0                                                  DISPR3.......15000
            UNTZZ = VNTXX                                                DISPR3.......15100
            WNTXX = 0D0                                                  DISPR3.......15200
            WNTYY = 1D0                                                  DISPR3.......15300
            WNTZZ = 0D0                                                  DISPR3.......15400
            AT1 = B2                                                     DISPR3.......15500
            AT2 = B2                                                     DISPR3.......15600
         ELSE                                                            DISPR3.......15700
C...........SLICING ELLIPSE IS NOT A CIRCLE                              DISPR3.......15800
            RVJ1MG = 1D0/DSQRT(1D0 - OA1V*OA1V)                          DISPR3.......15900
            RVJ2MG = 1D0/DSQRT(1D0 - OA2V*OA2V)                          DISPR3.......16000
            RSUM = RVJ1MG + RVJ2MG                                       DISPR3.......16100
            RDIF = RVJ1MG - RVJ2MG                                       DISPR3.......16200
            OAUXX = COSAV*RSUM                                           DISPR3.......16300
            OAUZZ = SINAV*RDIF                                           DISPR3.......16400
            OAWXX = COSAV*RDIF                                           DISPR3.......16500
            OAWZZ = SINAV*RSUM                                           DISPR3.......16600
            OAUV = OAUXX*VNTXX + OAUZZ*VNTZZ                             DISPR3.......16700
            OAWV = OAWXX*VNTXX + OAWZZ*VNTZZ                             DISPR3.......16800
            OAUOAU = OAUXX*OAUXX + OAUZZ*OAUZZ                           DISPR3.......16900
            OAWOAW = OAWXX*OAWXX + OAWZZ*OAWZZ                           DISPR3.......17000
            UMTERM = OAUOAU - OAUV*OAUV                                  DISPR3.......17100
            WMTERM = OAWOAW - OAWV*OAWV                                  DISPR3.......17200
C...........COMPUTE THE LARGER OF U AND W DIRECTLY, THEN COMPUTE THE     DISPR3.......17300
C              OTHER BY CROSS-PRODUCT WITH V.                            DISPR3.......17400
            IF (UMTERM.GT.WMTERM) THEN                                   DISPR3.......17500
               RUMAGH = 1D0/DSQRT(UMTERM)                                DISPR3.......17600
               UNTXX = (OAUXX - OAUV*VNTXX)*RUMAGH                       DISPR3.......17700
               UNTYY = -OAUV*VNTYY*RUMAGH                                DISPR3.......17800
               UNTZZ = (OAUZZ - OAUV*VNTZZ)*RUMAGH                       DISPR3.......17900
               WNTXX = UNTYY*VNTZZ - UNTZZ*VNTYY                         DISPR3.......18000
               WNTYY = UNTZZ*VNTXX - UNTXX*VNTZZ                         DISPR3.......18100
               WNTZZ = UNTXX*VNTYY - UNTYY*VNTXX                         DISPR3.......18200
            ELSE                                                         DISPR3.......18300
               RWMAGH = 1D0/DSQRT(WMTERM)                                DISPR3.......18400
               WNTXX = (OAWXX - OAWV*VNTXX)*RWMAGH                       DISPR3.......18500
               WNTYY = -OAWV*VNTYY*RWMAGH                                DISPR3.......18600
               WNTZZ = (OAWZZ - OAWV*VNTZZ)*RWMAGH                       DISPR3.......18700
               UNTXX = WNTYY*VNTZZ - WNTZZ*VNTYY                         DISPR3.......18800
               UNTYY = WNTZZ*VNTXX - WNTXX*VNTZZ                         DISPR3.......18900
               UNTZZ = WNTXX*VNTYY - WNTYY*VNTXX                         DISPR3.......19000
            END IF                                                       DISPR3.......19100
            A2B2C2 = A2B2*C2                                             DISPR3.......19200
            DEN1 = B2C2*UNTXX*UNTXX+A2C2*UNTYY*UNTYY+A2B2*UNTZZ*UNTZZ    DISPR3.......19300
            DEN2 = B2C2*WNTXX*WNTXX+A2C2*WNTYY*WNTYY+A2B2*WNTZZ*WNTZZ    DISPR3.......19400
            AT1 = A2B2C2/DEN1                                            DISPR3.......19500
            AT2 = A2B2C2/DEN2                                            DISPR3.......19600
         END IF                                                          DISPR3.......19700
C........TRANSPOSE AXES BACK TO ORIGINAL "MAX-MID-MIN" AXES.             DISPR3.......19800
         UN(J(1)) = UNTXX                                                DISPR3.......19900
         UN(J(2)) = UNTYY                                                DISPR3.......20000
         UN(J(3)) = UNTZZ                                                DISPR3.......20100
         UNXX = UN(1)                                                    DISPR3.......20200
         UNYY = UN(2)                                                    DISPR3.......20300
         UNZZ = UN(3)                                                    DISPR3.......20400
         WN(J(1)) = WNTXX                                                DISPR3.......20500
         WN(J(2)) = WNTYY                                                DISPR3.......20600
         WN(J(3)) = WNTZZ                                                DISPR3.......20700
         WNXX = WN(1)                                                    DISPR3.......20800
         WNYY = WN(2)                                                    DISPR3.......20900
         WNZZ = WN(3)                                                    DISPR3.......21000
C........ROTATE THE TRANSVERSE DISPERSION DIRECTIONS FROM "MAX-MID-MIN"  DISPR3.......21100
C           COORDINATES TO X,Y,Z-COORDINATES.                            DISPR3.......21200
         CALL ROTATE(G11,G12,G13,G21,G22,G23,G31,G32,G33,UNXX,UNYY,UNZZ, DISPR3.......21300
     1      UNX,UNY,UNZ)                                                 DISPR3.......21400
         CALL ROTATE(G11,G12,G13,G21,G22,G23,G31,G32,G33,WNXX,WNYY,WNZZ, DISPR3.......21500
     1      WNX,WNY,WNZ)                                                 DISPR3.......21600
      END IF                                                             DISPR3.......21700
C.....COMPUTE TRANSVERSE DISPERSION COEFFICIENTS FROM DISPERSIVITIES     DISPR3.......21800
      DT1 = AT1*VMAG                                                     DISPR3.......21900
      DT2 = AT2*VMAG                                                     DISPR3.......22000
C                                                                        DISPR3.......22100
C.....ROTATE THE DISPERSION TENSOR FROM EIGENVECTOR COORDINATES TO       DISPR3.......22200
C     X,Y,Z-COORDINATES.                                                 DISPR3.......22300
      CALL TENSYM(DL,DT1,DT2,VNX,UNX,WNX,VNY,UNY,WNY,VNZ,UNZ,WNZ,        DISPR3.......22400
     1   DXX,DXY,DXZ,DYX,DYY,DYZ,DZX,DZY,DZZ)                            DISPR3.......22500
C                                                                        DISPR3.......22600
      RETURN                                                             DISPR3.......22700
      END                                                                DISPR3.......22800
C                                                                        DISPR3.......22900
C     FUNCTION          D  P  3  S  T  R           SUTRA VERSION 2.2     DP3STR.........100
C                                                                        DP3STR.........200
C *** PURPOSE :                                                          DP3STR.........300
C ***  TO RETURN THREE DOUBLE-PRECISION NUMBERS IN THE FORM OF A         DP3STR.........400
C ***  STRING.  THE THREE NUMBERS ARE PASSED IN THROUGH ARRAY DPA        DP3STR.........500
C ***  AND ARE ROUNDED USING FUNCTION CUTSML IN PREPARATION FOR OUTPUT.  DP3STR.........600
C                                                                        DP3STR.........700
      FUNCTION DP3STR(DPA)                                               DP3STR.........800
      IMPLICIT DOUBLE PRECISION (A-H, O-Z)                               DP3STR.........900
      DIMENSION DPA(3)                                                   DP3STR........1000
      CHARACTER DP3STR*45                                                DP3STR........1100
C                                                                        DP3STR........1200
C.....WRITE NUMBERS TO STRING                                            DP3STR........1300
      WRITE(UNIT=DP3STR,FMT="(3(1PE15.7))")                              DP3STR........1400
     1   CUTSML(DPA(1)), CUTSML(DPA(2)), CUTSML(DPA(3))                  DP3STR........1500
C                                                                        DP3STR........1600
      RETURN                                                             DP3STR........1700
      END                                                                DP3STR........1800
C                                                                        DP3STR........1900
C     SUBROUTINE        E  L  E  M  N  2           SUTRA VERSION 2.2     ELEMN2.........100
C                                                                        ELEMN2.........200
C *** PURPOSE :                                                          ELEMN2.........300
C ***  TO CONTROL AND CARRY OUT ALL CALCULATIONS FOR EACH ELEMENT BY     ELEMN2.........400
C ***  OBTAINING ELEMENT INFORMATION FROM THE BASIS FUNCTION ROUTINE,    ELEMN2.........500
C ***  CARRYING OUT GAUSSIAN INTEGRATION OF FINITE ELEMENT INTEGRALS,    ELEMN2.........600
C ***  AND ASSEMBLING RESULTS OF ELEMENTWISE INTEGRATIONS INTO           ELEMN2.........700
C ***  A GLOBAL MATRIX AND GLOBAL VECTOR FOR BOTH FLOW AND TRANSPORT     ELEMN2.........800
C ***  EQUATIONS. ALSO CALCULATES VELOCITY AT EACH ELEMENT CENTROID FOR  ELEMN2.........900
C ***  PRINTED OUTPUT. THIS SUBROUTINE HANDLES 2D CALCULATIONS ONLY;     ELEMN2........1000
C ***  3D CALCULATIONS ARE PERFORMED IN SUBROUTINE ELEMN3.               ELEMN2........1100
C                                                                        ELEMN2........1200
C                                                                        ELEMN2........1300
      SUBROUTINE ELEMN2(ML,IN,X,Y,THICK,PITER,UITER,RCIT,RCITM1,POR,     ELEMN2........1400
     1   ALMAX,ALMIN,ATMAX,ATMIN,PERMXX,PERMXY,PERMYX,PERMYY,PANGLE,     ELEMN2........1500
C     2   VMAG,VANG,VOL,PMAT,PVEC,UMAT,UVEC,GXSI,GETA,PVEL,LREG,IA,JA)    ELEMN2........1600
     2   VMAG,VANG,VOL,PMAT,PVEC,UMAT,UVEC,GXSI,GETA,PVEL,LREG,IA,JA
     3   ,POR1,REK,QLX,QLY,TPT,QXF,QYF,SPF,RPF)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                ELEMN2........1700
      PARAMETER (NCOLMX=9)                                               ELEMN2........1800
      CHARACTER*80 ERRCOD,CHERR(10),UNAME,FNAME(0:13)                    ELEMN2........1900
      DIMENSION IN(NIN),X(NN),Y(NN),THICK(NN),PITER(NN),                 ELEMN2........2000
     1   UITER(NN),RCIT(NN),RCITM1(NN),POR(NN),PVEL(NN)                  ELEMN2........2100
      DIMENSION PERMXX(NE),PERMXY(NE),PERMYX(NE),PERMYY(NE),PANGLE(NE),  ELEMN2........2200
     1   ALMAX(NE),ALMIN(NE),ATMAX(NE),ATMIN(NE),VMAG(NE),VANG(NE),      ELEMN2........2300
     2   GXSI(NE,4),GETA(NE,4),LREG(NE)                                  ELEMN2........2400
      DIMENSION VOL(NN),PMAT(NELT,NCBI),PVEC(NNVEC),UMAT(NELT,NCBI),     ELEMN2........2500
     1   UVEC(NNVEC)                                                     ELEMN2........2600
      DIMENSION BFLOWE(8,8),DFLOWE(8),BTRANE(8,8),DTRANE(8,8),VOLE(8)    ELEMN2........2700
      DIMENSION F(4,4),W(4,4),DET(4),DFDXG(4,4),DFDYG(4,4),              ELEMN2........2800
     1   DWDXG(4,4),DWDYG(4,4)                                           ELEMN2........2900
      DIMENSION SWG(4),RHOG(4),VISCG(4),PORG(4),VXG(4),VYG(4),           ELEMN2........3000
     1   RELKG(4),RGXG(4),RGYG(4),VGMAG(4),THICKG(4)                     ELEMN2........3100
      DIMENSION RXXG(4),RXYG(4),RYXG(4),RYYG(4)                          ELEMN2........3200
      DIMENSION BXXG(4),BXYG(4),BYXG(4),BYYG(4),EXG(4),EYG(4)            ELEMN2........3300
      DIMENSION GXLOC(4),GYLOC(4)                                        ELEMN2........3400
      DIMENSION IA(NDIMIA),JA(NDIMJA)                                    ELEMN2........3500
      DIMENSION INERR(10), RLERR(10)                                     ELEMN2........3600
      DIMENSION J5COL(NCOLMX), J6COL(NCOLMX)                             ELEMN2........3700
      DIMENSION KTYPE(2)                                                 ELEMN2........3800
      DIMENSION POR1(NN),REK(NE),QLX(NE),QLY(NE),TPT(NN),QXF(NE),
     1   QYF(NE),SPF(NE),RPF(NE)
C      QXG AND QYG ARE THE DENSITY FLUX AT THE FOUR GAUSS POINT
      DIMENSION QXG(4),QYG(4),QXFG(4),QYFG(4),SPFG(4),RPFG(4)


      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  ELEMN2........3900
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           ELEMN2........4000
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      ELEMN2........4100
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              ELEMN2........4200
     1   NSOP,NSOU,NBCN,NCIDB                                            ELEMN2........4300
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        ELEMN2........4400
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA                           ELEMN2........4500
      COMMON /FNAMES/ UNAME,FNAME                                        ELEMN2........4600
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 ELEMN2........4700
     1   K10,K11,K12,K13                                                 ELEMN2........4800
      COMMON /GRAVEC/ GRAVX,GRAVY,GRAVZ                                  ELEMN2........4900
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS      ELEMN2........5000
      COMMON /JCOLS/ NCOLPR,LCOLPR,NCOLS5,NCOLS6,J5COL,J6COL             ELEMN2........5100
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                ELEMN2........5200
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            ELEMN2........5300
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,      ELEMN2........5400
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2        ELEMN2........5500
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                           ELEMN2........5600
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       ELEMN2........5700
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      ELEMN2........5800
      DATA GLOC/0.577350269189626D0/                                     ELEMN2........5900
      DATA INTIM/0/,ISTOP/0/,GXLOC/-1.D0,1.D0,1.D0,-1.D0/,               ELEMN2........6000
     1   GYLOC/-1.D0,-1.D0,1.D0,1.D0/                                    ELEMN2........6100
      SAVE GLOC,INTIM,ISTOP,GXLOC,GYLOC                                  ELEMN2........6200
C                                                                        ELEMN2........6300
C.....DECIDE WHETHER TO CALCULATE CENTROID VELOCITIES ON THIS CALL       ELEMN2........6400
      IVCALC = 0                                                         ELEMN2........6500
      JVCALC = 0                                                         ELEMN2........6600
      IF ((ML.NE.2).AND.(ITER.EQ.1)) IVCALC = 1                          ELEMN2........6700
      IF (IT.EQ.1) IVCALC = 1                                            ELEMN2........6800
      IF ((KVEL.EQ.1).OR.(K6.NE.-1)) JVCALC = 1                          ELEMN2........6900
      KVCALC = IVCALC + JVCALC                                           ELEMN2........7000
C                                                                        ELEMN2........7100
C.....ON FIRST TIME STEP, PREPARE GRAVITY VECTOR COMPONENTS,             ELEMN2........7200
C        GXSI AND GETA, FOR CONSISTENT VELOCITIES,                       ELEMN2........7300
C        AND CHECK ELEMENT SHAPES                                        ELEMN2........7400
      IF(INTIM) 100,100,2000                                             ELEMN2........7500
  100 INTIM=1                                                            ELEMN2........7600
C.....LOOP THROUGH ALL ELEMENTS TO OBTAIN THE JACOBIAN                   ELEMN2........7700
C        AT EACH OF THE FOUR NODES IN EACH ELEMENT                       ELEMN2........7800
      DO 1000 L=1,NE                                                     ELEMN2........7900
       DO 500 IL=1,4                                                     ELEMN2........8000
        XLOC=GXLOC(IL)                                                   ELEMN2........8100
        YLOC=GYLOC(IL)                                                   ELEMN2........8200
        CALL BASIS2(0000,L,XLOC,YLOC,IN,X,Y,F(1,IL),W(1,IL),DET(IL),     ELEMN2........8300
     1     DFDXG(1,IL),DFDYG(1,IL),DWDXG(1,IL),DWDYG(1,IL),              ELEMN2........8400
     2     PITER,UITER,PVEL,POR,THICK,THICKG(IL),VXG(IL),VYG(IL),        ELEMN2........8500
     3     SWG(IL),RHOG(IL),VISCG(IL),PORG(IL),VGMAG(IL),RELKG(IL),      ELEMN2........8600
     4     PERMXX,PERMXY,PERMYX,PERMYY,CJ11,CJ12,CJ21,CJ22,              ELEMN2........8700
     5     GXSI,GETA,RCIT,RCITM1,RGXG(IL),RGYG(IL),LREG,POR1,QXG(IL),
     6     QYG(IL),TPT,QXFG(IL),QYFG(IL),SPFG(IL),RPFG(IL))
C     5     GXSI,GETA,RCIT,RCITM1,RGXG(IL),RGYG(IL),LREG)                 ELEMN2........8800
        GXSI(L,IL)=CJ11*GRAVX+CJ12*GRAVY                                 ELEMN2........8900
        GETA(L,IL)=CJ21*GRAVX+CJ22*GRAVY                                 ELEMN2........9000
C.....CHECK FOR NEGATIVE- OR ZERO-AREA ERRORS IN ELEMENT SHAPES          ELEMN2........9100
        IF(DET(IL)) 200,200,500                                          ELEMN2........9200
  200   ISTOP=ISTOP+1                                                    ELEMN2........9300
        WRITE(K3,400) IN((L-1)*4+IL),L,DET(IL)                           ELEMN2........9400
        WRITE(K00,401) IN((L-1)*4+IL),L,DET(IL)                          ELEMN2........9500
  400   FORMAT(11X,'THE DETERMINANT OF THE JACOBIAN AT NODE ',I9,        ELEMN2........9600
     1     ' IN ELEMENT ',I9,' IS NEGATIVE OR ZERO, ',1PE15.7)           ELEMN2........9700
  401   FORMAT(1X,'THE DETERMINANT OF THE JACOBIAN AT NODE ',I9,         ELEMN2........9800
     1     ' IN ELEMENT ',I9,' IS NEGATIVE OR ZERO, ',1PE15.7)           ELEMN2........9900
  500  CONTINUE                                                          ELEMN2.......10000
 1000 CONTINUE                                                           ELEMN2.......10100
C                                                                        ELEMN2.......10200
      IF(ISTOP.EQ.0) GOTO 2000                                           ELEMN2.......10300
      ERRCOD = 'INP-14B,22-1'                                            ELEMN2.......10400
      CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                           ELEMN2.......10500
C                                                                        ELEMN2.......10600
C.....LOOP THROUGH ALL ELEMENTS TO CARRY OUT SPATIAL INTEGRATION         ELEMN2.......10700
C        OF FLUX TERMS IN P AND/OR U EQUATIONS                           ELEMN2.......10800
 2000 IF(IUNSAT.NE.0) IUNSAT=2                                           ELEMN2.......10900
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  ELEMN2.......11000
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  ELEMN2.......11100
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  ELEMN2.......11200
      DO 9999 L=1,NE                                                     ELEMN2.......11300
       XIX=-1.D0                                                         ELEMN2.......11400
       YIY=-1.D0                                                         ELEMN2.......11500
       KG=0                                                              ELEMN2.......11600
C.....OBTAIN BASIS FUNCTION AND RELATED INFORMATION AT EACH OF           ELEMN2.......11700
C        FOUR GAUSS POINTS IN THE ELEMENT                                ELEMN2.......11800
       DO 2200 IYL=1,2                                                   ELEMN2.......11900
        DO 2100 IXL=1,2                                                  ELEMN2.......12000
         KG=KG+1                                                         ELEMN2.......12100
         XLOC=XIX*GLOC                                                   ELEMN2.......12200
         YLOC=YIY*GLOC                                                   ELEMN2.......12300
         CALL BASIS2(0001,L,XLOC,YLOC,IN,X,Y,F(1,KG),W(1,KG),DET(KG),    ELEMN2.......12400
     1      DFDXG(1,KG),DFDYG(1,KG),DWDXG(1,KG),DWDYG(1,KG),             ELEMN2.......12500
     2      PITER,UITER,PVEL,POR,THICK,THICKG(KG),VXG(KG),VYG(KG),       ELEMN2.......12600
     3      SWG(KG),RHOG(KG),VISCG(KG),PORG(KG),VGMAG(KG),RELKG(KG),     ELEMN2.......12700
     4      PERMXX,PERMXY,PERMYX,PERMYY,CJ11,CJ12,CJ21,CJ22,             ELEMN2.......12800
     5     GXSI,GETA,RCIT,RCITM1,RGXG(KG),RGYG(KG),LREG,POR1,QXG(KG),
     6     QYG(KG),TPT,QXFG(KG),QYFG(KG),SPFG(KG),RPFG(KG))
C     5      GXSI,GETA,RCIT,RCITM1,RGXG(KG),RGYG(KG),LREG)                ELEMN2.......12900
 2100    XIX=-XIX                                                        ELEMN2.......13000
 2200   YIY=-YIY                                                         ELEMN2.......13100
C                                                                        ELEMN2.......13200
C.....CALCULATE VELOCITY AT ELEMENT CENTROID WHEN REQUIRED               ELEMN2.......13300
C     THIS IS REQUIRED IN EVERY TIME STEP BECAUSE QLY IS NEEDED IN ENERGY TRANSPORT
C       IF(KVCALC-2) 3000,2300,3000                                       ELEMN2.......13400
 2300  AXSUM=0.0D0                                                       ELEMN2.......13500
       AYSUM=0.0D0                                                       ELEMN2.......13600
       QXSUM=0.0D0
       QYSUM=0.0D0
       QXFSUM=0.0D0
       QYFSUM=0.0D0
       DO 2400 KG=1,4                                                    ELEMN2.......13700
        QXSUM=QXSUM+QXG(KG)
        QYSUM=QYSUM+QYG(KG)
        QXFSUM=QXFSUM+QXFG(KG)
        QYFSUM=QYFSUM+QYFG(KG)
        AXSUM=AXSUM+VXG(KG)                                              ELEMN2.......13800
 2400   AYSUM=AYSUM+VYG(KG)                                              ELEMN2.......13900
       VMAG(L)=DSQRT(AXSUM*AXSUM+AYSUM*AYSUM)                            ELEMN2.......14000
       IF (VMAG(L).NE.0D0) THEN                                          ELEMN2.......14100
          VMAG(L)=VMAG(L)*2.5D-1                                         ELEMN2.......14200
          VANG(L)=DATAN2(AYSUM,AXSUM)*5.729577951308232D+1               ELEMN2.......14300
       ELSE                                                              ELEMN2.......14400
          VANG(L)=0D0                                                    ELEMN2.......14500
       END IF                                                            ELEMN2.......14600
       QLX(L)=QXSUM/4.D0
       QLY(L)=QYSUM/4.D0
       QXF(L)=QXFSUM/4.D0
       QYF(L)=QYFSUM/4.D0
C                                                                        ELEMN2.......14700
C.....INCLUDE MESH THICKNESS IN NUMERICAL INTEGRATION                    ELEMN2.......14800
C.....CALCULATING RELATVE K AT THE CENRINOID OF THE ELEMENT
 3000  DO 3300 KG=1,4                                                    ELEMN2.......14900
        REK(L)=REK(L)+RELKG(KG)/4.D0
        SPF(L)=SPF(L)+SPFG(KG)/4.D0
        RPF(L)=RPF(L)+RPFG(KG)/4.D0
 3300   DET(KG)=THICKG(KG)*DET(KG)                                       ELEMN2.......15000
C                                                                        ELEMN2.......15100
C.....CALCULATE PARAMETERS FOR FLUID MASS BALANCE AT GAUSS POINTS        ELEMN2.......15200
       IF(ML-1) 3400,3400,6100                                           ELEMN2.......15300
 3400  SWTEST=0.D0                                                       ELEMN2.......15400
       DO 4000 KG=1,4                                                    ELEMN2.......15500
        SWTEST=SWTEST+SWG(KG)                                            ELEMN2.......15600
        ROMG=RHOG(KG)*RELKG(KG)/VISCG(KG)                                ELEMN2.......15700
        RXXG(KG)=PERMXX(L)*ROMG                                          ELEMN2.......15800
        RXYG(KG)=PERMXY(L)*ROMG                                          ELEMN2.......15900
        RYXG(KG)=PERMYX(L)*ROMG                                          ELEMN2.......16000
        RYYG(KG)=PERMYY(L)*ROMG                                          ELEMN2.......16100
 4000   CONTINUE                                                         ELEMN2.......16200
C......CALCULATE ABSOLUTE PERMEABILITY*RELATIVE PERMEABILITY*RHOG/VISCG 
C      DUE TO FILM FLOW, SEE PAGE 165-169 FOR REFERENCE
C      KG -- MEANS GAUSS POINT
       IF (MFT.EQ.1.OR.MFT.EQ.3)THEN
         DO 4001 KG=1,4
           RXXFG=SPFG(KG)*RPFG(KG)*RHOG(KG)/VISCG(KG)
           RYYFG=SPFG(KG)*RPFG(KG)*RHOG(KG)/VISCG(KG)
           RXXG(KG)=RXXG(KG)+RXXFG
           RYYG(KG)=RYYG(KG)+RYYFG
 4001    CONTINUE
       ENDIF
C                                                                        ELEMN2.......16300
C.....INTEGRATE FLUID MASS BALANCE IN AN UNSATURATED ELEMENT             ELEMN2.......16400
C        USING ASYMMETRIC WEIGHTING FUNCTIONS                            ELEMN2.......16500
       IF(UP.LE.1.0D-6) GOTO 5200                                        ELEMN2.......16600
       IF(SWTEST-3.999D0) 4200,5200,5200                                 ELEMN2.......16700
 4200  DO 4300 I=1,4                                                     ELEMN2.......16800
        VOLE(I) = 0.D0                                                   ELEMN2.......16900
        DFLOWE(I) = 0.D0                                                 ELEMN2.......17000
        DO 4300 J=1,4                                                    ELEMN2.......17100
         BFLOWE(I,J) = 0.D0                                              ELEMN2.......17200
 4300  CONTINUE                                                          ELEMN2.......17300
       DO 5000 KG=1,4                                                    ELEMN2.......17400
        RXXGD = RXXG(KG)*DET(KG)                                         ELEMN2.......17500
        RXYGD = RXYG(KG)*DET(KG)                                         ELEMN2.......17600
        RYXGD = RYXG(KG)*DET(KG)                                         ELEMN2.......17700
        RYYGD = RYYG(KG)*DET(KG)                                         ELEMN2.......17800
        RDRX = RXXGD*RGXG(KG) + RXYGD*RGYG(KG)                           ELEMN2.......17900
        RDRY = RYXGD*RGXG(KG) + RYYGD*RGYG(KG)                           ELEMN2.......18000
        DO 4400 I=1,4                                                    ELEMN2.......18100
         VOLE(I) = VOLE(I) + F(I,KG)*DET(KG)                             ELEMN2.......18200
         DFLOWE(I) = DFLOWE(I) + RDRX*DWDXG(I,KG) + RDRY*DWDYG(I,KG)     ELEMN2.......18300
 4400   CONTINUE                                                         ELEMN2.......18400
        DO 5000 J=1,4                                                    ELEMN2.......18500
         RDDFJX = RXXGD*DFDXG(J,KG) + RXYGD*DFDYG(J,KG)                  ELEMN2.......18600
         RDDFJY = RYXGD*DFDXG(J,KG) + RYYGD*DFDYG(J,KG)                  ELEMN2.......18700
         DO 5000 I=1,4                                                   ELEMN2.......18800
          BFLOWE(I,J) = BFLOWE(I,J) + DWDXG(I,KG)*RDDFJX                 ELEMN2.......18900
     1                  + DWDYG(I,KG)*RDDFJY                             ELEMN2.......19000
 5000  CONTINUE                                                          ELEMN2.......19100
       GOTO 6050                                                         ELEMN2.......19200
C                                                                        ELEMN2.......19300
C.....INTEGRATE FLUID MASS BALANCE IN A SATURATED OR UNSATURATED         ELEMN2.......19400
C        ELEMENT USING SYMMETRIC WEIGHTING FUNCTIONS                     ELEMN2.......19500
 5200  DO 5300 I=1,4                                                     ELEMN2.......19600
        VOLE(I) = 0.D0                                                   ELEMN2.......19700
        DFLOWE(I) = 0.D0                                                 ELEMN2.......19800
        DO 5300 J=1,4                                                    ELEMN2.......19900
         BFLOWE(I,J) = 0.D0                                              ELEMN2.......20000
 5300  CONTINUE                                                          ELEMN2.......20100
       DO 6000 KG=1,4                                                    ELEMN2.......20200
        RXXGD = RXXG(KG)*DET(KG)                                         ELEMN2.......20300
        RXYGD = RXYG(KG)*DET(KG)                                         ELEMN2.......20400
        RYXGD = RYXG(KG)*DET(KG)                                         ELEMN2.......20500
        RYYGD = RYYG(KG)*DET(KG)                                         ELEMN2.......20600
        RDRX = RXXGD*RGXG(KG) + RXYGD*RGYG(KG)                           ELEMN2.......20700
        RDRY = RYXGD*RGXG(KG) + RYYGD*RGYG(KG)                           ELEMN2.......20800
        DO 5400 I=1,4                                                    ELEMN2.......20900
         VOLE(I) = VOLE(I) + F(I,KG)*DET(KG)                             ELEMN2.......21000
         DFLOWE(I) = DFLOWE(I) + RDRX*DFDXG(I,KG) + RDRY*DFDYG(I,KG)     ELEMN2.......21100
 5400   CONTINUE                                                         ELEMN2.......21200
        DO 6000 J=1,4                                                    ELEMN2.......21300
         RDDFJX = RXXGD*DFDXG(J,KG) + RXYGD*DFDYG(J,KG)                  ELEMN2.......21400
         RDDFJY = RYXGD*DFDXG(J,KG) + RYYGD*DFDYG(J,KG)                  ELEMN2.......21500
         DO 6000 I=1,4                                                   ELEMN2.......21600
          BFLOWE(I,J) = BFLOWE(I,J) + DFDXG(I,KG)*RDDFJX                 ELEMN2.......21700
     1                  + DFDYG(I,KG)*RDDFJY                             ELEMN2.......21800
 6000  CONTINUE                                                          ELEMN2.......21900
 6050  CONTINUE                                                          ELEMN2.......22000
       IF(ML-1) 6100,9000,6100                                           ELEMN2.......22100
 6100  IF(NOUMAT.EQ.1) GOTO 9000                                         ELEMN2.......22200
C                                                                        ELEMN2.......22300
C                                                                        ELEMN2.......22400
C.....CALCULATE PARAMETERS FOR ENERGY BALANCE OR SOLUTE MASS BALANCE     ELEMN2.......22500
C        AT GAUSS POINTS                                                 ELEMN2.......22600
       DO 7000 KG=1,4                                                    ELEMN2.......22700
        ESWG=PORG(KG)*SWG(KG)                                            ELEMN2.......22800
        RHOCWG=RHOG(KG)*CW                                               ELEMN2.......22900
        ESRCG=ESWG*RHOCWG                                                ELEMN2.......23000
        IF(VGMAG(KG)) 6300,6300,6600                                     ELEMN2.......23100
 6300   EXG(KG)=0.0D0                                                    ELEMN2.......23200
        EYG(KG)=0.0D0                                                    ELEMN2.......23300
        DXXG=0.0D0                                                       ELEMN2.......23400
        DXYG=0.0D0                                                       ELEMN2.......23500
        DYXG=0.0D0                                                       ELEMN2.......23600
        DYYG=0.0D0                                                       ELEMN2.......23700
        GOTO 6900                                                        ELEMN2.......23800
 6600   EXG(KG)=ESRCG*VXG(KG)                                            ELEMN2.......23900
        EYG(KG)=ESRCG*VYG(KG)                                            ELEMN2.......24000
C                                                                        ELEMN2.......24100
C.....DISPERSIVITY MODEL FOR 2D ANISOTROPIC MEDIA                        ELEMN2.......24200
C        WITH PRINCIPAL DISPERSIVITIES ALMAX, ALMIN, ATMAX, AND ATMIN    ELEMN2.......24300
        VANGG=1.570796327D0                                              ELEMN2.......24400
        IF(VXG(KG)*VXG(KG).GT.0.D0) VANGG=DATAN(VYG(KG)/VXG(KG))         ELEMN2.......24500
        VKANGG=VANGG-PANGLE(L)                                           ELEMN2.......24600
        DCO=DCOS(VKANGG)                                                 ELEMN2.......24700
        DSI=DSIN(VKANGG)                                                 ELEMN2.......24800
C.....EFFECTIVE LONGITUDINAL DISPERSIVITY IN FLOW DIRECTION, ALEFF       ELEMN2.......24900
        ALEFF=0.0D0                                                      ELEMN2.......25000
        IF(ALMAX(L)+ALMIN(L)) 6800,6800,6700                             ELEMN2.......25100
 6700   ALEFF=ALMAX(L)*ALMIN(L)/(ALMIN(L)*DCO*DCO+ALMAX(L)*DSI*DSI)      ELEMN2.......25200
 6800   DLG=ALEFF*VGMAG(KG)                                              ELEMN2.......25300
C.....EFFECTIVE TRANSVERSE DISPERSIVITY IN FLOW DIRECTION, ATEFF.        ELEMN2.......25400
C        NOTE THAT, STARTING WITH VERSION 2D3D.1, ATMAX AND ATMIN        ELEMN2.......25500
C        HAVE EXCHANGED IDENTITIES TO MAKE THE 2D DISPERSION MODEL       ELEMN2.......25600
C        CONCEPTUALLY CONSISTENT WITH THE 3D MODEL.                      ELEMN2.......25700
        ATEFF=0.0D0                                                      ELEMN2.......25800
        IF(ATMAX(L)+ATMIN(L)) 6860,6860,6840                             ELEMN2.......25900
 6840   ATEFF=ATMAX(L)*ATMIN(L)/(ATMAX(L)*DCO*DCO+ATMIN(L)*DSI*DSI)      ELEMN2.......26000
 6860   DTG=ATEFF*VGMAG(KG)                                              ELEMN2.......26100
C                                                                        ELEMN2.......26200
        VXVG=VXG(KG)/VGMAG(KG)                                           ELEMN2.......26300
        VYVG=VYG(KG)/VGMAG(KG)                                           ELEMN2.......26400
        VXVG2=VXVG*VXVG                                                  ELEMN2.......26500
        VYVG2=VYVG*VYVG                                                  ELEMN2.......26600
C.....DISPERSION TENSOR                                                  ELEMN2.......26700
        DXXG=DLG*VXVG2+DTG*VYVG2                                         ELEMN2.......26800
        DYYG=DTG*VXVG2+DLG*VYVG2                                         ELEMN2.......26900
        DXYG=(DLG-DTG)*VXVG*VYVG                                         ELEMN2.......27000
        DYXG=DXYG                                                        ELEMN2.......27100
C                                                                        ELEMN2.......27200
C.....IN-PARALLEL CONDUCTIVITIES (DIFFUSIVITIES) FORMULA                 ELEMN2.......27300
 6900   IF (ME.EQ.1) THEN                                                ELEMN2.......27400
C..........FOR ENERGY TRANSPORT:                                         ELEMN2.......27500
           ESE = ESWG*SIGMAW + (1D0-PORG(KG))*SIGMAS                     ELEMN2.......27600
        ELSE                                                             ELEMN2.......27700
C..........FOR SOLUTE TRANSPORT:                                         ELEMN2.......27800
           ESE = ESRCG*SIGMAW                                            ELEMN2.......27900
        END IF                                                           ELEMN2.......28000
C.....ADD DIFFUSION AND DISPERSION TERMS TO TOTAL DISPERSION TENSOR      ELEMN2.......28100
        BXXG(KG)=ESRCG*DXXG+ESE                                          ELEMN2.......28200
        BXYG(KG)=ESRCG*DXYG                                              ELEMN2.......28300
        BYXG(KG)=ESRCG*DYXG                                              ELEMN2.......28400
 7000   BYYG(KG)=ESRCG*DYYG+ESE                                          ELEMN2.......28500
C                                                                        ELEMN2.......28600
C.....INTEGRATE SOLUTE MASS BALANCE OR ENERGY BALANCE                    ELEMN2.......28700
C        USING SYMMETRIC WEIGHTING FUNCTIONS FOR DISPERSION TERM AND     ELEMN2.......28800
C        USING EITHER SYMMETRIC OR ASYMMETRIC WEIGHTING FUNCTIONS        ELEMN2.......28900
C        FOR ADVECTION TERM                                              ELEMN2.......29000
         DO 7400 I=1,4                                                   ELEMN2.......29100
         DO 7400 J=1,4                                                   ELEMN2.......29200
            BTRANE(I,J) = 0.D0                                           ELEMN2.......29300
            DTRANE(I,J) = 0.D0                                           ELEMN2.......29400
 7400    CONTINUE                                                        ELEMN2.......29500
         DO 8000 KG=1,4                                                  ELEMN2.......29600
            BXXGD = BXXG(KG)*DET(KG)                                     ELEMN2.......29700
            BXYGD = BXYG(KG)*DET(KG)                                     ELEMN2.......29800
            BYXGD = BYXG(KG)*DET(KG)                                     ELEMN2.......29900
            BYYGD = BYYG(KG)*DET(KG)                                     ELEMN2.......30000
            EXGD = EXG(KG)*DET(KG)                                       ELEMN2.......30100
            EYGD = EYG(KG)*DET(KG)                                       ELEMN2.......30200
            DO 8000 J=1,4                                                ELEMN2.......30300
               BDDFJX = BXXGD*DFDXG(J,KG) + BXYGD*DFDYG(J,KG)            ELEMN2.......30400
               BDDFJY = BYXGD*DFDXG(J,KG) + BYYGD*DFDYG(J,KG)            ELEMN2.......30500
               EDDFJ = EXGD*DFDXG(J,KG) + EYGD*DFDYG(J,KG)               ELEMN2.......30600
               DO 8000 I=1,4                                             ELEMN2.......30700
                  BTRANE(I,J) = BTRANE(I,J) + DFDXG(I,KG)*BDDFJX         ELEMN2.......30800
     1               + DFDYG(I,KG)*BDDFJY                                ELEMN2.......30900
                  DTRANE(I,J) = DTRANE(I,J) + EDDFJ*W(I,KG)              ELEMN2.......31000
 8000    CONTINUE                                                        ELEMN2.......31100
 9000  CONTINUE                                                          ELEMN2.......31200
C                                                                        ELEMN2.......31300
C                                                                        ELEMN2.......31400
C.....SEND RESULTS OF INTEGRATIONS FOR THIS ELEMENT                      ELEMN2.......31500
C        TO GLOBAL ASSEMBLY ROUTINE:                                     ELEMN2.......31600
C        GLOBAN -- SUTRA'S ORIGINAL BANDED FORMAT                        ELEMN2.......31700
C        GLOCOL -- SLAP COLUMN FORMAT                                    ELEMN2.......31800
      IF (KSOLVP.EQ.0) THEN                                              ELEMN2.......31900
         CALL GLOBAN(L,ML,VOLE,BFLOWE,DFLOWE,BTRANE,DTRANE,              ELEMN2.......32000
     1      IN,VOL,PMAT,PVEC,UMAT,UVEC)                                  ELEMN2.......32100
      ELSE                                                               ELEMN2.......32200
         CALL GLOCOL(L,ML,VOLE,BFLOWE,DFLOWE,BTRANE,DTRANE,              ELEMN2.......32300
     1      IN,VOL,PMAT,PVEC,UMAT,UVEC,IA,JA)                            ELEMN2.......32400
      END IF                                                             ELEMN2.......32500
 9999 CONTINUE                                                           ELEMN2.......32600
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  ELEMN2.......32700
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  ELEMN2.......32800
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  ELEMN2.......32900
C                                                                        ELEMN2.......33000
C                                                                        ELEMN2.......33100
      RETURN                                                             ELEMN2.......33200
      END                                                                ELEMN2.......33300
C                                                                        ELEMN2.......33400
C     SUBROUTINE        E  L  E  M  N  3           SUTRA VERSION 2.2     ELEMN3.........100
C                                                                        ELEMN3.........200
C *** PURPOSE :                                                          ELEMN3.........300
C ***  TO CONTROL AND CARRY OUT ALL CALCULATIONS FOR EACH ELEMENT BY     ELEMN3.........400
C ***  OBTAINING ELEMENT INFORMATION FROM THE BASIS FUNCTION ROUTINE,    ELEMN3.........500
C ***  CARRYING OUT GAUSSIAN INTEGRATION OF FINITE ELEMENT INTEGRALS,    ELEMN3.........600
C ***  AND ASSEMBLING RESULTS OF ELEMENTWISE INTEGRATIONS INTO           ELEMN3.........700
C ***  A GLOBAL MATRIX AND GLOBAL VECTOR FOR BOTH FLOW AND TRANSPORT     ELEMN3.........800
C ***  EQUATIONS. ALSO CALCULATES VELOCITY AT EACH ELEMENT CENTROID FOR  ELEMN3.........900
C ***  PRINTED OUTPUT. THIS SUBROUTINE HANDLES 3D CALCULATIONS ONLY.     ELEMN3........1000
C ***  2D CALCULATIONS ARE PERFORMED IN SUBROUTINE ELEMN2.               ELEMN3........1100
C                                                                        ELEMN3........1200
C                                                                        ELEMN3........1300
      SUBROUTINE ELEMN3(ML,IN,X,Y,Z,PITER,UITER,RCIT,RCITM1,POR,         ELEMN3........1400
     1   ALMAX,ALMID,ALMIN,ATMAX,ATMID,ATMIN,                            ELEMN3........1500
     2   PERMXX,PERMXY,PERMXZ,PERMYX,PERMYY,PERMYZ,PERMZX,PERMZY,PERMZZ, ELEMN3........1600
     3   PANGL1,PANGL2,PANGL3,VMAG,VANG1,VANG2,VOL,PMAT,PVEC,            ELEMN3........1700
     4   UMAT,UVEC,GXSI,GETA,GZET,PVEL,LREG,IA,JA,POR1,REK) 
C     4   UMAT,UVEC,GXSI,GETA,GZET,PVEL,LREG,IA,JA)                       ELEMN3........1800
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                ELEMN3........1900
      PARAMETER (NCOLMX=9)                                               ELEMN3........2000
      CHARACTER*80 ERRCOD,CHERR(10),UNAME,FNAME(0:13)                    ELEMN3........2100
      DIMENSION IN(NIN),X(NN),Y(NN),Z(NN),PITER(NN),                     ELEMN3........2200
     1   UITER(NN),RCIT(NN),RCITM1(NN),POR(NN),PVEL(NN)                  ELEMN3........2300
      DIMENSION PERMXX(NE),PERMXY(NE),PERMXZ(NE),PERMYX(NE),             ELEMN3........2400
     1   PERMYY(NE),PERMYZ(NE),PERMZX(NE),PERMZY(NE),PERMZZ(NE),         ELEMN3........2500
     2   PANGL1(NE),PANGL2(NE),PANGL3(NE),                               ELEMN3........2600
     3   ALMAX(NE),ALMID(NE),ALMIN(NE),ATMAX(NE),ATMID(NE),ATMIN(NE),    ELEMN3........2700
     4   VMAG(NE),VANG1(NE),VANG2(NE),                                   ELEMN3........2800
     5   GXSI(NE,8),GETA(NE,8),GZET(NE,8),LREG(NE)                       ELEMN3........2900
      DIMENSION POR1(NN),REK(NE)
      DIMENSION VOL(NN),PMAT(NELT,NCBI),PVEC(NNVEC),UMAT(NELT,NCBI),     ELEMN3........3000
     1   UVEC(NNVEC)                                                     ELEMN3........3100
      DIMENSION BFLOWE(8,8),DFLOWE(8),BTRANE(8,8),DTRANE(8,8),VOLE(8)    ELEMN3........3200
      DIMENSION F(8,8),W(8,8),DET(8),DFDXG(8,8),DFDYG(8,8),DFDZG(8,8),   ELEMN3........3300
     1   DWDXG(8,8),DWDYG(8,8),DWDZG(8,8)                                ELEMN3........3400
      DIMENSION SWG(8),RHOG(8),VISCG(8),PORG(8),VXG(8),VYG(8),VZG(8),    ELEMN3........3500
     1   RELKG(8),RGXG(8),RGYG(8),RGZG(8),VGMAG(8)                       ELEMN3........3600
      DIMENSION RXXG(8),RXYG(8),RXZG(8),RYXG(8),RYYG(8),RYZG(8),         ELEMN3........3700
     1   RZXG(8),RZYG(8),RZZG(8)                                         ELEMN3........3800
      DIMENSION BXXG(8),BXYG(8),BXZG(8),BYXG(8),BYYG(8),BYZG(8),         ELEMN3........3900
     1   BZXG(8),BZYG(8),BZZG(8),EXG(8),EYG(8),EZG(8)                    ELEMN3........4000
      DIMENSION GXLOC(8),GYLOC(8),GZLOC(8)                               ELEMN3........4100
      DIMENSION IA(NDIMIA),JA(NDIMJA)                                    ELEMN3........4200
      DIMENSION INERR(10),RLERR(10)                                      ELEMN3........4300
      DIMENSION J5COL(NCOLMX), J6COL(NCOLMX)                             ELEMN3........4400
      DIMENSION KTYPE(2)                                                 ELEMN3........4500
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  ELEMN3........4600
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           ELEMN3........4700
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      ELEMN3........4800
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              ELEMN3........4900
     1   NSOP,NSOU,NBCN,NCIDB                                            ELEMN3........5000
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        ELEMN3........5100
      COMMON /DIMX2/ NELTA, NNVEC, NDIMIA, NDIMJA                        ELEMN3........5200
      COMMON /FNAMES/ UNAME,FNAME                                        ELEMN3........5300
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 ELEMN3........5400
     1   K10,K11,K12,K13                                                 ELEMN3........5500
      COMMON /GRAVEC/ GRAVX,GRAVY,GRAVZ                                  ELEMN3........5600
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS      ELEMN3........5700
      COMMON /JCOLS/ NCOLPR, LCOLPR, NCOLS5, NCOLS6, J5COL, J6COL        ELEMN3........5800
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                ELEMN3........5900
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            ELEMN3........6000
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,      ELEMN3........6100
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2        ELEMN3........6200
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                           ELEMN3........6300
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       ELEMN3........6400
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      ELEMN3........6500
      DATA GLOC/0.577350269189626D0/                                     ELEMN3........6600
      DATA INTIM/0/,ISTOP/0/                                             ELEMN3........6700
      DATA GXLOC/-1.D0,1.D0,1.D0,-1.D0,-1.D0,1.D0,1.D0,-1.D0/            ELEMN3........6800
      DATA GYLOC/-1.D0,-1.D0,1.D0,1.D0,-1.D0,-1.D0,1.D0,1.D0/            ELEMN3........6900
      DATA GZLOC/-1.D0,-1.D0,-1.D0,-1.D0,1.D0,1.D0,1.D0,1.D0/            ELEMN3........7000
      SAVE GLOC,INTIM,ISTOP,GXLOC,GYLOC,GZLOC                            ELEMN3........7100
C                                                                        ELEMN3........7200
C.....DECIDE WHETHER TO CALCULATE CENTROID VELOCITIES ON THIS CALL       ELEMN3........7300
      IVCALC = 0                                                         ELEMN3........7400
      JVCALC = 0                                                         ELEMN3........7500
      IF ((ML.NE.2).AND.(ITER.EQ.1)) IVCALC = 1                          ELEMN3........7600
      IF (IT.EQ.1) IVCALC = 1                                            ELEMN3........7700
      IF ((KVEL.EQ.1).OR.(K6.NE.-1)) JVCALC = 1                          ELEMN3........7800
      KVCALC = IVCALC + JVCALC                                           ELEMN3........7900
C                                                                        ELEMN3........8000
C.....ON FIRST TIME STEP, PREPARE GRAVITY VECTOR COMPONENTS,             ELEMN3........8100
C        GXSI, GETA, AND GZET FOR CONSISTENT VELOCITIES,                 ELEMN3........8200
C        AND CHECK ELEMENT SHAPES                                        ELEMN3........8300
      IF(INTIM) 100,100,2000                                             ELEMN3........8400
  100 INTIM=1                                                            ELEMN3........8500
C.....LOOP THROUGH ALL ELEMENTS TO OBTAIN THE JACOBIAN                   ELEMN3........8600
C        AT EACH OF THE EIGHT NODES IN EACH ELEMENT                      ELEMN3........8700
      DO 1000 L=1,NE                                                     ELEMN3........8800
       DO 500 IL=1,8                                                     ELEMN3........8900
        XLOC=GXLOC(IL)                                                   ELEMN3........9000
        YLOC=GYLOC(IL)                                                   ELEMN3........9100
        ZLOC=GZLOC(IL)                                                   ELEMN3........9200
        CALL BASIS3(0000,L,XLOC,YLOC,ZLOC,IN,X,Y,Z,F(1,IL),W(1,IL),      ELEMN3........9300
     1     DET(IL),DFDXG(1,IL),DFDYG(1,IL),DFDZG(1,IL),                  ELEMN3........9400
     2     DWDXG(1,IL),DWDYG(1,IL),DWDZG(1,IL),PITER,UITER,PVEL,POR,     ELEMN3........9500
     3     VXG(IL),VYG(IL),VZG(IL),SWG(IL),RHOG(IL),VISCG(IL),           ELEMN3........9600
     4     PORG(IL),VGMAG(IL),RELKG(IL),PERMXX,PERMXY,PERMXZ,            ELEMN3........9700
     5     PERMYX,PERMYY,PERMYZ,PERMZX,PERMZY,PERMZZ,                    ELEMN3........9800
     6     CJ11,CJ12,CJ13,CJ21,CJ22,CJ23,CJ31,CJ32,CJ33,                 ELEMN3........9900
     7     GXSI,GETA,GZET,RCIT,RCITM1,RGXG(IL),RGYG(IL),RGZG(IL),LREG
     8     ,POR1)
C     7     GXSI,GETA,GZET,RCIT,RCITM1,RGXG(IL),RGYG(IL),RGZG(IL),LREG)   ELEMN3.......10000
        GXSI(L,IL)=CJ11*GRAVX+CJ12*GRAVY+CJ13*GRAVZ                      ELEMN3.......10100
        GETA(L,IL)=CJ21*GRAVX+CJ22*GRAVY+CJ23*GRAVZ                      ELEMN3.......10200
        GZET(L,IL)=CJ31*GRAVX+CJ32*GRAVY+CJ33*GRAVZ                      ELEMN3.......10300
C.....CHECK FOR NEGATIVE- OR ZERO-AREA ERRORS IN ELEMENT SHAPES          ELEMN3.......10400
        IF(DET(IL)) 200,200,500                                          ELEMN3.......10500
  200   ISTOP=ISTOP+1                                                    ELEMN3.......10600
        WRITE(K3,400) IN((L-1)*8+IL),L,DET(IL)                           ELEMN3.......10700
        WRITE(K00,401) IN((L-1)*8+IL),L,DET(IL)                          ELEMN3.......10800
  400   FORMAT(11X,'THE DETERMINANT OF THE JACOBIAN AT NODE ',I9,        ELEMN3.......10900
     1     ' IN ELEMENT ',I9,' IS NEGATIVE OR ZERO, ',1PE15.7)           ELEMN3.......11000
  401   FORMAT(1X,'THE DETERMINANT OF THE JACOBIAN AT NODE ',I9,         ELEMN3.......11100
     1     ' IN ELEMENT ',I9,' IS NEGATIVE OR ZERO, ',1PE15.7)           ELEMN3.......11200
  500  CONTINUE                                                          ELEMN3.......11300
 1000 CONTINUE                                                           ELEMN3.......11400
C                                                                        ELEMN3.......11500
      IF(ISTOP.EQ.0) GOTO 2000                                           ELEMN3.......11600
      ERRCOD = 'INP-14B,22-1'                                            ELEMN3.......11700
      CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                           ELEMN3.......11800
C                                                                        ELEMN3.......11900
C.....LOOP THROUGH ALL ELEMENTS TO CARRY OUT SPATIAL INTEGRATION         ELEMN3.......12000
C        OF FLUX TERMS IN P AND/OR U EQUATIONS                           ELEMN3.......12100
 2000 IF(IUNSAT.NE.0) IUNSAT=2                                           ELEMN3.......12200
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  ELEMN3.......12300
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  ELEMN3.......12400
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  ELEMN3.......12500
      DO 9999 L=1,NE                                                     ELEMN3.......12600
       XIX=-1.D0                                                         ELEMN3.......12700
       YIY=-1.D0                                                         ELEMN3.......12800
       ZIZ=-1.D0                                                         ELEMN3.......12900
       KG=0                                                              ELEMN3.......13000
C.....OBTAIN BASIS FUNCTION AND RELATED INFORMATION AT EACH OF           ELEMN3.......13100
C        EIGHT GAUSS POINTS IN THE ELEMENT                               ELEMN3.......13200
       DO 2250 IZL=1,2                                                   ELEMN3.......13300
        DO 2200 IYL=1,2                                                  ELEMN3.......13400
         DO 2100 IXL=1,2                                                 ELEMN3.......13500
          KG=KG+1                                                        ELEMN3.......13600
          XLOC=XIX*GLOC                                                  ELEMN3.......13700
          YLOC=YIY*GLOC                                                  ELEMN3.......13800
          ZLOC=ZIZ*GLOC                                                  ELEMN3.......13900
          CALL BASIS3(0001,L,XLOC,YLOC,ZLOC,IN,X,Y,Z,F(1,KG),W(1,KG),    ELEMN3.......14000
     1       DET(KG),DFDXG(1,KG),DFDYG(1,KG),DFDZG(1,KG),                ELEMN3.......14100
     2       DWDXG(1,KG),DWDYG(1,KG),DWDZG(1,KG),PITER,UITER,PVEL,POR,   ELEMN3.......14200
     3       VXG(KG),VYG(KG),VZG(KG),SWG(KG),RHOG(KG),VISCG(KG),         ELEMN3.......14300
     4       PORG(KG),VGMAG(KG),RELKG(KG),PERMXX,PERMXY,PERMXZ,          ELEMN3.......14400
     5       PERMYX,PERMYY,PERMYZ,PERMZX,PERMZY,PERMZZ,                  ELEMN3.......14500
     6       CJ11,CJ12,CJ13,CJ21,CJ22,CJ23,CJ31,CJ32,CJ33,               ELEMN3.......14600
     7       GXSI,GETA,GZET,RCIT,RCITM1,RGXG(KG),RGYG(KG),RGZG(KG),LREG
     8       ,POR1)
C     7       GXSI,GETA,GZET,RCIT,RCITM1,RGXG(KG),RGYG(KG),RGZG(KG),LREG) ELEMN3.......14700
 2100     XIX=-XIX                                                       ELEMN3.......14800
 2200    YIY=-YIY                                                        ELEMN3.......14900
 2250   ZIZ=-ZIZ                                                         ELEMN3.......15000
C                                                                        ELEMN3.......15100
C.....CALCULATE VELOCITY AT ELEMENT CENTROID WHEN REQUIRED               ELEMN3.......15200
       IF(KVCALC-2) 3000,2300,3000                                       ELEMN3.......15300
 2300  AXSUM=0.0D0                                                       ELEMN3.......15400
       AYSUM=0.0D0                                                       ELEMN3.......15500
       AZSUM=0.0D0                                                       ELEMN3.......15600
       DO 2400 KG=1,8                                                    ELEMN3.......15700
        AXSUM=AXSUM+VXG(KG)                                              ELEMN3.......15800
        AYSUM=AYSUM+VYG(KG)                                              ELEMN3.......15900
 2400   AZSUM=AZSUM+VZG(KG)                                              ELEMN3.......16000
       VMAG(L)=DSQRT(AXSUM*AXSUM+AYSUM*AYSUM+AZSUM*AZSUM)                ELEMN3.......16100
       IF (VMAG(L).NE.0D0) THEN                                          ELEMN3.......16200
          VANG2(L)=DASIN(AZSUM/VMAG(L))*5.729577951308232D+1             ELEMN3.......16300
          VMAG(L)=VMAG(L)*1.25D-1                                        ELEMN3.......16400
          VANG1(L)=DATAN2(AYSUM,AXSUM)*5.729577951308232D+1              ELEMN3.......16500
       ELSE                                                              ELEMN3.......16600
          VANG1(L)=0D0                                                   ELEMN3.......16700
          VANG2(L)=0D0                                                   ELEMN3.......16800
       END IF                                                            ELEMN3.......16900
C                                                                        ELEMN3.......17000
 3000  CONTINUE                                                          ELEMN3.......17100
C                                                                        ELEMN3.......17200
C.....CALCULATE PARAMETERS FOR FLUID MASS BALANCE AT GAUSS POINTS        ELEMN3.......17300
       IF(ML-1) 3400,3400,6100                                           ELEMN3.......17400
 3400  SWTEST=0.D0                                                       ELEMN3.......17500
       DO 4000 KG=1,8                                                    ELEMN3.......17600
        SWTEST=SWTEST+SWG(KG)                                            ELEMN3.......17700
        ROMG=RHOG(KG)*RELKG(KG)/VISCG(KG)                                ELEMN3.......17800
        RXXG(KG)=PERMXX(L)*ROMG                                          ELEMN3.......17900
        RXYG(KG)=PERMXY(L)*ROMG                                          ELEMN3.......18000
        RXZG(KG)=PERMXZ(L)*ROMG                                          ELEMN3.......18100
        RYXG(KG)=PERMYX(L)*ROMG                                          ELEMN3.......18200
        RYYG(KG)=PERMYY(L)*ROMG                                          ELEMN3.......18300
        RYZG(KG)=PERMYZ(L)*ROMG                                          ELEMN3.......18400
        RZXG(KG)=PERMZX(L)*ROMG                                          ELEMN3.......18500
        RZYG(KG)=PERMZY(L)*ROMG                                          ELEMN3.......18600
        RZZG(KG)=PERMZZ(L)*ROMG                                          ELEMN3.......18700
 4000   CONTINUE                                                         ELEMN3.......18800
C                                                                        ELEMN3.......18900
C.....INTEGRATE FLUID MASS BALANCE IN AN UNSATURATED ELEMENT             ELEMN3.......19000
C        USING ASYMMETRIC WEIGHTING FUNCTIONS                            ELEMN3.......19100
       IF(UP.LE.1.0D-6) GOTO 5200                                        ELEMN3.......19200
       IF(SWTEST-3.999D0) 4200,5200,5200                                 ELEMN3.......19300
 4200  DO 4300 I=1,8                                                     ELEMN3.......19400
        VOLE(I) = 0.D0                                                   ELEMN3.......19500
        DFLOWE(I) = 0.D0                                                 ELEMN3.......19600
        DO 4300 J=1,8                                                    ELEMN3.......19700
         BFLOWE(I,J) = 0.D0                                              ELEMN3.......19800
 4300  CONTINUE                                                          ELEMN3.......19900
       DO 5000 KG=1,8                                                    ELEMN3.......20000
        RXXGD = RXXG(KG)*DET(KG)                                         ELEMN3.......20100
        RXYGD = RXYG(KG)*DET(KG)                                         ELEMN3.......20200
        RXZGD = RXZG(KG)*DET(KG)                                         ELEMN3.......20300
        RYXGD = RYXG(KG)*DET(KG)                                         ELEMN3.......20400
        RYYGD = RYYG(KG)*DET(KG)                                         ELEMN3.......20500
        RYZGD = RYZG(KG)*DET(KG)                                         ELEMN3.......20600
        RZXGD = RZXG(KG)*DET(KG)                                         ELEMN3.......20700
        RZYGD = RZYG(KG)*DET(KG)                                         ELEMN3.......20800
        RZZGD = RZZG(KG)*DET(KG)                                         ELEMN3.......20900
        RDRX = RXXGD*RGXG(KG) + RXYGD*RGYG(KG) + RXZGD*RGZG(KG)          ELEMN3.......21000
        RDRY = RYXGD*RGXG(KG) + RYYGD*RGYG(KG) + RYZGD*RGZG(KG)          ELEMN3.......21100
        RDRZ = RZXGD*RGXG(KG) + RZYGD*RGYG(KG) + RZZGD*RGZG(KG)          ELEMN3.......21200
        DO 4400 I=1,8                                                    ELEMN3.......21300
         VOLE(I) = VOLE(I) + F(I,KG)*DET(KG)                             ELEMN3.......21400
         DFLOWE(I) = DFLOWE(I) + RDRX*DWDXG(I,KG) + RDRY*DWDYG(I,KG)     ELEMN3.......21500
     1               + RDRZ*DWDZG(I,KG)                                  ELEMN3.......21600
 4400   CONTINUE                                                         ELEMN3.......21700
        DO 5000 J=1,8                                                    ELEMN3.......21800
         RDDFJX = RXXGD*DFDXG(J,KG) + RXYGD*DFDYG(J,KG)                  ELEMN3.......21900
     1            + RXZGD*DFDZG(J,KG)                                    ELEMN3.......22000
         RDDFJY = RYXGD*DFDXG(J,KG) + RYYGD*DFDYG(J,KG)                  ELEMN3.......22100
     1            + RYZGD*DFDZG(J,KG)                                    ELEMN3.......22200
         RDDFJZ = RZXGD*DFDXG(J,KG) + RZYGD*DFDYG(J,KG)                  ELEMN3.......22300
     1            + RZZGD*DFDZG(J,KG)                                    ELEMN3.......22400
         DO 5000 I=1,8                                                   ELEMN3.......22500
          BFLOWE(I,J) = BFLOWE(I,J) + DWDXG(I,KG)*RDDFJX                 ELEMN3.......22600
     1                  + DWDYG(I,KG)*RDDFJY + DWDZG(I,KG)*RDDFJZ        ELEMN3.......22700
 5000  CONTINUE                                                          ELEMN3.......22800
       GOTO 6050                                                         ELEMN3.......22900
C                                                                        ELEMN3.......23000
C.....INTEGRATE FLUID MASS BALANCE IN A SATURATED OR UNSATURATED         ELEMN3.......23100
C        ELEMENT USING SYMMETRIC WEIGHTING FUNCTIONS                     ELEMN3.......23200
 5200  DO 5300 I=1,8                                                     ELEMN3.......23300
        VOLE(I) = 0.D0                                                   ELEMN3.......23400
        DFLOWE(I) = 0.D0                                                 ELEMN3.......23500
        DO 5300 J=1,8                                                    ELEMN3.......23600
         BFLOWE(I,J) = 0.D0                                              ELEMN3.......23700
 5300  CONTINUE                                                          ELEMN3.......23800
       DO 6000 KG=1,8                                                    ELEMN3.......23900
        RXXGD = RXXG(KG)*DET(KG)                                         ELEMN3.......24000
        RXYGD = RXYG(KG)*DET(KG)                                         ELEMN3.......24100
        RXZGD = RXZG(KG)*DET(KG)                                         ELEMN3.......24200
        RYXGD = RYXG(KG)*DET(KG)                                         ELEMN3.......24300
        RYYGD = RYYG(KG)*DET(KG)                                         ELEMN3.......24400
        RYZGD = RYZG(KG)*DET(KG)                                         ELEMN3.......24500
        RZXGD = RZXG(KG)*DET(KG)                                         ELEMN3.......24600
        RZYGD = RZYG(KG)*DET(KG)                                         ELEMN3.......24700
        RZZGD = RZZG(KG)*DET(KG)                                         ELEMN3.......24800
        RDRX = RXXGD*RGXG(KG) + RXYGD*RGYG(KG) + RXZGD*RGZG(KG)          ELEMN3.......24900
        RDRY = RYXGD*RGXG(KG) + RYYGD*RGYG(KG) + RYZGD*RGZG(KG)          ELEMN3.......25000
        RDRZ = RZXGD*RGXG(KG) + RZYGD*RGYG(KG) + RZZGD*RGZG(KG)          ELEMN3.......25100
        DO 5400 I=1,8                                                    ELEMN3.......25200
         VOLE(I) = VOLE(I) + F(I,KG)*DET(KG)                             ELEMN3.......25300
         DFLOWE(I) = DFLOWE(I) + RDRX*DFDXG(I,KG) + RDRY*DFDYG(I,KG)     ELEMN3.......25400
     1               + RDRZ*DFDZG(I,KG)                                  ELEMN3.......25500
 5400   CONTINUE                                                         ELEMN3.......25600
        DO 6000 J=1,8                                                    ELEMN3.......25700
         RDDFJX = RXXGD*DFDXG(J,KG) + RXYGD*DFDYG(J,KG)                  ELEMN3.......25800
     1            + RXZGD*DFDZG(J,KG)                                    ELEMN3.......25900
         RDDFJY = RYXGD*DFDXG(J,KG) + RYYGD*DFDYG(J,KG)                  ELEMN3.......26000
     1            + RYZGD*DFDZG(J,KG)                                    ELEMN3.......26100
         RDDFJZ = RZXGD*DFDXG(J,KG) + RZYGD*DFDYG(J,KG)                  ELEMN3.......26200
     1            + RZZGD*DFDZG(J,KG)                                    ELEMN3.......26300
         DO 6000 I=1,8                                                   ELEMN3.......26400
          BFLOWE(I,J) = BFLOWE(I,J) + DFDXG(I,KG)*RDDFJX                 ELEMN3.......26500
     1                  + DFDYG(I,KG)*RDDFJY + DFDZG(I,KG)*RDDFJZ        ELEMN3.......26600
 6000  CONTINUE                                                          ELEMN3.......26700
 6050  CONTINUE                                                          ELEMN3.......26800
       IF(ML-1) 6100,9000,6100                                           ELEMN3.......26900
 6100  IF(NOUMAT.EQ.1) GOTO 9000                                         ELEMN3.......27000
C                                                                        ELEMN3.......27100
C                                                                        ELEMN3.......27200
C.....CALCULATE PARAMETERS FOR ENERGY BALANCE OR SOLUTE MASS BALANCE     ELEMN3.......27300
C        AT GAUSS POINTS                                                 ELEMN3.......27400
       DO 7000 KG=1,8                                                    ELEMN3.......27500
        ESWG=PORG(KG)*SWG(KG)                                            ELEMN3.......27600
        RHOCWG=RHOG(KG)*CW                                               ELEMN3.......27700
        ESRCG=ESWG*RHOCWG                                                ELEMN3.......27800
        IF(VGMAG(KG)) 6300,6300,6600                                     ELEMN3.......27900
 6300   EXG(KG)=0.0D0                                                    ELEMN3.......28000
        EYG(KG)=0.0D0                                                    ELEMN3.......28100
        EZG(KG)=0.0D0                                                    ELEMN3.......28200
        DXXG=0.0D0                                                       ELEMN3.......28300
        DXYG=0.0D0                                                       ELEMN3.......28400
        DXZG=0.0D0                                                       ELEMN3.......28500
        DYXG=0.0D0                                                       ELEMN3.......28600
        DYYG=0.0D0                                                       ELEMN3.......28700
        DYZG=0.0D0                                                       ELEMN3.......28800
        DZXG=0.0D0                                                       ELEMN3.......28900
        DZYG=0.0D0                                                       ELEMN3.......29000
        DZZG=0.0D0                                                       ELEMN3.......29100
        GOTO 6900                                                        ELEMN3.......29200
 6600   EXG(KG)=ESRCG*VXG(KG)                                            ELEMN3.......29300
        EYG(KG)=ESRCG*VYG(KG)                                            ELEMN3.......29400
        EZG(KG)=ESRCG*VZG(KG)                                            ELEMN3.......29500
C                                                                        ELEMN3.......29600
C                                                                        ELEMN3.......29700
C.....DISPERSIVITY MODEL FOR 3D ANISOTROPIC MEDIA                        ELEMN3.......29800
C        WITH PRINCIPAL DISPERSIVITIES ALMAX, ALMID, ALMIN,              ELEMN3.......29900
C        ATMAX, ATMID, ATMIN                                             ELEMN3.......30000
        CALL DISPR3(VXG(KG),VYG(KG),VZG(KG),VGMAG(KG),PANGL1(L),         ELEMN3.......30100
     1     PANGL2(L),PANGL3(L),ALMAX(L),ALMID(L),ALMIN(L),               ELEMN3.......30200
     2     ATMAX(L),ATMID(L),ATMIN(L),DXXG,DXYG,DXZG,DYXG,DYYG,DYZG,     ELEMN3.......30300
     3     DZXG,DZYG,DZZG)                                               ELEMN3.......30400
C                                                                        ELEMN3.......30500
C.....IN-PARALLEL CONDUCTIVITIES (DIFFUSIVITIES) FORMULA                 ELEMN3.......30600
 6900   IF (ME.EQ.1) THEN                                                ELEMN3.......30700
C..........FOR ENERGY TRANSPORT:                                         ELEMN3.......30800
           ESE = ESWG*SIGMAW + (1D0-PORG(KG))*SIGMAS                     ELEMN3.......30900
        ELSE                                                             ELEMN3.......31000
C..........FOR SOLUTE TRANSPORT:                                         ELEMN3.......31100
           ESE = ESRCG*SIGMAW + (1D0-PORG(KG))*RHOCWG*SIGMAS             ELEMN3.......31200
        END IF                                                           ELEMN3.......31300
C.....ADD DIFFUSION AND DISPERSION TERMS TO TOTAL DISPERSION TENSOR      ELEMN3.......31400
        BXXG(KG)=ESRCG*DXXG+ESE                                          ELEMN3.......31500
        BXYG(KG)=ESRCG*DXYG                                              ELEMN3.......31600
        BXZG(KG)=ESRCG*DXZG                                              ELEMN3.......31700
        BYXG(KG)=ESRCG*DYXG                                              ELEMN3.......31800
        BYYG(KG)=ESRCG*DYYG+ESE                                          ELEMN3.......31900
        BYZG(KG)=ESRCG*DYZG                                              ELEMN3.......32000
        BZXG(KG)=ESRCG*DZXG                                              ELEMN3.......32100
        BZYG(KG)=ESRCG*DZYG                                              ELEMN3.......32200
 7000   BZZG(KG)=ESRCG*DZZG+ESE                                          ELEMN3.......32300
C                                                                        ELEMN3.......32400
C.....INTEGRATE SOLUTE MASS BALANCE OR ENERGY BALANCE                    ELEMN3.......32500
C        USING SYMMETRIC WEIGHTING FUNCTIONS FOR DISPERSION TERM AND     ELEMN3.......32600
C        USING EITHER SYMMETRIC OR ASYMMETRIC WEIGHTING FUNCTIONS        ELEMN3.......32700
C        FOR ADVECTION TERM                                              ELEMN3.......32800
         DO 7400 I=1,8                                                   ELEMN3.......32900
         DO 7400 J=1,8                                                   ELEMN3.......33000
            BTRANE(I,J) = 0.D0                                           ELEMN3.......33100
            DTRANE(I,J) = 0.D0                                           ELEMN3.......33200
 7400    CONTINUE                                                        ELEMN3.......33300
         DO 8000 KG=1,8                                                  ELEMN3.......33400
            BXXGD = BXXG(KG)*DET(KG)                                     ELEMN3.......33500
            BXYGD = BXYG(KG)*DET(KG)                                     ELEMN3.......33600
            BXZGD = BXZG(KG)*DET(KG)                                     ELEMN3.......33700
            BYXGD = BYXG(KG)*DET(KG)                                     ELEMN3.......33800
            BYYGD = BYYG(KG)*DET(KG)                                     ELEMN3.......33900
            BYZGD = BYZG(KG)*DET(KG)                                     ELEMN3.......34000
            BZXGD = BZXG(KG)*DET(KG)                                     ELEMN3.......34100
            BZYGD = BZYG(KG)*DET(KG)                                     ELEMN3.......34200
            BZZGD = BZZG(KG)*DET(KG)                                     ELEMN3.......34300
            EXGD = EXG(KG)*DET(KG)                                       ELEMN3.......34400
            EYGD = EYG(KG)*DET(KG)                                       ELEMN3.......34500
            EZGD = EZG(KG)*DET(KG)                                       ELEMN3.......34600
            DO 8000 J=1,8                                                ELEMN3.......34700
               BDDFJX = BXXGD*DFDXG(J,KG) + BXYGD*DFDYG(J,KG)            ELEMN3.......34800
     1                 + BXZGD*DFDZG(J,KG)                               ELEMN3.......34900
               BDDFJY = BYXGD*DFDXG(J,KG) + BYYGD*DFDYG(J,KG)            ELEMN3.......35000
     1                 + BYZGD*DFDZG(J,KG)                               ELEMN3.......35100
               BDDFJZ = BZXGD*DFDXG(J,KG) + BZYGD*DFDYG(J,KG)            ELEMN3.......35200
     1                 + BZZGD*DFDZG(J,KG)                               ELEMN3.......35300
               EDDFJ = EXGD*DFDXG(J,KG) + EYGD*DFDYG(J,KG)               ELEMN3.......35400
     1                 + EZGD*DFDZG(J,KG)                                ELEMN3.......35500
               DO 8000 I=1,8                                             ELEMN3.......35600
                  BTRANE(I,J) = BTRANE(I,J) + DFDXG(I,KG)*BDDFJX         ELEMN3.......35700
     1               + DFDYG(I,KG)*BDDFJY + DFDZG(I,KG)*BDDFJZ           ELEMN3.......35800
                  DTRANE(I,J) = DTRANE(I,J) + EDDFJ*W(I,KG)              ELEMN3.......35900
 8000    CONTINUE                                                        ELEMN3.......36000
 9000  CONTINUE                                                          ELEMN3.......36100
C                                                                        ELEMN3.......36200
C                                                                        ELEMN3.......36300
C.....SEND RESULTS OF INTEGRATIONS FOR THIS ELEMENT                      ELEMN3.......36400
C        TO GLOBAL ASSEMBLY ROUTINE:                                     ELEMN3.......36500
C        GLOBAN -- SUTRA'S ORIGINAL BANDED FORMAT                        ELEMN3.......36600
C        GLOCOL -- SLAP COLUMN FORMAT                                    ELEMN3.......36700
      IF (KSOLVP.EQ.0) THEN                                              ELEMN3.......36800
         CALL GLOBAN(L,ML,VOLE,BFLOWE,DFLOWE,BTRANE,DTRANE,              ELEMN3.......36900
     1      IN,VOL,PMAT,PVEC,UMAT,UVEC)                                  ELEMN3.......37000
      ELSE                                                               ELEMN3.......37100
         CALL GLOCOL(L,ML,VOLE,BFLOWE,DFLOWE,BTRANE,DTRANE,              ELEMN3.......37200
     1      IN,VOL,PMAT,PVEC,UMAT,UVEC,IA,JA)                            ELEMN3.......37300
      END IF                                                             ELEMN3.......37400
 9999 CONTINUE                                                           ELEMN3.......37500
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  ELEMN3.......37600
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  ELEMN3.......37700
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  ELEMN3.......37800
C                                                                        ELEMN3.......37900
C                                                                        ELEMN3.......38000
      RETURN                                                             ELEMN3.......38100
      END                                                                ELEMN3.......38200
C                                                                        ELEMN3.......38300
C *** ASSIGNING EVAPORATION RATE THROUGH RELEVANT FUNCTIONS
C *** WHEN QET=1 THEN USING PENMAN (1948) EQUATION, THIS IS FURTHER MODIFIED BY KONUKCU (2007)
C *** WHEN QET=2 THEN USING PDV (1957) EQUATION.
C *** SEE NOTEBOOK2 PAGE47 FOR FURTHER EXPLANATION 
      SUBROUTINE EVAPORATION (AET,PC,CC,RHO,WMA,SM,HM,HO,DELL,TAUTH,DFR
     1,PWFR,PCFR,RSC,TSK,POR,SW,KREG)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      COMMON /ET/ QET,UET,PET,UVM,NGT,ITE,TMA,TMI,ALF,RS,RH,AP,BP,U2,
     1   TSD,SCF
      COMMON /AERORESIS/ RAVT,RAVS,SWRAT
      COMMON /SALTRESIS/ AR,BR
      COMMON /GRAVEC/ GRAVX,GRAVY,GRAVZ 
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,     
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2   
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD, 
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
      DIMENSION KTYPE(2)
      DOUBLE PRECISION SBC,GAM
      DATA  SBC /4.896E-9/, GAM /6.6E-2/, DP/1.8E+0/
      SAVE SBC,GAM,DP

C     AET  -- ACTUAL EVAPORATION RATE [MM/DAY]
C     PC   -- PRESSURE AT THE SPECIFIED NODE [KG/M/S2]
C     CC   -- CONCENTRATION AT THE SPECIFIED NODE  [KG/KG]
C     RHO  -- DENSITY OF THE SPECIFIED NODE [KG/M2]
C     TMA  -- AIR TEMPERATURE [CELSIUS]
C     TMI  -- SOIL SURFACE TEMPERATURE [CELSIUS]
C     TM   -- MEAN DAILY AIR TEMPERATURE [CELSIUS]
C     DLT  -- SLOPE OF SATURATION VAPOR PRESSURE CURVE E/T  [KPA/CELSIUS]
C     VLH  -- LATENT HEAT OF VAPORISATION [J/KG] 
C     ALF  -- ALBEDO [I]
C     RS   -- SHORT WAVE INCOMING RADIATION  [MJ/M2/DAY]
C     RH   -- RELATIVE HUMIDITY 0<RH<1
C     ED   -- SATURATED VAPOUR PRESSURE AT DEW POINT [KPA]
C     EMI  -- EMMISIVITY [I]
C     RN   -- NET RADIANT ENERGY 
C     GAM  -- PSYCHROMETRIC CONSTANT [KPA/CELSIUS]
C     EO(NOT ZERO)   -- SATURATED VAPOUR PRESSURE AT MEAN DAILY AIR TEMP. (TM) [PA]
C     FU   -- WIND FUNCTION [MJ/M2/KPA/DAY]
C     AP,BP-- PARAMETER IN WIND FUNCTION
C     U2   -- DAILY MEAN WIND SPEED AT 2M ABOVE GROUND [KM/DAY]
C     RC   -- UNIVERSAL GAS CONSTANT [J/MOL/K]
C     WMW   -- MOLECULAR WEIGHT OF WATER [KG/MOL]
C     TS   -- SOIL TEMPERATURE [CELSIUS]
C     DP   -- VAN'T HOFF DISSOCIATION FACTOR
C     STM  -- MOLECULAR WEIGHT OF NACL [KG/MOL]
C     FIO(NOT ZERO)  -- OSMOTIC POTENTIALS (M)
C     HO(NOT ZERO)   -- OSMOTIC PARAMETER
C     RHOW0   -- INITIAL WATER DENSITY (KG/M3)
C      TSK   -- TEMPERATURE AT THAT NODE
C      TMAK   -- TEMPERATURE AT THAT NODE  
C ... PEMAN METHOD ...      
      IF (MET.EQ.1) THEN ! USING PENMAN EVAPORATION EQUATION
      TMAK=273.15D0+TMA                                                               ! AIR TEMPERATURE TMAK=(TMA-273.15D0)
      VLH=(2.50025-0.002365*(TMAK-273.15D0))*1.D6                                     ! LATENT HEAT FOR VAPORIZATION   [J/KG]
      CGA=17.271*(TMAK-273.15D0)/(237.7+(TMAK-273.15D0))+LOG(RH)                        ! CAPITAL GAMA FOR CALCULATING DEW POINT TEMP.
      TD=237.7*CGA/(17.271-CGA)+273.15                                              ! DEW POINT [K]
C      EMI=0.34-0.139*SQRT(ED)                                                       ! EMMISIVITY [I]
C      RN=RS*(1-ALF)-EMI*SBC*((TMA+273.15)**4+(TMI+273.15)**4)/2
C      FU=AP+BP*U2
C.....EQUATION FROM KONUKCU OBVIOUSLY THIS EQUATION IS DODGY
C      FIO=-RC*(TS+273.15)*(CC*RHO/STM)*DP/DABS(GRAVY)/RHO
C.....END OF KONUKCU EQUATION
C.....START OF FUJIMAKI EQUATION FOR CALCULATING SOIL RELATIVE HUMIDITY
C..... 0.204=0.102*2
      RMG=0.D0                                                                     ! THIS IS (RN-G) WHICH CHANGES OVER TIME
      HO=EXP(-WMW*2.D0*CHI(CC)*CC/STM)
      HM=EXP(WMW*PC/RHOW0/RC/TSK)
      DFR=RSC                                                                       ! OUTPUT 
      PWFR=HO                                                                       ! OUTPUT
      PCFR=HM                                                                       ! OUTPUT

      CA=1013.D0                               ! SPECIFIC HEAT OF AIR AT CONSTANT TEMP [1013 J/KG/K]
      PA=1.01D5                                ! ATMOSPHEREIC PRESSURE                 [PA]
      DMOA=0.02897                              ! MOLECULAR WEIGHT OF AIR (KG/MOL)       

      RHOA=PA*DMOA/RC/TMAK
      GAMA=66.D0                               ! PSYCHOMETRIC CONSTANT  [PA/K]
      DLNUM=HO*HM*PSAT(2,TMAK)*RMG
      DRNUM=CA*RHOA/RAVT*(HO*HM*PSAT(1,TMAK)-PSAT(1,TD))
      DENO=VLH*RHOW0*(HO*HM*PSAT(2,TMAK)+GAMA*(RAVT+RSC)/RAVT)
      AET=-(DLNUM+DRNUM)/DENO
C      FIO=-0.204*X*CC/STM*RC*(TS+273.15)
C.....END OF FUJIMAKI EQUATION
C      AA=PC/RHO
C      BB=PC/RHO/9.81
C      HM=EXP(WMW*(PC/RHO)/RC/(TS+273.15))
C      HO=EXP(WMW*DABS(GRAVY)*FIO/RC/(TS+273.15))

C      AET=-(HM*HO*DLT*RN+GAM*(HM*HO*EO-ED)*FU)/VLH/(DLT+GAM)
C        IF (AET.GT.0) THEN
C        AET=0
C        ENDIF

C ... DIRECT METHOD OF CALCULATING EVAPORATION        ! SEE NOTEBOOK3 P5
      ELSEIF (MET.EQ.2) THEN                          ! USING VAPOR FLOW EQUATION
      TMAK=273.15D0+TMA                                 ! AIR TEMPERATURE TMAK=(TMA-273.15D0)
      TERM1=WMW/RHOW0/RC
      HO=EXP(-WMW*2.D0*CHI(CC)*CC/STM)         ! RELATIVE HUMIDITY INDUCED BY OSMOTICAL POTENTIAL 
      HM=EXP(WMW*PC/RHOW0/RC/TSK)              ! RELATIVE HUMIDITY INDUCED BY MATRIC POTENTIAL
      DFR=RSC                                         ! DFR, PWFR AND PCFR IS USED FOR OUTPUT IN .BCOF
      PWFR=HO
      PCFR=HM
      SURF=SURFRSIS(PC,POR,SW,MSR,KREG,TSK)
      AET=-TERM1*(PSAT(1,TSK)*HO*HM/TSK-PSAT(1,TMAK)*RH/TMAK)/(RAVT
     1 +SURF+RSC)
      WRITE(48,49) SURF,SW,PC,TSK,HO,HM,AET
49    FORMAT(7(1PE15.7))
       ENDIF
      RETURN
      END

C      WHEN N=1, IT CALCULATES SATURATED VAPOR PRESSURE
C      WHEN N=2, IT CALCULATES THE DERIVATIVE OF SATURATED VAPOR PRESSURE TO T 
      DOUBLE PRECISION FUNCTION PSAT(N,TK)
      IMPLICIT DOUBLE PRECISION (A-H, O-Z) 
      IF (N.EQ.1) THEN
      PSAT=6.11D2*EXP(17.27*(TK-273.15)/(TK-35.85))    !SATURATED VAPOR PRESSURE AT TEMP TK
      ELSEIF (N.EQ.2)THEN
      PSAT=2.504D6/(TK-35.85D0)**2.D0*
     1    EXP(17.27D0*(TK-273.15D0)/(TK-35.85D0))      !DELTA P  = DP/DT  
      ENDIF
      RETURN
      END

C     SUBROUTINE        F  I  N  D  L  2           SUTRA VERSION 2.2     FINDL2.........100
C                                                                        FINDL2.........200
C *** PURPOSE :                                                          FINDL2.........300
C ***  TO DETERMINE WHETHER POINT (XK, YK) IN 2D GLOBAL COORDINATES      FINDL2.........400
C ***  IS CONTAINED WITHIN ELEMENT LL.  IF THE POINT IS INSIDE THE       FINDL2.........500
C ***  ELEMENT, SET INOUT = 1; IF OUTSIDE, SET INOUT = 0.  CONDITION     FINDL2.........600
C ***  INOUT = 99 SIGNALS CONVERGENCE FAILURE.  ADAPTED FROM SUTRAPLOT   FINDL2.........700
C ***  SUBROUTINE ITER2D.                                                FINDL2.........800
C                                                                        FINDL2.........900
      SUBROUTINE FINDL2(X,Y,IN,LL,XK,YK,XSI,ETA,INOUT)                   FINDL2........1000
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                FINDL2........1100
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              FINDL2........1200
     1   NSOP,NSOU,NBCN,NCIDB                                            FINDL2........1300
      DIMENSION IN(NE*4)                                                 FINDL2........1400
      DIMENSION X(NN), Y(NN)                                             FINDL2........1500
      DATA TOL /0.001/, ITRMAX /25/, EPSILON /0.001/                     FINDL2........1600
C                                                                        FINDL2........1700
C.....DEFINE OPE = (1. + EPSILON) FOR CONVENIENCE.                       FINDL2........1800
      OPE = 1D0 + EPSILON                                                FINDL2........1900
C                                                                        FINDL2........2000
C.....SET CORNER COORDINATES.                                            FINDL2........2100
      M0 = (LL - 1)*4                                                    FINDL2........2200
      X1 = X(IN(M0+1))                                                   FINDL2........2300
      X2 = X(IN(M0+2))                                                   FINDL2........2400
      X3 = X(IN(M0+3))                                                   FINDL2........2500
      X4 = X(IN(M0+4))                                                   FINDL2........2600
      Y1 = Y(IN(M0+1))                                                   FINDL2........2700
      Y2 = Y(IN(M0+2))                                                   FINDL2........2800
      Y3 = Y(IN(M0+3))                                                   FINDL2........2900
      Y4 = Y(IN(M0+4))                                                   FINDL2........3000
C                                                                        FINDL2........3100
C.....CALCULATE COEFFICIENTS.                                            FINDL2........3200
      AX = +X1+X2+X3+X4                                                  FINDL2........3300
      BX = -X1+X2+X3-X4                                                  FINDL2........3400
      CX = -X1-X2+X3+X4                                                  FINDL2........3500
      DX = +X1-X2+X3-X4                                                  FINDL2........3600
      AY = +Y1+Y2+Y3+Y4                                                  FINDL2........3700
      BY = -Y1+Y2+Y3-Y4                                                  FINDL2........3800
      CY = -Y1-Y2+Y3+Y4                                                  FINDL2........3900
      DY = +Y1-Y2+Y3-Y4                                                  FINDL2........4000
                                                                         FINDL2........4100
C                                                                        FINDL2........4200
C.....INITIAL GUESS OF ZERO FOR XSI AND ETA.                             FINDL2........4300
      XSI=0.0                                                            FINDL2........4400
      ETA=0.0                                                            FINDL2........4500
C                                                                        FINDL2........4600
C.....ITERATION LOOP TO SOLVE FOR LOCAL COORDINATES.                     FINDL2........4700
C                                                                        FINDL2........4800
      DO 800 I=1,ITRMAX                                                  FINDL2........4900
C                                                                        FINDL2........5000
         F10 = AX - 4.*XK + BX*XSI + CX*ETA + DX*XSI*ETA                 FINDL2........5100
         F20 = AY - 4.*YK + BY*XSI + CY*ETA + DY*XSI*ETA                 FINDL2........5200
         FP11 = BX + DX*ETA                                              FINDL2........5300
         FP12 = CX + DX*XSI                                              FINDL2........5400
         FP21 = BY + DY*ETA                                              FINDL2........5500
         FP22 = CY + DY*XSI                                              FINDL2........5600
C                                                                        FINDL2........5700
         DETXSI = -F10*FP22 + F20*FP12                                   FINDL2........5800
         DETETA = -F20*FP11 + F10*FP21                                   FINDL2........5900
         DETERM = FP11*FP22 - FP12*FP21                                  FINDL2........6000
         DELXSI = DETXSI/DETERM                                          FINDL2........6100
         DELETA = DETETA/DETERM                                          FINDL2........6200
C                                                                        FINDL2........6300
         XSI = XSI + DELXSI                                              FINDL2........6400
         ETA = ETA + DELETA                                              FINDL2........6500
C                                                                        FINDL2........6600
C........STOP ITERATING IF CHANGE IN XSI AND ETA < TOL.                  FINDL2........6700
         IF ((ABS(DELXSI).LT.TOL).AND.(ABS(DELETA).LT.TOL)) GOTO 900     FINDL2........6800
C                                                                        FINDL2........6900
  800 CONTINUE                                                           FINDL2........7000
C                                                                        FINDL2........7100
C.....ITERATONS FAILED TO CONVERGE.  SET INOUT = 99 AND RETURN.          FINDL2........7200
      INOUT = 99                                                         FINDL2........7300
      GOTO 1000                                                          FINDL2........7400
C                                                                        FINDL2........7500
C.....ITERATIONS CONVERGED.  IF POINT IS INSIDE THE ELEMENT,             FINDL2........7600
C        SET INOUT = 1.  IF OUTSIDE, SET INOUT = 0.                      FINDL2........7700
  900 INOUT = 1                                                          FINDL2........7800
      IF ((ABS(XSI).GT.OPE).OR.(ABS(ETA).GT.OPE)) INOUT = 0              FINDL2........7900
C                                                                        FINDL2........8000
 1000 RETURN                                                             FINDL2........8100
      END                                                                FINDL2........8200
C                                                                        FINDL2........8300
C     SUBROUTINE        F  I  N  D  L  3           SUTRA VERSION 2.2     FINDL3.........100
C                                                                        FINDL3.........200
C *** PURPOSE :                                                          FINDL3.........300
C ***  TO DETERMINE WHETHER POINT (XK, YK, ZK) IN 3D GLOBAL COORDINATES  FINDL3.........400
C ***  IS CONTAINED WITHIN ELEMENT LL.  IF THE POINT IS INSIDE THE       FINDL3.........500
C ***  ELEMENT, SET INOUT = 1; IF OUTSIDE, SET INOUT = 0.  CONDITION     FINDL3.........600
C ***  INOUT = 99 SIGNALS CONVERGENCE FAILURE.  ADAPTED FROM SUTRAPLOT   FINDL3.........700
C ***  SUBROUTINE ITER3D.                                                FINDL3.........800
C                                                                        FINDL3.........900
      SUBROUTINE FINDL3(X,Y,Z,IN,LL,XK,YK,ZK,XSI,ETA,ZET,INOUT)          FINDL3........1000
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                FINDL3........1100
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              FINDL3........1200
     1   NSOP,NSOU,NBCN,NCIDB                                            FINDL3........1300
      DIMENSION IN(NE*8)                                                 FINDL3........1400
      DIMENSION X(NN), Y(NN), Z(NN)                                      FINDL3........1500
      DATA TOL /0.001/, ITRMAX /25/, EPSILON /0.001/                     FINDL3........1600
C                                                                        FINDL3........1700
C.....DEFINE OPE = (1. + EPSILON) FOR CONVENIENCE.                       FINDL3........1800
      OPE = 1D0 + EPSILON                                                FINDL3........1900
C                                                                        FINDL3........2000
C.....SET CORNER COORDINATES.                                            FINDL3........2100
      M0 = (LL - 1)*8                                                    FINDL3........2200
      X1 = X(IN(M0+1))                                                   FINDL3........2300
      X2 = X(IN(M0+2))                                                   FINDL3........2400
      X3 = X(IN(M0+3))                                                   FINDL3........2500
      X4 = X(IN(M0+4))                                                   FINDL3........2600
      X5 = X(IN(M0+5))                                                   FINDL3........2700
      X6 = X(IN(M0+6))                                                   FINDL3........2800
      X7 = X(IN(M0+7))                                                   FINDL3........2900
      X8 = X(IN(M0+8))                                                   FINDL3........3000
      Y1 = Y(IN(M0+1))                                                   FINDL3........3100
      Y2 = Y(IN(M0+2))                                                   FINDL3........3200
      Y3 = Y(IN(M0+3))                                                   FINDL3........3300
      Y4 = Y(IN(M0+4))                                                   FINDL3........3400
      Y5 = Y(IN(M0+5))                                                   FINDL3........3500
      Y6 = Y(IN(M0+6))                                                   FINDL3........3600
      Y7 = Y(IN(M0+7))                                                   FINDL3........3700
      Y8 = Y(IN(M0+8))                                                   FINDL3........3800
      Z1 = Z(IN(M0+1))                                                   FINDL3........3900
      Z2 = Z(IN(M0+2))                                                   FINDL3........4000
      Z3 = Z(IN(M0+3))                                                   FINDL3........4100
      Z4 = Z(IN(M0+4))                                                   FINDL3........4200
      Z5 = Z(IN(M0+5))                                                   FINDL3........4300
      Z6 = Z(IN(M0+6))                                                   FINDL3........4400
      Z7 = Z(IN(M0+7))                                                   FINDL3........4500
      Z8 = Z(IN(M0+8))                                                   FINDL3........4600
C                                                                        FINDL3........4700
C.....CALCULATE COEFFICIENTS.                                            FINDL3........4800
      AX = +X1+X2+X3+X4+X5+X6+X7+X8                                      FINDL3........4900
      BX = -X1+X2+X3-X4-X5+X6+X7-X8                                      FINDL3........5000
      CX = -X1-X2+X3+X4-X5-X6+X7+X8                                      FINDL3........5100
      DX = -X1-X2-X3-X4+X5+X6+X7+X8                                      FINDL3........5200
      EX = +X1-X2+X3-X4+X5-X6+X7-X8                                      FINDL3........5300
      FX = +X1-X2-X3+X4-X5+X6+X7-X8                                      FINDL3........5400
      GX = +X1+X2-X3-X4-X5-X6+X7+X8                                      FINDL3........5500
      HX = -X1+X2-X3+X4+X5-X6+X7-X8                                      FINDL3........5600
      AY = +Y1+Y2+Y3+Y4+Y5+Y6+Y7+Y8                                      FINDL3........5700
      BY = -Y1+Y2+Y3-Y4-Y5+Y6+Y7-Y8                                      FINDL3........5800
      CY = -Y1-Y2+Y3+Y4-Y5-Y6+Y7+Y8                                      FINDL3........5900
      DY = -Y1-Y2-Y3-Y4+Y5+Y6+Y7+Y8                                      FINDL3........6000
      EY = +Y1-Y2+Y3-Y4+Y5-Y6+Y7-Y8                                      FINDL3........6100
      FY = +Y1-Y2-Y3+Y4-Y5+Y6+Y7-Y8                                      FINDL3........6200
      GY = +Y1+Y2-Y3-Y4-Y5-Y6+Y7+Y8                                      FINDL3........6300
      HY = -Y1+Y2-Y3+Y4+Y5-Y6+Y7-Y8                                      FINDL3........6400
      AZ = +Z1+Z2+Z3+Z4+Z5+Z6+Z7+Z8                                      FINDL3........6500
      BZ = -Z1+Z2+Z3-Z4-Z5+Z6+Z7-Z8                                      FINDL3........6600
      CZ = -Z1-Z2+Z3+Z4-Z5-Z6+Z7+Z8                                      FINDL3........6700
      DZ = -Z1-Z2-Z3-Z4+Z5+Z6+Z7+Z8                                      FINDL3........6800
      EZ = +Z1-Z2+Z3-Z4+Z5-Z6+Z7-Z8                                      FINDL3........6900
      FZ = +Z1-Z2-Z3+Z4-Z5+Z6+Z7-Z8                                      FINDL3........7000
      GZ = +Z1+Z2-Z3-Z4-Z5-Z6+Z7+Z8                                      FINDL3........7100
      HZ = -Z1+Z2-Z3+Z4+Z5-Z6+Z7-Z8                                      FINDL3........7200
C                                                                        FINDL3........7300
C.....INITIAL GUESS OF ZERO FOR XSI, ETA, AND ZETA.                      FINDL3........7400
      XSI=0.0                                                            FINDL3........7500
      ETA=0.0                                                            FINDL3........7600
      ZET=0.0                                                            FINDL3........7700
C                                                                        FINDL3........7800
C.....ITERATION LOOP TO SOLVE FOR LOCAL COORDINATES.                     FINDL3........7900
C                                                                        FINDL3........8000
      DO 800 I=1,ITRMAX                                                  FINDL3........8100
C                                                                        FINDL3........8200
         F10 = AX - 8.*XK + BX*XSI + CX*ETA + DX*ZET + EX*XSI*ETA        FINDL3........8300
     1        + FX*XSI*ZET + GX*ETA*ZET + HX*XSI*ETA*ZET                 FINDL3........8400
         F20 = AY - 8.*YK + BY*XSI + CY*ETA + DY*ZET + EY*XSI*ETA        FINDL3........8500
     1        + FY*XSI*ZET + GY*ETA*ZET + HY*XSI*ETA*ZET                 FINDL3........8600
         F30 = AZ - 8.*ZK + BZ*XSI + CZ*ETA + DZ*ZET + EZ*XSI*ETA        FINDL3........8700
     1        + FZ*XSI*ZET + GZ*ETA*ZET + HZ*XSI*ETA*ZET                 FINDL3........8800
         FP11 = BX + EX*ETA + FX*ZET + HX*ETA*ZET                        FINDL3........8900
         FP12 = CX + EX*XSI + GX*ZET + HX*XSI*ZET                        FINDL3........9000
         FP13 = DX + FX*XSI + GX*ETA + HX*XSI*ETA                        FINDL3........9100
         FP21 = BY + EY*ETA + FY*ZET + HY*ETA*ZET                        FINDL3........9200
         FP22 = CY + EY*XSI + GY*ZET + HY*XSI*ZET                        FINDL3........9300
         FP23 = DY + FY*XSI + GY*ETA + HY*XSI*ETA                        FINDL3........9400
         FP31 = BZ + EZ*ETA + FZ*ZET + HZ*ETA*ZET                        FINDL3........9500
         FP32 = CZ + EZ*XSI + GZ*ZET + HZ*XSI*ZET                        FINDL3........9600
         FP33 = DZ + FZ*XSI + GZ*ETA + HZ*XSI*ETA                        FINDL3........9700
C                                                                        FINDL3........9800
         S11 = FP22*FP33 - FP32*FP23                                     FINDL3........9900
         S12 = FP21*FP33 - FP31*FP23                                     FINDL3.......10000
         S13 = FP21*FP32 - FP31*FP22                                     FINDL3.......10100
         CF12 = -F20*FP33 + F30*FP23                                     FINDL3.......10200
         CF34 = -F20*FP32 + F30*FP22                                     FINDL3.......10300
         CF43 = -CF34                                                    FINDL3.......10400
         CF56 = -F30*FP21 + F20*FP31                                     FINDL3.......10500
C                                                                        FINDL3.......10600
         DETXSI = -F10*S11 - FP12*CF12 + FP13*CF34                       FINDL3.......10700
         DETETA = FP11*CF12 + F10*S12 + FP13*CF56                        FINDL3.......10800
         DETZET = FP11*CF43 - FP12*CF56 - F10*S13                        FINDL3.......10900
         DETERM = FP11*S11 - FP12*S12 + FP13*S13                         FINDL3.......11000
         DELXSI = DETXSI/DETERM                                          FINDL3.......11100
         DELETA = DETETA/DETERM                                          FINDL3.......11200
         DELZET = DETZET/DETERM                                          FINDL3.......11300
C                                                                        FINDL3.......11400
         XSI = XSI + DELXSI                                              FINDL3.......11500
         ETA = ETA + DELETA                                              FINDL3.......11600
         ZET = ZET + DELZET                                              FINDL3.......11700
C                                                                        FINDL3.......11800
C........STOP ITERATING IF CHANGE IN XSI, ETA, AND ZETA < TOL.           FINDL3.......11900
         IF ((ABS(DELXSI).LT.TOL).AND.(ABS(DELETA).LT.TOL).AND.          FINDL3.......12000
     1       (ABS(DELZET).LT.TOL)) GOTO 900                              FINDL3.......12100
C                                                                        FINDL3.......12200
  800 CONTINUE                                                           FINDL3.......12300
C                                                                        FINDL3.......12400
C.....ITERATONS FAILED TO CONVERGE.  SET INOUT = 99 AND RETURN.          FINDL3.......12500
      INOUT = 99                                                         FINDL3.......12600
      GOTO 1000                                                          FINDL3.......12700
C                                                                        FINDL3.......12800
C.....ITERATIONS CONVERGED.  IF POINT IS INSIDE THE ELEMENT,             FINDL3.......12900
C        SET INOUT = 1.  IF OUTSIDE, SET INOUT = 0.                      FINDL3.......13000
  900 INOUT = 1                                                          FINDL3.......13100
      IF ((ABS(XSI).GT.OPE).OR.(ABS(ETA).GT.OPE).OR.(ABS(ZET).GT.OPE))   FINDL3.......13200
     1   INOUT = 0                                                       FINDL3.......13300
C                                                                        FINDL3.......13400
 1000 RETURN                                                             FINDL3.......13500
      END                                                                FINDL3.......13600
C                                                                        FINDL3.......13700
C     SUBROUTINE        F  O  P  E  N              SUTRA VERSION 2.2     FOPEN..........100
C                                                                        FOPEN..........200
C *** PURPOSE :                                                          FOPEN..........300
C ***  OPENS FILES FOR SUTRA SIMULATION.  READS AND PROCESSES FILE       FOPEN..........400
C ***  SPECIFICATIONS FROM "SUTRA.FIL" AND OPENS INPUT AND OUTPUT FILES. FOPEN..........500
C                                                                        FOPEN..........600
      SUBROUTINE FOPEN()                                                 FOPEN..........700
      USE EXPINT                                                         FOPEN..........800
      USE SCHDEF                                                         FOPEN..........900
      USE BCSDEF                                                         FOPEN.........1000
      USE FINDEF                                                         FOPEN.........1100
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                FOPEN.........1200
      PARAMETER (IUNMIN=11)                                              FOPEN.........1300
      CHARACTER*80 FT,FN,UNAME,FNAME,ENAME,ENDEF,FTSTR                   FOPEN.........1400
      CHARACTER*80 FNROOT,FNEXTN                                         FOPEN.........1500
      CHARACTER*80 ERRCOD,CHERR(10)                                      FOPEN.........1600
      CHARACTER*8 VERNUM, VERNIN                                         FOPEN.........1700
      CHARACTER INTFIL*1000                                              FOPEN.........1800
      LOGICAL IS                                                         FOPEN.........1900
      LOGICAL ONCEFO                                                     FOPEN.........2000
      LOGICAL ALCBCS,ALCFIN,ALCOBS                                       FOPEN.........2100
      DIMENSION FNAME(0:13),IUNIT(0:13)                                  FOPEN.........2200
      DIMENSION FTSTR(0:13)                                              FOPEN.........2300
      DIMENSION INERR(10),RLERR(10)                                      FOPEN.........2400
      DIMENSION KTYPE(2)                                                 FOPEN.........2500
      COMMON /ALC/ ALCBCS,ALCFIN,ALCOBS                                  FOPEN.........2600
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  FOPEN.........2700
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           FOPEN.........2800
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      FOPEN.........2900
      COMMON /FNAMES/ UNAME,FNAME                                        FOPEN.........3000
      COMMON /FO/ONCEFO                                                  FOPEN.........3100
      COMMON /FUNIB/ NFBCS                                               FOPEN.........3200
      COMMON /FUNITA/ IUNIT                                              FOPEN.........3300
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 FOPEN.........3400
     1   K10,K11,K12,K13                                                 FOPEN.........3500
      COMMON /OBS/ NOBSN,NTOBS,NOBCYC,NOBLIN,NFLOMX                      FOPEN.........3600
      COMMON /SCH/ NSCH,ISCHTS,NSCHAU                                    FOPEN.........3700
      COMMON /VER/ VERNUM, VERNIN                                        FOPEN.........3800
      DATA (FTSTR(NFT),NFT=0,13)/'SMY','INP','ICS','LST','RST',          FOPEN.........3900
     1   'NOD','ELE','OBS','OBC','BCS','BCOF','BCOS','BCOP','BCOU'/      FOPEN.........4000
C                                                                        FOPEN.........4100
C.....IF THIS IS THE FIRST CALL, READ AND PROCESS FILE SPECIFICATIONS    FOPEN.........4200
C        FROM "SUTRA.FIL" AND OPEN ALL OUTPUT FILES EXCEPT OBSERVATION   FOPEN.........4300
C        OUTPUT.  OBSERVATION OUTPUT FILES ARE CREATED ON THE SECOND     FOPEN.........4400
C        CALL, AFTER DATASET 8D HAS BEEN READ.                           FOPEN.........4500
      IF (.NOT.ONCEFO) THEN                                              FOPEN.........4600
C                                                                        FOPEN.........4700
C........INITIALIZE FLAGS THAT INDICATE WHETHER CERTAIN ARRAYS           FOPEN.........4800
C           HAVE BEEN ALLOCATED.  THEY ARE USED BY SUBROUTINE NAFU.      FOPEN.........4900
         ALCBCS = .FALSE.                                                FOPEN.........5000
         ALCFIN = .FALSE.                                                FOPEN.........5100
         ALCOBS = .FALSE.                                                FOPEN.........5200
C                                                                        FOPEN.........5300
C........INITIALIZE UNIT NUMBERS AND FILENAMES                           FOPEN.........5400
         K1 = -1                                                         FOPEN.........5500
         K2 = -1                                                         FOPEN.........5600
         K3 = -1                                                         FOPEN.........5700
         K4 = -1                                                         FOPEN.........5800
         K5 = -1                                                         FOPEN.........5900
         K6 = -1                                                         FOPEN.........6000
         K7 = -1                                                         FOPEN.........6100
         K8 = -1                                                         FOPEN.........6200
         K9 = -1                                                         FOPEN.........6300
         K10 = -1                                                        FOPEN.........6400
         K11 = -1                                                        FOPEN.........6500
         K12 = -1                                                        FOPEN.........6600
         K13 = -1                                                        FOPEN.........6700
         DO 20 NF=0,13                                                   FOPEN.........6800
            IUNIT(NF) = -1                                               FOPEN.........6900
            FNAME(NF) = ""                                               FOPEN.........7000
   20    CONTINUE                                                        FOPEN.........7100
C                                                                        FOPEN.........7200
C........SET DEFAULT VALUES FOR THE SMY FILE.  THE DEFAULT FILE WILL     FOPEN.........7300
C           NOT ACTUALLY BE CREATED UNLESS IT IS NEEDED.                 FOPEN.........7400
         K00 = K0 + 1                                                    FOPEN.........7500
         ENDEF = 'SUTRA.SMY'                                             FOPEN.........7600
C                                                                        FOPEN.........7700
C........OPEN FILE UNIT CONTAINING UNIT NUMBERS AND FILE ASSIGNMENTS     FOPEN.........7800
         IU=K0                                                           FOPEN.........7900
         FN=UNAME                                                        FOPEN.........8000
         INQUIRE(FILE=UNAME,EXIST=IS)                                    FOPEN.........8100
         IF (IS) THEN                                                    FOPEN.........8200
            OPEN(UNIT=IU,FILE=UNAME,STATUS='OLD',FORM='FORMATTED',       FOPEN.........8300
     1         IOSTAT=KERR)                                              FOPEN.........8400
            IF(KERR.GT.0) GOTO 9000                                      FOPEN.........8500
         ELSE                                                            FOPEN.........8600
            CALL NAFU(K00,0,ENDEF)                                       FOPEN.........8700
            OPEN(UNIT=K00,FILE=ENDEF,STATUS='REPLACE')                   FOPEN.........8800
            GOTO 8000                                                    FOPEN.........8900
         ENDIF                                                           FOPEN.........9000
C                                                                        FOPEN.........9100
C........COUNT HOW MANY BCS FILES LISTED, THEN REWIND.  ALLOCATE AND     FOPEN.........9200
C           INITIALIZE BCS-RELATED ARRAYS IUNIB AND FNAMB, AS WELL AS    FOPEN.........9300
C           NKS, KLIST, AND FNAIN.                                       FOPEN.........9400
         NFBCS = 0                                                       FOPEN.........9500
   30    READ(K0,'(A)',IOSTAT=INERR(1),END=32) INTFIL                    FOPEN.........9600
         IF (INERR(1).NE.0) THEN                                         FOPEN.........9700
            CALL NAFU(K00,0,ENDEF)                                       FOPEN.........9800
            OPEN(UNIT=K00,FILE=ENDEF,STATUS='REPLACE')                   FOPEN.........9900
            ERRCOD = 'REA-FIL'                                           FOPEN........10000
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     FOPEN........10100
         END IF                                                          FOPEN........10200
         FT = ''                                                         FOPEN........10300
         READ(INTFIL,*,IOSTAT=INERR(1)) FT                               FOPEN........10400
         IF (FT.EQ.'BCS') NFBCS = NFBCS + 1                              FOPEN........10500
         GOTO 30                                                         FOPEN........10600
   32    REWIND(K0)                                                      FOPEN........10700
         ALLOCATE (IUNIB(NFBCS),FNAMB(NFBCS))                            FOPEN........10800
         ALCBCS = .TRUE.                                                 FOPEN........10900
         ALLOCATE (NKS(2+NFBCS),KLIST(2+NFBCS,20),FNAIN(2+NFBCS,20))     FOPEN........11000
         ALCFIN = .TRUE.                                                 FOPEN........11100
         DO 33 N=1,2+NFBCS                                               FOPEN........11200
            NKS(N) = 0                                                   FOPEN........11300
   33    CONTINUE                                                        FOPEN........11400
         DO 35 NFB=1,NFBCS                                               FOPEN........11500
            IUNIB(NFB) = -1                                              FOPEN........11600
            FNAMB(NFB) = ""                                              FOPEN........11700
   35    CONTINUE                                                        FOPEN........11800
C........COMPUTE TOTAL NUMBER OF FILE SPECIFICATIONS.                    FOPEN........11900
         NFSPEC = 12 + NFBCS                                             FOPEN........12000
C                                                                        FOPEN........12100
C........READ IN UNIT NUMBERS AND FILE ASSIGNMENTS.  ASSIGN COMPATIBLE   FOPEN........12200
C           UNIT NUMBERS.  CLOSE UNIT K0.                                FOPEN........12300
         NFB = 0                                                         FOPEN........12400
         DO 90 NF=0,NFSPEC                                               FOPEN........12500
C...........READ A FILE SPECIFICATION                                    FOPEN........12600
            READ(K0,'(A)',IOSTAT=INERR(1),END=99) INTFIL                 FOPEN........12700
            IF (INERR(1).NE.0) THEN                                      FOPEN........12800
               CALL NAFU(K00,0,ENDEF)                                    FOPEN........12900
               OPEN(UNIT=K00,FILE=ENDEF,STATUS='REPLACE')                FOPEN........13000
               ERRCOD = 'REA-FIL'                                        FOPEN........13100
               CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                  FOPEN........13200
            END IF                                                       FOPEN........13300
            IF (VERIFY(INTFIL,' ').EQ.0) GOTO 99                         FOPEN........13400
            READ(INTFIL,*,IOSTAT=INERR(1)) FT, IU, FN                    FOPEN........13500
            IF (INERR(1).NE.0) THEN                                      FOPEN........13600
               CALL NAFU(K00,0,ENDEF)                                    FOPEN........13700
               OPEN(UNIT=K00,FILE=ENDEF,STATUS='REPLACE')                FOPEN........13800
               ERRCOD = 'REA-FIL'                                        FOPEN........13900
               CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                  FOPEN........14000
            END IF                                                       FOPEN........14100
C...........CHECK FOR ILLEGAL SPECIFICATIONS                             FOPEN........14200
            IF (FN.EQ.UNAME) THEN                                        FOPEN........14300
               CALL NAFU(K00,0,ENDEF)                                    FOPEN........14400
               OPEN(UNIT=K00,FILE=ENDEF,STATUS='REPLACE')                FOPEN........14500
               ERRCOD = 'FIL-9'                                          FOPEN........14600
               CHERR(1) = UNAME                                          FOPEN........14700
               CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                  FOPEN........14800
            END IF                                                       FOPEN........14900
C...........IF THE SPECIFIED UNIT NUMBER IS LESS THAN IUNMIN,            FOPEN........15000
C              SET IT TO IUNMIN                                          FOPEN........15100
            IU = MAX(IU, IUNMIN)                                         FOPEN........15200
C...........STORE THE FILE INFORMATION, CHECKING FOR INVALID AND         FOPEN........15300
C              REPEATED FILE TYPE SPECIFICATIONS AND ASSIGNING UNIT      FOPEN........15400
C              NUMBERS TO NON-OBSERVATION FILES ALONG THE WAY            FOPEN........15500
            IF (FT.EQ.'BCS') THEN                                        FOPEN........15600
               CALL NAFU(IU,0,FN)                                        FOPEN........15700
               IUNIT(9) = IU                                             FOPEN........15800
               FNAME(9) = FN                                             FOPEN........15900
               NFB = NFB + 1                                             FOPEN........16000
               IUNIB(NFB) = IU                                           FOPEN........16100
               FNAMB(NFB) = FN                                           FOPEN........16200
               GOTO 60                                                   FOPEN........16300
            END IF                                                       FOPEN........16400
            DO 50 NFT=0,13                                               FOPEN........16500
               IF (FT.EQ.FTSTR(NFT)) THEN                                FOPEN........16600
                  IF (IUNIT(NFT).EQ.-1) THEN                             FOPEN........16700
                     IF ((NFT.LE.6).OR.(NFT.GE.9)) CALL NAFU(IU,0,FN)    FOPEN........16800
                     IUNIT(NFT) = IU                                     FOPEN........16900
                     FNAME(NFT) = FN                                     FOPEN........17000
                     GOTO 60                                             FOPEN........17100
                  ELSE                                                   FOPEN........17200
                     CALL NAFU(K00,0,ENDEF)                              FOPEN........17300
                     OPEN(UNIT=K00,FILE=ENDEF,STATUS='REPLACE')          FOPEN........17400
                     ERRCOD = 'FIL-6'                                    FOPEN........17500
                     CHERR(1) = UNAME                                    FOPEN........17600
                     CHERR(2) = FT                                       FOPEN........17700
                     CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)            FOPEN........17800
                  END IF                                                 FOPEN........17900
               END IF                                                    FOPEN........18000
   50       CONTINUE                                                     FOPEN........18100
            CALL NAFU(K00,0,ENDEF)                                       FOPEN........18200
            OPEN(UNIT=K00,FILE=ENDEF,STATUS='REPLACE')                   FOPEN........18300
            ERRCOD = 'FIL-5'                                             FOPEN........18400
            CHERR(1) = UNAME                                             FOPEN........18500
            CHERR(2) = FT                                                FOPEN........18600
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     FOPEN........18700
   60       CONTINUE                                                     FOPEN........18800
   90    CONTINUE                                                        FOPEN........18900
   99    CLOSE(K0)                                                       FOPEN........19000
C                                                                        FOPEN........19100
C........OPEN THE SMY FILE.                                              FOPEN........19200
C                                                                        FOPEN........19300
C........IF NO SMY SPECIFICATION, USE THE DEFAULT.                       FOPEN........19400
         IF (IUNIT(0).EQ.-1) THEN                                        FOPEN........19500
            CALL NAFU(K00,0,ENDEF)                                       FOPEN........19600
            IUNIT(0) = K00                                               FOPEN........19700
            FNAME(0) = ENDEF                                             FOPEN........19800
         END IF                                                          FOPEN........19900
         IU = IUNIT(0)                                                   FOPEN........20000
         FN = FNAME(0)                                                   FOPEN........20100
         OPEN(UNIT=IU,FILE=FN,STATUS='REPLACE',IOSTAT=KERR)              FOPEN........20200
C........IN CASE OF ERROR WHILE OPENING SMY FILE, WRITE ERROR            FOPEN........20300
C           MESSAGE TO DEFAULT FILE                                      FOPEN........20400
         IF (KERR.GT.0) THEN                                             FOPEN........20500
            CALL NAFU(K00,0,ENDEF)                                       FOPEN........20600
            OPEN(UNIT=K00,FILE=ENDEF,STATUS='REPLACE')                   FOPEN........20700
            GOTO 9000                                                    FOPEN........20800
         END IF                                                          FOPEN........20900
C........SET K00 AND ENAME                                               FOPEN........21000
         K00 = IU                                                        FOPEN........21100
         ENAME = FN                                                      FOPEN........21200
C                                                                        FOPEN........21300
C........CHECK FOR REPEATED FILENAMES (EXCEPT OBS AND OBC FILES)         FOPEN........21400
C           AND MISSING SPECIFICATIONS FOR REQUIRED FILE TYPES           FOPEN........21500
         DO 260 NF=0,13                                                  FOPEN........21600
            IF ((NF.GE.7).OR.(NF.LE.9)) CYCLE                            FOPEN........21700
            IF (IUNIT(NF).EQ.-1) THEN                                    FOPEN........21800
               IF ((NF.GE.1).AND.(NF.LE.3)) THEN                         FOPEN........21900
                  ERRCOD = 'FIL-7'                                       FOPEN........22000
                  CHERR(1) = UNAME                                       FOPEN........22100
                  CHERR(2) = FTSTR(NF)                                   FOPEN........22200
                  CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)               FOPEN........22300
               ELSE                                                      FOPEN........22400
                  CYCLE                                                  FOPEN........22500
               END IF                                                    FOPEN........22600
            END IF                                                       FOPEN........22700
            DO 250 NF2=NF+1,13                                           FOPEN........22800
               IF ((NF2.GE.7).OR.(NF2.LE.9)) CYCLE                       FOPEN........22900
               IF (FNAME(NF2).EQ.FNAME(NF)) THEN                         FOPEN........23000
                  ERRCOD = 'FIL-4'                                       FOPEN........23100
                  CHERR(1) = UNAME                                       FOPEN........23200
                  CHERR(2) = FNAME(NF)                                   FOPEN........23300
                  CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)               FOPEN........23400
               END IF                                                    FOPEN........23500
  250       CONTINUE                                                     FOPEN........23600
            DO 255 NFB=1,NFBCS                                           FOPEN........23700
               IF (FNAME(NFB).EQ.FNAME(NF)) THEN                         FOPEN........23800
                  ERRCOD = 'FIL-4'                                       FOPEN........23900
                  CHERR(1) = UNAME                                       FOPEN........24000
                  CHERR(2) = FNAME(NF)                                   FOPEN........24100
                  CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)               FOPEN........24200
               END IF                                                    FOPEN........24300
  255       CONTINUE                                                     FOPEN........24400
  260    CONTINUE                                                        FOPEN........24500
         DO 280 NFB=1,NFBCS                                              FOPEN........24600
            DO 270 NFB2=NFB+1,NFBCS                                      FOPEN........24700
               IF (FNAMB(NFB2).EQ.FNAMB(NFB)) THEN                       FOPEN........24800
                  ERRCOD = 'FIL-4'                                       FOPEN........24900
                  CHERR(1) = UNAME                                       FOPEN........25000
                  CHERR(2) = FNAMB(NF)                                   FOPEN........25100
                  CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)               FOPEN........25200
               END IF                                                    FOPEN........25300
  270       CONTINUE                                                     FOPEN........25400
  280    CONTINUE                                                        FOPEN........25500
C                                                                        FOPEN........25600
C........SET UNIT NUMBERS K1 - K13.  (K00 HAS BEEN SET PREVIOUSLY.)      FOPEN........25700
         K1=IUNIT(1)                                                     FOPEN........25800
         K2=IUNIT(2)                                                     FOPEN........25900
         K3=IUNIT(3)                                                     FOPEN........26000
         K4=IUNIT(4)                                                     FOPEN........26100
         K5=IUNIT(5)                                                     FOPEN........26200
         K6=IUNIT(6)                                                     FOPEN........26300
         K7=IUNIT(7)                                                     FOPEN........26400
         K8=IUNIT(8)                                                     FOPEN........26500
         K9=IUNIT(9)                                                     FOPEN........26600
         K10=IUNIT(10)                                                   FOPEN........26700
         K11=IUNIT(11)                                                   FOPEN........26800
         K12=IUNIT(12)                                                   FOPEN........26900
         K13=IUNIT(13)                                                   FOPEN........27000
C                                                                        FOPEN........27100
C........CHECK FOR EXISTENCE OF INPUT FILES AND OPEN INPUT AND OUTPUT    FOPEN........27200
C           FILES (EXCEPT SMY, OBS, AND OBC)                             FOPEN........27300
         DO 300 NF=1,13                                                  FOPEN........27400
            IF ((NF.EQ.7).OR.(NF.EQ.8)) CYCLE                            FOPEN........27500
            IU=IUNIT(NF)                                                 FOPEN........27600
            FN=FNAME(NF)                                                 FOPEN........27700
            IF (IU.EQ.-1) GOTO 300                                       FOPEN........27800
            IF (NF.LE.2) THEN                                            FOPEN........27900
               INQUIRE(FILE=FN,EXIST=IS)                                 FOPEN........28000
               IF(IS) THEN                                               FOPEN........28100
                  OPEN(UNIT=IU,FILE=FN,STATUS='OLD',FORM='FORMATTED',    FOPEN........28200
     1               IOSTAT=KERR)                                        FOPEN........28300
               ELSE                                                      FOPEN........28400
                  GOTO 8000                                              FOPEN........28500
               ENDIF                                                     FOPEN........28600
            ELSE IF (NF.EQ.9) THEN                                       FOPEN........28700
               DO 290 NFB=1,NFBCS                                        FOPEN........28800
                  IU = IUNIB(NFB)                                        FOPEN........28900
                  FN = FNAMB(NFB)                                        FOPEN........29000
                  INQUIRE(FILE=FN,EXIST=IS)                              FOPEN........29100
                  IF(IS) THEN                                            FOPEN........29200
                     OPEN(UNIT=IU,FILE=FN,STATUS='OLD',FORM='FORMATTED', FOPEN........29300
     1                  IOSTAT=KERR)                                     FOPEN........29400
                  ELSE                                                   FOPEN........29500
                     GOTO 8000                                           FOPEN........29600
                  ENDIF                                                  FOPEN........29700
  290          CONTINUE                                                  FOPEN........29800
            ELSE                                                         FOPEN........29900
               OPEN(UNIT=IU,FILE=FN,STATUS='REPLACE',FORM='FORMATTED',   FOPEN........30000
     1            IOSTAT=KERR)                                           FOPEN........30100
            ENDIF                                                        FOPEN........30200
            IF(KERR.GT.0) GOTO 9000                                      FOPEN........30300
  300    CONTINUE                                                        FOPEN........30400
C                                                                        FOPEN........30500
C........SET FLAG TO INDICATE THAT FIRST CALL IS COMPLETED, THEN RETURN  FOPEN........30600
         ONCEFO = .TRUE.                                                 FOPEN........30700
         RETURN                                                          FOPEN........30800
C                                                                        FOPEN........30900
      ELSE                                                               FOPEN........31000
C                                                                        FOPEN........31100
C........ALLOCATE AND INITIALIZE OBSERVATION-RELATED UNIT NUMBERS        FOPEN........31200
C           AND FILENAMES                                                FOPEN........31300
         ALLOCATE(IUNIO(NFLOMX),FNAMO(NFLOMX))                           FOPEN........31400
         ALCOBS = .TRUE.                                                 FOPEN........31500
         DO 330 NFO=1,NFLOMX                                             FOPEN........31600
            IUNIO(NFO) = -1                                              FOPEN........31700
            FNAMO(NFO) = ""                                              FOPEN........31800
  330    CONTINUE                                                        FOPEN........31900
C                                                                        FOPEN........32000
C........OPEN OBS AND OBC FILES, AUTOMATICALLY GENERATING UNIT NUMBERS   FOPEN........32100
C           AND FILENAMES                                                FOPEN........32200
C                                                                        FOPEN........32300
C........LOOP OVER THE TWO FILE TYPES                                    FOPEN........32400
         DO 400 NF=7,8                                                   FOPEN........32500
C...........IF NO FILE SPECIFICATION OF THIS TYPE, MOVE ON               FOPEN........32600
            IF (IUNIT(NF).EQ.-1) CYCLE                                   FOPEN........32700
C...........DETERMINE LENGTH OF THE SPECIFIED FILENAME AND ITS ROOT      FOPEN........32800
            LNAME = LEN_TRIM(FNAME(NF))                                  FOPEN........32900
            LROOT = SCAN(FNAME(NF),'.',BACK=.TRUE.) - 1                  FOPEN........33000
C...........SET THE ROOT NAME AND EXTENSION THAT WILL BE USED FOR FILES  FOPEN........33100
C              OF THIS TYPE                                              FOPEN........33200
            IF (LROOT.NE.-1) THEN                                        FOPEN........33300
               IF (LROOT.NE.0) THEN                                      FOPEN........33400
                  FNROOT = FNAME(NF)(1:LROOT)                            FOPEN........33500
               ELSE                                                      FOPEN........33600
                  FNROOT = "SUTRA"                                       FOPEN........33700
               END IF                                                    FOPEN........33800
               IF (LROOT.NE.LNAME-1) THEN                                FOPEN........33900
                  FNEXTN = FNAME(NF)(LROOT+1:LNAME)                      FOPEN........34000
               ELSE                                                      FOPEN........34100
                  FNEXTN = "." // FTSTR(NF)                              FOPEN........34200
               END IF                                                    FOPEN........34300
            ELSE                                                         FOPEN........34400
               IF (LNAME.NE.0) THEN                                      FOPEN........34500
                  FNROOT = FNAME(NF)                                     FOPEN........34600
               ELSE                                                      FOPEN........34700
                  FNROOT = "SUTRA"                                       FOPEN........34800
               END IF                                                    FOPEN........34900
               FNEXTN = "." // FTSTR(NF)                                 FOPEN........35000
            END IF                                                       FOPEN........35100
C...........INITIALIZE UNIT NUMBER                                       FOPEN........35200
            IUNEXT = IUNIT(NF)                                           FOPEN........35300
C...........LOOP OVER OBSERVATION OUTPUT FILES                           FOPEN........35400
            DO 380 J=1,NFLOMX                                            FOPEN........35500
               JM1 = J - 1                                               FOPEN........35600
C..............IF FILE IS NOT OF THE TYPE CURRENTLY BEING PROCESSED,     FOPEN........35700
C                 SKIP FILE                                              FOPEN........35800
               IF (OFP(J)%FRMT.NE.FTSTR(NF)) CYCLE                       FOPEN........35900
C..............CONSTRUCT FILENAME FROM ROOT NAME, SCHEDULE NAME,         FOPEN........36000
C                 AND EXTENSION                                          FOPEN........36100
               IF ((ISSTRA.NE.1).AND.                                    FOPEN........36200
     1             (SCHDLS(OFP(J)%ISCHED)%NAME.NE."-")) THEN             FOPEN........36300
                  FN = TRIM(FNROOT) // "_"                               FOPEN........36400
     1               // TRIM(SCHDLS(OFP(J)%ISCHED)%NAME) // FNEXTN       FOPEN........36500
               ELSE                                                      FOPEN........36600
                  FN = TRIM(FNROOT) // FNEXTN                            FOPEN........36700
               END IF                                                    FOPEN........36800
C..............CHECK FOR DUPLICATE FILENAME AMONG NON-OBSERVATION        FOPEN........36900
C                 FILES                                                  FOPEN........37000
               DO 350 NFF=0,13                                           FOPEN........37100
                  IF ((NFF.GE.7).OR.(NFF.LE.9)) CYCLE                    FOPEN........37200
                  IF (FN.EQ.FNAME(NFF)) THEN                             FOPEN........37300
                     ERRCOD = 'FIL-4'                                    FOPEN........37400
                     CHERR(1) = UNAME                                    FOPEN........37500
                     CHERR(2) = FN                                       FOPEN........37600
                     CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)            FOPEN........37700
                  END IF                                                 FOPEN........37800
  350          CONTINUE                                                  FOPEN........37900
               DO 352 NFB=1,NFBCS                                        FOPEN........38000
                  IF (FN.EQ.FNAMB(NFB)) THEN                             FOPEN........38100
                     ERRCOD = 'FIL-4'                                    FOPEN........38200
                     CHERR(1) = UNAME                                    FOPEN........38300
                     CHERR(2) = FN                                       FOPEN........38400
                     CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)            FOPEN........38500
                  END IF                                                 FOPEN........38600
  352          CONTINUE                                                  FOPEN........38700
C..............CHECK FOR DUPLICATE FILENAME AMONG PREVIOUSLY DEFINED     FOPEN........38800
C                 OBSERVATION OUTPUT FILES                               FOPEN........38900
               DO 355 NJ=1,J-1                                           FOPEN........39000
                  IF (FN.EQ.FNAMO(NJ)) THEN                              FOPEN........39100
                     ERRCOD = 'FIL-4'                                    FOPEN........39200
                     CHERR(1) = UNAME                                    FOPEN........39300
                     CHERR(2) = FN                                       FOPEN........39400
                     CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)            FOPEN........39500
                  END IF                                                 FOPEN........39600
  355          CONTINUE                                                  FOPEN........39700
C..............ASSIGN NEXT AVAILABLE UNIT NUMBER, RECORD FILE            FOPEN........39800
C                 INFORMATION, AND OPEN THE FILE                         FOPEN........39900
               CALL NAFU(IUNEXT,JM1,FN)                                  FOPEN........40000
               IU = IUNEXT                                               FOPEN........40100
               IUNIO(J) = IU                                             FOPEN........40200
               FNAMO(J) = FN                                             FOPEN........40300
               INQUIRE(UNIT=IU, OPENED=IS)                               FOPEN........40400
               OPEN(UNIT=IU,FILE=FN,STATUS='REPLACE',FORM='FORMATTED',   FOPEN........40500
     1            IOSTAT=KERR)                                           FOPEN........40600
               IF(KERR.GT.0) GOTO 9000                                   FOPEN........40700
  380       CONTINUE                                                     FOPEN........40800
  400    CONTINUE                                                        FOPEN........40900
C                                                                        FOPEN........41000
C........SECOND CALL IS COMPLETED, SO RETURN                             FOPEN........41100
         RETURN                                                          FOPEN........41200
C                                                                        FOPEN........41300
      END IF                                                             FOPEN........41400
C                                                                        FOPEN........41500
 8000 CONTINUE                                                           FOPEN........41600
C.....GENERATE ERROR                                                     FOPEN........41700
      ERRCOD = 'FIL-1'                                                   FOPEN........41800
      CHERR(1) = UNAME                                                   FOPEN........41900
      CHERR(2) = FN                                                      FOPEN........42000
      CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                           FOPEN........42100
C                                                                        FOPEN........42200
 9000 CONTINUE                                                           FOPEN........42300
C.....GENERATE ERROR                                                     FOPEN........42400
      ERRCOD = 'FIL-2'                                                   FOPEN........42500
      CHERR(1) = UNAME                                                   FOPEN........42600
      CHERR(2) = FN                                                      FOPEN........42700
      INERR(1) = IU                                                      FOPEN........42800
      CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                           FOPEN........42900
C                                                                        FOPEN........43000
      END                                                                FOPEN........43100
C                                                                        FOPEN........43200
C     FUNCTION          F  R  C  S  T  P           SUTRA VERSION 2.2     FRCSTP.........100
C                                                                        FRCSTP.........200
C *** PURPOSE :                                                          FRCSTP.........300
C ***  TO RETURN THE FRACTIONAL TIME STEP FOR A GIVEN TIME.  IF THE      FRCSTP.........400
C ***  SPECIFIED TIME IS GREATER THAN THE MAXIMUM, A VALUE OF            FRCSTP.........500
C ***  +HUGE(1D0) (THE LARGEST NUMBER THAT CAN BE REPRESENTED IN DOUBLE  FRCSTP.........600
C ***  PRECISION) IS RETURNED.  IF THE SPECIFIED TIME IS LESS THAN       FRCSTP.........700
C ***  TSTART, A VALUE OF -HUGE(1D0) IS RETURNED.  IF THE TIME STEP      FRCSTP.........800
C ***  SCHEDULE HAS NOT YET BEEN DEFINED, A VALUE OF ZERO IS RETURNED.   FRCSTP.........900
C                                                                        FRCSTP........1000
      DOUBLE PRECISION FUNCTION FRCSTP(TIME)                             FRCSTP........1100
      USE LLDEF                                                          FRCSTP........1200
      USE SCHDEF                                                         FRCSTP........1300
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                FRCSTP........1400
      TYPE (LLD), POINTER :: DEN                                         FRCSTP........1500
      COMMON /SCH/ NSCH,ISCHTS,NSCHAU                                    FRCSTP........1600
C                                                                        FRCSTP........1700
      IF (ISCHTS.EQ.0) THEN                                              FRCSTP........1800
         FRCSTP = DNINT(DBLE(0))                                         FRCSTP........1900
         RETURN                                                          FRCSTP........2000
      END IF                                                             FRCSTP........2100
C                                                                        FRCSTP........2200
      NSMAX = SCHDLS(ISCHTS)%LLEN - 1                                    FRCSTP........2300
C                                                                        FRCSTP........2400
      DEN => SCHDLS(ISCHTS)%SLIST                                        FRCSTP........2500
      T1 = DEN%DVALU1                                                    FRCSTP........2600
      IF (TIME.EQ.T1) THEN                                               FRCSTP........2700
         FRCSTP = DNINT(DBLE(0))                                         FRCSTP........2800
         RETURN                                                          FRCSTP........2900
      ELSE IF (TIME.LT.T1) THEN                                          FRCSTP........3000
         FRCSTP = -HUGE(1D0)                                             FRCSTP........3100
         RETURN                                                          FRCSTP........3200
      END IF                                                             FRCSTP........3300
      DO 100 NS=1,NSMAX                                                  FRCSTP........3400
         DEN => DEN%NENT                                                 FRCSTP........3500
         T2 = DEN%DVALU1                                                 FRCSTP........3600
         IF (TIME.EQ.T2) THEN                                            FRCSTP........3700
            FRCSTP = DNINT(DBLE(NS))                                     FRCSTP........3800
            RETURN                                                       FRCSTP........3900
         ELSE IF (TIME.LT.T2) THEN                                       FRCSTP........4000
            WT = (TIME - T1)/(T2 - T1)                                   FRCSTP........4100
            S1 = DBLE(NS - 1)                                            FRCSTP........4200
            S2 = DBLE(NS)                                                FRCSTP........4300
            FRCSTP = (1D0 - WT)*S1 + WT*S2                               FRCSTP........4400
            RETURN                                                       FRCSTP........4500
         END IF                                                          FRCSTP........4600
  100 CONTINUE                                                           FRCSTP........4700
      FRCSTP = +HUGE(1D0)                                                FRCSTP........4800
C                                                                        FRCSTP........4900
      RETURN                                                             FRCSTP........5000
      END                                                                FRCSTP........5100
C                                                                        FRCSTP........5200
C     SUBROUTINE        G  L  O  B  A  N           SUTRA VERSION 2.2     GLOBAN.........100
C                                                                        GLOBAN.........200
C *** PURPOSE :                                                          GLOBAN.........300
C ***  TO ASSEMBLE RESULTS OF ELEMENTWISE INTEGRATIONS INTO              GLOBAN.........400
C ***  A GLOBAL BANDED MATRIX AND GLOBAL VECTOR FOR BOTH                 GLOBAN.........500
C ***  FLOW AND TRANSPORT EQUATIONS.                                     GLOBAN.........600
C                                                                        GLOBAN.........700
      SUBROUTINE GLOBAN(L,ML,VOLE,BFLOWE,DFLOWE,BTRANE,DTRANE,           GLOBAN.........800
     1      IN,VOL,PMAT,PVEC,UMAT,UVEC)                                  GLOBAN.........900
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                GLOBAN........1000
      DIMENSION BFLOWE(8,8),DFLOWE(8),BTRANE(8,8),DTRANE(8,8),VOLE(8)    GLOBAN........1100
      DIMENSION VOL(NN),PMAT(NELT,NCBI),PVEC(NNVEC)                      GLOBAN........1200
      DIMENSION UMAT(NELT,NCBI),UVEC(NNVEC)                              GLOBAN........1300
      DIMENSION IN(NIN)                                                  GLOBAN........1400
      DIMENSION KTYPE(2)                                                 GLOBAN........1500
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  GLOBAN........1600
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           GLOBAN........1700
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      GLOBAN........1800
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              GLOBAN........1900
     1   NSOP,NSOU,NBCN,NCIDB                                            GLOBAN........2000
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        GLOBAN........2100
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA                           GLOBAN........2200
C                                                                        GLOBAN........2300
      N1=(L-1)*N48+1                                                     GLOBAN........2400
      N8=N1+N48-1                                                        GLOBAN........2500
C                                                                        GLOBAN........2600
C.....ADD RESULTS OF INTEGRATIONS OVER ELEMENT L TO GLOBAL               GLOBAN........2700
C        P-MATRIX AND P-VECTOR                                           GLOBAN........2800
      IF(ML-1) 9050,9050,9150                                            GLOBAN........2900
 9050 IE=0                                                               GLOBAN........3000
      DO 9100 II=N1,N8                                                   GLOBAN........3100
      IE=IE+1                                                            GLOBAN........3200
      IB=IN(II)                                                          GLOBAN........3300
      VOL(IB)=VOL(IB)+VOLE(IE)                                           GLOBAN........3400
      PVEC(IB)=PVEC(IB)+DFLOWE(IE)                                       GLOBAN........3500
      JE=0                                                               GLOBAN........3600
      DO 9100 JJ=N1,N8                                                   GLOBAN........3700
      JE=JE+1                                                            GLOBAN........3800
      JB=IN(JJ)-IB+NBHALF                                                GLOBAN........3900
 9100 PMAT(IB,JB)=PMAT(IB,JB)+BFLOWE(IE,JE)                              GLOBAN........4000
      IF(ML-1) 9150,9300,9150                                            GLOBAN........4100
C                                                                        GLOBAN........4200
C.....ADD RESULTS OF INTEGRATIONS OVER ELEMENT L TO GLOBAL               GLOBAN........4300
C        U-MATRIX                                                        GLOBAN........4400
 9150 IF(NOUMAT.EQ.1) GOTO 9300                                          GLOBAN........4500
      IE=0                                                               GLOBAN........4600
      DO 9200 II=N1,N8                                                   GLOBAN........4700
      IE=IE+1                                                            GLOBAN........4800
      IB=IN(II)                                                          GLOBAN........4900
C.....POSITION FOR ADDITION TO U-VECTOR                                  GLOBAN........5000
C        UVEC(IB)=UVEC(IB)+ ((   ))                                      GLOBAN........5100
      JE=0                                                               GLOBAN........5200
      DO 9200 JJ=N1,N8                                                   GLOBAN........5300
      JE=JE+1                                                            GLOBAN........5400
      JB=IN(JJ)-IB+NBHALF                                                GLOBAN........5500
 9200 UMAT(IB,JB)=UMAT(IB,JB)+DTRANE(IE,JE)+BTRANE(IE,JE)                GLOBAN........5600
C                                                                        GLOBAN........5700
 9300 CONTINUE                                                           GLOBAN........5800
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  GLOBAN........5900
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  GLOBAN........6000
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  GLOBAN........6100
C                                                                        GLOBAN........6200
C                                                                        GLOBAN........6300
      RETURN                                                             GLOBAN........6400
      END                                                                GLOBAN........6500
C                                                                        GLOBAN........6600
C     SUBROUTINE        G  L  O  C  O  L           SUTRA VERSION 2.2     GLOCOL.........100
C                                                                        GLOCOL.........200
C *** PURPOSE :                                                          GLOCOL.........300
C ***  TO ASSEMBLE RESULTS OF ELEMENTWISE INTEGRATIONS INTO              GLOCOL.........400
C ***  A GLOBAL "SLAP COLUMN"-FORMAT MATRIX AND GLOBAL VECTOR            GLOCOL.........500
C ***  FOR BOTH FLOW AND TRANSPORT EQUATIONS.                            GLOCOL.........600
C                                                                        GLOCOL.........700
      SUBROUTINE GLOCOL(L,ML,VOLE,BFLOWE,DFLOWE,BTRANE,DTRANE,           GLOCOL.........800
     1      IN,VOL,PMAT,PVEC,UMAT,UVEC,IA,JA)                            GLOCOL.........900
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                GLOCOL........1000
      DIMENSION BFLOWE(8,8),DFLOWE(8),BTRANE(8,8),DTRANE(8,8),VOLE(8)    GLOCOL........1100
      DIMENSION VOL(NN),PMAT(NELT,NCBI),PVEC(NNVEC)                      GLOCOL........1200
      DIMENSION UMAT(NELT,NCBI),UVEC(NNVEC)                              GLOCOL........1300
      DIMENSION IN(NIN),IA(NDIMIA),JA(NDIMJA)                            GLOCOL........1400
      DIMENSION KTYPE(2)                                                 GLOCOL........1500
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  GLOCOL........1600
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           GLOCOL........1700
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      GLOCOL........1800
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              GLOCOL........1900
     1   NSOP,NSOU,NBCN,NCIDB                                            GLOCOL........2000
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        GLOCOL........2100
      COMMON /DIMX2/ NELTA, NNVEC, NDIMIA, NDIMJA                        GLOCOL........2200
C                                                                        GLOCOL........2300
      N1=(L-1)*N48+1                                                     GLOCOL........2400
      N8=N1+N48-1                                                        GLOCOL........2500
C                                                                        GLOCOL........2600
C.....ADD RESULTS OF INTEGRATIONS OVER ELEMENT L TO GLOBAL               GLOCOL........2700
C        P-MATRIX AND P-VECTOR                                           GLOCOL........2800
      IF(ML-1) 9050,9050,9150                                            GLOCOL........2900
 9050 IE=0                                                               GLOCOL........3000
      DO 9100 II=N1,N8                                                   GLOCOL........3100
      IE=IE+1                                                            GLOCOL........3200
      IB=IN(II)                                                          GLOCOL........3300
      VOL(IB)=VOL(IB)+VOLE(IE)                                           GLOCOL........3400
      PVEC(IB)=PVEC(IB)+DFLOWE(IE)                                       GLOCOL........3500
      JE=0                                                               GLOCOL........3600
      DO 9100 JJ=N1,N8                                                   GLOCOL........3700
      JE=JE+1                                                            GLOCOL........3800
      JB = IN(JJ)                                                        GLOCOL........3900
      MBEG = JA(JB)                                                      GLOCOL........4000
      MEND = JA(JB + 1) - 1                                              GLOCOL........4100
      DO 9060 MM=MBEG,MEND                                               GLOCOL........4200
         IF (IB.EQ.IA(MM)) THEN                                          GLOCOL........4300
            M = MM                                                       GLOCOL........4400
            GOTO 9100                                                    GLOCOL........4500
         END IF                                                          GLOCOL........4600
 9060 CONTINUE                                                           GLOCOL........4700
 9100 PMAT(M,1)=PMAT(M,1)+BFLOWE(IE,JE)                                  GLOCOL........4800
      IF(ML-1) 9150,9300,9150                                            GLOCOL........4900
C                                                                        GLOCOL........5000
C.....ADD RESULTS OF INTEGRATIONS OVER ELEMENT L TO GLOBAL               GLOCOL........5100
C        U-MATRIX                                                        GLOCOL........5200
 9150 IF(NOUMAT.EQ.1) GOTO 9300                                          GLOCOL........5300
      IE=0                                                               GLOCOL........5400
      DO 9200 II=N1,N8                                                   GLOCOL........5500
      IE=IE+1                                                            GLOCOL........5600
      IB=IN(II)                                                          GLOCOL........5700
C.....POSITION FOR ADDITION TO U-VECTOR                                  GLOCOL........5800
C        UVEC(IB)=UVEC(IB)+ ((   ))                                      GLOCOL........5900
      JE=0                                                               GLOCOL........6000
      DO 9200 JJ=N1,N8                                                   GLOCOL........6100
      JE=JE+1                                                            GLOCOL........6200
      JB = IN(JJ)                                                        GLOCOL........6300
      MBEG = JA(JB)                                                      GLOCOL........6400
      MEND = JA(JB + 1) - 1                                              GLOCOL........6500
      DO 9160 MM=MBEG,MEND                                               GLOCOL........6600
         IF (IB.EQ.IA(MM)) THEN                                          GLOCOL........6700
            M = MM                                                       GLOCOL........6800
            GOTO 9200                                                    GLOCOL........6900
         END IF                                                          GLOCOL........7000
 9160 CONTINUE                                                           GLOCOL........7100
 9200 UMAT(M,1)=UMAT(M,1)+DTRANE(IE,JE)+BTRANE(IE,JE)                    GLOCOL........7200
C                                                                        GLOCOL........7300
 9300 CONTINUE                                                           GLOCOL........7400
 9999 CONTINUE                                                           GLOCOL........7500
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  GLOCOL........7600
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  GLOCOL........7700
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  GLOCOL........7800
C                                                                        GLOCOL........7900
C                                                                        GLOCOL........8000
      RETURN                                                             GLOCOL........8100
      END                                                                GLOCOL........8200
C                                                                        GLOCOL........8300
C     SUBROUTINE        I  N  D  A  T  0           SUTRA VERSION 2.2     INDAT0.........100
C                                                                        INDAT0.........200
C *** PURPOSE :                                                          INDAT0.........300
C ***  TO INPUT, OUTPUT, AND ORGANIZE A PORTION OF THE INP FILE          INDAT0.........400
C ***  INPUT DATA (DATASETS 5 THROUGH 7)                                 INDAT0.........500
C                                                                        INDAT0.........600
      SUBROUTINE INDAT0()                                                INDAT0.........700
      USE EXPINT                                                         INDAT0.........800
      USE LLDEF                                                          INDAT0.........900
      USE SCHDEF                                                         INDAT0........1000
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                INDAT0........1100
      CHARACTER INTFIL*1000                                              INDAT0........1200
      CHARACTER*10 ADSMOD                                                INDAT0........1300
      CHARACTER SOLWRD(0:10)*10,SOLNAM(0:10)*40                          INDAT0........1400
      CHARACTER*10 CSOLVP,CSOLVU                                         INDAT0........1500
      CHARACTER*80 ERRCOD,CHERR(10),UNAME,FNAME(0:13)                    INDAT0........1600
      CHARACTER SCHTYP*12, CDUM10*10, CDUM80*80                          INDAT0........1700
      CHARACTER*10 SCHNAM                                                INDAT0........1800
      CHARACTER CTICS*20, CREFT*8                                        INDAT0........1900
      DIMENSION INERR(10),RLERR(10)                                      INDAT0........2000
      DIMENSION KTYPE(2)                                                 INDAT0........2100
      ALLOCATABLE :: ISLIST(:), TLIST(:), DTMP1(:), DTMP2(:)             INDAT0........2200
      CHARACTER*8 VERNUM, VERNIN                                         INDAT0........2300
      LOGICAL, ALLOCATABLE :: SBASED(:), ELAPSD(:)                       INDAT0........2400
      LOGICAL TSYES                                                      INDAT0........2500
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  INDAT0........2600
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           INDAT0........2700
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      INDAT0........2800
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              INDAT0........2900
     1   NSOP,NSOU,NBCN,NCIDB                                            INDAT0........3000
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        INDAT0........3100
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA                           INDAT0........3200
      COMMON /FNAMES/ UNAME,FNAME                                        INDAT0........3300
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 INDAT0........3400
     1   K10,K11,K12,K13                                                 INDAT0........3500
      COMMON /GRAVEC/ GRAVX,GRAVY,GRAVZ                                  INDAT0........3600
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS      INDAT0........3700
      COMMON /ITSOLI/ ITRMXP,ITOLP,NSAVEP,ITRMXU,ITOLU,NSAVEU            INDAT0........3800
      COMMON /ITSOLR/ TOLP,TOLU                                          INDAT0........3900
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                INDAT0........4000
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            INDAT0........4100
      COMMON /MODSOR/ ADSMOD                                             INDAT0........4200
      COMMON /SCH/ NSCH,ISCHTS,NSCHAU                                    INDAT0........4300
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,      INDAT0........4400
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2        INDAT0........4500
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /SOLVC/ SOLWRD,SOLNAM                                       INDAT0........4600
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                           INDAT0........4700
      COMMON /SOLVN/ NSLVRS                                              INDAT0........4800
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       INDAT0........4900
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      INDAT0........5000
      COMMON /VER/ VERNUM, VERNIN                                        INDAT0........5100
C                                                                        INDAT0........5200
      INSTOP=0                                                           INDAT0........5300
C                                                                        INDAT0........5400
C.....INPUT DATASET 5: NUMERICAL CONTROL PARAMETERS                      INDAT0........5500
      ERRCOD = 'REA-INP-5'                                               INDAT0........5600
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT0........5700
      READ(INTFIL,*,IOSTAT=INERR(1)) UP,GNUP,GNUU                        INDAT0........5800
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT0........5900
      IF(ME.EQ.-1) WRITE(K3,70) UP,GNUP,GNUU                             INDAT0........6000
   70 FORMAT(////11X,'N U M E R I C A L   C O N T R O L   D A T A'//     INDAT0........6100
     1   11X,F15.5,5X,'"UPSTREAM WEIGHTING" FACTOR'/                     INDAT0........6200
     2   11X,1PE15.4,5X,'SPECIFIED PRESSURE BOUNDARY CONDITION FACTOR'/  INDAT0........6300
     3   11X,1PE15.4,5X,'SPECIFIED CONCENTRATION BOUNDARY CONDITION ',   INDAT0........6400
     4   'FACTOR')                                                       INDAT0........6500
      IF(ME.EQ.+1) WRITE(K3,80) UP,GNUP,GNUU                             INDAT0........6600
   80 FORMAT(////11X,'N U M E R I C A L   C O N T R O L   D A T A'//     INDAT0........6700
     1   11X,F15.5,5X,'"UPSTREAM WEIGHTING" FACTOR'/                     INDAT0........6800
     2   11X,1PE15.4,5X,'SPECIFIED PRESSURE BOUNDARY CONDITION FACTOR'/  INDAT0........6900
     3   11X,1PE15.4,5X,'SPECIFIED TEMPERATURE BOUNDARY CONDITION ',     INDAT0........7000
     4   'FACTOR')                                                       INDAT0........7100
C                                                                        INDAT0........7200
C.....INPUT DATASET 6: TEMPORAL CONTROL AND SOLUTION CYCLING DATA        INDAT0........7300
      ERRCOD = 'REA-ICS-1'                                               INDAT0........7400
      CALL READIF(K2, 0, INTFIL, ERRCOD)                                 INDAT0........7500
      IF (IREAD.EQ.+1) THEN                                              INDAT0........7600
         READ(INTFIL,*,IOSTAT=INERR(1)) TICS                             INDAT0........7700
      ELSE                                                               INDAT0........7800
         READ(INTFIL,*,IOSTAT=INERR(1)) TICS,DUM,DUM,IDUM,TICS0          INDAT0........7900
      END IF                                                             INDAT0........8000
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT0........8100
      REWIND(K2)                                                         INDAT0........8200
      WRITE(CTICS,'(E20.10)') TICS                                       INDAT0........8300
      WRITE(K3,120)                                                      INDAT0........8400
  120 FORMAT('1'////11X,'T E M P O R A L   C O N T R O L   A N D   ',    INDAT0........8500
     1   'S O L U T I O N   C Y C L I N G   D A T A')                    INDAT0........8600
      ERRCOD = 'REA-INP-6'                                               INDAT0........8700
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT0........8800
      READ(INTFIL,*,IOSTAT=INERR(1)) NSCH                                INDAT0........8900
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT0........9000
C.....SET NUMBER OF USUAL AUTOMATIC SCHEDULES THAT WILL BE CREATED.      INDAT0........9100
C        CURRENTLY, THESE ARE "STEPS_1&UP", "STEP_0", AND "STEP_1".      INDAT0........9200
      NSCHAU = 3                                                         INDAT0........9300
C.....IF VERSION 2.0 INPUT, RE-READ DATASET IN OLD FORMAT.  ELSE IF      INDAT0........9400
C        NSCH>0, RE-READ FIRST LINE OF DATASET IN NEW FORMAT.  ELSE      INDAT0........9500
C        IF NSCH<0, OR NSCH=0 AND TRANSPORT IS NOT STEADY-STATE,         INDAT0........9600
C        GENERATE ERROR.                                                 INDAT0........9700
      IF (VERNIN.EQ."2.0") THEN                                          INDAT0........9800
C........READ TEMPORAL AND SOLUTION CYCLING CONTROLS.                    INDAT0........9900
         READ(INTFIL,*,IOSTAT=INERR(1)) ITMAX,DELT,TMAX,ITCYC,DTMULT,    INDAT0.......10000
     1      DTMAX,NPCYC,NUCYC                                            INDAT0.......10100
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT0.......10200
C........ERROR CHECKING SPECIFIC TO OLD FORMAT.                          INDAT0.......10300
         IF (DELT.GT.DTMAX) THEN                                         INDAT0.......10400
            ERRCOD = 'INP-6-3'                                           INDAT0.......10500
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     INDAT0.......10600
         END IF                                                          INDAT0.......10700
      ELSE IF (NSCH.GT.0) THEN                                           INDAT0.......10800
C........READ FIRST LINE OF DATASET.                                     INDAT0.......10900
         READ(INTFIL,*,IOSTAT=INERR(1)) NSCH, NPCYC, NUCYC               INDAT0.......11000
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT0.......11100
      ELSE IF (NSCH.LT.0) THEN                                           INDAT0.......11200
            ERRCOD = 'INP-6-8'                                           INDAT0.......11300
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     INDAT0.......11400
      ELSE                                                               INDAT0.......11500
         IF (ISSTRA.EQ.0) THEN                                           INDAT0.......11600
            ERRCOD = 'INP-6-13'                                          INDAT0.......11700
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     INDAT0.......11800
         END IF                                                          INDAT0.......11900
         NPCYC = 1                                                       INDAT0.......12000
         NUCYC = 1                                                       INDAT0.......12100
      END IF                                                             INDAT0.......12200
C.....ERROR CHECKING COMMON TO BOTH FORMATS.                             INDAT0.......12300
      IF (NPCYC.LT.1.OR.NUCYC.LT.1) THEN                                 INDAT0.......12400
         ERRCOD = 'INP-6-1'                                              INDAT0.......12500
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT0.......12600
      ELSE IF (NPCYC.NE.1.AND.NUCYC.NE.1) THEN                           INDAT0.......12700
         ERRCOD = 'INP-6-2'                                              INDAT0.......12800
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT0.......12900
      END IF                                                             INDAT0.......13000
C.....IF TRANSPORT IS STEADY-STATE, SKIP THROUGH THE REST OF THE         INDAT0.......13100
C        DATASET AND CREATE A TRIVIAL "TIME_STEPS" SCHEDULE.             INDAT0.......13200
C        (NOTE THAT IF TRANSPORT IS STEADY-STATE, SO IS FLOW.)           INDAT0.......13300
C        EVENTUALLY, IN ADDITION, THE USUAL AUTOMATIC SCHEDULES WILL     INDAT0.......13400
C        BE CREATED.                                                     INDAT0.......13500
      IF (ISSTRA.EQ.1) THEN                                              INDAT0.......13600
         TSTART = TICS                                                   INDAT0.......13700
         IF (VERNIN.NE."2.0") THEN                                       INDAT0.......13800
            ERRCOD = 'REA-INP-6'                                         INDAT0.......13900
            CDUM10 = ''                                                  INDAT0.......14000
            DO WHILE (CDUM10.NE.'-')                                     INDAT0.......14100
               CALL READIF(K1, 0, INTFIL, ERRCOD)                        INDAT0.......14200
               IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR,      INDAT0.......14300
     1            RLERR)                                                 INDAT0.......14400
               READ(INTFIL,*,IOSTAT=INERR(1)) CDUM10                     INDAT0.......14500
            END DO                                                       INDAT0.......14600
            DELT = MAX(1D-1*DABS(TSTART), 1D0)                           INDAT0.......14700
         END IF                                                          INDAT0.......14800
         NSCH = 1 + NSCHAU                                               INDAT0.......14900
         ALLOCATE(SCHDLS(NSCH))                                          INDAT0.......15000
         DO 135 NS=1,NSCH                                                INDAT0.......15100
            ALLOCATE(SCHDLS(NS)%SLIST, SCHDLS(NS)%SLAST)                 INDAT0.......15200
            SCHDLS(NS)%LLEN = 0                                          INDAT0.......15300
  135    CONTINUE                                                        INDAT0.......15400
         ISCHTS = 1                                                      INDAT0.......15500
         SCHDLS(ISCHTS)%NAME = 'TIME_STEPS'                              INDAT0.......15600
         NS1UP = 2                                                       INDAT0.......15700
         SCHDLS(NS1UP)%NAME = 'STEPS_1&UP'                               INDAT0.......15800
         NS0 = 3                                                         INDAT0.......15900
         SCHDLS(NS0)%NAME = 'STEP_0'                                     INDAT0.......16000
         NS1 = 4                                                         INDAT0.......16100
         SCHDLS(NS1)%NAME = 'STEP_1'                                     INDAT0.......16200
         TIME = TSTART                                                   INDAT0.......16300
         STEP = 0D0                                                      INDAT0.......16400
         CALL LLDINS(SCHDLS(ISCHTS)%LLEN, SCHDLS(ISCHTS)%SLIST, TIME,    INDAT0.......16500
     1      STEP, SCHDLS(ISCHTS)%SLAST)                                  INDAT0.......16600
         CALL LLDINS(SCHDLS(NS0)%LLEN, SCHDLS(NS0)%SLIST, TIME, STEP,    INDAT0.......16700
     1      SCHDLS(NS0)%SLAST)                                           INDAT0.......16800
         TIME = TIME + DELT                                              INDAT0.......16900
         STEP = 1D0                                                      INDAT0.......17000
         CALL LLDINS(SCHDLS(ISCHTS)%LLEN, SCHDLS(ISCHTS)%SLIST, TIME,    INDAT0.......17100
     1      STEP, SCHDLS(ISCHTS)%SLAST)                                  INDAT0.......17200
         CALL LLDINS(SCHDLS(NS1)%LLEN, SCHDLS(NS1)%SLIST, TIME, STEP,    INDAT0.......17300
     1      SCHDLS(NS1)%SLAST)                                           INDAT0.......17400
         CALL LLDINS(SCHDLS(NS1UP)%LLEN, SCHDLS(NS1UP)%SLIST, TIME,      INDAT0.......17500
     1       STEP, SCHDLS(NS1UP)%SLAST)                                  INDAT0.......17600
         ITMAX = 1                                                       INDAT0.......17700
C........WRITE STEADY-STATE OUTPUT INFORMATION AND BEGIN WRITING         INDAT0.......17800
C           DESCRIPTIONS OF SCHEDULES DEFINED BY SUTRA.                  INDAT0.......17900
         WRITE(K3,138) NSCH                                              INDAT0.......18000
  138    FORMAT (/13X,'NOTE: BECAUSE FLOW AND TRANSPORT ARE STEADY-',    INDAT0.......18100
     1      'STATE, USER-DEFINED SCHEDULES ARE NOT IN EFFECT.  '         INDAT0.......18200
     2      /13X,'STEADY-STATE RESULTS WILL BE WRITTEN TO THE ',         INDAT0.......18300
     3      'APPROPRIATE OUTPUT FILES.'                                  INDAT0.......18400
     4      //13X,'THE FOLLOWING ',I1,' SCHEDULES CAN BE USED ',         INDAT0.......18500
     5      'TO CONTROL SPECIFICATION OF STEADY-STATE BOUNDARY'          INDAT0.......18600
     6      /13X,'CONDITIONS IN (OPTIONAL) .BCS FILES:')                 INDAT0.......18700
         WRITE(K3,139) "TIME_STEPS"                                      INDAT0.......18800
  139    FORMAT(/16X,'SCHEDULE ',A10, 3X,'CONSISTS OF TIME STEPS 0 ',    INDAT0.......18900
     1      '(STEADY FLOW) AND 1 (STEADY TRANSPORT);',                   INDAT0.......19000
     2      /41X,'THIS SCHEDULE IS DEFINED AUTOMATICALLY BY SUTRA')      INDAT0.......19100
C........SKIP OVER PROCESSING AND WRITING OF TEMPORAL DATA.              INDAT0.......19200
         GOTO 846                                                        INDAT0.......19300
      END IF                                                             INDAT0.......19400
C.....IF DATASET IN OLD FORMAT, WRITE SPECIFICATIONS AND                 INDAT0.......19500
C        CREATE A CORRESPONDING SCHEDULE CALLED "TIME_STEPS".            INDAT0.......19600
C        IF NSCH=0, GENERATE AN ERROR.  IF IN NEW FORMAT, READ           INDAT0.......19700
C        AND PROCESS USER-DEFINED SCHEDULES.                             INDAT0.......19800
      IF (VERNIN.EQ."2.0") THEN                                          INDAT0.......19900
         TSTART = TICS                                                   INDAT0.......20000
         WRITE(K3,150) ITMAX,DELT,TMAX,ITCYC,DTMULT,DTMAX                INDAT0.......20100
  150    FORMAT (/13X,'NOTE: BECAUSE TEMPORAL CONTROL AND SOLUTION ',    INDAT0.......20200
     1      'CYCLING DATA WERE ENTERED USING THE OLD (VERSION 2D3D.1) ', INDAT0.......20300
     2      'INPUT FORMAT,'/13X,'A CORRESPONDING SCHEDULE, ',            INDAT0.......20400
     3      '"TIME_STEPS", WAS CREATED AUTOMATICALLY FROM THE ',         INDAT0.......20500
     4      'FOLLOWING PARAMETERS:'                                      INDAT0.......20600
     5      //11X,I15,5X,'MAXIMUM ALLOWED NUMBER OF TIME STEPS'          INDAT0.......20700
     6      /11X,1PE15.4,5X,'INITIAL TIME STEP (IN SECONDS)'             INDAT0.......20800
     7      /11X,1PE15.4,5X,'MAXIMUM ALLOWED SIMULATION TIME ',          INDAT0.......20900
     8      '(IN SECONDS)'                                               INDAT0.......21000
     9      //11X,I15,5X,'TIME STEP MULTIPLIER CYCLE (IN TIME STEPS)'    INDAT0.......21100
     1      /11X,0PF15.5,5X,'MULTIPLICATION FACTOR FOR TIME STEP CHANGE' INDAT0.......21200
     2      /11X,1PE15.4,5X,'MAXIMUM ALLOWED TIME STEP (IN SECONDS)')    INDAT0.......21300
C........FIVE DEFAULT SCHEDULES WILL EVENTUALLY BE DEFINED:              INDAT0.......21400
C           "TIME_STEPS", WHICH CONTROLS TIME STEPPING; "STEPS_1&UP",    INDAT0.......21500
C           WHICH IS IDENTICAL TO "TIME_STEPS" EXCEPT THAT IT OMITS      INDAT0.......21600
C           TIME STEP 0; "STEP_0", WHICH CONSISTS ONLY OF TIME STEP 0;   INDAT0.......21700
C           "STEP_1", WHICH CONSISTS ONLY OF TIME STEP 1; AND "OBS",     INDAT0.......21800
C           WHICH CONTROLS TIMING OF OBSERVATION OUTPUT.  SET THE        INDAT0.......21900
C           NUMBER OF SCHEDULES ACCORDINGLY AND ALLOCATE THE SCHEDULE    INDAT0.......22000
C           ARRAY AND ITS LINKED LISTS.                                  INDAT0.......22100
         NSCH = 5                                                        INDAT0.......22200
         ALLOCATE(SCHDLS(NSCH))                                          INDAT0.......22300
         DO 185 NS=1,NSCH                                                INDAT0.......22400
            ALLOCATE(SCHDLS(NS)%SLIST, SCHDLS(NS)%SLAST)                 INDAT0.......22500
            SCHDLS(NS)%LLEN = 0                                          INDAT0.......22600
  185    CONTINUE                                                        INDAT0.......22700
C........DEFINE THE DEFAULT "TIME_STEPS" SCHEDULE BASED ON THE           INDAT0.......22800
C           TEMPORAL CONTROLS.  NOTE THAT, FOR BACKWARD COMPATIBILITY    INDAT0.......22900
C           WITH OLD DATASETS, THE ORIGINAL METHOD OF HANDLING CHANGES   INDAT0.......23000
C           IN TIME STEP SIZE [BASED ON MOD(JT,ITCYC).EQ.0, NOT          INDAT0.......23100
C           MOD(JT-1,ITCYC).EQ.0] HAS BEEN RETAINED.                     INDAT0.......23200
C           AT THE SAME TIME, DEFINE SCHEDULE "STEPS_1&UP".              INDAT0.......23300
         SCHDLS(1)%NAME = "TIME_STEPS"                                   INDAT0.......23400
         SCHDLS(3)%NAME = "STEPS_1&UP"                                   INDAT0.......23500
         TIME = TSTART                                                   INDAT0.......23600
         STEP = 0D0                                                      INDAT0.......23700
         CALL LLDINS(SCHDLS(1)%LLEN, SCHDLS(1)%SLIST, TIME, STEP,        INDAT0.......23800
     1      SCHDLS(1)%SLAST)                                             INDAT0.......23900
         DTIME = DELT                                                    INDAT0.......24000
         DO 580 JT=1,ITMAX                                               INDAT0.......24100
            IF (MOD(JT,ITCYC).EQ.0 .AND. JT.GT.1) DTIME=DTIME*DTMULT     INDAT0.......24200
            IF (DTIME.GT.DTMAX) DTIME = DTMAX                            INDAT0.......24300
            TIME = TIME + DTIME                                          INDAT0.......24400
            STEP = DBLE(JT)                                              INDAT0.......24500
            CALL LLDINS(SCHDLS(1)%LLEN, SCHDLS(1)%SLIST, TIME, STEP,     INDAT0.......24600
     1         SCHDLS(1)%SLAST)                                          INDAT0.......24700
            CALL LLDINS(SCHDLS(3)%LLEN, SCHDLS(3)%SLIST, TIME, STEP,     INDAT0.......24800
     1         SCHDLS(3)%SLAST)                                          INDAT0.......24900
            IF (TIME.GE.TMAX) EXIT                                       INDAT0.......25000
  580    CONTINUE                                                        INDAT0.......25100
         ITMAX = SCHDLS(1)%LLEN - 1                                      INDAT0.......25200
         ISCHTS = 1                                                      INDAT0.......25300
C........SKIP OVER THE CODE THAT READS SCHEDULE SPECIFICATIONS.          INDAT0.......25400
         GOTO 850                                                        INDAT0.......25500
      END IF                                                             INDAT0.......25600
C.....INCREMENT NSCH TO ACCOUNT FOR THREE AUTOMATICALLY DEFINED          INDAT0.......25700
C        SCHEDULES: "STEPS_1&UP", WHICH IS IDENTICAL TO "TIME_STEPS"     INDAT0.......25800
C        EXCEPT THAT IT OMITS TIME STEP 0; "STEP_0", WHICH CONSISTS      INDAT0.......25900
C        ONLY OF TIME STEP 0; AND "STEP_1", WHICH CONSISTS ONLY OF       INDAT0.......26000
C        TIME STEP 1.                                                    INDAT0.......26100
      NSCH = NSCH + NSCHAU                                               INDAT0.......26200
C.....WRITE SCHEDULE PARAMETERS.                                         INDAT0.......26300
      WRITE(K3,700) NSCH                                                 INDAT0.......26400
  700 FORMAT(/13X,'THE ',I5,' SCHEDULES ARE LISTED BELOW.'               INDAT0.......26500
     1   '  SCHEDULE "TIME_STEPS" CONTROLS TIME STEPPING.')              INDAT0.......26600
C.....ALLOCATE SCHEDULE-RELATED ARRAYS AND INITIALIZE SCHEDULE NUMBER    INDAT0.......26700
C        FOR "TIME_STEPS".                                               INDAT0.......26800
      ALLOCATE(SCHDLS(NSCH), SBASED(NSCH), ELAPSD(NSCH))                 INDAT0.......26900
      ISCHTS = 0                                                         INDAT0.......27000
C.....LOOP THROUGH THE LIST OF SCHEDULE SPECIFICATIONS, CONSTRUCTING     INDAT0.......27100
C        SCHEDULES.                                                      INDAT0.......27200
      DO 800 I=1,NSCH-NSCHAU                                             INDAT0.......27300
C........ALLOCATE HEAD OF LINKED LIST FOR THE CURRENT SCHEDULE AND SET   INDAT0.......27400
C           LIST LENGTH TO ZERO.                                         INDAT0.......27500
         ALLOCATE(SCHDLS(I)%SLIST, SCHDLS(I)%SLAST)                      INDAT0.......27600
         SCHDLS(I)%LLEN = 0                                              INDAT0.......27700
C........READ SCHEDULE NAME AND DO SOME ERROR CHECKING.                  INDAT0.......27800
         ERRCOD = 'REA-INP-6'                                            INDAT0.......27900
         CALL READIF(K1, 0, INTFIL, ERRCOD)                              INDAT0.......28000
         READ(INTFIL,*,IOSTAT=INERR(1)) CDUM80                           INDAT0.......28100
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT0.......28200
         IF (LEN_TRIM(CDUM80).GT.10) THEN                                INDAT0.......28300
            ERRCOD = 'INP-6-15'                                          INDAT0.......28400
            CHERR(1) = CDUM80                                            INDAT0.......28500
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     INDAT0.......28600
         ELSE IF (CDUM80.EQ."-") THEN                                    INDAT0.......28700
            ERRCOD = 'INP-6-4'                                           INDAT0.......28800
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     INDAT0.......28900
         ELSE IF ((CDUM80.EQ."STEPS_1&UP").OR.                           INDAT0.......29000
     1            (CDUM80.EQ."STEP_0").OR.(CDUM80.EQ."STEP_1")) THEN     INDAT0.......29100
            ERRCOD = 'INP-6-11'                                          INDAT0.......29200
            CHERR(1) = CDUM80                                            INDAT0.......29300
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     INDAT0.......29400
         ELSE                                                            INDAT0.......29500
            DO 710 II=1,I-1                                              INDAT0.......29600
               IF (CDUM80.EQ.SCHDLS(II)%NAME) THEN                       INDAT0.......29700
                  ERRCOD = 'INP-6-5'                                     INDAT0.......29800
                  CHERR(1) = CDUM80                                      INDAT0.......29900
                  CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)               INDAT0.......30000
               END IF                                                    INDAT0.......30100
  710       CONTINUE                                                     INDAT0.......30200
         END IF                                                          INDAT0.......30300
C........(RE)READ SCHEDULE NAME AND TYPE.                                INDAT0.......30400
         READ(INTFIL,*,IOSTAT=INERR(1)) SCHNAM, SCHTYP                   INDAT0.......30500
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT0.......30600
C........BASED ON THE SCHEDULE TYPE, READ IN THE SPECIFICATIONS AND      INDAT0.......30700
C           CONSTRUCT THE SCHEDULE.                                      INDAT0.......30800
         IF (SCHTYP.EQ."STEP CYCLE") THEN                                INDAT0.......30900
            SBASED(I) = .TRUE.                                           INDAT0.......31000
C...........READ ALL THE SPECIFICATIONS.                                 INDAT0.......31100
            READ(INTFIL,*,IOSTAT=INERR(1)) SCHNAM, SCHTYP,               INDAT0.......31200
     1         NSMAX, ISTEPI, ISTEPL, ISTEPC                             INDAT0.......31300
            IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)  INDAT0.......31400
            SCHDLS(I)%NAME = SCHNAM                                      INDAT0.......31500
            ELAPSD(I) = .FALSE.                                          INDAT0.......31600
C...........CONSTRUCT THE SCHEDULE BY STEPPING THROUGH THE STEP CYCLE    INDAT0.......31700
C              AND STORING THE RESULTS IN THE LINKED LIST.  SET TIME     INDAT0.......31800
C              EQUAL TO STEP FOR NOW SO THAT THE LIST IS CONSTRUCTED     INDAT0.......31900
C              IN THE PROPER ORDER.                                      INDAT0.......32000
            NSTEP = ISTEPI                                               INDAT0.......32100
            NDSTEP = ISTEPC                                              INDAT0.......32200
            STEP = DNINT(DBLE(NSTEP))                                    INDAT0.......32300
            TIME = STEP                                                  INDAT0.......32400
            CALL LLDINS(SCHDLS(I)%LLEN, SCHDLS(I)%SLIST, TIME, STEP,     INDAT0.......32500
     1         SCHDLS(I)%SLAST)                                          INDAT0.......32600
            DO 720 NS=1,NSMAX                                            INDAT0.......32700
               NSTEP = NSTEP + NDSTEP                                    INDAT0.......32800
               STEP = DNINT(DBLE(NSTEP))                                 INDAT0.......32900
               TIME = STEP                                               INDAT0.......33000
               CALL LLDINS(SCHDLS(I)%LLEN, SCHDLS(I)%SLIST, TIME, STEP,  INDAT0.......33100
     1            SCHDLS(I)%SLAST)                                       INDAT0.......33200
  720       CONTINUE                                                     INDAT0.......33300
C...........WRITE OUT THE SPECIFICATIONS.                                INDAT0.......33400
            WRITE(K3,722) SCHDLS(I)%NAME, NSMAX, ISTEPI, ISTEPL, ISTEPC  INDAT0.......33500
  722       FORMAT(/16X,'SCHEDULE ',A, 3X,'STEP CYCLE WITH THE ',        INDAT0.......33600
     1         'FOLLOWING SPECIFICATIONS:'                               INDAT0.......33700
     2         /40X, I8, 5X, 'MAXIMUM NUMBER OF TIME STEPS AFTER ',      INDAT0.......33800
     3            'INITIAL TIME STEP NUMBER'                             INDAT0.......33900
     4         /40X, I8, 5X, 'INITIAL TIME STEP NUMBER'                  INDAT0.......34000
     5         /40X, I8, 5X, 'LIMITING TIME STEP NUMBER'                 INDAT0.......34100
     6         /40X, I8, 5X, 'TIME STEP INCREMENT')                      INDAT0.......34200
         ELSE IF (SCHTYP.EQ."TIME CYCLE") THEN                           INDAT0.......34300
            SBASED(I) = .FALSE.                                          INDAT0.......34400
C...........READ ALL THE SPECIFICATIONS.                                 INDAT0.......34500
            READ(INTFIL,*,IOSTAT=INERR(1)) SCHNAM, SCHTYP, CREFT,        INDAT0.......34600
     1         SCALT, NTMAX, TIMEI, TIMEL, TIMEC, NTCYC,                 INDAT0.......34700
     2         TCMULT, TCMIN, TCMAX                                      INDAT0.......34800
            IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)  INDAT0.......34900
            SCHDLS(I)%NAME = SCHNAM                                      INDAT0.......35000
            IF (CREFT.EQ.'ELAPSED ') THEN                                INDAT0.......35100
               IF ((SCHNAM.EQ.'TIME_STEPS').AND.(TIMEI.NE.0D0)) THEN     INDAT0.......35200
                  ERRCOD = 'INP-6-7'                                     INDAT0.......35300
                  CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)               INDAT0.......35400
               END IF                                                    INDAT0.......35500
               ELAPSD(I) = .TRUE.                                        INDAT0.......35600
            ELSE IF (CREFT.EQ.'ABSOLUTE') THEN                           INDAT0.......35700
               ELAPSD(I) = .FALSE.                                       INDAT0.......35800
            ELSE                                                         INDAT0.......35900
               ERRCOD = 'INP-6-6'                                        INDAT0.......36000
               CHERR(1) = CREFT                                          INDAT0.......36100
               CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                  INDAT0.......36200
            END IF                                                       INDAT0.......36300
C...........SCALE ALL TIME SPECIFICATIONS                                INDAT0.......36400
            TIMEI = TIMEI*SCALT                                          INDAT0.......36500
            TIMEL = TIMEL*SCALT                                          INDAT0.......36600
            TIMEC = TIMEC*SCALT                                          INDAT0.......36700
            TCMIN = TCMIN*SCALT                                          INDAT0.......36800
            TCMAX = TCMAX*SCALT                                          INDAT0.......36900
C...........CONSTRUCT THE SCHEDULE BY STEPPING THROUGH THE TIME CYCLE    INDAT0.......37000
C              AND STORING THE RESULTS IN THE LINKED LIST.               INDAT0.......37100
            TIME = TIMEI                                                 INDAT0.......37200
            STEP = FRCSTP(TIME)                                          INDAT0.......37300
            DTIME = TIMEC                                                INDAT0.......37400
            CALL LLDINS(SCHDLS(I)%LLEN, SCHDLS(I)%SLIST, TIME, STEP,     INDAT0.......37500
     1         SCHDLS(I)%SLAST)                                          INDAT0.......37600
            DO 730 NT=1,NTMAX                                            INDAT0.......37700
               IF (MOD(NT-1,NTCYC).EQ.0 .AND. NT.GT.1)                   INDAT0.......37800
     1            DTIME=DTIME*TCMULT                                     INDAT0.......37900
               IF (DTIME.GT.TCMAX) DTIME = TCMAX                         INDAT0.......38000
               IF (DTIME.LT.TCMIN) DTIME = TCMIN                         INDAT0.......38100
               TIME = TIME + DTIME                                       INDAT0.......38200
               STEP = FRCSTP(TIME)                                       INDAT0.......38300
               CALL LLDINS(SCHDLS(I)%LLEN, SCHDLS(I)%SLIST, TIME, STEP,  INDAT0.......38400
     1            SCHDLS(I)%SLAST)                                       INDAT0.......38500
               IF (TIME.GE.TIMEL) EXIT                                   INDAT0.......38600
  730       CONTINUE                                                     INDAT0.......38700
C...........WRITE OUT THE SPECIFICATIONS.                                INDAT0.......38800
            WRITE(K3,732) SCHDLS(I)%NAME, TRIM(CREFT), NTMAX, TIMEI,     INDAT0.......38900
     1          TIMEL, TIMEC, NTCYC, TCMULT, TCMIN, TCMAX                INDAT0.......39000
  732       FORMAT(/16X,'SCHEDULE ',A, 3X,'TIME CYCLE WITH THE ',        INDAT0.......39100
     1         'FOLLOWING SPECIFICATIONS IN TERMS OF ', A, ' TIMES:'     INDAT0.......39200
     2         /46X, I8, 5X, 'MAXIMUM NUMBER OF TIMES AFTER ',           INDAT0.......39300
     3            'INITIAL TIME'                                         INDAT0.......39400
     4         /39X, 1PE15.7, 5X, 'INITIAL TIME'                         INDAT0.......39500
     5         /39X, 1PE15.7, 5X, 'LIMITING TIME'                        INDAT0.......39600
     6         /39X, 1PE15.7, 5X, 'INITIAL TIME INCREMENT'               INDAT0.......39700
     7         /46X, I8, 5X, 'TIME INCREMENT CHANGE CYCLE '              INDAT0.......39800
     8         /39X, 1PE15.7, 5X, 'TIME INCREMENT MULTIPLIER'            INDAT0.......39900
     9         /39X, 1PE15.7, 5X, 'MINIMUM TIME INCREMENT'               INDAT0.......40000
     1         /39X, 1PE15.7, 5X, 'MAXIMUM TIME INCREMENT')              INDAT0.......40100
         ELSE IF (SCHTYP.EQ."STEP LIST") THEN                            INDAT0.......40200
            SBASED(I) = .TRUE.                                           INDAT0.......40300
C...........READ THE SCHEDULE NAME, TYPE, AND LENGTH.                    INDAT0.......40400
            BACKSPACE(K1)                                                INDAT0.......40500
            READ(K1,*,IOSTAT=INERR(1)) SCHNAM, SCHTYP, NSLIST            INDAT0.......40600
            IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)  INDAT0.......40700
C...........ALLOCATE A TEMPORARY ARRAY TO HOLD THE STEP LIST.            INDAT0.......40800
            ALLOCATE (ISLIST(NSLIST))                                    INDAT0.......40900
C...........READ ALL THE SPECIFICATIONS.                                 INDAT0.......41000
            BACKSPACE(K1)                                                INDAT0.......41100
            READ(K1,*,IOSTAT=INERR(1)) SCHNAM, SCHTYP,                   INDAT0.......41200
     1         NSLIST, (ISLIST(NS),NS=1,NSLIST)                          INDAT0.......41300
            IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)  INDAT0.......41400
            SCHDLS(I)%NAME = SCHNAM                                      INDAT0.......41500
            ELAPSD(I) = .FALSE.                                          INDAT0.......41600
C...........CONSTRUCT THE SCHEDULE BY TRANSFERRING THE LIST FROM ARRAY   INDAT0.......41700
C              ISLIST TO THE LINKED LIST.  SET TIME EQUAL TO STEP FOR    INDAT0.......41800
C              NOW SO THAT THE LIST IS CONSTRUCTED IN THE PROPER ORDER.  INDAT0.......41900
            DO 740 NS=1,NSLIST                                           INDAT0.......42000
               NSTEP = ISLIST(NS)                                        INDAT0.......42100
               STEP = DNINT(DBLE(NSTEP))                                 INDAT0.......42200
               TIME = STEP                                               INDAT0.......42300
               CALL LLDINS(SCHDLS(I)%LLEN, SCHDLS(I)%SLIST, TIME, STEP,  INDAT0.......42400
     1            SCHDLS(I)%SLAST)                                       INDAT0.......42500
  740       CONTINUE                                                     INDAT0.......42600
C...........WRITE OUT THE SPECIFICATIONS.                                INDAT0.......42700
            WRITE(K3,742) SCHDLS(I)%NAME, (ISLIST(NS),NS=1,NSLIST)       INDAT0.......42800
  742       FORMAT(/16X,'SCHEDULE ',A, 3X,'STEP LIST THAT INCLUDES ',    INDAT0.......42900
     1         'THE FOLLOWING TIME STEPS:'/:(38X,8(2X,I8)))              INDAT0.......43000
C...........DEALLOCATE THE TEMPORARY ARRAY.                              INDAT0.......43100
            DEALLOCATE (ISLIST)                                          INDAT0.......43200
         ELSE IF (SCHTYP.EQ."TIME LIST") THEN                            INDAT0.......43300
            SBASED(I) = .FALSE.                                          INDAT0.......43400
C...........READ THE SCHEDULE NAME, TYPE, SCALE FACTOR, AND LENGTH.      INDAT0.......43500
            BACKSPACE(K1)                                                INDAT0.......43600
            READ(K1,*,IOSTAT=INERR(1)) SCHNAM, SCHTYP, CREFT,            INDAT0.......43700
     1         SCALT, NTLIST                                             INDAT0.......43800
            IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)  INDAT0.......43900
C...........ALLOCATE A TEMPORARY ARRAY TO HOLD THE TIME LIST.            INDAT0.......44000
            ALLOCATE (TLIST(NTLIST))                                     INDAT0.......44100
C...........READ ALL THE SPECIFICATIONS.                                 INDAT0.......44200
            BACKSPACE(K1)                                                INDAT0.......44300
            READ(K1,*,IOSTAT=INERR(1)) SCHNAM, SCHTYP, CREFT,            INDAT0.......44400
     1         SCALT, NTLIST, (TLIST(NT),NT=1,NTLIST)                    INDAT0.......44500
            IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)  INDAT0.......44600
            SCHDLS(I)%NAME = SCHNAM                                      INDAT0.......44700
            IF (CREFT.EQ.'ELAPSED ') THEN                                INDAT0.......44800
               IF ((SCHNAM.EQ.'TIME_STEPS').AND.(TLIST(1).NE.0D0)) THEN  INDAT0.......44900
                  ERRCOD = 'INP-6-7'                                     INDAT0.......45000
                  CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)               INDAT0.......45100
               END IF                                                    INDAT0.......45200
               ELAPSD(I) = .TRUE.                                        INDAT0.......45300
            ELSE IF (CREFT.EQ.'ABSOLUTE') THEN                           INDAT0.......45400
               ELAPSD(I) = .FALSE.                                       INDAT0.......45500
            ELSE                                                         INDAT0.......45600
               ERRCOD = 'INP-6-6'                                        INDAT0.......45700
               CHERR(1) = CREFT                                          INDAT0.......45800
               CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                  INDAT0.......45900
            END IF                                                       INDAT0.......46000
C...........SCALE ALL TIME SPECIFICATIONS                                INDAT0.......46100
            DO 745 NT=1,NTLIST                                           INDAT0.......46200
               TLIST(NT) = TLIST(NT)*SCALT                               INDAT0.......46300
  745       CONTINUE                                                     INDAT0.......46400
C...........CONSTRUCT THE SCHEDULE BY TRANSFERRING THE LIST FROM ARRAY   INDAT0.......46500
C              TLIST TO THE LINKED LIST.                                 INDAT0.......46600
            DO 750 NT=1,NTLIST                                           INDAT0.......46700
               TIME = TLIST(NT)                                          INDAT0.......46800
               STEP = FRCSTP(TIME)                                       INDAT0.......46900
               CALL LLDINS(SCHDLS(I)%LLEN, SCHDLS(I)%SLIST, TIME, STEP,  INDAT0.......47000
     1            SCHDLS(I)%SLAST)                                       INDAT0.......47100
  750       CONTINUE                                                     INDAT0.......47200
C...........WRITE OUT THE SPECIFICATIONS.                                INDAT0.......47300
            WRITE(K3,752) SCHDLS(I)%NAME, TRIM(CREFT),                   INDAT0.......47400
     1         (TLIST(NT),NT=1,NTLIST)                                   INDAT0.......47500
  752       FORMAT(/16X,'SCHEDULE ',A, 3X,'TIME LIST THAT INCLUDES ',    INDAT0.......47600
     1         'THE FOLLOWING ', A, ' TIMES (SEC):'                      INDAT0.......47700
     2         /:(38X,4(1X,1PE15.7)))                                    INDAT0.......47800
            DEALLOCATE (TLIST)                                           INDAT0.......47900
         ELSE                                                            INDAT0.......48000
C...........THE SPECIFIED SCHEDULE TYPE IS INVALID, SO GENERATE AN       INDAT0.......48100
C              ERROR.                                                    INDAT0.......48200
            ERRCOD = 'INP-6-9'                                           INDAT0.......48300
            CHERR(1) = SCHTYP                                            INDAT0.......48400
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     INDAT0.......48500
         END IF                                                          INDAT0.......48600
  800 CONTINUE                                                           INDAT0.......48700
C.....READ ONE MORE LINE TO CHECK FOR THE END-OF-LIST MARKER ('-').      INDAT0.......48800
C        IF NOT FOUND, GENERATE AN ERROR.                                INDAT0.......48900
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT0.......49000
      READ(INTFIL,*,IOSTAT=INERR(1)) CDUM10                              INDAT0.......49100
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT0.......49200
      IF (CDUM10.NE.'-') THEN                                            INDAT0.......49300
         ERRCOD = 'INP-6-4'                                              INDAT0.......49400
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT0.......49500
      END IF                                                             INDAT0.......49600
C.....FIND SCHEDULE "TIME_STEPS".                                        INDAT0.......49700
      DO 810 I=1,NSCH-NSCHAU                                             INDAT0.......49800
         IF (SCHDLS(I)%NAME.EQ."TIME_STEPS") THEN                        INDAT0.......49900
            ISCHTS=I                                                     INDAT0.......50000
            TSYES = .TRUE.                                               INDAT0.......50100
            EXIT                                                         INDAT0.......50200
         END IF                                                          INDAT0.......50300
  810 CONTINUE                                                           INDAT0.......50400
C.....IF TRANSPORT IS TRANSIENT AND SCHEDULE "TIME_STEPS" HAS NOT        INDAT0.......50500
C        BEEN DEFINED, GENERATE ERROR                                    INDAT0.......50600
      IF ((ISSTRA.EQ.0).AND.(.NOT.TSYES)) THEN                           INDAT0.......50700
         ERRCOD = 'INP-6-14'                                             INDAT0.......50800
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT0.......50900
      END IF                                                             INDAT0.......51000
C.....IF "TIME_STEPS" LENGTH IS <=1 (SCHEDULE CONTAINS, AT MOST,         INDAT0.......51100
C        ONLY THE INITIAL TIME, AND NO SUBSEQUENT TIME STEPS),           INDAT0.......51200
C        GENERATE AN ERROR.                                              INDAT0.......51300
      IF (SCHDLS(ISCHTS)%LLEN.LE.1) THEN                                 INDAT0.......51400
         ERRCOD = 'INP-6-10'                                             INDAT0.......51500
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT0.......51600
      END IF                                                             INDAT0.......51700
C.....IN SCHEDULE TIME_STEPS, FILL IN TIME STEP NUMBERS, ADDING          INDAT0.......51800
C        TICS TO ELAPSED TIMES IF NECESSARY.  GENERATE ERROR IF          INDAT0.......51900
C        ANY TIMES ARE REPEATED.                                         INDAT0.......52000
C        AT THE SAME TIME, DEFINE SCHEDULE "STEPS_1&UP".                 INDAT0.......52100
      NSMAX = SCHDLS(ISCHTS)%LLEN                                        INDAT0.......52200
      ALLOCATE(DTMP1(NSMAX),DTMP2(NSMAX))                                INDAT0.......52300
      CALL LLD2AR(NSMAX, SCHDLS(ISCHTS)%SLIST, DTMP1, DTMP2)             INDAT0.......52400
      NS1UP = NSCH - NSCHAU + 1                                          INDAT0.......52500
      ALLOCATE (SCHDLS(NS1UP)%SLIST, SCHDLS(NS1UP)%SLAST)                INDAT0.......52600
      SCHDLS(ISCHTS)%LLEN = 0                                            INDAT0.......52700
      SCHDLS(NS1UP)%NAME = "STEPS_1&UP"                                  INDAT0.......52800
      SCHDLS(NS1UP)%LLEN = 0                                             INDAT0.......52900
      IF (ELAPSD(ISCHTS)) THEN                                           INDAT0.......53000
         IF (IREAD.EQ.+1) THEN                                           INDAT0.......53100
            TREF = TICS                                                  INDAT0.......53200
         ELSE                                                            INDAT0.......53300
            TREF = TICS0                                                 INDAT0.......53400
         END IF                                                          INDAT0.......53500
      ELSE                                                               INDAT0.......53600
         TREF = 0D0                                                      INDAT0.......53700
      END IF                                                             INDAT0.......53800
      ITMAX = NSMAX - 1                                                  INDAT0.......53900
      TSTART = TREF + DTMP1(1)                                           INDAT0.......54000
      TFINSH = TREF + DTMP1(NSMAX)                                       INDAT0.......54100
      DELT = DTMP1(2) - DTMP1(1)                                         INDAT0.......54200
      DO 820 NS=1,NSMAX                                                  INDAT0.......54300
         IF (NS.GT.1) THEN                                               INDAT0.......54400
         IF (DTMP1(NS).EQ.DTMP1(NS-1)) THEN                              INDAT0.......54500
            ERRCOD = 'INP-6-12'                                          INDAT0.......54600
            IF (ELAPSD(ISCHTS)) THEN                                     INDAT0.......54700
               CHERR(1) = "elapsed time"                                 INDAT0.......54800
            ELSE                                                         INDAT0.......54900
               CHERR(1) = "absolute time"                                INDAT0.......55000
            END IF                                                       INDAT0.......55100
            CHERR(2) = "TIME_STEPS"                                      INDAT0.......55200
            RLERR(1) = DTMP1(NS)                                         INDAT0.......55300
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     INDAT0.......55400
         END IF                                                          INDAT0.......55500
         END IF                                                          INDAT0.......55600
         NSTEP = NS - 1                                                  INDAT0.......55700
         TIME = TREF + DTMP1(NS)                                         INDAT0.......55800
         STEP = DNINT(DBLE(NSTEP))                                       INDAT0.......55900
         CALL LLDINS(SCHDLS(ISCHTS)%LLEN, SCHDLS(ISCHTS)%SLIST, TIME,    INDAT0.......56000
     1      STEP, SCHDLS(ISCHTS)%SLAST)                                  INDAT0.......56100
         IF (NS.GT.1) CALL LLDINS(SCHDLS(NS1UP)%LLEN,                    INDAT0.......56200
     1       SCHDLS(NS1UP)%SLIST, TIME, STEP, SCHDLS(NS1UP)%SLAST)       INDAT0.......56300
  820 CONTINUE                                                           INDAT0.......56400
      DEALLOCATE(DTMP1,DTMP2)                                            INDAT0.......56500
C.....DEFINE SCHEDULES STEP_0 AND STEP_1.                                INDAT0.......56600
      NS0 = NSCH - NSCHAU + 2                                            INDAT0.......56700
      ALLOCATE (SCHDLS(NS0)%SLIST, SCHDLS(NS0)%SLAST)                    INDAT0.......56800
      SCHDLS(NS0)%NAME = "STEP_0"                                        INDAT0.......56900
      SCHDLS(NS0)%LLEN = 0                                               INDAT0.......57000
      STEP = 0                                                           INDAT0.......57100
      TIME = TIMETS(INT(STEP))                                           INDAT0.......57200
      CALL LLDINS(SCHDLS(NS0)%LLEN, SCHDLS(NS0)%SLIST, TIME,             INDAT0.......57300
     1      STEP, SCHDLS(NS0)%SLAST)                                     INDAT0.......57400
      NS1 = NS0 + 1                                                      INDAT0.......57500
      ALLOCATE (SCHDLS(NS1)%SLIST, SCHDLS(NS1)%SLAST)                    INDAT0.......57600
      SCHDLS(NS1)%NAME = "STEP_1"                                        INDAT0.......57700
      SCHDLS(NS1)%LLEN = 0                                               INDAT0.......57800
      STEP = 1                                                           INDAT0.......57900
      TIME = TIMETS(INT(STEP))                                           INDAT0.......58000
      CALL LLDINS(SCHDLS(NS1)%LLEN, SCHDLS(NS1)%SLIST, TIME,             INDAT0.......58100
     1      STEP, SCHDLS(NS1)%SLAST)                                     INDAT0.......58200
C.....FILL IN TIMES OR STEPS FOR REMAINING SCHEDULES, SHIFTING           INDAT0.......58300
C        ELAPSED TIMES TO ABSOLUTE TIMES IF NECESSARY.  PRUNE ENTRIES    INDAT0.......58400
C        THAT ARE OUTSIDE THE RANGE OF SCHEDULE "TIME_STEPS".            INDAT0.......58500
C        GENERATE ERROR IF ANY TIME STEPS OR TIMES ARE REPEATED.         INDAT0.......58600
      DO 845 I=1,NSCH-NSCHAU                                             INDAT0.......58700
         IF (I.EQ.ISCHTS) CYCLE                                          INDAT0.......58800
         NSMAX = SCHDLS(I)%LLEN                                          INDAT0.......58900
         ALLOCATE(DTMP1(NSMAX),DTMP2(NSMAX))                             INDAT0.......59000
         CALL LLD2AR(NSMAX, SCHDLS(I)%SLIST, DTMP1, DTMP2)               INDAT0.......59100
         SCHDLS(I)%LLEN = 0                                              INDAT0.......59200
         IF (ELAPSD(I)) THEN                                             INDAT0.......59300
            TREF = TSTART                                                INDAT0.......59400
         ELSE                                                            INDAT0.......59500
            TREF = 0D0                                                   INDAT0.......59600
         END IF                                                          INDAT0.......59700
         IF (SBASED(I)) THEN                                             INDAT0.......59800
            DO 840 NS=1,NSMAX                                            INDAT0.......59900
               IF (NS.GT.1) THEN                                         INDAT0.......60000
               IF (DTMP2(NS).EQ.DTMP2(NS-1)) THEN                        INDAT0.......60100
                  ERRCOD = 'INP-6-12'                                    INDAT0.......60200
                  CHERR(1) = "time step"                                 INDAT0.......60300
                  CHERR(2) = SCHDLS(I)%NAME                              INDAT0.......60400
                  RLERR(1) = DTMP2(NS)                                   INDAT0.......60500
                  CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)               INDAT0.......60600
               END IF                                                    INDAT0.......60700
               END IF                                                    INDAT0.......60800
               STEP = DTMP2(NS)                                          INDAT0.......60900
               NSTEP = NINT(STEP)                                        INDAT0.......61000
               IF ((NSTEP.LT.0).OR.(NSTEP.GT.ITMAX)) CYCLE               INDAT0.......61100
               TIME = TIMETS(NSTEP)                                      INDAT0.......61200
               CALL LLDINS(SCHDLS(I)%LLEN, SCHDLS(I)%SLIST, TIME,        INDAT0.......61300
     1            STEP, SCHDLS(I)%SLAST)                                 INDAT0.......61400
  840       CONTINUE                                                     INDAT0.......61500
         ELSE                                                            INDAT0.......61600
            DO 842 NS=1,NSMAX                                            INDAT0.......61700
               IF (NS.GT.1) THEN                                         INDAT0.......61800
               IF (DTMP1(NS).EQ.DTMP1(NS-1)) THEN                        INDAT0.......61900
                  ERRCOD = 'INP-6-12'                                    INDAT0.......62000
                  IF (ELAPSD(I)) THEN                                    INDAT0.......62100
                     CHERR(1) = "elapsed time"                           INDAT0.......62200
                  ELSE                                                   INDAT0.......62300
                     CHERR(1) = "absolute time"                          INDAT0.......62400
                  END IF                                                 INDAT0.......62500
                  CHERR(2) = SCHDLS(I)%NAME                              INDAT0.......62600
                  RLERR(1) = DTMP1(NS)                                   INDAT0.......62700
                  CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)               INDAT0.......62800
               END IF                                                    INDAT0.......62900
               END IF                                                    INDAT0.......63000
               TIME = TREF + DTMP1(NS)                                   INDAT0.......63100
               IF ((TIME.LT.TSTART).OR.(TIME.GT.TFINSH)) CYCLE           INDAT0.......63200
               STEP = FRCSTP(TIME)                                       INDAT0.......63300
               CALL LLDINS(SCHDLS(I)%LLEN, SCHDLS(I)%SLIST, TIME,        INDAT0.......63400
     1            STEP, SCHDLS(I)%SLAST)                                 INDAT0.......63500
  842       CONTINUE                                                     INDAT0.......63600
         END IF                                                          INDAT0.......63700
         DEALLOCATE(DTMP1,DTMP2)                                         INDAT0.......63800
  845 CONTINUE                                                           INDAT0.......63900
C.....DEALLOCATE ARRAY THAT INDICATES METHODS OF SCHEDULE SPECIFICATION  INDAT0.......64000
      DEALLOCATE(SBASED)                                                 INDAT0.......64100
C.....WRITE SPECIFICATIONS OF SCHEDULES "STEPS_1&UP", "STEP_0", AND      INDAT0.......64200
C        "STEP_1".                                                       INDAT0.......64300
  846 WRITE(K3,847) "STEPS_1&UP"                                         INDAT0.......64400
  847 FORMAT(/16X,'SCHEDULE ',A10, 3X,'IDENTICAL TO SCHEDULE ',          INDAT0.......64500
     1   '"TIME_STEPS", EXCEPT THAT IT OMITS TIME STEP 0;',              INDAT0.......64600
     2   /41X,'THIS SCHEDULE IS DEFINED AUTOMATICALLY BY SUTRA')         INDAT0.......64700
      WRITE(K3,848) "STEP_0", 0                                          INDAT0.......64800
      WRITE(K3,848) "STEP_1", 1                                          INDAT0.......64900
  848 FORMAT(/16X,'SCHEDULE ',A6, 4X,                                    INDAT0.......65000
     1   3X,'CONSISTS ONLY OF TIME STEP ', I1, ';',                      INDAT0.......65100
     2   /41X,'THIS SCHEDULE IS DEFINED AUTOMATICALLY BY SUTRA')         INDAT0.......65200
C.....WRITE THE SOLUTION CYCLING CONTROLS.                               INDAT0.......65300
  850 WRITE(K3,874) NPCYC,NUCYC                                          INDAT0.......65400
  874 FORMAT (/13X,'SOLUTION CYCLING DATA:'                              INDAT0.......65500
     1      //11X,I15,5X,'FLOW SOLUTION CYCLE (IN TIME STEPS)'           INDAT0.......65600
     2      /11X,I15,5X,'TRANSPORT SOLUTION CYCLE (IN TIME STEPS)'       INDAT0.......65700
     3      //16X,'FLOW AND TRANSPORT SOLUTIONS ARE ALSO COMPUTED '      INDAT0.......65800
     4      'AUTOMATICALLY ON TIME STEPS ON WHICH FLOW-RELATED '         INDAT0.......65900
     5      /16X,'AND TRANSPORT-RELATED BOUNDARY CONDITIONS, '           INDAT0.......66000
     5      'RESPECTIVELY, ARE SET IN (OPTIONAL) BCS FILES.')            INDAT0.......66100
C.....SET SOLUTION CYCLING FOR STEADY-STATE FLOW                         INDAT0.......66200
      IF(ISSFLO.EQ.1) THEN                                               INDAT0.......66300
         NPCYC=ITMAX+1                                                   INDAT0.......66400
         NUCYC=1                                                         INDAT0.......66500
      END IF                                                             INDAT0.......66600
C                                                                        INDAT0.......66700
C.....INPUT DATASET 7A:  ITERATION CONTROLS FOR RESOLVING NONLINEARITIES INDAT0.......66800
      ERRCOD = 'REA-INP-7A'                                              INDAT0.......66900
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT0.......67000
      READ(INTFIL,*,IOSTAT=INERR(1)) ITRMAX                              INDAT0.......67100
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT0.......67200
      IF (ITRMAX.GT.1) THEN                                              INDAT0.......67300
         ERRCOD = 'REA-INP-7A'                                           INDAT0.......67400
         READ(INTFIL,*,IOSTAT=INERR(1)) ITRMAX,RPMAX,RUMAX               INDAT0.......67500
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT0.......67600
      END IF                                                             INDAT0.......67700
      IF(ITRMAX-1) 1192,1192,1194                                        INDAT0.......67800
 1192 WRITE(K3,1193)                                                     INDAT0.......67900
 1193 FORMAT(////11X,'I T E R A T I O N   C O N T R O L   D A T A',      INDAT0.......68000
     1   //11X,'  NON-ITERATIVE SOLUTION')                               INDAT0.......68100
      GOTO 1196                                                          INDAT0.......68200
 1194 WRITE(K3,1195) ITRMAX,RPMAX,RUMAX                                  INDAT0.......68300
 1195 FORMAT(////11X,'I T E R A T I O N   C O N T R O L   D A T A',      INDAT0.......68400
     1   //11X,I15,5X,'MAXIMUM NUMBER OF ITERATIONS PER TIME STEP',      INDAT0.......68500
     2   /11X,1PE15.4,5X,'ABSOLUTE CONVERGENCE CRITERION FOR FLOW',      INDAT0.......68600
     3   ' SOLUTION'/11X,1PE15.4,5X,'ABSOLUTE CONVERGENCE CRITERION',    INDAT0.......68700
     4   ' FOR TRANSPORT SOLUTION')                                      INDAT0.......68800
 1196 CONTINUE                                                           INDAT0.......68900
C                                                                        INDAT0.......69000
C.....INPUT DATASETS 7B & 7C:  MATRIX EQUATION SOLVER CONTROLS FOR       INDAT0.......69100
C        PRESSURE AND TRANSPORT SOLUTIONS                                INDAT0.......69200
      ERRCOD = 'REA-INP-7B'                                              INDAT0.......69300
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT0.......69400
      READ(INTFIL,*,IOSTAT=INERR(1)) CSOLVP                              INDAT0.......69500
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT0.......69600
      IF ((CSOLVP.NE.SOLWRD(0))) THEN                                    INDAT0.......69700
         ERRCOD = 'REA-INP-7B'                                           INDAT0.......69800
         READ(INTFIL,*,IOSTAT=INERR(1)) CSOLVP,ITRMXP,TOLP               INDAT0.......69900
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT0.......70000
      END IF                                                             INDAT0.......70100
      ERRCOD = 'REA-INP-7C'                                              INDAT0.......70200
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT0.......70300
      READ(INTFIL,*,IOSTAT=INERR(1)) CSOLVU                              INDAT0.......70400
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT0.......70500
      IF ((CSOLVU.NE.SOLWRD(0))) THEN                                    INDAT0.......70600
         ERRCOD = 'REA-INP-7C'                                           INDAT0.......70700
         READ(INTFIL,*,IOSTAT=INERR(1)) CSOLVU,ITRMXU,TOLU               INDAT0.......70800
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT0.......70900
      END IF                                                             INDAT0.......71000
      KSOLVP = -1                                                        INDAT0.......71100
      KSOLVU = -1                                                        INDAT0.......71200
      DO 1250 M=0,NSLVRS-1                                               INDAT0.......71300
         IF (CSOLVP.EQ.SOLWRD(M)) KSOLVP = M                             INDAT0.......71400
         IF (CSOLVU.EQ.SOLWRD(M)) KSOLVU = M                             INDAT0.......71500
 1250 CONTINUE                                                           INDAT0.......71600
      IF ((KSOLVP.LT.0).OR.(KSOLVU.LT.0)) THEN                           INDAT0.......71700
         ERRCOD = 'INP-7B&C-1'                                           INDAT0.......71800
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT0.......71900
      ELSE IF ((KSOLVP*KSOLVU.EQ.0).AND.(KSOLVP+KSOLVU.NE.0)) THEN       INDAT0.......72000
         ERRCOD = 'INP-7B&C-2'                                           INDAT0.......72100
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT0.......72200
      ELSE IF ((KSOLVU.EQ.1).OR.((KSOLVP.EQ.1).AND.(UP.NE.0D0))) THEN    INDAT0.......72300
         ERRCOD = 'INP-7B&C-3'                                           INDAT0.......72400
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT0.......72500
      END IF                                                             INDAT0.......72600
      IF (KSOLVP.EQ.2) THEN                                              INDAT0.......72700
         ITOLP = 0                                                       INDAT0.......72800
      ELSE                                                               INDAT0.......72900
         ITOLP = 1                                                       INDAT0.......73000
      END IF                                                             INDAT0.......73100
      IF (KSOLVU.EQ.2) THEN                                              INDAT0.......73200
         ITOLU = 0                                                       INDAT0.......73300
      ELSE                                                               INDAT0.......73400
         ITOLU = 1                                                       INDAT0.......73500
      END IF                                                             INDAT0.......73600
      NSAVEP = 10                                                        INDAT0.......73700
      NSAVEU = 10                                                        INDAT0.......73800
C                                                                        INDAT0.......73900
C                                                                        INDAT0.......74000
      RETURN                                                             INDAT0.......74100
      END                                                                INDAT0.......74200
C                                                                        INDAT0.......74300
C     SUBROUTINE        I  N  D  A  T  1           SUTRA VERSION 2.2     INDAT1.........100
C                                                                        INDAT1.........200
C *** PURPOSE :                                                          INDAT1.........300
C ***  TO INPUT, OUTPUT, AND ORGANIZE A MAJOR PORTION OF INP FILE        INDAT1.........400
C ***  INPUT DATA (DATASETS 8 THROUGH 15)                                INDAT1.........500
C                                                                        INDAT1.........600
      SUBROUTINE INDAT1(X,Y,Z,POR,ALMAX,ALMID,ALMIN,ATMAX,ATMID,         INDAT1.........700
     1   ATMIN,PERMXX,PERMXY,PERMXZ,PERMYX,PERMYY,                       INDAT1.........800
     2   PERMYZ,PERMZX,PERMZY,PERMZZ,PANGL1,PANGL2,PANGL3,SOP,NREG,LREG, INDAT1.........900
     3   OBSPTS,POR1)
C     3   OBSPTS)                                                         INDAT1........1000
      USE ALLARR, ONLY : OBSDAT                                          INDAT1........1100
      USE LLDEF                                                          INDAT1........1200
      USE EXPINT                                                         INDAT1........1300
      USE SCHDEF                                                         INDAT1........1400
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                INDAT1........1500
      PARAMETER (NCOLMX=9)                                               INDAT1........1600
      CHARACTER*10 ADSMOD,CDUM10                                         INDAT1........1700
      CHARACTER*6 STYPE(2)                                               INDAT1........1800
      CHARACTER K5SYM(7)*1, NCOL(NCOLMX)*1, VARNK5(7)*25                 INDAT1........1900
      CHARACTER K6SYM(7)*2, LCOL(NCOLMX)*2, VARNK6(7)*25                 INDAT1........2000
      CHARACTER*1 CNODAL,CELMNT,CINCID,CPANDS,CVEL,CCORT,CBUDG,          INDAT1........2100
     1   CSCRN,CPAUSE,CINACT                                             INDAT1........2200
      CHARACTER*80 ERRCOD,CHERR(10),UNAME,FNAME(0:13)                    INDAT1........2300
      CHARACTER INTFIL*1000,DOTS45*45                                    INDAT1........2400
      CHARACTER OBSNAM*40, OBSSCH*10, OBSFMT*3, CDUM80*80                INDAT1........2500
      CHARACTER*8 VERNUM, VERNIN                                         INDAT1........2600
      TYPE (OBSDAT), DIMENSION (NOBSN) :: OBSPTS                         INDAT1........2700
      DIMENSION J5COL(NCOLMX), J6COL(NCOLMX)                             INDAT1........2800
      DIMENSION X(NN),Y(NN),Z(NN),POR(NN),SOP(NN),NREG(NN)               INDAT1........2900
      DIMENSION POR1(NN)
      DIMENSION PERMXX(NE),PERMXY(NE),PERMXZ(NEX),PERMYX(NE),PERMYY(NE), INDAT1........3000
     1   PERMYZ(NEX),PERMZX(NEX),PERMZY(NEX),PERMZZ(NEX),PANGL1(NE),     INDAT1........3100
     2   PANGL2(NEX),PANGL3(NEX),ALMAX(NE),ALMID(NEX),ALMIN(NE),         INDAT1........3200
     3   ATMAX(NE),ATMID(NEX),ATMIN(NE),LREG(NE)                         INDAT1........3300
      DIMENSION INERR(10),RLERR(10)                                      INDAT1........3400
      DIMENSION KTYPE(2)                                                 INDAT1........3500
      DIMENSION IUNIT(0:13)                                              INDAT1........3600
      ALLOCATABLE :: INOB(:)                                             INDAT1........3700
      TYPE (LLD), POINTER :: DENTS                                       INDAT1........3800
      COMMON /TC/ TCS,TCL,B1,B2,B3,NTC
      COMMON /ENHFAC/ YA,YB,YC,YD,YE,FC,NEF
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  INDAT1........3900
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           INDAT1........4000
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      INDAT1........4100
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              INDAT1........4200
     1   NSOP,NSOU,NBCN,NCIDB                                            INDAT1........4300
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        INDAT1........4400
      COMMON /FNAMES/ UNAME,FNAME                                        INDAT1........4500
      COMMON /FUNITA/ IUNIT                                              INDAT1........4600
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 INDAT1........4700
     1   K10,K11,K12,K13                                                 INDAT1........4800
      COMMON /GRAVEC/ GRAVX,GRAVY,GRAVZ                                  INDAT1........4900
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS      INDAT1........5000
      COMMON /JCOLS/ NCOLPR, LCOLPR, NCOLS5, NCOLS6, J5COL, J6COL        INDAT1........5100
      COMMON /KPRBCS/ KINACT                                             INDAT1........5200
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                INDAT1........5300
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            INDAT1........5400
      COMMON /MODSOR/ ADSMOD                                             INDAT1........5500
      COMMON /OBS/ NOBSN,NTOBS,NOBCYC,NOBLIN,NFLOMX                      INDAT1........5600
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,      INDAT1........5700
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2        INDAT1........5800
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /SURFR/ TAL,EC,ETR 
      COMMON /FILMFLOW/ CORF,AGR,SWM3,SWM4,PHICM,ASVL
      COMMON /SCH/ NSCH,ISCHTS,NSCHAU                                    INDAT1........5900
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       INDAT1........6000
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      INDAT1........6100
      COMMON /VER/ VERNUM, VERNIN                                        INDAT1........6200
CM....TIDE, ET AND WATER RETENTION PARAMETERS
      COMMON /TIDE/ TA,TP,TM,RHOST,SC,TH,IBC,ITT
      COMMON /ET/ QET,UET,PET,UVM,NGT,ITE,TMA,TMI,ALF,RS,RH,AP,BP,U2,
     1   TSD,SCF
      COMMON /UNSA/ SWRES1,AA1,VN1,SWRES2,AA2,VN2,SWRES3,DLAM3,PHICB3,
     1SWRES4,DLAM4,PHICB4,PHIC0,ECTO
      COMMON /AERORESIS/ RAVT,RAVS,SWRAT
      COMMON /SALTRESIS/ AR,BR
      COMMON /HEATPARA/ HSC,HER,ROUS,HCS
      DATA STYPE(1)/'ENERGY'/,STYPE(2)/'SOLUTE'/                         INDAT1........6300
      DATA (K5SYM(MM), MM=1,7) /'N', 'X', 'Y', 'Z', 'P', 'U', 'S'/       INDAT1........6400
      DATA (VARNK5(MM), MM=1,7) /'NODE NUMBER',                          INDAT1........6500
     1   'X-COORDINATE', 'Y-COORDINATE', 'Z-COORDINATE',                 INDAT1........6600
     2   'PRESSURE', 'CONCENTRATION/TEMPERATURE', 'SATURATION'/          INDAT1........6700
      DATA (K6SYM(MM), MM=1,7) /'E', 'X', 'Y', 'Z', 'VX', 'VY', 'VZ'/    INDAT1........6800
      DATA (VARNK6(MM), MM=1,7) /'ELEMENT NUMBER',                       INDAT1........6900
     1   'X-COORDINATE OF CENTROID', 'Y-COORDINATE OF CENTROID',         INDAT1........7000
     2   'Z-COORDINATE OF CENTROID', 'X-VELOCITY', 'Y-VELOCITY',         INDAT1........7100
     3   'Z-VELOCITY'/                                                   INDAT1........7200
      DATA DOTS45 /'.............................................'/      INDAT1........7300
      SAVE STYPE,K5SYM,VARNK5,K6SYM,VARNK6                               INDAT1........7400
C                                                                        INDAT1........7500
      INSTOP=0                                                           INDAT1........7600
C                                                                        INDAT1........7700
C.....INPUT DATASET 8A:  OUTPUT CONTROLS AND OPTIONS FOR LST FILE        INDAT1........7800
C        AND SCREEN                                                      INDAT1........7900
      ERRCOD = 'REA-INP-8A'                                              INDAT1........8000
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1........8100
      IF ((VERNIN.EQ.'2.0').OR.(VERNIN.EQ.'2.1')) THEN                   INDAT1........8200
         READ(INTFIL,*,IOSTAT=INERR(1)) NPRINT,CNODAL,CELMNT,CINCID,     INDAT1........8300
     1      CVEL,CBUDG,CSCRN,CPAUSE                                      INDAT1........8400
         CPANDS = 'Y'                                                    INDAT1........8500
         CCORT = 'Y'                                                     INDAT1........8600
      ELSE                                                               INDAT1........8700
         READ(INTFIL,*,IOSTAT=INERR(1)) NPRINT,CNODAL,CELMNT,CINCID,     INDAT1........8800
     1      CPANDS,CVEL,CCORT,CBUDG,CSCRN,CPAUSE                         INDAT1........8900
      END IF                                                             INDAT1........9000
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1........9100
      IF (CNODAL.EQ.'Y') THEN                                            INDAT1........9200
         KNODAL = +1                                                     INDAT1........9300
      ELSE IF (CNODAL.EQ.'N') THEN                                       INDAT1........9400
         KNODAL = 0                                                      INDAT1........9500
      ELSE                                                               INDAT1........9600
         ERRCOD = 'INP-8A-1'                                             INDAT1........9700
         CHERR(1) = 'CNODAL '                                            INDAT1........9800
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1........9900
      END IF                                                             INDAT1.......10000
      IF (CELMNT.EQ.'Y') THEN                                            INDAT1.......10100
         KELMNT = +1                                                     INDAT1.......10200
      ELSE IF (CELMNT.EQ.'N') THEN                                       INDAT1.......10300
         KELMNT = 0                                                      INDAT1.......10400
      ELSE                                                               INDAT1.......10500
         ERRCOD = 'INP-8A-2'                                             INDAT1.......10600
         CHERR(1) = 'CELMNT'                                             INDAT1.......10700
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1.......10800
      END IF                                                             INDAT1.......10900
      IF (CINCID.EQ.'Y') THEN                                            INDAT1.......11000
         KINCID = +1                                                     INDAT1.......11100
      ELSE IF (CINCID.EQ.'N') THEN                                       INDAT1.......11200
         KINCID = 0                                                      INDAT1.......11300
      ELSE                                                               INDAT1.......11400
         ERRCOD = 'INP-8A-3'                                             INDAT1.......11500
         CHERR(1) = 'CINCID'                                             INDAT1.......11600
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1.......11700
      END IF                                                             INDAT1.......11800
      IF (CPANDS.EQ.'Y') THEN                                            INDAT1.......11900
         KPANDS = +1                                                     INDAT1.......12000
      ELSE IF (CPANDS.EQ.'N') THEN                                       INDAT1.......12100
         KPANDS = 0                                                      INDAT1.......12200
      ELSE                                                               INDAT1.......12300
         ERRCOD = 'INP-8A-8'                                             INDAT1.......12400
         CHERR(1) = 'CPANDS'                                             INDAT1.......12500
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1.......12600
      END IF                                                             INDAT1.......12700
      IF (CVEL.EQ.'Y') THEN                                              INDAT1.......12800
         KVEL = +1                                                       INDAT1.......12900
      ELSE IF (CVEL.EQ.'N') THEN                                         INDAT1.......13000
         KVEL = 0                                                        INDAT1.......13100
      ELSE                                                               INDAT1.......13200
         ERRCOD = 'INP-8A-4'                                             INDAT1.......13300
         CHERR(1) = 'CVEL  '                                             INDAT1.......13400
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1.......13500
      END IF                                                             INDAT1.......13600
      IF (CCORT.EQ.'Y') THEN                                             INDAT1.......13700
         KCORT = +1                                                      INDAT1.......13800
      ELSE IF (CCORT.EQ.'N') THEN                                        INDAT1.......13900
         KCORT = 0                                                       INDAT1.......14000
      ELSE                                                               INDAT1.......14100
         ERRCOD = 'INP-8A-9'                                             INDAT1.......14200
         CHERR(1) = 'CCORT '                                             INDAT1.......14300
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1.......14400
      END IF                                                             INDAT1.......14500
      IF (CBUDG.EQ.'Y') THEN                                             INDAT1.......14600
         KBUDG = +1                                                      INDAT1.......14700
      ELSE IF (CBUDG.EQ.'N') THEN                                        INDAT1.......14800
         KBUDG = 0                                                       INDAT1.......14900
      ELSE                                                               INDAT1.......15000
         ERRCOD = 'INP-8A-5'                                             INDAT1.......15100
         CHERR(1) = 'CBUDG '                                             INDAT1.......15200
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1.......15300
      END IF                                                             INDAT1.......15400
      IF (CSCRN.EQ.'Y') THEN                                             INDAT1.......15500
         KSCRN = +1                                                      INDAT1.......15600
      ELSE IF (CSCRN.EQ.'N') THEN                                        INDAT1.......15700
         KSCRN = 0                                                       INDAT1.......15800
      ELSE                                                               INDAT1.......15900
         ERRCOD = 'INP-8A-6'                                             INDAT1.......16000
         CHERR(1) = 'CSCRN '                                             INDAT1.......16100
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1.......16200
      END IF                                                             INDAT1.......16300
      IF (CPAUSE.EQ.'Y') THEN                                            INDAT1.......16400
         KPAUSE = +1                                                     INDAT1.......16500
      ELSE IF (CPAUSE.EQ.'N') THEN                                       INDAT1.......16600
         KPAUSE = 0                                                      INDAT1.......16700
      ELSE                                                               INDAT1.......16800
         ERRCOD = 'INP-8A-7'                                             INDAT1.......16900
         CHERR(1) = 'CPAUSE'                                             INDAT1.......17000
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1.......17100
      END IF                                                             INDAT1.......17200
C                                                                        INDAT1.......17300
      WRITE(K3,72) NPRINT                                                INDAT1.......17400
   72 FORMAT(////11X,'O U T P U T   C O N T R O L S   A N D   ',         INDAT1.......17500
     1   'O P T I O N S'//13X,'.LST FILE'/13X,'---------'                INDAT1.......17600
     2   //13X,I8,3X,'PRINTED OUTPUT CYCLE (IN TIME STEPS)')             INDAT1.......17700
      IF(KNODAL.EQ.+1) WRITE(K3,74)                                      INDAT1.......17800
      IF(KNODAL.EQ.0) WRITE(K3,75)                                       INDAT1.......17900
   74 FORMAT(/13X,'- PRINT NODE COORDINATES, THICKNESSES AND',           INDAT1.......18000
     1   ' POROSITIES')                                                  INDAT1.......18100
   75 FORMAT(/13X,'- CANCEL PRINT OF NODE COORDINATES, THICKNESSES AND', INDAT1.......18200
     1   ' POROSITIES')                                                  INDAT1.......18300
      IF(KELMNT.EQ.+1) WRITE(K3,76)                                      INDAT1.......18400
      IF(KELMNT.EQ.0) WRITE(K3,77)                                       INDAT1.......18500
   76 FORMAT(13X,'- PRINT ELEMENT PERMEABILITIES AND DISPERSIVITIES')    INDAT1.......18600
   77 FORMAT(13X,'- CANCEL PRINT OF ELEMENT PERMEABILITIES AND ',        INDAT1.......18700
     1   'DISPERSIVITIES')                                               INDAT1.......18800
      IF(KINCID.EQ.+1) WRITE(K3,78)                                      INDAT1.......18900
      IF(KINCID.EQ.0) WRITE(K3,79)                                       INDAT1.......19000
   78 FORMAT(13X,'- PRINT NODE INCIDENCES IN EACH ELEMENT')              INDAT1.......19100
   79 FORMAT(13X,'- CANCEL PRINT OF NODE INCIDENCES IN EACH ELEMENT')    INDAT1.......19200
      IME=2                                                              INDAT1.......19300
      IF(ME.EQ.+1) IME=1                                                 INDAT1.......19400
      IF(KPANDS.EQ.+1) WRITE(K3,81)                                      INDAT1.......19500
      IF(KPANDS.EQ.0) WRITE(K3,82)                                       INDAT1.......19600
   81 FORMAT(/13X,'- PRINT PRESSURES AND SATURATIONS AT NODES ',         INDAT1.......19700
     1   'ON EACH TIME STEP WITH OUTPUT')                                INDAT1.......19800
   82 FORMAT(/13X,'- CANCEL PRINT OF PRESSURES AND SATURATIONS')         INDAT1.......19900
      IF(KVEL.EQ.+1) WRITE(K3,84)                                        INDAT1.......20000
      IF(KVEL.EQ.0) WRITE(K3,85)                                         INDAT1.......20100
   84 FORMAT(13X,'- CALCULATE AND PRINT VELOCITIES AT ELEMENT ',         INDAT1.......20200
     1   'CENTROIDS ON EACH TIME STEP WITH OUTPUT')                      INDAT1.......20300
   85 FORMAT(13X,'- CANCEL PRINT OF VELOCITIES')                         INDAT1.......20400
      IF(KCORT.EQ.+1) THEN                                               INDAT1.......20500
         IF (ME.EQ.-1) THEN                                              INDAT1.......20600
            WRITE(K3,86)                                                 INDAT1.......20700
         ELSE                                                            INDAT1.......20800
            WRITE(K3,87)                                                 INDAT1.......20900
         END IF                                                          INDAT1.......21000
      ELSE                                                               INDAT1.......21100
         IF (ME.EQ.-1) THEN                                              INDAT1.......21200
            WRITE(K3,88)                                                 INDAT1.......21300
         ELSE                                                            INDAT1.......21400
            WRITE(K3,89)                                                 INDAT1.......21500
         END IF                                                          INDAT1.......21600
      END IF                                                             INDAT1.......21700
   86 FORMAT(13X,'- PRINT CONCENTRATIONS AT NODES ',                     INDAT1.......21800
     1   'ON EACH TIME STEP WITH OUTPUT')                                INDAT1.......21900
   87 FORMAT(13X,'- PRINT TEMPERATURES AT NODES ',                       INDAT1.......22000
     1   'ON EACH TIME STEP WITH OUTPUT')                                INDAT1.......22100
   88 FORMAT(13X,'- CANCEL PRINT OF CONCENTRATIONS')                     INDAT1.......22200
   89 FORMAT(13X,'- CANCEL PRINT OF TEMPERATURES')                       INDAT1.......22300
      IF(KBUDG.EQ.+1) WRITE(K3,90) STYPE(IME)                            INDAT1.......22400
      IF(KBUDG.EQ.0) WRITE(K3,91)                                        INDAT1.......22500
   90 FORMAT(/13X,'- CALCULATE AND PRINT FLUID AND ',A6,' BUDGETS ',     INDAT1.......22600
     1   'ON EACH TIME STEP WITH OUTPUT')                                INDAT1.......22700
   91 FORMAT(/13X,'- CANCEL PRINT OF BUDGETS')                           INDAT1.......22800
C                                                                        INDAT1.......22900
C.....INPUT DATASET 8B:  OUTPUT CONTROLS AND OPTIONS FOR NOD FILE        INDAT1.......23000
      ERRCOD = 'REA-INP-8B'                                              INDAT1.......23100
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1.......23200
      READ(INTFIL,*,IOSTAT=INERR(1)) NCOLPR                              INDAT1.......23300
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1.......23400
      DO 140 M=1,NCOLMX                                                  INDAT1.......23500
         READ(INTFIL,*,IOSTAT=INERR(1)) NCOLPR, (NCOL(MM), MM=1,M)       INDAT1.......23600
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT1.......23700
         IF (NCOL(M).EQ.'-') THEN                                        INDAT1.......23800
            NCOLS5 = M - 1                                               INDAT1.......23900
            GOTO 142                                                     INDAT1.......24000
         END IF                                                          INDAT1.......24100
  140 CONTINUE                                                           INDAT1.......24200
      NCOLS5 = NCOLMX                                                    INDAT1.......24300
  142 CONTINUE                                                           INDAT1.......24400
      WRITE(K3,144) NCOLPR                                               INDAT1.......24500
  144 FORMAT (//13X,'.NOD FILE'/13X,'---------'                          INDAT1.......24600
     1   //13X,I8,3X,'PRINTED OUTPUT CYCLE (IN TIME STEPS)'/)            INDAT1.......24700
      DO 148 M=1,NCOLS5                                                  INDAT1.......24800
         DO 146 MM=1,7                                                   INDAT1.......24900
            IF (NCOL(M).EQ.K5SYM(MM)) THEN                               INDAT1.......25000
               IF ((MM.EQ.1).AND.(M.NE.1)) THEN                          INDAT1.......25100
                  ERRCOD = 'INP-8B-1'                                    INDAT1.......25200
                  CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)               INDAT1.......25300
               END IF                                                    INDAT1.......25400
               IF ((MM.EQ.4).AND.(KTYPE(1).EQ.2)) THEN                   INDAT1.......25500
                  ERRCOD = 'INP-8B-2'                                    INDAT1.......25600
                  CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)               INDAT1.......25700
               END IF                                                    INDAT1.......25800
               J5COL(M) = MM                                             INDAT1.......25900
               GOTO 148                                                  INDAT1.......26000
            END IF                                                       INDAT1.......26100
  146    CONTINUE                                                        INDAT1.......26200
         ERRCOD = 'INP-8B-3'                                             INDAT1.......26300
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1.......26400
  148 CONTINUE                                                           INDAT1.......26500
      WRITE(K3,150) (M,VARNK5(J5COL(M)),M=1,NCOLS5)                      INDAT1.......26600
  150 FORMAT (13X,'COLUMN ',I1,':',2X,A)                                 INDAT1.......26700
C                                                                        INDAT1.......26800
C.....INPUT DATASET 8C:  OUTPUT CONTROLS AND OPTIONS FOR ELE FILE        INDAT1.......26900
      ERRCOD = 'REA-INP-8C'                                              INDAT1.......27000
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1.......27100
      READ(INTFIL,*,IOSTAT=INERR(1)) LCOLPR                              INDAT1.......27200
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1.......27300
      DO 160 M=1,NCOLMX                                                  INDAT1.......27400
         READ(INTFIL,*,IOSTAT=INERR(1)) LCOLPR, (LCOL(MM), MM=1,M)       INDAT1.......27500
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT1.......27600
         IF (LCOL(M).EQ.'-') THEN                                        INDAT1.......27700
            NCOLS6 = M - 1                                               INDAT1.......27800
            GOTO 162                                                     INDAT1.......27900
         END IF                                                          INDAT1.......28000
  160 CONTINUE                                                           INDAT1.......28100
      NCOLS6 = NCOLMX                                                    INDAT1.......28200
  162 CONTINUE                                                           INDAT1.......28300
      WRITE(K3,164) LCOLPR                                               INDAT1.......28400
  164 FORMAT (//13X,'.ELE FILE'/13X,'---------'                          INDAT1.......28500
     1   //13X,I8,3X,'PRINTED OUTPUT CYCLE (IN TIME STEPS)'/)            INDAT1.......28600
      DO 168 M=1,NCOLS6                                                  INDAT1.......28700
         DO 166 MM=1,7                                                   INDAT1.......28800
            IF (LCOL(M).EQ.K6SYM(MM)) THEN                               INDAT1.......28900
               IF ((MM.EQ.1).AND.(M.NE.1)) THEN                          INDAT1.......29000
                  ERRCOD = 'INP-8C-1'                                    INDAT1.......29100
                  CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)               INDAT1.......29200
               END IF                                                    INDAT1.......29300
               IF ((MM.EQ.4).AND.(KTYPE(1).EQ.2)) THEN                   INDAT1.......29400
                  ERRCOD = 'INP-8C-2'                                    INDAT1.......29500
                  CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)               INDAT1.......29600
               END IF                                                    INDAT1.......29700
               IF ((MM.EQ.7).AND.(KTYPE(1).EQ.2)) THEN                   INDAT1.......29800
                  ERRCOD = 'INP-8C-4'                                    INDAT1.......29900
                  CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)               INDAT1.......30000
               END IF                                                    INDAT1.......30100
               J6COL(M) = MM                                             INDAT1.......30200
               GOTO 168                                                  INDAT1.......30300
            END IF                                                       INDAT1.......30400
  166    CONTINUE                                                        INDAT1.......30500
         ERRCOD = 'INP-8C-3'                                             INDAT1.......30600
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1.......30700
  168 CONTINUE                                                           INDAT1.......30800
      WRITE(K3,170) (M,VARNK6(J6COL(M)),M=1,NCOLS6)                      INDAT1.......30900
  170 FORMAT (13X,'COLUMN ',I1,':',2X,A)                                 INDAT1.......31000
C                                                                        INDAT1.......31100
C.....INPUT DATASET 8D:  OUTPUT CONTROLS AND OPTIONS FOR OBSERVATIONS    INDAT1.......31200
      NOBCYC = ITMAX + 1                                                 INDAT1.......31300
      IF (NOBSN-1.EQ.0) GOTO 999                                         INDAT1.......31400
C.....NOBS IS ACTUAL NUMBER OF OBSERVATION POINTS                        INDAT1.......31500
C.....NTOBS IS MAXIMUM NUMBER OF TIME STEPS WITH OBSERVATIONS            INDAT1.......31600
      NOBS=NOBSN-1                                                       INDAT1.......31700
C.....READ IN OBSERVATION POINTS                                         INDAT1.......31800
      ERRCOD = 'REA-INP-8D'                                              INDAT1.......31900
C.....DO THIS READ NOW TO SKIP ANY COMMENTS AND BLANK LINES.             INDAT1.......32000
C        (BACKSPACE LATER IF IT MUST BE REREAD IN OLD FORMAT.)           INDAT1.......32100
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1.......32200
      READ(INTFIL,*,IOSTAT=INERR(1)) NOBLIN                              INDAT1.......32300
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1.......32400
C.....IF OLD (VERSION 2.0) INPUT FORMAT IS BEING USED, CONSTRUCT A       INDAT1.......32500
C        CORRESPONDING OBSERVATION OUTPUT SCHEDULE IF TRANSPORT IS       INDAT1.......32600
C        TRANSIENT.                                                      INDAT1.......32700
      IF (VERNIN.EQ."2.0") THEN                                          INDAT1.......32800
C........SET THE MAX NUMBER OF OBSERVATIONS PER LINE TO THE TOTAL        INDAT1.......32900
C           NUMBER OF OBSERVATIONS.                                      INDAT1.......33000
         NOBLIN = NOBS                                                   INDAT1.......33100
C........SET UP A TEMPORARY ARRAY TO HOLD OBSERVATION NODES.             INDAT1.......33200
         ALLOCATE(INOB(NOBSN))                                           INDAT1.......33300
C........BACKSPACE AND REREAD DATASET IN OLD FORMAT                      INDAT1.......33400
         BACKSPACE(K1)                                                   INDAT1.......33500
         READ(K1,*,IOSTAT=INERR(1)) NOBCYC, (INOB(JJ), JJ=1,NOBSN)       INDAT1.......33600
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT1.......33700
C........IF THE LAST NODE NUMBER IS NOT ZERO, GENERATE AN ERROR.         INDAT1.......33800
         IF (INOB(NOBSN).NE.0) THEN                                      INDAT1.......33900
            ERRCOD = 'INP-8D-1'                                          INDAT1.......34000
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     INDAT1.......34100
         END IF                                                          INDAT1.......34200
C........IF A NODE NUMBER IS INVALID, GENERATE AN ERROR.                 INDAT1.......34300
         DO 510 JJ=1,NOBS                                                INDAT1.......34400
            IF ((INOB(JJ).LT.1).OR.(INOB(JJ).GT.NN)) THEN                INDAT1.......34500
               ERRCOD = 'INP-8D-2'                                       INDAT1.......34600
               CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                  INDAT1.......34700
            END IF                                                       INDAT1.......34800
  510    CONTINUE                                                        INDAT1.......34900
C........IF TRANSPORT IS TRANSIENT, CONSTRUCT A SCHEDULE THAT            INDAT1.......35000
C           CORRESPONDS TO THE CYCLE SPECIFIED BY NOBCYC.                INDAT1.......35100
         IF (ISSTRA.EQ.0) THEN                                           INDAT1.......35200
            SCHDLS(2)%NAME = "-"                                         INDAT1.......35300
            ISTEPI = 0                                                   INDAT1.......35400
            ISTEPL = ITMAX                                               INDAT1.......35500
            ITERM = ISTEPL - ISTEPI                                      INDAT1.......35600
C...........IF NOBCYC=0, SET THE CYCLE TO THE TOTAL NUMBER OF TIME       INDAT1.......35700
C              STEPS, SO THAT THE SCHEDULE CONSISTS OF TIME STEPS        INDAT1.......35800
C              0, 1, AND ITMAX.  (VERSION 2.0 SIMPLY BOMBS IF            INDAT1.......35900
C              NOBCYC=0.)                                                INDAT1.......36000
            IF (NOBCYC.EQ.0) THEN                                        INDAT1.......36100
               ISTEPC = ITERM                                            INDAT1.......36200
            ELSE                                                         INDAT1.......36300
               ISTEPC = IABS(NOBCYC)                                     INDAT1.......36400
            END IF                                                       INDAT1.......36500
            NTORS = INT(ITERM/ISTEPC) + 1                                INDAT1.......36600
            IF (MOD(ITERM,ISTEPC).NE.0) NTORS = NTORS + 1                INDAT1.......36700
            NSTEP = ISTEPI                                               INDAT1.......36800
            DENTS => SCHDLS(ISCHTS)%SLIST                                INDAT1.......36900
            JT = 0                                                       INDAT1.......37000
            DO 580 NT=1,NTORS                                            INDAT1.......37100
               NSTEP = MIN(ISTEPL, ISTEPI + (NT - 1)*ISTEPC)             INDAT1.......37200
               DO WHILE (NSTEP.GT.JT)                                    INDAT1.......37300
                  DENTS => DENTS%NENT                                    INDAT1.......37400
                  JT = JT + 1                                            INDAT1.......37500
               END DO                                                    INDAT1.......37600
               STEP = DENTS%DVALU2                                       INDAT1.......37700
               TIME = DENTS%DVALU1                                       INDAT1.......37800
               CALL LLDINS(SCHDLS(2)%LLEN, SCHDLS(2)%SLIST, TIME, STEP,  INDAT1.......37900
     1            SCHDLS(2)%SLAST)                                       INDAT1.......38000
  580       CONTINUE                                                     INDAT1.......38100
C...........IF NOBCYC>=0, INCLUDE TIME STEP 1 IF NOT ALREADY INCLUDED.   INDAT1.......38200
            IF ((NOBCYC.GE.0).AND.(NOBCYC.NE.1)) THEN                    INDAT1.......38300
               DENTS => SCHDLS(ISCHTS)%SLIST                             INDAT1.......38400
               STEP = DNINT(DBLE(1))                                     INDAT1.......38500
               TIME = DENTS%NENT%DVALU1                                  INDAT1.......38600
               CALL LLDINS(SCHDLS(2)%LLEN, SCHDLS(2)%SLIST, TIME, STEP,  INDAT1.......38700
     1            SCHDLS(2)%SLAST)                                       INDAT1.......38800
            END IF                                                       INDAT1.......38900
         END IF                                                          INDAT1.......39000
C........CONVERT NODES TO GENERALIZED OBSERVATION POINTS.  THE POINTS    INDAT1.......39100
C           ARE NAMED "NODE_#", WHERE # IS THE NODE NUMBER.              INDAT1.......39200
         DO 540 I=1,NOBS                                                 INDAT1.......39300
            WRITE(OBSPTS(I)%NAME,*) INOB(I)                              INDAT1.......39400
            OBSPTS(I)%NAME = "NODE_" // ADJUSTL(OBSPTS(I)%NAME)          INDAT1.......39500
            OBSPTS(I)%SCHED = "-"                                        INDAT1.......39600
            OBSPTS(I)%FRMT = "OBS"                                       INDAT1.......39700
            OBSPTS(I)%L = INOB(I)                                        INDAT1.......39800
  540    CONTINUE                                                        INDAT1.......39900
C........DEALLOCATE TEMPORARY ARRAY.                                     INDAT1.......40000
         DEALLOCATE(INOB)                                                INDAT1.......40100
C........SKIP PAST THE CODE THAT READS A LIST OF GENERALIZED             INDAT1.......40200
C           OBSERVATION POINTS.                                          INDAT1.......40300
         GOTO 820                                                        INDAT1.......40400
      END IF                                                             INDAT1.......40500
C.....READ THE LIST OF GENERALIZED OBSERVATION POINTS.                   INDAT1.......40600
      NOBCYC = -1                                                        INDAT1.......40700
      DO 690 I=1,NOBS                                                    INDAT1.......40800
C........READ THE OBSERVATION NAME.                                      INDAT1.......40900
         CALL READIF(K1, 0, INTFIL, ERRCOD)                              INDAT1.......41000
         READ(INTFIL,*,IOSTAT=INERR(1)) OBSNAM                           INDAT1.......41100
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT1.......41200
C........IF END-OF-LIST MARKER ENCOUNTERED TOO SOON, GENERATE ERROR.     INDAT1.......41300
         IF (OBSNAM.EQ.'-') THEN                                         INDAT1.......41400
            ERRCOD = 'INP-8D-4'                                          INDAT1.......41500
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     INDAT1.......41600
         END IF                                                          INDAT1.......41700
C........READ IN (X,Y,Z) OR (X,Y) COORDINATES, DEPENDING ON PROBLEM      INDAT1.......41800
C           DIMENSIONALITY, AS WELL AS OUTPUT SCHEDULE AND FORMAT.       INDAT1.......41900
         IF (KTYPE(1).EQ.3) THEN                                         INDAT1.......42000
            READ(INTFIL,*,IOSTAT=INERR(1)) OBSNAM, XOBS, YOBS, ZOBS,     INDAT1.......42100
     1         CDUM80, OBSFMT                                            INDAT1.......42200
         ELSE                                                            INDAT1.......42300
            READ(INTFIL,*,IOSTAT=INERR(1)) OBSNAM, XOBS, YOBS,           INDAT1.......42400
     1         CDUM80, OBSFMT                                            INDAT1.......42500
            ZOBS = 0D0                                                   INDAT1.......42600
         END IF                                                          INDAT1.......42700
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT1.......42800
         IF (LEN_TRIM(CDUM80).GT.10) THEN                                INDAT1.......42900
            ERRCOD = 'INP-8D-6'                                          INDAT1.......43000
            CHERR(1) = CDUM80                                            INDAT1.......43100
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     INDAT1.......43200
         END IF                                                          INDAT1.......43300
         OBSSCH = CDUM80                                                 INDAT1.......43400
         OBSPTS(I)%NAME = OBSNAM                                         INDAT1.......43500
         OBSPTS(I)%X = XOBS                                              INDAT1.......43600
         OBSPTS(I)%Y = YOBS                                              INDAT1.......43700
         OBSPTS(I)%Z = ZOBS                                              INDAT1.......43800
         IF (ISSTRA.EQ.1) THEN                                           INDAT1.......43900
            OBSPTS(I)%SCHED = "TIME_STEPS"                               INDAT1.......44000
         ELSE                                                            INDAT1.......44100
            OBSPTS(I)%SCHED = OBSSCH                                     INDAT1.......44200
         END IF                                                          INDAT1.......44300
         OBSPTS(I)%FRMT = OBSFMT                                         INDAT1.......44400
  690 CONTINUE                                                           INDAT1.......44500
C.....READ ONE MORE LINE TO CHECK FOR THE END-OF-LIST MARKER ('-').      INDAT1.......44600
C        IF NOT FOUND, GENERATE ERROR.                                   INDAT1.......44700
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1.......44800
      READ(INTFIL,*,IOSTAT=INERR(1)) OBSNAM                              INDAT1.......44900
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1.......45000
      IF (OBSNAM.NE.'-') THEN                                            INDAT1.......45100
         ERRCOD = 'INP-8D-4'                                             INDAT1.......45200
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1.......45300
      END IF                                                             INDAT1.......45400
C                                                                        INDAT1.......45500
C.....CONDENSE SCHEDULE AND FILE TYPE INFORMATION FROM OBSDAT INTO       INDAT1.......45600
C        ARRAY OFP, CHECKING FOR UNDEFINED SCHEDULES                     INDAT1.......45700
  820 ALLOCATE (OFP(NSCH*2))                                             INDAT1.......45800
      IF (ISSTRA.EQ.1) THEN                                              INDAT1.......45900
         NFLOMX=0                                                        INDAT1.......46000
         DO 840 I=1,NOBS                                                 INDAT1.......46100
            DO 835 J=1,NFLOMX                                            INDAT1.......46200
               IF (OBSPTS(I)%FRMT.EQ.OFP(J)%FRMT) GOTO 840               INDAT1.......46300
  835       CONTINUE                                                     INDAT1.......46400
            NFLOMX = NFLOMX + 1                                          INDAT1.......46500
            OFP(NFLOMX)%ISCHED = 2                                       INDAT1.......46600
            OFP(NFLOMX)%FRMT = OBSPTS(I)%FRMT                            INDAT1.......46700
  840    CONTINUE                                                        INDAT1.......46800
      ELSE                                                               INDAT1.......46900
         NFLOMX = 0                                                      INDAT1.......47000
         DO 860 I=1,NOBS                                                 INDAT1.......47100
            DO 850 NS=1,NSCH                                             INDAT1.......47200
               IF (OBSPTS(I)%SCHED.EQ.SCHDLS(NS)%NAME) THEN              INDAT1.......47300
                  INS = NS                                               INDAT1.......47400
                  GOTO 852                                               INDAT1.......47500
               END IF                                                    INDAT1.......47600
  850       CONTINUE                                                     INDAT1.......47700
            ERRCOD = 'INP-8D-5'                                          INDAT1.......47800
            CHERR(1) = OBSPTS(I)%SCHED                                   INDAT1.......47900
            CHERR(2) = OBSPTS(I)%NAME                                    INDAT1.......48000
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     INDAT1.......48100
  852       DO 855 J=1,NFLOMX                                            INDAT1.......48200
               IF ((OBSPTS(I)%SCHED.EQ.SCHDLS(OFP(J)%ISCHED)%NAME).AND.  INDAT1.......48300
     1             (OBSPTS(I)%FRMT.EQ.OFP(J)%FRMT)) GOTO 860             INDAT1.......48400
  855       CONTINUE                                                     INDAT1.......48500
            NFLOMX = NFLOMX + 1                                          INDAT1.......48600
            OFP(NFLOMX)%ISCHED = INS                                     INDAT1.......48700
            OFP(NFLOMX)%FRMT = OBSPTS(I)%FRMT                            INDAT1.......48800
  860    CONTINUE                                                        INDAT1.......48900
      END IF                                                             INDAT1.......49000
C                                                                        INDAT1.......49100
C.....ASSIGN UNIT NUMBERS AND OPEN FILE UNITS FOR OBSERVATION OUTPUT     INDAT1.......49200
C        FILES.                                                          INDAT1.......49300
      CALL FOPEN()                                                       INDAT1.......49400
C                                                                        INDAT1.......49500
C.....OUTPUT OBSERVATION FILE INFORMATION                                INDAT1.......49600
      IF (ISSTRA.EQ.1) THEN                                              INDAT1.......49700
         WRITE(K3,868) IUNIO(1),FNAMO(1)                                 INDAT1.......49800
  868    FORMAT (//13X,'.OBS AND .OBC FILES'/13X,'-------------------'// INDAT1.......49900
     1      (13X,'UNIT ',I7,4X,'ASSIGNED TO ',A80))                      INDAT1.......50000
         WRITE(K3,869)                                                   INDAT1.......50100
  869    FORMAT (/13X,'NOTE: BECAUSE FLOW AND TRANSPORT ARE STEADY-',    INDAT1.......50200
     1      'STATE, USER-DEFINED SCHEDULES ARE NOT IN EFFECT.  '         INDAT1.......50300
     2      /13X,'STEADY-STATE OBSERVATIONS WILL BE WRITTEN TO THE ',    INDAT1.......50400
     3      'APPROPRIATE OUTPUT FILES.')                                 INDAT1.......50500
      ELSE IF (VERNIN.NE."2.0") THEN                                     INDAT1.......50600
         WRITE(K3,870) (SCHDLS(OFP(J)%ISCHED)%NAME,OFP(J)%FRMT,          INDAT1.......50700
     1      IUNIO(J),FNAMO(J),J=1,NFLOMX)                                INDAT1.......50800
  870    FORMAT (//13X,'.OBS AND .OBC FILES'/13X,'-------------------'// INDAT1.......50900
     1      (13X,'SCHEDULE ',A,', FORMAT ',A,', UNIT ',I7,4X,            INDAT1.......51000
     2      'ASSIGNED TO ',A80))                                         INDAT1.......51100
      ELSE                                                               INDAT1.......51200
         WRITE(K3,868) IUNIO(1),FNAMO(1)                                 INDAT1.......51300
         WRITE(K3,872) NOBCYC, SCHDLS(2)%LLEN                            INDAT1.......51400
  872    FORMAT (/13X,'NOTE: OBSERVATION OUTPUT CYCLING ',               INDAT1.......51500
     1      'INFORMATION WAS ENTERED USING THE OLD (VERSION 2D3D.1) '    INDAT1.......51600
     2      'INPUT FORMAT.'/13X,'OBSERVATIONS WILL BE MADE EVERY ',I8,   INDAT1.......51700
     3      ' TIME STEPS, AS WELL AS ON THE FIRST AND LAST TIME STEP,'   INDAT1.......51800
     4      /13X,'FOR A TOTAL OF ',I8,' TIME STEPS.')                    INDAT1.......51900
      END IF                                                             INDAT1.......52000
C                                                                        INDAT1.......52100
C.....OUTPUT GENERALIZED OBSERVATION POINT INFORMATION.                  INDAT1.......52200
      WRITE(K3,982)                                                      INDAT1.......52300
  982 FORMAT(////11X,'O B S E R V A T I O N   P O I N T S')              INDAT1.......52400
C.....3D PROBLEM.                                                        INDAT1.......52500
      IF (KTYPE(1).EQ.3) THEN                                            INDAT1.......52600
C........WRITE HEADER.                                                   INDAT1.......52700
         WRITE(K3,987)                                                   INDAT1.......52800
  987    FORMAT(                                                         INDAT1.......52900
     1        //13X,'NAME',42X,'COORDINATES',37X,'SCHEDULE',4X,'FORMAT'  INDAT1.......53000
     2         /13X,'----',42X,'-----------',37X,'--------',4X,'------') INDAT1.......53100
C........PRINT INFORMATION FOR EACH POINT.  IF POINTS WERE CONVERTED     INDAT1.......53200
C           FROM NODES, COORDINATES HAVE YET TO BE READ IN, SO PUT IN    INDAT1.......53300
C           A PLACEHOLDER.                                               INDAT1.......53400
         IF (NOBCYC.NE.-1) THEN                                          INDAT1.......53500
            DO 989 JJ=1,NOBS                                             INDAT1.......53600
               LTOP = LEN_TRIM(OBSPTS(JJ)%NAME)                          INDAT1.......53700
               IF (ISSTRA.EQ.1) THEN                                     INDAT1.......53800
                  OBSSCH = '-'                                           INDAT1.......53900
               ELSE                                                      INDAT1.......54000
                  OBSSCH = OBSPTS(JJ)%SCHED                              INDAT1.......54100
               END IF                                                    INDAT1.......54200
               WRITE(K3,988) TRIM(OBSPTS(JJ)%NAME),DOTS45(1:43-LTOP),    INDAT1.......54300
     1            OBSSCH,OBSPTS(JJ)%FRMT                                 INDAT1.......54400
  988          FORMAT(13X,A,1X,A,1X,                                     INDAT1.......54500
     1            '( _______ TO BE READ FROM DATASET 14 _______ )',      INDAT1.......54600
     2            3X,A,2X,A)                                             INDAT1.......54700
  989       CONTINUE                                                     INDAT1.......54800
         ELSE                                                            INDAT1.......54900
            DO 991 JJ=1,NOBS                                             INDAT1.......55000
               LTOP = LEN_TRIM(OBSPTS(JJ)%NAME)                          INDAT1.......55100
               IF (ISSTRA.EQ.1) THEN                                     INDAT1.......55200
                  OBSSCH = '-'                                           INDAT1.......55300
               ELSE                                                      INDAT1.......55400
                  OBSSCH = OBSPTS(JJ)%SCHED                              INDAT1.......55500
               END IF                                                    INDAT1.......55600
               WRITE(K3,990) TRIM(OBSPTS(JJ)%NAME),DOTS45(1:43-LTOP),    INDAT1.......55700
     1            OBSPTS(JJ)%X,OBSPTS(JJ)%Y,OBSPTS(JJ)%Z,                INDAT1.......55800
     2            OBSSCH,OBSPTS(JJ)%FRMT                                 INDAT1.......55900
  990          FORMAT(13X,A,1X,A,1X,'(',2(1PE14.7,','),1PE14.7,')',      INDAT1.......56000
     1            3X,A,2X,A)                                             INDAT1.......56100
  991       CONTINUE                                                     INDAT1.......56200
         END IF                                                          INDAT1.......56300
C.....2D PROBLEM.                                                        INDAT1.......56400
      ELSE                                                               INDAT1.......56500
C........WRITE HEADER.                                                   INDAT1.......56600
         WRITE(K3,993)                                                   INDAT1.......56700
  993    FORMAT(                                                         INDAT1.......56800
     1        //13X,'NAME',42X,'COORDINATES',22X,'SCHEDULE',4X,'FORMAT'  INDAT1.......56900
     2         /13X,'----',42X,'-----------',22X,'--------',4X,'------') INDAT1.......57000
C........PRINT INFORMATION FOR EACH POINT.  IF POINTS WERE CONVERTED     INDAT1.......57100
C           FROM NODES, COORDINATES HAVE YET TO BE READ IN, SO PUT IN    INDAT1.......57200
C           A PLACEHOLDER.                                               INDAT1.......57300
         IF (NOBCYC.NE.-1) THEN                                          INDAT1.......57400
            DO 995 JJ=1,NOBS                                             INDAT1.......57500
               LTOP = LEN_TRIM(OBSPTS(JJ)%NAME)                          INDAT1.......57600
               IF (ISSTRA.EQ.1) THEN                                     INDAT1.......57700
                  OBSSCH = '-'                                           INDAT1.......57800
               ELSE                                                      INDAT1.......57900
                  OBSSCH = OBSPTS(JJ)%SCHED                              INDAT1.......58000
               END IF                                                    INDAT1.......58100
               WRITE(K3,994) TRIM(OBSPTS(JJ)%NAME),DOTS45(1:43-LTOP),    INDAT1.......58200
     1            OBSSCH,OBSPTS(JJ)%FRMT                                 INDAT1.......58300
  994          FORMAT(13X,A,1X,A,1X,'( TO BE READ FROM DATASET 14  )',   INDAT1.......58400
     1            3X,A,2X,A)                                             INDAT1.......58500
  995       CONTINUE                                                     INDAT1.......58600
         ELSE                                                            INDAT1.......58700
            DO 997 JJ=1,NOBS                                             INDAT1.......58800
               LTOP = LEN_TRIM(OBSPTS(JJ)%NAME)                          INDAT1.......58900
               IF (ISSTRA.EQ.1) THEN                                     INDAT1.......59000
                  OBSSCH = '-'                                           INDAT1.......59100
               ELSE                                                      INDAT1.......59200
                  OBSSCH = OBSPTS(JJ)%SCHED                              INDAT1.......59300
               END IF                                                    INDAT1.......59400
               WRITE(K3,996) TRIM(OBSPTS(JJ)%NAME),DOTS45(1:43-LTOP),    INDAT1.......59500
     1            OBSPTS(JJ)%X,OBSPTS(JJ)%Y,                             INDAT1.......59600
     2            OBSSCH,OBSPTS(JJ)%FRMT                                 INDAT1.......59700
  996          FORMAT(13X,A,1X,A,1X,'(',1PE14.7,',',1PE14.7,')',         INDAT1.......59800
     1            3X,A,2X,A)                                             INDAT1.......59900
  997       CONTINUE                                                     INDAT1.......60000
         END IF                                                          INDAT1.......60100
      END IF                                                             INDAT1.......60200
  999 CONTINUE                                                           INDAT1.......60300
C                                                                        INDAT1.......60400
C.....INPUT DATASET 8E:  OUTPUT CONTROLS AND OPTIONS FOR BCOF, BCOP,     INDAT1.......60500
C        BCOS, AND BCOU FILES                                            INDAT1.......60600
      IF ((VERNIN.EQ.'2.0').OR.(VERNIN.EQ.'2.1')) THEN                   INDAT1.......60700
         NBCFPR = HUGE(1)                                                INDAT1.......60800
         NBCSPR = HUGE(1)                                                INDAT1.......60900
         NBCPPR = HUGE(1)                                                INDAT1.......61000
         NBCUPR = HUGE(1)                                                INDAT1.......61100
C........CINACT IS IRRELEVANT IN THIS CASE                               INDAT1.......61200
         GOTO 1100                                                       INDAT1.......61300
      END IF                                                             INDAT1.......61400
      ERRCOD = 'REA-INP-8E'                                              INDAT1.......61500
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1.......61600
      READ(INTFIL,*,IOSTAT=INERR(1)) NBCFPR, NBCSPR, NBCPPR, NBCUPR,     INDAT1.......61700
     1   CINACT                                                          INDAT1.......61800
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1.......61900
      IF (CINACT.EQ.'Y') THEN                                            INDAT1.......62000
         KINACT = +1                                                     INDAT1.......62100
      ELSE IF (CINACT.EQ.'N') THEN                                       INDAT1.......62200
         KINACT = 0                                                      INDAT1.......62300
      ELSE                                                               INDAT1.......62400
         ERRCOD = 'INP-8E-1'                                             INDAT1.......62500
         CHERR(1) = 'CINACT'                                             INDAT1.......62600
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1.......62700
      END IF                                                             INDAT1.......62800
      IF (ME.EQ.-1) THEN                                                 INDAT1.......62900
         WRITE(K3,1050) NBCFPR, NBCSPR, NBCPPR, NBCUPR                   INDAT1.......63000
 1050    FORMAT(//13X,'.BCOF, .BCOS, .BCOP, AND .BCOU FILES'             INDAT1.......63100
     1           /13X,'------------------------------------'             INDAT1.......63200
     2      //13X,I8,3X,'PRINTED OUTPUT CYCLE FOR FLUID SOURCES/SINK ',  INDAT1.......63300
     3        'NODES TO .BCOF FILE (IN TIME STEPS)'                      INDAT1.......63400
     4       /13X,I8,3X,'PRINTED OUTPUT CYCLE FOR SOLUTE ',              INDAT1.......63500
     5        'SOURCES/SINK NODES TO .BCOS FILE (IN TIME STEPS)'         INDAT1.......63600
     6       /13X,I8,3X,'PRINTED OUTPUT CYCLE FOR SPECIFIED PRESSURE ',  INDAT1.......63700
     7        'NODES TO .BCOP FILE (IN TIME STEPS)'                      INDAT1.......63800
     8       /13X,I8,3X,'PRINTED OUTPUT CYCLE FOR SPECIFIED ',           INDAT1.......63900
     9        'CONCENTRATION NODES TO .BCOU FILE (IN TIME STEPS)')       INDAT1.......64000
      ELSE                                                               INDAT1.......64100
         WRITE(K3,1051) NBCFPR, NBCSPR, NBCPPR, NBCUPR                   INDAT1.......64200
 1051    FORMAT(//13X,'.BCOF, .BCOS, .BCOP, AND .BCOU FILES'             INDAT1.......64300
     1           /13X,'------------------------------------'             INDAT1.......64400
     2      //13X,I8,3X,'PRINTED OUTPUT CYCLE FOR FLUID SOURCES/SINK ',  INDAT1.......64500
     3        'NODES TO .BCOF FILE (IN TIME STEPS)'                      INDAT1.......64600
     4       /13X,I8,3X,'PRINTED OUTPUT CYCLE FOR ENERGY ',              INDAT1.......64700
     5        'SOURCES/SINK NODES TO .BCOS FILE (IN TIME STEPS)'         INDAT1.......64800
     6       /13X,I8,3X,'PRINTED OUTPUT CYCLE FOR SPECIFIED PRESSURE ',  INDAT1.......64900
     7        'NODES TO .BCOP FILE (IN TIME STEPS)'                      INDAT1.......65000
     8       /13X,I8,3X,'PRINTED OUTPUT CYCLE FOR SPECIFIED ',           INDAT1.......65100
     9        'TEMPERATURE NODES TO .BCOU FILE (IN TIME STEPS)')         INDAT1.......65200
      END IF                                                             INDAT1.......65300
      IF(KINACT.EQ.+1) WRITE(K3,1052)                                    INDAT1.......65400
      IF(KINACT.EQ.0) WRITE(K3,1053)                                     INDAT1.......65500
 1052 FORMAT(/13X,'- PRINT INACTIVE BOUNDARY CONDITIONS')                INDAT1.......65600
 1053 FORMAT(/13X,'- CANCEL PRINT OF INACTIVE BOUNDARY CONDITIONS')      INDAT1.......65700
C                                                                        INDAT1.......65800
C.....INPUT DATASET 9:  FLUID PROPERTIES                                 INDAT1.......65900
 1100 ERRCOD = 'REA-INP-9'                                               INDAT1.......66000
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1.......66100
      READ(INTFIL,*,IOSTAT=INERR(1)) COMPFL,CW,SIGMAW,RHOW0,URHOW0,      INDAT1.......66200
     1   DRWDU,VISC0,DVIDU
C     1   DRWDU,VISC0                                                     INDAT1.......66300
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1.......66400
C.....INPUT DATASET 10:  SOLID MATRIX PROPERTIES                         INDAT1.......66500
      ERRCOD = 'REA-INP-10'                                              INDAT1.......66600
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1.......66700
      READ(INTFIL,*,IOSTAT=INERR(1)) COMPMA,CS,SIGMAS,RHOS               INDAT1.......66800
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1.......66900
      IF(ME.EQ.+1)                                                       INDAT1.......67000
     1  WRITE(K3,1210) COMPFL,COMPMA,CW,CS,VISC0,RHOS,RHOW0,DRWDU,       INDAT1.......67100
     2     URHOW0,SIGMAW,SIGMAS                                          INDAT1.......67200
 1210 FORMAT('1'////11X,'C O N S T A N T   P R O P E R T I E S   O F',   INDAT1.......67300
     1   '   F L U I D   A N D   S O L I D   M A T R I X'                INDAT1.......67400
     2   //11X,1PE15.4,5X,'COMPRESSIBILITY OF FLUID'/11X,1PE15.4,5X,     INDAT1.......67500
     3   'COMPRESSIBILITY OF POROUS MATRIX'//11X,1PE15.4,5X,             INDAT1.......67600
     4   'SPECIFIC HEAT CAPACITY OF FLUID',/11X,1PE15.4,5X,              INDAT1.......67700
     5   'SPECIFIC HEAT CAPACITY OF SOLID GRAIN'//13X,'FLUID VISCOSITY', INDAT1.......67800
     6   ' IS CALCULATED BY SUTRA AS A FUNCTION OF TEMPERATURE IN ',     INDAT1.......67900
     7   'UNITS OF {kg/(m*s)}'//11X,1PE15.4,5X,'VISC0, CONVERSION ',     INDAT1.......68000
     8   'FACTOR FOR VISCOSITY UNITS,  {desired units} = VISC0*',        INDAT1.......68100
     9   '{kg/(m*s)}'//11X,1PE15.4,5X,'DENSITY OF A SOLID GRAIN'         INDAT1.......68200
     *   //13X,'FLUID DENSITY, RHOW'/13X,'CALCULATED BY ',               INDAT1.......68300
     1   'SUTRA IN TERMS OF TEMPERATURE, U, AS:'/13X,'RHOW = RHOW0 + ',  INDAT1.......68400
     2   'DRWDU*(U-URHOW0)'//11X,1PE15.4,5X,'FLUID BASE DENSITY, RHOW0'  INDAT1.......68500
     3   /11X,1PE15.4,5X,'COEFFICIENT OF DENSITY CHANGE WITH ',          INDAT1.......68600
     4   'TEMPERATURE, DRWDU'/11X,1PE15.4,5X,'TEMPERATURE, URHOW0, ',    INDAT1.......68700
     5   'AT WHICH FLUID DENSITY IS AT BASE VALUE, RHOW0'                INDAT1.......68800
     6   //11X,1PE15.4,5X,'THERMAL CONDUCTIVITY OF FLUID'                INDAT1.......68900
     7   /11X,1PE15.4,5X,'THERMAL CONDUCTIVITY OF SOLID GRAIN')          INDAT1.......69000
      IF(ME.EQ.-1)                                                       INDAT1.......69100
     1  WRITE(K3,1220) COMPFL,COMPMA,VISC0,RHOS,RHOW0,DRWDU,             INDAT1.......69200
     2     URHOW0,SIGMAW                                                 INDAT1.......69300
 1220 FORMAT('1'////11X,'C O N S T A N T   P R O P E R T I E S   O F',   INDAT1.......69400
     1   '   F L U I D   A N D   S O L I D   M A T R I X'                INDAT1.......69500
     2   //11X,1PE15.4,5X,'COMPRESSIBILITY OF FLUID'/11X,1PE15.4,5X,     INDAT1.......69600
     3   'COMPRESSIBILITY OF POROUS MATRIX'                              INDAT1.......69700
     4   //11X,1PE15.4,5X,'FLUID VISCOSITY'                              INDAT1.......69800
     4   //11X,1PE15.4,5X,'DENSITY OF A SOLID GRAIN'                     INDAT1.......69900
     5   //13X,'FLUID DENSITY, RHOW'/13X,'CALCULATED BY ',               INDAT1.......70000
     6   'SUTRA IN TERMS OF SOLUTE CONCENTRATION, U, AS:',               INDAT1.......70100
     7   /13X,'RHOW = RHOW0 + DRWDU*(U-URHOW0)'                          INDAT1.......70200
     8   //11X,1PE15.4,5X,'FLUID BASE DENSITY, RHOW0'                    INDAT1.......70300
     9   /11X,1PE15.4,5X,'COEFFICIENT OF DENSITY CHANGE WITH ',          INDAT1.......70400
     *   'SOLUTE CONCENTRATION, DRWDU'                                   INDAT1.......70500
     1   /11X,1PE15.4,5X,'SOLUTE CONCENTRATION, URHOW0, ',               INDAT1.......70600
     4   'AT WHICH FLUID DENSITY IS AT BASE VALUE, RHOW0'                INDAT1.......70700
     5   //11X,1PE15.4,5X,'MOLECULAR DIFFUSIVITY OF SOLUTE IN FLUID')    INDAT1.......70800
C                                                                        INDAT1.......70900
C.....INPUT DATASET 11:  ADSORPTION PARAMETERS                           INDAT1.......71000
      ERRCOD = 'REA-INP-11'                                              INDAT1.......71100
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1.......71200
      READ(INTFIL,*,IOSTAT=INERR(1)) ADSMOD                              INDAT1.......71300
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1.......71400
      IF (ADSMOD.NE.'NONE      ') THEN                                   INDAT1.......71500
         READ(INTFIL,*,IOSTAT=INERR(1)) ADSMOD,CHI1,CHI2                 INDAT1.......71600
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT1.......71700
      END IF                                                             INDAT1.......71800
      IF(ME.EQ.+1) GOTO 1248                                             INDAT1.......71900
      IF(ADSMOD.EQ.'NONE      ') GOTO 1234                               INDAT1.......72000
      WRITE(K3,1232) ADSMOD                                              INDAT1.......72100
 1232 FORMAT(////11X,'A D S O R P T I O N   P A R A M E T E R S'         INDAT1.......72200
     1   //16X,A10,5X,'EQUILIBRIUM SORPTION ISOTHERM')                   INDAT1.......72300
      GOTO 1236                                                          INDAT1.......72400
 1234 WRITE(K3,1235)                                                     INDAT1.......72500
 1235 FORMAT(////11X,'A D S O R P T I O N   P A R A M E T E R S'         INDAT1.......72600
     1   //16X,'NON-SORBING SOLUTE')                                     INDAT1.......72700
 1236 IF((ADSMOD.EQ.'NONE      ').OR.(ADSMOD.EQ.'LINEAR    ').OR.        INDAT1.......72800
     1   (ADSMOD.EQ.'FREUNDLICH').OR.(ADSMOD.EQ.'LANGMUIR  ').OR.
     2 (ADSMOD.EQ.'SOLID')) GOTO 1238
C     1   (ADSMOD.EQ.'FREUNDLICH').OR.(ADSMOD.EQ.'LANGMUIR  ')) GOTO 1238 INDAT1.......72900
      ERRCOD = 'INP-11-1'                                                INDAT1.......73000
      CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                           INDAT1.......73100
 1238 IF(ADSMOD.EQ.'LINEAR    ') WRITE(K3,1242) CHI1                     INDAT1.......73200
 1242 FORMAT(11X,1PE15.4,5X,'LINEAR DISTRIBUTION COEFFICIENT')           INDAT1.......73300
      IF(ADSMOD.EQ.'FREUNDLICH') WRITE(K3,1244) CHI1,CHI2                INDAT1.......73400
 1244 FORMAT(11X,1PE15.4,5X,'FREUNDLICH DISTRIBUTION COEFFICIENT'        INDAT1.......73500
     1   /11X,1PE15.4,5X,'SECOND FREUNDLICH COEFFICIENT')                INDAT1.......73600
      IF(ADSMOD.EQ.'FREUNDLICH'.AND.CHI2.LE.0.D0) THEN                   INDAT1.......73700
         ERRCOD = 'INP-11-2'                                             INDAT1.......73800
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1.......73900
      ENDIF                                                              INDAT1.......74000
      IF(ADSMOD.EQ.'LANGMUIR  ') WRITE(K3,1246) CHI1,CHI2                INDAT1.......74100
 1246 FORMAT(11X,1PE15.4,5X,'LANGMUIR DISTRIBUTION COEFFICIENT'          INDAT1.......74200
     1   /11X,1PE15.4,5X,'SECOND LANGMUIR COEFFICIENT')                  INDAT1.......74300
C                                                                        INDAT1.......74400
C.....INPUT DATASET 12:  PRODUCTION OF ENERGY OR SOLUTE MASS             INDAT1.......74500
 1248 ERRCOD = 'REA-INP-12'                                              INDAT1.......74600
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1.......74700
      READ(INTFIL,*,IOSTAT=INERR(1)) PRODF0,PRODS0,PRODF1,PRODS1         INDAT1.......74800
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1.......74900
      IF(ME.EQ.-1) WRITE(K3,1250) PRODF0,PRODS0,PRODF1,PRODS1            INDAT1.......75000
 1250 FORMAT(////11X,'P R O D U C T I O N   A N D   D E C A Y   O F   ', INDAT1.......75100
     1   'S P E C I E S   M A S S'//13X,'PRODUCTION RATE (+)'/13X,       INDAT1.......75200
     2   'DECAY RATE (-)'//11X,1PE15.4,5X,'ZERO-ORDER RATE OF SOLUTE ',  INDAT1.......75300
     3   'MASS PRODUCTION/DECAY IN FLUID'/11X,1PE15.4,5X,                INDAT1.......75400
     4   'ZERO-ORDER RATE OF ADSORBATE MASS PRODUCTION/DECAY IN ',       INDAT1.......75500
     5   'IMMOBILE PHASE'/11X,1PE15.4,5X,'FIRST-ORDER RATE OF SOLUTE ',  INDAT1.......75600
     3   'MASS PRODUCTION/DECAY IN FLUID'/11X,1PE15.4,5X,                INDAT1.......75700
     4   'FIRST-ORDER RATE OF ADSORBATE MASS PRODUCTION/DECAY IN ',      INDAT1.......75800
     5   'IMMOBILE PHASE')                                               INDAT1.......75900
      IF(ME.EQ.+1) WRITE(K3,1260) PRODF0,PRODS0                          INDAT1.......76000
 1260 FORMAT(////11X,'P R O D U C T I O N   A N D   L O S S   O F   ',   INDAT1.......76100
     1   'E N E R G Y'//13X,'PRODUCTION RATE (+)'/13X,                   INDAT1.......76200
     2   'LOSS RATE (-)'//11X,1PE15.4,5X,'ZERO-ORDER RATE OF ENERGY ',   INDAT1.......76300
     3   'PRODUCTION/LOSS IN FLUID'/11X,1PE15.4,5X,                      INDAT1.......76400
     4   'ZERO-ORDER RATE OF ENERGY PRODUCTION/LOSS IN ',                INDAT1.......76500
     5   'SOLID GRAINS')                                                 INDAT1.......76600
C.....SET PARAMETER SWITCHES FOR EITHER ENERGY OR SOLUTE TRANSPORT       INDAT1.......76700
      IF(ME) 1272,1272,1274                                              INDAT1.......76800
C     FOR SOLUTE TRANSPORT:                                              INDAT1.......76900
 1272 CS=0.0D0                                                           INDAT1.......77000
      CW=1.D00                                                           INDAT1.......77100
      SIGMAS=0.0D0                                                       INDAT1.......77200
      GOTO 1278                                                          INDAT1.......77300
C     FOR ENERGY TRANSPORT:                                              INDAT1.......77400
 1274 ADSMOD='NONE      '                                                INDAT1.......77500
      CHI1=0.0D0                                                         INDAT1.......77600
      CHI2=0.0D0                                                         INDAT1.......77700
      PRODF1=0.0D0                                                       INDAT1.......77800
      PRODS1=0.0D0                                                       INDAT1.......77900
 1278 CONTINUE                                                           INDAT1.......78000
C                                                                        INDAT1.......78100
      IF (KTYPE(1).EQ.3) THEN                                            INDAT1.......78200
C.....READ 3D INPUT FROM DATASETS 13 - 15.                               INDAT1.......78300
C                                                                        INDAT1.......78400
C.....INPUT DATASET 13:  ORIENTATION OF COORDINATES TO GRAVITY           INDAT1.......78500
      ERRCOD = 'REA-INP-13'                                              INDAT1.......78600
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1.......78700
      READ(INTFIL,*,IOSTAT=INERR(1)) GRAVX,GRAVY,GRAVZ                   INDAT1.......78800
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1.......78900
      WRITE(K3,1320) GRAVX,GRAVY,GRAVZ                                   INDAT1.......79000
 1320 FORMAT(////11X,'C O O R D I N A T E   O R I E N T A T I O N   ',   INDAT1.......79100
     1   'T O   G R A V I T Y'//13X,'COMPONENT OF GRAVITY VECTOR',       INDAT1.......79200
     2   /13X,'IN +X DIRECTION, GRAVX'/11X,1PE15.4,5X,                   INDAT1.......79300
     3   'GRAVX = -GRAV * D(ELEVATION)/DX'//13X,'COMPONENT OF GRAVITY',  INDAT1.......79400
     4   ' VECTOR'/13X,'IN +Y DIRECTION, GRAVY'/11X,1PE15.4,5X,          INDAT1.......79500
     5   'GRAVY = -GRAV * D(ELEVATION)/DY'//13X,'COMPONENT OF GRAVITY',  INDAT1.......79600
     6   ' VECTOR'/13X,'IN +Z DIRECTION, GRAVZ'/11X,1PE15.4,5X,          INDAT1.......79700
     7   'GRAVZ = -GRAV * D(ELEVATION)/DZ')                              INDAT1.......79800
C                                                                        INDAT1.......79900
CM....INPUT DATASET 13B FOR 3D CASE(TIDAL FLUCTUATION INPUT)
      ERRCOD = 'REA-INP-13B'                                               
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 
      READ(INTFIL,*,IOSTAT=INERR(1)) TA,TP,TM,RHOST,SC,ITEB
CM....INPUT DATASET 13C FOR 3D CASE (ET Process Parameters)
      ERRCOD = 'REA-INP-13C'                                               
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 
      READ(INTFIL,*,IOSTAT=INERR(1)) QET,UET,PET,UVM,NGT
      IF (QET.EQ.1.)THEN                                    
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 
      READ(INTFIL,*,IOSTAT=INERR(1)) TMA,TMI,ALF,RS,RH,AP,BP,U2,TSD,SCF
      ENDIF

C.....INPUT DATASETS 14A & 14B:  NODEWISE DATA                           INDAT1.......80000
      ERRCOD = 'REA-INP-14A'                                             INDAT1.......80100
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1.......80200
      READ(INTFIL,*,IOSTAT=INERR(1)) CDUM10,SCALX,SCALY,SCALZ,PORFAC     INDAT1.......80300
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1.......80400
      IF (CDUM10.NE.'NODE      ') THEN                                   INDAT1.......80500
         ERRCOD = 'INP-14A-1'                                            INDAT1.......80600
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1.......80700
      END IF                                                             INDAT1.......80800
      NRTEST=1                                                           INDAT1.......80900
      DO 1450 I=1,NN                                                     INDAT1.......81000
      ERRCOD = 'REA-INP-14B'                                             INDAT1.......81100
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1.......81200
      READ(INTFIL,*,IOSTAT=INERR(1)) II,NREG(II),X(II),Y(II),Z(II),      INDAT1.......81300
     1   POR(II)                                                         INDAT1.......81400
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1.......81500
      X(II)=X(II)*SCALX                                                  INDAT1.......81600
      Y(II)=Y(II)*SCALY                                                  INDAT1.......81700
      Z(II)=Z(II)*SCALZ                                                  INDAT1.......81800
      POR(II)=POR(II)*PORFAC                                             INDAT1.......81900
      POR1(II)=POR(II)
      IF(I.GT.1.AND.NREG(II).NE.NROLD) NRTEST=NRTEST+1                   INDAT1.......82000
      NROLD=NREG(II)                                                     INDAT1.......82100
C.....SET SPECIFIC PRESSURE STORATIVITY, SOP.                            INDAT1.......82200
 1450 SOP(II)=(1.D0-POR(II))*COMPMA+POR(II)*COMPFL                       INDAT1.......82300
 1460 IF(KNODAL.EQ.0) WRITE(K3,1461) SCALX,SCALY,SCALZ,PORFAC            INDAT1.......82400
 1461 FORMAT('1'////11X,'N O D E   I N F O R M A T I O N'//16X,          INDAT1.......82500
     1   'PRINTOUT OF NODE COORDINATES AND POROSITIES ',                 INDAT1.......82600
     2   'CANCELLED.'//16X,'SCALE FACTORS :'/33X,1PE15.4,5X,'X-SCALE'/   INDAT1.......82700
     3   33X,1PE15.4,5X,'Y-SCALE'/33X,1PE15.4,5X,'Z-SCALE'/              INDAT1.......82800
     4   33X,1PE15.4,5X,'POROSITY FACTOR')                               INDAT1.......82900
      IF(IUNSAT.EQ.1.AND.KNODAL.EQ.0.AND.NRTEST.NE.1) WRITE(K3,1463)     INDAT1.......83000
      IF(IUNSAT.EQ.1.AND.KNODAL.EQ.0.AND.NRTEST.EQ.1) WRITE(K3,1465)     INDAT1.......83100
 1463 FORMAT(33X,'MORE THAN ONE REGION OF UNSATURATED PROPERTIES HAS ',  INDAT1.......83200
     1   'BEEN SPECIFIED AMONG THE NODES.')                              INDAT1.......83300
 1465 FORMAT(33X,'ONLY ONE REGION OF UNSATURATED PROPERTIES HAS ',       INDAT1.......83400
     1   'BEEN SPECIFIED AMONG THE NODES.')                              INDAT1.......83500
      IF(KNODAL.EQ.+1.AND.IUNSAT.NE.1)                                   INDAT1.......83600
     1   WRITE(K3,1470)(I,X(I),Y(I),Z(I),POR(I),I=1,NN)                  INDAT1.......83700
 1470 FORMAT('1'//11X,'N O D E   I N F O R M A T I O N'//14X,            INDAT1.......83800
     1   'NODE',7X,'X',16X,'Y',16X,'Z',15X,'POROSITY'//                  INDAT1.......83900
     2   (9X,I9,3(3X,1PE14.5),6X,0PF8.5))                                INDAT1.......84000
      IF(KNODAL.EQ.+1.AND.IUNSAT.EQ.1)                                   INDAT1.......84100
     1   WRITE(K3,1480)(I,NREG(I),X(I),Y(I),Z(I),POR(I),I=1,NN)          INDAT1.......84200
 1480 FORMAT('1'//11X,'N O D E   I N F O R M A T I O N'//14X,'NODE',3X,  INDAT1.......84300
     1   'REGION',7X,'X',16X,'Y',16X,'Z',15X,'POROSITY'//                INDAT1.......84400
     2   (9X,I9,3X,I6,3(3X,1PE14.5),6X,0PF8.5))                          INDAT1.......84500
C                                                                        INDAT1.......84600
C.....INPUT DATASETS 15A & 15B:  ELEMENTWISE DATA                        INDAT1.......84700
      ERRCOD = 'REA-INP-15A'                                             INDAT1.......84800
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1.......84900
      READ(INTFIL,*,IOSTAT=INERR(1)) CDUM10,PMAXFA,PMIDFA,PMINFA,        INDAT1.......85000
     1   ANG1FA,ANG2FA,ANG3FA,ALMAXF,ALMIDF,ALMINF,                      INDAT1.......85100
     1   ATMXF,ATMDF,ATMNF                                               INDAT1.......85200
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1.......85300
      IF (CDUM10.NE.'ELEMENT   ') THEN                                   INDAT1.......85400
         ERRCOD = 'INP-15A-1'                                            INDAT1.......85500
         CHERR(1) = '3D'                                                 INDAT1.......85600
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1.......85700
      END IF                                                             INDAT1.......85800
      IF(KELMNT.EQ.+1) THEN                                              INDAT1.......85900
         IF (IUNSAT.EQ.1) THEN                                           INDAT1.......86000
            WRITE(K3,1500)                                               INDAT1.......86100
 1500       FORMAT('1'//11X,'E L E M E N T   I N F O R M A T I O N'//    INDAT1.......86200
     1         11X,'ELEMENT',3X,'REGION',4X,                             INDAT1.......86300
     2         'MAXIMUM',9X,'MIDDLE',10X,'MINIMUM',18X,                  INDAT1.......86400
     2         'ANGLE1',9X,'ANGLE2',9X,'ANGLE3',4X,                      INDAT1.......86500
     2         'LONGITUDINAL',3X,'LONGITUDINAL',3X,'LONGITUDINAL',5X,    INDAT1.......86600
     2         'TRANSVERSE',5X,'TRANSVERSE',5X,'TRANSVERSE'/             INDAT1.......86700
     3         31X,'PERMEABILITY',4X,'PERMEABILITY',4X,'PERMEABILITY',   INDAT1.......86800
     4         8X,'(IN DEGREES)',3X,'(IN DEGREES)',3X,'(IN DEGREES)',3X, INDAT1.......86900
     4         'DISPERSIVITY',3X,'DISPERSIVITY',3X,'DISPERSIVITY',3X,    INDAT1.......87000
     4         'DISPERSIVITY',3X,'DISPERSIVITY',3X,'DISPERSIVITY'/       INDAT1.......87100
     4         2(64X),' IN MAX-PERM',3X,' IN MID-PERM',3X,' IN MIN-PERM' INDAT1.......87200
     4         3X,' IN MAX-PERM',3X,' IN MID-PERM',3X,' IN MIN-PERM'/    INDAT1.......87300
     1         2(64X),'   DIRECTION',3X,'   DIRECTION',3X,'   DIRECTION' INDAT1.......87400
     2         3X,'   DIRECTION',3X,'   DIRECTION',3X,'   DIRECTION'/)   INDAT1.......87500
         ELSE                                                            INDAT1.......87600
            WRITE(K3,1501)                                               INDAT1.......87700
 1501       FORMAT('1'//11X,'E L E M E N T   I N F O R M A T I O N'//    INDAT1.......87800
     1         11X,'ELEMENT',4X,                                         INDAT1.......87900
     2         'MAXIMUM',9X,'MIDDLE',10X,'MINIMUM',18X,                  INDAT1.......88000
     2         'ANGLE1',9X,'ANGLE2',9X,'ANGLE3',4X,                      INDAT1.......88100
     2         'LONGITUDINAL',3X,'LONGITUDINAL',3X,'LONGITUDINAL',5X,    INDAT1.......88200
     2         'TRANSVERSE',5X,'TRANSVERSE',5X,'TRANSVERSE'/             INDAT1.......88300
     3         22X,'PERMEABILITY',4X,'PERMEABILITY',4X,'PERMEABILITY',   INDAT1.......88400
     4         8X,'(IN DEGREES)',3X,'(IN DEGREES)',3X,'(IN DEGREES)',3X, INDAT1.......88500
     4         'DISPERSIVITY',3X,'DISPERSIVITY',3X,'DISPERSIVITY',3X,    INDAT1.......88600
     4         'DISPERSIVITY',3X,'DISPERSIVITY',3X,'DISPERSIVITY'/       INDAT1.......88700
     4         119X,' IN MAX-PERM',3X,' IN MID-PERM',3X,' IN MIN-PERM',  INDAT1.......88800
     4         3X,' IN MAX-PERM',3X,' IN MID-PERM',3X,' IN MIN-PERM'/    INDAT1.......88900
     1         119X,'   DIRECTION',3X,'   DIRECTION',3X,'   DIRECTION',  INDAT1.......89000
     2         3X,'   DIRECTION',3X,'   DIRECTION',3X,'   DIRECTION'/)   INDAT1.......89100
         END IF                                                          INDAT1.......89200
      END IF                                                             INDAT1.......89300
      LRTEST=1                                                           INDAT1.......89400
      DO 1550 LL=1,NE                                                    INDAT1.......89500
      ERRCOD = 'REA-INP-15B'                                             INDAT1.......89600
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1.......89700
      READ(INTFIL,*,IOSTAT=INERR(1)) L,LREG(L),PMAX,PMID,PMIN,           INDAT1.......89800
     1   ANGLE1,ANGLE2,ANGLE3,ALMAX(L),ALMID(L),ALMIN(L),                INDAT1.......89900
     1   ATMAX(L),ATMID(L),ATMIN(L)                                      INDAT1.......90000
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1.......90100
      IF(LL.GT.1.AND.LREG(L).NE.LROLD) LRTEST=LRTEST+1                   INDAT1.......90200
      LROLD=LREG(L)                                                      INDAT1.......90300
      PMAX=PMAX*PMAXFA                                                   INDAT1.......90400
      PMID=PMID*PMIDFA                                                   INDAT1.......90500
      PMIN=PMIN*PMINFA                                                   INDAT1.......90600
      ANGLE1=ANGLE1*ANG1FA                                               INDAT1.......90700
      ANGLE2=ANGLE2*ANG2FA                                               INDAT1.......90800
      ANGLE3=ANGLE3*ANG3FA                                               INDAT1.......90900
      ALMAX(L)=ALMAX(L)*ALMAXF                                           INDAT1.......91000
      ALMID(L)=ALMID(L)*ALMIDF                                           INDAT1.......91100
      ALMIN(L)=ALMIN(L)*ALMINF                                           INDAT1.......91200
      ATMAX(L)=ATMAX(L)*ATMXF                                            INDAT1.......91300
      ATMID(L)=ATMID(L)*ATMDF                                            INDAT1.......91400
      ATMIN(L)=ATMIN(L)*ATMNF                                            INDAT1.......91500
      IF(KELMNT.EQ.+1.AND.IUNSAT.NE.1) WRITE(K3,1520) L,                 INDAT1.......91600
     1   PMAX,PMID,PMIN,ANGLE1,ANGLE2,ANGLE3,                            INDAT1.......91700
     2   ALMAX(L),ALMID(L),ALMIN(L),ATMAX(L),ATMID(L),ATMIN(L)           INDAT1.......91800
 1520 FORMAT(9X,I9,2X,3(1PE14.5,2X),7X,9(G11.4,4X))                      INDAT1.......91900
      IF(KELMNT.EQ.+1.AND.IUNSAT.EQ.1) WRITE(K3,1530) L,LREG(L),         INDAT1.......92000
     1   PMAX,PMID,PMIN,ANGLE1,ANGLE2,ANGLE3,                            INDAT1.......92100
     2   ALMAX(L),ALMID(L),ALMIN(L),ATMAX(L),ATMID(L),ATMIN(L)           INDAT1.......92200
 1530 FORMAT(9X,I9,4X,I5,2X,3(1PE14.5,2X),7X,9(G11.4,4X))                INDAT1.......92300
C                                                                        INDAT1.......92400
C.....ROTATE PERMEABILITY FROM MAX/MID/MIN TO X/Y/Z DIRECTIONS.          INDAT1.......92500
C        BASED ON CODE WRITTEN BY DAVID POLLOCK (USGS).                  INDAT1.......92600
      D2R=1.745329252D-2                                                 INDAT1.......92700
      PANGL1(L)=D2R*ANGLE1                                               INDAT1.......92800
      PANGL2(L)=D2R*ANGLE2                                               INDAT1.......92900
      PANGL3(L)=D2R*ANGLE3                                               INDAT1.......93000
      ZERO = 0D0                                                         INDAT1.......93100
      CALL ROTMAT(PANGL1(L),PANGL2(L),PANGL3(L),Q11,Q12,Q13,             INDAT1.......93200
     1   Q21,Q22,Q23,Q31,Q32,Q33)                                        INDAT1.......93300
      CALL TENSYM(PMAX,PMID,PMIN,Q11,Q12,Q13,Q21,Q22,Q23,Q31,Q32,Q33,    INDAT1.......93400
     1   PERMXX(L),PERMXY(L),PERMXZ(L),PERMYX(L),PERMYY(L),PERMYZ(L),    INDAT1.......93500
     2   PERMZX(L),PERMZY(L),PERMZZ(L))                                  INDAT1.......93600
 1550 CONTINUE                                                           INDAT1.......93700
      IF(KELMNT.EQ.0)                                                    INDAT1.......93800
     1   WRITE(K3,1569) PMAXFA,PMIDFA,PMINFA,ANG1FA,ANG2FA,ANG3FA,       INDAT1.......93900
     2      ALMAXF,ALMIDF,ALMINF,ATMXF,ATMDF,ATMNF                       INDAT1.......94000
 1569 FORMAT(////11X,'E L E M E N T   I N F O R M A T I O N'//           INDAT1.......94100
     1   16X,'PRINTOUT OF ELEMENT PERMEABILITIES AND DISPERSIVITIES ',   INDAT1.......94200
     2   'CANCELLED.'//16X,'SCALE FACTORS :'/33X,1PE15.4,5X,'MAXIMUM ',  INDAT1.......94300
     3   'PERMEABILITY FACTOR'/33X,1PE15.4,5X,'MIDDLE PERMEABILITY ',    INDAT1.......94400
     4   'FACTOR '/33X,1PE15.4,5X,'MINIMUM PERMEABILITY FACTOR'/         INDAT1.......94500
     5   33X,1PE15.4,5X,'ANGLE1 FACTOR'/33X,1PE15.4,5X,'ANGLE2 FACTOR'/  INDAT1.......94600
     6   33X,1PE15.4,5X,'ANGLE3 FACTOR'/                                 INDAT1.......94700
     7   33X,1PE15.4,5X,'FACTOR FOR LONGITUDINAL DISPERSIVITY IN ',      INDAT1.......94800
     8   'MAX-PERM DIRECTION'/33X,1PE15.4,5X,'FACTOR FOR LONGITUDINAL ', INDAT1.......94900
     9   'DISPERSIVITY IN MID-PERM DIRECTION'/33X,1PE15.4,5X,'FACTOR ',  INDAT1.......95000
     T   'FOR LONGITUDINAL DISPERSIVITY IN MIN-PERM DIRECTION'/          INDAT1.......95100
     1   33X,1PE15.4,5X,'FACTOR FOR TRANSVERSE DISPERSIVITY IN ',        INDAT1.......95200
     2   'MAX-PERM DIRECTION'/33X,1PE15.4,5X,'FACTOR FOR TRANSVERSE ',   INDAT1.......95300
     3   'DISPERSIVITY IN MID-PERM DIRECTION'/33X,1PE15.4,5X,'FACTOR',   INDAT1.......95400
     4   ' FOR TRANSVERSE DISPERSIVITY IN MIN-PERM DIRECTION')           INDAT1.......95500
      IF(IUNSAT.EQ.1.AND.KELMNT.EQ.0.AND.LRTEST.NE.1) WRITE(K3,1573)     INDAT1.......95600
      IF(IUNSAT.EQ.1.AND.KELMNT.EQ.0.AND.LRTEST.EQ.1) WRITE(K3,1575)     INDAT1.......95700
 1573 FORMAT(33X,'MORE THAN ONE REGION OF UNSATURATED PROPERTIES HAS ',  INDAT1.......95800
     1   'BEEN SPECIFIED AMONG THE ELEMENTS.')                           INDAT1.......95900
 1575 FORMAT(33X,'ONLY ONE REGION OF UNSATURATED PROPERTIES HAS ',       INDAT1.......96000
     1   'BEEN SPECIFIED AMONG THE ELEMENTS.')                           INDAT1.......96100
C                                                                        INDAT1.......96200
      ELSE                                                               INDAT1.......96300
C.....READ 2D INPUT FROM DATASETS 13 - 15.                               INDAT1.......96400
C.....NOTE THAT Z = THICKNESS AND PANGL1 = PANGLE.                       INDAT1.......96500
C                                                                        INDAT1.......96600
C.....INPUT DATASET 13:  ORIENTATION OF COORDINATES TO GRAVITY           INDAT1.......96700
      ERRCOD = 'REA-INP-13'                                              INDAT1.......96800
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1.......96900
      READ(INTFIL,*,IOSTAT=INERR(1)) GRAVX,GRAVY                         INDAT1.......97000
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1.......97100
      GRAVZ = 0D0                                                        INDAT1.......97200
      WRITE(K3,2320) GRAVX,GRAVY                                         INDAT1.......97300
 2320 FORMAT(////11X,'C O O R D I N A T E   O R I E N T A T I O N   ',   INDAT1.......97400
     1   'T O   G R A V I T Y'//13X,'COMPONENT OF GRAVITY VECTOR',       INDAT1.......97500
     2   /13X,'IN +X DIRECTION, GRAVX'/11X,1PE15.4,5X,                   INDAT1.......97600
     3   'GRAVX = -GRAV * D(ELEVATION)/DX'//13X,'COMPONENT OF GRAVITY',  INDAT1.......97700
     4   ' VECTOR'/13X,'IN +Y DIRECTION, GRAVY'/11X,1PE15.4,5X,          INDAT1.......97800
     5   'GRAVY = -GRAV * D(ELEVATION)/DY')                              INDAT1.......97900

C   DATASET 13B FOR 2D CASE(TIDAL FLUCTUATION INPUT)
      ERRCOD = 'REA-INP-13B'                                               
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 
      READ(INTFIL,*,IOSTAT=INERR(1)) TA,TP,TM,RHOST,SC,ITT

C   DATASET 13C FOR 2D CASE (ET Process Parameters)
C     MET...SWICH OF EVAPORATION. =1 PENMAN EQUATION =2 PDV EQUATION =0 OFF
C     MAR...AERODYNAMIC RESISTANCE SWICH =1 CONSTANT =0 OFF
C     MSR...SURFACE RESISTANCE SWICH =1 =2 =0 OFF
C     MSC...SALT RESISTANCE SWICH =0 OFF =1 FUJIMAKI(2006)
C     MHT...IF MHT=1 USING SIMPLE HEAT BALANCE EQUATION TO CALCULATE TEMPERATURE
C              MHT=2 USING ENERGY TRANSFER EQUATION TO CALCULATE T
C              MHT=3 DIRECTLY USING INITIAL ENERGY EQUATION
C     MFT...(F)ILM (T)RANSPORT SWICH SEE PAGE 165 SEE PAGE 166 FOR REFERENCE
C             MFT=0, FILM TRANSPORT DISABLED
C             MFT=1, FILM TRANSPORT IS ENABLED BASED ON TOKUNAKA (2009) AND ZHANG(2010) 
C             MFT=2, FILM TRANSPORT IS CALCULATED BY MUALEM (1976) BASED ON TOTAL SATURATION. SEE PAGE 170
C     MRK IS CURRENT NOT USED
      ERRCOD = 'REA-INP-13C'
      CALL READIF(K1, 0, INTFIL, ERRCOD)      
      READ(INTFIL,*,IOSTAT=INERR(1)) MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK

C   DATASET 13D: EVAPORATION SINARIO
C     QET... (MM/DAY) NON OF USE SO FAR
C     UET... (KG/KG) THE SOLUTE DENSITY OF WATER TAKEN BY EVAPORATION
C     PET... (PA) WHEN PORE WATER PRESSURE REACHED THE POINT LOWER THAN PET, EVAPORATION IS TAKING PLACE
C     UVM... (KG/KG) SOLUBILITY
C     NGT... IF =1 EVAPORATION IS SWICHED OFF DURING NIGHT TIME, IF =0 IT IS ALWAYS ON
C     ITE... TEMPERATORYLY NOT USING, IT WAS DESIGNED FOR THE NUMBER OF TIME CALL FOR BCTIME
C      IF (MET.NE.0)THEN
      ERRCOD = 'REA-INP-13D'      
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 
      READ(INTFIL,*,IOSTAT=INERR(1)) QET,UET,PET,UVM,NGT,ITE

C   DATASET 13E: EVAPORATION PARAMETER
C     TMA ... (K) ATMOSPHERE TEMPERATURE
C     RH  ... (L) RELATIVE HUMIDITY IN THE ATMOSPHERE
C     TSD ... (CELSIUS) (T)EMPERATURE ON THE (S)I(D)E OF THE COLUMN
C     SCF ... SCALE FACTOR TO ALLOW CUBIC DOMAIN TO SIMULATE CYLINDRICAL PROBLEM. SEE PAGE 68
C              OF BOOK 2012
       ERRCOD = 'REA-INP-13E'
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 
        READ(INTFIL,*,IOSTAT=INERR(1)) TMA,TMI,ALF,RS,RH,AP,BP,U2,TSD
     1   ,SCF
C     ENDIF
      
C   DATASET 13F: AERODYNAMIC RESISTANCE TERM
C     RAVT... (S/M) AERODYNAMIC RESISTANCE
C      IF (MAR.EQ.1)THEN
        ERRCOD = 'REA-INP-13F'
      CALL READIF(K1, 0, INTFIL, ERRCOD) 
      READ(INTFIL,*,IOSTAT=INERR(1)) RAVT,RAVS,SWRAT
C      ENDIF

C   DATASET 13G SOIL THERMO PROPERTY TERM
C     HSC  -- HEAT SOURCE FROM ATMOSPHERE G [WATT/M2]
C     NHER -- NUMER OF NODES THAT CONSIDERS HEAT BALANCE    
C     ROUS -- THE DENSITY OF SOLID GRAIN     [KG/M3]
C     HCS  -- HEAT CAPACITY OF SOLID GRAIN   [J/KG/K]
C      IF (MHT.NE.0)THEN
        ERRCOD = 'REA-INP-13G'
      CALL READIF(K1, 0, INTFIL, ERRCOD) 
      READ(INTFIL,*,IOSTAT=INERR(1)) HSC,HER,ROUS,HCS
C      ENDIF
C   DATASET 13H, PARAMETERS FOR THE SALT RESISTANCE
C     AR  FITTING PARAMETER
C     BR  FITTING PARAMETER
C      IF (MSC.EQ.1)THEN
        ERRCOD = 'REA-INP-13H'
      CALL READIF(K1, 0, INTFIL, ERRCOD) 
      READ(INTFIL,*,IOSTAT=INERR(1)) AR,BR
C      ENDIF
CM      INPUT DATASET 13I FOR 2D CASE (WATER RETENTION CURVE PARAMETERS)
      ERRCOD = 'REA-INP-13I'                                               
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 
      READ(INTFIL,*,IOSTAT=INERR(1))SWRES1,AA1,VN1,SWRES2,AA2,VN2,
     1SWRES3,DLAM3,PHICB3,SWRES4,DLAM4,PHICB4,PHIC0,ECTO

C.... INPUT DATASET 13J FOR THERMAL CONDUCTIVITIES
C   NTC -- TYPE OF (T)HERMAL (C)ONDUCTIVITIES EQUATION: 
C              NTC=1, USING EQUATIONS FROM SUTRA MANUAL, THEN [TCS] AND [TCL] HAS TO BE INPUT 
C                     TCS -- THERMAL CONDUCTIVITY OF SOIL  USUALLY BETWEEN 2-4 W/M/K
C                     TCL -- THERMAL CONDUCTIVITY OF LIQUID WATER, 0.6      W/M/K
C              NTC=2, USING EQUATION FROM CHUNG AND HORTON (1987) THREE PARAMETERS [B1] [B2] [B3] IS REQUIRED 
      ERRCOD = 'REA-INP-13J'                                               
      CALL READIF(K1, 0, INTFIL, ERRCOD)                         
      READ(INTFIL,*,IOSTAT=INERR(1)) NTC
      IF (NTC.EQ.1)THEN        
        READ(INTFIL,*,IOSTAT=INERR(1)) NTC,TCS,TCL
      ELSEIF (NTC.EQ.2)THEN
        READ(INTFIL,*,IOSTAT=INERR(1)) NTC,B1,B2,B3
      ENDIF        
C  DATASET 13K ENHANCEMENT FACTOR
C   NEF -- THE SWITCH TO THE ENHANCEMENT FACTOR
C            =0, ENHANCEMENT FACTOR EQUALS TO 1
C            =1, APPLY ENHANCEMENT FACTOR TO THE TEMPERATURE GRADIENT TERM ONLY
C            =2, APPLY ENHANCEMENT FACTOR TO ALL OF THE TERMS
      ERRCOD = 'REA-INP-13K'                                               
      CALL READIF(K1, 0, INTFIL, ERRCOD)                         
      READ(INTFIL,*,IOSTAT=INERR(1)) NEF,YA,YB,YC,YD,YE,FC

C  DATASET 13L PARAMETERS FOR SURFACE RESISTANCE
C  SEE PAGE 142BLUEBOOK, 98(5) FOR REFERENCE
C  [TAL]  --  THICKNESS OF AIR LAYER (M) [TAL]
C  [EC]   --  ECCENTRICITY OF THE ACTIVE PORE
C  [ETR]  --  RESIDUAL EVAPORATION RATE [-] [ETR]
      ERRCOD = 'REA-INP-13L'                                               
      CALL READIF(K1, 0, INTFIL, ERRCOD)                         
      READ(INTFIL,*,IOSTAT=INERR(1)) TAL,EC,ETR
C DATASET 13M PARAMETERS FOR FILM FLOW
      ERRCOD = 'REA-INP-13M'                                               
      CALL READIF(K1, 0, INTFIL, ERRCOD)                         
      READ(INTFIL,*,IOSTAT=INERR(1)) CORF,AGR,PHICM,ASVL

C                                                                        INDAT1.......98000
C.....INPUT DATASETS 14A & 14B:  NODEWISE DATA                           INDAT1.......98100
      ERRCOD = 'REA-INP-14A'                                             INDAT1.......98200
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1.......98300
      READ(INTFIL,*,IOSTAT=INERR(1)) CDUM10,SCALX,SCALY,SCALTH,PORFAC    INDAT1.......98400
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1.......98500
      IF (CDUM10.NE.'NODE      ') THEN                                   INDAT1.......98600
         ERRCOD = 'INP-14A-1'                                            INDAT1.......98700
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1.......98800
      END IF                                                             INDAT1.......98900
      NRTEST=1                                                           INDAT1.......99000
      DO 2450 I=1,NN                                                     INDAT1.......99100
      ERRCOD = 'REA-INP-14B'                                             INDAT1.......99200
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1.......99300
      READ(INTFIL,*,IOSTAT=INERR(1)) II,NREG(II),X(II),Y(II),Z(II),      INDAT1.......99400
     1   POR(II)                                                         INDAT1.......99500
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1.......99600
      X(II)=X(II)*SCALX                                                  INDAT1.......99700
      Y(II)=Y(II)*SCALY                                                  INDAT1.......99800
      Z(II)=Z(II)*SCALTH                                                 INDAT1.......99900
      POR(II)=POR(II)*PORFAC                                             INDAT1......100000
      POR1(II)=POR(II)
      IF(I.GT.1.AND.NREG(II).NE.NROLD) NRTEST=NRTEST+1                   INDAT1......100100
      NROLD=NREG(II)                                                     INDAT1......100200
C.....SET SPECIFIC PRESSURE STORATIVITY, SOP.                            INDAT1......100300
 2450 SOP(II)=(1.D0-POR(II))*COMPMA+POR(II)*COMPFL                       INDAT1......100400
 2460 IF(KNODAL.EQ.0) WRITE(K3,2461) SCALX,SCALY,SCALTH,PORFAC           INDAT1......100500
 2461 FORMAT('1'////11X,'N O D E   I N F O R M A T I O N'//16X,          INDAT1......100600
     1   'PRINTOUT OF NODE COORDINATES, THICKNESSES AND POROSITIES ',    INDAT1......100700
     2   'CANCELLED.'//16X,'SCALE FACTORS :'/33X,1PE15.4,5X,'X-SCALE'/   INDAT1......100800
     1   33X,1PE15.4,5X,'Y-SCALE'/33X,1PE15.4,5X,'THICKNESS FACTOR'/     INDAT1......100900
     2   33X,1PE15.4,5X,'POROSITY FACTOR')                               INDAT1......101000
      IF(IUNSAT.EQ.1.AND.KNODAL.EQ.0.AND.NRTEST.NE.1) WRITE(K3,2463)     INDAT1......101100
      IF(IUNSAT.EQ.1.AND.KNODAL.EQ.0.AND.NRTEST.EQ.1) WRITE(K3,2465)     INDAT1......101200
 2463 FORMAT(33X,'MORE THAN ONE REGION OF UNSATURATED PROPERTIES HAS ',  INDAT1......101300
     1   'BEEN SPECIFIED AMONG THE NODES.')                              INDAT1......101400
 2465 FORMAT(33X,'ONLY ONE REGION OF UNSATURATED PROPERTIES HAS ',       INDAT1......101500
     1   'BEEN SPECIFIED AMONG THE NODES.')                              INDAT1......101600
      IF(KNODAL.EQ.+1.AND.IUNSAT.NE.1)                                   INDAT1......101700
     1   WRITE(K3,2470)(I,X(I),Y(I),Z(I),POR(I),I=1,NN)                  INDAT1......101800
 2470 FORMAT('1'//11X,'N O D E   I N F O R M A T I O N'//14X,            INDAT1......101900
     1   'NODE',7X,'X',16X,'Y',17X,'THICKNESS',6X,'POROSITY'//           INDAT1......102000
     2   (9X,I9,3(3X,1PE14.5),6X,0PF8.5))                                INDAT1......102100
      IF(KNODAL.EQ.+1.AND.IUNSAT.EQ.1)                                   INDAT1......102200
     1   WRITE(K3,2480)(I,NREG(I),X(I),Y(I),Z(I),POR(I),I=1,NN)          INDAT1......102300
 2480 FORMAT('1'//11X,'N O D E   I N F O R M A T I O N'//14X,'NODE',3X,  INDAT1......102400
     1   'REGION',7X,'X',16X,'Y',17X,'THICKNESS',6X,'POROSITY'//         INDAT1......102500
     2   (9X,I9,3X,I6,3(3X,1PE14.5),6X,0PF8.5))                          INDAT1......102600
C                                                                        INDAT1......102700
C.....INPUT DATASETS 15A & 15B:  ELEMENTWISE DATA                        INDAT1......102800
      ERRCOD = 'REA-INP-15A'                                             INDAT1......102900
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1......103000
      READ(INTFIL,*,IOSTAT=INERR(1)) CDUM10,PMAXFA,PMINFA,ANGFAC,        INDAT1......103100
     1   ALMAXF,ALMINF,ATMAXF,ATMINF                                     INDAT1......103200
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1......103300
      IF (CDUM10.NE.'ELEMENT   ') THEN                                   INDAT1......103400
         ERRCOD = 'INP-15A-1'                                            INDAT1......103500
         CHERR(1) = '2D'                                                 INDAT1......103600
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT1......103700
      END IF                                                             INDAT1......103800
      IF (KELMNT.EQ.+1) THEN                                             INDAT1......103900
         IF (IUNSAT.EQ.1) THEN                                           INDAT1......104000
            WRITE(K3,2500)                                               INDAT1......104100
 2500       FORMAT('1'//11X,'E L E M E N T   I N F O R M A T I O N'//    INDAT1......104200
     1         11X,'ELEMENT',3X,'REGION',4X,'MAXIMUM',9X,'MINIMUM',12X,  INDAT1......104300
     2         'ANGLE BETWEEN',3X,'LONGITUDINAL',3X,'LONGITUDINAL',5X,   INDAT1......104400
     3         'TRANSVERSE',5X,'TRANSVERSE'/                             INDAT1......104500
     4         31X,'PERMEABILITY',4X,'PERMEABILITY',4X,                  INDAT1......104600
     5         '+X-DIRECTION AND',3X,'DISPERSIVITY',3X,'DISPERSIVITY',   INDAT1......104700
     6         3X,'DISPERSIVITY',3X,'DISPERSIVITY'/                      INDAT1......104800
     7         59X,'MAXIMUM PERMEABILITY',3X,' IN MAX-PERM',             INDAT1......104900
     8         3X,' IN MIN-PERM',3X,' IN MAX-PERM',3X,' IN MIN-PERM'/    INDAT1......105000
     9         67X,'(IN DEGREES)',3X,'   DIRECTION',3X,                  INDAT1......105100
     1         '   DIRECTION',3X,'   DIRECTION',3X,'   DIRECTION'/)      INDAT1......105200
         ELSE                                                            INDAT1......105300
            WRITE(K3,2501)                                               INDAT1......105400
 2501       FORMAT('1'//11X,'E L E M E N T   I N F O R M A T I O N'//    INDAT1......105500
     1         11X,'ELEMENT',4X,'MAXIMUM',9X,'MINIMUM',12X,              INDAT1......105600
     2         'ANGLE BETWEEN',3X,'LONGITUDINAL',3X,'LONGITUDINAL',5X,   INDAT1......105700
     3         'TRANSVERSE',5X,'TRANSVERSE'/                             INDAT1......105800
     4         22X,'PERMEABILITY',4X,'PERMEABILITY',4X,                  INDAT1......105900
     5         '+X-DIRECTION AND',3X,'DISPERSIVITY',3X,'DISPERSIVITY',   INDAT1......106000
     6         3X,'DISPERSIVITY',3X,'DISPERSIVITY'/                      INDAT1......106100
     7         50X,'MAXIMUM PERMEABILITY',3X,' IN MAX-PERM',             INDAT1......106200
     8         3X,' IN MIN-PERM',3X,' IN MAX-PERM',3X,' IN MIN-PERM'/    INDAT1......106300
     9         58X,'(IN DEGREES)',3X,'   DIRECTION',3X,                  INDAT1......106400
     1         '   DIRECTION',3X,'   DIRECTION',3X,'   DIRECTION'/)      INDAT1......106500
         END IF                                                          INDAT1......106600
      END IF                                                             INDAT1......106700
      LRTEST=1                                                           INDAT1......106800
      DO 2550 LL=1,NE                                                    INDAT1......106900
      ERRCOD = 'REA-INP-15B'                                             INDAT1......107000
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 INDAT1......107100
      READ(INTFIL,*,IOSTAT=INERR(1)) L,LREG(L),PMAX,PMIN,ANGLEX,         INDAT1......107200
     1   ALMAX(L),ALMIN(L),ATMAX(L),ATMIN(L)                             INDAT1......107300
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT1......107400
      IF(LL.GT.1.AND.LREG(L).NE.LROLD) LRTEST=LRTEST+1                   INDAT1......107500
      LROLD=LREG(L)                                                      INDAT1......107600
      PMAX=PMAX*PMAXFA                                                   INDAT1......107700
      PMIN=PMIN*PMINFA                                                   INDAT1......107800
      ANGLEX=ANGLEX*ANGFAC                                               INDAT1......107900
      ALMAX(L)=ALMAX(L)*ALMAXF                                           INDAT1......108000
      ALMIN(L)=ALMIN(L)*ALMINF                                           INDAT1......108100
      ATMAX(L)=ATMAX(L)*ATMAXF                                           INDAT1......108200
      ATMIN(L)=ATMIN(L)*ATMINF                                           INDAT1......108300
      IF(KELMNT.EQ.+1.AND.IUNSAT.NE.1) WRITE(K3,2520) L,                 INDAT1......108400
     1   PMAX,PMIN,ANGLEX,ALMAX(L),ALMIN(L),ATMAX(L),ATMIN(L)            INDAT1......108500
 2520 FORMAT(9X,I9,2X,2(1PE14.5,2X),7X,5(G11.4,4X))                      INDAT1......108600
      IF(KELMNT.EQ.+1.AND.IUNSAT.EQ.1) WRITE(K3,2530) L,LREG(L),         INDAT1......108700
     1   PMAX,PMIN,ANGLEX,ALMAX(L),ALMIN(L),ATMAX(L),ATMIN(L)            INDAT1......108800
 2530 FORMAT(9X,I9,4X,I5,2X,2(1PE14.5,2X),7X,5(G11.4,4X))                INDAT1......108900
C                                                                        INDAT1......109000
C.....ROTATE PERMEABILITY FROM MAXIMUM/MINIMUM TO X/Y DIRECTIONS         INDAT1......109100
      RADIAX=1.745329D-2*ANGLEX                                          INDAT1......109200
      SINA=DSIN(RADIAX)                                                  INDAT1......109300
      COSA=DCOS(RADIAX)                                                  INDAT1......109400
      SINA2=SINA*SINA                                                    INDAT1......109500
      COSA2=COSA*COSA                                                    INDAT1......109600
      PERMXX(L)=PMAX*COSA2+PMIN*SINA2                                    INDAT1......109700
      PERMYY(L)=PMAX*SINA2+PMIN*COSA2                                    INDAT1......109800
      PERMXY(L)=(PMAX-PMIN)*SINA*COSA                                    INDAT1......109900
      PERMYX(L)=PERMXY(L)                                                INDAT1......110000
      PANGL1(L)=RADIAX                                                   INDAT1......110100
 2550 CONTINUE                                                           INDAT1......110200
      IF(KELMNT.EQ.0)                                                    INDAT1......110300
     1   WRITE(K3,2569) PMAXFA,PMINFA,ANGFAC,ALMAXF,ALMINF,ATMAXF,ATMINF INDAT1......110400
 2569 FORMAT(////11X,'E L E M E N T   I N F O R M A T I O N'//           INDAT1......110500
     1   16X,'PRINTOUT OF ELEMENT PERMEABILITIES AND DISPERSIVITIES ',   INDAT1......110600
     2   'CANCELLED.'//16X,'SCALE FACTORS :'/33X,1PE15.4,5X,'MAXIMUM ',  INDAT1......110700
     3   'PERMEABILITY FACTOR'/33X,1PE15.4,5X,'MINIMUM PERMEABILITY ',   INDAT1......110800
     4   'FACTOR'/33X,1PE15.4,5X,'ANGLE FROM +X TO MAXIMUM DIRECTION',   INDAT1......110900
     5   ' FACTOR'/33X,1PE15.4,5X,'FACTOR FOR LONGITUDINAL DISPERSIVITY' INDAT1......111000
     6  ,' IN MAX-PERM DIRECTION'/33X,1PE15.4,5X,                        INDAT1......111100
     7   'FACTOR FOR LONGITUDINAL DISPERSIVITY IN MIN-PERM DIRECTION',   INDAT1......111200
     8   /33X,1PE15.4,5X,'FACTOR FOR TRANSVERSE DISPERSIVITY',           INDAT1......111300
     9   ' IN MAX-PERM DIRECTION'/33X,1PE15.4,5X,                        INDAT1......111400
     *   'FACTOR FOR TRANSVERSE DISPERSIVITY IN MIN-PERM DIRECTION')     INDAT1......111500
      IF(IUNSAT.EQ.1.AND.KELMNT.EQ.0.AND.LRTEST.NE.1) WRITE(K3,2573)     INDAT1......111600
      IF(IUNSAT.EQ.1.AND.KELMNT.EQ.0.AND.LRTEST.EQ.1) WRITE(K3,2575)     INDAT1......111700
 2573 FORMAT(33X,'MORE THAN ONE REGION OF UNSATURATED PROPERTIES HAS ',  INDAT1......111800
     1   'BEEN SPECIFIED AMONG THE ELEMENTS.')                           INDAT1......111900
 2575 FORMAT(33X,'ONLY ONE REGION OF UNSATURATED PROPERTIES HAS ',       INDAT1......112000
     1   'BEEN SPECIFIED AMONG THE ELEMENTS.')                           INDAT1......112100
C                                                                        INDAT1......112200
      END IF                                                             INDAT1......112300
C                                                                        INDAT1......112400
      RETURN                                                             INDAT1......112500
      END                                                                INDAT1......112600
C                                                                        INDAT1......112700
C     SUBROUTINE        I  N  D  A  T  2           SUTRA VERSION 2.2     INDAT2.........100
C                                                                        INDAT2.........200
C *** PURPOSE :                                                          INDAT2.........300
C ***  TO READ INITIAL CONDITIONS FROM ICS FILE, AND TO                  INDAT2.........400
C ***  INITIALIZE DATA FOR EITHER WARM OR COLD START OF                  INDAT2.........500
C ***  THE SIMULATION.                                                   INDAT2.........600
C                                                                        INDAT2.........700
      SUBROUTINE INDAT2(PVEC,UVEC,PM1,UM1,UM2,CS1,CS2,CS3,SL,SR,RCIT,    INDAT2.........800
     1   SW,DSWDP,PBC,IPBC,IPBCT,NREG,QIN,DPDTITR,GNUP1,GNUU1,UIN,UBC,   INDAT2.........900
     2   QUIN,IBCPBC,IBCUBC,IBCSOP,IBCSOU,IIDPBC,IIDUBC,IIDSOP,IIDSOU,
     3   TPT)
C     2   QUIN,IBCPBC,IBCUBC,IBCSOP,IBCSOU,IIDPBC,IIDUBC,IIDSOP,IIDSOU)   INDAT2........1000
      USE ALLARR, ONLY : CIDBCS                                          INDAT2........1100
      USE EXPINT                                                         INDAT2........1200
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                INDAT2........1300
      CHARACTER*10 CPUNI,CUUNI                                           INDAT2........1400
      CHARACTER INTFIL*1000                                              INDAT2........1500
      CHARACTER*80 ERRCOD,CHERR(10),UNAME,FNAME(0:13)                    INDAT2........1600
      CHARACTER*8 VERNUM, VERNIN                                         INDAT2........1700
      INTEGER(1) IBCPBC(NBCN),IBCUBC(NBCN),IBCSOP(NSOP),IBCSOU(NSOU)     INDAT2........1800
      INTEGER IIDPBC(NBCN),IIDUBC(NBCN),IIDSOP(NSOP),IIDSOU(NSOU)        INDAT2........1900
      DIMENSION INERR(10),RLERR(10)                                      INDAT2........2000
      DIMENSION PVEC(NNVEC),UVEC(NNVEC),PM1(NN),UM1(NN),UM2(NN),SL(NN),  INDAT2........2100
     1   SR(NN),CS1(NN),CS2(NN),CS3(NN),RCIT(NN),SW(NN),DSWDP(NN),       INDAT2........2200
     2   PBC(NBCN),IPBC(NBCN),GNUP1(NBCN),GNUU1(NBCN),NREG(NN),QIN(NN),  INDAT2........2300
     3   DPDTITR(NN),UIN(NN),UBC(NBCN),QUIN(NN)                          INDAT2........2400
      DIMENSION TPT(NN)
      DIMENSION KTYPE(2)                                                 INDAT2........2500
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  INDAT2........2600
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           INDAT2........2700
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      INDAT2........2800
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              INDAT2........2900
     1   NSOP,NSOU,NBCN,NCIDB                                            INDAT2........3000
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA                           INDAT2........3100
      COMMON /FNAMES/ UNAME,FNAME                                        INDAT2........3200
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 INDAT2........3300
     1   K10,K11,K12,K13                                                 INDAT2........3400
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,      INDAT2........3500
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2        INDAT2........3600
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       INDAT2........3700
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      INDAT2........3800
      COMMON /VER/ VERNUM, VERNIN                                        INDAT2........3900
C                                                                        INDAT2........4000
C                                                                        INDAT2........4100
      IF(IREAD) 500,500,620                                              INDAT2........4200
C.....INPUT INITIAL CONDITIONS FOR WARM START                            INDAT2........4300
  500 ERRCOD = 'REA-ICS-1'                                               INDAT2........4400
      CALL READIF(K2, 0, INTFIL, ERRCOD)                                 INDAT2........4500
      IF ((VERNIN.EQ.'2.0').OR.(VERNIN.EQ.'2.1')) THEN                   INDAT2........4600
         READ(INTFIL,*,IOSTAT=INERR(1)) DUM,DELTP,DELTU                  INDAT2........4700
      ELSE                                                               INDAT2........4800
         READ(INTFIL,*,IOSTAT=INERR(1)) DUM,DELTP,DELTU,ITRST,DUM        INDAT2........4900
      END IF                                                             INDAT2........5000
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT2........5100
      IF (ITRST.GE.ITMAX) THEN                                           INDAT2........5200
         ERRCOD = 'ICS-1-1'                                              INDAT2........5300
         INERR(1) = ITRST                                                INDAT2........5400
         INERR(2) = ITMAX                                                INDAT2........5500
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT2........5600
      END IF                                                             INDAT2........5700
      ERRCOD = 'REA-ICS-2'                                               INDAT2........5800
      CALL READIF(K2, 0, INTFIL, ERRCOD)                                 INDAT2........5900
      READ(INTFIL,*,IOSTAT=INERR(1)) CPUNI                               INDAT2........6000
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT2........6100
      IF (CPUNI.NE.'NONUNIFORM') THEN                                    INDAT2........6200
         ERRCOD = 'ICS-2-2'                                              INDAT2........6300
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT2........6400
      END IF                                                             INDAT2........6500
      ERRCOD = 'REA-ICS-2'                                               INDAT2........6600
      CALL READIF(K2, 0, INTFIL, ERRCOD)                                 INDAT2........6700
      BACKSPACE(K2)                                                      INDAT2........6800
      READ(K2,*,IOSTAT=INERR(1)) (PVEC(I),I=1,NN)                        INDAT2........6900
      IF (INERR(1).NE.0) THEN                                            INDAT2........7000
         ERRCOD = 'REA-ICS-2'                                            INDAT2........7100
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT2........7200
      END IF                                                             INDAT2........7300
      ERRCOD = 'REA-ICS-3'                                               INDAT2........7400
      CALL READIF(K2, 0, INTFIL, ERRCOD)                                 INDAT2........7500
      READ(INTFIL,*,IOSTAT=INERR(1)) CUUNI                               INDAT2........7600
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT2........7700
      IF (CUUNI.NE.'NONUNIFORM') THEN                                    INDAT2........7800
         ERRCOD = 'ICS-3-2'                                              INDAT2........7900
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT2........8000
      END IF                                                             INDAT2........8100
      ERRCOD = 'REA-ICS-3'                                               INDAT2........8200
      CALL READIF(K2, 0, INTFIL, ERRCOD)                                 INDAT2........8300
      BACKSPACE(K2)                                                      INDAT2........8400
      READ(K2,*,IOSTAT=INERR(1)) (UVEC(I),I=1,NN)                        INDAT2........8500
      IF (INERR(1).NE.0) THEN                                            INDAT2........8600
         ERRCOD = 'REA-ICS-3'                                            INDAT2........8700
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT2........8800
      END IF                                                             INDAT2........8900
      ERRCOD = 'REA-ICS-4'                                               INDAT2........9000
      CALL READIF(K2, 0, INTFIL, ERRCOD)                                 INDAT2........9100
      BACKSPACE(K2)                                                      INDAT2........9200
      READ(K2,*,IOSTAT=INERR(1)) (PM1(I),I=1,NN)                         INDAT2........9300
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT2........9400
      READ(K2,*,IOSTAT=INERR(1)) (UM1(I),I=1,NN)                         INDAT2........9500
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT2........9600
      READ(K2,*,IOSTAT=INERR(1)) (CS1(I),I=1,NN)                         INDAT2........9700
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT2........9800
      READ(K2,*,IOSTAT=INERR(1)) (RCIT(I),I=1,NN)                        INDAT2........9900
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT2.......10000
      READ(K2,*,IOSTAT=INERR(1)) (SW(I),I=1,NN)                          INDAT2.......10100
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT2.......10200
      IF ((VERNIN.EQ.'2.0').OR.(VERNIN.EQ.'2.1')) THEN                   INDAT2.......10300
         READ(K2,*,IOSTAT=INERR(1)) (QIN(I),I=1,NN)                      INDAT2.......10400
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT2.......10500
         READ(K2,*,IOSTAT=INERR(1)) (PBC(IP),IP=1,NBCN)                  INDAT2.......10600
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT2.......10700
      ELSE                                                               INDAT2.......10800
         READ(K2,*,IOSTAT=INERR(1)) (QIN(I),I=1,NN)                      INDAT2.......10900
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT2.......11000
         READ(K2,*,IOSTAT=INERR(1)) (UIN(I),I=1,NN)                      INDAT2.......11100
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT2.......11200
         READ(K2,*,IOSTAT=INERR(1)) (IBCSOP(IQP),IQP=1,NSOP)             INDAT2.......11300
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT2.......11400
         READ(K2,*,IOSTAT=INERR(1)) (IIDSOP(IQP),IQP=1,NSOP)             INDAT2.......11500
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT2.......11600
         READ(K2,*,IOSTAT=INERR(1)) (QUIN(I),I=1,NN)                     INDAT2.......11700
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT2.......11800
         READ(K2,*,IOSTAT=INERR(1)) (IBCSOU(IQU),IQU=1,NSOU)             INDAT2.......11900
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT2.......12000
         READ(K2,*,IOSTAT=INERR(1)) (IIDSOU(IQU),IQU=1,NSOU)             INDAT2.......12100
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT2.......12200
         READ(K2,*,IOSTAT=INERR(1)) (PBC(IP),IP=1,NPBC)                  INDAT2.......12300
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT2.......12400
         READ(K2,*,IOSTAT=INERR(1)) (UBC(IP),IP=1,NPBC)                  INDAT2.......12500
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT2.......12600
         READ(K2,*,IOSTAT=INERR(1)) (IBCPBC(IP),IP=1,NPBC)               INDAT2.......12700
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT2.......12800
         READ(K2,*,IOSTAT=INERR(1)) (IIDPBC(IP),IP=1,NPBC)               INDAT2.......12900
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT2.......13000
         READ(K2,*,IOSTAT=INERR(1)) (UBC(IUP),IUP=1+NPBC,NUBC+NPBC)      INDAT2.......13100
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT2.......13200
         READ(K2,*,IOSTAT=INERR(1)) (IBCUBC(IUP),IUP=1+NPBC,NUBC+NPBC)   INDAT2.......13300
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT2.......13400
         READ(K2,*,IOSTAT=INERR(1)) (IIDUBC(IUP),IUP=1+NPBC,NUBC+NPBC)   INDAT2.......13500
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT2.......13600
         READ(K2,*,IOSTAT=INERR(1)) NCID                                 INDAT2.......13700
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     INDAT2.......13800
         NCIDB = MAX(NCIDB, NCID)                                        INDAT2.......13900
         IF (ALLOCATED(CIDBCS)) DEALLOCATE(CIDBCS)                       INDAT2.......14000
         ALLOCATE(CIDBCS(NCIDB))                                         INDAT2.......14100
         DO 510 NC=1,NCID                                                INDAT2.......14200
            READ(K2,'(A40)',IOSTAT=INERR(1)) CIDBCS(NC)                  INDAT2.......14300
            IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)  INDAT2.......14400
  510    CONTINUE                                                        INDAT2.......14500
      END IF                                                             INDAT2.......14600
      DO 520 IP=1,NPBC                                                   INDAT2.......14700
         IF (IBCPBC(IP).EQ.2) THEN                                       INDAT2.......14800
            GNUP1(IP) = 0D0                                              INDAT2.......14900
         ELSE                                                            INDAT2.......15000
            GNUP1(IP) = GNUP                                             INDAT2.......15100
         END IF                                                          INDAT2.......15200
  520 CONTINUE                                                           INDAT2.......15300
      DO 530 IUP=1+NPBC,NUBC+NPBC                                        INDAT2.......15400
         IF (IBCUBC(IUP).EQ.2) THEN                                      INDAT2.......15500
            GNUU1(IUP) = 0D0                                             INDAT2.......15600
         ELSE                                                            INDAT2.......15700
            GNUU1(IUP) = GNUU                                            INDAT2.......15800
         END IF                                                          INDAT2.......15900
  530 CONTINUE                                                           INDAT2.......16000
C     CALL ZERO(CS2,NN,0.0D0)                                            INDAT2.......16100
C     CALL ZERO(CS3,NN,0.0D0)                                            INDAT2.......16200
      CALL ZERO(SL,NN,0.0D0)                                             INDAT2.......16300
      CALL ZERO(SR,NN,0.0D0)                                             INDAT2.......16400
      CALL ZERO(DSWDP,NN,0.0D0)                                          INDAT2.......16500
      DO 550 I=1,NN                                                      INDAT2.......16600
  550 UM2(I)=UM1(I)                                                      INDAT2.......16700
      GOTO 1000                                                          INDAT2.......16800
C                                                                        INDAT2.......16900
C.....INPUT INITIAL CONDITIONS FOR COLD START                            INDAT2.......17000
  620 ERRCOD = 'REA-ICS-1'                                               INDAT2.......17100
      CALL READIF(K2, 0, INTFIL, ERRCOD)                                 INDAT2.......17200
      READ(INTFIL,*,IOSTAT=INERR(1)) DUM                                 INDAT2.......17300
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT2.......17400
      ITRST = 0                                                          INDAT2.......17500
      ERRCOD = 'REA-ICS-2'                                               INDAT2.......17600
      CALL READIF(K2, 0, INTFIL, ERRCOD)                                 INDAT2.......17700
      READ(INTFIL,*,IOSTAT=INERR(1)) CPUNI                               INDAT2.......17800
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT2.......17900
      IF (CPUNI.EQ.'UNIFORM') THEN                                       INDAT2.......18000
         ERRCOD = 'REA-ICS-2'                                            INDAT2.......18100
         CALL READIF(K2, 0, INTFIL, ERRCOD)                              INDAT2.......18200
         BACKSPACE(K2)                                                   INDAT2.......18300
         READ(K2,*,IOSTAT=INERR(1)) PUNI                                 INDAT2.......18400
         IF (INERR(1).NE.0) THEN                                         INDAT2.......18500
            ERRCOD = 'REA-ICS-2'                                         INDAT2.......18600
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     INDAT2.......18700
         END IF                                                          INDAT2.......18800
         DO 625 I=1,NN                                                   INDAT2.......18900
            PVEC(I) = PUNI                                               INDAT2.......19000
  625    CONTINUE                                                        INDAT2.......19100
      ELSE IF (CPUNI.EQ.'NONUNIFORM') THEN                               INDAT2.......19200
         ERRCOD = 'REA-ICS-2'                                            INDAT2.......19300
         CALL READIF(K2, 0, INTFIL, ERRCOD)                              INDAT2.......19400
         BACKSPACE(K2)                                                   INDAT2.......19500
         READ(K2,*,IOSTAT=INERR(1)) (PVEC(I),I=1,NN)                     INDAT2.......19600
         IF (INERR(1).NE.0) THEN                                         INDAT2.......19700
            ERRCOD = 'REA-ICS-2'                                         INDAT2.......19800
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     INDAT2.......19900
         END IF                                                          INDAT2.......20000
      ELSE                                                               INDAT2.......20100
         ERRCOD = 'ICS-2-1'                                              INDAT2.......20200
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT2.......20300
      END IF                                                             INDAT2.......20400
      ERRCOD = 'REA-ICS-3'                                               INDAT2.......20500
      CALL READIF(K2, 0, INTFIL, ERRCOD)                                 INDAT2.......20600
      READ(INTFIL,*,IOSTAT=INERR(1)) CUUNI                               INDAT2.......20700
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        INDAT2.......20800
      IF (CUUNI.EQ.'UNIFORM') THEN                                       INDAT2.......20900
         ERRCOD = 'REA-ICS-3'                                            INDAT2.......21000
         CALL READIF(K2, 0, INTFIL, ERRCOD)                              INDAT2.......21100
         BACKSPACE(K2)                                                   INDAT2.......21200
         READ(K2,*,IOSTAT=INERR(1)) UUNI                                 INDAT2.......21300
         IF (INERR(1).NE.0) THEN                                         INDAT2.......21400
            ERRCOD = 'REA-ICS-3'                                         INDAT2.......21500
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     INDAT2.......21600
         END IF                                                          INDAT2.......21700
         DO 630 I=1,NN                                                   INDAT2.......21800
            UVEC(I) = UUNI                                               INDAT2.......21900
  630    CONTINUE                                                        INDAT2.......22000
      ELSE IF (CUUNI.EQ.'NONUNIFORM') THEN                               INDAT2.......22100
         ERRCOD = 'REA-ICS-3'                                            INDAT2.......22200
         CALL READIF(K2, 0, INTFIL, ERRCOD)                              INDAT2.......22300
         BACKSPACE(K2)                                                   INDAT2.......22400
         READ(K2,*,IOSTAT=INERR(1)) (UVEC(I),I=1,NN)                     INDAT2.......22500
         IF (INERR(1).NE.0) THEN                                         INDAT2.......22600
            ERRCOD = 'REA-ICS-3'                                         INDAT2.......22700
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     INDAT2.......22800
         END IF                                                          INDAT2.......22900
      ELSE                                                               INDAT2.......23000
         ERRCOD = 'ICS-3-1'                                              INDAT2.......23100
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        INDAT2.......23200
      END IF                                                             INDAT2.......23300
C.....START TEMPERATURE INPUT........
      ERRCOD = 'REA-ICS-4' 
      CALL READIF(K2, 0, INTFIL, ERRCOD)                                
      READ(INTFIL,*,IOSTAT=INERR(1)) CUUNI                              
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)       
      IF (CUUNI.EQ.'UNIFORM') THEN                                      
         CALL READIF(K2, 0, INTFIL, ERRCOD)                             
         BACKSPACE(K2)                                                  
         READ(K2,*,IOSTAT=INERR(1)) TUNI                                
         IF (INERR(1).NE.0) THEN                                        
            ERRCOD = 'REA-ICS-3'                                        
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                    
         END IF                                                         
         DO 631 I=1,NN                                                  
            TPT(I) = TUNI                                              
 631     CONTINUE                                                       
      ELSE IF (CUUNI.EQ.'NONUNIFORM') THEN                              
         ERRCOD = 'REA-ICS-4'                                           
         CALL READIF(K2, 0, INTFIL, ERRCOD)                             
         BACKSPACE(K2)                                                  
         READ(K2,*,IOSTAT=INERR(1)) (TPT(I),I=1,NN)                    
         IF (INERR(1).NE.0) THEN                                        
            ERRCOD = 'REA-ICS-4'                                        
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                    
         END IF                                                         
      ELSE                                                              
         ERRCOD = 'ICS-3-4'                                             
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                       
      END IF                                                            
C.....START-UP WITH NO PROJECTIONS BY SETTING DELTP AND DELTU            INDAT2.......23400
C        SUCH THAT BDELP=BDELU=0.5D-16 IN PROJECTION FORMULAE FOUND      INDAT2.......23500
C        IN SUBROUTINE SUTRA.                                            INDAT2.......23600
      DELTP=DELT*1.D16                                                   INDAT2.......23700
      DELTU=DELT*1.D16                                                   INDAT2.......23800
C.....INITIALIZE SPECIFIED TIME-DEPENDENT PRESSURES TO INITIAL PRESSURE  INDAT2.......23900
C        VALUES FOR START-UP CALCULATION OF INFLOWS OR OUTFLOWS          INDAT2.......24000
C        (SET QPLITR=0)                                                  INDAT2.......24100
      IF(IPBCT) 680,740,740                                              INDAT2.......24200
  680 DO 730 IP=1,NPBC                                                   INDAT2.......24300
      I=IPBC(IP)                                                         INDAT2.......24400
      IF(I) 700,700,730                                                  INDAT2.......24500
  700 PBC(IP)=PVEC(-I)                                                   INDAT2.......24600
  730 CONTINUE                                                           INDAT2.......24700
C.....INITIALIZE P, U, AND CONSISTENT DENSITY                            INDAT2.......24800
  740 DO 800 I=1,NN                                                      INDAT2.......24900
      PM1(I)=PVEC(I)                                                     INDAT2.......25000
      UM1(I)=UVEC(I)                                                     INDAT2.......25100
      UM2(I)=UVEC(I)                                                     INDAT2.......25200
      RCIT(I)=RHOW0+DRWDU*(UVEC(I)-URHOW0)                               INDAT2.......25300
  800 CONTINUE                                                           INDAT2.......25400
C.....INITIALIZE SATURATION, SW(I)                                       INDAT2.......25500
      CALL ZERO(SW,NN,1.0D0)                                             INDAT2.......25600
      CALL ZERO(DSWDP,NN,0.0D0)                                          INDAT2.......25700
      IF(IUNSAT.NE.1) GOTO 990                                           INDAT2.......25800
      IUNSAT=3                                                           INDAT2.......25900
      DO 900 I=1,NN                                                      INDAT2.......26000
  900 IF(PVEC(I).LT.0) CALL UNSAT(SW(I),DSWDP(I),RELK,PVEC(I),NREG(I))   INDAT2.......26100
  990 CONTINUE                                                           INDAT2.......26200
      IF (ALLOCATED(CIDBCS)) DEALLOCATE(CIDBCS)                          INDAT2.......26300
      ALLOCATE(CIDBCS(NCIDB))                                            INDAT2.......26400
      CIDBCS(1) = 'N/A'                                                  INDAT2.......26500
      CALL ZERO(CS1,NN,CS)                                               INDAT2.......26600
C     CALL ZERO(CS2,NN,0.0D0)                                            INDAT2.......26700
C     CALL ZERO(CS3,NN,0.0D0)                                            INDAT2.......26800
      CALL ZERO(SL,NN,0.0D0)                                             INDAT2.......26900
      CALL ZERO(SR,NN,0.0D0)                                             INDAT2.......27000
      CALL ZERO(DPDTITR,NN,0.0D0)                                        INDAT2.......27100
 1000 CONTINUE                                                           INDAT2.......27200
C                                                                        INDAT2.......27300
C.....SET STARTING TIME OF SIMULATION CLOCK, TSEC.  NOTE THAT THE VALUE  INDAT2.......27400
C        OF TSTART WAS SET IN SUBROUTINE INDAT0, WHERE THE "TIME_STEPS"  INDAT2.......27500
C        SCHEDULE IS DEFINED.                                            INDAT2.......27600
      TSEC=TSTART                                                        INDAT2.......27700
C                                                                        INDAT2.......27800
C                                                                        INDAT2.......27900
      RETURN                                                             INDAT2.......28000
      END                                                                INDAT2.......28100
C                                                                        INDAT2.......28200
C     SUBROUTINE        L  L  D  2  A  R           SUTRA VERSION 2.2     LLD2AR.........100
C                                                                        LLD2AR.........200
C *** PURPOSE :                                                          LLD2AR.........300
C ***  TO LOAD A LINKED LIST OF DOUBLE-PRECISION PAIRS INTO TWO ARRAYS.  LLD2AR.........400
C                                                                        LLD2AR.........500
      SUBROUTINE LLD2AR(LSTLEN, DLIST, DARR1, DARR2)                     LLD2AR.........600
      USE LLDEF                                                          LLD2AR.........700
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                LLD2AR.........800
      TYPE (LLD), POINTER :: DEN, DLIST                                  LLD2AR.........900
      DIMENSION DARR1(*), DARR2(*)                                       LLD2AR........1000
C                                                                        LLD2AR........1100
      DEN => DLIST                                                       LLD2AR........1200
      DO 100 K=1,LSTLEN                                                  LLD2AR........1300
         DARR1(K) = DEN%DVALU1                                           LLD2AR........1400
         DARR2(K) = DEN%DVALU2                                           LLD2AR........1500
         DEN => DEN%NENT                                                 LLD2AR........1600
  100 CONTINUE                                                           LLD2AR........1700
C                                                                        LLD2AR........1800
      RETURN                                                             LLD2AR........1900
      END                                                                LLD2AR........2000
C                                                                        LLD2AR........2100
C                                                                        LLD2AR........2200
C     SUBROUTINE        L  L  D  I  N  S           SUTRA VERSION 2.2     LLDINS.........100
C                                                                        LLDINS.........200
C *** PURPOSE :                                                          LLDINS.........300
C ***  TO INSERT A PAIR OF DOUBLE-PRECISION VALUES INTO A LINKED         LLDINS.........400
C ***  LIST, IN ASCENDING ORDER BASED ON THE FIRST VALUE IN THE PAIR.    LLDINS.........500
C                                                                        LLDINS.........600
      SUBROUTINE LLDINS(LSTLEN, DLIST, DNUM1, DNUM2, DLAST)              LLDINS.........700
      USE LLDEF                                                          LLDINS.........800
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                LLDINS.........900
      TYPE (LLD), POINTER :: DEN, DENPV, DENNW, DLIST, DLAST             LLDINS........1000
C                                                                        LLDINS........1100
C.....IF LIST IS EMPTY, PLACE PAIR AT HEAD OF LIST, ELSE INSERT          LLDINS........1200
C        INTO LIST IN ASCENDING ORDER BASED ON FIRST VALUE               LLDINS........1300
      IF (LSTLEN.EQ.0) THEN                                              LLDINS........1400
C........PLACE AT HEAD                                                   LLDINS........1500
         DLIST%DVALU1 = DNUM1                                            LLDINS........1600
         DLIST%DVALU2 = DNUM2                                            LLDINS........1700
         DLAST => DLIST                                                  LLDINS........1800
      ELSE IF (DNUM1.GE.DLAST%DVALU1) THEN                               LLDINS........1900
C........APPEND TO TAIL                                                  LLDINS........2000
         ALLOCATE(DENNW)                                                 LLDINS........2100
         DENNW%DVALU1 = DNUM1                                            LLDINS........2200
         DENNW%DVALU2 = DNUM2                                            LLDINS........2300
         DLAST%NENT => DENNW                                             LLDINS........2400
         DLAST => DENNW                                                  LLDINS........2500
      ELSE                                                               LLDINS........2600
C........INSERT INTO LISTS                                               LLDINS........2700
         DEN => DLIST                                                    LLDINS........2800
         DO 770 K=1,LSTLEN                                               LLDINS........2900
            IF (DNUM1.LT.DEN%DVALU1) THEN                                LLDINS........3000
               ALLOCATE(DENNW)                                           LLDINS........3100
               DENNW%DVALU1 = DNUM1                                      LLDINS........3200
               DENNW%DVALU2 = DNUM2                                      LLDINS........3300
               DENNW%NENT => DEN                                         LLDINS........3400
               IF (K.EQ.1) THEN                                          LLDINS........3500
                  DLIST => DENNW                                         LLDINS........3600
               ELSE                                                      LLDINS........3700
                  DENPV%NENT => DENNW                                    LLDINS........3800
               END IF                                                    LLDINS........3900
               GOTO 780                                                  LLDINS........4000
            END IF                                                       LLDINS........4100
            DENPV => DEN                                                 LLDINS........4200
            DEN => DEN%NENT                                              LLDINS........4300
  770    CONTINUE                                                        LLDINS........4400
      END IF                                                             LLDINS........4500
C                                                                        LLDINS........4600
  780 LSTLEN = LSTLEN + 1                                                LLDINS........4700
      RETURN                                                             LLDINS........4800
      END                                                                LLDINS........4900
C                                                                        LLDINS........5000
C     SUBROUTINE        L  O  D  O  B  S           SUTRA VERSION 2.2     LODOBS.........100
C                                                                        LODOBS.........200
C *** PURPOSE :                                                          LODOBS.........300
C ***  TO LOAD OBSERVATION POINT INDICES NOBLIN AT A TIME, STARTING      LODOBS.........400
C ***  WITH INDEX JNEXT, INTO ARRAY JSET.  ONLY OBSERVATION POINTS       LODOBS.........500
C ***  WHOSE SCHEDULE AND OUTPUT FORMAT MATCH THOSE THAT CORRESPOND      LODOBS.........600
C ***  TO FILE INDEX NFLO ARE LOADED.  THE NUMBER OF OBSERVATIONS        LODOBS.........700
C ***  LOADED, JLOAD, CAN BE LESS THAN NOBLIN IF THE LIST OF             LODOBS.........800
C ***  OBSERVATION POINT INDICES IS EXHAUSTED.                           LODOBS.........900
C                                                                        LODOBS........1000
      SUBROUTINE LODOBS(NFLO,JNEXT,OBSPTS,JSET,JLOAD)                    LODOBS........1100
      USE ALLARR, ONLY : OBSDAT                                          LODOBS........1200
      USE SCHDEF                                                         LODOBS........1300
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                LODOBS........1400
      TYPE (OBSDAT), DIMENSION (NOBSN) :: OBSPTS                         LODOBS........1500
      DIMENSION JSET(*)                                                  LODOBS........1600
      COMMON /OBS/ NOBSN,NTOBS,NOBCYC,NOBLIN,NFLOMX                      LODOBS........1700
C                                                                        LODOBS........1800
      NOBS = NOBSN - 1                                                   LODOBS........1900
C                                                                        LODOBS........2000
      JLOAD = 0                                                          LODOBS........2100
      DO 300 J=JNEXT,NOBS                                                LODOBS........2200
         IF ((OBSPTS(J)%FRMT.EQ."OBS").AND.                              LODOBS........2300
     1      (OBSPTS(J)%SCHED.EQ.SCHDLS(OFP(NFLO)%ISCHED)%NAME))          LODOBS........2400
     2      THEN                                                         LODOBS........2500
            JLOAD = JLOAD + 1                                            LODOBS........2600
            JSET(JLOAD) = J                                              LODOBS........2700
            IF ((JLOAD.EQ.NOBLIN).OR.(J.EQ.NOBS)) THEN                   LODOBS........2800
               JNEXT = J + 1                                             LODOBS........2900
               RETURN                                                    LODOBS........3000
            END IF                                                       LODOBS........3100
         END IF                                                          LODOBS........3200
  300 CONTINUE                                                           LODOBS........3300
C                                                                        LODOBS........3400
      JNEXT = NOBS + 1                                                   LODOBS........3500
      RETURN                                                             LODOBS........3600
      END                                                                LODOBS........3700
C                                                                        LODOBS........3800
C     SUBROUTINE        N  A  F  U                 SUTRA VERSION 2.2     NAFU...........100
C                                                                        NAFU...........200
C *** PURPOSE :                                                          NAFU...........300
C ***  TO FIND THE NEXT AVAILABLE FORTRAN UNIT.  ON INPUT, IUNEXT IS     NAFU...........400
C ***  THE UNIT NUMBER FROM WHICH THE SEARCH IS TO BEGIN.  ON OUTPUT,    NAFU...........500
C ***  IUNEXT IS THE NEXT AVAILABLE UNIT NUMBER.                         NAFU...........600
C                                                                        NAFU...........700
      SUBROUTINE NAFU(IUNEXT,NJMAX,FN)                                   NAFU...........800
      USE SCHDEF, ONLY : IUNIO                                           NAFU...........900
      USE BCSDEF                                                         NAFU..........1000
      USE FINDEF                                                         NAFU..........1100
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                NAFU..........1200
      CHARACTER*80 FN,UNAME,FNAME(0:13)                                  NAFU..........1300
      CHARACTER*80 ERRCOD,CHERR(10)                                      NAFU..........1400
      LOGICAL EXST                                                       NAFU..........1500
      LOGICAL ALCBCS,ALCFIN,ALCOBS                                       NAFU..........1600
      DIMENSION INERR(10),RLERR(10)                                      NAFU..........1700
      DIMENSION IUNIT(0:13)                                              NAFU..........1800
      COMMON /ALC/ ALCBCS,ALCFIN,ALCOBS                                  NAFU..........1900
      COMMON /FNAMES/ UNAME,FNAME                                        NAFU..........2000
      COMMON /FUNIB/ NFBCS                                               NAFU..........2100
      COMMON /FUNITA/ IUNIT                                              NAFU..........2200
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 NAFU..........2300
     1   K10,K11,K12,K13                                                 NAFU..........2400
C                                                                        NAFU..........2500
C.....CHECK "SUTRA.FIL" (UNIT K0)                                        NAFU..........2600
  100 IF (IUNEXT.EQ.K0) IUNEXT = IUNEXT + 1                              NAFU..........2700
C.....CHECK NON-INSERTED, NON-OBSERVATION FILES                          NAFU..........2800
  200 DO 300 NFF=0,13                                                    NAFU..........2900
         IF ((NFF.EQ.7).OR.(NFF.EQ.8)) CYCLE                             NAFU..........3000
         IF (IUNEXT.EQ.IUNIT(NFF)) THEN                                  NAFU..........3100
            IUNEXT = IUNEXT + 1                                          NAFU..........3200
            GOTO 100                                                     NAFU..........3300
         END IF                                                          NAFU..........3400
  300 CONTINUE                                                           NAFU..........3500
      IF (ALCBCS) THEN                                                   NAFU..........3600
         DO 350 NFB=1,NFBCS                                              NAFU..........3700
            IF (IUNEXT.EQ.IUNIB(NFB)) THEN                               NAFU..........3800
               IUNEXT = IUNEXT + 1                                       NAFU..........3900
               GOTO 100                                                  NAFU..........4000
            END IF                                                       NAFU..........4100
  350    CONTINUE                                                        NAFU..........4200
      END IF                                                             NAFU..........4300
C.....CHECK OBSERVATION FILES                                            NAFU..........4400
      IF (ALCOBS) THEN                                                   NAFU..........4500
  400    DO 500 NJ=1,NJMAX                                               NAFU..........4600
            IF (IUNEXT.EQ.IUNIO(NJ)) THEN                                NAFU..........4700
               IUNEXT = IUNEXT + 1                                       NAFU..........4800
               GOTO 100                                                  NAFU..........4900
            END IF                                                       NAFU..........5000
  500    CONTINUE                                                        NAFU..........5100
      END IF                                                             NAFU..........5200
C.....CHECK INSERTED FILES                                               NAFU..........5300
      IF ((IUNEXT.EQ.K1).OR.(IUNEXT.EQ.K2).OR.(IUNEXT.EQ.K9)) THEN       NAFU..........5400
         IUNEXT = IUNEXT + 1                                             NAFU..........5500
         GOTO 100                                                        NAFU..........5600
      END IF                                                             NAFU..........5700
      IF (ALCFIN) THEN                                                   NAFU..........5800
         DO 600 I=1,2+NFBCS                                              NAFU..........5900
            DO 600 K=1,NKS(I)                                            NAFU..........6000
               IF (IUNEXT.EQ.KLIST(I,K)) THEN                            NAFU..........6100
                  IUNEXT = IUNEXT + 1                                    NAFU..........6200
                  GOTO 100                                               NAFU..........6300
               END IF                                                    NAFU..........6400
  600    CONTINUE                                                        NAFU..........6500
      END IF                                                             NAFU..........6600
C.....IF THE UNIT NUMBER SELECTED IS NOT VALID, GENERATE ERROR           NAFU..........6700
      INQUIRE(UNIT=IUNEXT, EXIST=EXST)                                   NAFU..........6800
      IF (.NOT.EXST) THEN                                                NAFU..........6900
         ERRCOD = 'FIL-10'                                               NAFU..........7000
         INERR(1) = IUNEXT                                               NAFU..........7100
         CHERR(1) = UNAME                                                NAFU..........7200
         CHERR(2) = FN                                                   NAFU..........7300
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        NAFU..........7400
      END IF                                                             NAFU..........7500
C                                                                        NAFU..........7600
      RETURN                                                             NAFU..........7700
      END                                                                NAFU..........7800
C                                                                        NAFU..........7900
C     SUBROUTINE        N  O  D  A  L              SUTRA VERSION 2.2     NODAL..........100
C                                                                        NODAL..........200
C *** PURPOSE :                                                          NODAL..........300
C ***  (1) TO CARRY OUT ALL CELLWISE CALCULATIONS AND TO ADD CELLWISE    NODAL..........400
C ***      TERMS TO THE GLOBAL MATRIX AND GLOBAL VECTOR FOR BOTH FLOW    NODAL..........500
C ***      AND TRANSPORT EQUATIONS.                                      NODAL..........600
C ***  (2) TO ADD FLUID SOURCE AND SOLUTE MASS OR ENERGY SOURCE TERMS    NODAL..........700
C ***      TO THE MATRIX EQUATIONS.                                      NODAL..........800
C                                                                        NODAL..........900
      SUBROUTINE NODAL(ML,VOL,PMAT,PVEC,UMAT,UVEC,PITER,UITER,PM1,UM1,   NODAL.........1000
     1   UM2,POR,QIN,UIN,QUIN,QINITR,CS1,CS2,CS3,SL,SR,SW,DSWDP,RHO,SOP, NODAL.........1100
     1   NREG,JA)                                                        NODAL.........1200
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                NODAL.........1300
      DIMENSION VOL(NN),PMAT(NELT,NCBI),PVEC(NNVEC),UMAT(NELT,NCBI),     NODAL.........1400
     1   UVEC(NNVEC)                                                     NODAL.........1500
      DIMENSION PITER(NN),UITER(NN),PM1(NN),UM1(NN),UM2(NN),             NODAL.........1600
     1   POR(NN),QIN(NN),UIN(NN),QUIN(NN),QINITR(NN),                    NODAL.........1700
     2   CS1(NN),CS2(NN),CS3(NN),SL(NN),SR(NN),SW(NN),RHO(NN),DSWDP(NN), NODAL.........1800
     3   SOP(NN),NREG(NN)                                                NODAL.........1900
      DIMENSION JA(NDIMJA)                                               NODAL.........2000
      DIMENSION KTYPE(2)                                                 NODAL.........2100
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  NODAL.........2200
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           NODAL.........2300
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      NODAL.........2400
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              NODAL.........2500
     1   NSOP,NSOU,NBCN,NCIDB                                            NODAL.........2600
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        NODAL.........2700
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA                           NODAL.........2800
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,      NODAL.........2900
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2        NODAL.........3000
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                           NODAL.........3100
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       NODAL.........3200
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      NODAL.........3300
C                                                                        NODAL.........3400
C                                                                        NODAL.........3500
      IF(IUNSAT.NE.0) IUNSAT=1                                           NODAL.........3600
C                                                                        NODAL.........3700
C.....SET UP MATRIX STRUCTURE INFORMATION                                NODAL.........3800
      IF (KSOLVP.EQ.0) THEN                                              NODAL.........3900
         JMID = NBHALF                                                   NODAL.........4000
      ELSE                                                               NODAL.........4100
         JMID = 1                                                        NODAL.........4200
      END IF                                                             NODAL.........4300
C                                                                        NODAL.........4400
C.....DO NOT UPDATE NODAL PARAMETERS ON A TIME STEP WHEN ONLY U IS       NODAL.........4500
C        SOLVED FOR BY BACK SUBSTITUTION (I.E., WHEN NOUMAT=1)           NODAL.........4600
      IF(NOUMAT) 50,50,200                                               NODAL.........4700
C.....SET UNSATURATED FLOW PARAMETERS AT NODES, SW(I) AND DSWDP(I)       NODAL.........4800
   50 DO 120 I=1,NN                                                      NODAL.........4900
      IF(IUNSAT-1) 120,100,120                                           NODAL.........5000
  100 IF(PITER(I)) 110,115,115                                           NODAL.........5100
  110 CALL UNSAT(SW(I),DSWDP(I),RELK,PITER(I),NREG(I))                   NODAL.........5200
      GOTO 120                                                           NODAL.........5300
  115 SW(I)=1.0D0                                                        NODAL.........5400
      DSWDP(I)=0.0D0                                                     NODAL.........5500
  120 CONTINUE                                                           NODAL.........5600
C.....SET FLUID DENSITY AT NODES, RHO(I)                                 NODAL.........5700
C        RHO = F (UITER(I))                                              NODAL.........5800
      DO 150 I=1,NN                                                      NODAL.........5900
  150 RHO(I)=RHOW0+DRWDU*(UITER(I)-URHOW0)                               NODAL.........6000
  200 CONTINUE                                                           NODAL.........6100
C                                                                        NODAL.........6200
      DO 1000 I=1,NN                                                     NODAL.........6300
      IF (KSOLVP.EQ.0) THEN                                              NODAL.........6400
         IMID = I                                                        NODAL.........6500
      ELSE                                                               NODAL.........6600
         IMID = JA(I)                                                    NODAL.........6700
      END IF                                                             NODAL.........6800
C                                                                        NODAL.........6900
      SWRHON=SW(I)*RHO(I)                                                NODAL.........7000
C                                                                        NODAL.........7100
      IF(ML-1) 220,220,230                                               NODAL.........7200
C                                                                        NODAL.........7300
C.....CALCULATE CELLWISE TERMS FOR P EQUATION.                           NODAL.........7400
C.....FOR STEADY-STATE FLOW, ISSFLO=2; FOR TRANSIENT FLOW, ISSFLO=0.     NODAL.........7500
  220 AFLN=(1-ISSFLO/2)*                                                 NODAL.........7600
     1   (SWRHON*SOP(I)+POR(I)*RHO(I)*DSWDP(I))*VOL(I)/DELTP             NODAL.........7700
      CFLN=POR(I)*SW(I)*DRWDU*VOL(I)                                     NODAL.........7800
      DUDT=(1-ISSFLO/2)*(UM1(I)-UM2(I))/DLTUM1                           NODAL.........7900
      CFLN=CFLN*DUDT                                                     NODAL.........8000
C.....ADD CELLWISE TERMS AND FLUID SOURCES OR FLUXES TO P EQUATION       NODAL.........8100
      PMAT(IMID,JMID) = PMAT(IMID,JMID) + AFLN                           NODAL.........8200
      PVEC(I) = PVEC(I) - CFLN + AFLN*PM1(I) + QIN(I)                    NODAL.........8300
C                                                                        NODAL.........8400
      IF(ML-1) 230,1000,230                                              NODAL.........8500
C                                                                        NODAL.........8600
C.....CALCULATE CELLWISE TERMS FOR U-EQUATION                            NODAL.........8700
  230 EPRS=(1.D0-POR(I))*RHOS                                            NODAL.........8800
      ATRN=(1-ISSTRA)*(POR(I)*SWRHON*CW+EPRS*CS1(I))*VOL(I)/DELTU        NODAL.........8900
      GTRN=POR(I)*SWRHON*PRODF1*VOL(I)                                   NODAL.........9000
      GSV=EPRS*PRODS1*VOL(I)                                             NODAL.........9100
      GSLTRN=GSV*SL(I)                                                   NODAL.........9200
      GSRTRN=GSV*SR(I)                                                   NODAL.........9300
      ETRN=(POR(I)*SWRHON*PRODF0+EPRS*PRODS0)*VOL(I)                     NODAL.........9400
C.....CALCULATE SOURCES OF SOLUTE OR ENERGY CONTAINED IN                 NODAL.........9500
C        SOURCES OF FLUID (ZERO CONTRIBUTION FOR OUTFLOWING FLUID)       NODAL.........9600
      QUR=0.0D0                                                          NODAL.........9700
      QUL=0.0D0                                                          NODAL.........9800
C      IF(QINITR(I)) 360,360,340                                          NODAL.........9900
      IF(QINITR(I)) 340,360,340 
  340 QUL=-CW*QINITR(I)                                                  NODAL........10000
      QUR=-QUL*UIN(I)                                                    NODAL........10100
C.....ADD CELLWISE TERMS, SOURCES OF SOLUTE OR ENERGY IN FLUID INFLOWS,  NODAL........10200
C        AND PURE SOURCES OR FLUXES OF SOLUTE OR ENERGY TO U-EQUATION    NODAL........10300
  360 IF(NOUMAT) 370,370,380                                             NODAL........10400
  370 UMAT(IMID,JMID) = UMAT(IMID,JMID) + ATRN - GTRN - GSLTRN - QUL     NODAL........10500
  380 UVEC(I) = UVEC(I) + ATRN*UM1(I) + ETRN + GSRTRN + QUR + QUIN(I)    NODAL........10600
C                                                                        NODAL........10700
 1000 CONTINUE                                                           NODAL........10800
C                                                                        NODAL........10900
      RETURN                                                             NODAL........11000
      END                                                                NODAL........11100
C                                                                        NODAL........11200
C     SUBROUTINE        O  U  T  B  C  O  F        SUTRA VERSION 2.2     OUTBCOF........100
C                                                                        OUTBCOF........200
C *** PURPOSE :                                                          OUTBCOF........300
C ***  TO PRINT BOUNDARY CONDITION INFORMATION AT FLUID SOURCE/SINK      OUTBCOF........400
C ***  NODES IN A FLEXIBLE, COLUMNWISE FORMAT.  OUTPUT IS TO THE         OUTBCOF........500
C ***  BCOF FILE.                                                        OUTBCOF........600
C                                                                        OUTBCOF........700
      SUBROUTINE OUTBCOF(QIN,IQSOP,UVEC,UIN,QINITR,IBCSOP,TITLE1,TITLE2, OUTBCOF........800
     1   IIDSOP,X,Y,Z,DFR,PWFR,PCFR)
C     1   IIDSOP)                                                         OUTBCOF........900

      USE ALLARR, ONLY : CIDBCS                                          OUTBCOF.......1000
      USE EXPINT                                                         OUTBCOF.......1100
      USE SCHDEF                                                         OUTBCOF.......1200
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                OUTBCOF.......1300
      PARAMETER (NCOLMX=9)                                               OUTBCOF.......1400
      CHARACTER*1  TITLE1(80),TITLE2(80)                                 OUTBCOF.......1500
      CHARACTER*14 CTYPE2                                                OUTBCOF.......1600
      CHARACTER*80 LAYSTR                                                OUTBCOF.......1700
      CHARACTER*10 BCDSTR(-1:2)                                          OUTBCOF.......1800
      CHARACTER*40 NOTAPP                                                OUTBCOF.......1900
      LOGICAL ONCEK10,ONCEK11,ONCEK12,ONCEK13                            OUTBCOF.......2000
      INTEGER(1) IBCSOP(NSOP)                                            OUTBCOF.......2100
      INTEGER IIDSOP(NSOP)                                               OUTBCOF.......2200
      DIMENSION QIN(NN),IQSOP(NSOP),UVEC(NNVEC),UIN(NN),QINITR(NN)       OUTBCOF.......2300
      DIMENSION KTYPE(2)                                                 OUTBCOF.......2400
      DIMENSION J5COL(NCOLMX), J6COL(NCOLMX)                             OUTBCOF.......2500
      DIMENSION X(NN),Y(NN),Z(NN),DFR(NSOP),PWFR(NSOP),PCFR(NSOP)
      ALLOCATABLE TT(:),ITT(:)                                           OUTBCOF.......2600
      TYPE (LLD), POINTER :: DENTS                                       OUTBCOF.......2700
      COMMON /CLAY/ LAYSTR                                               OUTBCOF.......2800
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  OUTBCOF.......2900
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           OUTBCOF.......3000
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      OUTBCOF.......3100
      COMMON /DIMLAY/ NLAYS,NNLAY,NELAY                                  OUTBCOF.......3200
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              OUTBCOF.......3300
     1   NSOP,NSOU,NBCN,NCIDB                                            OUTBCOF.......3400
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        OUTBCOF.......3500
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA                           OUTBCOF.......3600
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 OUTBCOF.......3700
     1   K10,K11,K12,K13                                                 OUTBCOF.......3800
      COMMON /GRAVEC/ GRAVX,GRAVY,GRAVZ                                  OUTBCOF.......3900
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS      OUTBCOF.......4000
      COMMON /JCOLS/ NCOLPR,LCOLPR,NCOLS5,NCOLS6,J5COL,J6COL             OUTBCOF.......4100
      COMMON /KPRBCS/ KINACT                                             OUTBCOF.......4200
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                OUTBCOF.......4300
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            OUTBCOF.......4400
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,      OUTBCOF.......4500
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2        OUTBCOF.......4600
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /PLT2/ ONCEK10, ONCEK11, ONCEK12, ONCEK13                   OUTBCOF.......4700
      COMMON /SCH/ NSCH,ISCHTS,NSCHAU                                    OUTBCOF.......4800
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                           OUTBCOF.......4900
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       OUTBCOF.......5000
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      OUTBCOF.......5100
      DATA (BCDSTR(M),M=-1,2)                                            OUTBCOF.......5200
     1   /'    BCTIME','       INP','       BCS','       BCS'/           OUTBCOF.......5300
      DATA NOTAPP /"                                     N/A"/           OUTBCOF.......5400
      SAVE BCDSTR                                                        OUTBCOF.......5500
C                                                                        OUTBCOF.......5600
C.....CALCULATE HEADERS ON FIRST CALL AND CREATE OUTPUT ON EACH CALL.    OUTBCOF.......5700
C                                                                        OUTBCOF.......5800
C                                                                        OUTBCOF.......5900
      IF (.NOT. ONCEK10)  THEN                                           OUTBCOF.......6000
C.....FIRST CALL -- CREATE FILE HEADER.                                  OUTBCOF.......6100
C                                                                        OUTBCOF.......6200
C........CALCULATE THE MAXIMUM NUMBER OF TIME STEPS, KTMAX.              OUTBCOF.......6300
         KT=0                                                            OUTBCOF.......6400
         DO 4 JT=1,ITMAX                                                 OUTBCOF.......6500
            IF (MOD(JT,NBCFPR).EQ.0 .OR.                                 OUTBCOF.......6600
     1         ((JT.EQ.ITRST+1).AND.((ISSTRA.NE.0).OR.(NBCFPR.GT.0))))   OUTBCOF.......6700
     2         KT = KT + 1                                               OUTBCOF.......6800
    4    CONTINUE                                                        OUTBCOF.......6900
         IF(ITMAX.GT.1 .AND. MOD(ITMAX,NBCFPR).NE.0) KT = KT + 1         OUTBCOF.......7000
         KTMAX = KT                                                      OUTBCOF.......7100
C                                                                        OUTBCOF.......7200
C........ALLOCATE LOCAL ARRAYS                                           OUTBCOF.......7300
         ALLOCATE(TT(KTMAX),ITT(KTMAX))                                  OUTBCOF.......7400
C                                                                        OUTBCOF.......7500
C........CALCULATE AND PRINT TIME STEP INFORMATION                       OUTBCOF.......7600
         TS=TSTART                                                       OUTBCOF.......7700
C........TIME STEP VALUE                                                 OUTBCOF.......7800
         JT=0                                                            OUTBCOF.......7900
C........NUMBER OF PRINTED TIME STEPS                                    OUTBCOF.......8000
         KT=0                                                            OUTBCOF.......8100
C........TIME STEP INCREMENT                                             OUTBCOF.......8200
         DELTK=DELT                                                      OUTBCOF.......8300
         DENTS => SCHDLS(ISCHTS)%SLIST                                   OUTBCOF.......8400
         DO 10 JT=1,ITMAX                                                OUTBCOF.......8500
            DENTS => DENTS%NENT                                          OUTBCOF.......8600
            TS = DENTS%DVALU1                                            OUTBCOF.......8700
            IF (MOD(JT,NBCFPR).EQ.0 .OR.                                 OUTBCOF.......8800
     1         ((JT.EQ.ITRST+1).AND.((ISSTRA.NE.0).OR.(NBCFPR.GT.0))))   OUTBCOF.......8900
     2         THEN                                                      OUTBCOF.......9000
               KT = KT + 1                                               OUTBCOF.......9100
               TT(KT) = TS                                               OUTBCOF.......9200
               ITT(KT) = JT                                              OUTBCOF.......9300
            ENDIF                                                        OUTBCOF.......9400
   10    CONTINUE                                                        OUTBCOF.......9500
         IF (ISSTRA.EQ.1) THEN                                           OUTBCOF.......9600
            TT(KT) = TSTART                                              OUTBCOF.......9700
            ITT(KT) = 0                                                  OUTBCOF.......9800
         END IF                                                          OUTBCOF.......9900
C                                                                        OUTBCOF......10000
C                                                                        OUTBCOF......10100
C........PRINT LAST TIME STEP ALWAYS, UNLESS ALREADY PRINTED             OUTBCOF......10200
         IF(ITMAX.GT.1 .AND. MOD(ITMAX,NBCFPR).NE.0) THEN                OUTBCOF......10300
            KT = KT + 1                                                  OUTBCOF......10400
            TT(KT) = TS                                                  OUTBCOF......10500
            ITT(KT) = ITMAX                                              OUTBCOF......10600
         ENDIF                                                           OUTBCOF......10700
C                                                                        OUTBCOF......10800
C........COMPUTE ACTUAL NUMBER OF PRINTED TIME STEPS, KTPRN; LESS THAN   OUTBCOF......10900
C           KTMAX IF RUN IS A RESTART                                    OUTBCOF......11000
         IF (IREAD.EQ.+1) THEN                                           OUTBCOF......11100
            KTPRN = KTMAX                                                OUTBCOF......11200
         ELSE                                                            OUTBCOF......11300
            KTPRN = 0                                                    OUTBCOF......11400
            DO 17 KT=1,KTMAX                                             OUTBCOF......11500
               IF (ITT(KT).GT.ITRST) KTPRN = KTPRN + 1                   OUTBCOF......11600
   17       CONTINUE                                                     OUTBCOF......11700
         END IF                                                          OUTBCOF......11800
C                                                                        OUTBCOF......11900
C........WRITE HEADER INFORMATION                                        OUTBCOF......12000
         WRITE(K10,950) TITLE1, TITLE2                                   OUTBCOF......12100
         IF (KTYPE(2).GT.1) THEN                                         OUTBCOF......12200
            IF (KTYPE(2).EQ.3) THEN                                      OUTBCOF......12300
               CTYPE2 = "BLOCKWISE MESH"                                 OUTBCOF......12400
            ELSE                                                         OUTBCOF......12500
               CTYPE2 = "REGULAR MESH  "                                 OUTBCOF......12600
            END IF                                                       OUTBCOF......12700
            IF (KTYPE(1).EQ.3) THEN                                      OUTBCOF......12800
               WRITE(K10,951) KTYPE(1),CTYPE2,NN1,NN2,NN3,NN," Nodes",   OUTBCOF......12900
     1            NE, " Elems"                                           OUTBCOF......13000
            ELSE                                                         OUTBCOF......13100
               WRITE(K10,952) KTYPE(1),CTYPE2,NN1,NN2,NN," Nodes",       OUTBCOF......13200
     1            NE, " Elems"                                           OUTBCOF......13300
            END IF                                                       OUTBCOF......13400
         ELSE IF (KTYPE(2).EQ.1) THEN                                    OUTBCOF......13500
            WRITE(K10,953) KTYPE(1), LAYSTR(1:6), NLAYS, NNLAY,          OUTBCOF......13600
     1         NN, " Nodes", NE, " Elems"                                OUTBCOF......13700
         ELSE                                                            OUTBCOF......13800
            WRITE(K10,954) KTYPE(1), NN, " Nodes", NE, " Elems"          OUTBCOF......13900
         END IF                                                          OUTBCOF......14000
         WRITE(K10,960) "FLUID SOURCE/SINK NODE RESULTS", KTPRN          OUTBCOF......14100
         DO 920 KT=1,KTMAX                                               OUTBCOF......14200
            IF ((ITT(KT).GT.ITRST).OR.(ISSFLO.NE.0))                     OUTBCOF......14300
     1         WRITE(K10,961) ITT(KT), TT(KT)                            OUTBCOF......14400
  920    CONTINUE                                                        OUTBCOF......14500
  950    FORMAT("## ", 80A1,                                             OUTBCOF......14600
     1         /"## ", 80A1,                                             OUTBCOF......14700
     2         /"## ")                                                   OUTBCOF......14800
  951    FORMAT("## ", I1, "-D, ", A, 2X,                                OUTBCOF......14900
     1                 "(", 2(I9, ")*("), I9, ") = ", I9, A, 1X,         OUTBCOF......15000
     2                 "(", I9, A, ")"                                   OUTBCOF......15100
     3         /"## ")                                                   OUTBCOF......15200
  952    FORMAT("## ", I1, "-D, ", A, 14X,                               OUTBCOF......15300
     1                 "(", I9, ")*(", I9, ") = ", I9, A, 1X,            OUTBCOF......15400
     2                 "(", I9, A, ")"                                   OUTBCOF......15500
     3         /"## ")                                                   OUTBCOF......15600
  953    FORMAT("## ", I1, "-D, LAYERED MESH [", A6, "]", 7X,            OUTBCOF......15700
     1                 "(", I9, ")*(", I9, ") = ", I9, A, 1X,            OUTBCOF......15800
     2                 "(", I9, A, ")"                                   OUTBCOF......15900
     3         /"## ")                                                   OUTBCOF......16000
  954    FORMAT("## ", I1, "-D, IRREGULAR MESH", 40X, I9, A, 1X,         OUTBCOF......16100
     1                 "(", I9, A, ")"                                   OUTBCOF......16200
     2         /"## ")                                                   OUTBCOF......16300
  960    FORMAT("## ", 92("="),                                          OUTBCOF......16400
     1         /"## ", A, 34X, I9, " Time steps printed",                OUTBCOF......16500
     2         /"## ", 92("="),                                          OUTBCOF......16600
     3         /"## ",                                                   OUTBCOF......16700
     4         /"## ", 4X, "Time steps"                                  OUTBCOF......16800
     5         /"## ", 3X, "in this file      Time (sec)"                OUTBCOF......16900
     6         /"## ", 2X, 14("-"), 3X, 13("-"))                         OUTBCOF......17000
  961    FORMAT ("## ", 7X, I8, 4X, 1PE13.6)                             OUTBCOF......17100
C                                                                        OUTBCOF......17200
C........DEALLOCATE LOCAL ARRAYS.                                        OUTBCOF......17300
         DEALLOCATE(TT,ITT)                                              OUTBCOF......17400
C                                                                        OUTBCOF......17500
         ONCEK10 = .TRUE.                                                OUTBCOF......17600
      ENDIF                                                              OUTBCOF......17700
C                                                                        OUTBCOF......17800
C.....NODEWISE HEADER INFORMATION REPEATED BEFORE EACH TIME STEP         OUTBCOF......17900
      IF ((IT.EQ.0).OR.((IT.EQ.1).AND.(ISSTRA.EQ.1))) THEN               OUTBCOF......18000
         DURN = 0D0                                                      OUTBCOF......18100
         TOUT = TSTART                                                   OUTBCOF......18200
         ITOUT = 0                                                       OUTBCOF......18300
      ELSE                                                               OUTBCOF......18400
         DURN = DELT                                                     OUTBCOF......18500
         TOUT = TSEC                                                     OUTBCOF......18600
         ITOUT = IT                                                      OUTBCOF......18700
      END IF                                                             OUTBCOF......18800
      WRITE(K10,966) ITOUT, DURN, TOUT                                   OUTBCOF......18900
  966 FORMAT('## ',                                                      OUTBCOF......19000
     1      /'## ', 131('='),                                            OUTBCOF......19100
     2      /'## TIME STEP ', I8, 61X, 'Duration: ', 1PE11.4, ' sec',    OUTBCOF......19200
     3                            6X, 'Time: ', 1PE11.4, ' sec',         OUTBCOF......19300
     4      /'## ', 131('='))                                            OUTBCOF......19400
      IF (ME .GT. 0) THEN                                                OUTBCOF......19500
         WRITE(K10,967)                                                  OUTBCOF......19600
      ELSE                                                               OUTBCOF......19700
         WRITE(K10,968)                                                  OUTBCOF......19800
      END IF                                                             OUTBCOF......19900
  967 FORMAT(                                                            OUTBCOF......20000
     1    '## ',76X,'Specified',9X,'Temperature of',14X,'Resultant'      OUTBCOF......20100
     2   /'## ',66X,'source/sink(+/-) of',6X,'fluid source/sink',        OUTBCOF......20200
     3           4X,'source/sink(+/-) of'                                OUTBCOF......20300
     4   /'##   Node    Defined in',28X,'BCS identifier',                OUTBCOF......20400
     5           7X,'fluid (mass/sec)',14X,'(degrees)',                  OUTBCOF......20500
     6           4X,'energy (energy/sec)')                               OUTBCOF......20600
  968 FORMAT(                                                            OUTBCOF......20700
     1    '## ',76X,'Specified',9X,'Solute conc of',14X,'Resultant'      OUTBCOF......20800
     2   /'## ',66X,'source/sink(+/-) of',6X,'fluid source/sink',        OUTBCOF......20900
     3           4X,'source/sink(+/-) of'                                OUTBCOF......21000
     4   /'##   Node    Defined in',28X,'BCS identifier',                OUTBCOF......21100
     5           7X,'fluid (mass/sec)',5X,'(sol mass/fl mass)',          OUTBCOF......21200
     6           6X,'solute (mass/sec)',9X,'  PD',9X,'  PW',9X,'  PC')
C     6           6X,'solute (mass/sec)')                                 OUTBCOF......21300
C                                                                        OUTBCOF......21400
C.....BOUNDARY CONDITION INFORMATION FOR THIS TIME STEP                  OUTBCOF......21500
      NSOPI=NSOP-1                                                       OUTBCOF......21600
      IF (NSOPI.GT.0) THEN                                               OUTBCOF......21700
      DO 990 IQP=1,NSOPI                                                 OUTBCOF......21800
      I=IABS(IQSOP(IQP))                                                 OUTBCOF......21900
C      IF (QINITR(I).LE.0D0) THEN                                         OUTBCOF......22000
C         UU = UVEC(I)                                                    OUTBCOF......22100
C         UUCUT = CUTSML(UU)                                              OUTBCOF......22200
C      ELSE                                                               OUTBCOF......22300
         UU = UIN(I)                                                     OUTBCOF......22400
         UUCUT = UU                                                      OUTBCOF......22500
C      END IF                                                             OUTBCOF......22600
      QU=QINITR(I)*CW*UU                                                 OUTBCOF......22700
      IBC = IBCSOP(IQP)                                                  OUTBCOF......22800
      IF (IBC.NE.2) THEN                                                 OUTBCOF......22900
         IF (IBC.GT.0) THEN                                              OUTBCOF......23000
            WRITE(K10,980) I,                                            OUTBCOF......23100
     1         BCDSTR(IBC),ADJUSTR(CIDBCS(IIDSOP(IQP))),                 OUTBCOF......23200
     2         QIN(I),UUCUT,CUTSML(QU)                                   OUTBCOF......23300
         ELSE                                                            OUTBCOF......23400
            WRITE(K10,980) I,BCDSTR(IBC),NOTAPP,QIN(I),UUCUT,CUTSML(QU)  OUTBCOF......23500
     1       ,DFR(IQP),PWFR(IQP),PCFR(IQP)
         END IF                                                          OUTBCOF......23600
C  980    FORMAT(I9,4X,A10,2X,A40,3(8X,1PE15.7))                          OUTBCOF......23700
  980    FORMAT(I9,4X,A10,2X,A40,3(8X,1PE15.7),3(2X,1PE11.4))   
      ELSE IF (KINACT.EQ.1) THEN                                         OUTBCOF......23800
         WRITE(K10,982) I,                                               OUTBCOF......23900
     1      BCDSTR(IBC),ADJUSTR(CIDBCS(IIDSOP(IQP))),                    OUTBCOF......24000
     2      "INACTIVE","INACTIVE","INACTIVE"                             OUTBCOF......24100
  982    FORMAT(I9,4X,A10,2X,A40,3(15X,A8))                              OUTBCOF......24200
      END IF                                                             OUTBCOF......24300
  990 CONTINUE                                                           OUTBCOF......24400
      END IF                                                             OUTBCOF......24500
C                                                                        OUTBCOF......24600
      RETURN                                                             OUTBCOF......24700
C                                                                        OUTBCOF......24800
      END                                                                OUTBCOF......24900
C                                                                        OUTBCOF......25000
C     SUBROUTINE        O  U  T  B  C  O  P        SUTRA VERSION 2.2     OUTBCOP........100
C                                                                        OUTBCOP........200
C *** PURPOSE :                                                          OUTBCOP........300
C ***  TO PRINT BOUNDARY CONDITION INFORMATION AT SPECIFIED PRESSURE     OUTBCOP........400
C ***  NODES IN A FLEXIBLE, COLUMNWISE FORMAT.  OUTPUT IS TO THE         OUTBCOP........500
C ***  BCOP FILE.                                                        OUTBCOP........600
C                                                                        OUTBCOP........700
      SUBROUTINE OUTBCOP(PVEC,UVEC,PBC,UBC,QPLITR,GNUP1,IPBC,IBCPBC,     OUTBCOP........800
     1   TITLE1,TITLE2,IIDPBC,X,Y,Z)
C     1   TITLE1,TITLE2,IIDPBC)                                           OUTBCOP........900
      USE ALLARR, ONLY : CIDBCS                                          OUTBCOP.......1000
      USE EXPINT                                                         OUTBCOP.......1100
      USE SCHDEF                                                         OUTBCOP.......1200
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                OUTBCOP.......1300
      PARAMETER (NCOLMX=9)                                               OUTBCOP.......1400
      CHARACTER*1  TITLE1(80),TITLE2(80)                                 OUTBCOP.......1500
      CHARACTER*14 CTYPE2                                                OUTBCOP.......1600
      CHARACTER*80 LAYSTR                                                OUTBCOP.......1700
      CHARACTER*10 BCDSTR(-1:2)                                          OUTBCOP.......1800
      CHARACTER*40 NOTAPP                                                OUTBCOP.......1900
      LOGICAL ONCEK10,ONCEK11,ONCEK12,ONCEK13                            OUTBCOP.......2000
      INTEGER(1) IBCPBC(NBCN)                                            OUTBCOP.......2100
      INTEGER IIDPBC(NBCN)                                               OUTBCOP.......2200
      DIMENSION PVEC(NNVEC),UVEC(NNVEC),PBC(NBCN),UBC(NBCN)              OUTBCOP.......2300
      DIMENSION QPLITR(NBCN),GNUP1(NBCN)                                 OUTBCOP.......2400
      DIMENSION IPBC(NBCN)                                               OUTBCOP.......2500
      DIMENSION KTYPE(2)                                                 OUTBCOP.......2600
      DIMENSION J5COL(NCOLMX), J6COL(NCOLMX)                             OUTBCOP.......2700
      DIMENSION X(NN),Y(NN),Z(NN)
      ALLOCATABLE TT(:),ITT(:)                                           OUTBCOP.......2800
      TYPE (LLD), POINTER :: DENTS                                       OUTBCOP.......2900
      COMMON /CLAY/ LAYSTR                                               OUTBCOP.......3000
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  OUTBCOP.......3100
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           OUTBCOP.......3200
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      OUTBCOP.......3300
      COMMON /DIMLAY/ NLAYS,NNLAY,NELAY                                  OUTBCOP.......3400
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              OUTBCOP.......3500
     1   NSOP,NSOU,NBCN,NCIDB                                            OUTBCOP.......3600
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        OUTBCOP.......3700
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA                           OUTBCOP.......3800
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 OUTBCOP.......3900
     1   K10,K11,K12,K13                                                 OUTBCOP.......4000
      COMMON /GRAVEC/ GRAVX,GRAVY,GRAVZ                                  OUTBCOP.......4100
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS      OUTBCOP.......4200
      COMMON /JCOLS/ NCOLPR,LCOLPR,NCOLS5,NCOLS6,J5COL,J6COL             OUTBCOP.......4300
      COMMON /KPRBCS/ KINACT                                             OUTBCOP.......4400
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                OUTBCOP.......4500
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            OUTBCOP.......4600
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,      OUTBCOP.......4700
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2        OUTBCOP.......4800
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /PLT2/ ONCEK10, ONCEK11, ONCEK12, ONCEK13                   OUTBCOP.......4900
      COMMON /SCH/ NSCH,ISCHTS,NSCHAU                                    OUTBCOP.......5000
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                           OUTBCOP.......5100
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       OUTBCOP.......5200
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      OUTBCOP.......5300
      DATA (BCDSTR(M),M=-1,2)                                            OUTBCOP.......5400
     1   /'    BCTIME','       INP','       BCS','       BCS'/           OUTBCOP.......5500
      DATA NOTAPP /"                                     N/A"/           OUTBCOP.......5600
      SAVE BCDSTR                                                        OUTBCOP.......5700
C                                                                        OUTBCOP.......5800
C.....CALCULATE HEADERS ON FIRST CALL AND CREATE OUTPUT ON EACH CALL.    OUTBCOP.......5900
C                                                                        OUTBCOP.......6000
C                                                                        OUTBCOP.......6100
      IF (.NOT. ONCEK12)  THEN                                           OUTBCOP.......6200
C.....FIRST CALL -- CREATE FILE HEADER.                                  OUTBCOP.......6300
C                                                                        OUTBCOP.......6400
C........CALCULATE THE MAXIMUM NUMBER OF TIME STEPS, KTMAX.              OUTBCOP.......6500
         KT=0                                                            OUTBCOP.......6600
         DO 4 JT=1,ITMAX                                                 OUTBCOP.......6700
            IF (MOD(JT,NBCPPR).EQ.0 .OR.                                 OUTBCOP.......6800
     1         ((JT.EQ.ITRST+1).AND.((ISSTRA.NE.0).OR.(NBCPPR.GT.0))))   OUTBCOP.......6900
     2         KT = KT + 1                                               OUTBCOP.......7000
    4    CONTINUE                                                        OUTBCOP.......7100
         IF(ITMAX.GT.1 .AND. MOD(ITMAX,NBCPPR).NE.0) KT = KT + 1         OUTBCOP.......7200
         KTMAX = KT                                                      OUTBCOP.......7300
C                                                                        OUTBCOP.......7400
C........ALLOCATE LOCAL ARRAYS                                           OUTBCOP.......7500
         ALLOCATE(TT(KTMAX),ITT(KTMAX))                                  OUTBCOP.......7600
C                                                                        OUTBCOP.......7700
C........CALCULATE AND PRINT TIME STEP INFORMATION                       OUTBCOP.......7800
         TS=TSTART                                                       OUTBCOP.......7900
C........TIME STEP VALUE                                                 OUTBCOP.......8000
         JT=0                                                            OUTBCOP.......8100
C........NUMBER OF PRINTED TIME STEPS                                    OUTBCOP.......8200
         KT=0                                                            OUTBCOP.......8300
C........TIME STEP INCREMENT                                             OUTBCOP.......8400
         DELTK=DELT                                                      OUTBCOP.......8500
         DENTS => SCHDLS(ISCHTS)%SLIST                                   OUTBCOP.......8600
         DO 10 JT=1,ITMAX                                                OUTBCOP.......8700
            DENTS => DENTS%NENT                                          OUTBCOP.......8800
            TS = DENTS%DVALU1                                            OUTBCOP.......8900
            IF (MOD(JT,NBCPPR).EQ.0 .OR.                                 OUTBCOP.......9000
     1         ((JT.EQ.ITRST+1).AND.((ISSTRA.NE.0).OR.(NBCPPR.GT.0))))   OUTBCOP.......9100
     2         THEN                                                      OUTBCOP.......9200
               KT = KT + 1                                               OUTBCOP.......9300
               TT(KT) = TS                                               OUTBCOP.......9400
               ITT(KT) = JT                                              OUTBCOP.......9500
            ENDIF                                                        OUTBCOP.......9600
   10    CONTINUE                                                        OUTBCOP.......9700
         IF (ISSTRA.EQ.1) THEN                                           OUTBCOP.......9800
            TT(KT) = TSTART                                              OUTBCOP.......9900
            ITT(KT) = 0                                                  OUTBCOP......10000
         END IF                                                          OUTBCOP......10100
C                                                                        OUTBCOP......10200
C                                                                        OUTBCOP......10300
C........PRINT LAST TIME STEP ALWAYS, UNLESS ALREADY PRINTED             OUTBCOP......10400
         IF(ITMAX.GT.1 .AND. MOD(ITMAX,NBCPPR).NE.0) THEN                OUTBCOP......10500
            KT = KT + 1                                                  OUTBCOP......10600
            TT(KT) = TS                                                  OUTBCOP......10700
            ITT(KT) = ITMAX                                              OUTBCOP......10800
         ENDIF                                                           OUTBCOP......10900
C                                                                        OUTBCOP......11000
C........COMPUTE ACTUAL NUMBER OF PRINTED TIME STEPS, KTPRN; LESS THAN   OUTBCOP......11100
C           KTMAX IF RUN IS A RESTART                                    OUTBCOP......11200
         IF (IREAD.EQ.+1) THEN                                           OUTBCOP......11300
            KTPRN = KTMAX                                                OUTBCOP......11400
         ELSE                                                            OUTBCOP......11500
            KTPRN = 0                                                    OUTBCOP......11600
            DO 17 KT=1,KTMAX                                             OUTBCOP......11700
               IF (ITT(KT).GT.ITRST) KTPRN = KTPRN + 1                   OUTBCOP......11800
   17       CONTINUE                                                     OUTBCOP......11900
         END IF                                                          OUTBCOP......12000
C                                                                        OUTBCOP......12100
C........WRITE HEADER INFORMATION                                        OUTBCOP......12200
         WRITE(K12,950) TITLE1, TITLE2                                   OUTBCOP......12300
         IF (KTYPE(2).GT.1) THEN                                         OUTBCOP......12400
            IF (KTYPE(2).EQ.3) THEN                                      OUTBCOP......12500
               CTYPE2 = "BLOCKWISE MESH"                                 OUTBCOP......12600
            ELSE                                                         OUTBCOP......12700
               CTYPE2 = "REGULAR MESH  "                                 OUTBCOP......12800
            END IF                                                       OUTBCOP......12900
            IF (KTYPE(1).EQ.3) THEN                                      OUTBCOP......13000
               WRITE(K12,951) KTYPE(1),CTYPE2,NN1,NN2,NN3,NN," Nodes",   OUTBCOP......13100
     1            NE, " Elems"                                           OUTBCOP......13200
            ELSE                                                         OUTBCOP......13300
               WRITE(K12,952) KTYPE(1),CTYPE2,NN1,NN2,NN," Nodes",       OUTBCOP......13400
     1            NE, " Elems"                                           OUTBCOP......13500
            END IF                                                       OUTBCOP......13600
         ELSE IF (KTYPE(2).EQ.1) THEN                                    OUTBCOP......13700
            WRITE(K12,953) KTYPE(1), LAYSTR(1:6), NLAYS, NNLAY,          OUTBCOP......13800
     1         NN, " Nodes", NE, " Elems"                                OUTBCOP......13900
         ELSE                                                            OUTBCOP......14000
            WRITE(K12,954) KTYPE(1), NN, " Nodes", NE, " Elems"          OUTBCOP......14100
         END IF                                                          OUTBCOP......14200
         WRITE(K12,960) "SPECIFIED-PRESSURE NODE RESULTS", KTPRN         OUTBCOP......14300
         DO 920 KT=1,KTMAX                                               OUTBCOP......14400
            IF ((ITT(KT).GT.ITRST).OR.(ISSFLO.NE.0))                     OUTBCOP......14500
     1         WRITE(K12,961) ITT(KT), TT(KT)                            OUTBCOP......14600
  920    CONTINUE                                                        OUTBCOP......14700
  950    FORMAT("## ", 80A1,                                             OUTBCOP......14800
     1         /"## ", 80A1,                                             OUTBCOP......14900
     2         /"## ")                                                   OUTBCOP......15000
  951    FORMAT("## ", I1, "-D, ", A, 2X,                                OUTBCOP......15100
     1                 "(", 2(I9, ")*("), I9, ") = ", I9, A, 1X,         OUTBCOP......15200
     2                 "(", I9, A, ")"                                   OUTBCOP......15300
     3         /"## ")                                                   OUTBCOP......15400
  952    FORMAT("## ", I1, "-D, ", A, 14X,                               OUTBCOP......15500
     1                 "(", I9, ")*(", I9, ") = ", I9, A, 1X,            OUTBCOP......15600
     2                 "(", I9, A, ")"                                   OUTBCOP......15700
     3         /"## ")                                                   OUTBCOP......15800
  953    FORMAT("## ", I1, "-D, LAYERED MESH [", A6, "]", 7X,            OUTBCOP......15900
     1                 "(", I9, ")*(", I9, ") = ", I9, A, 1X,            OUTBCOP......16000
     2                 "(", I9, A, ")"                                   OUTBCOP......16100
     3         /"## ")                                                   OUTBCOP......16200
  954    FORMAT("## ", I1, "-D, IRREGULAR MESH", 40X, I9, A, 1X,         OUTBCOP......16300
     1                 "(", I9, A, ")"                                   OUTBCOP......16400
     2         /"## ")                                                   OUTBCOP......16500
  960    FORMAT("## ", 92("="),                                          OUTBCOP......16600
     1         /"## ", A, 33X, I9, " Time steps printed",                OUTBCOP......16700
     2         /"## ", 92("="),                                          OUTBCOP......16800
     3         /"## ",                                                   OUTBCOP......16900
     4         /"## ", 4X, "Time steps"                                  OUTBCOP......17000
     5         /"## ", 3X, "in this file      Time (sec)"                OUTBCOP......17100
     6         /"## ", 2X, 14("-"), 3X, 13("-"))                         OUTBCOP......17200
  961    FORMAT ("## ", 7X, I8, 4X, 1PE13.6)                             OUTBCOP......17300
C                                                                        OUTBCOP......17400
C........DEALLOCATE LOCAL ARRAYS.                                        OUTBCOP......17500
         DEALLOCATE(TT,ITT)                                              OUTBCOP......17600
C                                                                        OUTBCOP......17700
         ONCEK12 = .TRUE.                                                OUTBCOP......17800
      ENDIF                                                              OUTBCOP......17900
C                                                                        OUTBCOP......18000
C.....NODEWISE HEADER INFORMATION REPEATED BEFORE EACH TIME STEP         OUTBCOP......18100
      IF ((IT.EQ.0).OR.((IT.EQ.1).AND.(ISSTRA.EQ.1))) THEN               OUTBCOP......18200
         DURN = 0D0                                                      OUTBCOP......18300
         TOUT = TSTART                                                   OUTBCOP......18400
         ITOUT = 0                                                       OUTBCOP......18500
      ELSE                                                               OUTBCOP......18600
         DURN = DELT                                                     OUTBCOP......18700
         TOUT = TSEC                                                     OUTBCOP......18800
         ITOUT = IT                                                      OUTBCOP......18900
      END IF                                                             OUTBCOP......19000
      WRITE(K12,966) ITOUT, DURN, TOUT                                   OUTBCOP......19100
  966 FORMAT('## ',                                                      OUTBCOP......19200
     1      /'## ', 177('='),                                            OUTBCOP......19300
     2      /'## TIME STEP ', I8, 107X, 'Duration: ', 1PE11.4, ' sec',   OUTBCOP......19400
     3                            6X, 'Time: ', 1PE11.4, ' sec',         OUTBCOP......19500
     4      /'## ', 177('='))                                            OUTBCOP......19600
      IF (ME .GT. 0) THEN                                                OUTBCOP......19700
         WRITE(K12,967)                                                  OUTBCOP......19800
      ELSE                                                               OUTBCOP......19900
         WRITE(K12,968)                                                  OUTBCOP......20000
      END IF                                                             OUTBCOP......20100
  967 FORMAT(                                                            OUTBCOP......20200
     1    '## ',76X,'Resultant',9X,'Temperature of',14X,'Resultant'      OUTBCOP......20300
     2   /'## ',66X,'source/sink(+/-) of',6X,'fluid source/sink',        OUTBCOP......20400
     3           4X,'source/sink(+/-) of'                                OUTBCOP......20500
     4   /'##   Node    Defined in',28X,'BCS identifier',                OUTBCOP......20600
     5           7X,'fluid (mass/sec)',14X,'(degrees)',                  OUTBCOP......20700
     6           4X,'energy (energy/sec)',6X,'Computed pressure',        OUTBCOP......20800
     7           5X,'Specified pressure')                                OUTBCOP......20900
  968 FORMAT(                                                            OUTBCOP......21000
     1    '## ',76X,'Resultant',9X,'Solute conc of',14X,'Resultant'      OUTBCOP......21100
     2   /'## ',66X,'source/sink(+/-) of',6X,'fluid source/sink',        OUTBCOP......21200
     3           4X,'source/sink(+/-) of'                                OUTBCOP......21300
     4   /'##   Node    Defined in',28X,'BCS identifier',                OUTBCOP......21400
     5           7X,'fluid (mass/sec)',5X,'(sol mass/fl mass)',          OUTBCOP......21500
     6           6X,'solute (mass/sec)',6X,'Computed pressure',          OUTBCOP......21600
     7         5X,'Specified pressure',9X,'X(M)',9X,'Y(M)',9X,'Z(M)')
C     7           5X,'Specified pressure')                                OUTBCOP......21700
C                                                                        OUTBCOP......21800
C.....BOUNDARY CONDITION INFORMATION FOR THIS TIME STEP                  OUTBCOP......21900
      IF (NPBC.GT.0) THEN                                                OUTBCOP......22000
      DO 990 IP=1,NPBC                                                   OUTBCOP......22100
      I=IABS(IPBC(IP))                                                   OUTBCOP......22200
      QPL = GNUP1(IP)*(PBC(IP)-PVEC(I))                                  OUTBCOP......22300
      IF (QPLITR(IP).LE.0D0) THEN                                        OUTBCOP......22400
         UU = UVEC(I)                                                    OUTBCOP......22500
         UUCUT = CUTSML(UU)                                              OUTBCOP......22600
      ELSE                                                               OUTBCOP......22700
         UU = UBC(IP)                                                    OUTBCOP......22800
         UUCUT = UU                                                      OUTBCOP......22900
      END IF                                                             OUTBCOP......23000
      QPU=QPLITR(IP)*CW*UU                                               OUTBCOP......23100
      IBC = IBCPBC(IP)                                                   OUTBCOP......23200
      IF (IBC.NE.2) THEN                                                 OUTBCOP......23300
         IF (IBC.GT.0) THEN                                              OUTBCOP......23400
            WRITE(K12,980) I,                                            OUTBCOP......23500
     1         BCDSTR(IBC),ADJUSTR(CIDBCS(IIDPBC(IP))),                  OUTBCOP......23600
     2         CUTSML(QPL),UUCUT,CUTSML(QPU),CUTSML(PVEC(I)),PBC(IP)     OUTBCOP......23700
         ELSE                                                            OUTBCOP......23800
            WRITE(K12,880) I,                                            OUTBCOP......23900
     1         BCDSTR(IBC),NOTAPP,                                       OUTBCOP......24000
     2         CUTSML(QPL),UUCUT,CUTSML(QPU),CUTSML(PVEC(I)),PBC(IP)     OUTBCOP......24100
     3             ,X(I),Y(I),Z(I)
         END IF                                                          OUTBCOP......24200
  980    FORMAT(I9,4X,A10,2X,A40,3(8X,1PE15.7),2(8X,1PE15.8))            OUTBCOP......24300
880   FORMAT(I9,4X,A10,2X,A40,3(8X,1PE15.7),2(8X,1PE15.8),3(2X,1PE11.4))
      ELSE IF (KINACT.EQ.1) THEN                                         OUTBCOP......24400
         WRITE(K12,982) I,                                               OUTBCOP......24500
     1      BCDSTR(IBC),ADJUSTR(CIDBCS(IIDPBC(IP))),                     OUTBCOP......24600
     2      "INACTIVE","INACTIVE","INACTIVE","INACTIVE","INACTIVE"       OUTBCOP......24700
  982    FORMAT(I9,4X,A10,2X,A40,5(15X,A8))                              OUTBCOP......24800
      END IF                                                             OUTBCOP......24900
  990 CONTINUE                                                           OUTBCOP......25000
      END IF                                                             OUTBCOP......25100
C                                                                        OUTBCOP......25200
      RETURN                                                             OUTBCOP......25300
C                                                                        OUTBCOP......25400
      END                                                                OUTBCOP......25500
C                                                                        OUTBCOP......25600
C     SUBROUTINE        O  U  T  B  C  O  S        SUTRA VERSION 2.2     OUTBCOS........100
C                                                                        OUTBCOS........200
C *** PURPOSE :                                                          OUTBCOS........300
C ***  TO PRINT BOUNDARY CONDITION INFORMATION AT SOLUTE/ENERGY          OUTBCOS........400
C ***  SOURCE/SINK NODES IN A FLEXIBLE, COLUMNWISE FORMAT.  OUTPUT IS    OUTBCOS........500
C ***  TO THE BCOS FILE.                                                 OUTBCOS........600
C                                                                        OUTBCOS........700
      SUBROUTINE OUTBCOS(QUIN,IQSOU,IBCSOU,TITLE1,TITLE2,IIDSOU)         OUTBCOS........800
      USE ALLARR, ONLY : CIDBCS                                          OUTBCOS........900
      USE EXPINT                                                         OUTBCOS.......1000
      USE SCHDEF                                                         OUTBCOS.......1100
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                OUTBCOS.......1200
      PARAMETER (NCOLMX=9)                                               OUTBCOS.......1300
      CHARACTER*1  TITLE1(80),TITLE2(80)                                 OUTBCOS.......1400
      CHARACTER*14 CTYPE2                                                OUTBCOS.......1500
      CHARACTER*80 LAYSTR                                                OUTBCOS.......1600
      CHARACTER*10 BCDSTR(-1:2)                                          OUTBCOS.......1700
      CHARACTER*40 NOTAPP                                                OUTBCOS.......1800
      LOGICAL ONCEK10,ONCEK11,ONCEK12,ONCEK13                            OUTBCOS.......1900
      INTEGER(1) IBCSOU(NSOU)                                            OUTBCOS.......2000
      INTEGER IIDSOU(NSOU)                                               OUTBCOS.......2100
      DIMENSION QUIN(NN),IQSOU(NSOU)                                     OUTBCOS.......2200
      DIMENSION KTYPE(2)                                                 OUTBCOS.......2300
      DIMENSION J5COL(NCOLMX), J6COL(NCOLMX)                             OUTBCOS.......2400
      ALLOCATABLE TT(:),ITT(:)                                           OUTBCOS.......2500
      TYPE (LLD), POINTER :: DENTS                                       OUTBCOS.......2600
      COMMON /CLAY/ LAYSTR                                               OUTBCOS.......2700
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  OUTBCOS.......2800
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           OUTBCOS.......2900
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      OUTBCOS.......3000
      COMMON /DIMLAY/ NLAYS,NNLAY,NELAY                                  OUTBCOS.......3100
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              OUTBCOS.......3200
     1   NSOP,NSOU,NBCN,NCIDB                                            OUTBCOS.......3300
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        OUTBCOS.......3400
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA                           OUTBCOS.......3500
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 OUTBCOS.......3600
     1   K10,K11,K12,K13                                                 OUTBCOS.......3700
      COMMON /GRAVEC/ GRAVX,GRAVY,GRAVZ                                  OUTBCOS.......3800
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS      OUTBCOS.......3900
      COMMON /JCOLS/ NCOLPR,LCOLPR,NCOLS5,NCOLS6,J5COL,J6COL             OUTBCOS.......4000
      COMMON /KPRBCS/ KINACT                                             OUTBCOS.......4100
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                OUTBCOS.......4200
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            OUTBCOS.......4300
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,      OUTBCOS.......4400
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2        OUTBCOS.......4500
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /PLT2/ ONCEK10, ONCEK11, ONCEK12, ONCEK13                   OUTBCOS.......4600
      COMMON /SCH/ NSCH,ISCHTS,NSCHAU                                    OUTBCOS.......4700
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                           OUTBCOS.......4800
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       OUTBCOS.......4900
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      OUTBCOS.......5000
      DATA (BCDSTR(M),M=-1,2)                                            OUTBCOS.......5100
     1   /'    BCTIME','       INP','       BCS','       BCS'/           OUTBCOS.......5200
      DATA NOTAPP /"                                     N/A"/           OUTBCOS.......5300
      SAVE BCDSTR                                                        OUTBCOS.......5400
C                                                                        OUTBCOS.......5500
C.....CALCULATE HEADERS ON FIRST CALL AND CREATE OUTPUT ON EACH CALL.    OUTBCOS.......5600
C                                                                        OUTBCOS.......5700
C                                                                        OUTBCOS.......5800
      IF (.NOT. ONCEK11)  THEN                                           OUTBCOS.......5900
C.....FIRST CALL -- CREATE FILE HEADER.                                  OUTBCOS.......6000
C                                                                        OUTBCOS.......6100
C........CALCULATE THE MAXIMUM NUMBER OF TIME STEPS, KTMAX.              OUTBCOS.......6200
         KT=0                                                            OUTBCOS.......6300
         DO 4 JT=1,ITMAX                                                 OUTBCOS.......6400
            IF (MOD(JT,NBCSPR).EQ.0 .OR.                                 OUTBCOS.......6500
     1         ((JT.EQ.ITRST+1).AND.((ISSTRA.NE.0).OR.(NBCSPR.GT.0))))   OUTBCOS.......6600
     2         KT = KT + 1                                               OUTBCOS.......6700
    4    CONTINUE                                                        OUTBCOS.......6800
         IF(ITMAX.GT.1 .AND. MOD(ITMAX,NBCSPR).NE.0) KT = KT + 1         OUTBCOS.......6900
         KTMAX = KT                                                      OUTBCOS.......7000
C                                                                        OUTBCOS.......7100
C........ALLOCATE LOCAL ARRAYS                                           OUTBCOS.......7200
         ALLOCATE(TT(KTMAX),ITT(KTMAX))                                  OUTBCOS.......7300
C                                                                        OUTBCOS.......7400
C........CALCULATE AND PRINT TIME STEP INFORMATION                       OUTBCOS.......7500
         TS=TSTART                                                       OUTBCOS.......7600
C........TIME STEP VALUE                                                 OUTBCOS.......7700
         JT=0                                                            OUTBCOS.......7800
C........NUMBER OF PRINTED TIME STEPS                                    OUTBCOS.......7900
         KT=0                                                            OUTBCOS.......8000
C........TIME STEP INCREMENT                                             OUTBCOS.......8100
         DELTK=DELT                                                      OUTBCOS.......8200
         DENTS => SCHDLS(ISCHTS)%SLIST                                   OUTBCOS.......8300
         DO 10 JT=1,ITMAX                                                OUTBCOS.......8400
            DENTS => DENTS%NENT                                          OUTBCOS.......8500
            TS = DENTS%DVALU1                                            OUTBCOS.......8600
            IF (MOD(JT,NBCSPR).EQ.0 .OR.                                 OUTBCOS.......8700
     1         ((JT.EQ.ITRST+1).AND.((ISSTRA.NE.0).OR.(NBCSPR.GT.0))))   OUTBCOS.......8800
     2         THEN                                                      OUTBCOS.......8900
               KT = KT + 1                                               OUTBCOS.......9000
               TT(KT) = TS                                               OUTBCOS.......9100
               ITT(KT) = JT                                              OUTBCOS.......9200
            ENDIF                                                        OUTBCOS.......9300
   10    CONTINUE                                                        OUTBCOS.......9400
         IF (ISSTRA.EQ.1) TT(KT) = TSTART                                OUTBCOS.......9500
C                                                                        OUTBCOS.......9600
C                                                                        OUTBCOS.......9700
C........PRINT LAST TIME STEP ALWAYS, UNLESS ALREADY PRINTED             OUTBCOS.......9800
         IF(ITMAX.GT.1 .AND. MOD(ITMAX,NBCSPR).NE.0) THEN                OUTBCOS.......9900
            KT = KT + 1                                                  OUTBCOS......10000
            TT(KT) = TS                                                  OUTBCOS......10100
            ITT(KT) = ITMAX                                              OUTBCOS......10200
         ENDIF                                                           OUTBCOS......10300
C                                                                        OUTBCOS......10400
C........COMPUTE ACTUAL NUMBER OF PRINTED TIME STEPS, KTPRN; LESS THAN   OUTBCOS......10500
C           KTMAX IF RUN IS A RESTART                                    OUTBCOS......10600
         IF (IREAD.EQ.+1) THEN                                           OUTBCOS......10700
            KTPRN = KTMAX                                                OUTBCOS......10800
         ELSE                                                            OUTBCOS......10900
            KTPRN = 0                                                    OUTBCOS......11000
            DO 17 KT=1,KTMAX                                             OUTBCOS......11100
               IF (ITT(KT).GT.ITRST) KTPRN = KTPRN + 1                   OUTBCOS......11200
   17       CONTINUE                                                     OUTBCOS......11300
         END IF                                                          OUTBCOS......11400
C                                                                        OUTBCOS......11500
C........WRITE HEADER INFORMATION                                        OUTBCOS......11600
         WRITE(K11,950) TITLE1, TITLE2                                   OUTBCOS......11700
         IF (KTYPE(2).GT.1) THEN                                         OUTBCOS......11800
            IF (KTYPE(2).EQ.3) THEN                                      OUTBCOS......11900
               CTYPE2 = "BLOCKWISE MESH"                                 OUTBCOS......12000
            ELSE                                                         OUTBCOS......12100
               CTYPE2 = "REGULAR MESH  "                                 OUTBCOS......12200
            END IF                                                       OUTBCOS......12300
            IF (KTYPE(1).EQ.3) THEN                                      OUTBCOS......12400
               WRITE(K11,951) KTYPE(1),CTYPE2,NN1,NN2,NN3,NN," Nodes",   OUTBCOS......12500
     1            NE, " Elems"                                           OUTBCOS......12600
            ELSE                                                         OUTBCOS......12700
               WRITE(K11,952) KTYPE(1),CTYPE2,NN1,NN2,NN," Nodes",       OUTBCOS......12800
     1            NE, " Elems"                                           OUTBCOS......12900
            END IF                                                       OUTBCOS......13000
         ELSE IF (KTYPE(2).EQ.1) THEN                                    OUTBCOS......13100
            WRITE(K11,953) KTYPE(1), LAYSTR(1:6), NLAYS, NNLAY,          OUTBCOS......13200
     1         NN, " Nodes", NE, " Elems"                                OUTBCOS......13300
         ELSE                                                            OUTBCOS......13400
            WRITE(K11,954) KTYPE(1), NN, " Nodes", NE, " Elems"          OUTBCOS......13500
         END IF                                                          OUTBCOS......13600
         IF (ME.GT.0) THEN                                               OUTBCOS......13700
            WRITE(K11,960) "ENERGY SOURCE/SINK NODE RESULTS", KTPRN      OUTBCOS......13800
         ELSE                                                            OUTBCOS......13900
            WRITE(K11,960) "SOLUTE SOURCE/SINK NODE RESULTS", KTPRN      OUTBCOS......14000
         END IF                                                          OUTBCOS......14100
         DO 920 KT=1,KTMAX                                               OUTBCOS......14200
            IF (ITT(KT).GT.ITRST)                                        OUTBCOS......14300
     1         WRITE(K11,961) ITT(KT), TT(KT)                            OUTBCOS......14400
  920    CONTINUE                                                        OUTBCOS......14500
  950    FORMAT("## ", 80A1,                                             OUTBCOS......14600
     1         /"## ", 80A1,                                             OUTBCOS......14700
     2         /"## ")                                                   OUTBCOS......14800
  951    FORMAT("## ", I1, "-D, ", A, 2X,                                OUTBCOS......14900
     1                 "(", 2(I9, ")*("), I9, ") = ", I9, A, 1X,         OUTBCOS......15000
     2                 "(", I9, A, ")"                                   OUTBCOS......15100
     3         /"## ")                                                   OUTBCOS......15200
  952    FORMAT("## ", I1, "-D, ", A, 14X,                               OUTBCOS......15300
     1                 "(", I9, ")*(", I9, ") = ", I9, A, 1X,            OUTBCOS......15400
     2                 "(", I9, A, ")"                                   OUTBCOS......15500
     3         /"## ")                                                   OUTBCOS......15600
  953    FORMAT("## ", I1, "-D, LAYERED MESH [", A6, "]", 7X,            OUTBCOS......15700
     1                 "(", I9, ")*(", I9, ") = ", I9, A, 1X,            OUTBCOS......15800
     2                 "(", I9, A, ")"                                   OUTBCOS......15900
     3         /"## ")                                                   OUTBCOS......16000
  954    FORMAT("## ", I1, "-D, IRREGULAR MESH", 40X, I9, A, 1X,         OUTBCOS......16100
     1                 "(", I9, A, ")"                                   OUTBCOS......16200
     2         /"## ")                                                   OUTBCOS......16300
  960    FORMAT("## ", 92("="),                                          OUTBCOS......16400
     1         /"## ", A, 33X, I9, " Time steps printed",                OUTBCOS......16500
     2         /"## ", 92("="),                                          OUTBCOS......16600
     3         /"## ",                                                   OUTBCOS......16700
     4         /"## ", 4X, "Time steps"                                  OUTBCOS......16800
     5         /"## ", 3X, "in this file      Time (sec)"                OUTBCOS......16900
     6         /"## ", 2X, 14("-"), 3X, 13("-"))                         OUTBCOS......17000
  961    FORMAT ("## ", 7X, I8, 4X, 1PE13.6)                             OUTBCOS......17100
C                                                                        OUTBCOS......17200
C........DEALLOCATE LOCAL ARRAYS.                                        OUTBCOS......17300
         DEALLOCATE(TT,ITT)                                              OUTBCOS......17400
C                                                                        OUTBCOS......17500
         ONCEK11 = .TRUE.                                                OUTBCOS......17600
      ENDIF                                                              OUTBCOS......17700
C                                                                        OUTBCOS......17800
C.....NODEWISE HEADER INFORMATION REPEATED BEFORE EACH TIME STEP         OUTBCOS......17900
      IF ((IT.EQ.1).AND.(ISSTRA.EQ.1)) THEN                              OUTBCOS......18000
         DURN = 0D0                                                      OUTBCOS......18100
         TOUT = TSTART                                                   OUTBCOS......18200
      ELSE                                                               OUTBCOS......18300
         DURN = DELT                                                     OUTBCOS......18400
         TOUT = TSEC                                                     OUTBCOS......18500
      END IF                                                             OUTBCOS......18600
      WRITE(K11,966) IT, DURN, TOUT                                      OUTBCOS......18700
  966 FORMAT('## ',                                                      OUTBCOS......18800
     1      /'## ', 92('='),                                             OUTBCOS......18900
     2      /'## TIME STEP ', I8, 22X, 'Duration: ', 1PE11.4, ' sec',    OUTBCOS......19000
     3                            6X, 'Time: ', 1PE11.4, ' sec',         OUTBCOS......19100
     4      /'## ', 92('='))                                             OUTBCOS......19200
      IF (ME .GT. 0) THEN                                                OUTBCOS......19300
         WRITE(K11,967)                                                  OUTBCOS......19400
      ELSE                                                               OUTBCOS......19500
         WRITE(K11,968)                                                  OUTBCOS......19600
      END IF                                                             OUTBCOS......19700
  967 FORMAT(                                                            OUTBCOS......19800
     1    '## ',76X,'Specified'                                          OUTBCOS......19900
     2   /'## ',66X,'source/sink(+/-) of'                                OUTBCOS......20000
     4   /'##   Node    Defined in',28X,'BCS identifier',                OUTBCOS......20100
     5           4X,'energy (energy/sec)')                               OUTBCOS......20200
  968 FORMAT(                                                            OUTBCOS......20300
     1    '## ',76X,'Specified'                                          OUTBCOS......20400
     2   /'## ',66X,'source/sink(+/-) of'                                OUTBCOS......20500
     4   /'##   Node    Defined in',28X,'BCS identifier',                OUTBCOS......20600
     5           6X,'solute (mass/sec)')                                 OUTBCOS......20700
C                                                                        OUTBCOS......20800
C.....BOUNDARY CONDITION INFORMATION FOR THIS TIME STEP                  OUTBCOS......20900
      NSOUI=NSOU-1                                                       OUTBCOS......21000
      IF (NSOUI.GT.0) THEN                                               OUTBCOS......21100
      DO 990 IQU=1,NSOUI                                                 OUTBCOS......21200
      I=IABS(IQSOU(IQU))                                                 OUTBCOS......21300
      IBC = IBCSOU(IQU)                                                  OUTBCOS......21400
      IF (IBC.NE.2) THEN                                                 OUTBCOS......21500
         IF (IBC.GT.0) THEN                                              OUTBCOS......21600
            WRITE(K11,980) I,                                            OUTBCOS......21700
     1         BCDSTR(IBC),ADJUSTR(CIDBCS(IIDSOU(IQU))),QUIN(I)          OUTBCOS......21800
         ELSE                                                            OUTBCOS......21900
            WRITE(K11,980) I,BCDSTR(IBC),NOTAPP,QUIN(I)                  OUTBCOS......22000
         END IF                                                          OUTBCOS......22100
  980    FORMAT(I9,4X,A10,2X,A40,8X,1PE15.7)                             OUTBCOS......22200
      ELSE IF (KINACT.EQ.1) THEN                                         OUTBCOS......22300
         WRITE(K11,982) I,                                               OUTBCOS......22400
     1      BCDSTR(IBC),ADJUSTR(CIDBCS(IIDSOU(IQU))),"INACTIVE"          OUTBCOS......22500
  982    FORMAT(I9,4X,A10,2X,A40,15X,A8)                                 OUTBCOS......22600
      END IF                                                             OUTBCOS......22700
  990 CONTINUE                                                           OUTBCOS......22800
      END IF                                                             OUTBCOS......22900
C                                                                        OUTBCOS......23000
      RETURN                                                             OUTBCOS......23100
C                                                                        OUTBCOS......23200
      END                                                                OUTBCOS......23300
C                                                                        OUTBCOS......23400
C     SUBROUTINE        O  U  T  B  C  O  U        SUTRA VERSION 2.2     OUTBCOU........100
C                                                                        OUTBCOU........200
C *** PURPOSE :                                                          OUTBCOU........300
C ***  TO PRINT BOUNDARY CONDITION INFORMATION AT SPECIFIED CONC/TEMP    OUTBCOU........400
C ***  NODES IN A FLEXIBLE, COLUMNWISE FORMAT.  OUTPUT IS TO THE         OUTBCOU........500
C ***  BCOU FILE.                                                        OUTBCOU........600
C                                                                        OUTBCOU........700
      SUBROUTINE OUTBCOU(UVEC,UBC,GNUU1,IUBC,IBCUBC,TITLE1,TITLE2,       OUTBCOU........800
     1   IIDUBC)                                                         OUTBCOU........900
      USE ALLARR, ONLY : CIDBCS                                          OUTBCOU.......1000
      USE EXPINT                                                         OUTBCOU.......1100
      USE SCHDEF                                                         OUTBCOU.......1200
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                OUTBCOU.......1300
      PARAMETER (NCOLMX=9)                                               OUTBCOU.......1400
      CHARACTER*1  TITLE1(80),TITLE2(80)                                 OUTBCOU.......1500
      CHARACTER*14 CTYPE2                                                OUTBCOU.......1600
      CHARACTER*80 LAYSTR                                                OUTBCOU.......1700
      CHARACTER*10 BCDSTR(-1:2)                                          OUTBCOU.......1800
      CHARACTER*40 NOTAPP                                                OUTBCOU.......1900
      LOGICAL ONCEK10,ONCEK11,ONCEK12,ONCEK13                            OUTBCOU.......2000
      INTEGER(1) IBCUBC(NBCN)                                            OUTBCOU.......2100
      INTEGER IIDUBC(NBCN)                                               OUTBCOU.......2200
      DIMENSION UVEC(NNVEC),UBC(NBCN),GNUU1(NBCN)                        OUTBCOU.......2300
      DIMENSION IUBC(NBCN)                                               OUTBCOU.......2400
      DIMENSION KTYPE(2)                                                 OUTBCOU.......2500
      DIMENSION J5COL(NCOLMX), J6COL(NCOLMX)                             OUTBCOU.......2600
      ALLOCATABLE TT(:),ITT(:)                                           OUTBCOU.......2700
      TYPE (LLD), POINTER :: DENTS                                       OUTBCOU.......2800
      COMMON /CLAY/ LAYSTR                                               OUTBCOU.......2900
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  OUTBCOU.......3000
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           OUTBCOU.......3100
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      OUTBCOU.......3200
      COMMON /DIMLAY/ NLAYS,NNLAY,NELAY                                  OUTBCOU.......3300
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              OUTBCOU.......3400
     1   NSOP,NSOU,NBCN,NCIDB                                            OUTBCOU.......3500
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        OUTBCOU.......3600
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA                           OUTBCOU.......3700
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 OUTBCOU.......3800
     1   K10,K11,K12,K13                                                 OUTBCOU.......3900
      COMMON /GRAVEC/ GRAVX,GRAVY,GRAVZ                                  OUTBCOU.......4000
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS      OUTBCOU.......4100
      COMMON /JCOLS/ NCOLPR,LCOLPR,NCOLS5,NCOLS6,J5COL,J6COL             OUTBCOU.......4200
      COMMON /KPRBCS/ KINACT                                             OUTBCOU.......4300
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                OUTBCOU.......4400
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            OUTBCOU.......4500
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,      OUTBCOU.......4600
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2        OUTBCOU.......4700
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /PLT2/ ONCEK10, ONCEK11, ONCEK12, ONCEK13                   OUTBCOU.......4800
      COMMON /SCH/ NSCH,ISCHTS,NSCHAU                                    OUTBCOU.......4900
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                           OUTBCOU.......5000
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       OUTBCOU.......5100
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      OUTBCOU.......5200
      DATA (BCDSTR(M),M=-1,2)                                            OUTBCOU.......5300
     1   /'    BCTIME','       INP','       BCS','       BCS'/           OUTBCOU.......5400
      DATA NOTAPP /"                                     N/A"/           OUTBCOU.......5500
      SAVE BCDSTR                                                        OUTBCOU.......5600
C                                                                        OUTBCOU.......5700
C.....CALCULATE HEADERS ON FIRST CALL AND CREATE OUTPUT ON EACH CALL.    OUTBCOU.......5800
C                                                                        OUTBCOU.......5900
C                                                                        OUTBCOU.......6000
      IF (.NOT. ONCEK13)  THEN                                           OUTBCOU.......6100
C.....FIRST CALL -- CREATE FILE HEADER.                                  OUTBCOU.......6200
C                                                                        OUTBCOU.......6300
C........CALCULATE THE MAXIMUM NUMBER OF TIME STEPS, KTMAX.              OUTBCOU.......6400
         KT=0                                                            OUTBCOU.......6500
         DO 4 JT=1,ITMAX                                                 OUTBCOU.......6600
            IF (MOD(JT,NBCUPR).EQ.0 .OR.                                 OUTBCOU.......6700
     1         ((JT.EQ.ITRST+1).AND.((ISSTRA.NE.0).OR.(NBCUPR.GT.0))))   OUTBCOU.......6800
     2         KT = KT + 1                                               OUTBCOU.......6900
    4    CONTINUE                                                        OUTBCOU.......7000
         IF(ITMAX.GT.1 .AND. MOD(ITMAX,NBCUPR).NE.0) KT = KT + 1         OUTBCOU.......7100
         KTMAX = KT                                                      OUTBCOU.......7200
C                                                                        OUTBCOU.......7300
C........ALLOCATE LOCAL ARRAYS                                           OUTBCOU.......7400
         ALLOCATE(TT(KTMAX),ITT(KTMAX))                                  OUTBCOU.......7500
C                                                                        OUTBCOU.......7600
C........CALCULATE AND PRINT TIME STEP INFORMATION                       OUTBCOU.......7700
         TS=TSTART                                                       OUTBCOU.......7800
C........TIME STEP VALUE                                                 OUTBCOU.......7900
         JT=0                                                            OUTBCOU.......8000
C........NUMBER OF PRINTED TIME STEPS                                    OUTBCOU.......8100
         KT=0                                                            OUTBCOU.......8200
C........TIME STEP INCREMENT                                             OUTBCOU.......8300
         DELTK=DELT                                                      OUTBCOU.......8400
         DENTS => SCHDLS(ISCHTS)%SLIST                                   OUTBCOU.......8500
         DO 10 JT=1,ITMAX                                                OUTBCOU.......8600
            DENTS => DENTS%NENT                                          OUTBCOU.......8700
            TS = DENTS%DVALU1                                            OUTBCOU.......8800
            IF (MOD(JT,NBCUPR).EQ.0 .OR.                                 OUTBCOU.......8900
     1         ((JT.EQ.ITRST+1).AND.((ISSTRA.NE.0).OR.(NBCUPR.GT.0))))   OUTBCOU.......9000
     2         THEN                                                      OUTBCOU.......9100
               KT = KT + 1                                               OUTBCOU.......9200
               TT(KT) = TS                                               OUTBCOU.......9300
               ITT(KT) = JT                                              OUTBCOU.......9400
            ENDIF                                                        OUTBCOU.......9500
   10    CONTINUE                                                        OUTBCOU.......9600
         IF (ISSTRA.EQ.1) TT(KT) = TSTART                                OUTBCOU.......9700
C                                                                        OUTBCOU.......9800
C                                                                        OUTBCOU.......9900
C........PRINT LAST TIME STEP ALWAYS, UNLESS ALREADY PRINTED             OUTBCOU......10000
         IF(ITMAX.GT.1 .AND. MOD(ITMAX,NBCUPR).NE.0) THEN                OUTBCOU......10100
            KT = KT + 1                                                  OUTBCOU......10200
            TT(KT) = TS                                                  OUTBCOU......10300
            ITT(KT) = ITMAX                                              OUTBCOU......10400
         ENDIF                                                           OUTBCOU......10500
C                                                                        OUTBCOU......10600
C........COMPUTE ACTUAL NUMBER OF PRINTED TIME STEPS, KTPRN; LESS THAN   OUTBCOU......10700
C           KTMAX IF RUN IS A RESTART                                    OUTBCOU......10800
         IF (IREAD.EQ.+1) THEN                                           OUTBCOU......10900
            KTPRN = KTMAX                                                OUTBCOU......11000
         ELSE                                                            OUTBCOU......11100
            KTPRN = 0                                                    OUTBCOU......11200
            DO 17 KT=1,KTMAX                                             OUTBCOU......11300
               IF (ITT(KT).GT.ITRST) KTPRN = KTPRN + 1                   OUTBCOU......11400
   17       CONTINUE                                                     OUTBCOU......11500
         END IF                                                          OUTBCOU......11600
C                                                                        OUTBCOU......11700
C........WRITE HEADER INFORMATION                                        OUTBCOU......11800
         WRITE(K13,950) TITLE1, TITLE2                                   OUTBCOU......11900
         IF (KTYPE(2).GT.1) THEN                                         OUTBCOU......12000
            IF (KTYPE(2).EQ.3) THEN                                      OUTBCOU......12100
               CTYPE2 = "BLOCKWISE MESH"                                 OUTBCOU......12200
            ELSE                                                         OUTBCOU......12300
               CTYPE2 = "REGULAR MESH  "                                 OUTBCOU......12400
            END IF                                                       OUTBCOU......12500
            IF (KTYPE(1).EQ.3) THEN                                      OUTBCOU......12600
               WRITE(K13,951) KTYPE(1),CTYPE2,NN1,NN2,NN3,NN," Nodes",   OUTBCOU......12700
     1            NE, " Elems"                                           OUTBCOU......12800
            ELSE                                                         OUTBCOU......12900
               WRITE(K13,952) KTYPE(1),CTYPE2,NN1,NN2,NN," Nodes",       OUTBCOU......13000
     1            NE, " Elems"                                           OUTBCOU......13100
            END IF                                                       OUTBCOU......13200
         ELSE IF (KTYPE(2).EQ.1) THEN                                    OUTBCOU......13300
            WRITE(K13,953) KTYPE(1), LAYSTR(1:6), NLAYS, NNLAY,          OUTBCOU......13400
     1         NN, " Nodes", NE, " Elems"                                OUTBCOU......13500
         ELSE                                                            OUTBCOU......13600
            WRITE(K13,954) KTYPE(1), NN, " Nodes", NE, " Elems"          OUTBCOU......13700
         END IF                                                          OUTBCOU......13800
         IF (ME.GT.0) THEN                                               OUTBCOU......13900
            WRITE(K13,960) "SPECIFIED-TEMPERATURE NODE RESULTS  ", KTPRN OUTBCOU......14000
         ELSE                                                            OUTBCOU......14100
            WRITE(K13,960) "SPECIFIED-CONCENTRATION NODE RESULTS", KTPRN OUTBCOU......14200
         END IF                                                          OUTBCOU......14300
         DO 920 KT=1,KTMAX                                               OUTBCOU......14400
            IF (ITT(KT).GT.ITRST)                                        OUTBCOU......14500
     1         WRITE(K13,961) ITT(KT), TT(KT)                            OUTBCOU......14600
  920    CONTINUE                                                        OUTBCOU......14700
  950    FORMAT("## ", 80A1,                                             OUTBCOU......14800
     1         /"## ", 80A1,                                             OUTBCOU......14900
     2         /"## ")                                                   OUTBCOU......15000
  951    FORMAT("## ", I1, "-D, ", A, 2X,                                OUTBCOU......15100
     1                 "(", 2(I9, ")*("), I9, ") = ", I9, A, 1X,         OUTBCOU......15200
     2                 "(", I9, A, ")"                                   OUTBCOU......15300
     3         /"## ")                                                   OUTBCOU......15400
  952    FORMAT("## ", I1, "-D, ", A, 14X,                               OUTBCOU......15500
     1                 "(", I9, ")*(", I9, ") = ", I9, A, 1X,            OUTBCOU......15600
     2                 "(", I9, A, ")"                                   OUTBCOU......15700
     3         /"## ")                                                   OUTBCOU......15800
  953    FORMAT("## ", I1, "-D, LAYERED MESH [", A6, "]", 7X,            OUTBCOU......15900
     1                 "(", I9, ")*(", I9, ") = ", I9, A, 1X,            OUTBCOU......16000
     2                 "(", I9, A, ")"                                   OUTBCOU......16100
     3         /"## ")                                                   OUTBCOU......16200
  954    FORMAT("## ", I1, "-D, IRREGULAR MESH", 40X, I9, A, 1X,         OUTBCOU......16300
     1                 "(", I9, A, ")"                                   OUTBCOU......16400
     2         /"## ")                                                   OUTBCOU......16500
  960    FORMAT("## ", 92("="),                                          OUTBCOU......16600
     1         /"## ", A, 28X, I9, " Time steps printed",                OUTBCOU......16700
     2         /"## ", 92("="),                                          OUTBCOU......16800
     3         /"## ",                                                   OUTBCOU......16900
     4         /"## ", 4X, "Time steps"                                  OUTBCOU......17000
     5         /"## ", 3X, "in this file      Time (sec)"                OUTBCOU......17100
     6         /"## ", 2X, 14("-"), 3X, 13("-"))                         OUTBCOU......17200
  961    FORMAT ("## ", 7X, I8, 4X, 1PE13.6)                             OUTBCOU......17300
C                                                                        OUTBCOU......17400
C........DEALLOCATE LOCAL ARRAYS.                                        OUTBCOU......17500
         DEALLOCATE(TT,ITT)                                              OUTBCOU......17600
C                                                                        OUTBCOU......17700
         ONCEK13 = .TRUE.                                                OUTBCOU......17800
      ENDIF                                                              OUTBCOU......17900
C                                                                        OUTBCOU......18000
C.....NODEWISE HEADER INFORMATION REPEATED BEFORE EACH TIME STEP         OUTBCOU......18100
      IF ((IT.EQ.1).AND.(ISSTRA.EQ.1)) THEN                              OUTBCOU......18200
         DURN = 0D0                                                      OUTBCOU......18300
         TOUT = TSTART                                                   OUTBCOU......18400
      ELSE                                                               OUTBCOU......18500
         DURN = DELT                                                     OUTBCOU......18600
         TOUT = TSEC                                                     OUTBCOU......18700
      END IF                                                             OUTBCOU......18800
      WRITE(K13,966) IT, DURN, TOUT                                      OUTBCOU......18900
  966 FORMAT('## ',                                                      OUTBCOU......19000
     1      /'## ', 131('='),                                            OUTBCOU......19100
     2      /'## TIME STEP ', I8, 61X, 'Duration: ', 1PE11.4, ' sec',    OUTBCOU......19200
     3                            6X, 'Time: ', 1PE11.4, ' sec',         OUTBCOU......19300
     4      /'## ', 131('='))                                            OUTBCOU......19400
      IF (ME .GT. 0) THEN                                                OUTBCOU......19500
         WRITE(K13,967)                                                  OUTBCOU......19600
      ELSE                                                               OUTBCOU......19700
         WRITE(K13,968)                                                  OUTBCOU......19800
      END IF                                                             OUTBCOU......19900
  967 FORMAT(                                                            OUTBCOU......20000
     1    '## ',76X,'Resultant'                                          OUTBCOU......20100
     2   /'## ',66X,'source/sink(+/-) of'                                OUTBCOU......20200
     3   /'##   Node    Defined in',28X,'BCS identifier',                OUTBCOU......20300
     4           4X,'energy (energy/sec)',10X,'Computed temp',           OUTBCOU......20400
     5           9X,'Specified temp')                                    OUTBCOU......20500
  968 FORMAT(                                                            OUTBCOU......20600
     1    '## ',76X,'Resultant'                                          OUTBCOU......20700
     2   /'## ',66X,'source/sink(+/-) of'                                OUTBCOU......20800
     3   /'##   Node    Defined in',28X,'BCS identifier',                OUTBCOU......20900
     4           6X,'solute (mass/sec)',10X,'Computed conc',             OUTBCOU......21000
     5           9X,'Specified conc')                                    OUTBCOU......21100
C                                                                        OUTBCOU......21200
C.....BOUNDARY CONDITION INFORMATION FOR THIS TIME STEP                  OUTBCOU......21300
      IF (NUBC.GT.0) THEN                                                OUTBCOU......21400
      DO 990 IU=1,NUBC                                                   OUTBCOU......21500
      IUP = IU + NPBC                                                    OUTBCOU......21600
      I=IABS(IUBC(IUP))                                                  OUTBCOU......21700
      IBC = IBCUBC(IUP)                                                  OUTBCOU......21800
      QPL = GNUU1(IUP)*(UBC(IUP)-UVEC(I))                                OUTBCOU......21900
      IF (IBC.NE.2) THEN                                                 OUTBCOU......22000
         IF (IBC.GT.0) THEN                                              OUTBCOU......22100
            WRITE(K13,980) I,                                            OUTBCOU......22200
     1         BCDSTR(IBC),ADJUSTR(CIDBCS(IIDUBC(IUP))),                 OUTBCOU......22300
     2         CUTSML(QPL),CUTSML(UVEC(I)),UBC(IUP)                      OUTBCOU......22400
         ELSE                                                            OUTBCOU......22500
            WRITE(K13,980) I,                                            OUTBCOU......22600
     1         BCDSTR(IBC),NOTAPP,                                       OUTBCOU......22700
     2         CUTSML(QPL),CUTSML(UVEC(I)),UBC(IUP)                      OUTBCOU......22800
         END IF                                                          OUTBCOU......22900
  980    FORMAT(I9,4X,A10,2X,A40,8X,1PE15.7,2(8X,1PE15.8))               OUTBCOU......23000
      ELSE IF (KINACT.EQ.1) THEN                                         OUTBCOU......23100
         WRITE(K13,982) I,                                               OUTBCOU......23200
     1      BCDSTR(IBC),ADJUSTR(CIDBCS(IIDUBC(IUP))),                    OUTBCOU......23300
     2      "INACTIVE","INACTIVE","INACTIVE"                             OUTBCOU......23400
  982    FORMAT(I9,4X,A10,2X,A40,3(15X,A8))                              OUTBCOU......23500
      END IF                                                             OUTBCOU......23600
  990 CONTINUE                                                           OUTBCOU......23700
      END IF                                                             OUTBCOU......23800
C                                                                        OUTBCOU......23900
      RETURN                                                             OUTBCOU......24000
C                                                                        OUTBCOU......24100
      END                                                                OUTBCOU......24200
C                                                                        OUTBCOU......24300
C     SUBROUTINE        O  U  T  E  L  E           SUTRA VERSION 2.2     OUTELE.........100
C                                                                        OUTELE.........200
C *** PURPOSE :                                                          OUTELE.........300
C ***  TO PRINT ELEMENT CENTROID COORDINATES AND VELOCITY COMPONENTS     OUTELE.........400
C ***  IN A FLEXIBLE, COLUMNWISE FORMAT.  OUTPUT IS TO THE ELE FILE.     OUTELE.........500
C                                                                        OUTELE.........600
      SUBROUTINE OUTELE(VMAG,VANG1,VANG2,IN,X,Y,Z,TITLE1,TITLE2,         OUTELE.........700
     1   BCSFL,BCSTR,QLX,QLY,REK,QXF,QYF,SPF,RPF) 
C     1   BCSFL,BCSTR)                                                    OUTELE.........800
      USE EXPINT                                                         OUTELE.........900
      USE SCHDEF                                                         OUTELE........1000
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                OUTELE........1100
      PARAMETER (NCOLMX=9)                                               OUTELE........1200
      CHARACTER*1  TITLE1(80),TITLE2(80)                                 OUTELE........1300
      CHARACTER*15 COLTK6(7)                                             OUTELE........1400
      CHARACTER*1 CPVX,CPVY,CPVZ                                         OUTELE........1500
      CHARACTER*14 CTYPE2                                                OUTELE........1600
      CHARACTER*80 LAYSTR                                                OUTELE........1700
      LOGICAL ONCEK5,ONCEK6,ONCEK7,ONCEK8                                OUTELE........1800
      LOGICAL PRINTE                                                     OUTELE........1900
      LOGICAL BCSFL(0:ITMAX),BCSTR(0:ITMAX)                              OUTELE........2000
      DIMENSION IN(NIN),IIN(8)                                           OUTELE........2100
      DIMENSION VMAG(NE),VANG1(NE),VANG2(NEX)                            OUTELE........2200
      DIMENSION X(NN),Y(NN),Z(NN)                                        OUTELE........2300
      DIMENSION REK(NE),QLX(NE),QLY(NE),QXF(NE),QYF(NE),SPF(NE),
     1   RPF(NE)
      DIMENSION VCOL(NCOLMX),VVAR(7)                                     OUTELE........2400
      DIMENSION J5COL(NCOLMX),J6COL(NCOLMX)                              OUTELE........2500
      DIMENSION KTYPE(2)                                                 OUTELE........2600
      ALLOCATABLE TT(:),ITT(:),ISVEL(:)                                  OUTELE........2700
      TYPE (LLD), POINTER :: DENTS                                       OUTELE........2800
      COMMON /CLAY/ LAYSTR                                               OUTELE........2900
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  OUTELE........3000
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           OUTELE........3100
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      OUTELE........3200
      COMMON /DIMLAY/ NLAYS,NNLAY,NELAY                                  OUTELE........3300
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              OUTELE........3400
     1   NSOP,NSOU,NBCN,NCIDB                                            OUTELE........3500
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        OUTELE........3600
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 OUTELE........3700
     1   K10,K11,K12,K13                                                 OUTELE........3800
      COMMON /GRAVEC/ GRAVX,GRAVY,GRAVZ                                  OUTELE........3900
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS      OUTELE........4000
      COMMON /JCOLS/ NCOLPR,LCOLPR,NCOLS5,NCOLS6,J5COL,J6COL             OUTELE........4100
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                OUTELE........4200
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            OUTELE........4300
      COMMON /PLT1/ ONCEK5,ONCEK6,ONCEK7,ONCEK8                          OUTELE........4400
      COMMON /SCH/ NSCH,ISCHTS,NSCHAU                                    OUTELE........4500
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                           OUTELE........4600
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       OUTELE........4700
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      OUTELE........4800
      DATA (COLTK6(MM), MM=1,7) /'Element',                              OUTELE........4900
     1   '       X origin', '       Y origin', '       Z origin',        OUTELE........5000
     2   '     X velocity', '     Y velocity', '     Z velocity'/        OUTELE........5100
      SAVE COLTK6                                                        OUTELE........5200
C                                                                        OUTELE........5300
C.....CALCULATE HEADERS ON FIRST CALL AND CREATE OUTPUT ON EACH CALL.    OUTELE........5400
C                                                                        OUTELE........5500
      DKTM2 = DBLE(KTYPE(1) - 2)                                         OUTELE........5600
C                                                                        OUTELE........5700
      IF (.NOT. ONCEK6)  THEN                                            OUTELE........5800
C.....FIRST CALL -- CREATE FILE HEADER.                                  OUTELE........5900
C                                                                        OUTELE........6000
C........CALCULATE THE MAXIMUM NUMBER OF TIME STEPS, KTMAX.              OUTELE........6100
         KT=0                                                            OUTELE........6200
         DO 4 JT=1,ITMAX                                                 OUTELE........6300
            IF (MOD(JT,LCOLPR).EQ.0 .OR. JT.EQ.ITRST+1) KT = KT + 1      OUTELE........6400
    4    CONTINUE                                                        OUTELE........6500
         IF(ITMAX.GT.1 .AND. MOD(ITMAX,LCOLPR).NE.0) KT = KT + 1         OUTELE........6600
         KTMAX = KT                                                      OUTELE........6700
C                                                                        OUTELE........6800
C........ALLOCATE LOCAL ARRAYS                                           OUTELE........6900
         ALLOCATE(TT(KTMAX),ITT(KTMAX))                                  OUTELE........7000
         ALLOCATE(ISVEL(KTMAX))                                          OUTELE........7100
C                                                                        OUTELE........7200
C........CALCULATE AND PRINT TIME STEP INFORMATION                       OUTELE........7300
         TS=TSTART                                                       OUTELE........7400
C........TIME STEP VALUE                                                 OUTELE........7500
         JT=0                                                            OUTELE........7600
C........NUMBER OF PRINTED TIME STEPS                                    OUTELE........7700
         KT=0                                                            OUTELE........7800
C........TIME STEP INCREMENT                                             OUTELE........7900
         DELTK=DELT                                                      OUTELE........8000
C........INDICATORS OF WHEN VARIABLES ARE CALCULATED AND PRINTED         OUTELE........8100
         LCP = 0                                                         OUTELE........8200
         CPVX = 'N'                                                      OUTELE........8300
         CPVY = 'N'                                                      OUTELE........8400
         CPVZ = 'N'                                                      OUTELE........8500
         DO 8 M=1,NCOLS6                                                 OUTELE........8600
            IF (J6COL(M).EQ.5) CPVX = 'Y'                                OUTELE........8700
            IF (J6COL(M).EQ.6) CPVY = 'Y'                                OUTELE........8800
            IF (J6COL(M).EQ.7) CPVZ = 'Y'                                OUTELE........8900
    8    CONTINUE                                                        OUTELE........9000
         DENTS => SCHDLS(ISCHTS)%SLIST                                   OUTELE........9100
         DO 10 JT=1,ITMAX                                                OUTELE........9200
            DENTS => DENTS%NENT                                          OUTELE........9300
            TS = DENTS%DVALU1                                            OUTELE........9400
            LCV = LCP                                                    OUTELE........9500
            IF (MOD(JT,NPCYC).EQ.0 .OR. BCSFL(JT) .OR. JT.EQ.1)          OUTELE........9600
     1         LCP = JT                                                  OUTELE........9700
            IF (MOD(JT,LCOLPR).EQ.0 .OR. JT.EQ.ITRST+1) THEN             OUTELE........9800
               KT = KT + 1                                               OUTELE........9900
               TT(KT) = TS                                               OUTELE.......10000
               ITT(KT) = JT                                              OUTELE.......10100
               ISVEL(KT) = LCV                                           OUTELE.......10200
               IF (JT.NE.1 .OR. ISSFLO.EQ.2) THEN                        OUTELE.......10300
                  IF (MOD(JT,NUCYC).NE.0 .AND. (.NOT.BCSTR(JT)))         OUTELE.......10400
     1               ISVEL(KT) = 0                                       OUTELE.......10500
               ENDIF                                                     OUTELE.......10600
            ENDIF                                                        OUTELE.......10700
   10    CONTINUE                                                        OUTELE.......10800
         IF (ISSTRA.EQ.1) TT(KT) = TSTART                                OUTELE.......10900
C                                                                        OUTELE.......11000
C                                                                        OUTELE.......11100
C........PRINT LAST TIME STEP ALWAYS, UNLESS ALREADY PRINTED             OUTELE.......11200
         IF(ITMAX.GT.1 .AND. MOD(ITMAX,LCOLPR).NE.0) THEN                OUTELE.......11300
            KT = KT + 1                                                  OUTELE.......11400
            TT(KT) = TS                                                  OUTELE.......11500
            ITT(KT) = ITMAX                                              OUTELE.......11600
            ISVEL(KT) = LCV                                              OUTELE.......11700
         ENDIF                                                           OUTELE.......11800
C                                                                        OUTELE.......11900
C........IF STEADY-STATE FLOW, V BASED ON TIME STEP 0 ONLY, AND          OUTELE.......12000
C           OUTPUT OCCURS ONLY ON TIME STEP 1.                           OUTELE.......12100
         IF (ISSFLO.NE.0) THEN                                           OUTELE.......12200
            KTMAX = 1                                                    OUTELE.......12300
            ISVEL(1) = 0                                                 OUTELE.......12400
         END IF                                                          OUTELE.......12500
C                                                                        OUTELE.......12600
C........COMPUTE ACTUAL NUMBER OF PRINTED TIME STEPS, KTPRN; LESS THAN   OUTELE.......12700
C           KTMAX IF RUN IS A RESTART                                    OUTELE.......12800
         IF (IREAD.EQ.+1) THEN                                           OUTELE.......12900
            KTPRN = KTMAX                                                OUTELE.......13000
         ELSE                                                            OUTELE.......13100
            KTPRN = 0                                                    OUTELE.......13200
            DO 17 KT=1,KTMAX                                             OUTELE.......13300
               IF (ITT(KT).GT.ITRST) KTPRN = KTPRN + 1                   OUTELE.......13400
   17       CONTINUE                                                     OUTELE.......13500
         END IF                                                          OUTELE.......13600
C                                                                        OUTELE.......13700
C........WRITE HEADER INFORMATION                                        OUTELE.......13800
         WRITE(K6,950) TITLE1, TITLE2                                    OUTELE.......13900
         IF (KTYPE(2).GT.1) THEN                                         OUTELE.......14000
            IF (KTYPE(2).EQ.3) THEN                                      OUTELE.......14100
               CTYPE2 = "BLOCKWISE MESH"                                 OUTELE.......14200
            ELSE                                                         OUTELE.......14300
               CTYPE2 = "REGULAR MESH  "                                 OUTELE.......14400
            END IF                                                       OUTELE.......14500
            IF (KTYPE(1).EQ.3) THEN                                      OUTELE.......14600
               WRITE(K6,951) KTYPE(1), CTYPE2, NN1-1, NN2-1, NN3-1,      OUTELE.......14700
     1            NE, " Elems", NN, " Nodes"                             OUTELE.......14800
            ELSE                                                         OUTELE.......14900
               WRITE(K6,952) KTYPE(1), CTYPE2, NN1-1, NN2-1,             OUTELE.......15000
     1            NE, " Elems", NN, " Nodes"                             OUTELE.......15100
            END IF                                                       OUTELE.......15200
         ELSE IF (KTYPE(2).EQ.1) THEN                                    OUTELE.......15300
            WRITE(K6,953) KTYPE(1), LAYSTR(1:6), NLAYS-1, NELAY,         OUTELE.......15400
     1         NE, " Elems", NN, " Nodes"                                OUTELE.......15500
         ELSE                                                            OUTELE.......15600
            WRITE(K6,954) KTYPE(1), NE, " Elems", NN, " Nodes"           OUTELE.......15700
         END IF                                                          OUTELE.......15800
         WRITE(K6,960) "VELOCITY RESULTS",                               OUTELE.......15900
     1      KTPRN, "Vx", "Vy", "Vz"                                      OUTELE.......16000
         DO 20 KT=1,KTMAX                                                OUTELE.......16100
            IF (ITT(KT).GT.ITRST)                                        OUTELE.......16200
     1         WRITE(K6,961) ITT(KT), TT(KT), CPVX, ISVEL(KT),           OUTELE.......16300
     2         CPVY, ISVEL(KT), CPVZ, ISVEL(KT)                          OUTELE.......16400
   20    CONTINUE                                                        OUTELE.......16500
  950    FORMAT("## ", 80A1,                                             OUTELE.......16600
     1         /"## ", 80A1,                                             OUTELE.......16700
     2         /"## ")                                                   OUTELE.......16800
  951    FORMAT("## ", I1, "-D, ", A, 2X,                                OUTELE.......16900
     1                 "(", 2(I9, ")*("), I9, ") = ", I9, A, 1X,         OUTELE.......17000
     2                 "(", I9, A, ")"                                   OUTELE.......17100
     3         /"## ")                                                   OUTELE.......17200
  952    FORMAT("## ", I1, "-D, ", A, 14X,                               OUTELE.......17300
     1                 "(", I9, ")*(", I9, ") = ", I9, A, 1X,            OUTELE.......17400
     2                 "(", I9, A, ")"                                   OUTELE.......17500
     3         /"## ")                                                   OUTELE.......17600
  953    FORMAT("## ", I1, "-D, LAYERED MESH [", A6, "]", 7X,            OUTELE.......17700
     1                 "(", I9, ")*(", I9, ") = ", I9, A, 1X,            OUTELE.......17800
     2                 "(", I9, A, ")"                                   OUTELE.......17900
     3         /"## ")                                                   OUTELE.......18000
  954    FORMAT("## ", I1, "-D, IRREGULAR MESH", 40X, I9, A, 1X,         OUTELE.......18100
     1                 "(", I9, A, ")"                                   OUTELE.......18200
     2          /"## ")                                                  OUTELE.......18300
  960    FORMAT("## ", 92("="),                                          OUTELE.......18400
     1         /"## ", A, 48X, I9, " Time steps printed",                OUTELE.......18500
     2         /"## ", 92("="),                                          OUTELE.......18600
     3         /"## ",                                                   OUTELE.......18700
     4         /"## ", 4X, "Time steps", 22X,                            OUTELE.......18800
     5                 "[Printed? / Time step on which V is based]"      OUTELE.......18900
     6         /"## ", 3X, "in this file      Time (sec)",               OUTELE.......19000
     7                 10X,A2, 13X,A2, 13X,A2,                           OUTELE.......19100
     8         /"## ", 2X, 14("-"), 3X, 13("-"), 1X, 3(3X, 12("-")) )    OUTELE.......19200
  961    FORMAT ("## ", 7X, I8, 4X, 1PE13.6, 3(5X, A1, 1X, I8))          OUTELE.......19300
C                                                                        OUTELE.......19400
C........DEALLOCATE LOCAL ARRAYS.                                        OUTELE.......19500
         DEALLOCATE(TT,ITT,ISVEL)                                        OUTELE.......19600
C                                                                        OUTELE.......19700
         ONCEK6 = .TRUE.                                                 OUTELE.......19800
      ENDIF                                                              OUTELE.......19900
C                                                                        OUTELE.......20000
C.....OUTPUT VELOCITIES FOR STEADY FLOW ONLY ON THE FIRST TIME STEP      OUTELE.......20100
      IF ((ISSFLO.EQ.2).AND.(IT.GT.1)) GOTO 9999                         OUTELE.......20200
C                                                                        OUTELE.......20300
C.....VELOCITY HEADER INFORMATION REPEATED BEFORE EACH TIME STEP         OUTELE.......20400
      IF ((IT.EQ.1).AND.(ISSTRA.EQ.1)) THEN                              OUTELE.......20500
         DURN = 0D0                                                      OUTELE.......20600
         TOUT = TSTART                                                   OUTELE.......20700
      ELSE                                                               OUTELE.......20800
         DURN = DELT                                                     OUTELE.......20900
         TOUT = TSEC                                                     OUTELE.......21000
      END IF                                                             OUTELE.......21100
      WRITE(K6,966) IT, DURN, TOUT                                       OUTELE.......21200
  966 FORMAT('## ',                                                      OUTELE.......21300
     1      /'## ', 92('='),                                             OUTELE.......21400
     2      /'## TIME STEP ', I8, 22X, 'Duration: ', 1PE11.4, ' sec',    OUTELE.......21500
     3                            6X, 'Time: ', 1PE11.4, ' sec',         OUTELE.......21600
     4      /'## ', 92('='))                                             OUTELE.......21700
      PRINTE = (J6COL(1).EQ.1)                                           OUTELE.......21800
      IF (PRINTE) THEN                                                   OUTELE.......21900
         WRITE(K6,982) (COLTK6(J6COL(M)), M=1,NCOLS6)                    OUTELE.......22000
C  982    FORMAT ("## ", A8, 19(A15))                                     OUTELE.......22100
982            FORMAT ("## ", A8, 4(A15),9X,"X FLUX",9X,
     5"Y FLUX",11X,"RELK",12X,"QXF",12X,"QYF",12X,"SPF",12X,"RPF")

      ELSE                                                               OUTELE.......22200
         WRITE(K6,983) COLTK6(J6COL(1))(3:15),                           OUTELE.......22300
     1      (COLTK6(J6COL(M)), M=2,NCOLS6)                               OUTELE.......22400
  983    FORMAT ("## ", A13, 19(A15))                                    OUTELE.......22500
      END IF                                                             OUTELE.......22600
C                                                                        OUTELE.......22700
C.....VELOCITY DATA FOR THIS TIME STEP                                   OUTELE.......22800
      RN48 = 1D0/DBLE(N48)                                               OUTELE.......22900
      DO 5000 L=1, NE                                                    OUTELE.......23000
         CENTRX = 0D0                                                    OUTELE.......23100
         CENTRY = 0D0                                                    OUTELE.......23200
         CENTRZ = 0D0                                                    OUTELE.......23300
         DO 1400 II=1, N48                                               OUTELE.......23400
            III=II+(L-1)*N48                                             OUTELE.......23500
            IIN(II)=IN(III)                                              OUTELE.......23600
            CENTRX = CENTRX + X(IIN(II))                                 OUTELE.......23700
            CENTRY = CENTRY + Y(IIN(II))                                 OUTELE.......23800
            CENTRZ = CENTRZ + Z(IIN(II))                                 OUTELE.......23900
 1400    CONTINUE                                                        OUTELE.......24000
         CENTRX = CENTRX*RN48                                            OUTELE.......24100
         CENTRY = CENTRY*RN48                                            OUTELE.......24200
         CENTRZ = CENTRZ*RN48                                            OUTELE.......24300
         VA1 = 0.017453292D0*VANG1(L)                                    OUTELE.......24400
         LL = MIN(L, NEX)                                                OUTELE.......24500
         VA2 = 0.017453292D0*VANG2(LL)*DKTM2                             OUTELE.......24600
         CVA2 = DCOS(VA2)                                                OUTELE.......24700
         VECTRX=VMAG(L) * DCOS(VA1)*CVA2                                 OUTELE.......24800
         VECTRY=VMAG(L) * DSIN(VA1)*CVA2                                 OUTELE.......24900
         VECTRZ=VMAG(L) * DSIN(VA2)                                      OUTELE.......25000
         VVAR(1) = DBLE(L)                                               OUTELE.......25100
         VVAR(2) = CENTRX                                                OUTELE.......25200
         VVAR(3) = CENTRY                                                OUTELE.......25300
         VVAR(4) = CENTRZ                                                OUTELE.......25400
         VVAR(5) = VECTRX                                                OUTELE.......25500
         VVAR(6) = VECTRY                                                OUTELE.......25600
         VVAR(7) = VECTRZ                                                OUTELE.......25700
         DO 1984 M=1,NCOLS6                                              OUTELE.......25800
            VCOL(M) = VVAR(J6COL(M))                                     OUTELE.......25900
 1984    CONTINUE                                                        OUTELE.......26000
         IF (PRINTE) THEN                                                OUTELE.......26100
             WRITE(K6,1985) L,(CUTSML(VCOL(M)), M=2,NCOLS6),QLX(L),
     1       QLY(L),REK(L),QXF(L),QYF(L),SPF(L),RPF(L)
C            WRITE(K6,1985) L,(CUTSML(VCOL(M)), M=2,NCOLS6)               OUTELE.......26200
 1985       FORMAT (I9, 2X, 19(1PE15.7))                                 OUTELE.......26300
         ELSE                                                            OUTELE.......26400
            WRITE(K6,1986) (CUTSML(VCOL(M)), M=1,NCOLS6)                 OUTELE.......26500
 1986       FORMAT (1X, 20(1PE15.7))                                     OUTELE.......26600
         END IF                                                          OUTELE.......26700
 5000 CONTINUE                                                           OUTELE.......26800
C                                                                        OUTELE.......26900
 9999 CONTINUE                                                           OUTELE.......27000
      RETURN                                                             OUTELE.......27100
C                                                                        OUTELE.......27200
      END                                                                OUTELE.......27300
C                                                                        OUTELE.......27400
C     SUBROUTINE        O  U  T  L  S  T  2        SUTRA VERSION 2.2     OUTLST2........100
C                                                                        OUTLST2........200
C *** PURPOSE :                                                          OUTLST2........300
C ***  TO PRINT PRESSURE AND TEMPERATURE OR CONCENTRATION                OUTLST2........400
C ***  SOLUTIONS AND TO OUTPUT INFORMATION ON TIME STEP, ITERATIONS,     OUTLST2........500
C ***  SATURATIONS, AND FLUID VELOCITIES FOR 2D PROBLEMS.                OUTLST2........600
C ***  OUTPUT IS TO THE LST FILE.                                        OUTLST2........700
C                                                                        OUTLST2........800
      SUBROUTINE OUTLST2(ML,ISTOP,IGOI,IERRP,ITRSP,ERRP,                 OUTLST2........900
     1   IERRU,ITRSU,ERRU,PVEC,UVEC,VMAG,VANG,SW)                        OUTLST2.......1000
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                OUTLST2.......1100
      DIMENSION PVEC(NNVEC),UVEC(NNVEC),VMAG(NE),VANG(NE),SW(NN)         OUTLST2.......1200
      DIMENSION KTYPE(2)                                                 OUTLST2.......1300
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  OUTLST2.......1400
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           OUTLST2.......1500
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      OUTLST2.......1600
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              OUTLST2.......1700
     1   NSOP,NSOU,NBCN,NCIDB                                            OUTLST2.......1800
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        OUTLST2.......1900
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA                           OUTLST2.......2000
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 OUTLST2.......2100
     1   K10,K11,K12,K13                                                 OUTLST2.......2200
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS      OUTLST2.......2300
      COMMON /KPRBCS/ KINACT                                             OUTLST2.......2400
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                OUTLST2.......2500
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            OUTLST2.......2600
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                           OUTLST2.......2700
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       OUTLST2.......2800
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      OUTLST2.......2900
C                                                                        OUTLST2.......3000
C.....OUTPUT MAJOR HEADINGS FOR CURRENT TIME STEP                        OUTLST2.......3100
      ITREL = IT - ITRST                                                 OUTLST2.......3200
      IF(ITREL.GT.0.OR.ISSFLO.EQ.2.OR.ISSTRA.EQ.1) GOTO 100              OUTLST2.......3300
      WRITE(K3,60)                                                       OUTLST2.......3400
   60 FORMAT('1'////11X,'I N I T I A L   C O N D I T I O N S',           OUTLST2.......3500
     1             /11X,'___________________________________')           OUTLST2.......3600
      IF(IREAD.EQ.-1) WRITE(K3,65) ITRST                                 OUTLST2.......3700
   65 FORMAT(//11X,'INITIAL CONDITIONS RETRIEVED FROM A RESTART',        OUTLST2.......3800
     1   ' FILE (WARM START)'                                            OUTLST2.......3900
     2   /11X,'THAT WAS SAVED AT THE END OF TIME STEP ',I8,' OF THE ',   OUTLST2.......4000
     3        'ORIGINAL SIMULATION.')                                    OUTLST2.......4100
      GOTO 500                                                           OUTLST2.......4200
C                                                                        OUTLST2.......4300
  100 WRITE(K3,350) IT                                                   OUTLST2.......4400
  350 FORMAT('1'//11X,'RESULTS FOR TIME STEP ',I8/                       OUTLST2.......4500
     1   11X,'_______ ___ ____ ____ ________')                           OUTLST2.......4600
C                                                                        OUTLST2.......4700
      IF(ITRMAX.GT.1) THEN                                               OUTLST2.......4800
         IF(IGOI.EQ.0) THEN                                              OUTLST2.......4900
            WRITE(K3,355) ITER                                           OUTLST2.......5000
         ELSE                                                            OUTLST2.......5100
            WRITE(K3,356) ITER                                           OUTLST2.......5200
         END IF                                                          OUTLST2.......5300
  355    FORMAT(/11X,'NON-LINEARITY ITERATIONS CONVERGED AFTER ',I5,     OUTLST2.......5400
     1      ' ITERATIONS')                                               OUTLST2.......5500
  356    FORMAT(/11X,'NON-LINEARITY ITERATIONS  N O T  CONVERGED',       OUTLST2.......5600
     1      ' AFTER ',I5,' ITERATIONS')                                  OUTLST2.......5700
         WRITE(K3,450) RPM,IPWORS,RUM,IUWORS                             OUTLST2.......5800
  450    FORMAT(11X,'MAXIMUM P CHANGE FROM PREVIOUS ITERATION ',         OUTLST2.......5900
     1      1PE14.5,' AT NODE ',I9/11X,'MAXIMUM U CHANGE FROM PREVIOUS', OUTLST2.......6000
     2      ' ITERATION ',1PE14.5,' AT NODE ',I9)                        OUTLST2.......6100
      END IF                                                             OUTLST2.......6200
C                                                                        OUTLST2.......6300
      IF ((ML.EQ.0).OR.(ML.EQ.1)) THEN                                   OUTLST2.......6400
         IF (KSOLVP.EQ.0) THEN                                           OUTLST2.......6500
            WRITE(K3,452)                                                OUTLST2.......6600
         ELSE IF (IERRP.EQ.0) THEN                                       OUTLST2.......6700
            WRITE(K3,455) ITRSP, ERRP                                    OUTLST2.......6800
         ELSE                                                            OUTLST2.......6900
            WRITE(K3,456) ITRSP, ERRP                                    OUTLST2.......7000
         END IF                                                          OUTLST2.......7100
      END IF                                                             OUTLST2.......7200
      IF ((ML.EQ.0).OR.(ML.EQ.2)) THEN                                   OUTLST2.......7300
         IF (ML.EQ.2) WRITE(K3,*) ' '                                    OUTLST2.......7400
         IF (KSOLVU.EQ.0) THEN                                           OUTLST2.......7500
            WRITE(K3,453)                                                OUTLST2.......7600
         ELSE IF (IERRU.EQ.0) THEN                                       OUTLST2.......7700
            WRITE(K3,457) ITRSU, ERRU                                    OUTLST2.......7800
         ELSE                                                            OUTLST2.......7900
            WRITE(K3,458) ITRSU, ERRU                                    OUTLST2.......8000
         END IF                                                          OUTLST2.......8100
      END IF                                                             OUTLST2.......8200
  452 FORMAT(/11X,'P-SOLUTION COMPUTED USING DIRECT SOLVER')             OUTLST2.......8300
  453 FORMAT(11X,'U-SOLUTION COMPUTED USING DIRECT SOLVER')              OUTLST2.......8400
  455 FORMAT(/11X,'P-SOLUTION CONVERGED AFTER ',I5,' MATRIX'             OUTLST2.......8500
     1   ' SOLVER ITERATIONS; ESTIMATED ERROR ',1PE14.5)                 OUTLST2.......8600
  456 FORMAT(/11X,'P-SOLUTION  F A I L E D  AFTER ',I5,' MATRIX'         OUTLST2.......8700
     1   ' SOLVER ITERATIONS; ESTIMATED ERROR ',1PE14.5)                 OUTLST2.......8800
  457 FORMAT(11X,'U-SOLUTION CONVERGED AFTER ',I5,' MATRIX'              OUTLST2.......8900
     1   ' SOLVER ITERATIONS; ESTIMATED ERROR ',1PE14.5)                 OUTLST2.......9000
  458 FORMAT(11X,'U-SOLUTION  F A I L E D  AFTER ',I5,' MATRIX'          OUTLST2.......9100
     1   ' SOLVER ITERATIONS; ESTIMATED ERROR ',1PE14.5)                 OUTLST2.......9200
C                                                                        OUTLST2.......9300
  500 IF(IT.EQ.0.AND.ISSFLO.EQ.2) GOTO 680                               OUTLST2.......9400
      IF(ISSTRA.EQ.1) GOTO 800                                           OUTLST2.......9500
      WRITE(K3,550) DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,                     OUTLST2.......9600
     1   TMONTH,TYEAR                                                    OUTLST2.......9700
  550 FORMAT(///11X,'TIME INCREMENT :',T27,1PE15.4,' SECONDS'//11X,      OUTLST2.......9800
     1   'TIME AT END',3X,T27,1PE15.4,' SECONDS',/11X,'OF STEP:',6X,T27, OUTLST2.......9900
     2   1PE15.4,' MINUTES'/T27,1PE15.4,' HOURS'/T27,1PE15.4,' DAYS'     OUTLST2......10000
     3   /T27,1PE15.4,' WEEKS'/T27,1PE15.4,' MONTHS'/T27,1PE15.4,        OUTLST2......10100
     4   ' YEARS')                                                       OUTLST2......10200
C                                                                        OUTLST2......10300
C.....OUTPUT PRESSURES FOR TRANSIENT FLOW SOLUTION (AND, POSSIBLY,       OUTLST2......10400
C        SATURATION AND VELOCITY)                                        OUTLST2......10500
      IF(ML.EQ.2.AND.ISTOP.GE.0) GOTO 700                                OUTLST2......10600
      IF(ISSFLO.GT.0) GOTO 700                                           OUTLST2......10700
      IF (KPANDS.EQ.1) THEN                                              OUTLST2......10800
         WRITE(K3,650) (I,CUTSML(PVEC(I)),I=1,NN)                        OUTLST2......10900
  650    FORMAT(///11X,'P  R  E  S  S  U  R  E'                          OUTLST2......11000
     1      //2X,5(6X,'NODE',16X)/(2X,5(1X,I9,1X,1PE15.8)))              OUTLST2......11100
         IF(IUNSAT.NE.0) WRITE(K3,651) (I,CUTSML(SW(I)),I=1,NN)          OUTLST2......11200
  651    FORMAT(///11X,'S  A  T  U  R  A  T  I  O  N'                    OUTLST2......11300
     1      //2X,5(6X,'NODE',16X)/(2X,5(1X,I9,1X,1PE15.8)))              OUTLST2......11400
      END IF                                                             OUTLST2......11500
      IF(KVEL.EQ.1.AND.ITREL.GT.0)                                       OUTLST2......11600
     1   WRITE(K3,655) (L,CUTSML(VMAG(L)),L=1,NE)                        OUTLST2......11700
      IF(KVEL.EQ.1.AND.ITREL.GT.0)                                       OUTLST2......11800
     1   WRITE(K3,656) (L,CUTSML(VANG(L)),L=1,NE)                        OUTLST2......11900
  655 FORMAT(///11X,'F  L  U  I  D     V  E  L  O  C  I  T  Y'//         OUTLST2......12000
     1   11X,'M A G N I T U D E   AT CENTROID OF ELEMENT'//              OUTLST2......12100
     2   2X,5(3X,'ELEMENT',16X)/(2X,5(1X,I9,1X,1PE15.8)))                OUTLST2......12200
  656 FORMAT(///11X,'F  L  U  I  D     V  E  L  O  C  I  T  Y'//         OUTLST2......12300
     1   11X,'A N G L E   IN DEGREES FROM +X-AXIS TO FLOW DIRECTION ',   OUTLST2......12400
     2   'AT CENTROID OF ELEMENT'//                                      OUTLST2......12500
     3   2X,5(3X,'ELEMENT',16X)/(2X,5(1X,I9,1X,1PE15.8)))                OUTLST2......12600
      GOTO 700                                                           OUTLST2......12700
C                                                                        OUTLST2......12800
C.....OUTPUT PRESSURES FOR STEADY-STATE FLOW SOLUTION                    OUTLST2......12900
  680 IF (KPANDS.EQ.1) THEN                                              OUTLST2......13000
         WRITE(K3,690) (I,CUTSML(PVEC(I)),I=1,NN)                        OUTLST2......13100
  690    FORMAT(///11X,'S  T  E  A  D  Y  -  S  T  A  T  E     ',        OUTLST2......13200
     1      'P  R  E  S  S  U  R  E'//2X,5(6X,'NODE',16X)                OUTLST2......13300
     2      /(2X,5(1X,I9,1X,1PE15.8)))                                   OUTLST2......13400
         IF(IUNSAT.NE.0) WRITE(K3,651) (I,CUTSML(SW(I)),I=1,NN)          OUTLST2......13500
      END IF                                                             OUTLST2......13600
      GOTO 1000                                                          OUTLST2......13700
C                                                                        OUTLST2......13800
C.....OUTPUT CONCENTRATIONS OR TEMPERATURES FOR                          OUTLST2......13900
C        TRANSIENT TRANSPORT SOLUTION                                    OUTLST2......14000
  700 IF(ML.EQ.1.AND.ISTOP.GE.0) GOTO 1000                               OUTLST2......14100
      IF (KCORT.EQ.1) THEN                                               OUTLST2......14200
         IF(ME) 720,720,730                                              OUTLST2......14300
  720    WRITE(K3,725) (I,CUTSML(UVEC(I)),I=1,NN)                        OUTLST2......14400
  725    FORMAT(///11X,'C  O  N  C  E  N  T  R  A  T  I  O  N'           OUTLST2......14500
     1      //2X,5(6X,'NODE',16X)/(2X,5(1X,I9,1X,1PE15.8)))              OUTLST2......14600
         GOTO 900                                                        OUTLST2......14700
  730    WRITE(K3,735) (I,CUTSML(UVEC(I)),I=1,NN)                        OUTLST2......14800
  735    FORMAT(///11X,'T  E  M  P  E  R  A  T  U  R  E'                 OUTLST2......14900
     1      //2X,5(6X,'NODE',16X)/(2X,5(1X,I9,1X,1PE15.8)))              OUTLST2......15000
         GOTO 900                                                        OUTLST2......15100
      END IF                                                             OUTLST2......15200
C                                                                        OUTLST2......15300
C.....OUTPUT CONCENTRATIONS OR TEMPERATURES FOR                          OUTLST2......15400
C        STEADY-STATE TRANSPORT SOLUTION                                 OUTLST2......15500
  800 IF (KCORT.EQ.1) THEN                                               OUTLST2......15600
         IF(ME) 820,820,830                                              OUTLST2......15700
  820    WRITE(K3,825) (I,CUTSML(UVEC(I)),I=1,NN)                        OUTLST2......15800
  825    FORMAT(///11X,'S  T  E  A  D  Y  -  S  T  A  T  E     ',        OUTLST2......15900
     1      'C  O  N  C  E  N  T  R  A  T  I  O  N'                      OUTLST2......16000
     2      //2X,5(6X,'NODE',16X)/(2X,5(1X,I9,1X,1PE15.8)))              OUTLST2......16100
         GOTO 900                                                        OUTLST2......16200
  830    WRITE(K3,835) (I,CUTSML(UVEC(I)),I=1,NN)                        OUTLST2......16300
  835    FORMAT(///11X,'S  T  E  A  D  Y  -  S  T  A  T  E     ',        OUTLST2......16400
     1      'T  E  M  P  E  R  A  T  U  R  E'                            OUTLST2......16500
     2      //2X,5(6X,'NODE',16X)/(2X,5(1X,I9,1X,1PE15.8)))              OUTLST2......16600
      END IF                                                             OUTLST2......16700
C                                                                        OUTLST2......16800
C.....OUTPUT VELOCITIES FOR STEADY-STATE FLOW SOLUTION                   OUTLST2......16900
  900 IF(ISSFLO.NE.2.OR.IT.NE.1.OR.KVEL.NE.1) GOTO 1000                  OUTLST2......17000
      WRITE(K3,925) (L,CUTSML(VMAG(L)),L=1,NE)                           OUTLST2......17100
      WRITE(K3,950) (L,CUTSML(VANG(L)),L=1,NE)                           OUTLST2......17200
  925 FORMAT(///11X,'S  T  E  A  D  Y  -  S  T  A  T  E     ',           OUTLST2......17300
     1   'F  L  U  I  D     V  E  L  O  C  I  T  Y'//                    OUTLST2......17400
     2   11X,'M A G N I T U D E   AT CENTROID OF ELEMENT'//              OUTLST2......17500
     3   2X,5(3X,'ELEMENT',16X)/(2X,5(1X,I9,1X,1PE15.8)))                OUTLST2......17600
  950 FORMAT(///11X,'S  T  E  A  D  Y  -  S  T  A  T  E     ',           OUTLST2......17700
     1   'F  L  U  I  D     V  E  L  O  C  I  T  Y'//                    OUTLST2......17800
     2   11X,'A N G L E   IN DEGREES FROM +X-AXIS TO FLOW DIRECTION ',   OUTLST2......17900
     3   'AT CENTROID OF ELEMENT'//                                      OUTLST2......18000
     4   2X,5(3X,'ELEMENT',16X)/(2X,5(1X,I9,1X,1PE15.8)))                OUTLST2......18100
C                                                                        OUTLST2......18200
 1000 RETURN                                                             OUTLST2......18300
C                                                                        OUTLST2......18400
      END                                                                OUTLST2......18500
C                                                                        OUTLST2......18600
C     SUBROUTINE        O  U  T  L  S  T  3        SUTRA VERSION 2.2     OUTLST3........100
C                                                                        OUTLST3........200
C *** PURPOSE :                                                          OUTLST3........300
C ***  TO PRINT PRESSURE AND TEMPERATURE OR CONCENTRATION                OUTLST3........400
C ***  SOLUTIONS AND TO OUTPUT INFORMATION ON TIME STEP, ITERATIONS,     OUTLST3........500
C ***  SATURATIONS, AND FLUID VELOCITIES FOR 3D PROBLEMS.                OUTLST3........600
C ***  OUTPUT IS TO THE LST FILE.                                        OUTLST3........700
C                                                                        OUTLST3........800
      SUBROUTINE OUTLST3(ML,ISTOP,IGOI,IERRP,ITRSP,ERRP,                 OUTLST3........900
     1   IERRU,ITRSU,ERRU,PVEC,UVEC,VMAG,VANG1,VANG2,SW)                 OUTLST3.......1000
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                OUTLST3.......1100
      DIMENSION PVEC(NNVEC),UVEC(NNVEC),VMAG(NE),VANG1(NE),VANG2(NEX),   OUTLST3.......1200
     1   SW(NN)                                                          OUTLST3.......1300
      DIMENSION KTYPE(2)                                                 OUTLST3.......1400
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  OUTLST3.......1500
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           OUTLST3.......1600
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      OUTLST3.......1700
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              OUTLST3.......1800
     1   NSOP,NSOU,NBCN,NCIDB                                            OUTLST3.......1900
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        OUTLST3.......2000
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA                           OUTLST3.......2100
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 OUTLST3.......2200
     1   K10,K11,K12,K13                                                 OUTLST3.......2300
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS      OUTLST3.......2400
      COMMON /KPRBCS/ KINACT                                             OUTLST3.......2500
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                OUTLST3.......2600
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            OUTLST3.......2700
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                           OUTLST3.......2800
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       OUTLST3.......2900
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      OUTLST3.......3000
C                                                                        OUTLST3.......3100
C.....OUTPUT MAJOR HEADINGS FOR CURRENT TIME STEP                        OUTLST3.......3200
      ITREL = IT - ITRST                                                 OUTLST3.......3300
      IF(ITREL.GT.0.OR.ISSFLO.EQ.2.OR.ISSTRA.EQ.1) GOTO 100              OUTLST3.......3400
      WRITE(K3,60)                                                       OUTLST3.......3500
   60 FORMAT('1'////11X,'I N I T I A L   C O N D I T I O N S',           OUTLST3.......3600
     1             /11X,'___________________________________')           OUTLST3.......3700
      IF(IREAD.EQ.-1) WRITE(K3,65) ITRST                                 OUTLST3.......3800
   65 FORMAT(//11X,'INITIAL CONDITIONS RETRIEVED FROM A RESTART',        OUTLST3.......3900
     1   ' FILE (WARM START)'                                            OUTLST3.......4000
     2   /11X,'THAT WAS SAVED AT THE END OF TIME STEP ',I8,' OF THE ',   OUTLST3.......4100
     3        'ORIGINAL SIMULATION.')                                    OUTLST3.......4200
      GOTO 500                                                           OUTLST3.......4300
C                                                                        OUTLST3.......4400
  100 WRITE(K3,350) IT                                                   OUTLST3.......4500
  350 FORMAT('1'//11X,'RESULTS FOR TIME STEP ',I8/                       OUTLST3.......4600
     1   11X,'_______ ___ ____ ____ ________')                           OUTLST3.......4700
C                                                                        OUTLST3.......4800
      IF(ITRMAX.GT.1) THEN                                               OUTLST3.......4900
         IF(IGOI.EQ.0) THEN                                              OUTLST3.......5000
            WRITE(K3,355) ITER                                           OUTLST3.......5100
         ELSE                                                            OUTLST3.......5200
            WRITE(K3,356) ITER                                           OUTLST3.......5300
         END IF                                                          OUTLST3.......5400
  355    FORMAT(/11X,'NON-LINEARITY ITERATIONS CONVERGED AFTER ',I5,     OUTLST3.......5500
     1      ' ITERATIONS')                                               OUTLST3.......5600
  356    FORMAT(/11X,'NON-LINEARITY ITERATIONS  N O T  CONVERGED',       OUTLST3.......5700
     1      ' AFTER ',I5,' ITERATIONS')                                  OUTLST3.......5800
         WRITE(K3,450) RPM,IPWORS,RUM,IUWORS                             OUTLST3.......5900
  450    FORMAT(11X,'MAXIMUM P CHANGE FROM PREVIOUS ITERATION ',         OUTLST3.......6000
     1      1PE14.5,' AT NODE ',I9/11X,'MAXIMUM U CHANGE FROM PREVIOUS', OUTLST3.......6100
     2      ' ITERATION ',1PE14.5,' AT NODE ',I9)                        OUTLST3.......6200
      END IF                                                             OUTLST3.......6300
C                                                                        OUTLST3.......6400
      IF ((ML.EQ.0).OR.(ML.EQ.1)) THEN                                   OUTLST3.......6500
         IF (KSOLVP.EQ.0) THEN                                           OUTLST3.......6600
            WRITE(K3,452)                                                OUTLST3.......6700
         ELSE IF (IERRP.EQ.0) THEN                                       OUTLST3.......6800
            WRITE(K3,455) ITRSP, ERRP                                    OUTLST3.......6900
         ELSE                                                            OUTLST3.......7000
            WRITE(K3,456) ITRSP, ERRP                                    OUTLST3.......7100
         END IF                                                          OUTLST3.......7200
      END IF                                                             OUTLST3.......7300
      IF ((ML.EQ.0).OR.(ML.EQ.2)) THEN                                   OUTLST3.......7400
         IF (ML.EQ.2) WRITE(K3,*) ' '                                    OUTLST3.......7500
         IF (KSOLVU.EQ.0) THEN                                           OUTLST3.......7600
            WRITE(K3,453)                                                OUTLST3.......7700
         ELSE IF (IERRU.EQ.0) THEN                                       OUTLST3.......7800
            WRITE(K3,457) ITRSU, ERRU                                    OUTLST3.......7900
         ELSE                                                            OUTLST3.......8000
            WRITE(K3,458) ITRSU, ERRU                                    OUTLST3.......8100
         END IF                                                          OUTLST3.......8200
      END IF                                                             OUTLST3.......8300
  452 FORMAT(/11X,'P-SOLUTION COMPUTED USING DIRECT SOLVER')             OUTLST3.......8400
  453 FORMAT(11X,'U-SOLUTION COMPUTED USING DIRECT SOLVER')              OUTLST3.......8500
  455 FORMAT(/11X,'P-SOLUTION CONVERGED AFTER ',I5,' MATRIX'             OUTLST3.......8600
     1   ' SOLVER ITERATIONS; ESTIMATED ERROR ',1PE14.5)                 OUTLST3.......8700
  456 FORMAT(/11X,'P-SOLUTION  F A I L E D  AFTER ',I5,' MATRIX'         OUTLST3.......8800
     1   ' SOLVER ITERATIONS; ESTIMATED ERROR ',1PE14.5)                 OUTLST3.......8900
  457 FORMAT(11X,'U-SOLUTION CONVERGED AFTER ',I5,' MATRIX'              OUTLST3.......9000
     1   ' SOLVER ITERATIONS; ESTIMATED ERROR ',1PE14.5)                 OUTLST3.......9100
  458 FORMAT(11X,'U-SOLUTION  F A I L E D  AFTER ',I5,' MATRIX'          OUTLST3.......9200
     1   ' SOLVER ITERATIONS; ESTIMATED ERROR ',1PE14.5)                 OUTLST3.......9300
C                                                                        OUTLST3.......9400
  500 IF(IT.EQ.0.AND.ISSFLO.EQ.2) GOTO 680                               OUTLST3.......9500
      IF(ISSTRA.EQ.1) GOTO 800                                           OUTLST3.......9600
      WRITE(K3,550) DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,                     OUTLST3.......9700
     1   TMONTH,TYEAR                                                    OUTLST3.......9800
  550 FORMAT(///11X,'TIME INCREMENT :',T27,1PE15.4,' SECONDS'//11X,      OUTLST3.......9900
     1   'TIME AT END',3X,T27,1PE15.4,' SECONDS',/11X,'OF STEP:',6X,T27, OUTLST3......10000
     2   1PE15.4,' MINUTES'/T27,1PE15.4,' HOURS'/T27,1PE15.4,' DAYS'     OUTLST3......10100
     3   /T27,1PE15.4,' WEEKS'/T27,1PE15.4,' MONTHS'/T27,1PE15.4,        OUTLST3......10200
     4   ' YEARS')                                                       OUTLST3......10300
C                                                                        OUTLST3......10400
C.....OUTPUT PRESSURES FOR TRANSIENT FLOW SOLUTION (AND, POSSIBLY,       OUTLST3......10500
C        SATURATION AND VELOCITY)                                        OUTLST3......10600
      IF(ML.EQ.2.AND.ISTOP.GE.0) GOTO 700                                OUTLST3......10700
      IF(ISSFLO.GT.0) GOTO 700                                           OUTLST3......10800
      IF (KPANDS.EQ.1) THEN                                              OUTLST3......10900
         WRITE(K3,650) (I,CUTSML(PVEC(I)),I=1,NN)                        OUTLST3......11000
  650    FORMAT(///11X,'P  R  E  S  S  U  R  E'                          OUTLST3......11100
     1      //2X,5(6X,'NODE',16X)/(2X,5(1X,I9,1X,1PE15.8)))              OUTLST3......11200
         IF(IUNSAT.NE.0) WRITE(K3,651) (I,CUTSML(SW(I)),I=1,NN)          OUTLST3......11300
  651    FORMAT(///11X,'S  A  T  U  R  A  T  I  O  N'                    OUTLST3......11400
     1      //2X,5(6X,'NODE',16X)/(2X,5(1X,I9,1X,1PE15.8)))              OUTLST3......11500
      END IF                                                             OUTLST3......11600
      IF(KVEL.EQ.1.AND.ITREL.GT.0) THEN                                  OUTLST3......11700
         WRITE(K3,655) (L,CUTSML(VMAG(L)),L=1,NE)                        OUTLST3......11800
         WRITE(K3,656) (L,CUTSML(VANG1(L)),L=1,NE)                       OUTLST3......11900
         WRITE(K3,657) (L,CUTSML(VANG2(L)),L=1,NE)                       OUTLST3......12000
      END IF                                                             OUTLST3......12100
  655 FORMAT(///11X,'F  L  U  I  D     V  E  L  O  C  I  T  Y'//         OUTLST3......12200
     1   11X,'M A G N I T U D E   AT CENTROID OF ELEMENT'//              OUTLST3......12300
     2   2X,5(3X,'ELEMENT',16X)/(2X,5(1X,I9,1X,1PE15.8)))                OUTLST3......12400
  656 FORMAT(///11X,'F  L  U  I  D     V  E  L  O  C  I  T  Y'//         OUTLST3......12500
     1   11X,'A N G L E 1   AT CENTROID OF ELEMENT, IN DEGREES FROM ',   OUTLST3......12600
     2   '+X-AXIS TO PROJECTION OF FLOW DIRECTION IN XY-PLANE'//         OUTLST3......12700
     3   2X,5(3X,'ELEMENT',16X)/(2X,5(1X,I9,1X,1PE15.8)))                OUTLST3......12800
  657 FORMAT(///11X,'F  L  U  I  D     V  E  L  O  C  I  T  Y'//         OUTLST3......12900
     1   11X,'A N G L E 2   AT CENTROID OF ELEMENT, IN DEGREES FROM ',   OUTLST3......13000
     2   'XY-PLANE TO FLOW DIRECTION'//                                  OUTLST3......13100
     3   2X,5(3X,'ELEMENT',16X)/(2X,5(1X,I9,1X,1PE15.8)))                OUTLST3......13200
C     END IF                                                             OUTLST3......13300
      GOTO 700                                                           OUTLST3......13400
C                                                                        OUTLST3......13500
C.....OUTPUT PRESSURES FOR STEADY-STATE FLOW SOLUTION                    OUTLST3......13600
  680 IF (KPANDS.EQ.1) THEN                                              OUTLST3......13700
         WRITE(K3,690) (I,CUTSML(PVEC(I)),I=1,NN)                        OUTLST3......13800
  690    FORMAT(///11X,'S  T  E  A  D  Y  -  S  T  A  T  E     ',        OUTLST3......13900
     1      'P  R  E  S  S  U  R  E'//2X,5(6X,'NODE',16X)                OUTLST3......14000
     2      /(2X,5(1X,I9,1X,1PE15.8)))                                   OUTLST3......14100
         IF(IUNSAT.NE.0) WRITE(K3,651) (I,CUTSML(SW(I)),I=1,NN)          OUTLST3......14200
      END IF                                                             OUTLST3......14300
      GOTO 1000                                                          OUTLST3......14400
C                                                                        OUTLST3......14500
C.....OUTPUT CONCENTRATIONS OR TEMPERATURES FOR                          OUTLST3......14600
C        TRANSIENT TRANSPORT SOLUTION                                    OUTLST3......14700
  700 IF(ML.EQ.1.AND.ISTOP.GE.0) GOTO 1000                               OUTLST3......14800
      IF (KCORT.EQ.1) THEN                                               OUTLST3......14900
         IF(ME) 720,720,730                                              OUTLST3......15000
  720    WRITE(K3,725) (I,CUTSML(UVEC(I)),I=1,NN)                        OUTLST3......15100
  725    FORMAT(///11X,'C  O  N  C  E  N  T  R  A  T  I  O  N'           OUTLST3......15200
     1      //2X,5(6X,'NODE',16X)/(2X,5(1X,I9,1X,1PE15.8)))              OUTLST3......15300
         GOTO 900                                                        OUTLST3......15400
  730    WRITE(K3,735) (I,CUTSML(UVEC(I)),I=1,NN)                        OUTLST3......15500
  735    FORMAT(///11X,'T  E  M  P  E  R  A  T  U  R  E'                 OUTLST3......15600
     1      //2X,5(6X,'NODE',16X)/(2X,5(1X,I9,1X,1PE15.8)))              OUTLST3......15700
         GOTO 900                                                        OUTLST3......15800
      END IF                                                             OUTLST3......15900
C                                                                        OUTLST3......16000
C.....OUTPUT CONCENTRATIONS OR TEMPERATURES FOR                          OUTLST3......16100
C        STEADY-STATE TRANSPORT SOLUTION                                 OUTLST3......16200
  800 IF (KCORT.EQ.1) THEN                                               OUTLST3......16300
         IF(ME) 820,820,830                                              OUTLST3......16400
  820    WRITE(K3,825) (I,CUTSML(UVEC(I)),I=1,NN)                        OUTLST3......16500
  825    FORMAT(///11X,'S  T  E  A  D  Y  -  S  T  A  T  E     ',        OUTLST3......16600
     1      'C  O  N  C  E  N  T  R  A  T  I  O  N'                      OUTLST3......16700
     2      //2X,5(6X,'NODE',16X)/(2X,5(1X,I9,1X,1PE15.8)))              OUTLST3......16800
         GOTO 900                                                        OUTLST3......16900
  830    WRITE(K3,835) (I,CUTSML(UVEC(I)),I=1,NN)                        OUTLST3......17000
  835    FORMAT(///11X,'S  T  E  A  D  Y  -  S  T  A  T  E     ',        OUTLST3......17100
     1      'T  E  M  P  E  R  A  T  U  R  E'                            OUTLST3......17200
     2      //2X,5(6X,'NODE',16X)/(2X,5(1X,I9,1X,1PE15.8)))              OUTLST3......17300
      END IF                                                             OUTLST3......17400
C                                                                        OUTLST3......17500
C.....OUTPUT VELOCITIES FOR STEADY-STATE FLOW SOLUTION                   OUTLST3......17600
  900 IF(ISSFLO.NE.2.OR.IT.NE.1.OR.KVEL.NE.1) GOTO 1000                  OUTLST3......17700
      WRITE(K3,925) (L,CUTSML(VMAG(L)),L=1,NE)                           OUTLST3......17800
      WRITE(K3,950) (L,CUTSML(VANG1(L)),L=1,NE)                          OUTLST3......17900
      WRITE(K3,951) (L,CUTSML(VANG2(L)),L=1,NE)                          OUTLST3......18000
  925 FORMAT(///11X,'S  T  E  A  D  Y  -  S  T  A  T  E     ',           OUTLST3......18100
     1   'F  L  U  I  D     V  E  L  O  C  I  T  Y'//                    OUTLST3......18200
     2   11X,'M A G N I T U D E   AT CENTROID OF ELEMENT'//              OUTLST3......18300
     3   2X,5(3X,'ELEMENT',16X)/(2X,5(1X,I9,1X,1PE15.8)))                OUTLST3......18400
  950 FORMAT(///11X,'S  T  E  A  D  Y  -  S  T  A  T  E     ',           OUTLST3......18500
     1   'F  L  U  I  D     V  E  L  O  C  I  T  Y'//                    OUTLST3......18600
     2   11X,'A N G L E 1   AT CENTROID OF ELEMENT, IN DEGREES FROM ',   OUTLST3......18700
     3   '+X-AXIS TO PROJECTION OF FLOW DIRECTION IN XY-PLANE'//         OUTLST3......18800
     4   2X,5(3X,'ELEMENT',16X)/(2X,5(1X,I9,1X,1PE15.8)))                OUTLST3......18900
  951 FORMAT(///11X,'S  T  E  A  D  Y  -  S  T  A  T  E     ',           OUTLST3......19000
     1   'F  L  U  I  D     V  E  L  O  C  I  T  Y'//                    OUTLST3......19100
     2   11X,'A N G L E 2   AT CENTROID OF ELEMENT, IN DEGREES FROM ',   OUTLST3......19200
     3   'XY-PLANE TO FLOW DIRECTION'//                                  OUTLST3......19300
     4   2X,5(3X,'ELEMENT',16X)/(2X,5(1X,I9,1X,1PE15.8)))                OUTLST3......19400
C                                                                        OUTLST3......19500
 1000 RETURN                                                             OUTLST3......19600
C                                                                        OUTLST3......19700
      END                                                                OUTLST3......19800
C                                                                        OUTLST3......19900
C     SUBROUTINE        O  U  T  N  O  D           SUTRA VERSION 2.2     OUTNOD.........100
C                                                                        OUTNOD.........200
C *** PURPOSE :                                                          OUTNOD.........300
C ***  TO PRINT NODE COORDINATES, PRESSURES, CONCENTRATIONS OR           OUTNOD.........400
C ***  TEMPERATURES, AND SATURATIONS IN A FLEXIBLE, COLUMNWISE FORMAT.   OUTNOD.........500
C ***  OUTPUT IS TO THE NOD FILE.                                        OUTNOD.........600
C                                                                        OUTNOD.........700
C      SUBROUTINE OUTNOD(PVEC,UVEC,SW,X,Y,Z,TITLE1,TITLE2,BCSFL,BCSTR)    OUTNOD.........800
      SUBROUTINE OUTNOD(PVEC,UVEC,SW,X,Y,Z,TITLE1,TITLE2,BCSFL,BCSTR,SM
     1 ,POR1,WMA,SMA,DSWDP,TPT)
      USE EXPINT                                                         OUTNOD.........900
      USE SCHDEF                                                         OUTNOD........1000
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                OUTNOD........1100
      PARAMETER (NCOLMX=9)                                               OUTNOD........1200
      CHARACTER*1  TITLE1(80),TITLE2(80)                                 OUTNOD........1300
      CHARACTER*8  HORP                                                  OUTNOD........1400
      CHARACTER*13 TORC                                                  OUTNOD........1500
      CHARACTER*15 COLTK5(7)                                             OUTNOD........1600
      CHARACTER*1 CPHORP,CPTORC,CPSATU                                   OUTNOD........1700
      CHARACTER*14 CTYPE2                                                OUTNOD........1800
      CHARACTER*80 LAYSTR                                                OUTNOD........1900
      LOGICAL ONCEK5,ONCEK6,ONCEK7,ONCEK8                                OUTNOD........2000
      LOGICAL PRINTN                                                     OUTNOD........2100
      LOGICAL BCSFL(0:ITMAX),BCSTR(0:ITMAX)                              OUTNOD........2200
      DIMENSION PVEC(NNVEC),UVEC(NNVEC),SW(NN)                           OUTNOD........2300
      DIMENSION X(NN),Y(NN),Z(NN)                                        OUTNOD........2400
      DIMENSION VCOL(NCOLMX),VVAR(7)                                     OUTNOD........2500
      DIMENSION J5COL(NCOLMX),J6COL(NCOLMX)                              OUTNOD........2600
      DIMENSION SM(NNVEC),POR1(NN),WMA(NN),SMA(NN),DSWDP(NN),TPT(NN)
      DIMENSION KTYPE(2)                                                 OUTNOD........2700
      ALLOCATABLE TT(:),ITT(:),ISTORC(:),ISHORP(:),ISSATU(:)             OUTNOD........2800
      TYPE (LLD), POINTER :: DENTS                                       OUTNOD........2900
      COMMON /CLAY/ LAYSTR                                               OUTNOD........3000
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  OUTNOD........3100
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           OUTNOD........3200
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      OUTNOD........3300
      COMMON /DIMLAY/ NLAYS,NNLAY,NELAY                                  OUTNOD........3400
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              OUTNOD........3500
     1   NSOP,NSOU,NBCN,NCIDB                                            OUTNOD........3600
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        OUTNOD........3700
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA                           OUTNOD........3800
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 OUTNOD........3900
     1   K10,K11,K12,K13                                                 OUTNOD........4000
      COMMON /GRAVEC/ GRAVX,GRAVY,GRAVZ                                  OUTNOD........4100
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS      OUTNOD........4200
      COMMON /JCOLS/ NCOLPR,LCOLPR,NCOLS5,NCOLS6,J5COL,J6COL             OUTNOD........4300
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                OUTNOD........4400
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            OUTNOD........4500
      COMMON /PLT1/ ONCEK5,ONCEK6,ONCEK7,ONCEK8                          OUTNOD........4600
      COMMON /SCH/ NSCH,ISCHTS,NSCHAU                                    OUTNOD........4700
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                           OUTNOD........4800
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       OUTNOD........4900
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      OUTNOD........5000
      DATA (COLTK5(MM), MM=1,7) /'Node',                                 OUTNOD........5100
     1   '              X', '              Y', '              Z',        OUTNOD........5200
     2   '       Pressure', '  Concentration', '     Saturation'/        OUTNOD........5300
      SAVE COLTK5                                                        OUTNOD........5400
C                                                                        OUTNOD........5500
C.....CALCULATE HEADERS ON FIRST CALL AND CREATE OUTPUT ON EACH CALL.    OUTNOD........5600
C                                                                        OUTNOD........5700
C                                                                        OUTNOD........5800
      IF (.NOT. ONCEK5)  THEN                                            OUTNOD........5900
C.....FIRST CALL -- CREATE FILE HEADER.                                  OUTNOD........6000
C                                                                        OUTNOD........6100
C........CALCULATE THE MAXIMUM NUMBER OF TIME STEPS, KTMAX.              OUTNOD........6200
         IF (ISSTRA.NE.1) THEN                                           OUTNOD........6300
            KT = 1                                                       OUTNOD........6400
         ELSE                                                            OUTNOD........6500
            KT = 0                                                       OUTNOD........6600
         END IF                                                          OUTNOD........6700
         DO 4 JT=1,ITMAX                                                 OUTNOD........6800
            IF (MOD(JT,NCOLPR).EQ.0 .OR. JT.EQ.ITRST .OR.                OUTNOD........6900
     1         ((JT.EQ.ITRST+1).AND.((ISSTRA.NE.0).OR.(NCOLPR.GT.0))))   OUTNOD........7000
     2         KT = KT + 1                                               OUTNOD........7100
    4    CONTINUE                                                        OUTNOD........7200
         IF(ITMAX.GT.1 .AND. MOD(ITMAX,NCOLPR).NE.0) KT = KT + 1         OUTNOD........7300
         KTMAX = KT                                                      OUTNOD........7400
C                                                                        OUTNOD........7500
C........ALLOCATE LOCAL ARRAYS                                           OUTNOD........7600
         ALLOCATE(TT(KTMAX),ITT(KTMAX))                                  OUTNOD........7700
         ALLOCATE(ISTORC(KTMAX),ISHORP(KTMAX),ISSATU(KTMAX))             OUTNOD........7800
C                                                                        OUTNOD........7900
C........CALCULATE AND PRINT TIME STEP INFORMATION                       OUTNOD........8000
         TS=TSTART                                                       OUTNOD........8100
C........TIME STEP VALUE                                                 OUTNOD........8200
         JT=0                                                            OUTNOD........8300
C........NUMBER OF PRINTED TIME STEPS                                    OUTNOD........8400
         KT=0                                                            OUTNOD........8500
C........TIME STEP INCREMENT                                             OUTNOD........8600
         DELTK=DELT                                                      OUTNOD........8700
C........INDICATORS OF WHEN VARIABLES ARE CALCULATED AND PRINTED         OUTNOD........8800
         LCHORP = 0                                                      OUTNOD........8900
         LCTORC = 0                                                      OUTNOD........9000
         CPHORP = 'N'                                                    OUTNOD........9100
         CPTORC = 'N'                                                    OUTNOD........9200
         CPSATU = 'N'                                                    OUTNOD........9300
         DO 8 M=1,NCOLS5                                                 OUTNOD........9400
            IF (J5COL(M).EQ.5) CPHORP = 'Y'                              OUTNOD........9500
            IF (J5COL(M).EQ.6) CPTORC = 'Y'                              OUTNOD........9600
            IF (J5COL(M).EQ.7) CPSATU = 'Y'                              OUTNOD........9700
    8    CONTINUE                                                        OUTNOD........9800
         IF (ISSTRA.NE.1) THEN                                           OUTNOD........9900
            KT = KT + 1                                                  OUTNOD.......10000
            TT(KT) = TS                                                  OUTNOD.......10100
            ITT(KT) = JT                                                 OUTNOD.......10200
            ISHORP(KT) = 0                                               OUTNOD.......10300
            ISTORC(KT) = 0                                               OUTNOD.......10400
            ISSATU(KT) = 0                                               OUTNOD.......10500
         END IF                                                          OUTNOD.......10600
         DENTS => SCHDLS(ISCHTS)%SLIST                                   OUTNOD.......10700
         DO 10 JT=1,ITMAX                                                OUTNOD.......10800
            DENTS => DENTS%NENT                                          OUTNOD.......10900
            TS = DENTS%DVALU1                                            OUTNOD.......11000
            IF (MOD(JT,NPCYC).EQ.0 .OR. BCSFL(JT) .OR. JT.EQ.1)          OUTNOD.......11100
     1         LCHORP = JT                                               OUTNOD.......11200
            IF (MOD(JT,NUCYC).EQ.0 .OR. BCSTR(JT) .OR. JT.EQ.1)          OUTNOD.......11300
     1         LCTORC = JT                                               OUTNOD.......11400
            IF (MOD(JT,NCOLPR).EQ.0 .OR. JT.EQ.ITRST .OR.                OUTNOD.......11500
     1         ((JT.EQ.ITRST+1).AND.((ISSTRA.NE.0).OR.(NCOLPR.GT.0))))   OUTNOD.......11600
     2         THEN                                                      OUTNOD.......11700
               KT = KT + 1                                               OUTNOD.......11800
               TT(KT) = TS                                               OUTNOD.......11900
               ITT(KT) = JT                                              OUTNOD.......12000
               ISHORP(KT) = LCHORP                                       OUTNOD.......12100
               ISTORC(KT) = LCTORC                                       OUTNOD.......12200
               ISSATU(KT) = LCHORP                                       OUTNOD.......12300
            ENDIF                                                        OUTNOD.......12400
   10    CONTINUE                                                        OUTNOD.......12500
         IF (ISSTRA.EQ.1) THEN                                           OUTNOD.......12600
            TT(KT) = TSTART                                              OUTNOD.......12700
            ITT(KT) = 0                                                  OUTNOD.......12800
         END IF                                                          OUTNOD.......12900
C                                                                        OUTNOD.......13000
C                                                                        OUTNOD.......13100
C........PRINT LAST TIME STEP ALWAYS, UNLESS ALREADY PRINTED             OUTNOD.......13200
         IF(ITMAX.GT.1 .AND. MOD(ITMAX,NCOLPR).NE.0) THEN                OUTNOD.......13300
            KT = KT + 1                                                  OUTNOD.......13400
            TT(KT) = TS                                                  OUTNOD.......13500
            ITT(KT) = ITMAX                                              OUTNOD.......13600
            IF (MOD(ITMAX,NPCYC).EQ.0 .OR. BCSFL(ITMAX)) LCHORP = ITMAX  OUTNOD.......13700
            IF (MOD(ITMAX,NUCYC).EQ.0 .OR. BCSTR(ITMAX)) LCTORC = ITMAX  OUTNOD.......13800
            ISHORP(KT) = LCHORP                                          OUTNOD.......13900
            ISTORC(KT) = LCTORC                                          OUTNOD.......14000
            ISSATU(KT) = LCHORP                                          OUTNOD.......14100
         ENDIF                                                           OUTNOD.......14200
C                                                                        OUTNOD.......14300
C........IF STEADY-STATE FLOW, P AND S CALCULATED ON TIME STEP 0 ONLY.   OUTNOD.......14400
         IF (ISSFLO.NE.0) THEN                                           OUTNOD.......14500
            DO 14 KT=1,KTMAX                                             OUTNOD.......14600
               ISHORP(KT) = 0                                            OUTNOD.......14700
               ISSATU(KT) = 0                                            OUTNOD.......14800
   14       CONTINUE                                                     OUTNOD.......14900
         END IF                                                          OUTNOD.......15000
C                                                                        OUTNOD.......15100
C........COMPUTE ACTUAL NUMBER OF PRINTED TIME STEPS, KTPRN; LESS THAN   OUTNOD.......15200
C           KTMAX IF RUN IS A RESTART                                    OUTNOD.......15300
         IF (IREAD.EQ.+1) THEN                                           OUTNOD.......15400
            KTPRN = KTMAX                                                OUTNOD.......15500
         ELSE                                                            OUTNOD.......15600
            KTPRN = 0                                                    OUTNOD.......15700
            DO 17 KT=1,KTMAX                                             OUTNOD.......15800
               IF (ITT(KT).GE.ITRST) KTPRN = KTPRN + 1                   OUTNOD.......15900
   17       CONTINUE                                                     OUTNOD.......16000
         END IF                                                          OUTNOD.......16100
C                                                                        OUTNOD.......16200
C........SET TEMPERATURE OR CONCENTRATION TEXT STRING FOR HEADER         OUTNOD.......16300
         IF (ME .GT. 0) THEN                                             OUTNOD.......16400
            TORC = "Temperature  "                                       OUTNOD.......16500
            COLTK5(6) = "    Temperature"                                OUTNOD.......16600
         ELSE                                                            OUTNOD.......16700
            TORC = "Concentration"                                       OUTNOD.......16800
         ENDIF                                                           OUTNOD.......16900
C                                                                        OUTNOD.......17000
C........SET PRESSURE TEXT STRING FOR HEADER                             OUTNOD.......17100
         HORP = "Pressure"                                               OUTNOD.......17200
C                                                                        OUTNOD.......17300
C........WRITE HEADER INFORMATION                                        OUTNOD.......17400
         WRITE(K5,950) TITLE1, TITLE2                                    OUTNOD.......17500
         IF (KTYPE(2).GT.1) THEN                                         OUTNOD.......17600
            IF (KTYPE(2).EQ.3) THEN                                      OUTNOD.......17700
               CTYPE2 = "BLOCKWISE MESH"                                 OUTNOD.......17800
            ELSE                                                         OUTNOD.......17900
               CTYPE2 = "REGULAR MESH  "                                 OUTNOD.......18000
            END IF                                                       OUTNOD.......18100
            IF (KTYPE(1).EQ.3) THEN                                      OUTNOD.......18200
               WRITE(K5,951) KTYPE(1),CTYPE2,NN1,NN2,NN3,NN," Nodes",    OUTNOD.......18300
     1            NE, " Elems"                                           OUTNOD.......18400
            ELSE                                                         OUTNOD.......18500
               WRITE(K5,952) KTYPE(1),CTYPE2,NN1,NN2,NN," Nodes",        OUTNOD.......18600
     1            NE, " Elems"                                           OUTNOD.......18700
            END IF                                                       OUTNOD.......18800
         ELSE IF (KTYPE(2).EQ.1) THEN                                    OUTNOD.......18900
            WRITE(K5,953) KTYPE(1), LAYSTR(1:6), NLAYS, NNLAY,           OUTNOD.......19000
     1         NN, " Nodes", NE, " Elems"                                OUTNOD.......19100
         ELSE                                                            OUTNOD.......19200
            WRITE(K5,954) KTYPE(1), NN, " Nodes", NE, " Elems"           OUTNOD.......19300
         END IF                                                          OUTNOD.......19400
         WRITE(K5,960) "NODEWISE RESULTS",                               OUTNOD.......19500
     1      KTPRN, HORP, TORC, "Sat"                                     OUTNOD.......19600
         DO 920 KT=1,KTMAX                                               OUTNOD.......19700
            IF (ITT(KT).GE.ITRST)                                        OUTNOD.......19800
     1         WRITE(K5,961) ITT(KT), TT(KT), CPHORP, ISHORP(KT),        OUTNOD.......19900
     2         CPTORC, ISTORC(KT), CPSATU, ISSATU(KT)                    OUTNOD.......20000
  920    CONTINUE                                                        OUTNOD.......20100
  950    FORMAT("## ", 80A1,                                             OUTNOD.......20200
     1         /"## ", 80A1,                                             OUTNOD.......20300
     2         /"## ")                                                   OUTNOD.......20400
  951    FORMAT("## ", I1, "-D, ", A, 2X,                                OUTNOD.......20500
     1                 "(", 2(I9, ")*("), I9, ") = ", I9, A, 1X,         OUTNOD.......20600
     2                 "(", I9, A, ")"                                   OUTNOD.......20700
     3         /"## ")                                                   OUTNOD.......20800
  952    FORMAT("## ", I1, "-D, ", A, 14X,                               OUTNOD.......20900
     1                 "(", I9, ")*(", I9, ") = ", I9, A, 1X,            OUTNOD.......21000
     2                 "(", I9, A, ")"                                   OUTNOD.......21100
     3         /"## ")                                                   OUTNOD.......21200
  953    FORMAT("## ", I1, "-D, LAYERED MESH [", A6, "]", 7X,            OUTNOD.......21300
     1                 "(", I9, ")*(", I9, ") = ", I9, A, 1X,            OUTNOD.......21400
     2                 "(", I9, A, ")"                                   OUTNOD.......21500
     3         /"## ")                                                   OUTNOD.......21600
  954    FORMAT("## ", I1, "-D, IRREGULAR MESH", 40X, I9, A, 1X,         OUTNOD.......21700
     1                 "(", I9, A, ")"                                   OUTNOD.......21800
     2         /"## ")                                                   OUTNOD.......21900
  960    FORMAT("## ", 92("="),                                          OUTNOD.......22000
     1         /"## ", A, 48X, I9, " Time steps printed",                OUTNOD.......22100
     2         /"## ", 92("="),                                          OUTNOD.......22200
     3         /"## ",                                                   OUTNOD.......22300
     4         /"## ", 4X, "Time steps", 23X,                            OUTNOD.......22400
     5                 "[Printed? / Latest time step computed]",         OUTNOD.......22500
     6         /"## ", 3X, "in this file      Time (sec)", 9X,A5,        OUTNOD.......22600
     7                 10X,A4, 11X,A3,                                   OUTNOD.......22700
     8         /"## ", 2X, 14("-"), 3X, 13("-"), 1X, 3(3X, 12("-")) )    OUTNOD.......22800
  961    FORMAT ("## ", 7X, I8, 4X, 1PE13.6, 3(5X, A1, 1X, I8))          OUTNOD.......22900
C                                                                        OUTNOD.......23000
C........DEALLOCATE LOCAL ARRAYS.                                        OUTNOD.......23100
         DEALLOCATE(TT,ITT,ISTORC,ISHORP,ISSATU)                         OUTNOD.......23200
C                                                                        OUTNOD.......23300
         ONCEK5 = .TRUE.                                                 OUTNOD.......23400
      ENDIF                                                              OUTNOD.......23500
C                                                                        OUTNOD.......23600
C.....NODEWISE HEADER INFORMATION REPEATED BEFORE EACH TIME STEP         OUTNOD.......23700
      IF ((IT.EQ.0).OR.((IT.EQ.1).AND.(ISSTRA.EQ.1))) THEN               OUTNOD.......23800
         DURN = 0D0                                                      OUTNOD.......23900
         TOUT = TSTART                                                   OUTNOD.......24000
         ITOUT = 0                                                       OUTNOD.......24100
      ELSE                                                               OUTNOD.......24200
         DURN = DELT                                                     OUTNOD.......24300
         TOUT = TSEC                                                     OUTNOD.......24400
         ITOUT = IT                                                      OUTNOD.......24500
      END IF                                                             OUTNOD.......24600
      WRITE(K5,966) ITOUT, DURN, TOUT                                    OUTNOD.......24700
  966 FORMAT('## ',                                                      OUTNOD.......24800
     1      /'## ', 92('='),                                             OUTNOD.......24900
     2      /'## TIME STEP ', I8, 22X, 'Duration: ', 1PE11.4, ' sec',    OUTNOD.......25000
     3                            6X, 'Time: ', 1PE11.4, ' sec',         OUTNOD.......25100
     4      /'## ', 92('='))                                             OUTNOD.......25200
      PRINTN = (J5COL(1).EQ.1)                                           OUTNOD.......25300
      IF (PRINTN) THEN                                                   OUTNOD.......25400
         WRITE(K5,968) (COLTK5(J5COL(M)), M=1,NCOLS5)                    OUTNOD.......25500
968    FORMAT ("## ", 2X, A4, 2(A15),3(A15),1X,"SOLID MASS(KG)"
     1, 7X,"POROSITY",7X,"MASS(KG)",5X,"SOLUTE(KG)",10X,"DSWDP",11X,
     2"TEMP")
C  968    FORMAT ("## ", 2X, A4, 19(A15))                                 OUTNOD.......25600
      ELSE                                                               OUTNOD.......25700
         WRITE(K5,969) COLTK5(J5COL(1))(3:15),                           OUTNOD.......25800
     1      (COLTK5(J5COL(M)), M=2,NCOLS5)                               OUTNOD.......25900
  969    FORMAT ("## ", A13, 19(A15))                                    OUTNOD.......26000
      END IF                                                             OUTNOD.......26100
C                                                                        OUTNOD.......26200
C.....NODEWISE DATA FOR THIS TIME STEP                                   OUTNOD.......26300
      DO 978 I=1,NN                                                      OUTNOD.......26400
         VVAR(1) = DBLE(I)                                               OUTNOD.......26500
         VVAR(2) = X(I)                                                  OUTNOD.......26600
         VVAR(3) = Y(I)                                                  OUTNOD.......26700
         VVAR(4) = Z(I)                                                  OUTNOD.......26800
         VVAR(5) = PVEC(I)                                               OUTNOD.......26900
         VVAR(6) = UVEC(I)                                               OUTNOD.......27000
         VVAR(7) = SW(I)                                                 OUTNOD.......27100
         DO 972 M=1,NCOLS5                                               OUTNOD.......27200
            VCOL(M) = VVAR(J5COL(M))                                     OUTNOD.......27300
  972    CONTINUE                                                        OUTNOD.......27400
         IF (PRINTN) THEN                                                OUTNOD.......27500
C            WRITE(K5,975) I,(CUTSML(VCOL(M)), M=2,NCOLS5)                OUTNOD.......27600
C  975       FORMAT (I9, 19(1PE15.7))                                     OUTNOD.......27700
      WRITE(K5,975) I,(CUTSML(VCOL(M)), M=2,NCOLS5),SM(I),POR1(I)
     1       ,WMA(I),SMA(I),DSWDP(I),TPT(I)
C975       FORMAT (I9, 19(1PE15.7))
975       FORMAT (I9, 2(1PE15.7),10(1PE15.7))
         ELSE                                                            OUTNOD.......27800
            WRITE(K5,976) (CUTSML(VCOL(M)), M=1,NCOLS5)                  OUTNOD.......27900
  976       FORMAT (1X, 20(1PE15.7))                                     OUTNOD.......28000
         END IF                                                          OUTNOD.......28100
  978 CONTINUE                                                           OUTNOD.......28200
C                                                                        OUTNOD.......28300
      RETURN                                                             OUTNOD.......28400
C                                                                        OUTNOD.......28500
      END                                                                OUTNOD.......28600
C                                                                        OUTNOD.......28700
C     SUBROUTINE        O  U  T  O  B  C           SUTRA VERSION 2.2     OUTOBC.........100
C                                                                        OUTOBC.........200
C *** PURPOSE :                                                          OUTOBC.........300
C ***  TO PRINT THE SOLUTION AT OBSERVATION POINTS.  SPECIFICALLY,       OUTOBC.........400
C ***  TO PRINT PRESSURES, CONCENTRATIONS OR TEMPERATURES, AND           OUTOBC.........500
C ***  SATURATIONS IN A COLUMNWISE FORMAT SIMILAR TO THAT USED IN THE    OUTOBC.........600
C ***  NODEWISE AND ELEMENTWISE OUTPUT FILES.                            OUTOBC.........700
C                                                                        OUTOBC.........800
      SUBROUTINE OUTOBC(NFLO,OBSPTS,TIME,STEP,PM1,UM1,PVEC,UVEC,         OUTOBC.........900
     1   TITLE1,TITLE2,IN,LREG,BCSFL,BCSTR)                              OUTOBC........1000
      USE ALLARR, ONLY : OBSDAT                                          OUTOBC........1100
      USE LLDEF                                                          OUTOBC........1200
      USE EXPINT                                                         OUTOBC........1300
      USE SCHDEF                                                         OUTOBC........1400
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                OUTOBC........1500
      CHARACTER*1  TITLE1(80),TITLE2(80)                                 OUTOBC........1600
      CHARACTER*8  HORP                                                  OUTOBC........1700
      CHARACTER*13 TORC1,TORC2                                           OUTOBC........1800
      CHARACTER*15 COLTK8(7)                                             OUTOBC........1900
      CHARACTER*14 CTYPE2                                                OUTOBC........2000
      CHARACTER*80 UNAME,FNAME(0:13)                                     OUTOBC........2100
      CHARACTER*40 OBSNM, BLANKS                                         OUTOBC........2200
      CHARACTER*80 LAYSTR                                                OUTOBC........2300
      LOGICAL ONCEK5,ONCEK6,ONCEK7,ONCEK8                                OUTOBC........2400
      LOGICAL IMPRTD                                                     OUTOBC........2500
      LOGICAL BCSFL(0:ITMAX),BCSTR(0:ITMAX)                              OUTOBC........2600
      DIMENSION PM1(NNVEC),UM1(NNVEC),PVEC(NNVEC),UVEC(NNVEC)            OUTOBC........2700
      DIMENSION IN(NIN),LREG(NE)                                         OUTOBC........2800
      DIMENSION KTYPE(2)                                                 OUTOBC........2900
      TYPE (OBSDAT), DIMENSION (NOBSN) :: OBSPTS                         OUTOBC........3000
      ALLOCATABLE TT(:),DITT(:),ISTORC(:),ISHORP(:),ISSATU(:)            OUTOBC........3100
      TYPE (LLD), POINTER :: DENTS, DENOBC                               OUTOBC........3200
      COMMON /CLAY/ LAYSTR                                               OUTOBC........3300
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  OUTOBC........3400
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           OUTOBC........3500
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      OUTOBC........3600
      COMMON /DIMLAY/ NLAYS,NNLAY,NELAY                                  OUTOBC........3700
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              OUTOBC........3800
     1   NSOP,NSOU,NBCN,NCIDB                                            OUTOBC........3900
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        OUTOBC........4000
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA                           OUTOBC........4100
      COMMON /FNAMES/ UNAME,FNAME                                        OUTOBC........4200
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 OUTOBC........4300
     1   K10,K11,K12,K13                                                 OUTOBC........4400
      COMMON /GRAVEC/ GRAVX,GRAVY,GRAVZ                                  OUTOBC........4500
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS      OUTOBC........4600
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                OUTOBC........4700
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            OUTOBC........4800
      COMMON /OBS/ NOBSN,NTOBS,NOBCYC,NOBLIN,NFLOMX                      OUTOBC........4900
      COMMON /PLT1/ ONCEK5,ONCEK6,ONCEK7,ONCEK8                          OUTOBC........5000
      COMMON /SCH/ NSCH,ISCHTS,NSCHAU                                    OUTOBC........5100
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                           OUTOBC........5200
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       OUTOBC........5300
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      OUTOBC........5400
      DATA (COLTK8(MM), MM=1,7) /'Name',                                 OUTOBC........5500
     1   '              X', '              Y', '              Z',        OUTOBC........5600
     2   '       Pressure', '  Concentration', '     Saturation'/        OUTOBC........5700
      DATA BLANKS /"                                        "/           OUTOBC........5800
      SAVE COLTK8                                                        OUTOBC........5900
C                                                                        OUTOBC........6000
C.....CALCULATE HEADERS ON FIRST CALL AND CREATE OUTPUT ON EACH CALL.    OUTOBC........6100
C                                                                        OUTOBC........6200
      NOBS=NOBSN-1                                                       OUTOBC........6300
      DITMAX = DNINT(DBLE(ITMAX))                                        OUTOBC........6400
      DITRST = DNINT(DBLE(ITRST))                                        OUTOBC........6500
C                                                                        OUTOBC........6600
      K8 = IUNIO(NFLO)                                                   OUTOBC........6700
      IF (.NOT. ONCK78(NFLO))  THEN                                      OUTOBC........6800
C.....FIRST CALL FOR THIS FILE -- CREATE FILE HEADER.                    OUTOBC........6900
C                                                                        OUTOBC........7000
C........IF NO OBSERVATION POINTS, WRITE MESSAGE AND RETURN              OUTOBC........7100
         IF (NOBSN-1.EQ.0) THEN                                          OUTOBC........7200
            WRITE(K8,5) TITLE1, TITLE2                                   OUTOBC........7300
    5       FORMAT("## ", 80A1,                                          OUTOBC........7400
     1         /"## ", 80A1,                                             OUTOBC........7500
     2         /"## ")                                                   OUTOBC........7600
            WRITE(K8,7)                                                  OUTOBC........7700
    7       FORMAT(/'  *** NO OBSERVATION POINTS SPECIFIED ',            OUTOBC........7800
     1         '(NOBS=0) ***')                                           OUTOBC........7900
            ONCK78(NFLO) = .TRUE.                                        OUTOBC........8000
            ONCEK8 = .TRUE.                                              OUTOBC........8100
            RETURN                                                       OUTOBC........8200
         END IF                                                          OUTOBC........8300
C                                                                        OUTOBC........8400
C........CALCULATE THE MAXIMUM NUMBER OF TIME STEPS, KTMAX.              OUTOBC........8500
         IF (ISSTRA.NE.0) THEN                                           OUTOBC........8600
            KTMAX = 1                                                    OUTOBC........8700
            IMPRTD = .TRUE.                                              OUTOBC........8800
         ELSE                                                            OUTOBC........8900
            KTMAX = 2                                                    OUTOBC........9000
            IMPRTD = .FALSE.                                             OUTOBC........9100
            LENSCH = SCHDLS(OFP(NFLO)%ISCHED)%LLEN                       OUTOBC........9200
            IF (LENSCH.NE.0) THEN                                        OUTOBC........9300
               DENOBC => SCHDLS(OFP(NFLO)%ISCHED)%SLIST                  OUTOBC........9400
               KTMAX = KTMAX + 1                                         OUTOBC........9500
               SOB = DENOBC%DVALU2                                       OUTOBC........9600
               IF (SOB.EQ.DITRST) KTMAX = KTMAX - 1                      OUTOBC........9700
               DO 4 JT=2,LENSCH                                          OUTOBC........9800
                  DENOBC => DENOBC%NENT                                  OUTOBC........9900
                  KTMAX = KTMAX + 1                                      OUTOBC.......10000
    4          CONTINUE                                                  OUTOBC.......10100
               SOB = DENOBC%DVALU2                                       OUTOBC.......10200
               IF (SOB.EQ.DITMAX) THEN                                   OUTOBC.......10300
                  KTMAX = KTMAX - 1                                      OUTOBC.......10400
                  IMPRTD = .TRUE.                                        OUTOBC.......10500
               END IF                                                    OUTOBC.......10600
            END IF                                                       OUTOBC.......10700
         END IF                                                          OUTOBC.......10800
C                                                                        OUTOBC.......10900
C........ALLOCATE LOCAL ARRAYS                                           OUTOBC.......11000
         ALLOCATE(TT(KTMAX),DITT(KTMAX))                                 OUTOBC.......11100
         ALLOCATE(ISTORC(KTMAX),ISHORP(KTMAX),ISSATU(KTMAX))             OUTOBC.......11200
C                                                                        OUTOBC.......11300
C........CALCULATE AND PRINT TIME STEP INFORMATION                       OUTOBC.......11400
         IF (ISSTRA.NE.0) THEN                                           OUTOBC.......11500
            KT = 1                                                       OUTOBC.......11600
            TT(KT) = TSTART                                              OUTOBC.......11700
            DITT(KT) = 1                                                 OUTOBC.......11800
            ISHORP(KT) = 0                                               OUTOBC.......11900
            ISTORC(KT) = 1                                               OUTOBC.......12000
            ISSATU(KT) = 0                                               OUTOBC.......12100
         ELSE                                                            OUTOBC.......12200
C...........NUMBER OF PRINTED TIME STEPS                                 OUTOBC.......12300
            KT=0                                                         OUTOBC.......12400
C...........TIME STEP INCREMENT                                          OUTOBC.......12500
            DELTK=DELT                                                   OUTOBC.......12600
C...........POINTERS TO TIME STEP AND OBSERVATIONS SCHEDULES             OUTOBC.......12700
            DENTS => SCHDLS(ISCHTS)%SLIST                                OUTOBC.......12800
            DENOBC => SCHDLS(OFP(NFLO)%ISCHED)%SLIST                     OUTOBC.......12900
            LCNT = 1                                                     OUTOBC.......13000
C...........OBSERVATION TIME AND STEP                                    OUTOBC.......13100
            TOB = DENOBC%DVALU1                                          OUTOBC.......13200
            SOB = DENOBC%DVALU2                                          OUTOBC.......13300
C...........INDICATORS OF WHEN VARIABLES ARE CALCULATED AND PRINTED      OUTOBC.......13400
            LCHORP = 0                                                   OUTOBC.......13500
            LCTORC = 0                                                   OUTOBC.......13600
C...........INITIAL/STARTING CONDITIONS ARE PRINTED                      OUTOBC.......13700
            IF (ITRST.GT.0) THEN                                         OUTOBC.......13800
               DO 3 JT=1,ITRST                                           OUTOBC.......13900
                  DENTS => DENTS%NENT                                    OUTOBC.......14000
                  IF (MOD(JT,NPCYC).EQ.0 .OR. BCSFL(JT) .OR. JT.EQ.1)    OUTOBC.......14100
     1               LCHORP = JT                                         OUTOBC.......14200
                  IF (MOD(JT,NUCYC).EQ.0 .OR. BCSTR(JT) .OR. JT.EQ.1)    OUTOBC.......14300
     1               LCTORC = JT                                         OUTOBC.......14400
    3          CONTINUE                                                  OUTOBC.......14500
            END IF                                                       OUTOBC.......14600
            TJT = DENTS%DVALU1                                           OUTOBC.......14700
            SJT = DENTS%DVALU2                                           OUTOBC.......14800
            DO WHILE ((SOB.LT.SJT).AND.(LCNT.LT.LENSCH))                 OUTOBC.......14900
               DENOBC => DENOBC%NENT                                     OUTOBC.......15000
               TOB = DENOBC%DVALU1                                       OUTOBC.......15100
               SOB = DENOBC%DVALU2                                       OUTOBC.......15200
               LCNT = LCNT + 1                                           OUTOBC.......15300
            END DO                                                       OUTOBC.......15400
            KT = KT + 1                                                  OUTOBC.......15500
            TT(KT) = TJT                                                 OUTOBC.......15600
            DITT(KT) = SJT                                               OUTOBC.......15700
            ISHORP(KT) = LCHORP                                          OUTOBC.......15800
            ISTORC(KT) = LCTORC                                          OUTOBC.......15900
            ISSATU(KT) = LCHORP                                          OUTOBC.......16000
            IF ((SOB.EQ.SJT).AND.(LCNT.LT.LENSCH)) THEN                  OUTOBC.......16100
               DENOBC => DENOBC%NENT                                     OUTOBC.......16200
               TOB = DENOBC%DVALU1                                       OUTOBC.......16300
               SOB = DENOBC%DVALU2                                       OUTOBC.......16400
               LCNT = LCNT + 1                                           OUTOBC.......16500
            END IF                                                       OUTOBC.......16600
C...........IDENTIFY AND RECORD SCHEDULED OUTPUT                         OUTOBC.......16700
            DO 10 JT=ITRST+1,ITMAX                                       OUTOBC.......16800
               DJT = DNINT(DBLE(JT))                                     OUTOBC.......16900
               DENTS => DENTS%NENT                                       OUTOBC.......17000
               TJT = DENTS%DVALU1                                        OUTOBC.......17100
               SJT = DENTS%DVALU2                                        OUTOBC.......17200
               IF (MOD(JT,NPCYC).EQ.0 .OR. BCSFL(JT) .OR. JT.EQ.1)       OUTOBC.......17300
     1            LCHORP = JT                                            OUTOBC.......17400
               IF (MOD(JT,NUCYC).EQ.0 .OR. BCSTR(JT) .OR. JT.EQ.1)       OUTOBC.......17500
     1            LCTORC = JT                                            OUTOBC.......17600
               DO WHILE ((SOB.LE.DJT).AND.(LCNT.LE.LENSCH))              OUTOBC.......17700
                  KT = KT + 1                                            OUTOBC.......17800
                  TT(KT) = TOB                                           OUTOBC.......17900
                  DITT(KT) = SOB                                         OUTOBC.......18000
                  ISHORP(KT) = LCHORP                                    OUTOBC.......18100
                  ISTORC(KT) = LCTORC                                    OUTOBC.......18200
                  ISSATU(KT) = LCHORP                                    OUTOBC.......18300
                  IF (LCNT.LT.LENSCH) THEN                               OUTOBC.......18400
                     DENOBC => DENOBC%NENT                               OUTOBC.......18500
                     TOB = DENOBC%DVALU1                                 OUTOBC.......18600
                     SOB = DENOBC%DVALU2                                 OUTOBC.......18700
                  END IF                                                 OUTOBC.......18800
                  LCNT = LCNT + 1                                        OUTOBC.......18900
               END DO                                                    OUTOBC.......19000
   10       CONTINUE                                                     OUTOBC.......19100
         END IF                                                          OUTOBC.......19200
C                                                                        OUTOBC.......19300
C                                                                        OUTOBC.......19400
C........PRINT LAST TIME STEP ALWAYS, UNLESS ALREADY PRINTED             OUTOBC.......19500
         IF (.NOT.IMPRTD) THEN                                           OUTOBC.......19600
            KT = KT + 1                                                  OUTOBC.......19700
            TT(KT) = TJT                                                 OUTOBC.......19800
            DITT(KT) = SJT                                               OUTOBC.......19900
            IF (MOD(JT,NPCYC).EQ.0 .OR. BCSFL(JT)) LCHORP = ITMAX        OUTOBC.......20000
            IF (MOD(JT,NUCYC).EQ.0 .OR. BCSTR(JT)) LCTORC = ITMAX        OUTOBC.......20100
            ISHORP(KT) = LCHORP                                          OUTOBC.......20200
            ISTORC(KT) = LCTORC                                          OUTOBC.......20300
            ISSATU(KT) = LCHORP                                          OUTOBC.......20400
         ENDIF                                                           OUTOBC.......20500
C                                                                        OUTOBC.......20600
C........IF STEADY-STATE FLOW, P AND S CALCULATED ON TIME STEP 0 ONLY.   OUTOBC.......20700
         IF (ISSFLO.NE.0) THEN                                           OUTOBC.......20800
            DO 14 KT=1,KTMAX                                             OUTOBC.......20900
               ISHORP(KT) = 0                                            OUTOBC.......21000
               ISSATU(KT) = 0                                            OUTOBC.......21100
   14       CONTINUE                                                     OUTOBC.......21200
         END IF                                                          OUTOBC.......21300
C                                                                        OUTOBC.......21400
C........COMPUTE ACTUAL NUMBER OF PRINTED TIME STEPS, KTPRN; LESS THAN   OUTOBC.......21500
C           KTMAX IF RUN IS A RESTART                                    OUTOBC.......21600
         IF (IREAD.EQ.+1) THEN                                           OUTOBC.......21700
            KTPRN = KTMAX                                                OUTOBC.......21800
         ELSE                                                            OUTOBC.......21900
            KTPRN = 0                                                    OUTOBC.......22000
            DO 17 KT=1,KTMAX                                             OUTOBC.......22100
               IF (DITT(KT).GE.DITRST) KTPRN = KTPRN + 1                 OUTOBC.......22200
   17       CONTINUE                                                     OUTOBC.......22300
         END IF                                                          OUTOBC.......22400
C                                                                        OUTOBC.......22500
C........SET TEMPERATURE OR CONCENTRATION TEXT STRING FOR HEADER         OUTOBC.......22600
         IF (ME .GT. 0) THEN                                             OUTOBC.......22700
            TORC1 = "Temperature  "                                      OUTOBC.......22800
            TORC2 = "  Temperature"                                      OUTOBC.......22900
         ELSE                                                            OUTOBC.......23000
            TORC1 = "Concentration"                                      OUTOBC.......23100
            TORC2 = "Concentration"                                      OUTOBC.......23200
         ENDIF                                                           OUTOBC.......23300
C                                                                        OUTOBC.......23400
C........SET PRESSURE TEXT STRING FOR HEADER                             OUTOBC.......23500
         HORP = "Pressure"                                               OUTOBC.......23600
C                                                                        OUTOBC.......23700
C........WRITE HEADER INFORMATION                                        OUTOBC.......23800
         WRITE(K8,5) TITLE1, TITLE2                                      OUTOBC.......23900
         IF (KTYPE(2).GT.1) THEN                                         OUTOBC.......24000
            IF (KTYPE(2).EQ.3) THEN                                      OUTOBC.......24100
               CTYPE2 = "BLOCKWISE MESH"                                 OUTOBC.......24200
            ELSE                                                         OUTOBC.......24300
               CTYPE2 = "REGULAR MESH  "                                 OUTOBC.......24400
            END IF                                                       OUTOBC.......24500
            IF (KTYPE(1).EQ.3) THEN                                      OUTOBC.......24600
               WRITE(K8,951) KTYPE(1),CTYPE2,NN1,NN2,NN3,NN," Nodes",    OUTOBC.......24700
     1            NE, " Elems"                                           OUTOBC.......24800
            ELSE                                                         OUTOBC.......24900
               WRITE(K8,952) KTYPE(1),CTYPE2,NN1,NN2,NN," Nodes",        OUTOBC.......25000
     1            NE, " Elems"                                           OUTOBC.......25100
            END IF                                                       OUTOBC.......25200
         ELSE IF (KTYPE(2).EQ.1) THEN                                    OUTOBC.......25300
            WRITE(K8,953) KTYPE(1), LAYSTR(1:6), NLAYS, NNLAY,           OUTOBC.......25400
     1         NN, " Nodes", NE, " Elems"                                OUTOBC.......25500
         ELSE                                                            OUTOBC.......25600
            WRITE(K8,954) KTYPE(1), NN, " Nodes", NE, " Elems"           OUTOBC.......25700
         END IF                                                          OUTOBC.......25800
         WRITE(K8,960) "OBSERVATION POINT RESULTS",KTPRN                 OUTOBC.......25900
         WRITE(K8,962) HORP, TORC1, "Sat"                                OUTOBC.......26000
         DO 920 KT=1,KTMAX                                               OUTOBC.......26100
            IF (DITT(KT).GE.DITRST)                                      OUTOBC.......26200
     1         WRITE(K8,963) DITT(KT), TT(KT), ISHORP(KT),               OUTOBC.......26300
     2         ISTORC(KT), ISSATU(KT)                                    OUTOBC.......26400
  920    CONTINUE                                                        OUTOBC.......26500
  951    FORMAT("## ", I1, "-D, ", A, 2X,                                OUTOBC.......26600
     1                 "(", 2(I9, ")*("), I9, ") = ", I9, A, 1X,         OUTOBC.......26700
     2                 "(", I9, A, ")"                                   OUTOBC.......26800
     3         /"## ")                                                   OUTOBC.......26900
  952    FORMAT("## ", I1, "-D, ", A, 14X,                               OUTOBC.......27000
     1                 "(", I9, ")*(", I9, ") = ", I9, A, 1X,            OUTOBC.......27100
     2                 "(", I9, A, ")"                                   OUTOBC.......27200
     3         /"## ")                                                   OUTOBC.......27300
  953    FORMAT("## ", I1, "-D, LAYERED MESH [", A6, "]", 7X,            OUTOBC.......27400
     1                 "(", I9, ")*(", I9, ") = ", I9, A, 1X,            OUTOBC.......27500
     2                 "(", I9, A, ")"                                   OUTOBC.......27600
     3         /"## ")                                                   OUTOBC.......27700
  954    FORMAT("## ", I1, "-D, IRREGULAR MESH", 40X, I9, A, 1X,         OUTOBC.......27800
     1                 "(", I9, A, ")"                                   OUTOBC.......27900
     2         /"## ")                                                   OUTOBC.......28000
  960    FORMAT("## ", 92("="),                                          OUTOBC.......28100
     1         /"## ", A, 39X, I9, " Time steps printed",                OUTOBC.......28200
     2         /"## ", 92("="))                                          OUTOBC.......28300
  962    FORMAT("## ",                                                   OUTOBC.......28400
     1         /"## ", 4X, "Time steps", 29X,                            OUTOBC.......28500
     2                 "[Latest time step computed]",                    OUTOBC.......28600
     3         /"## ", 3X, "in this file      Time (sec)", 9X,A5,        OUTOBC.......28700
     4                 10X,A4, 11X,A3,                                   OUTOBC.......28800
     5         /"## ", 2X, 14("-"), 3X, 13("-"), 1X, 3(3X, 12("-")) )    OUTOBC.......28900
  963    FORMAT("## ", 1X, F15.5, 3X, 1PE13.6, 3(7X, I8))                OUTOBC.......29000
C                                                                        OUTOBC.......29100
C........DEALLOCATE LOCAL ARRAYS.                                        OUTOBC.......29200
         DEALLOCATE(TT,DITT,ISTORC,ISHORP,ISSATU)                        OUTOBC.......29300
C                                                                        OUTOBC.......29400
         ONCK78(NFLO) = .TRUE.                                           OUTOBC.......29500
         ONCEK8 = .TRUE.                                                 OUTOBC.......29600
      ENDIF                                                              OUTOBC.......29700
C                                                                        OUTOBC.......29800
C.....IF NO OBSERVATIONS, RETURN.                                        OUTOBC.......29900
      IF (NOBSN-1.EQ.0) RETURN                                           OUTOBC.......30000
C                                                                        OUTOBC.......30100
C.....HEADER INFORMATION REPEATED BEFORE EACH TIME STEP                  OUTOBC.......30200
      SFRAC = STEP - CEILING(STEP) + 1D0                                 OUTOBC.......30300
      IF ((STEP.EQ.0D0).OR.((STEP.EQ.1D0).AND.(ISSTRA.EQ.1))) THEN       OUTOBC.......30400
         TOUT = TSTART                                                   OUTOBC.......30500
      ELSE                                                               OUTOBC.......30600
         TOUT = TIME                                                     OUTOBC.......30700
      END IF                                                             OUTOBC.......30800
      IF (KTYPE(1).EQ.3) THEN                                            OUTOBC.......30900
         WRITE(K8,966) STEP,  TOUT                                       OUTOBC.......31000
      ELSE                                                               OUTOBC.......31100
         WRITE(K8,967) STEP,  TOUT                                       OUTOBC.......31200
      END IF                                                             OUTOBC.......31300
  966 FORMAT('## ',                                                      OUTOBC.......31400
     1      /'## ', 129('='),                                            OUTOBC.......31500
     2      /'## TIME STEP ', F15.5, 83X, 'Time: ', 1PE11.4, ' sec',     OUTOBC.......31600
     3      /'## ', 129('='))                                            OUTOBC.......31700
  967 FORMAT('## ',                                                      OUTOBC.......31800
     1      /'## ', 114('='),                                            OUTOBC.......31900
     2      /'## TIME STEP ', F15.5, 68X, 'Time: ', 1PE11.4, ' sec',     OUTOBC.......32000
     3      /'## ', 114('='))                                            OUTOBC.......32100
      KCONT = 7 - KTYPE(1)                                               OUTOBC.......32200
      WRITE(K8,968) (COLTK8(K),K=1,3),(COLTK8(K),K=KCONT,7)              OUTOBC.......32300
  968 FORMAT ("## ", 33X, A4, 2X, 6(A15))                                OUTOBC.......32400
C                                                                        OUTOBC.......32500
C.....WRITE OBSERVATIONS FOR THIS TIME STEP.                             OUTOBC.......32600
      IF (KTYPE(1).EQ.3) THEN                                            OUTOBC.......32700
         DO 1010 JJ=1,NOBS                                               OUTOBC.......32800
            IF ((OBSPTS(JJ)%FRMT.EQ."OBC").AND.                          OUTOBC.......32900
     1         (OBSPTS(JJ)%SCHED.EQ.SCHDLS(OFP(NFLO)%ISCHED)%NAME))      OUTOBC.......33000
     2         THEN                                                      OUTOBC.......33100
               LENNAM = LEN_TRIM(OBSPTS(JJ)%NAME)                        OUTOBC.......33200
               OBSNM = BLANKS(1:40-LENNAM) // TRIM(OBSPTS(JJ)%NAME)      OUTOBC.......33300
               WRITE(K8,1000) OBSNM, OBSPTS(JJ)%X, OBSPTS(JJ)%Y,         OUTOBC.......33400
     1            OBSPTS(JJ)%Z, DP3STR(PUSWF(OBSPTS(JJ)%L,               OUTOBC.......33500
     2            OBSPTS(JJ)%XSI,OBSPTS(JJ)%ETA,OBSPTS(JJ)%ZET,SFRAC,    OUTOBC.......33600
     3            PM1,UM1,PVEC,UVEC,IN,LREG))                            OUTOBC.......33700
 1000          FORMAT(A40,2X,3(1PE15.7),A45)                             OUTOBC.......33800
            END IF                                                       OUTOBC.......33900
 1010    CONTINUE                                                        OUTOBC.......34000
      ELSE                                                               OUTOBC.......34100
         DO 1030 JJ=1,NOBS                                               OUTOBC.......34200
            IF ((OBSPTS(JJ)%FRMT.EQ."OBC").AND.                          OUTOBC.......34300
     1         (OBSPTS(JJ)%SCHED.EQ.SCHDLS(OFP(NFLO)%ISCHED)%NAME))      OUTOBC.......34400
     2         THEN                                                      OUTOBC.......34500
               LENNAM = LEN_TRIM(OBSPTS(JJ)%NAME)                        OUTOBC.......34600
               OBSNM = BLANKS(1:40-LENNAM) // TRIM(OBSPTS(JJ)%NAME)      OUTOBC.......34700
               WRITE(K8,1020) OBSNM, OBSPTS(JJ)%X, OBSPTS(JJ)%Y,         OUTOBC.......34800
     1            DP3STR(PUSWF(OBSPTS(JJ)%L,OBSPTS(JJ)%XSI,              OUTOBC.......34900
     2            OBSPTS(JJ)%ETA,OBSPTS(JJ)%ZET,SFRAC,                   OUTOBC.......35000
     3            PM1,UM1,PVEC,UVEC,IN,LREG))                            OUTOBC.......35100
 1020          FORMAT(A40,2X,2(1PE15.7),A45)                             OUTOBC.......35200
            END IF                                                       OUTOBC.......35300
 1030    CONTINUE                                                        OUTOBC.......35400
      END IF                                                             OUTOBC.......35500
C                                                                        OUTOBC.......35600
C                                                                        OUTOBC.......35700
      RETURN                                                             OUTOBC.......35800
C                                                                        OUTOBC.......35900
      END                                                                OUTOBC.......36000
C                                                                        OUTOBC.......36100
C     SUBROUTINE        O  U  T  O  B  S           SUTRA VERSION 2.2     OUTOBS.........100
C                                                                        OUTOBS.........200
C *** PURPOSE :                                                          OUTOBS.........300
C ***  TO PRINT THE SOLUTION AT OBSERVATION POINTS.  SPECIFICALLY,       OUTOBS.........400
C ***  TO PRINT PRESSURES, CONCENTRATIONS OR TEMPERATURES, AND           OUTOBS.........500
C ***  SATURATIONS IN A COLUMNWISE FORMAT.                               OUTOBS.........600
C                                                                        OUTOBS.........700
      SUBROUTINE OUTOBS(NFLO,OBSPTS,TIME,STEP,PM1,UM1,PVEC,UVEC,         OUTOBS.........800
     1   TITLE1,TITLE2,IN,LREG,BCSFL,BCSTR)                              OUTOBS.........900
      USE ALLARR, ONLY : OBSDAT                                          OUTOBS........1000
      USE LLDEF                                                          OUTOBS........1100
      USE EXPINT                                                         OUTOBS........1200
      USE SCHDEF                                                         OUTOBS........1300
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                OUTOBS........1400
      CHARACTER*1  TITLE1(80),TITLE2(80)                                 OUTOBS........1500
      CHARACTER*8  HORP                                                  OUTOBS........1600
      CHARACTER*13 TORC1,TORC2                                           OUTOBS........1700
      CHARACTER*14 CTYPE2                                                OUTOBS........1800
      CHARACTER*80 UNAME,FNAME(0:13),FRMT,FRMT2                          OUTOBS........1900
      CHARACTER*40 BLANKS                                                OUTOBS........2000
      CHARACTER*80 LAYSTR                                                OUTOBS........2100
      LOGICAL ONCEK5,ONCEK6,ONCEK7,ONCEK8                                OUTOBS........2200
      LOGICAL IMPRTD                                                     OUTOBS........2300
      LOGICAL BCSFL(0:ITMAX),BCSTR(0:ITMAX)                              OUTOBS........2400
      DIMENSION PM1(NNVEC),UM1(NNVEC),PVEC(NNVEC),UVEC(NNVEC)            OUTOBS........2500
      DIMENSION IN(NIN),LREG(NE)                                         OUTOBS........2600
      DIMENSION KTYPE(2)                                                 OUTOBS........2700
      TYPE (OBSDAT), DIMENSION (NOBSN) :: OBSPTS                         OUTOBS........2800
      ALLOCATABLE TT(:),DITT(:),ISTORC(:),ISHORP(:),ISSATU(:)            OUTOBS........2900
      ALLOCATABLE JSET(:)                                                OUTOBS........3000
      TYPE (LLD), POINTER :: DENTS, DENOBS                               OUTOBS........3100
      COMMON /CLAY/ LAYSTR                                               OUTOBS........3200
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  OUTOBS........3300
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           OUTOBS........3400
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      OUTOBS........3500
      COMMON /DIMLAY/ NLAYS,NNLAY,NELAY                                  OUTOBS........3600
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              OUTOBS........3700
     1   NSOP,NSOU,NBCN,NCIDB                                            OUTOBS........3800
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        OUTOBS........3900
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA                           OUTOBS........4000
      COMMON /FNAMES/ UNAME,FNAME                                        OUTOBS........4100
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 OUTOBS........4200
     1   K10,K11,K12,K13                                                 OUTOBS........4300
      COMMON /GRAVEC/ GRAVX,GRAVY,GRAVZ                                  OUTOBS........4400
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS      OUTOBS........4500
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                OUTOBS........4600
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            OUTOBS........4700
      COMMON /OBS/ NOBSN,NTOBS,NOBCYC,NOBLIN,NFLOMX                      OUTOBS........4800
      COMMON /PLT1/ ONCEK5,ONCEK6,ONCEK7,ONCEK8                          OUTOBS........4900
      COMMON /SCH/ NSCH,ISCHTS,NSCHAU                                    OUTOBS........5000
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                           OUTOBS........5100
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       OUTOBS........5200
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      OUTOBS........5300
      DATA BLANKS /"                                        "/           OUTOBS........5400
C                                                                        OUTOBS........5500
C.....CALCULATE HEADERS ON FIRST CALL AND CREATE OUTPUT ON EACH CALL.    OUTOBS........5600
C                                                                        OUTOBS........5700
      NOBS=NOBSN-1                                                       OUTOBS........5800
      DITMAX = DNINT(DBLE(ITMAX))                                        OUTOBS........5900
      DITRST = DNINT(DBLE(ITRST))                                        OUTOBS........6000
C                                                                        OUTOBS........6100
      K7 = IUNIO(NFLO)                                                   OUTOBS........6200
      IF (.NOT. ONCK78(NFLO))  THEN                                      OUTOBS........6300
C.....FIRST CALL FOR THIS FILE -- CREATE FILE HEADER.                    OUTOBS........6400
C                                                                        OUTOBS........6500
C........IF NO OBSERVATION POINTS, WRITE MESSAGE AND RETURN              OUTOBS........6600
         IF (NOBSN-1.EQ.0) THEN                                          OUTOBS........6700
            WRITE(K7,5) TITLE1, TITLE2                                   OUTOBS........6800
    5       FORMAT("## ", 80A1,                                          OUTOBS........6900
     1         /"## ", 80A1,                                             OUTOBS........7000
     2         /"## ")                                                   OUTOBS........7100
            WRITE(K7,7)                                                  OUTOBS........7200
    7       FORMAT(/'  *** NO OBSERVATION POINTS SPECIFIED ',            OUTOBS........7300
     1         '(NOBS=0) ***')                                           OUTOBS........7400
            ONCK78(NFLO) = .TRUE.                                        OUTOBS........7500
            ONCEK7 = .TRUE.                                              OUTOBS........7600
            RETURN                                                       OUTOBS........7700
         END IF                                                          OUTOBS........7800
C                                                                        OUTOBS........7900
C........CALCULATE THE MAXIMUM NUMBER OF TIME STEPS, KTMAX.              OUTOBS........8000
         IF (ISSTRA.NE.0) THEN                                           OUTOBS........8100
            KTMAX = 1                                                    OUTOBS........8200
            IMPRTD = .TRUE.                                              OUTOBS........8300
         ELSE                                                            OUTOBS........8400
            KTMAX = 2                                                    OUTOBS........8500
            IMPRTD = .FALSE.                                             OUTOBS........8600
            LENSCH = SCHDLS(OFP(NFLO)%ISCHED)%LLEN                       OUTOBS........8700
            IF (LENSCH.NE.0) THEN                                        OUTOBS........8800
               DENOBS => SCHDLS(OFP(NFLO)%ISCHED)%SLIST                  OUTOBS........8900
               KTMAX = KTMAX + 1                                         OUTOBS........9000
               SOB = DENOBS%DVALU2                                       OUTOBS........9100
               IF (SOB.EQ.DITRST) KTMAX = KTMAX - 1                      OUTOBS........9200
               DO 4 JT=2,LENSCH                                          OUTOBS........9300
                  DENOBS => DENOBS%NENT                                  OUTOBS........9400
                  KTMAX = KTMAX + 1                                      OUTOBS........9500
    4          CONTINUE                                                  OUTOBS........9600
               SOB = DENOBS%DVALU2                                       OUTOBS........9700
               IF (SOB.EQ.DITMAX) THEN                                   OUTOBS........9800
                  KTMAX = KTMAX - 1                                      OUTOBS........9900
                  IMPRTD = .TRUE.                                        OUTOBS.......10000
               END IF                                                    OUTOBS.......10100
            END IF                                                       OUTOBS.......10200
         END IF                                                          OUTOBS.......10300
C                                                                        OUTOBS.......10400
C........ALLOCATE LOCAL ARRAYS                                           OUTOBS.......10500
         ALLOCATE(TT(KTMAX),DITT(KTMAX))                                 OUTOBS.......10600
         ALLOCATE(ISTORC(KTMAX),ISHORP(KTMAX),ISSATU(KTMAX))             OUTOBS.......10700
C                                                                        OUTOBS.......10800
C........CALCULATE AND PRINT TIME STEP INFORMATION                       OUTOBS.......10900
         IF (ISSTRA.NE.0) THEN                                           OUTOBS.......11000
            KT = 1                                                       OUTOBS.......11100
            TT(KT) = TSTART                                              OUTOBS.......11200
            DITT(KT) = 1                                                 OUTOBS.......11300
            ISHORP(KT) = 0                                               OUTOBS.......11400
            ISTORC(KT) = 1                                               OUTOBS.......11500
            ISSATU(KT) = 0                                               OUTOBS.......11600
         ELSE                                                            OUTOBS.......11700
C...........NUMBER OF PRINTED TIME STEPS                                 OUTOBS.......11800
            KT=0                                                         OUTOBS.......11900
C...........TIME STEP INCREMENT                                          OUTOBS.......12000
            DELTK=DELT                                                   OUTOBS.......12100
C...........POINTERS TO TIME STEP AND OBSERVATIONS SCHEDULES             OUTOBS.......12200
            DENTS => SCHDLS(ISCHTS)%SLIST                                OUTOBS.......12300
            DENOBS => SCHDLS(OFP(NFLO)%ISCHED)%SLIST                     OUTOBS.......12400
            LCNT = 1                                                     OUTOBS.......12500
C...........OBSERVATION TIME AND STEP                                    OUTOBS.......12600
            TOB = DENOBS%DVALU1                                          OUTOBS.......12700
            SOB = DENOBS%DVALU2                                          OUTOBS.......12800
C...........INDICATORS OF WHEN VARIABLES ARE CALCULATED AND PRINTED      OUTOBS.......12900
            LCHORP = 0                                                   OUTOBS.......13000
            LCTORC = 0                                                   OUTOBS.......13100
C...........INITIAL/STARTING CONDITIONS ARE PRINTED                      OUTOBS.......13200
            IF (ITRST.GT.0) THEN                                         OUTOBS.......13300
               DO 3 JT=1,ITRST                                           OUTOBS.......13400
                  DENTS => DENTS%NENT                                    OUTOBS.......13500
                  IF (MOD(JT,NPCYC).EQ.0 .OR. BCSFL(JT) .OR. JT.EQ.1)    OUTOBS.......13600
     1               LCHORP = JT                                         OUTOBS.......13700
                  IF (MOD(JT,NUCYC).EQ.0 .OR. BCSTR(JT) .OR. JT.EQ.1)    OUTOBS.......13800
     1               LCTORC = JT                                         OUTOBS.......13900
    3          CONTINUE                                                  OUTOBS.......14000
            END IF                                                       OUTOBS.......14100
            TJT = DENTS%DVALU1                                           OUTOBS.......14200
            SJT = DENTS%DVALU2                                           OUTOBS.......14300
            DO WHILE ((SOB.LT.SJT).AND.(LCNT.LT.LENSCH))                 OUTOBS.......14400
               DENOBS => DENOBS%NENT                                     OUTOBS.......14500
               TOB = DENOBS%DVALU1                                       OUTOBS.......14600
               SOB = DENOBS%DVALU2                                       OUTOBS.......14700
               LCNT = LCNT + 1                                           OUTOBS.......14800
            END DO                                                       OUTOBS.......14900
            KT = KT + 1                                                  OUTOBS.......15000
            TT(KT) = TJT                                                 OUTOBS.......15100
            DITT(KT) = SJT                                               OUTOBS.......15200
            ISHORP(KT) = LCHORP                                          OUTOBS.......15300
            ISTORC(KT) = LCTORC                                          OUTOBS.......15400
            ISSATU(KT) = LCHORP                                          OUTOBS.......15500
            IF ((SOB.EQ.SJT).AND.(LCNT.LT.LENSCH)) THEN                  OUTOBS.......15600
               DENOBS => DENOBS%NENT                                     OUTOBS.......15700
               TOB = DENOBS%DVALU1                                       OUTOBS.......15800
               SOB = DENOBS%DVALU2                                       OUTOBS.......15900
               LCNT = LCNT + 1                                           OUTOBS.......16000
            END IF                                                       OUTOBS.......16100
C...........IDENTIFY AND RECORD SCHEDULED OUTPUT                         OUTOBS.......16200
            DO 10 JT=ITRST+1,ITMAX                                       OUTOBS.......16300
               DJT = DNINT(DBLE(JT))                                     OUTOBS.......16400
               DENTS => DENTS%NENT                                       OUTOBS.......16500
               TJT = DENTS%DVALU1                                        OUTOBS.......16600
               SJT = DENTS%DVALU2                                        OUTOBS.......16700
               IF (MOD(JT,NPCYC).EQ.0 .OR. BCSFL(JT) .OR. JT.EQ.1)       OUTOBS.......16800
     1            LCHORP = JT                                            OUTOBS.......16900
               IF (MOD(JT,NUCYC).EQ.0 .OR. BCSTR(JT) .OR. JT.EQ.1)       OUTOBS.......17000
     1            LCTORC = JT                                            OUTOBS.......17100
               DO WHILE ((SOB.LE.DJT).AND.(LCNT.LE.LENSCH))              OUTOBS.......17200
                  KT = KT + 1                                            OUTOBS.......17300
                  TT(KT) = TOB                                           OUTOBS.......17400
                  DITT(KT) = SOB                                         OUTOBS.......17500
                  ISHORP(KT) = LCHORP                                    OUTOBS.......17600
                  ISTORC(KT) = LCTORC                                    OUTOBS.......17700
                  ISSATU(KT) = LCHORP                                    OUTOBS.......17800
                  IF (LCNT.LT.LENSCH) THEN                               OUTOBS.......17900
                     DENOBS => DENOBS%NENT                               OUTOBS.......18000
                     TOB = DENOBS%DVALU1                                 OUTOBS.......18100
                     SOB = DENOBS%DVALU2                                 OUTOBS.......18200
                  END IF                                                 OUTOBS.......18300
                  LCNT = LCNT + 1                                        OUTOBS.......18400
               END DO                                                    OUTOBS.......18500
   10       CONTINUE                                                     OUTOBS.......18600
         END IF                                                          OUTOBS.......18700
C                                                                        OUTOBS.......18800
C                                                                        OUTOBS.......18900
C........PRINT LAST TIME STEP ALWAYS, UNLESS ALREADY PRINTED             OUTOBS.......19000
         IF (.NOT.IMPRTD) THEN                                           OUTOBS.......19100
            KT = KT + 1                                                  OUTOBS.......19200
            TT(KT) = TJT                                                 OUTOBS.......19300
            DITT(KT) = SJT                                               OUTOBS.......19400
            IF (MOD(JT,NPCYC).EQ.0 .OR. BCSFL(JT)) LCHORP = ITMAX        OUTOBS.......19500
            IF (MOD(JT,NUCYC).EQ.0 .OR. BCSTR(JT)) LCTORC = ITMAX        OUTOBS.......19600
            ISHORP(KT) = LCHORP                                          OUTOBS.......19700
            ISTORC(KT) = LCTORC                                          OUTOBS.......19800
            ISSATU(KT) = LCHORP                                          OUTOBS.......19900
         ENDIF                                                           OUTOBS.......20000
C                                                                        OUTOBS.......20100
C........IF STEADY-STATE FLOW, P AND S CALCULATED ON TIME STEP 0 ONLY.   OUTOBS.......20200
         IF (ISSFLO.NE.0) THEN                                           OUTOBS.......20300
            DO 14 KT=1,KTMAX                                             OUTOBS.......20400
               ISHORP(KT) = 0                                            OUTOBS.......20500
               ISSATU(KT) = 0                                            OUTOBS.......20600
   14       CONTINUE                                                     OUTOBS.......20700
         END IF                                                          OUTOBS.......20800
C                                                                        OUTOBS.......20900
C........COMPUTE ACTUAL NUMBER OF PRINTED TIME STEPS, KTPRN; LESS THAN   OUTOBS.......21000
C           KTMAX IF RUN IS A RESTART                                    OUTOBS.......21100
         IF (IREAD.EQ.+1) THEN                                           OUTOBS.......21200
            KTPRN = KTMAX                                                OUTOBS.......21300
         ELSE                                                            OUTOBS.......21400
            KTPRN = 0                                                    OUTOBS.......21500
            DO 17 KT=1,KTMAX                                             OUTOBS.......21600
               IF (DITT(KT).GE.DITRST) KTPRN = KTPRN + 1                 OUTOBS.......21700
   17       CONTINUE                                                     OUTOBS.......21800
         END IF                                                          OUTOBS.......21900
C                                                                        OUTOBS.......22000
C........SET TEMPERATURE OR CONCENTRATION TEXT STRING FOR HEADER         OUTOBS.......22100
         IF (ME .GT. 0) THEN                                             OUTOBS.......22200
            TORC1 = "Temperature  "                                      OUTOBS.......22300
            TORC2 = "  Temperature"                                      OUTOBS.......22400
         ELSE                                                            OUTOBS.......22500
            TORC1 = "Concentration"                                      OUTOBS.......22600
            TORC2 = "Concentration"                                      OUTOBS.......22700
         ENDIF                                                           OUTOBS.......22800
C                                                                        OUTOBS.......22900
C........SET PRESSURE TEXT STRING FOR HEADER                             OUTOBS.......23000
         HORP = "Pressure"                                               OUTOBS.......23100
C                                                                        OUTOBS.......23200
C........WRITE HEADER INFORMATION                                        OUTOBS.......23300
         WRITE(K7,5) TITLE1, TITLE2                                      OUTOBS.......23400
         IF (KTYPE(2).GT.1) THEN                                         OUTOBS.......23500
            IF (KTYPE(2).EQ.3) THEN                                      OUTOBS.......23600
               CTYPE2 = "BLOCKWISE MESH"                                 OUTOBS.......23700
            ELSE                                                         OUTOBS.......23800
               CTYPE2 = "REGULAR MESH  "                                 OUTOBS.......23900
            END IF                                                       OUTOBS.......24000
            IF (KTYPE(1).EQ.3) THEN                                      OUTOBS.......24100
               WRITE(K7,951) KTYPE(1),CTYPE2,NN1,NN2,NN3,NN," Nodes",    OUTOBS.......24200
     1            NE, " Elems"                                           OUTOBS.......24300
            ELSE                                                         OUTOBS.......24400
               WRITE(K7,952) KTYPE(1),CTYPE2,NN1,NN2,NN," Nodes",        OUTOBS.......24500
     1            NE, " Elems"                                           OUTOBS.......24600
            END IF                                                       OUTOBS.......24700
         ELSE IF (KTYPE(2).EQ.1) THEN                                    OUTOBS.......24800
            WRITE(K7,953) KTYPE(1), LAYSTR(1:6), NLAYS, NNLAY,           OUTOBS.......24900
     1         NN, " Nodes", NE, " Elems"                                OUTOBS.......25000
         ELSE                                                            OUTOBS.......25100
            WRITE(K7,954) KTYPE(1), NN, " Nodes", NE, " Elems"           OUTOBS.......25200
         END IF                                                          OUTOBS.......25300
         WRITE(K7,960) "OBSERVATION POINT RESULTS",KTPRN                 OUTOBS.......25400
         WRITE(K7,962) HORP, TORC1, "Sat"                                OUTOBS.......25500
         DO 920 KT=1,KTMAX                                               OUTOBS.......25600
            IF (DITT(KT).GE.DITRST)                                      OUTOBS.......25700
     1         WRITE(K7,963) DITT(KT), TT(KT), ISHORP(KT),               OUTOBS.......25800
     2         ISTORC(KT), ISSATU(KT)                                    OUTOBS.......25900
  920    CONTINUE                                                        OUTOBS.......26000
         WRITE(K7,964)                                                   OUTOBS.......26100
  951    FORMAT("## ", I1, "-D, ", A, 2X,                                OUTOBS.......26200
     1                 "(", 2(I9, ")*("), I9, ") = ", I9, A, 1X,         OUTOBS.......26300
     2                 "(", I9, A, ")"                                   OUTOBS.......26400
     3         /"## ")                                                   OUTOBS.......26500
  952    FORMAT("## ", I1, "-D, ", A, 14X,                               OUTOBS.......26600
     1                 "(", I9, ")*(", I9, ") = ", I9, A, 1X,            OUTOBS.......26700
     2                 "(", I9, A, ")"                                   OUTOBS.......26800
     3         /"## ")                                                   OUTOBS.......26900
  953    FORMAT("## ", I1, "-D, LAYERED MESH [", A6, "]", 7X,            OUTOBS.......27000
     1                 "(", I9, ")*(", I9, ") = ", I9, A, 1X,            OUTOBS.......27100
     2                 "(", I9, A, ")"                                   OUTOBS.......27200
     3         /"## ")                                                   OUTOBS.......27300
  954    FORMAT("## ", I1, "-D, IRREGULAR MESH", 40X, I9, A, 1X,         OUTOBS.......27400
     1                 "(", I9, A, ")"                                   OUTOBS.......27500
     2         /"## ")                                                   OUTOBS.......27600
  960    FORMAT("## ", 92("="),                                          OUTOBS.......27700
     1         /"## ", A, 39X, I9, " Time steps printed",                OUTOBS.......27800
     2         /"## ", 92("="))                                          OUTOBS.......27900
  962    FORMAT("## ",                                                   OUTOBS.......28000
     1         /"## ", 4X, "Time steps", 29X,                            OUTOBS.......28100
     2                 "[Latest time step computed]",                    OUTOBS.......28200
     3         /"## ", 3X, "in this file      Time (sec)", 9X,A5,        OUTOBS.......28300
     4                 10X,A4, 11X,A3,                                   OUTOBS.......28400
     5         /"## ", 2X, 14("-"), 3X, 13("-"), 1X, 3(3X, 12("-")) )    OUTOBS.......28500
  963    FORMAT("## ", 1X, F15.5, 3X, 1PE13.6, 3(7X, I8))                OUTOBS.......28600
  964    FORMAT("## "/"## ", 92("=")/"## ")                              OUTOBS.......28700
C                                                                        OUTOBS.......28800
         ALLOCATE(JSET(NOBLIN))                                          OUTOBS.......28900
         JLTOT = 0                                                       OUTOBS.......29000
         JSETS = 0                                                       OUTOBS.......29100
         JNEXT = 1                                                       OUTOBS.......29200
         DO WHILE (JNEXT.LE.NOBS)                                        OUTOBS.......29300
            CALL LODOBS(NFLO,JNEXT,OBSPTS,JSET,JLOAD)                    OUTOBS.......29400
            IF (JLOAD.EQ.0) EXIT                                         OUTOBS.......29500
            JLLAST = JLOAD                                               OUTOBS.......29600
            JLTOT = JLTOT + JLOAD                                        OUTOBS.......29700
            JSETS = JSETS + 1                                            OUTOBS.......29800
            WRITE(FRMT,"(A,I9,A)") '("## ",30X,',JLOAD,"(4X,A))"         OUTOBS.......29900
            WRITE(K7,FRMT)                                               OUTOBS.......30000
     1         (BLANKS(1:(44-LEN_TRIM(OBSPTS(JSET(JJ))%NAME))/2)         OUTOBS.......30100
     2         // TRIM(OBSPTS(JSET(JJ))%NAME) //                         OUTOBS.......30200
     3         BLANKS(1:44-LEN_TRIM(OBSPTS(JSET(JJ))%NAME)-              OUTOBS.......30300
     4         (44-LEN_TRIM(OBSPTS(JSET(JJ))%NAME))/2),                  OUTOBS.......30400
     5         JJ=1,JLOAD)                                               OUTOBS.......30500
         END DO                                                          OUTOBS.......30600
         IF (JSETS.EQ.1) THEN                                            OUTOBS.......30700
            JJMAX = JLLAST                                               OUTOBS.......30800
         ELSE                                                            OUTOBS.......30900
            JJMAX = NOBLIN                                               OUTOBS.......31000
         END IF                                                          OUTOBS.......31100
         WRITE(FRMT2,"(A,I9,A)") '("## ",30X,',NOBLIN,"(:A,44('-')))"    OUTOBS.......31200
         WRITE(K7,FRMT2) ("    ", JJ=1,JJMAX)                            OUTOBS.......31300
         JNEXT = 1                                                       OUTOBS.......31400
         DO WHILE (JNEXT.LE.NOBS)                                        OUTOBS.......31500
            CALL LODOBS(NFLO,JNEXT,OBSPTS,JSET,JLOAD)                    OUTOBS.......31600
            IF (JLOAD.EQ.0) EXIT                                         OUTOBS.......31700
            IF (KTYPE(1).EQ.2) THEN                                      OUTOBS.......31800
               WRITE(FRMT,"(A,I9,A)") '("## ",31X,',JLOAD,               OUTOBS.......31900
     1            "(2X,7X'(',1PE14.7,',',1PE14.7,')',8X))"               OUTOBS.......32000
               WRITE(K7,FRMT) (OBSPTS(JSET(JJ))%X, OBSPTS(JSET(JJ))%Y,   OUTOBS.......32100
     1            JJ=1,JLOAD)                                            OUTOBS.......32200
            ELSE                                                         OUTOBS.......32300
               WRITE(FRMT,"(A,I9,A)") '("## ",31X,',JLOAD,               OUTOBS.......32400
     1            "(2X,'(',2(1PE14.7,','),1PE14.7,')'))"                 OUTOBS.......32500
               WRITE(K7,FRMT) (OBSPTS(JSET(JJ))%X, OBSPTS(JSET(JJ))%Y,   OUTOBS.......32600
     1            OBSPTS(JSET(JJ))%Z, JJ=1,JLOAD)                        OUTOBS.......32700
            END IF                                                       OUTOBS.......32800
         END DO                                                          OUTOBS.......32900
         WRITE(K7,FRMT2) ("    ", JJ=1,JJMAX)                            OUTOBS.......33000
         WRITE(FRMT,"(A,I9,A)") '("## ",6X,"Time Step",5X,"Time (sec)",' OUTOBS.......33100
     1      ,NOBLIN,"(:10X,A,2X,A,5X,'Saturation'))"                     OUTOBS.......33200
         WRITE(K7,FRMT) (HORP, TORC2, JJ=1,JJMAX)                        OUTOBS.......33300
C                                                                        OUTOBS.......33400
C........DEALLOCATE LOCAL ARRAYS FOR HEADER.                             OUTOBS.......33500
         DEALLOCATE(TT,DITT,ISTORC,ISHORP,ISSATU,JSET)                   OUTOBS.......33600
C                                                                        OUTOBS.......33700
         ONCK78(NFLO) = .TRUE.                                           OUTOBS.......33800
         ONCEK7 = .TRUE.                                                 OUTOBS.......33900
      ENDIF                                                              OUTOBS.......34000
C                                                                        OUTOBS.......34100
C.....IF NO OBSERVATIONS, RETURN.                                        OUTOBS.......34200
      IF (NOBSN-1.EQ.0) RETURN                                           OUTOBS.......34300
C                                                                        OUTOBS.......34400
C.....WRITE OBSERVATIONS.                                                OUTOBS.......34500
      SFRAC = STEP - CEILING(STEP) + 1D0                                 OUTOBS.......34600
      IF ((STEP.EQ.0D0).OR.((STEP.EQ.1D0).AND.(ISSTRA.EQ.1))) THEN       OUTOBS.......34700
         TOUT = TSTART                                                   OUTOBS.......34800
      ELSE                                                               OUTOBS.......34900
         TOUT = TIME                                                     OUTOBS.......35000
      END IF                                                             OUTOBS.......35100
      ALLOCATE(JSET(NOBLIN))                                             OUTOBS.......35200
      NS = 0                                                             OUTOBS.......35300
      JNEXT = 1                                                          OUTOBS.......35400
      DO WHILE (JNEXT.LE.NOBS)                                           OUTOBS.......35500
         CALL LODOBS(NFLO,JNEXT,OBSPTS,JSET,JLOAD)                       OUTOBS.......35600
         IF (JLOAD.EQ.0) EXIT                                            OUTOBS.......35700
         NS = NS + 1                                                     OUTOBS.......35800
         IF (NS.EQ.1) THEN                                               OUTOBS.......35900
            WRITE(FRMT,"(A,I9,A)") "(3X,F15.5,1PE15.7,",JLOAD,"(:3X,A))" OUTOBS.......36000
            WRITE(K7,FRMT) STEP, TOUT,                                   OUTOBS.......36100
     1         (DP3STR(PUSWF(OBSPTS(JSET(JJ))%L,                         OUTOBS.......36200
     2         OBSPTS(JSET(JJ))%XSI,OBSPTS(JSET(JJ))%ETA,                OUTOBS.......36300
     3         OBSPTS(JSET(JJ))%ZET,SFRAC,PM1,UM1,                       OUTOBS.......36400
     4         PVEC,UVEC,IN,LREG)), JJ=1,JLOAD)                          OUTOBS.......36500
         ELSE                                                            OUTOBS.......36600
            WRITE(FRMT,"(A,I9,A)") "(33X,",JLOAD,"(:3X,A))"              OUTOBS.......36700
            WRITE(K7,FRMT) (DP3STR(PUSWF(OBSPTS(JSET(JJ))%L,             OUTOBS.......36800
     1         OBSPTS(JSET(JJ))%XSI,OBSPTS(JSET(JJ))%ETA,                OUTOBS.......36900
     2         OBSPTS(JSET(JJ))%ZET,SFRAC,PM1,UM1,                       OUTOBS.......37000
     3         PVEC,UVEC,IN,LREG)), JJ=1,JLOAD)                          OUTOBS.......37100
         END IF                                                          OUTOBS.......37200
      END DO                                                             OUTOBS.......37300
      DEALLOCATE(JSET)                                                   OUTOBS.......37400
C                                                                        OUTOBS.......37500
C                                                                        OUTOBS.......37600
      RETURN                                                             OUTOBS.......37700
C                                                                        OUTOBS.......37800
      END                                                                OUTOBS.......37900
C                                                                        OUTOBS.......38000
C     SUBROUTINE        O  U  T  R  S  T           SUTRA VERSION 2.2     OUTRST.........100
C                                                                        OUTRST.........200
C *** PURPOSE :                                                          OUTRST.........300
C ***  TO STORE RESULTS THAT MAY LATER BE USED TO RESTART                OUTRST.........400
C ***  THE SIMULATION.                                                   OUTRST.........500
C                                                                        OUTRST.........600
      SUBROUTINE OUTRST(PVEC,UVEC,PM1,UM1,CS1,RCIT,SW,QIN,PBC,           OUTRST.........700
     1   UIN,UBC,QUIN,IBCPBC,IBCUBC,IBCSOP,IBCSOU,                       OUTRST.........800
     2   IIDPBC,IIDUBC,IIDSOP,IIDSOU)                                    OUTRST.........900
      USE ALLARR, ONLY : CIDBCS                                          OUTRST........1000
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                OUTRST........1100
      INTEGER(1) IBCPBC(NBCN),IBCUBC(NBCN),IBCSOP(NSOP),IBCSOU(NSOU)     OUTRST........1200
      INTEGER IIDPBC(NBCN),IIDUBC(NBCN),IIDSOP(NSOP),IIDSOU(NSOU)        OUTRST........1300
      CHARACTER*8 VERNUM, VERNIN                                         OUTRST........1400
      DIMENSION PVEC(NNVEC),UVEC(NNVEC),PM1(NN),UM1(NN),CS1(NN),         OUTRST........1500
     1   RCIT(NN),SW(NN),PBC(NBCN),QIN(NN),UIN(NN),UBC(NBCN),QUIN(NN)    OUTRST........1600
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              OUTRST........1700
     1   NSOP,NSOU,NBCN,NCIDB                                            OUTRST........1800
      COMMON /DIMX2/ NELTA, NNVEC, NDIMIA, NDIMJA                        OUTRST........1900
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 OUTRST........2000
     1   K10,K11,K12,K13                                                 OUTRST........2100
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       OUTRST........2200
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      OUTRST........2300
      COMMON /VER/ VERNUM, VERNIN                                        OUTRST........2400
C                                                                        OUTRST........2500
C.....REWIND RST FILE FOR WRITING RESULTS OF CURRENT TIME STEP           OUTRST........2600
      REWIND(K4)                                                         OUTRST........2700
C                                                                        OUTRST........2800
C.....STORE TIME INFORMATION                                             OUTRST........2900
      WRITE(K4,100) TSEC,DELTP,DELTU,IT,TSTART                           OUTRST........3000
  100 FORMAT(3E20.10,3X,I8,E20.10)                                       OUTRST........3100
C                                                                        OUTRST........3200
C.....STORE SOLUTION                                                     OUTRST........3300
      WRITE(K4,105)                                                      OUTRST........3400
      WRITE(K4,110) (CUTSML(PVEC(I)),I=1,NN)                             OUTRST........3500
      WRITE(K4,105)                                                      OUTRST........3600
      WRITE(K4,110) (CUTSML(UVEC(I)),I=1,NN)                             OUTRST........3700
      WRITE(K4,110) (CUTSML(PM1(I)),I=1,NN)                              OUTRST........3800
      WRITE(K4,110) (CUTSML(UM1(I)),I=1,NN)                              OUTRST........3900
      WRITE(K4,110) (CUTSML(CS1(I)),I=1,NN)                              OUTRST........4000
      WRITE(K4,110) (CUTSML(RCIT(I)),I=1,NN)                             OUTRST........4100
      WRITE(K4,110) (CUTSML(SW(I)),I=1,NN)                               OUTRST........4200
      IF ((VERNIN.EQ.'2.0').OR.(VERNIN.EQ.'2.1')) THEN                   OUTRST........4300
         WRITE(K4,110) (CUTSML(QIN(I)),I=1,NN)                           OUTRST........4400
         WRITE(K4,110) (CUTSML(PBC(IP)),IP=1,NBCN)                       OUTRST........4500
      ELSE                                                               OUTRST........4600
         WRITE(K4,110) (CUTSML(QIN(I)),I=1,NN)                           OUTRST........4700
         WRITE(K4,110) (CUTSML(UIN(I)),I=1,NN)                           OUTRST........4800
         WRITE(K4,112) (IBCSOP(IQP),IQP=1,NSOP)                          OUTRST........4900
         WRITE(K4,112) (IIDSOP(IQP),IQP=1,NSOP)                          OUTRST........5000
         WRITE(K4,110) (CUTSML(QUIN(I)),I=1,NN)                          OUTRST........5100
         WRITE(K4,112) (IBCSOU(IQU),IQU=1,NSOU)                          OUTRST........5200
         WRITE(K4,112) (IIDSOU(IQU),IQU=1,NSOU)                          OUTRST........5300
         WRITE(K4,110) (CUTSML(PBC(IP)),IP=1,NPBC)                       OUTRST........5400
         WRITE(K4,110) (CUTSML(UBC(IP)),IP=1,NPBC)                       OUTRST........5500
         WRITE(K4,112) (IBCPBC(IP),IP=1,NPBC)                            OUTRST........5600
         WRITE(K4,112) (IIDPBC(IP),IP=1,NPBC)                            OUTRST........5700
         WRITE(K4,110) (CUTSML(UBC(IUP)),IUP=1+NPBC,NUBC+NPBC)           OUTRST........5800
         WRITE(K4,112) (IBCUBC(IUP),IUP=1+NPBC,NUBC+NPBC)                OUTRST........5900
         WRITE(K4,112) (IIDUBC(IUP),IUP=1+NPBC,NUBC+NPBC)                OUTRST........6000
         WRITE(K4,'(I9)') NCIDB                                          OUTRST........6100
         DO 103 NC=1,NCIDB                                               OUTRST........6200
            WRITE(K4,'(A)') TRIM(ADJUSTL(CIDBCS(NC)))                    OUTRST........6300
  103    CONTINUE                                                        OUTRST........6400
      END IF                                                             OUTRST........6500
  105 FORMAT("'NONUNIFORM'")                                             OUTRST........6600
  110 FORMAT(1PE20.13,1X,1PE20.13,1X,1PE20.13,1X,1PE20.13)               OUTRST........6700
  112 FORMAT(I20,1X,I20,1X,I20,1X,I20)                                   OUTRST........6800
C                                                                        OUTRST........6900
      ENDFILE(K4)                                                        OUTRST........7000
C                                                                        OUTRST........7100
      RETURN                                                             OUTRST........7200
      END                                                                OUTRST........7300
C                                                                        OUTRST........7400
C     SUBROUTINE        P  R  S  W  D  S           SUTRA VERSION 2.2     PRSWDS.........100
C                                                                        PRSWDS.........200
C *** PURPOSE :                                                          PRSWDS.........300
C ***  PARSE A CHARACTER STRING INTO WORDS.  WORDS ARE CONSIDERED TO BE  PRSWDS.........400
C ***  SEPARATED BY ONE OR MORE OF THE SINGLE-CHARACTER DELIMITER DELIM  PRSWDS.........500
C ***  AND/OR BLANKS.  PARSING CONTINUES UNTIL THE ENTIRE STRING HAS     PRSWDS.........600
C ***  BEEN PROCESSED OR THE NUMBER OF WORDS PARSED EQUALS NWMAX.  IF    PRSWDS.........700
C ***  NWMAX IS SET TO ZERO, PRSWDS SIMPLY COMPUTES THE NUMBER OF WORDS. PRSWDS.........800
C                                                                        PRSWDS.........900
      SUBROUTINE PRSWDS(STRING, DELIM, NWMAX, WORD, NWORDS)              PRSWDS........1000
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                PRSWDS........1100
      CHARACTER*(*) STRING, WORD(NWMAX)                                  PRSWDS........1200
      CHARACTER DELIM*1, DELIM2*2                                        PRSWDS........1300
C                                                                        PRSWDS........1400
C.....DEFINE SET OF DELIMITERS (SPACE PLUS USER-SPECIFIED CHARACTER)     PRSWDS........1500
      DELIM2 = " " // DELIM                                              PRSWDS........1600
C                                                                        PRSWDS........1700
C.....COMPUTE LENGTH OF STRING WITHOUT TRAILING BLANKS                   PRSWDS........1800
      LSTRNG = LEN_TRIM(STRING)                                          PRSWDS........1900
C                                                                        PRSWDS........2000
C.....INITIALIZE WORD LIST AND COUNTERS                                  PRSWDS........2100
      DO 50 I=1,NWMAX                                                    PRSWDS........2200
         WORD(I) = ""                                                    PRSWDS........2300
   50 CONTINUE                                                           PRSWDS........2400
      NWORDS = 0                                                         PRSWDS........2500
      M2 = 0                                                             PRSWDS........2600
C                                                                        PRSWDS........2700
  300 CONTINUE                                                           PRSWDS........2800
C.....FIND THE NEXT CHARACTER THAT IS NOT A DELIMITER                    PRSWDS........2900
      M1L = VERIFY(STRING(M2+1:LSTRNG),DELIM2)                           PRSWDS........3000
      IF (M1L.EQ.0) RETURN                                               PRSWDS........3100
      M1 = M2 + M1L                                                      PRSWDS........3200
C                                                                        PRSWDS........3300
  400 CONTINUE                                                           PRSWDS........3400
C.....FIND THE NEXT CHARACTER THAT IS A DELIMITER                        PRSWDS........3500
      M2L = SCAN(STRING(M1+1:LSTRNG),DELIM2)                             PRSWDS........3600
      IF (M2L.EQ.0) THEN                                                 PRSWDS........3700
         M2 = LSTRNG + 1                                                 PRSWDS........3800
      ELSE                                                               PRSWDS........3900
         M2 = M1 + M2L                                                   PRSWDS........4000
      END IF                                                             PRSWDS........4100
C                                                                        PRSWDS........4200
  500 CONTINUE                                                           PRSWDS........4300
C.....STORE THE LATEST WORD FOUND                                        PRSWDS........4400
      NWORDS = NWORDS + 1                                                PRSWDS........4500
      IF (NWMAX.GT.0) WORD(NWORDS) = STRING(M1:M2-1)                     PRSWDS........4600
C                                                                        PRSWDS........4700
C.....IF END OF STRING NOT REACHED AND NUMBER OF WORDS IS LESS THAN      PRSWDS........4800
C        THE MAXIMUM ALLOWED, CONTINUE PARSING                           PRSWDS........4900
      IF ((M2.LT.LSTRNG).AND.((NWORDS.LT.NWMAX).OR.(NWMAX.EQ.0)))        PRSWDS........5000
     1   GOTO 300                                                        PRSWDS........5100
C                                                                        PRSWDS........5200
      RETURN                                                             PRSWDS........5300
      END                                                                PRSWDS........5400
C                                                                        PRSWDS........5500
C     SUBROUTINE        P  T  R  S  E  T           SUTRA VERSION 2.2     PTRSET.........100
C                                                                        PTRSET.........200
C *** PURPOSE :                                                          PTRSET.........300
C ***  TO SET UP POINTER ARRAYS NEEDED TO SPECIFY THE MATRIX STRUCTURE.  PTRSET.........400
C                                                                        PTRSET.........500
      SUBROUTINE PTRSET()                                                PTRSET.........600
      USE ALLARR                                                         PTRSET.........700
      USE PTRDEF                                                         PTRSET.........800
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                PTRSET.........900
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              PTRSET........1000
     1   NSOP,NSOU,NBCN,NCIDB                                            PTRSET........1100
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        PTRSET........1200
      COMMON /DIMX2/ NELTA, NNVEC, NDIMIA, NDIMJA                        PTRSET........1300
C                                                                        PTRSET........1400
C.....SET UP POINTER ARRAYS IA AND JA THAT SPECIFY MATRIX STRUCTURE IN   PTRSET........1500
C        "SLAP COLUMN" FORMAT.  FOR EACH NODE, CONSTRUCT A LINKED LIST   PTRSET........1600
C        OF NEIGHBORING NODES.  HLIST(K) POINTS TO THE HEAD OF THE LIST  PTRSET........1700
C        FOR NODE K.  THEN, TRANSFER THE LISTS TO ARRAYS IA AND JA.      PTRSET........1800
C                                                                        PTRSET........1900
C.....ALLOCATE HLIST AND LLIST, AND INITIALIZE LIST LENGTHS TO ZERO.     PTRSET........2000
      ALLOCATE(LLIST(NN), HLIST(NN))                                     PTRSET........2100
      DO 490 I=1,NN                                                      PTRSET........2200
         ALLOCATE(HLIST(I)%PL)                                           PTRSET........2300
         LLIST(I) = 0                                                    PTRSET........2400
  490 CONTINUE                                                           PTRSET........2500
C.....LOOP THROUGH INCIDENCE LIST.                                       PTRSET........2600
      DO 500 L=1,NE                                                      PTRSET........2700
      DO 500 IL=1,N48                                                    PTRSET........2800
         IC = IN((L-1)*N48+IL)                                           PTRSET........2900
      DO 500 JL=1,N48                                                    PTRSET........3000
         JC = IN((L-1)*N48+JL)                                           PTRSET........3100
C........INSERT NEIGHBOR JC IN LIST FOR NODE IC IN ASCENDING ORDER.      PTRSET........3200
C           (IF DUPLICATE OR SELF-NEIGHBOR, SKIP IT.)                    PTRSET........3300
         IF (JC.EQ.IC) THEN                                              PTRSET........3400
C...........SKIP SELF-NEIGHBOR.                                          PTRSET........3500
            GOTO 500                                                     PTRSET........3600
         ELSE IF (LLIST(IC).EQ.0) THEN                                   PTRSET........3700
C...........PLACE FIRST LIST ENTRY AT HEAD.                              PTRSET........3800
            HLIST(IC)%PL%NODNUM = JC                                     PTRSET........3900
            GOTO 498                                                     PTRSET........4000
         ELSE                                                            PTRSET........4100
C...........INSERT INTO LIST, OR SKIP IF DUPLICATE.                      PTRSET........4200
            ALLOCATE(DENTPV)                                             PTRSET........4300
C  IT HAS BEEN PROVED THAT DENTPI AND DENTPV IN THE COMMENTED OUT SYSTEM IS USELESS
C SEE PAGE 93 OF (2.2 I)
C            DENTPI => DENTPV                                             PTRSET........4400
            DENTPV%NENT => HLIST(IC)%PL                                  PTRSET........4500
            DO 495 K=1,LLIST(IC)                                         PTRSET........4600
               DENT => DENTPV%NENT                                       PTRSET........4700
               IF (JC.EQ.DENT%NODNUM) THEN                               PTRSET........4800
                  GOTO 500                                               PTRSET........4900
               ELSE IF (JC.LT.DENT%NODNUM) THEN                          PTRSET........5000
                  ALLOCATE(DENTNW)                                       PTRSET........5100
                  DENTNW%NODNUM = JC                                     PTRSET........5200
                  DENTNW%NENT => DENT                                    PTRSET........5300
                  IF (K.EQ.1) THEN                                       PTRSET........5400
                     HLIST(IC)%PL => DENTNW                              PTRSET........5500
                  ELSE                                                   PTRSET........5600
                     DENTPV%NENT => DENTNW                               PTRSET........5700
                  END IF                                                 PTRSET........5800
C                  DEALLOCATE(DENTPI)                                     PTRSET........5900
                  GOTO 498                                               PTRSET........6000
               END IF                                                    PTRSET........6100
               DENTPV => DENT                                            PTRSET........6200
  495       CONTINUE                                                     PTRSET........6300
C...........APPEND TO TAIL.                                              PTRSET........6400
            ALLOCATE(DENTNW)                                             PTRSET........6500
            DENTNW%NODNUM = JC                                           PTRSET........6600
            DENT%NENT => DENTNW                                          PTRSET........6700
C            DEALLOCATE(DENTPI)                                           PTRSET........6800
         END IF                                                          PTRSET........6900
  498    LLIST(IC) = LLIST(IC) + 1                                       PTRSET........7000
  500 CONTINUE                                                           PTRSET........7100
C.....COMPUTE THE ARRAY DIMENSION NELT AND ALLOCATE ARRAY IA.            PTRSET........7200
      NELT = 0                                                           PTRSET........7300
      DO 600 I=1,NN                                                      PTRSET........7400
  600    NELT = NELT + LLIST(I) + 1                                      PTRSET........7500
      NDIMIA = NELT                                                      PTRSET........7600
      ALLOCATE(IA(NDIMIA))                                               PTRSET........7700
C.....TRANSFER THE LINKED LISTS TO ARRAYS IA AND JA IN SLAP COLUMN       PTRSET........7800
C        FORMAT.  DEALLOCATE POINTERS AS THEY ARE TRANSFERRED.           PTRSET........7900
      JASTRT = 1                                                         PTRSET........8000
      DO 660 I=1,NN                                                      PTRSET........8100
         JA(I) = JASTRT                                                  PTRSET........8200
         IA(JASTRT) = I                                                  PTRSET........8300
         DENT => HLIST(I)%PL                                             PTRSET........8400
         DO 650 K=1,LLIST(I)                                             PTRSET........8500
            IA(JASTRT + K) = DENT%NODNUM                                 PTRSET........8600
C            DENTPV => DENT                                               PTRSET........8700
            DENT => DENT%NENT                                            PTRSET........8800
C            DEALLOCATE(DENTPV)                                           PTRSET........8900
  650    CONTINUE                                                        PTRSET........9000
         JASTRT = JASTRT + LLIST(I) + 1                                  PTRSET........9100
  660 CONTINUE                                                           PTRSET........9200
      JA(NN + 1) = NELT + 1                                              PTRSET........9300
      DEALLOCATE(HLIST, LLIST)                                           PTRSET........9400
C                                                                        PTRSET........9500
      RETURN                                                             PTRSET........9600
      END                                                                PTRSET........9700
C                                                                        PTRSET........9800
C                                                                        PTRSET........9900
C     SUBROUTINE        P  U                       SUTRA VERSION 2.2     PU.............100
C                                                                        PU.............200
C *** PURPOSE :                                                          PU.............300
C ***  TO EVALUATE P AND U AT SPECIFIED LOCAL COORDINATES WITHIN A       PU.............400
C ***  2D OR 3D ELEMENT.  ADAPTED FROM SUBROUTINES BASIS2 AND BASIS3.    PU.............500
C                                                                        PU.............600
      SUBROUTINE PU(L,XLOC,YLOC,ZLOC,PVEC,UVEC,IN,P,U)                   PU.............700
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                PU.............800
      DIMENSION FX(8),FY(8),FZ(8),F(8)                                   PU.............900
      DIMENSION PVEC(NN),UVEC(NN)                                        PU............1000
      DIMENSION IN(NIN),KTYPE(2)                                         PU............1100
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  PU............1200
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           PU............1300
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      PU............1400
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              PU............1500
     1   NSOP,NSOU,NBCN,NCIDB                                            PU............1600
C                                                                        PU............1700
      IF (KTYPE(1).EQ.2) THEN                                            PU............1800
C.....2D MESH                                                            PU............1900
C........EVALUATE BASIS FUNCTIONS                                        PU............2000
         XF1=1.D0-XLOC                                                   PU............2100
         XF2=1.D0+XLOC                                                   PU............2200
         YF1=1.D0-YLOC                                                   PU............2300
         YF2=1.D0+YLOC                                                   PU............2400
         FX(1)=XF1                                                       PU............2500
         FX(2)=XF2                                                       PU............2600
         FX(3)=XF2                                                       PU............2700
         FX(4)=XF1                                                       PU............2800
         FY(1)=YF1                                                       PU............2900
         FY(2)=YF1                                                       PU............3000
         FY(3)=YF2                                                       PU............3100
         FY(4)=YF2                                                       PU............3200
         DO 20 I=1,4                                                     PU............3300
   20       F(I)=0.250D0*FX(I)*FY(I)                                     PU............3400
C........EVALUATE P AND U                                                PU............3500
         P=0.D0                                                          PU............3600
         U=0.D0                                                          PU............3700
         DO 25 IL=1,4                                                    PU............3800
            II=(L-1)*4 +IL                                               PU............3900
            I=IN(II)                                                     PU............4000
            P=P+PVEC(I)*F(IL)                                            PU............4100
            U=U+UVEC(I)*F(IL)                                            PU............4200
   25    CONTINUE                                                        PU............4300
      ELSE                                                               PU............4400
C.....3D MESH                                                            PU............4500
C........EVALUATE BASIS FUNCTIONS                                        PU............4600
         XF1=1.D0-XLOC                                                   PU............4700
         XF2=1.D0+XLOC                                                   PU............4800
         YF1=1.D0-YLOC                                                   PU............4900
         YF2=1.D0+YLOC                                                   PU............5000
         ZF1=1.D0-ZLOC                                                   PU............5100
         ZF2=1.D0+ZLOC                                                   PU............5200
         FX(1)=XF1                                                       PU............5300
         FX(2)=XF2                                                       PU............5400
         FX(3)=XF2                                                       PU............5500
         FX(4)=XF1                                                       PU............5600
         FX(5)=XF1                                                       PU............5700
         FX(6)=XF2                                                       PU............5800
         FX(7)=XF2                                                       PU............5900
         FX(8)=XF1                                                       PU............6000
         FY(1)=YF1                                                       PU............6100
         FY(2)=YF1                                                       PU............6200
         FY(3)=YF2                                                       PU............6300
         FY(4)=YF2                                                       PU............6400
         FY(5)=YF1                                                       PU............6500
         FY(6)=YF1                                                       PU............6600
         FY(7)=YF2                                                       PU............6700
         FY(8)=YF2                                                       PU............6800
         FZ(1)=ZF1                                                       PU............6900
         FZ(2)=ZF1                                                       PU............7000
         FZ(3)=ZF1                                                       PU............7100
         FZ(4)=ZF1                                                       PU............7200
         FZ(5)=ZF2                                                       PU............7300
         FZ(6)=ZF2                                                       PU............7400
         FZ(7)=ZF2                                                       PU............7500
         FZ(8)=ZF2                                                       PU............7600
         DO 30 I=1,8                                                     PU............7700
   30       F(I)=0.125D0*FX(I)*FY(I)*FZ(I)                               PU............7800
C........EVALUATE P AND U                                                PU............7900
         P=0.D0                                                          PU............8000
         U=0.D0                                                          PU............8100
         DO 35 IL=1,8                                                    PU............8200
            II=(L-1)*8 +IL                                               PU............8300
            I=IN(II)                                                     PU............8400
            P=P+PVEC(I)*F(IL)                                            PU............8500
            U=U+UVEC(I)*F(IL)                                            PU............8600
   35    CONTINUE                                                        PU............8700
      END IF                                                             PU............8800
      END                                                                PU............8900
C                                                                        PU............9000
C     FUNCTION          P  U  S  W  F              SUTRA VERSION 2.2     PUSWF..........100
C                                                                        PUSWF..........200
C *** PURPOSE :                                                          PUSWF..........300
C ***  TO INTERPOLATE P, U, AND SW AT A FRACTIONAL TIME STEP (BETWEEN    PUSWF..........400
C ***  THE CURRENT AND PREVIOUS TIME STEPS) AND RETURN THE VALUES IN     PUSWF..........500
C ***  AN ARRAY.                                                         PUSWF..........600
C                                                                        PUSWF..........700
      FUNCTION PUSWF(L,XLOC,YLOC,ZLOC,SFRAC,PM1,UM1,PVEC,UVEC,IN,LREG)   PUSWF..........800
      IMPLICIT DOUBLE PRECISION (A-H, O-Z)                               PUSWF..........900
      DIMENSION PUSWF(3)                                                 PUSWF.........1000
      DIMENSION PM1(NN),UM1(NN),PVEC(NN),UVEC(NN)                        PUSWF.........1100
      DIMENSION IN(NIN),LREG(NE)                                         PUSWF.........1200
      DIMENSION KTYPE(2)                                                 PUSWF.........1300
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  PUSWF.........1400
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           PUSWF.........1500
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      PUSWF.........1600
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              PUSWF.........1700
     1   NSOP,NSOU,NBCN,NCIDB                                            PUSWF.........1800
C                                                                        PUSWF.........1900
C.....EVALUATE P AND U AT PREVIOUS AND CURRENT TIME STEPS                PUSWF.........2000
      CALL PU(L,XLOC,YLOC,ZLOC,PM1,UM1,IN,P1,U1)                         PUSWF.........2100
      CALL PU(L,XLOC,YLOC,ZLOC,PVEC,UVEC,IN,P2,U2)                       PUSWF.........2200
C                                                                        PUSWF.........2300
C.....INTERPOLATE P AND U AT FRACTIONAL TIME STEP                        PUSWF.........2400
      CSFRAC = 1D0 - SFRAC                                               PUSWF.........2500
      PINT = CSFRAC*P1 + SFRAC*P2                                        PUSWF.........2600
      PUSWF(1) = PINT                                                    PUSWF.........2700
      PUSWF(2) = CSFRAC*U1 + SFRAC*U2                                    PUSWF.........2800
C                                                                        PUSWF.........2900
C.....EVALUATE SW AT FRACTIONAL TIME STEP                                PUSWF.........3000
      IF ((IUNSAT.NE.0).AND.(PINT.LT.0D0)) THEN                          PUSWF.........3100
         IUNSAT = 3                                                      PUSWF.........3200
         CALL UNSAT(SWINT,DSWDPG,RELK,PINT,LREG(L))                      PUSWF.........3300
      ELSE                                                               PUSWF.........3400
         SWINT = 1D0                                                     PUSWF.........3500
      END IF                                                             PUSWF.........3600
      PUSWF(3) = SWINT                                                   PUSWF.........3700
C                                                                        PUSWF.........3800
      RETURN                                                             PUSWF.........3900
      END                                                                PUSWF.........4000
C                                                                        PUSWF.........4100
C     SUBROUTINE        R  E  A  D  I  F           SUTRA VERSION 2.2     READIF.........100
C                                                                        READIF.........200
C *** PURPOSE :                                                          READIF.........300
C ***  TO READ A LINE FROM AN INPUT FILE INTO THE CHARACTER VARIABLE     READIF.........400
C ***  INTFIL.  HANDLE OPENING AND CLOSING OF INSERTED FILES AS          READIF.........500
C ***  NECESSARY.                                                        READIF.........600
C                                                                        READIF.........700
      SUBROUTINE READIF(KUU, NFB, INTFIL, ERRCIO, CHERIN)                READIF.........800
      USE SCHDEF, ONLY : IUNIO, FNAMO                                    READIF.........900
      USE BCSDEF                                                         READIF........1000
      USE FINDEF                                                         READIF........1100
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                READIF........1200
      PARAMETER (KINMIN=10)                                              READIF........1300
      CHARACTER INTFIL*1000                                              READIF........1400
      CHARACTER*80 ERRCOD,ERRCIO,CHERR(10)                               READIF........1500
      CHARACTER*80, DIMENSION(10), OPTIONAL :: CHERIN                    READIF........1600
      CHARACTER*80 UNAME,FNAME                                           READIF........1700
      CHARACTER ERRF*3, FINS*80                                          READIF........1800
      LOGICAL IS                                                         READIF........1900
      DIMENSION INERR(10),RLERR(10)                                      READIF........2000
      DIMENSION IUNIT(0:13)                                              READIF........2100
      DIMENSION FNAME(0:13)                                              READIF........2200
      COMMON /FNAMES/ UNAME,FNAME                                        READIF........2300
      COMMON /FUNIB/ NFBCS                                               READIF........2400
      COMMON /FUNITA/ IUNIT                                              READIF........2500
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 READIF........2600
     1   K10,K11,K12,K13                                                 READIF........2700
      COMMON /OBS/ NOBSN,NTOBS,NOBCYC,NOBLIN,NFLOMX                      READIF........2800
C                                                                        READIF........2900
C.....COPY ERRCIO INTO ERRCOD AND ARRAY CHERIN (IF PRESENT AS AN         READIF........3000
C        ARGUMENT) INTO CHERR.                                           READIF........3100
      ERRCOD = ERRCIO                                                    READIF........3200
      IF (PRESENT(CHERIN)) CHERR = CHERIN                                READIF........3300
C                                                                        READIF........3400
C.....COPY KUU INTO KU. SHOULD AVOID CHANGING KUU, SINCE IT IS ALREADY   READIF........3500
C        LINKED TO K1, K2, OR K9 THROUGH THE ARGUMENT LIST, AND THE      READIF........3600
C        LATTER ARE ALSO PASSED IN THROUGH COMMON BLOCK FUNITS.          READIF........3700
      KU = KUU                                                           READIF........3800
C                                                                        READIF........3900
C.....READ A LINE OF INPUT (UP TO 1000 CHARACTERS) FROM UNIT KU          READIF........4000
C        INTO INTFIL                                                     READIF........4100
100   READ(KU,'(A)',IOSTAT=INERR(1)) INTFIL                              READIF........4200
C.....IF THE END OF AN INSERTED FILE IS REACHED, CLOSE THAT FILE AND     READIF........4300
C        CONTINUE READING FROM THE NEXT-LEVEL-UP FILE                    READIF........4400
      IF (INERR(1).LT.0) THEN                                            READIF........4500
C........SET FLAG IK TO INDICATE WHETHER THE READ WAS ATTEMPTED FROM     READIF........4600
C           AN INP DATASET (IK=1), AN ICS DATASET (IK=2), OR A BCS       READIF........4700
C           DATASET (IK>2)                                               READIF........4800
         IF (KU.EQ.K1) THEN                                              READIF........4900
            IK = 1                                                       READIF........5000
            IIK = 1                                                      READIF........5100
         ELSE IF (KU.EQ.K2) THEN                                         READIF........5200
            IK = 2                                                       READIF........5300
            IIK = 2                                                      READIF........5400
         ELSE                                                            READIF........5500
            IK = 2 + NFB                                                 READIF........5600
            IIK = 9                                                      READIF........5700
         END IF                                                          READIF........5800
C........IF READING FROM AN INSERTED FILE, CLOSE THAT FILE, UPDATE       READIF........5900
C           UNIT NUMBERS, FILENAME, AND COUNTER TO INDICATE THE          READIF........6000
C           NEXT-LEVEL-UP FILE, AND CONTINUE READING                     READIF........6100
         IF (NKS(IK).GT.0) THEN                                          READIF........6200
            CLOSE(KU)                                                    READIF........6300
            IF (KU.EQ.K1) THEN                                           READIF........6400
               K1 = KLIST(IK, NKS(IK))                                   READIF........6500
               FNAME(IIK) = FNAIN(IK, NKS(IK))                           READIF........6600
            ELSE IF (KU.EQ.K2) THEN                                      READIF........6700
               K2 = KLIST(IK, NKS(IK))                                   READIF........6800
               FNAME(IIK) = FNAIN(IK, NKS(IK))                           READIF........6900
            ELSE                                                         READIF........7000
               K9 = KLIST(IK, NKS(IK))                                   READIF........7100
               FNAMB(NFB) = FNAIN(IK, NKS(IK))                           READIF........7200
               IUNIB(NFB) = K9                                           READIF........7300
               FNAME(IIK) = FNAIN(IK, NKS(IK))                           READIF........7400
            END IF                                                       READIF........7500
            KU = KLIST(IK, NKS(IK))                                      READIF........7600
            NKS(IK) = NKS(IK) - 1                                        READIF........7700
            GOTO 100                                                     READIF........7800
         ELSE                                                            READIF........7900
C...........REACHED END OF ZERO-LEVEL FILE. IF ERRCOD="NO_EOF_ERR"       READIF........8000
C                ON INPUT, RETURN; ELSE GENERATE ERROR.                  READIF........8100
            IF (ERRCIO.EQ."NO_EOF_ERR") THEN                             READIF........8200
               ERRCIO = "EOF"                                            READIF........8300
               GOTO 999                                                  READIF........8400
            ELSE                                                         READIF........8500
               CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                  READIF........8600
            END IF                                                       READIF........8700
         END IF                                                          READIF........8800
C.....ELSE IF THE READ RESULTS IN A DIFFERENT KIND OF ERROR, GENERATE    READIF........8900
C        ERROR MESSAGE                                                   READIF........9000
      ELSE IF (INERR(1).GT.0) THEN                                       READIF........9100
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        READIF........9200
      END IF                                                             READIF........9300
C                                                                        READIF........9400
C.....IF BLANK OR COMMENT LINE, SKIP IT.                                 READIF........9500
      IF ((INTFIL(1:1).EQ.'#').OR.(INTFIL.EQ.'')) GOTO 100               READIF........9600
C                                                                        READIF........9700
C.....IF INSERT STATEMENT, OPEN THE FILE AND CONTINUE READING            READIF........9800
      IF (INTFIL(1:7).EQ.'@INSERT') THEN                                 READIF........9900
C........SET FLAG IK TO INDICATE WHETHER THE READ WAS DONE FROM          READIF.......10000
C           AN INP DATASET (IK=1), AN ICS DATASET (IK=2), OR A BCS       READIF.......10100
C           DATASET (IK>2).  SET ERRF TO THE FILE TYPE ('INP', 'ICS',    READIF.......10200
C           OR 'BCS').                                                   READIF.......10300
         IF (KU.EQ.K1) THEN                                              READIF.......10400
            IK = 1                                                       READIF.......10500
            IIK = 1                                                      READIF.......10600
            ERRF = 'INP'                                                 READIF.......10700
         ELSE IF (KU.EQ.K2) THEN                                         READIF.......10800
            IK = 2                                                       READIF.......10900
            IIK = 2                                                      READIF.......11000
            ERRF = 'ICS'                                                 READIF.......11100
         ELSE                                                            READIF.......11200
            IK = 2 + NFB                                                 READIF.......11300
            IIK = 9                                                      READIF.......11400
            ERRF = 'BCS'                                                 READIF.......11500
         END IF                                                          READIF.......11600
C........READ THE FILE SPECIFICATION FOR THE INSERTED FILE               READIF.......11700
         READ(INTFIL(8:),*,IOSTAT=INERR(1)) KINS, FINS                   READIF.......11800
         IF (INERR(1).NE.0) THEN                                         READIF.......11900
            CHERR(1) = ERRCOD                                            READIF.......12000
            ERRCOD = 'REA-' // ERRF // '-INS'                            READIF.......12100
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     READIF.......12200
         END IF                                                          READIF.......12300
C........CHECK FOR DUPLICATE FILENAME AMONG INSERTED FILES               READIF.......12400
         DO 550 I=1,2+NFB                                                READIF.......12500
         DO 550 K=1,NKS(I)                                               READIF.......12600
            IF (FINS.EQ.FNAIN(I, K)) THEN                                READIF.......12700
               ERRCOD = 'FIL-4'                                          READIF.......12800
               INERR(1) = KINS                                           READIF.......12900
               CHERR(1) = FNAME(IIK)                                     READIF.......13000
               CHERR(2) = FINS                                           READIF.......13100
               CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                  READIF.......13200
            END IF                                                       READIF.......13300
  550    CONTINUE                                                        READIF.......13400
C........CHECK FOR DUPLICATE FILENAME AMONG NON-INSERTED,                READIF.......13500
C           NON-OBSERVATION FILES                                        READIF.......13600
         DO 560 NFF=0,13                                                 READIF.......13700
            IF ((NFF.GE.7).OR.(NFF.LE.9)) CYCLE                          READIF.......13800
            IF (FINS.EQ.FNAME(NFF)) THEN                                 READIF.......13900
               ERRCOD = 'FIL-4'                                          READIF.......14000
               INERR(1) = KINS                                           READIF.......14100
               CHERR(1) = FNAME(IIK)                                     READIF.......14200
               CHERR(2) = FINS                                           READIF.......14300
               CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                  READIF.......14400
            END IF                                                       READIF.......14500
  560    CONTINUE                                                        READIF.......14600
         DO 565 NFFB=1,NFBCS                                             READIF.......14700
            IF (FINS.EQ.FNAMB(NFFB)) THEN                                READIF.......14800
               ERRCOD = 'FIL-4'                                          READIF.......14900
               INERR(1) = KINS                                           READIF.......15000
               CHERR(1) = FNAME(IIK)                                     READIF.......15100
               CHERR(2) = FINS                                           READIF.......15200
               CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                  READIF.......15300
            END IF                                                       READIF.......15400
  565    CONTINUE                                                        READIF.......15500
C........CHECK FOR DUPLICATE FILENAME AMONG OBSERVATION FILES            READIF.......15600
         DO 570 NJ=1,NFLOMX                                              READIF.......15700
            IF (FINS.EQ.FNAMO(NJ)) THEN                                  READIF.......15800
               ERRCOD = 'FIL-4'                                          READIF.......15900
               INERR(1) = KINS                                           READIF.......16000
               CHERR(1) = FNAME(IIK)                                     READIF.......16100
               CHERR(2) = FINS                                           READIF.......16200
               CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                  READIF.......16300
            END IF                                                       READIF.......16400
  570    CONTINUE                                                        READIF.......16500
C........IF THE SPECIFIED UNIT NUMBER IS LESS THAN KINMIN,               READIF.......16600
C           SET IT TO KINMIN                                             READIF.......16700
         KINS = MAX(KINS, KINMIN)                                        READIF.......16800
C........IF THE FILE TO BE INSERTED EXISTS, ASSIGN IT A UNIT NUMBER      READIF.......16900
C           AND OPEN IT                                                  READIF.......17000
         INQUIRE(FILE=FINS,EXIST=IS)                                     READIF.......17100
         IF (IS) THEN                                                    READIF.......17200
            CALL NAFU(KINS,NFLOMX,FINS)                                  READIF.......17300
            OPEN(UNIT=KINS,FILE=FINS,STATUS='OLD',FORM='FORMATTED',      READIF.......17400
     1         IOSTAT=KERR)                                              READIF.......17500
            IF (KERR.GT.0) THEN                                          READIF.......17600
               CHERR(1) = FNAME(IIK)                                     READIF.......17700
               CHERR(2) = FINS                                           READIF.......17800
               INERR(1) = KINS                                           READIF.......17900
               ERRCOD = 'FIL-2'                                          READIF.......18000
               CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                  READIF.......18100
            END IF                                                       READIF.......18200
         ELSE                                                            READIF.......18300
            CHERR(1) = FNAME(IIK)                                        READIF.......18400
            CHERR(2) = FINS                                              READIF.......18500
            ERRCOD = 'FIL-1'                                             READIF.......18600
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     READIF.......18700
         END IF                                                          READIF.......18800
C........UPDATE THE INSERTION COUNTER.  IF THE COUNT EXCEEDS 20,         READIF.......18900
C           GENERATE AN ERROR                                            READIF.......19000
         NKS(IK) = NKS(IK) + 1                                           READIF.......19100
         IF (NKS(IK).GT.20) THEN                                         READIF.......19200
            CHERR(1) = FNAME(IIK)                                        READIF.......19300
            CHERR(2) = FINS                                              READIF.......19400
            ERRCOD = 'FIL-8'                                             READIF.......19500
            CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                     READIF.......19600
         END IF                                                          READIF.......19700
C........UPDATE UNIT NUMBERS AND FILENAMES TO INDICATE THE NEWLY         READIF.......19800
C           INSERTED FILE, AND CONTINUE READING                          READIF.......19900
         IF (KU.EQ.K1) THEN                                              READIF.......20000
            K1 = KINS                                                    READIF.......20100
            FNAIN(IK, NKS(IK)) = FNAME(IIK)                              READIF.......20200
            FNAME(IIK) = FINS                                            READIF.......20300
         ELSE IF (KU.EQ.K2) THEN                                         READIF.......20400
            K2 = KINS                                                    READIF.......20500
            FNAIN(IK, NKS(IK)) = FNAME(IIK)                              READIF.......20600
            FNAME(IIK) = FINS                                            READIF.......20700
         ELSE                                                            READIF.......20800
            K9 = KINS                                                    READIF.......20900
            FNAIN(IK, NKS(IK)) = FNAMB(NFB)                              READIF.......21000
            FNAMB(NFB) = FINS                                            READIF.......21100
            IUNIB(NFB) = KINS                                            READIF.......21200
C...........SET FNAME(9) EQUAL TO FNAMB(NFB) FOR CONVENIENCE IN          READIF.......21300
C              ERROR HANDLING                                            READIF.......21400
            FNAME(9) = FNAMB(NFB)                                        READIF.......21500
         END IF                                                          READIF.......21600
         KLIST(IK, NKS(IK)) = KU                                         READIF.......21700
         KU = KINS                                                       READIF.......21800
         GOTO 100                                                        READIF.......21900
      END IF                                                             READIF.......22000
C                                                                        READIF.......22100
  999 RETURN                                                             READIF.......22200
      END                                                                READIF.......22300
C                                                                        READIF.......22400
C     SUBROUTINE        R  O  T  A  T  E           SUTRA VERSION 2.2     ROTATE.........100
C                                                                        ROTATE.........200
C *** PURPOSE :                                                          ROTATE.........300
C ***  TO TRANSFORM THE COORDINATES OF A VECTOR, {x}, BY APPLYING THE    ROTATE.........400
C ***  ROTATION MATRIX, [G]:  {xp}=[G]{x}.                               ROTATE.........500
C                                                                        ROTATE.........600
      SUBROUTINE ROTATE(G11,G12,G13,G21,G22,G23,G31,G32,G33,X,Y,Z,       ROTATE.........700
     1   XP,YP,ZP)                                                       ROTATE.........800
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                ROTATE.........900
C                                                                        ROTATE........1000
C.....COMPUTE VECTOR {xp} AS THE PRODUCT OF MATRIX [G] AND VECTOR {x}    ROTATE........1100
      XP= G11*X + G12*Y + G13*Z                                          ROTATE........1200
      YP= G21*X + G22*Y + G23*Z                                          ROTATE........1300
      ZP= G31*X + G32*Y + G33*Z                                          ROTATE........1400
C                                                                        ROTATE........1500
      RETURN                                                             ROTATE........1600
      END                                                                ROTATE........1700
C                                                                        ROTATE........1800
C     SUBROUTINE        R  O  T  M  A  T           SUTRA VERSION 2.2     ROTMAT.........100
C                                                                        ROTMAT.........200
C *** PURPOSE :                                                          ROTMAT.........300
C ***  TO COMPUTE A TRANSFORMATION MATRIX, [G], THAT CONVERTS            ROTMAT.........400
C ***  COORDINATES OF A VECTOR, {v}, FROM A COORDINATE SYSTEM (X, Y, Z)  ROTMAT.........500
C ***  TO A NEW COORDINATE SYSTEM (X', Y', Z'):  {v'} = [G]{v}.          ROTMAT.........600
C ***  THE OVERALL TRANSFORMATION IS THE RESULT OF THREE ROTATIONS       ROTMAT.........700
C ***  APPLIED CONSECUTIVELY:                                            ROTMAT.........800
C ***  A1 = ROTATION IN THE XY-PLANE, COUNTER-CLOCKWISE FROM THE         ROTMAT.........900
C ***     +X-AXIS (LOOKING DOWN THE +Z-AXIS TOWARD THE ORIGIN),          ROTMAT........1000
C ***  A2 = ROTATION IN THE NEW XZ-PLANE, COUNTER-CLOCKWISE FROM THE     ROTMAT........1100
C ***     NEW +X-AXIS (LOOKING DOWN THE NEW +Y-AXIS TOWARD THE ORIGIN),  ROTMAT........1200
C ***  A3 = ROTATION IN THE NEW YZ-PLANE, COUNTER-CLOCKWISE FROM THE     ROTMAT........1300
C ***     NEW +Y-AXIS (LOOKING DOWN THE NEW +X-AXIS TOWARD THE ORIGIN).  ROTMAT........1400
C                                                                        ROTMAT........1500
      SUBROUTINE ROTMAT(A1,A2,A3,G11,G12,G13,G21,G22,G23,G31,G32,G33)    ROTMAT........1600
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                ROTMAT........1700
C                                                                        ROTMAT........1800
C.....COMPUTE SINES AND COSINES OF ANGLES.                               ROTMAT........1900
      S1= DSIN(A1)                                                       ROTMAT........2000
      C1= DCOS(A1)                                                       ROTMAT........2100
      S2= DSIN(A2)                                                       ROTMAT........2200
      C2= DCOS(A2)                                                       ROTMAT........2300
      S3= DSIN(A3)                                                       ROTMAT........2400
      C3= DCOS(A3)                                                       ROTMAT........2500
C                                                                        ROTMAT........2600
C.....COMPUTE ROTATION MATRIX.                                           ROTMAT........2700
      G11 =  C1*C2                                                       ROTMAT........2800
      G12 =  -C1*S2*S3 - S1*C3                                           ROTMAT........2900
      G13 =  -C1*S2*C3 + S1*S3                                           ROTMAT........3000
      G21 =  S1*C2                                                       ROTMAT........3100
      G22 =  -S1*S2*S3 + C1*C3                                           ROTMAT........3200
      G23 =  -S1*S2*C3 - C1*S3                                           ROTMAT........3300
      G31 =  S2                                                          ROTMAT........3400
      G32 =  C2*S3                                                       ROTMAT........3500
      G33 =  C2*C3                                                       ROTMAT........3600
      RETURN                                                             ROTMAT........3700
      END                                                                ROTMAT........3800
C                                                                        ROTMAT........3900
C     SUBROUTINE        S  O  L  V  E  B           SUTRA VERSION 2.2     SOLVEB.........100
C                                                                        SOLVEB.........200
C *** PURPOSE :                                                          SOLVEB.........300
C ***  TO SOLVE THE MATRIX EQUATION BY:                                  SOLVEB.........400
C ***   (1) DECOMPOSING THE MATRIX                                       SOLVEB.........500
C ***   (2) MODIFYING THE RIGHT-HAND SIDE                                SOLVEB.........600
C ***   (3) BACK-SUBSTITUTING FOR THE SOLUTION                           SOLVEB.........700
C                                                                        SOLVEB.........800
      SUBROUTINE SOLVEB(KMT,C,R,NNP,IHALFB,MAXNP,MAXBW)                  SOLVEB.........900
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                SOLVEB........1000
      DIMENSION C(MAXNP,MAXBW),R(MAXNP)                                  SOLVEB........1100
C                                                                        SOLVEB........1200
      IHBP=IHALFB+1                                                      SOLVEB........1300
C                                                                        SOLVEB........1400
C.....DECOMPOSE MATRIX C BY BANDED GAUSSIAN ELIMINATION FOR              SOLVEB........1500
C        NON-SYMMETRIC MATRIX                                            SOLVEB........1600
      IF(KMT-1) 5,5,50                                                   SOLVEB........1700
    5 NU=NNP-IHALFB                                                      SOLVEB........1800
      DO 20 NI=1,NU                                                      SOLVEB........1900
      PIVOTI=1.D0/C(NI,IHBP)                                             SOLVEB........2000
      NJ=NI+1                                                            SOLVEB........2100
      IB=IHBP                                                            SOLVEB........2200
      NK=NI+IHALFB                                                       SOLVEB........2300
      DO 10 NL=NJ,NK                                                     SOLVEB........2400
      IB=IB-1                                                            SOLVEB........2500
      A=-C(NL,IB)*PIVOTI                                                 SOLVEB........2600
      C(NL,IB)=A                                                         SOLVEB........2700
      JB=IB+1                                                            SOLVEB........2800
      KB=IB+IHALFB                                                       SOLVEB........2900
      LB=IHBP-IB                                                         SOLVEB........3000
      DO10 MB=JB,KB                                                      SOLVEB........3100
      NB=LB+MB                                                           SOLVEB........3200
   10 C(NL,MB)=C(NL,MB)+A*C(NI,NB)                                       SOLVEB........3300
   20 CONTINUE                                                           SOLVEB........3400
      NR=NU+1                                                            SOLVEB........3500
      NU=NNP-1                                                           SOLVEB........3600
      NK=NNP                                                             SOLVEB........3700
      DO 40 NI=NR,NU                                                     SOLVEB........3800
      PIVOTI=1.D0/(C(NI,IHBP))                                           SOLVEB........3900
      NJ=NI+1                                                            SOLVEB........4000
      IB=IHBP                                                            SOLVEB........4100
      DO 30 NL=NJ,NK                                                     SOLVEB........4200
      IB=IB-1                                                            SOLVEB........4300
      A=-C(NL,IB)*PIVOTI                                                 SOLVEB........4400
      C(NL,IB)=A                                                         SOLVEB........4500
      JB=IB+1                                                            SOLVEB........4600
      KB=IB+IHALFB                                                       SOLVEB........4700
      LB=IHBP-IB                                                         SOLVEB........4800
      DO 30 MB=JB,KB                                                     SOLVEB........4900
      NB=LB+MB                                                           SOLVEB........5000
   30 C(NL,MB)=C(NL,MB)+A*C(NI,NB)                                       SOLVEB........5100
   40 CONTINUE                                                           SOLVEB........5200
      IF(KMT-1) 50,44,50                                                 SOLVEB........5300
   44 RETURN                                                             SOLVEB........5400
C                                                                        SOLVEB........5500
C.....UPDATE RIGHT-HAND SIDE VECTOR, R                                   SOLVEB........5600
   50 NU=NNP+1                                                           SOLVEB........5700
      IBAND=2*IHALFB+1                                                   SOLVEB........5800
      DO 70 NI=2,IHBP                                                    SOLVEB........5900
      IB=IHBP-NI+1                                                       SOLVEB........6000
      NJ=1                                                               SOLVEB........6100
      SUM=0.0D0                                                          SOLVEB........6200
      DO 60 JB=IB,IHALFB                                                 SOLVEB........6300
      SUM=SUM+C(NI,JB)*R(NJ)                                             SOLVEB........6400
   60 NJ=NJ+1                                                            SOLVEB........6500
   70 R(NI)=R(NI)+SUM                                                    SOLVEB........6600
      IB=1                                                               SOLVEB........6700
      NL=IHBP+1                                                          SOLVEB........6800
      DO 90 NI=NL,NNP                                                    SOLVEB........6900
      NJ=NI-IHBP+1                                                       SOLVEB........7000
      SUM=0.D0                                                           SOLVEB........7100
      DO 80 JB=IB,IHALFB                                                 SOLVEB........7200
      SUM=SUM+C(NI,JB)*R(NJ)                                             SOLVEB........7300
   80 NJ=NJ+1                                                            SOLVEB........7400
   90 R(NI)=R(NI)+SUM                                                    SOLVEB........7500
C                                                                        SOLVEB........7600
C.....BACK SOLVE                                                         SOLVEB........7700
      R(NNP)=R(NNP)/C(NNP,IHBP)                                          SOLVEB........7800
      DO 110 IB=2,IHBP                                                   SOLVEB........7900
      NI=NU-IB                                                           SOLVEB........8000
      NJ=NI                                                              SOLVEB........8100
      MB=IHALFB+IB                                                       SOLVEB........8200
      SUM=0.D0                                                           SOLVEB........8300
      DO 100 JB=NL,MB                                                    SOLVEB........8400
      NJ=NJ+1                                                            SOLVEB........8500
  100 SUM=SUM+C(NI,JB)*R(NJ)                                             SOLVEB........8600
  110 R(NI)=(R(NI)-SUM)/C(NI,IHBP)                                       SOLVEB........8700
      MB=IBAND                                                           SOLVEB........8800
      DO 130 IB=NL,NNP                                                   SOLVEB........8900
      NI=NU-IB                                                           SOLVEB........9000
      NJ=NI                                                              SOLVEB........9100
      SUM=0.D0                                                           SOLVEB........9200
      DO 120 JB=NL,MB                                                    SOLVEB........9300
      NJ=NJ+1                                                            SOLVEB........9400
  120 SUM=SUM+C(NI,JB)*R(NJ)                                             SOLVEB........9500
  130 R(NI)=(R(NI)-SUM)/C(NI,IHBP)                                       SOLVEB........9600
C                                                                        SOLVEB........9700
C                                                                        SOLVEB........9800
      RETURN                                                             SOLVEB........9900
      END                                                                SOLVEB.......10000
C                                                                        SOLVEB.......10100
C     SUBROUTINE        S  O  L  V  E  R           SUTRA VERSION 2.2     SOLVER.........100
C                                                                        SOLVER.........200
C *** PURPOSE :                                                          SOLVER.........300
C ***  TO CALL THE APPROPRIATE MATRIX EQUATION SOLVER.                   SOLVER.........400
C                                                                        SOLVER.........500
      SUBROUTINE SOLVER(KMT,KPU,KSOLVR,C,R,XITER,B,NNP,IHALFB,MAXNP,     SOLVER.........600
     1                  MAXBW,IWK,FWK,IA,JA,IERR,ITRS,ERR)               SOLVER.........700
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                SOLVER.........800
      CHARACTER SOLNAM(0:10)*40,SOLWRD(0:10)*10,KPUTXT(2)*1              SOLVER.........900
      DIMENSION C(MAXNP,MAXBW),R(NNVEC),XITER(NNP),B(NNNX)               SOLVER........1000
      DIMENSION IWK(NWI),FWK(NWF)                                        SOLVER........1100
      DIMENSION IA(NDIMIA),JA(NDIMJA)                                    SOLVER........1200
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        SOLVER........1300
      COMMON /DIMX2/ NELTA, NNVEC, NDIMIA, NDIMJA                        SOLVER........1400
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 SOLVER........1500
     1   K10,K11,K12,K13                                                 SOLVER........1600
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                SOLVER........1700
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            SOLVER........1800
      COMMON /SOLVC/ SOLWRD, SOLNAM                                      SOLVER........1900
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                           SOLVER........2000
      DATA (KPUTXT(K), K=1,2) /'P', 'U'/                                 SOLVER........2100
      SAVE KPUTXT                                                        SOLVER........2200
C                                                                        SOLVER........2300
C.....IF THE RIGHT-HAND-SIDE VECTOR OF THE MATRIX EQUATION IS ZERO,      SOLVER........2400
C        RETURN A ZERO SOLUTION VECTOR.                                  SOLVER........2500
      LENR = NNVEC                                                       SOLVER........2600
      RHSNRM = DNRM2(LENR, R, 1)                                         SOLVER........2700
      IF (RHSNRM.EQ.0D0) THEN                                            SOLVER........2800
         IERR = 0                                                        SOLVER........2900
         ITRS = 0                                                        SOLVER........2920
         ERR = 0D0                                                       SOLVER........2940
         DO 44 I=1,NNVEC                                                 SOLVER........3000
   44       R(I) = 0D0                                                   SOLVER........3100
         IF (KSCRN.EQ.1) WRITE(*,55) KPUTXT(KPU),KPUTXT(KPU),KPUTXT(KPU) SOLVER........3200
         WRITE (K00,55) KPUTXT(KPU), KPUTXT(KPU), KPUTXT(KPU)            SOLVER........3300
   55    FORMAT (1X, 6X, A1, '-solution (', A1, '=0)'                    SOLVER........3400
     1      ' inferred from matrix equation A*', A1, '=0;'               SOLVER........3500
     1      ' solver not called.')                                       SOLVER........3600
         RETURN                                                          SOLVER........3700
      END IF                                                             SOLVER........3800
C                                                                        SOLVER........3900
C.....SIGNAL THE START OF A SOLUTION                                     SOLVER........4000
  101 IF (KSCRN.EQ.1) WRITE(*,133) KPUTXT(KPU),TRIM(SOLWRD(KSOLVR))      SOLVER........4100
C      WRITE (K00,133) KPUTXT(KPU), TRIM(SOLWRD(KSOLVR))                  SOLVER........4200
  133 FORMAT (1X, 6X, "Starting ", A1, "-solution using ", A,            SOLVER........4300
     1   " solver ...")                                                  SOLVER........4400
C                                                                        SOLVER........4500
C.....IF KSOLVR=0, CALL BANDED GAUSSIAN (DIRECT) SOLVER.                 SOLVER........4600
C        OTHERWISE, CALL ITERATIVE SOLVER.                               SOLVER........4700
      IF (KSOLVR.EQ.0) THEN                                              SOLVER........4800
         CALL SOLVEB(KMT, C, R, NNP, IHALFB, MAXNP, MAXBW)               SOLVER........4900
         IERR = 0                                                        SOLVER........5000
         ITRS = 0                                                        SOLVER........5100
         ERR = 0D0                                                       SOLVER........5200
      ELSE                                                               SOLVER........5300
         CALL SOLWRP(KPU, KSOLVR, C, R, XITER, B, NNP,                   SOLVER........5400
     1         IWK, FWK, IA, JA, IERR, ITRS, ERR)                        SOLVER........5500
      END IF                                                             SOLVER........5600
C                                                                        SOLVER........5700
      RETURN                                                             SOLVER........5800
      END                                                                SOLVER........5900
C                                                                        SOLVER........6000
C     SUBROUTINE        S  O  L  W  R  P           SUTRA VERSION 2.2     SOLWRP.........100
C                                                                        SOLWRP.........200
C *** PURPOSE :                                                          SOLWRP.........300
C ***  TO SERVE AS A WRAPPER FOR THE ITERATIVE SOLVERS, PERFORMING       SOLWRP.........400
C ***  SOME PRELIMINARIES ON VECTORS BEFORE CALLING A SOLVER.            SOLWRP.........500
C                                                                        SOLWRP.........600
      SUBROUTINE SOLWRP(KPU, KSOLVR, A, R, XITER, B, NNP,                SOLWRP.........700
     1                  IWK, FWK, IA, JA, IERR, ITRS, ERR)               SOLWRP.........800
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                SOLWRP.........900
      CHARACTER*80 UNAME,FNAME(0:13)                                     SOLWRP........1000
      CHARACTER*1 KPUTXT(2)                                              SOLWRP........1100
      CHARACTER*40 SOLNAM(0:10)                                          SOLWRP........1200
      CHARACTER*10 SOLWRD(0:10)                                          SOLWRP........1300
      DIMENSION A(NELT)                                                  SOLWRP........1400
      DIMENSION IA(NDIMIA),JA(NDIMJA)                                    SOLWRP........1500
      DIMENSION IWK(NWI),FWK(NWF)                                        SOLWRP........1600
      DIMENSION XITER(NNP),R(NNP),B(NNNX)                                SOLWRP........1700
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        SOLWRP........1800
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA                           SOLWRP........1900
      COMMON /FNAMES/ UNAME,FNAME                                        SOLWRP........2000
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 SOLWRP........2100
     1   K10,K11,K12,K13                                                 SOLWRP........2200
      COMMON /ITSOLI/ ITRMXP,ITOLP,NSAVEP,ITRMXU,ITOLU,NSAVEU            SOLWRP........2300
      COMMON /ITSOLR/ TOLP,TOLU                                          SOLWRP........2400
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                SOLWRP........2500
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            SOLWRP........2600
      COMMON /SOLVC/ SOLWRD, SOLNAM                                      SOLWRP........2700
      COMMON /SOLVI/ KSOLVP, KSOLVU, NN1, NN2, NN3                       SOLWRP........2800
      COMMON /SOLVN/ NSLVRS                                              SOLWRP........2900
      DATA (KPUTXT(K), K=1,2) /'P', 'U'/                                 SOLWRP........3000
      SAVE KPUTXT                                                        SOLWRP........3100
      EXTERNAL DSLUGM,DSLUOM                                             SOLWRP........3200
C                                                                        SOLWRP........3300
C.....COPY THE RHS VECTOR R INTO VECTOR B, THEN USE R AS THE             SOLWRP........3400
C        SOLUTION VECTOR.  INITIALIZE IT FROM THE LATEST SUTRA           SOLWRP........3500
C        SOLUTION.  XITER IS NOT USED AS THE SOLUTION VECTOR BECAUSE     SOLWRP........3600
C        DOING SO MIGHT INTERFERE WITH SUBSEQUENT CALCULATIONS.          SOLWRP........3700
      DO 150 N=1,NNP                                                     SOLWRP........3800
         B(N) = R(N)                                                     SOLWRP........3900
         R(N) = XITER(N)                                                 SOLWRP........4000
  150 CONTINUE                                                           SOLWRP........4100
C                                                                        SOLWRP........4200
C.....SET ITERATIVE SOLVER PARAMETERS.                                   SOLWRP........4300
C        IUNITE --> UNIT ON WHICH TO WRITE SOLVER ERROR (0 = NONE)       SOLWRP........4400
C        ISYM  --> 0 = FULL STORAGE; 1 = SYMMETRIC STORAGE               SOLWRP........4500
C        ITRMX --> MAXIMUM NUMBER OF SOLVER ITERATIONS                   SOLWRP........4600
C        ITOL  --> TYPE OF CONVERGENCE CRITERION                         SOLWRP........4700
C        TOL   --> CONVERGENCE TOLERANCE                                 SOLWRP........4800
C        NSAVE --> NUMBER OF DIRECTION VECTORS                           SOLWRP........4900
      IF (KPU.EQ.1) THEN                                                 SOLWRP........5000
C........SET PARAMETERS FOR ITERATIVE P SOLUTION.                        SOLWRP........5100
         ISYM = 0                                                        SOLWRP........5200
         ITRMX = MAX(ITRMXP, 1)                                          SOLWRP........5300
         ITOL = ITOLP                                                    SOLWRP........5400
         TOL = TOLP                                                      SOLWRP........5500
         NSAVE = NSAVEP                                                  SOLWRP........5600
      ELSE                                                               SOLWRP........5700
C........SET PARAMETERS FOR ITERATIVE U SOLUTION.                        SOLWRP........5800
         ISYM = 0                                                        SOLWRP........5900
         ITRMX = MAX(ITRMXU, 1)                                          SOLWRP........6000
         ITOL = ITOLU                                                    SOLWRP........6100
         TOL = TOLU                                                      SOLWRP........6200
         NSAVE = NSAVEU                                                  SOLWRP........6300
      END IF                                                             SOLWRP........6400
      IUNITE = K00                                                       SOLWRP........6500
C                                                                        SOLWRP........6600
C.....CALL AN ITERATIVE SOLVER:                                          SOLWRP........6700
C        DSICCG = CG WITH IC PRECONDITIONING,                            SOLWRP........6800
C        DSLUGM = GMRES WITH ILU PRECONDITIONING,                        SOLWRP........6900
C        DSLUOM = ORTHOMIN WITH ILU PRECONDITIONING.                     SOLWRP........7000
      IF (KSOLVR.EQ.1) THEN                                              SOLWRP........7100
         CALL DSICCG(NNP, B, R, NELT, IA, JA, A, ISYM, ITOL, TOL,        SOLWRP........7200
     1            ITRMX, ITRS, ERR, IERR, IUNITE, FWK, NWF, IWK, NWI)    SOLWRP........7300
      ELSE IF (KSOLVR.EQ.2) THEN                                         SOLWRP........7400
         CALL DSLUGM(NNP, B, R, NELT, IA, JA, A, ISYM, NSAVE, ITOL, TOL, SOLWRP........7500
     1            ITRMX, ITRS, ERR, IERR, IUNITE, FWK, NWF, IWK, NWI)    SOLWRP........7600
      ELSE                                                               SOLWRP........7700
         CALL DSLUOM(NNP, B, R, NELT, IA, JA, A, ISYM, NSAVE, ITOL, TOL, SOLWRP........7800
     1            ITRMX, ITRS, ERR, IERR, IUNITE, FWK, NWF, IWK, NWI)    SOLWRP........7900
      END IF                                                             SOLWRP........8000
C                                                                        SOLWRP........8100
C.....WRITE CONVERGENCE INFORMATION.                                     SOLWRP........8200
      IF (IERR.EQ.0) THEN                                                SOLWRP........8300
         IF (KSCRN.EQ.1) WRITE (*,555) KPUTXT(KPU), ITRS, ERR            SOLWRP........8400
         WRITE (K00,555) KPUTXT(KPU), ITRS, ERR                          SOLWRP........8500
  555    FORMAT (1X, 6X, A1, '-solution converged in ', I5,              SOLWRP........8600
     1      ' solver iterations  (Error ~ ', 1PE8.1, ')')                SOLWRP........8700
      ELSE                                                               SOLWRP........8800
         IF (KSCRN.EQ.1) WRITE (*,557) KPUTXT(KPU), ITRS, ERR            SOLWRP........8900
         WRITE (K00,557) KPUTXT(KPU), ITRS, ERR                          SOLWRP........9000
  557    FORMAT (1X, 6X, A1, '-solution FAILED after ', I5,              SOLWRP........9100
     1      ' solver iterations  (Error ~ ', 1PE8.1, ')')                SOLWRP........9200
      END IF                                                             SOLWRP........9300
C                                                                        SOLWRP........9400
      RETURN                                                             SOLWRP........9500
      END                                                                SOLWRP........9600
C                                                                        SOLWRP........9700
C     SUBROUTINE        S  O  U  R  C  E           SUTRA VERSION 2.2     SOURCE.........100
C                                                                        SOURCE.........200
C *** PURPOSE :                                                          SOURCE.........300
C ***  TO READ AND ORGANIZE DEFAULT VALUES FOR FLUID MASS SOURCE DATA    SOURCE.........400
C ***  AND ENERGY OR SOLUTE MASS SOURCE DATA.                            SOURCE.........500
C                                                                        SOURCE.........600
      SUBROUTINE SOURCE(QIN,UIN,IQSOP,QUIN,IQSOU,IQSOPT,IQSOUT,          SOURCE.........700
     1   IBCSOP,IBCSOU,NDPT,NREF)
C     1   IBCSOP,IBCSOU)                                                  SOURCE.........800

      USE EXPINT                                                         SOURCE.........900
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                SOURCE........1000
      CHARACTER INTFIL*1000                                              SOURCE........1100
      CHARACTER*80 ERRCOD,CHERR(10),UNAME,FNAME(0:13)                    SOURCE........1200
      INTEGER(1) IBCSOP(NSOP),IBCSOU(NSOU)                               SOURCE........1300
      DIMENSION KTYPE(2)                                                 SOURCE........1400
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  SOURCE........1500
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           SOURCE........1600
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      SOURCE........1700
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              SOURCE........1800
     1   NSOP,NSOU,NBCN,NCIDB                                            SOURCE........1900
      COMMON /FNAMES/ UNAME,FNAME                                        SOURCE........2000
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 SOURCE........2100
     1   K10,K11,K12,K13                                                 SOURCE........2200
      COMMON /DEPTH/  MXD,NFY
      DIMENSION QIN(NN),UIN(NN),IQSOP(NSOP),QUIN(NN),IQSOU(NSOU)         SOURCE........2300
      DIMENSION INERR(10),RLERR(10)                                      SOURCE........2400
      INTEGER NDPT(NSOP)
      INTEGER NREF(NSOP)
C                                                                        SOURCE........2500
C.....NSOPI IS ACTUAL NUMBER OF FLUID SOURCE NODES.                      SOURCE........2600
C.....NSOUI IS ACTUAL NUMBER OF SOLUTE MASS OR ENERGY SOURCE NODES.      SOURCE........2700
      NSOPI=NSOP-1                                                       SOURCE........2800
      NSOUI=NSOU-1                                                       SOURCE........2900
      NIQP=0                                                             SOURCE........3200
      NFY=0
      NIQU=0                                                             SOURCE........3300
      IF(NSOPI.EQ.0) GOTO 1000                                           SOURCE........3400
      IF(ME) 50,50,150                                                   SOURCE........3500
   50 WRITE(K3,100)                                                      SOURCE........3600
  100 FORMAT('1'////11X,'F L U I D   S O U R C E   D A T A'              SOURCE........3700
     1   ////11X,'**** NODES AT WHICH FLUID INFLOWS OR OUTFLOWS ARE ',   SOURCE........3800
     2   'SPECIFIED ****'                                                SOURCE........3900
     3   //16X,13X,'DEFAULT FLUID',5X,'DEFAULT CONCENTRATION'            SOURCE........4000
     4    /16X,6X,'INFLOW(+)/OUTFLOW(-)',8X,'OF INFLOWING FLUID'         SOURCE........4100
     5    /12X,'NODE',7X,'(FLUID MASS/SECOND)',2X,                       SOURCE........4200
     6   '(MASS SOLUTE/MASS WATER)'//)                                   SOURCE........4300
      GOTO 300                                                           SOURCE........4400
  150 WRITE(K3,200)                                                      SOURCE........4500
  200 FORMAT('1'////11X,'F L U I D   S O U R C E   D A T A'              SOURCE........4600
     1   ////11X,'**** NODES AT WHICH FLUID INFLOWS OR OUTFLOWS ARE ',   SOURCE........4700
     2   'SPECIFIED ****'                                                SOURCE........4800
     3   //16X,13X,'DEFAULT FLUID',5X,'  DEFAULT TEMPERATURE'            SOURCE........4900
     4    /16X,6X,'INFLOW(+)/OUTFLOW(-)',8X,'OF INFLOWING FLUID'         SOURCE........5000
     5    /12X,'NODE',7X,'(FLUID MASS/SECOND)',2X,                       SOURCE........5100
     6   '       (DEGREES CELSIUS)'//)                                   SOURCE........5200
C                                                                        SOURCE........5300
C.....INPUT DATASET 17:  DATA FOR FLUID SOURCES AND SINKS                SOURCE........5400
  300 CONTINUE                                                           SOURCE........5500
  305 NIQP=NIQP+1                                                        SOURCE........5600
      ERRCOD = 'REA-INP-17'                                              SOURCE........5700
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 SOURCE........5800
      READ(INTFIL,*,IOSTAT=INERR(1)) IQCP                                SOURCE........5900
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        SOURCE........6000
      IQCPA = IABS(IQCP)                                                 SOURCE........6100
      IF (IQCP.EQ.0) THEN                                                SOURCE........6200
         GOTO 700                                                        SOURCE........6300
      ELSE IF (IQCPA.GT.NN) THEN                                         SOURCE........6400
         ERRCOD = 'INP-17-1'                                             SOURCE........6500
         INERR(1) = IQCPA                                                SOURCE........6600
         INERR(2) = NN                                                   SOURCE........6700
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SOURCE........6800
      ELSE IF (NIQP.GT.NSOPI) THEN                                       SOURCE........6900
         GOTO 305                                                        SOURCE........7000
      END IF                                                             SOURCE........7100
      ERRCOD = 'REA-INP-17'                                              SOURCE........7200
      IF (IQCP.GT.0) THEN                                                SOURCE........7300
C         READ(INTFIL,*,IOSTAT=INERR(1)) IQCP,QINC                        SOURCE........7400
C         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     SOURCE........7500
C         IF (QINC.GT.0D0) THEN                                           SOURCE........7600
            READ(INTFIL,*,IOSTAT=INERR(1)) IQCP,QINC,UINC                SOURCE........7700
            IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)  SOURCE........7800
C         ELSE                                                            SOURCE........7900
C            UINC = 0D0                                                   SOURCE........8000
C         END IF                                                          SOURCE........8100
C      ELSE                                                               SOURCE........8200
C     THE DEPTH OF THE NODE
      ELSEIF (IQCP.LT.0) THEN
         READ(INTFIL,*,IOSTAT=INERR(1)) IQCP,NDP,NDF
         QINC = 0D0                                                      SOURCE........8300
         UINC = 0D0                                                      SOURCE........8400
      END IF                                                             SOURCE........8500
      IQSOP(NIQP)=IQCP                                                   SOURCE........8600
      IF(IQCP.LT.0) IQSOPT=-1                                            SOURCE........8700
      IF(IQCP.LT.0) THEN
      NDPT(NIQP)=NDP
      NREF(NIQP)=NDF
      IF(NDP.GT.MXD) MXD=NDP
        IF (NDP.EQ.1) NFY=NFY+1 !NUMBER OF NODE IN THE FIRST LAYER
      ELSE
      NDPT(NIQP)=0
      NREF(NIQP)=0
      ENDIF
      IQP=IABS(IQCP)                                                     SOURCE........8800
      QIN(IQP)=QINC                                                      SOURCE........8900
      UIN(IQP)=UINC                                                      SOURCE........9000
      IF(IQCP.GT.0) GOTO 450                                             SOURCE........9100
      WRITE(K3,500) IQCP                                                 SOURCE........9200
      GOTO 600                                                           SOURCE........9300
  450 IF(QINC.GT.0) GOTO 460                                             SOURCE........9400
      WRITE(K3,500) IQCP,QINC                                            SOURCE........9500
      GOTO 600                                                           SOURCE........9600
  460 WRITE(K3,500) IQCP,QINC,UINC                                       SOURCE........9700
  500 FORMAT(7X,I9,6X,1PE20.13,6X,1PE20.13)                              SOURCE........9800
  600 GOTO 305                                                           SOURCE........9900
  700 NIQP = NIQP - 1                                                    SOURCE.......10000
      IF(NIQP.EQ.NSOPI) GOTO 800                                         SOURCE.......10100
         ERRCOD = 'INP-3,17-1'                                           SOURCE.......10200
         INERR(1) = NIQP                                                 SOURCE.......10300
         INERR(2) = NSOPI                                                SOURCE.......10400
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SOURCE.......10500
  800 IF(IQSOPT.NE.-1) GOTO 950                                          SOURCE.......10600
      IF(ME) 805,805,815                                                 SOURCE.......10700
  805 WRITE(K3,806)                                                      SOURCE.......10800
  806 FORMAT(//12X,'TIME-DEPENDENT FLUID SOURCE/SINK OR INFLOW ',        SOURCE.......10900
     1   'CONCENTRATION'/12X,'SET IN SUBROUTINE BCTIME IS INDICATED ',   SOURCE.......11000
     2   'BY NEGATIVE NODE NUMBER')                                      SOURCE.......11100
      GOTO 950                                                           SOURCE.......11200
  815 WRITE(K3,816)                                                      SOURCE.......11300
  816 FORMAT(//12X,'TIME-DEPENDENT FLUID SOURCE/SINK OR INFLOW ',        SOURCE.......11400
     1   'TEMPERATURE'/12X,'SET IN SUBROUTINE BCTIME IS INDICATED ',     SOURCE.......11500
     2   'BY NEGATIVE NODE NUMBER')                                      SOURCE.......11600
  950 WRITE(K3,952)                                                      SOURCE.......11700
  952 FORMAT(/11X,'SPECIFICATIONS MADE IN (OPTIONAL) ',                  SOURCE.......11800
     1   'BCS INPUT FILES TAKE PRECEDENCE OVER THE'/11X,                 SOURCE.......11900
     2   'DEFAULT VALUES LISTED ABOVE AND ANY VALUES ',                  SOURCE.......12000
     3   'SET IN SUBROUTINE BCTIME.')                                    SOURCE.......12100
C.....INITIALIZE ARRAY THAT INDICATES WHERE FLUID SOURCE                 SOURCE.......12200
C        CONDITIONS WERE SET (0 = INP FILE)                              SOURCE.......12300
      IBCSOP = 0                                                         SOURCE.......12400
C                                                                        SOURCE.......12500
C                                                                        SOURCE.......12600
C                                                                        SOURCE.......12700
 1000 IF(NSOUI.EQ.0) GOTO 9000                                           SOURCE.......12800
      IF(ME) 1050,1050,1150                                              SOURCE.......12900
 1050 WRITE(K3,1100)                                                     SOURCE.......13000
 1100 FORMAT(////////11X,'S O L U T E   S O U R C E   D A T A'           SOURCE.......13100
     1   ////11X,'**** NODES AT WHICH SOURCES OR SINKS OF SOLUTE ',      SOURCE.......13200
     2   'MASS ARE SPECIFIED ****'                                       SOURCE.......13300
     3   //16X,12X,'DEFAULT SOLUTE'/16X,9X,'SOURCE(+)/SINK(-)'           SOURCE.......13400
     4    /12X,'NODE',6X,'(SOLUTE MASS/SECOND)'//)                       SOURCE.......13500
      GOTO 1305                                                          SOURCE.......13600
 1150 WRITE(K3,1200)                                                     SOURCE.......13700
 1200 FORMAT(////////11X,'E N E R G Y   S O U R C E   D A T A'           SOURCE.......13800
     1   ////11X,'**** NODES AT WHICH SOURCES OR SINKS OF ',             SOURCE.......13900
     2   'ENERGY ARE SPECIFIED ****'                                     SOURCE.......14000
     3   //16X,12X,'DEFAULT ENERGY'/16X,9X,'SOURCE(+)/SINK(-)'           SOURCE.......14100
     4    /12X,'NODE',11X,'(ENERGY/SECOND)'//)                           SOURCE.......14200
C                                                                        SOURCE.......14300
C.....INPUT DATASET 18:  DATA FOR ENERGY OR SOLUTE MASS SOURCES OR SINKS SOURCE.......14400
 1305 NIQU=NIQU+1                                                        SOURCE.......14500
      ERRCOD = 'REA-INP-18'                                              SOURCE.......14600
      CALL READIF(K1, 0, INTFIL, ERRCOD)                                 SOURCE.......14700
      READ(INTFIL,*,IOSTAT=INERR(1)) IQCU                                SOURCE.......14800
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        SOURCE.......14900
      IQCUA = IABS(IQCU)                                                 SOURCE.......15000
      IF (IQCU.EQ.0) THEN                                                SOURCE.......15100
         GOTO 1700                                                       SOURCE.......15200
      ELSE IF (IQCUA.GT.NN) THEN                                         SOURCE.......15300
         ERRCOD = 'INP-18-1'                                             SOURCE.......15400
         INERR(1) = IQCUA                                                SOURCE.......15500
         INERR(2) = NN                                                   SOURCE.......15600
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SOURCE.......15700
      ELSE IF (NIQU.GT.NSOUI) THEN                                       SOURCE.......15800
         GOTO 1305                                                       SOURCE.......15900
      END IF                                                             SOURCE.......16000
      IF (IQCU.GT.0) THEN                                                SOURCE.......16100
         ERRCOD = 'REA-INP-18'                                           SOURCE.......16200
         READ(INTFIL,*,IOSTAT=INERR(1)) IQCU,QUINC                       SOURCE.......16300
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     SOURCE.......16400
      ELSE                                                               SOURCE.......16500
         QUINC = 0D0                                                     SOURCE.......16600
      END IF                                                             SOURCE.......16700
      IQSOU(NIQU)=IQCU                                                   SOURCE.......16800
      IF(IQCU.LT.0) IQSOUT=-1                                            SOURCE.......16900
      IQU=IABS(IQCU)                                                     SOURCE.......17000
      QUIN(IQU)=QUINC                                                    SOURCE.......17100
      IF(IQCU.GT.0) GOTO 1450                                            SOURCE.......17200
      WRITE(K3,1500) IQCU                                                SOURCE.......17300
      GOTO 1600                                                          SOURCE.......17400
 1450 WRITE(K3,1500) IQCU,QUINC                                          SOURCE.......17500
 1500 FORMAT(7X,I9,6X,1PE20.13)                                          SOURCE.......17600
 1600 GOTO 1305                                                          SOURCE.......17700
 1700 NIQU = NIQU - 1                                                    SOURCE.......17800
      IF(NIQU.EQ.NSOUI) GOTO 1800                                        SOURCE.......17900
         ERRCOD = 'INP-3,18-1'                                           SOURCE.......18000
         IF (ME.EQ.1) THEN                                               SOURCE.......18100
            CHERR(1) = 'energy'                                          SOURCE.......18200
         ELSE                                                            SOURCE.......18300
            CHERR(1) = 'solute'                                          SOURCE.......18400
         END IF                                                          SOURCE.......18500
         INERR(1) = NIQU                                                 SOURCE.......18600
         INERR(2) = NSOUI                                                SOURCE.......18700
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SOURCE.......18800
 1800 IF(IQSOPT.NE.-1) GOTO 6000                                         SOURCE.......18900
      IF(ME) 1805,1805,1815                                              SOURCE.......19000
 1805 WRITE(K3,1806)                                                     SOURCE.......19100
 1806 FORMAT(//12X,'TIME-DEPENDENT SOLUTE SOURCE/SINK SET IN ',          SOURCE.......19200
     1   /12X,'SUBROUTINE BCTIME IS INDICATED ',                         SOURCE.......19300
     2   'BY NEGATIVE NODE NUMBER')                                      SOURCE.......19400
      GOTO 6000                                                          SOURCE.......19500
 1815 WRITE(K3,1816)                                                     SOURCE.......19600
 1816 FORMAT(//12X,'TIME-DEPENDENT ENERGY SOURCE/SINK SET IN ',          SOURCE.......19700
     1   /12X,'SUBROUTINE BCTIME IS INDICATED ',                         SOURCE.......19800
     2   'BY NEGATIVE NODE NUMBER')                                      SOURCE.......19900
 6000 WRITE(K3,952)                                                      SOURCE.......20000
C.....INITIALIZE ARRAY THAT INDICATES WHERE ENERGY OR SOLUTE SOURCE      SOURCE.......20100
C        CONDITIONS WERE SET (0 = INP FILE)                              SOURCE.......20200
      IBCSOU = 0                                                         SOURCE.......20300
C                                                                        SOURCE.......20400
C                                                                        SOURCE.......20500
 9000 RETURN                                                             SOURCE.......20600
C                                                                        SOURCE.......20700
      END                                                                SOURCE.......20800
C                                                                        SOURCE.......20900
C     SUBROUTINE        S  O  U  R  C  E  1        SUTRA VERSION 2.2     SOURCE1........100
C                                                                        SOURCE1........200
C *** PURPOSE :                                                          SOURCE1........300
C ***  TO READ AND ORGANIZE TIME-DEPENDENT FLUID MASS SOURCE DATA AND    SOURCE1........400
C ***  ENERGY OR SOLUTE MASS SOURCE DATA SPECIFIED IN THE OPTIONAL       SOURCE1........500
C ***  BCS INPUT FILE.                                                   SOURCE1........600
C                                                                        SOURCE1........700
      SUBROUTINE SOURCE1(QIN1,UIN1,IQSOP1,QUIN1,IQSOU1,IQSOPT1,IQSOUT1,  SOURCE1........800
     1   NSOP1,NSOU1,NFB,BCSID)                                          SOURCE1........900
      USE EXPINT                                                         SOURCE1.......1000
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                SOURCE1.......1100
      CHARACTER INTFIL*1000                                              SOURCE1.......1200
      CHARACTER*80 ERRCOD,CHERR(10),UNAME,FNAME(0:13)                    SOURCE1.......1300
      CHARACTER*40 BCSID                                                 SOURCE1.......1400
      DIMENSION KTYPE(2)                                                 SOURCE1.......1500
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  SOURCE1.......1600
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           SOURCE1.......1700
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      SOURCE1.......1800
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              SOURCE1.......1900
     1   NSOP,NSOU,NBCN,NCIDB                                            SOURCE1.......2000
      COMMON /FNAMES/ UNAME,FNAME                                        SOURCE1.......2100
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 SOURCE1.......2200
     1   K10,K11,K12,K13                                                 SOURCE1.......2300
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       SOURCE1.......2400
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      SOURCE1.......2500
      DIMENSION QIN1(NN),UIN1(NN),IQSOP1(NSOP1)                          SOURCE1.......2600
      DIMENSION QUIN1(NN),IQSOU1(NSOU1)                                  SOURCE1.......2700
      DIMENSION INERR(10),RLERR(10)                                      SOURCE1.......2800
C                                                                        SOURCE1.......2900
C.....NSOPI1 IS ACTUAL NUMBER OF TIME-STEP-DEPENDENT FLUID SOURCE NODES. SOURCE1.......3000
C.....NSOUI1 IS ACTUAL NUMBER OF TIME-STEP-DEPENDENT SOLUTE MASS OR      SOURCE1.......3100
C        ENERGY SOURCE NODES.                                            SOURCE1.......3200
      NSOPI1=NSOP1 - 1                                                   SOURCE1.......3300
      NSOUI1=NSOU1 - 1                                                   SOURCE1.......3400
C                                                                        SOURCE1.......3500
      NIQP = 0                                                           SOURCE1.......3600
      NIQU = 0                                                           SOURCE1.......3700
      IQSOPT1 = +1                                                       SOURCE1.......3800
      IQSOUT1 = +1                                                       SOURCE1.......3900
C                                                                        SOURCE1.......4000
      IF (NSOPI1.EQ.0) GOTO 1000                                         SOURCE1.......4100
C                                                                        SOURCE1.......4200
C.....INPUT BCS DATASET 3:  DATA FOR FLUID SOURCES AND SINKS             SOURCE1.......4300
      IQSOPT1 = -1                                                       SOURCE1.......4400
  305 NIQP = NIQP + 1                                                    SOURCE1.......4500
      ERRCOD = 'REA-BCS-3'                                               SOURCE1.......4600
      WRITE(CHERR(1),*) ITBCS                                            SOURCE1.......4700
      CHERR(2) = BCSID                                                   SOURCE1.......4800
      CALL READIF(K9, NFB, INTFIL, ERRCOD, CHERR)                        SOURCE1.......4900
      READ(INTFIL,*,IOSTAT=INERR(1)) IQCP                                SOURCE1.......5000
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        SOURCE1.......5100
      IQP = IABS(IQCP)                                                   SOURCE1.......5200
      IF (IQCP.EQ.0) THEN                                                SOURCE1.......5300
         GOTO 700                                                        SOURCE1.......5400
      ELSE IF (IQP.GT.NN) THEN                                           SOURCE1.......5500
         ERRCOD = 'BCS-3-1'                                              SOURCE1.......5600
         INERR(1) = IQP                                                  SOURCE1.......5700
         INERR(2) = NN                                                   SOURCE1.......5800
         INERR(3) = ITBCS                                                SOURCE1.......5900
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SOURCE1.......6000
      ELSE IF (NIQP.GT.NSOPI1) THEN                                      SOURCE1.......6100
         GOTO 305                                                        SOURCE1.......6200
      END IF                                                             SOURCE1.......6300
      ERRCOD = 'REA-BCS-3'                                               SOURCE1.......6400
      WRITE(CHERR(1),*) ITBCS                                            SOURCE1.......6500
      CHERR(2) = BCSID                                                   SOURCE1.......6600
      IF (IQCP.GT.0) THEN                                                SOURCE1.......6700
         READ(INTFIL,*,IOSTAT=INERR(1)) IQCP,QINC                        SOURCE1.......6800
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     SOURCE1.......6900
         IF (QINC.GT.0D0) THEN                                           SOURCE1.......7000
            READ(INTFIL,*,IOSTAT=INERR(1)) IQCP,QINC,UINC                SOURCE1.......7100
            IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)  SOURCE1.......7200
            QIN1(IQP)=QINC                                               SOURCE1.......7300
            UIN1(IQP)=UINC                                               SOURCE1.......7400
         ELSE                                                            SOURCE1.......7500
            QIN1(IQP)=QINC                                               SOURCE1.......7600
         END IF                                                          SOURCE1.......7700
      END IF                                                             SOURCE1.......7800
      IQSOP1(NIQP)=IQCP                                                  SOURCE1.......7900
  600 GOTO 305                                                           SOURCE1.......8000
  700 NIQP = NIQP - 1                                                    SOURCE1.......8100
      IF(NIQP.EQ.NSOPI1) GOTO 1000                                       SOURCE1.......8200
         ERRCOD = 'BCS-2,3-1'                                            SOURCE1.......8300
         INERR(1) = NIQP                                                 SOURCE1.......8400
         INERR(2) = NSOPI1                                               SOURCE1.......8500
         INERR(3) = ITBCS                                                SOURCE1.......8600
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SOURCE1.......8700
C                                                                        SOURCE1.......8800
C                                                                        SOURCE1.......8900
 1000 IF(NSOUI1.EQ.0) GOTO 9000                                          SOURCE1.......9000
C                                                                        SOURCE1.......9100
C.....INPUT BCS DATASET 4:  DATA FOR ENERGY OR SOLUTE MASS SOURCES       SOURCE1.......9200
C        OR SINKS                                                        SOURCE1.......9300
      IQSOUT1 = -1                                                       SOURCE1.......9400
 1305 NIQU=NIQU+1                                                        SOURCE1.......9500
      ERRCOD = 'REA-BCS-4'                                               SOURCE1.......9600
      WRITE(CHERR(1),*) ITBCS                                            SOURCE1.......9700
      CHERR(2) = BCSID                                                   SOURCE1.......9800
      CALL READIF(K9, NFB, INTFIL, ERRCOD, CHERR)                        SOURCE1.......9900
      READ(INTFIL,*,IOSTAT=INERR(1)) IQCU                                SOURCE1......10000
      IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)        SOURCE1......10100
      IQU = IABS(IQCU)                                                   SOURCE1......10200
      IF (IQCU.EQ.0) THEN                                                SOURCE1......10300
         GOTO 1700                                                       SOURCE1......10400
      ELSE IF (IQU.GT.NN) THEN                                           SOURCE1......10500
         ERRCOD = 'BCS-4-1'                                              SOURCE1......10600
         INERR(1) = IQU                                                  SOURCE1......10700
         INERR(2) = NN                                                   SOURCE1......10800
         INERR(3) = ITBCS                                                SOURCE1......10900
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SOURCE1......11000
      ELSE IF (NIQU.GT.NSOUI1) THEN                                      SOURCE1......11100
         GOTO 1305                                                       SOURCE1......11200
      END IF                                                             SOURCE1......11300
      IF (IQCU.GT.0) THEN                                                SOURCE1......11400
         ERRCOD = 'REA-BCS-4'                                            SOURCE1......11500
         WRITE(CHERR(1),*) ITBCS                                         SOURCE1......11600
         CHERR(2) = BCSID                                                SOURCE1......11700
         READ(INTFIL,*,IOSTAT=INERR(1)) IQCU,QUINC                       SOURCE1......11800
         IF (INERR(1).NE.0) CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)     SOURCE1......11900
         QUIN1(IQU)=QUINC                                                SOURCE1......12000
      END IF                                                             SOURCE1......12100
      IQSOU1(NIQU)=IQCU                                                  SOURCE1......12200
 1600 GOTO 1305                                                          SOURCE1......12300
 1700 NIQU = NIQU - 1                                                    SOURCE1......12400
      IF(NIQU.EQ.NSOUI1) GOTO 9000                                       SOURCE1......12500
         ERRCOD = 'BCS-2,4-1'                                            SOURCE1......12600
         IF (ME.EQ.1) THEN                                               SOURCE1......12700
            CHERR(1) = 'energy'                                          SOURCE1......12800
         ELSE                                                            SOURCE1......12900
            CHERR(1) = 'solute'                                          SOURCE1......13000
         END IF                                                          SOURCE1......13100
         INERR(1) = NIQU                                                 SOURCE1......13200
         INERR(2) = NSOUI1                                               SOURCE1......13300
         INERR(3) = ITBCS                                                SOURCE1......13400
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SOURCE1......13500
C                                                                        SOURCE1......13600
 9000 RETURN                                                             SOURCE1......13700
C                                                                        SOURCE1......13800
      END                                                                SOURCE1......13900
C                                                                        SOURCE1......14000
C     SUBROUTINE        S  U  T  E  R  R           SUTRA VERSION 2.2     SUTERR.........100
C                                                                        SUTERR.........200
C *** PURPOSE :                                                          SUTERR.........300
C ***  TO HANDLE SUTRA AND FORTRAN ERRORS.                               SUTERR.........400
C                                                                        SUTERR.........500
      SUBROUTINE SUTERR(ERRCOD, CHERR, INERR, RLERR)                     SUTERR.........600
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                SUTERR.........700
      CHARACTER*80 ERRCOD,CHERR(10),CODE(3),CODUM(3),UNAME,FNAME(0:13)   SUTERR.........800
      CHARACTER*70 DS(50),EX(50)                                         SUTERR.........900
      CHARACTER CDUM80*80                                                SUTERR........1000
      CHARACTER CINERR(10)*9,CRLERR(10)*15                               SUTERR........1100
      CHARACTER SOLNAM(0:10)*40,SOLWRD(0:10)*10                          SUTERR........1200
      CHARACTER*8 VERNUM, VERNIN                                         SUTERR........1300
      DIMENSION INERR(10), RLERR(10)                                     SUTERR........1400
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              SUTERR........1500
     1   NSOP,NSOU,NBCN,NCIDB                                            SUTERR........1600
      COMMON /FNAMES/ UNAME,FNAME                                        SUTERR........1700
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 SUTERR........1800
     1   K10,K11,K12,K13                                                 SUTERR........1900
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                SUTERR........2000
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            SUTERR........2100
      COMMON /SOLVC/ SOLWRD,SOLNAM                                       SUTERR........2200
      COMMON /SOLVN/ NSLVRS                                              SUTERR........2300
      COMMON /VER/ VERNUM, VERNIN                                        SUTERR........2400
C                                                                        SUTERR........2500
C.....PARSE THE ERROR CODE                                               SUTERR........2600
      CALL PRSWDS(ERRCOD, '-', 3, CODE, NWORDS)                          SUTERR........2700
C                                                                        SUTERR........2800
C.....IF AN ERROR OTHER THAN A MATRIX SOLVER OR NONLINEAR CONVERGENCE    SUTERR........2900
C        ERROR HAS OCCURRED, OVERRIDE THE SCREEN OUTPUT CONTROLS SO      SUTERR........3000
C        THAT THE ERROR IS PRINTED TO THE SCREEN AND SUTRA PAUSES FOR    SUTERR........3100
C        A USER RESPONSE.                                                SUTERR........3200
      IF ((CODE(1).NE.'SOL').AND.(CODE(1).NE.'CON')) THEN                SUTERR........3300
         KSCRN = +1                                                      SUTERR........3400
         KPAUSE = +1                                                     SUTERR........3500
      END IF                                                             SUTERR........3600
C                                                                        SUTERR........3700
C.....COPY INTEGER AND REAL ERROR PARAMETERS INTO CHARACTER STRINGS      SUTERR........3800
      DO 150 I=1,10                                                      SUTERR........3900
         WRITE(UNIT=CINERR(I), FMT='(I9)') INERR(I)                      SUTERR........4000
         WRITE(UNIT=CRLERR(I), FMT='(1PE15.7)') RLERR(I)                 SUTERR........4100
  150 CONTINUE                                                           SUTERR........4200
C                                                                        SUTERR........4300
C.....INITIALIZE THE ERROR OUTPUT STRINGS                                SUTERR........4400
      DO 200 I=1,50                                                      SUTERR........4500
         DS(I) = "null_line"                                             SUTERR........4600
         EX(I) = "null_line"                                             SUTERR........4700
  200 CONTINUE                                                           SUTERR........4800
C                                                                        SUTERR........4900
C.....SET THE ERROR OUTPUT STRINGS ACCORDING TO THE TYPE OF ERROR        SUTERR........5000
      IF (ERRCOD.EQ.'INP-2A-1') THEN                                     SUTERR........5100
        DS(1)="The first word of SIMULA is not 'SUTRA'."                 SUTERR........5200
        EX(1)="In dataset 2A of the main input file, the first word"     SUTERR........5300
        EX(2)="of the variable SIMULA must be 'SUTRA'."                  SUTERR........5400
        EX(3)=" "                                                        SUTERR........5500
        EX(4)="Example of a valid dataset 2A:"                           SUTERR........5600
        EX(5)="'SUTRA SOLUTE TRANSPORT'"                                 SUTERR........5700
      ELSE IF (ERRCOD.EQ.'INP-2A-2') THEN                                SUTERR........5800
        DS(1)="The second word of SIMULA is not 'SOLUTE' or 'ENERGY'."   SUTERR........5900
        EX(1)="In dataset 2A of the main input file, when the second"    SUTERR........6000
        EX(2)="word is not 'VERSION', the version 2.0 input format is"   SUTERR........6100
        EX(3)="assumed, and the second word must be 'SOLUTE' or"         SUTERR........6200
        EX(4)="'ENERGY'."                                                SUTERR........6300
        EX(5)=" "                                                        SUTERR........6400
        EX(6)="Example of a valid (version 2.0) dataset 2A:"             SUTERR........6500
        EX(7)="'SUTRA SOLUTE TRANSPORT'"                                 SUTERR........6600
      ELSE IF (ERRCOD.EQ.'INP-2A-3') THEN                                SUTERR........6700
        DS(1)="The fourth word of SIMULA is not 'SOLUTE' or 'ENERGY'."   SUTERR........6800
        EX(1)="In dataset 2A of the main input file, the fourth word"    SUTERR........6900
        EX(2)="must be 'SOLUTE' or 'ENERGY' (unless the version 2.0"     SUTERR........7000
        EX(3)="input format is being used)."                             SUTERR........7100
        EX(4)=" "                                                        SUTERR........7200
        EX(5)="Example of a valid (version 2.0) dataset 2A:"             SUTERR........7300
        EX(6)="'SUTRA VERSION " // TRIM(VERNUM) // " SOLUTE TRANSPORT'"  SUTERR........7400
      ELSE IF (ERRCOD.EQ.'INP-2A-4') THEN                                SUTERR........7500
        DS(1)="Unsupported SUTRA version: " // CHERR(1)                  SUTERR........7600
        EX(1)="Input files from SUTRA version " // TRIM(CHERR(1))        SUTERR........7700
        EX(2)="are not supported by version " // TRIM(VERNUM) // "."     SUTERR........7800
      ELSE IF (ERRCOD.EQ.'INP-2B-1') THEN                                SUTERR........7900
        DS(1)="The first word of MSHSTR is not '2D' or '3D'."            SUTERR........8000
        EX(1)="In dataset 2B of the main input file, the first word"     SUTERR........8100
        EX(2)="of the variable MSHSTR must be '2D' or '3D'."             SUTERR........8200
        EX(3)=" "                                                        SUTERR........8300
        EX(4)="Example of a valid dataset 2B:"                           SUTERR........8400
        EX(5)="'3D REGULAR MESH'  10  20  30"                            SUTERR........8500
C.....ERROR CODE 'INP-2B-2' IS NO LONGER USED.                           SUTERR........8600
      ELSE IF (ERRCOD.EQ.'INP-2B-3') THEN                                SUTERR........8700
        DS(1)="At least one of the rectangular dimensions NN1, NN2,"     SUTERR........8800
        DS(2)="and NN3 is set improperly."                               SUTERR........8900
        EX(1)="In dataset 2B of the main input file, the rectangular"    SUTERR........9000
        EX(2)="dimensions NN1, NN2, and (for 3D problems) NN3 must"      SUTERR........9100
        EX(3)="each be greater than 1."                                  SUTERR........9200
        EX(4)=" "                                                        SUTERR........9300
        EX(5)="Example of a valid dataset 2B:"                           SUTERR........9400
        EX(6)="'3D BLOCKWISE MESH'  10  20  30"                          SUTERR........9500
      ELSE IF (ERRCOD.EQ.'INP-2B-4') THEN                                SUTERR........9600
        DS(1)="The second word of MSHSTR is not 'IRREGULAR', 'REGULAR'," SUTERR........9700
        DS(2)="'BLOCKWISE', or 'LAYERED'."                               SUTERR........9800
        EX(1)="In dataset 2B of the main input file, the second word"    SUTERR........9900
        EX(2)="of the variable MSHSTR must be 'IRREGULAR', 'REGULAR',"   SUTERR.......10000
        EX(3)="'BLOCKWISE' or 'LAYERED'.  By definition, only 3D meshes" SUTERR.......10100
        EX(4)="can be LAYERED."                                          SUTERR.......10200
        EX(5)=" "                                                        SUTERR.......10300
        EX(6)="Example of a valid dataset 2B:"                           SUTERR.......10400
        EX(7)="'3D REGULAR MESH'  10  20  30"                            SUTERR.......10500
      ELSE IF (ERRCOD.EQ.'INP-2B-5') THEN                                SUTERR.......10600
        DS(1)="A 2D LAYERED mesh has been specified."                    SUTERR.......10700
        EX(1)="By definition, only 3D meshes can be LAYERED."            SUTERR.......10800
        EX(2)=" "                                                        SUTERR.......10900
        EX(3)="Example of a valid dataset 2B:"                           SUTERR.......11000
        EX(4)="'3D LAYERED MESH'  10  2560  2210  'ACROSS'"              SUTERR.......11100
      ELSE IF (ERRCOD.EQ.'INP-2B-6') THEN                                SUTERR.......11200
        DS(1)="The first word of LAYSTR is not 'ACROSS' or 'WITHIN'."    SUTERR.......11300
        EX(1)="In dataset 2B of the main input file, the first word"     SUTERR.......11400
        EX(2)="of the variable LAYSTR must be 'ACROSS' or 'WITHIN'."     SUTERR.......11500
        EX(3)=" "                                                        SUTERR.......11600
        EX(4)="Example of a valid dataset 2B:"                           SUTERR.......11700
        EX(5)="'3D LAYERED MESH'  10  2560  2210  'ACROSS'"              SUTERR.......11800
      ELSE IF (ERRCOD.EQ.'INP-2B-7') THEN                                SUTERR.......11900
        DS(1)="At least one of the layer dimensions NLAYS, NNLAY,"       SUTERR.......12000
        DS(2)="and NELAY is set improperly."                             SUTERR.......12100
        EX(1)="In dataset 2B of the main input file, the layer"          SUTERR.......12200
        EX(2)="dimensions are subject to the following constraints:"     SUTERR.......12300
        EX(3)="NLAYS>1, NNLAY>3, and NELAY>0."                           SUTERR.......12400
        EX(4)=" "                                                        SUTERR.......12500
        EX(5)="Example of a valid dataset 2B:"                           SUTERR.......12600
        EX(6)="'3D LAYERED MESH'  10  2560  2210  'ACROSS'"              SUTERR.......12700
      ELSE IF (ERRCOD.EQ.'INP-2B,3-1') THEN                              SUTERR.......12800
        DS(1)="The number of nodes, NN, does not match the rectangular"  SUTERR.......12900
        DS(2)="dimensions, NN1*NN2(*NN3)."                               SUTERR.......13000
        EX(1)="In datasets 2B and 3 of the main input file, the total"   SUTERR.......13100
        EX(2)="number of nodes, NN, must equal the product of the"       SUTERR.......13200
        EX(3)="rectangular dimensions, NN1*NN2 in 2D, or NN1*NN2*NN3"    SUTERR.......13300
        EX(4)="in 3D."                                                   SUTERR.......13400
        EX(5)=" "                                                        SUTERR.......13500
        EX(6)="Example:"                                                 SUTERR.......13600
        EX(7)="If NN1=10, NN2=20, and NN3=30 (dataset 2B), then"         SUTERR.......13700
        EX(8)="NN=10*20*30=6000 (dataset 3)."                            SUTERR.......13800
      ELSE IF (ERRCOD.EQ.'INP-2B,3-2') THEN                              SUTERR.......13900
        DS(1)="The number of elements, NE, does not match the"           SUTERR.......14000
        DS(2)="rectangular dimensions, (NN1-1)*(NN2-1)[*(NN3-1)]."       SUTERR.......14100
        EX(1)="In datasets 2B and 3 of the main input file, the total"   SUTERR.......14200
        EX(2)="number of elements, NE, must equal the product of the"    SUTERR.......14300
        EX(3)="rectangular dimensions, (NN1-1)*(NN2-1) in 2D, or"        SUTERR.......14400
        EX(4)="(NN1-1)*(NN2-1)*(NN3-1) in 3D."                           SUTERR.......14500
        EX(5)=" "                                                        SUTERR.......14600
        EX(6)="Example:"                                                 SUTERR.......14700
        EX(7)="If NN1=10, NN2=20, and NN3=30 (dataset 2B), then"         SUTERR.......14800
        EX(8)="NE=9*19*29=4959 (dataset 3)."                             SUTERR.......14900
      ELSE IF (ERRCOD.EQ.'INP-2B,3-3') THEN                              SUTERR.......15000
        DS(1)="The number of nodes, NN, does not match the layered"      SUTERR.......15100
        DS(2)="dimensions, NLAYS*NNLAY."                                 SUTERR.......15200
        EX(1)="In datasets 2B and 3 of the main input file, the total"   SUTERR.......15300
        EX(2)="number of nodes, NN, must equal the product of the"       SUTERR.......15400
        EX(3)="layered dimensions, NLAYS*NNLAY."                         SUTERR.......15500
        EX(4)=" "                                                        SUTERR.......15600
        EX(5)="Example:"                                                 SUTERR.......15700
        EX(6)="If NLAYS=10 and NNLAY=2560 (dataset 2B), then"            SUTERR.......15800
        EX(7)="NN=10*2560=25600 (dataset 3)."                            SUTERR.......15900
      ELSE IF (ERRCOD.EQ.'INP-2B,3-4') THEN                              SUTERR.......16000
        DS(1)="The number of nodes, NE, does not match the layered"      SUTERR.......16100
        DS(2)="dimensions, (NLAYS-1)*NELAY."                             SUTERR.......16200
        EX(1)="In datasets 2B and 3 of the main input file, the total"   SUTERR.......16300
        EX(2)="number of nodes, NE, must equal the product of the"       SUTERR.......16400
        EX(3)="layered dimensions, (NLAYS-1)*NELAY."                     SUTERR.......16500
        EX(4)=" "                                                        SUTERR.......16600
        EX(5)="Example:"                                                 SUTERR.......16700
        EX(6)="If NLAYS=10 and NELAY=2210 (dataset 2B), then"            SUTERR.......16800
        EX(7)="NN=9*2210=19890 (dataset 3)."                             SUTERR.......16900
      ELSE IF (ERRCOD.EQ.'INP-4-1') THEN                                 SUTERR.......17000
        DS(1)="The first word of CUNSAT is not 'SATURATED' or"           SUTERR.......17100
        DS(2)="'UNSATURATED'."                                           SUTERR.......17200
        EX(1)="In dataset 4 of the main input file, the first word"      SUTERR.......17300
        EX(2)="of the variable CUNSAT must be 'SATURATED' or"            SUTERR.......17400
        EX(3)="'UNSATURATED'."                                           SUTERR.......17500
        EX(4)=" "                                                        SUTERR.......17600
        EX(5)="Example of a valid dataset 4:"                            SUTERR.......17700
        EX(6)="'SATURATED FLOW' 'STEADY FLOW' 'TRANSIENT TRANSPORT'" //  SUTERR.......17800
     1        " 'COLD' 10"                                               SUTERR.......17900
      ELSE IF (ERRCOD.EQ.'INP-4-2') THEN                                 SUTERR.......18000
        DS(1)="The first word of CSSFLO is not 'STEADY' or 'TRANSIENT'." SUTERR.......18100
        EX(1)="In dataset 4 of the main input file, the first word"      SUTERR.......18200
        EX(2)="of the variable CSSFLO must be 'STEADY' or 'TRANSIENT'."  SUTERR.......18300
        EX(3)=" "                                                        SUTERR.......18400
        EX(4)="Example of a valid dataset 4:"                            SUTERR.......18500
        EX(5)="'SATURATED FLOW' 'STEADY FLOW' 'TRANSIENT TRANSPORT'" //  SUTERR.......18600
     1        " 'COLD' 10"                                               SUTERR.......18700
      ELSE IF (ERRCOD.EQ.'INP-4-3') THEN                                 SUTERR.......18800
        DS(1)="The first word of CSSTRA is not 'STEADY' or 'TRANSIENT'." SUTERR.......18900
        EX(1)="In dataset 4 of the main input file, the first word"      SUTERR.......19000
        EX(2)="of the variable CSSTRA must be 'STEADY' or 'TRANSIENT'."  SUTERR.......19100
        EX(3)=" "                                                        SUTERR.......19200
        EX(4)="Example of a valid dataset 4:"                            SUTERR.......19300
        EX(5)="'SATURATED FLOW' 'STEADY FLOW' 'TRANSIENT TRANSPORT'" //  SUTERR.......19400
     1        " 'COLD' 10"                                               SUTERR.......19500
      ELSE IF (ERRCOD.EQ.'INP-4-4') THEN                                 SUTERR.......19600
        DS(1)="The first word of CREAD is not 'COLD' or 'WARM'."         SUTERR.......19700
        EX(1)="In dataset 4 of the main input file, the first word"      SUTERR.......19800
        EX(2)="of the variable CREAD must be 'COLD' or 'WARM'."          SUTERR.......19900
        EX(3)=" "                                                        SUTERR.......20000
        EX(4)="Example of a valid dataset 4:"                            SUTERR.......20100
        EX(5)="'SATURATED FLOW' 'STEADY FLOW' 'TRANSIENT TRANSPORT'" //  SUTERR.......20200
     1        " 'COLD' 10"                                               SUTERR.......20300
      ELSE IF (ERRCOD.EQ.'INP-4-5') THEN                                 SUTERR.......20400
        DS(1)="Specified TRANSIENT flow with STEADY transport."          SUTERR.......20500
        EX(1)="In dataset 4 of the main input file, TRANSIENT flow"      SUTERR.......20600
        EX(2)="requires TRANSIENT transport.  Likewise, STEADY"          SUTERR.......20700
        EX(3)="transport requires STEADY flow.  The following are"       SUTERR.......20800
        EX(4)="valid combinations:"                                      SUTERR.......20900
        EX(5)=" "                                                        SUTERR.......21000
        EX(6)="     CSSFLO      CSSTRA"                                  SUTERR.......21100
        EX(7)="   ----------- -----------"                               SUTERR.......21200
        EX(8)="    'STEADY'    'STEADY'"                                 SUTERR.......21300
        EX(9)="    'STEADY'   'TRANSIENT'"                               SUTERR.......21400
        EX(10)="   'TRANSIENT' 'TRANSIENT'"                              SUTERR.......21500
        EX(11)=" "                                                       SUTERR.......21600
        EX(12)="Example of a valid dataset 4:"                           SUTERR.......21700
        EX(13)="'SATURATED FLOW' 'STEADY FLOW' 'STEADY TRANSPORT'" //    SUTERR.......21800
     1        " 'COLD' 10"                                               SUTERR.......21900
      ELSE IF (ERRCOD.EQ.'INP-7B&C-1') THEN                              SUTERR.......22000
        DS(1)="Unrecognized solver name."                                SUTERR.......22100
        EX(1)="In datasets 7B&C, valid solver selections are:"           SUTERR.......22200
        EX(2)=" "                                                        SUTERR.......22300
        DO 400 M=0,NSLVRS-1                                              SUTERR.......22400
           EX(M+3)=SOLWRD(M) // " --> " // SOLNAM(M)                     SUTERR.......22500
  400   CONTINUE                                                         SUTERR.......22600
        EX(NSLVRS+3)=" "                                                 SUTERR.......22700
        EX(NSLVRS+4)="Note that solver selections for P and U must be"   SUTERR.......22800
        EX(NSLVRS+5)="both DIRECT or both iterative."                    SUTERR.......22900
      ELSE IF (ERRCOD.EQ.'INP-7B&C-2') THEN                              SUTERR.......23000
        DS(1)="Solver selections for P and U are not both DIRECT or"     SUTERR.......23100
        DS(2)="both iterative."                                          SUTERR.......23200
        EX(1)="The solver selections for P and U must be both"           SUTERR.......23300
        EX(2)="DIRECT or both iterative."                                SUTERR.......23400
      ELSE IF (ERRCOD.EQ.'INP-7B&C-3') THEN                              SUTERR.......23500
        DS(1)="Invalid selection of the CG solver."                      SUTERR.......23600
        EX(1)="The CG solver may be used only for the flow (P) equation" SUTERR.......23700
        EX(2)="with no upstream weighting (UP=0.0).  It may not be used" SUTERR.......23800
        EX(3)="for the transport (U) equation."                          SUTERR.......23900
C.....ERROR CODE 'INP-7B&C-4' IS NO LONGER USED.                         SUTERR.......24000
      ELSE IF (ERRCOD.EQ.'INP-3,19-1') THEN                              SUTERR.......24100
        DS(1)="The actual number of specified pressure nodes, "          SUTERR.......24200
     1        // CINERR(1) // ","                                        SUTERR.......24300
        DS(2)="does not equal the input value,                "          SUTERR.......24400
     1        // CINERR(2) // "."                                        SUTERR.......24500
        EX(1)="In dataset 3 of the main input file, the variable NPBC"   SUTERR.......24600
        EX(2)="must specify the exact number of specified pressure"      SUTERR.......24700
        EX(3)="nodes listed in dataset 19."                              SUTERR.......24800
      ELSE IF (ERRCOD.EQ.'INP-3,20-1') THEN                              SUTERR.......24900
        DS(1)="The actual number of specified conc. nodes, "             SUTERR.......25000
     1        // CINERR(1) // ","                                        SUTERR.......25100
        DS(2)="does not equal the input value,             "             SUTERR.......25200
     1        // CINERR(2) // "."                                        SUTERR.......25300
        EX(1)="In dataset 3 of the main input file, the variable NUBC"   SUTERR.......25400
        EX(2)="must specify the exact number of specified concentration" SUTERR.......25500
        EX(3)="nodes listed in dataset 20."                              SUTERR.......25600
      ELSE IF (ERRCOD.EQ.'INP-3,20-2') THEN                              SUTERR.......25700
        DS(1)="The actual number of specified temp. nodes, "             SUTERR.......25800
     1        // CINERR(1) // ","                                        SUTERR.......25900
        DS(2)="does not equal the input value,             "             SUTERR.......26000
     1        // CINERR(2) // "."                                        SUTERR.......26100
        EX(1)="In dataset 3 of the main input file, the variable NUBC"   SUTERR.......26200
        EX(2)="must specify the exact number of specified temperature"   SUTERR.......26300
        EX(3)="nodes listed in dataset 20."                              SUTERR.......26400
      ELSE IF (ERRCOD.EQ.'INP-22-1') THEN                                SUTERR.......26500
        DS(1)="Line 1 of the element incidence data does not begin with" SUTERR.......26600
        DS(2)="the word 'INCIDENCE'."                                    SUTERR.......26700
        EX(1)="In dataset 22 of the main input file, the first line"     SUTERR.......26800
        EX(2)="must begin with the word 'INCIDENCE'."                    SUTERR.......26900
      ELSE IF (ERRCOD.EQ.'INP-22-2') THEN                                SUTERR.......27000
        DS(1)="The incidence data for element " // CINERR(1)             SUTERR.......27100
        DS(2)="are not in numerical order in the dataset."               SUTERR.......27200
        EX(1)="In dataset 22 of the main input file, incidence data"     SUTERR.......27300
        EX(2)="must be listed in order of increasing element number."    SUTERR.......27400
        EX(3)="Note that the numbering of elements must begin at 1"      SUTERR.......27500
        EX(4)="and be continuous; element numbers may not be skipped."   SUTERR.......27600
      ELSE IF (ERRCOD.EQ.'INP-14B,22-1') THEN                            SUTERR.......27700
        DS(1)="At least one element has incorrect geometry."             SUTERR.......27800
        EX(1)="Incorrect element geometry can result from improper"      SUTERR.......27900
        EX(2)="specification of node coordinates in dataset 14B of the"  SUTERR.......28000
        EX(3)="main input file, or from improper ordering of nodes in"   SUTERR.......28100
        EX(4)="a node incidence list in dataset 22 of the same file."    SUTERR.......28200
      ELSE IF (ERRCOD.EQ.'FIL-1') THEN                                   SUTERR.......28300
        DS(1)="The file " // CHERR(2)                                    SUTERR.......28400
        DS(2)="does not exist."                                          SUTERR.......28500
        EX(1)="One of the files required by SUTRA does not exist."       SUTERR.......28600
        EX(2)="Check the filename and the directory path."               SUTERR.......28700
      ELSE IF (ERRCOD.EQ.'FIL-2') THEN                                   SUTERR.......28800
        DS(1)="The file " // CHERR(2)                                    SUTERR.......28900
        DS(2)="could not be opened on FORTRAN unit " // CINERR(1) // "." SUTERR.......29000
        EX(1)="One of the files required by SUTRA could not be opened."  SUTERR.......29100
        EX(2)="Check to make sure the file is not protected or in use"   SUTERR.......29200
        EX(3)="by another application, and that the FORTRAN unit number" SUTERR.......29300
        EX(4)="is valid."                                                SUTERR.......29400
C.....ERROR CODE 'FIL-3' IS NO LONGER USED.                              SUTERR.......29500
      ELSE IF (ERRCOD.EQ.'FIL-4') THEN                                   SUTERR.......29600
        DS(1)="An attempt was made to use the file"                      SUTERR.......29700
        DS(2)=CHERR(2)                                                   SUTERR.......29800
        DS(3)="for more than one purpose simultaneously."                SUTERR.......29900
        EX(1)='Each filename listed in "SUTRA.FIL" must be unique'       SUTERR.......30000
        EX(2)='and may not be reused in an "@INSERT" statement.'         SUTERR.......30100
        EX(3)='Also, if you have nested "@INSERT" statements'            SUTERR.......30200
        EX(4)='(i.e., a file inserted into a file, which is itself'      SUTERR.......30300
        EX(5)='inserted into a file, etc.), a given file may be'         SUTERR.......30400
        EX(6)='used only once in the nested sequence.'                   SUTERR.......30500
      ELSE IF (ERRCOD.EQ.'FIL-5') THEN                                   SUTERR.......30600
        DS(1)="Invalid file type: " // CHERR(2)                          SUTERR.......30700
        EX(1)="Valid file types are:"                                    SUTERR.......30800
        EX(2)='   INP (".inp" input file)'                               SUTERR.......30900
        EX(3)='   ICS (".ics" input file)'                               SUTERR.......31000
        EX(4)='   BCS (".bcs" input file)'                               SUTERR.......31100
        EX(5)='   SMY (".smy" output file)'                              SUTERR.......31200
        EX(6)='   LST (".lst" output file)'                              SUTERR.......31300
        EX(7)='   RST (".rst" output file)'                              SUTERR.......31400
        EX(8)='   NOD (".nod" output file)'                              SUTERR.......31500
        EX(9)='   ELE (".ele" output file)'                              SUTERR.......31600
        EX(10)='   OBS (".obs" output file)'                             SUTERR.......31700
        EX(11)='   OBC (".obc" output file)'                             SUTERR.......31800
        EX(12)='   BCOF (".bcof" output file)'                           SUTERR.......31900
        EX(13)='   BCOP (".bcop" output file)'                           SUTERR.......32000
        EX(14)='   BCOS (".bcos" output file)'                           SUTERR.......32100
        EX(15)='   BCOU (".bcou" output file)'                           SUTERR.......32200
      ELSE IF (ERRCOD.EQ.'FIL-6') THEN                                   SUTERR.......32300
        DS(1)="File type " // CHERR(2)                                   SUTERR.......32400
        DS(2)="has been assigned more than once."                        SUTERR.......32500
        EX(1)="The following file types must be assigned:"               SUTERR.......32600
        EX(2)='   INP (".inp" input file)'                               SUTERR.......32700
        EX(3)='   ICS (".ics" input file)'                               SUTERR.......32800
        EX(4)='   LST (".lst" output file)'                              SUTERR.......32900
        EX(5)="The following file types are optional:"                   SUTERR.......33000
        EX(6)='   BCS (".bcs" input file)'                               SUTERR.......33100
        EX(7)='   SMY (".smy" output file; defaults to "SUTRA.SMY")'     SUTERR.......33200
        EX(8)='   RST (".rst" output file)'                              SUTERR.......33300
        EX(9)='   NOD (".nod" output file)'                              SUTERR.......33400
        EX(10)='   ELE (".ele" output file)'                             SUTERR.......33500
        EX(11)='   OBS (".obs" output file)'                             SUTERR.......33600
        EX(12)='   OBC (".obc" output file)'                             SUTERR.......33700
        EX(13)='   BCOF (".bcof" output file)'                           SUTERR.......33800
        EX(14)='   BCOP (".bcop" output file)'                           SUTERR.......33900
        EX(15)='   BCOS (".bcos" output file)'                           SUTERR.......34000
        EX(16)='   BCOU (".bcou" output file)'                           SUTERR.......34100
        EX(17)="No file type except BCS may be assigned more than once." SUTERR.......34200
      ELSE IF (ERRCOD.EQ.'FIL-7') THEN                                   SUTERR.......34300
        DS(1)="Required file type " // CHERR(2)                          SUTERR.......34400
        DS(2)="has not been assigned."                                   SUTERR.......34500
        EX(1)="The following file types must be assigned:"               SUTERR.......34600
        EX(2)='   INP (".inp" input file)'                               SUTERR.......34700
        EX(3)='   ICS (".ics" input file)'                               SUTERR.......34800
        EX(4)='   LST (".lst" output file)'                              SUTERR.......34900
        EX(5)="The following file types are optional:"                   SUTERR.......35000
        EX(6)='   BCS (".bcs" input file)'                               SUTERR.......35100
        EX(7)='   SMY (".smy" output file; defaults to "SUTRA.SMY")'     SUTERR.......35200
        EX(8)='   RST (".rst" output file)'                              SUTERR.......35300
        EX(9)='   NOD (".nod" output file)'                              SUTERR.......35400
        EX(10)='   ELE (".ele" output file)'                             SUTERR.......35500
        EX(11)='   OBS (".obs" output file)'                             SUTERR.......35600
        EX(12)='   OBC (".obc" output file)'                             SUTERR.......35700
        EX(13)='   BCOF (".bcof" output file)'                           SUTERR.......35800
        EX(14)='   BCOP (".bcop" output file)'                           SUTERR.......35900
        EX(15)='   BCOS (".bcos" output file)'                           SUTERR.......36000
        EX(16)='   BCOU (".bcou" output file)'                           SUTERR.......36100
        EX(17)="No file type except BCS may be assigned more than once." SUTERR.......36200
      ELSE IF (ERRCOD.EQ.'FIL-8') THEN                                   SUTERR.......36300
        DS(1)="The file " // CHERR(2)                                    SUTERR.......36400
        DS(2)="could not be inserted."                                   SUTERR.......36500
        EX(1)="Inserts cannot be nested more than 20 levels deep."       SUTERR.......36600
      ELSE IF (ERRCOD.EQ.'FIL-9') THEN                                   SUTERR.......36700
        DS(1)="A file listed in 'SUTRA.FIL' is named 'SUTRA.FIL'."       SUTERR.......36800
        EX(1)="The filename 'SUTRA.FIL' is reserved by SUTRA."           SUTERR.......36900
        EX(2)="Files listed in 'SUTRA.FIL' may not be named"             SUTERR.......37000
        EX(3)="'SUTRA.FIL'."                                             SUTERR.......37100
      ELSE IF (ERRCOD.EQ.'FIL-10') THEN                                  SUTERR.......37200
        DS(1)="SUTRA was unable to automatically"                        SUTERR.......37300
        DS(2)="assign unit number " // CINERR(1)                         SUTERR.......37400
        DS(3)="to file " // CHERR(2)                                     SUTERR.......37500
        EX(1)="SUTRA attempted to automatically assign to one of the "   SUTERR.......37600
        EX(2)="files listed in 'SUTRA.FIL' a unit number that is not"    SUTERR.......37700
        EX(3)="allowed on this computer.  Please check the unit"         SUTERR.......37800
        EX(4)="number assignments in 'SUTRA.FIL'.  It may be possible"   SUTERR.......37900
        EX(5)="to avoid this problem by explicitly assigning a"          SUTERR.......38000
        EX(6)="different unit number to the file in question or by"      SUTERR.......38100
        EX(7)="reducing the number of optional files listed in"          SUTERR.......38200
        EX(8)="'SUTRA.FIL'."                                             SUTERR.......38300
      ELSE IF (ERRCOD.EQ.'INP-6-1') THEN                                 SUTERR.......38400
        DS(1)="NPCYC<1 and/or NUCYC<1."                                  SUTERR.......38500
        EX(1)="In dataset 6 of the main input file, both NPCYC and"      SUTERR.......38600
        EX(2)="NUCYC must be set greater than or equal to 1."            SUTERR.......38700
      ELSE IF (ERRCOD.EQ.'INP-6-2') THEN                                 SUTERR.......38800
        DS(1)="Neither NPCYC nor NUCYC is set to 1."                     SUTERR.......38900
        EX(1)="In dataset 6 of the main input file, either NPCYC or"     SUTERR.......39000
        EX(2)="NUCYC (or both) must be set to 1."                        SUTERR.......39100
      ELSE IF (ERRCOD.EQ.'INP-6-3') THEN                                 SUTERR.......39200
        DS(1)="DELT is greater than DTMAX."                              SUTERR.......39300
        EX(1)="In dataset 6 of the main input file, DELT must be set"    SUTERR.......39400
        EX(2)="less than or equal to DTMAX."                             SUTERR.......39500
      ELSE IF (ERRCOD.EQ.'INP-6-4') THEN                                 SUTERR.......39600
        DS(1)="The actual number of schedules listed does not equal"     SUTERR.......39700
        DS(2)="the input value, or the schedule list does not end"       SUTERR.......39800
        DS(3)="with '-'."                                                SUTERR.......39900
        EX(1)="In dataset 6 of the main input file, the number of"       SUTERR.......40000
        EX(2)="schedules listed must equal the number, NSCH, specified"  SUTERR.......40100
        EX(3)="in dataset 6 of the same file, and the final entry in"    SUTERR.......40200
        EX(4)="the list must be '-'."                                    SUTERR.......40300
        EX(5)=" "                                                        SUTERR.......40400
        EX(6)="Example of a valid dataset 6 with two schedules:"         SUTERR.......40500
        EX(7)="2   1   1"                                                SUTERR.......40600
        EX(8)="'TIME_STEPS' 'TIME CYCLE' 'ELAPSED'  1. 100   0. " //     SUTERR.......40700
     1     "3.e+9 3.e+7 999 1. 0. 1.e+99"                                SUTERR.......40800
        EX(9)="'SCHED_A'    'STEP LIST'        4   20  40  60  80"       SUTERR.......40900
        EX(10)="'-'"                                                     SUTERR.......41000
      ELSE IF (ERRCOD.EQ.'INP-6-5') THEN                                 SUTERR.......41100
        DS(1)="Multiple definitions of schedule " // CHERR(1)            SUTERR.......41200
        EX(1)="A given schedule name may not be defined more than once"  SUTERR.......41300
        EX(2)="in dataset 6 of the main input file."                     SUTERR.......41400
      ELSE IF (ERRCOD.EQ.'INP-6-6') THEN                                 SUTERR.......41500
        DS(1)="Invalid time descriptor " // CHERR(1)                     SUTERR.......41600
        EX(1)="Time-based schedules must be defined in terms of either"  SUTERR.......41700
        EX(2)="ABSOLUTE or ELAPSED times."                               SUTERR.......41800
      ELSE IF (ERRCOD.EQ.'INP-6-7') THEN                                 SUTERR.......41900
        DS(1)="ELAPSED times in TIME_STEPS schedule,"                    SUTERR.......42000
        DS(2)="but initial elapsed time is not zero."                    SUTERR.......42100
        EX(1)="When the TIME_STEPS schedule is defined in terms of"      SUTERR.......42200
        EX(2)="ELAPSED times, the first (initial) elapsed time in the"   SUTERR.......42300
        EX(3)="schedule must be set to zero."                            SUTERR.......42400
      ELSE IF (ERRCOD.EQ.'INP-6-8') THEN                                 SUTERR.......42500
        DS(1)="Invalid number of schedules (NSCH<0)."                    SUTERR.......42600
        EX(1)="The number of schedules, NSCH, must be non-negative."     SUTERR.......42700
        EX(2)="NSCH=0 is allowed only if flow and transport are both"    SUTERR.......42800
        EX(3)="steady-state."                                            SUTERR.......42900
      ELSE IF (ERRCOD.EQ.'INP-6-9') THEN                                 SUTERR.......43000
        DS(1)="Invalid schedule type " // CHERR(1)                       SUTERR.......43100
        EX(1)="An invalid schedule type has been specified."             SUTERR.......43200
        EX(2)="Valid schedule types are:"                                SUTERR.......43300
        EX(3)="   'TIME CYCLE'"                                          SUTERR.......43400
        EX(4)="   'TIME LIST'"                                           SUTERR.......43500
        EX(5)="   'STEP CYCLE'"                                          SUTERR.......43600
        EX(6)="   'STEP LIST'"                                           SUTERR.......43700
      ELSE IF (ERRCOD.EQ.'INP-6-10') THEN                                SUTERR.......43800
        DS(1)="Incomplete TIME_STEPS schedule."                          SUTERR.......43900
        EX(1)="The TIME_STEPS schedule must contain at least two"        SUTERR.......44000
        EX(2)="distinct times, including the starting time."             SUTERR.......44100
      ELSE IF (ERRCOD.EQ.'INP-6-11') THEN                                SUTERR.......44200
        DS(1)="Invalid user-defined schedule name, " // TRIM(CHERR(1))   SUTERR.......44300
        EX(1)="Schedule names 'STEP_0', 'STEP_1', and 'STEPS_1&UP'"      SUTERR.......44400
        EX(2)="are reserved by SUTRA and may not be used to name a"      SUTERR.......44500
        EX(3)="user-defined schedule."                                   SUTERR.......44600
      ELSE IF (ERRCOD.EQ.'INP-6-12') THEN                                SUTERR.......44700
        DS(1)="Repeated " // TRIM(CHERR(1)) // " " // CRLERR(1)          SUTERR.......44800
        DS(2)="in schedule " // CHERR(2)                                 SUTERR.......44900
        EX(1)="A time or time step value may not appear more than once"  SUTERR.......45000
        EX(2)="in a given schedule."                                     SUTERR.......45100
      ELSE IF (ERRCOD.EQ.'INP-6-13') THEN                                SUTERR.......45200
        DS(1)="Invalid number of schedules (NSCH=0)."                    SUTERR.......45300
        EX(1)="NSCH=0 is allowed only if flow and transport are both"    SUTERR.......45400
        EX(2)="steady-state."                                            SUTERR.......45500
      ELSE IF (ERRCOD.EQ.'INP-6-14') THEN                                SUTERR.......45600
        DS(1)="Missing TIME_STEPS schedule."                             SUTERR.......45700
        EX(1)="When transport is transient, a TIME_STEPS schedule must"  SUTERR.......45800
        EX(2)="be defined by the user in dataset 6."                     SUTERR.......45900
      ELSE IF (ERRCOD.EQ.'INP-6-15') THEN                                SUTERR.......46000
        DS(1)="Schedule name " // CHERR(1)                               SUTERR.......46100
        DS(2)="is too long"                                              SUTERR.......46200
        EX(1)="Schedule names are limited to 10 characters."             SUTERR.......46300
      ELSE IF ((ERRCOD.EQ.'INP-8A-1').OR.(ERRCOD.EQ.'INP-8A-2')          SUTERR.......46400
     1     .OR.(ERRCOD.EQ.'INP-8A-3').OR.(ERRCOD.EQ.'INP-8A-4')          SUTERR.......46500
     2     .OR.(ERRCOD.EQ.'INP-8A-5').OR.(ERRCOD.EQ.'INP-8A-6')          SUTERR.......46600
     3     .OR.(ERRCOD.EQ.'INP-8A-7').OR.(ERRCOD.EQ.'INP-8A-8')          SUTERR.......46700
     4     .OR.(ERRCOD.EQ.'INP-8A-9')) THEN                              SUTERR.......46800
        DS(1)=CHERR(1)(1:6) // " is not 'Y' or 'N'."                     SUTERR.......46900
        EX(1)="In dataset 8A of the main input file, " // CHERR(1)(1:6)  SUTERR.......47000
        EX(2)="must be set to either 'Y' or 'N'."                        SUTERR.......47100
        EX(3)=" "                                                        SUTERR.......47200
        EX(4)="Example of a valid dataset 8A:"                           SUTERR.......47300
        EX(5)="10  'N' 'N' 'N' 'Y' 'Y' 'Y' 'Y' 'Y' 'Y' 'Y' 'Y'"          SUTERR.......47400
      ELSE IF (ERRCOD.EQ.'INP-8B-1') THEN                                SUTERR.......47500
        DS(1)="Node number listed in column other than column 1."        SUTERR.......47600
        EX(1)="In dataset 8B of the main input file, if the node number" SUTERR.......47700
        EX(2)="is to appear, it must appear only in column 1, i.e.,"     SUTERR.......47800
        EX(3)="only NCOL(1) can be set to 'N'."                          SUTERR.......47900
      ELSE IF (ERRCOD.EQ.'INP-8B-2') THEN                                SUTERR.......48000
        DS(1)="Specified that 'Z' be output for a 2D problem."           SUTERR.......48100
        EX(1)="In dataset 8B of the main input file, 'Z' can be listed"  SUTERR.......48200
        EX(2)="only if the problem is 3D."                               SUTERR.......48300
      ELSE IF (ERRCOD.EQ.'INP-8B-3') THEN                                SUTERR.......48400
        DS(1)="Unrecognized value for NCOL."                             SUTERR.......48500
        EX(1)="In dataset 8B of the main input file, the following"      SUTERR.......48600
        EX(2)="variables may be listed:"                                 SUTERR.......48700
        EX(3)=" "                                                        SUTERR.......48800
        EX(4)="'N'  =  node number (if used, it must appear first)"      SUTERR.......48900
        EX(5)="'X'  =  X-coordinate of node"                             SUTERR.......49000
        EX(6)="'Y'  =  Y-coordinate of node"                             SUTERR.......49100
        EX(7)="'Z'  =  Z-coordinate of node (3D only)"                   SUTERR.......49200
        EX(8)="'P'  =  pressure"                                         SUTERR.......49300
        EX(9)="'U'  =  concentration or temperature"                     SUTERR.......49400
        EX(10)="'S'  =  saturation"                                      SUTERR.......49500
        EX(11)=" "                                                       SUTERR.......49600
        EX(12)="The symbol '-' (a single dash) is used to end the list." SUTERR.......49700
        EX(13)="Any symbols following '-' are ignored."                  SUTERR.......49800
        EX(14)=" "                                                       SUTERR.......49900
        EX(15)="Example of a valid dataset 8B for a 3D problem:"         SUTERR.......50000
        EX(16)="10  'N'  'X'  'Y'  'Z'  'S'  'U'  '-'"                   SUTERR.......50100
      ELSE IF (ERRCOD.EQ.'INP-8C-1') THEN                                SUTERR.......50200
        DS(1)="Element number listed in column other than column 1."     SUTERR.......50300
        EX(1)="In dataset 8C of the main input file, if the element"     SUTERR.......50400
        EX(2)="number is to appear, it must appear only in column 1,"    SUTERR.......50500
        EX(3)="i.e., only LCOL(1) can be set to 'E'."                    SUTERR.......50600
      ELSE IF (ERRCOD.EQ.'INP-8C-2') THEN                                SUTERR.......50700
        DS(1)="Specified that 'Z' be output for a 2D problem."           SUTERR.......50800
        EX(1)="In dataset 8C of the main input file, 'Z' can be listed"  SUTERR.......50900
        EX(2)="only if the problem is 3D."                               SUTERR.......51000
      ELSE IF (ERRCOD.EQ.'INP-8C-3') THEN                                SUTERR.......51100
        DS(1)="Unrecognized value for LCOL."                             SUTERR.......51200
        EX(1)="In dataset 8C of the main input file, the following"      SUTERR.......51300
        EX(2)="variables may be listed:"                                 SUTERR.......51400
        EX(3)=" "                                                        SUTERR.......51500
        EX(4)="'E'  =  element number (if used, it must appear first)"   SUTERR.......51600
        EX(5)="'X'  =  X-coordinate of element centroid"                 SUTERR.......51700
        EX(6)="'Y'  =  Y-coordinate of element centroid"                 SUTERR.......51800
        EX(7)="'Z'  =  Z-coordinate of element centroid (3D only)"       SUTERR.......51900
        EX(8)="'VX'  =  X-component of fluid velocity"                   SUTERR.......52000
        EX(9)="'VY'  =  Y-component of fluid velocity"                   SUTERR.......52100
        EX(10)="'VZ'  =  Z-component of fluid velocity (3D only)"        SUTERR.......52200
        EX(11)=" "                                                       SUTERR.......52300
        EX(12)="The symbol '-' (a single dash) is used to end the list." SUTERR.......52400
        EX(13)="Any symbols following '-' are ignored."                  SUTERR.......52500
        EX(14)=" "                                                       SUTERR.......52600
        EX(15)="Example of a valid dataset 8B for a 3D problem:"         SUTERR.......52700
        EX(16)="10  'E'  'X'  'Y'  'Z'  'VX'  'VY'  'VZ'  '-'"           SUTERR.......52800
      ELSE IF (ERRCOD.EQ.'INP-8C-4') THEN                                SUTERR.......52900
        DS(1)="Specified that 'VZ' be output for a 2D problem."          SUTERR.......53000
        EX(1)="In dataset 8C of the main input file, 'VZ' can be listed" SUTERR.......53100
        EX(2)="only if the problem is 3D."                               SUTERR.......53200
      ELSE IF (ERRCOD.EQ.'INP-8D-1') THEN                                SUTERR.......53300
        DS(1)="The actual number of observation points listed does not"  SUTERR.......53400
        DS(2)="equal the input value, or the observation point list"     SUTERR.......53500
        DS(3)="does not end with a zero."                                SUTERR.......53600
        EX(1)="In dataset 8D of the main input file, the number of"      SUTERR.......53700
        EX(2)="points listed must equal the number, NOBS, specified in"  SUTERR.......53800
        EX(3)="dataset 3 of the same file, and a zero must appear after" SUTERR.......53900
        EX(4)="the last point in the list when the old format is used."  SUTERR.......54000
        EX(5)="Any information appearing after the zero is ignored."     SUTERR.......54100
        EX(6)=" "                                                        SUTERR.......54200
        EX(7)="Example of a valid old-format dataset 8D with three"      SUTERR.......54300
        EX(8)="observation points (nodes 45, 46, and 7347),"             SUTERR.......54400
        EX(9)="assuming NN>=7347:"                                       SUTERR.......54500
        EX(10)="10   45   46   7347   0"                                 SUTERR.......54600
      ELSE IF (ERRCOD.EQ.'INP-8D-2') THEN                                SUTERR.......54700
        DS(1)="The observation node list contains an invalid node"       SUTERR.......54800
        DS(2)="number."                                                  SUTERR.......54900
        EX(1)="In dataset 8D of the main input file, all node numbers"   SUTERR.......55000
        EX(2)="must be greater than or equal to 1, and less than or"     SUTERR.......55100
        EX(3)="equal to NN, the total number of nodes.  The last entry"  SUTERR.......55200
        EX(4)="must be a zero, which signals the end of the list."       SUTERR.......55300
        EX(5)=" "                                                        SUTERR.......55400
        EX(6)="Example of a valid old-format dataset 8D with three"      SUTERR.......55500
        EX(7)="observation nodes (45, 46, and 7347),"                    SUTERR.......55600
        EX(8)="assuming NN>=7347:"                                       SUTERR.......55700
        EX(9)="10   45   46   7347   0"                                  SUTERR.......55800
      ELSE IF (ERRCOD.EQ.'INP-8D-3') THEN                                SUTERR.......55900
        DS(1)="Element not found for the following observation point:"   SUTERR.......56000
        DS(2)="   " // CHERR(1)                                          SUTERR.......56100
        DS(3)="   " // CHERR(2)                                          SUTERR.......56200
        EX(1)="SUTRA was unable to find an element that contains"        SUTERR.......56300
        EX(2)="the observation point named above.  Please check"         SUTERR.......56400
        EX(3)="to make sure the coordinates specified for that"          SUTERR.......56500
        EX(4)="observation point are within the model domain."           SUTERR.......56600
      ELSE IF (ERRCOD.EQ.'INP-8D-4') THEN                                SUTERR.......56700
        DS(1)="The actual number of observation points listed does not"  SUTERR.......56800
        DS(2)="equal the input value, or the observation point list"     SUTERR.......56900
        DS(3)="does not end with '-'."                                   SUTERR.......57000
        EX(1)="In dataset 8D of the main input file, the number of"      SUTERR.......57100
        EX(2)="points listed must equal the number, NOBS, specified in"  SUTERR.......57200
        EX(3)="dataset 3 of the same file, and the final entry in the"   SUTERR.......57300
        EX(4)="list must be '-'."                                        SUTERR.......57400
        EX(5)=" "                                                        SUTERR.......57500
        EX(6)="Example of a valid dataset 8D with two 3D observation"    SUTERR.......57600
        EX(7)="points, assuming schedules A and B have been defined:"    SUTERR.......57700
        EX(8)="100"                                                      SUTERR.......57800
        EX(9)="'POINT_1'     0.   100.   500.   'A'   'OBS'"             SUTERR.......57900
        EX(10)="'POINT_2'   100.   200.   800.   'B'   'OBC'"            SUTERR.......58000
        EX(11)="'-'"                                                     SUTERR.......58100
      ELSE IF (ERRCOD.EQ.'INP-8D-5') THEN                                SUTERR.......58200
        DS(1)="Undefined schedule " // CHERR(1)                          SUTERR.......58300
        DS(2)="specified for observation " // CHERR(2)                   SUTERR.......58400
        EX(1)="The output schedule specified for one of the"             SUTERR.......58500
        EX(2)="observation points has not been defined in dataset 6"     SUTERR.......58600
        EX(3)="of the main input file."                                  SUTERR.......58700
      ELSE IF (ERRCOD.EQ.'INP-8D-6') THEN                                SUTERR.......58800
        DS(1)="Schedule name " // CHERR(1)                               SUTERR.......58900
        DS(2)="is too long"                                              SUTERR.......59000
        EX(1)="Schedule names are limited to 10 characters."             SUTERR.......59100
      ELSE IF (ERRCOD.EQ.'INP-8E-1') THEN                                SUTERR.......59200
        DS(1)=CHERR(1)(1:6) // " is not 'Y' or 'N'."                     SUTERR.......59300
        EX(1)="In dataset 8E of the main input file, " // CHERR(1)(1:6)  SUTERR.......59400
        EX(2)="must be set to either 'Y' or 'N'."                        SUTERR.......59500
        EX(3)=" "                                                        SUTERR.......59600
        EX(4)="Example of a valid dataset 8E:"                           SUTERR.......59700
        EX(5)="1   1    1    1   'Y'"                                    SUTERR.......59800
      ELSE IF (ERRCOD.EQ.'INP-11-1') THEN                                SUTERR.......59900
        DS(1)="Unrecognized sorption model."                             SUTERR.......60000
        EX(1)="In dataset 11 of the main input file, the sorption model" SUTERR.......60100
        EX(2)="may be chosen from the following:"                        SUTERR.......60200
        EX(3)=" "                                                        SUTERR.......60300
        EX(4)="'NONE'       =  No sorption"                              SUTERR.......60400
        EX(5)="'LINEAR'     =  Linear sorption model"                    SUTERR.......60500
        EX(6)="'FREUNDLICH' =  Freundlich sorption model"                SUTERR.......60600
        EX(7)="'LANGMUIR'   =  Langmuir sorption model"                  SUTERR.......60700
      ELSE IF (ERRCOD.EQ.'INP-11-2') THEN                                SUTERR.......60800
        DS(1)="The second Freundlich sorption coefficient is less than"  SUTERR.......60900
        DS(2)="or equal to zero."                                        SUTERR.......61000
        EX(1)="In dataset 11 of the main input file, the second"         SUTERR.......61100
        EX(2)="coefficient, CHI2, must be positive if Freundlich"        SUTERR.......61200
        EX(3)="sorption is chosen."                                      SUTERR.......61300
      ELSE IF (ERRCOD.EQ.'INP-14A-1') THEN                               SUTERR.......61400
        DS(1)="Dataset 14A does not begin with the word 'NODE'."         SUTERR.......61500
        EX(1)="Dataset 14A of the main input file must begin with the"   SUTERR.......61600
        EX(2)="word 'NODE'."                                             SUTERR.......61700
        EX(3)=" "                                                        SUTERR.......61800
        EX(4)="Example of a valid dataset 14A:"                          SUTERR.......61900
        EX(5)="'NODE'  1000.  1000.  1.  0.1"                            SUTERR.......62000
      ELSE IF (ERRCOD.EQ.'INP-15A-1') THEN                               SUTERR.......62100
        DS(1)="Dataset 15A does not begin with the word 'ELEMENT'."      SUTERR.......62200
        EX(1)="Dataset 15A of the main input file must begin with the"   SUTERR.......62300
        EX(2)="word 'ELEMENT'."                                          SUTERR.......62400
        EX(3)=" "                                                        SUTERR.......62500
        EX(4)="Example of a valid dataset 15A for a " // CHERR(1)(1:2)   SUTERR.......62600
     1         // " problem:"                                            SUTERR.......62700
        IF (CHERR(1).EQ."3D") THEN                                       SUTERR.......62800
          EX(5)="'ELEMENT' 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1." SUTERR.......62900
        ELSE                                                             SUTERR.......63000
          EX(5)="'ELEMENT' 1. 1. 1. 1. 1. 1. 1."                         SUTERR.......63100
        END IF                                                           SUTERR.......63200
      ELSE IF (ERRCOD.EQ.'ICS-1-1') THEN                                 SUTERR.......63300
        DS(1)="Unable to restart simulation."                            SUTERR.......63400
        EX(1)="The time step number from which the simulation is trying" SUTERR.......63500
        EX(2)="to restart (" // CINERR(1) // ") equals or exceeds the"   SUTERR.......63600
        EX(3)="number of the final time step (" // CINERR(2) // ")."     SUTERR.......63700
      ELSE IF (ERRCOD.EQ.'ICS-2-1') THEN                                 SUTERR.......63800
        DS(1)="Unrecognized initialization type."                        SUTERR.......63900
        EX(1)="In dataset 2 of the initial conditions input file,"       SUTERR.......64000
        EX(2)="the valid types of initializations for P are UNIFORM"     SUTERR.......64100
        EX(3)="and NONUNIFORM."                                          SUTERR.......64200
      ELSE IF (ERRCOD.EQ.'ICS-2-2') THEN                                 SUTERR.......64300
        DS(1)="Did not specify NONUNIFORM initial values during a WARM"  SUTERR.......64400
        DS(2)="start."                                                   SUTERR.......64500
        EX(1)="In dataset 2 of the initial conditions input file,"       SUTERR.......64600
        EX(2)="initial values for P must be specified as NONUNIFORM"     SUTERR.......64700
        EX(3)="during a WARM start (i.e., if CREAD='WARM' in dataset 4"  SUTERR.......64800
        EX(4)="of the main input file)."                                 SUTERR.......64900
      ELSE IF (ERRCOD.EQ.'ICS-3-1') THEN                                 SUTERR.......65000
        DS(1)="Unrecognized initialization type."                        SUTERR.......65100
        EX(1)="In dataset 3 of the initial conditions input file,"       SUTERR.......65200
        EX(2)="the valid types of initializations for U are UNIFORM"     SUTERR.......65300
        EX(3)="and NONUNIFORM."                                          SUTERR.......65400
      ELSE IF (ERRCOD.EQ.'ICS-3-2') THEN                                 SUTERR.......65500
        DS(1)="Did not specify NONUNIFORM initial values during a WARM"  SUTERR.......65600
        DS(2)="start."                                                   SUTERR.......65700
        EX(1)="In dataset 3 of the initial conditions input file,"       SUTERR.......65800
        EX(2)="initial values for U must be specified as NONUNIFORM"     SUTERR.......65900
        EX(3)="during a WARM start (i.e., if CREAD='WARM' in dataset 4"  SUTERR.......66000
        EX(4)="of the main input file)."                                 SUTERR.......66100
      ELSE IF (ERRCOD.EQ.'SOL-1') THEN                                   SUTERR.......66200
        DS(1)="Error returned by the " // CHERR(2)(1:10)                 SUTERR.......66300
        DS(2)="solver while solving for " // CHERR(1)(1:1) // "."        SUTERR.......66400
        EX(1)="The iterative solver has stopped because of an error."    SUTERR.......66500
        EX(2)="Error flag values are interpreted as follows:"            SUTERR.......66600
        EX(3)="  "                                                       SUTERR.......66700
        EX(4)="IERR = 2  =>  Method stalled or failed to converge in"    SUTERR.......66800
        EX(5)="              the maximum number of iterations allowed."  SUTERR.......66900
        EX(6)="IERR = 4  =>  Convergence tolerance set too tight for"    SUTERR.......67000
        EX(7)="              machine precision."                         SUTERR.......67100
        EX(8)="IERR = 5  =>  Method broke down because preconditioning"  SUTERR.......67200
        EX(9)="              matrix is non-positive-definite."           SUTERR.......67300
        EX(10)="IERR = 6  =>  Method broke down because matrix is non-"  SUTERR.......67400
        EX(11)="              positive-definite or nearly so."           SUTERR.......67500
        EX(12)=" "                                                       SUTERR.......67600
        EX(13)="If the P-solution resulted in a solver error, an"        SUTERR.......67700
        EX(14)="attempt was still made to obtain a U-solution."          SUTERR.......67800
        EX(15)="The last P and U solutions were written to the"          SUTERR.......67900
        EX(16)="appropriate output files (except the restart file)"      SUTERR.......68000
        EX(17)="whether or not they resulted in solver errors."          SUTERR.......68100
      ELSE IF (ERRCOD.EQ.'INP-3,17-1') THEN                              SUTERR.......68200
        DS(1)="The actual number of"                                     SUTERR.......68300
        DS(2)="specified fluid source nodes,   " // CINERR(1) // ","     SUTERR.......68400
        DS(3)="does not equal the input value, " // CINERR(2) // "."     SUTERR.......68500
        EX(1)="In dataset 3 of the main input file, the variable NSOP"   SUTERR.......68600
        EX(2)="must specify the exact number of specified fluid source"  SUTERR.......68700
        EX(3)="nodes listed in dataset 17."                              SUTERR.......68800
      ELSE IF (ERRCOD.EQ.'INP-3,18-1') THEN                              SUTERR.......68900
        DS(1)="The actual number of"                                     SUTERR.......69000
        DS(2)="specified " // CHERR(1)(1:6) // " source nodes,  "        SUTERR.......69100
     1         // CINERR(1) // ","                                       SUTERR.......69200
        DS(3)="does not equal the input value, " // CINERR(2) // "."     SUTERR.......69300
        EX(1)="In dataset 3 of the main input file, the variable NSOU"   SUTERR.......69400
        EX(2)="must specify the exact number of specified "              SUTERR.......69500
     1         // CHERR(1)(1:6) // " source"                             SUTERR.......69600
        EX(3)="nodes listed in dataset 18."                              SUTERR.......69700
      ELSE IF (ERRCOD.EQ.'INP-17-1') THEN                                SUTERR.......69800
        DS(1)="Invalid node number referenced in dataset 17: "           SUTERR.......69900
     1         // CINERR(1)                                              SUTERR.......70000
        EX(1)="Dataset 17 of the main input file contains a reference"   SUTERR.......70100
        EX(2)="to a non-existent node number.  All node numbers must"    SUTERR.......70200
        EX(3)="be less than or equal to the total number of nodes,"      SUTERR.......70300
        EX(4)="NN = " // CINERR(2)                                       SUTERR.......70400
        EX(5)="(excluding the negative sign that precedes nodes with"    SUTERR.......70500
        EX(6)="time-dependent boundary conditions)."                     SUTERR.......70600
      ELSE IF (ERRCOD.EQ.'INP-18-1') THEN                                SUTERR.......70700
        DS(1)="Invalid node number referenced in dataset 18: "           SUTERR.......70800
     1         // CINERR(1)                                              SUTERR.......70900
        EX(1)="Dataset 18 of the main input file contains a reference"   SUTERR.......71000
        EX(2)="to a non-existent node number.  All node numbers must"    SUTERR.......71100
        EX(3)="be less than or equal to the total number of nodes,"      SUTERR.......71200
        EX(4)="NN = " // CINERR(2)                                       SUTERR.......71300
        EX(5)="(excluding the negative sign that precedes nodes with"    SUTERR.......71400
        EX(6)="time-dependent boundary conditions)."                     SUTERR.......71500
      ELSE IF (ERRCOD.EQ.'INP-19-1') THEN                                SUTERR.......71600
        DS(1)="Invalid node number referenced in dataset 19: "           SUTERR.......71700
     1         // CINERR(1)                                              SUTERR.......71800
        EX(1)="Dataset 19 of the main input file contains a reference"   SUTERR.......71900
        EX(2)="to a non-existent node number.  All node numbers must"    SUTERR.......72000
        EX(3)="be less than or equal to the total number of nodes,"      SUTERR.......72100
        EX(4)="NN = " // CINERR(2)                                       SUTERR.......72200
        EX(5)="(excluding the negative sign that precedes nodes with"    SUTERR.......72300
        EX(6)="time-dependent boundary conditions)."                     SUTERR.......72400
      ELSE IF (ERRCOD.EQ.'INP-20-1') THEN                                SUTERR.......72500
        DS(1)="Invalid node number referenced in dataset 20: "           SUTERR.......72600
     1         // CINERR(1)                                              SUTERR.......72700
        EX(1)="Dataset 20 of the main input file contains a reference"   SUTERR.......72800
        EX(2)="to a non-existent node number.  All node numbers must"    SUTERR.......72900
        EX(3)="be less than or equal to the total number of nodes,"      SUTERR.......73000
        EX(4)="NN = " // CINERR(2)                                       SUTERR.......73100
        EX(5)="(excluding the negative sign that precedes nodes with"    SUTERR.......73200
        EX(6)="time-dependent boundary conditions)."                     SUTERR.......73300
      ELSE IF (ERRCOD.EQ.'BCS-1-1') THEN                                 SUTERR.......73400
        DS(1)="Undefined schedule " // CHERR(1)                          SUTERR.......73500
        DS(2)="specified in BCS file " // CHERR(2)                       SUTERR.......73600
        EX(1)="The schedule specified in the BCS file mentioned"         SUTERR.......73700
        EX(2)="above has not been defined in dataset 6 of the"           SUTERR.......73800
        EX(3)="main input file."                                         SUTERR.......73900
      ELSE IF (ERRCOD.EQ.'BCS-1-2') THEN                                 SUTERR.......74000
        DS(1)="Schedule " // CHERR(1)                                    SUTERR.......74100
        DS(2)="used in BCS file " // CHERR(2)                            SUTERR.......74200
        DS(3)="includes a fractional time step number, " // CRLERR(1)    SUTERR.......74300
        EX(1)="Schedules that are used in BCS files must not include"    SUTERR.......74400
        EX(2)="fractional time step numbers.  Only whole-numbered"       SUTERR.......74500
        EX(3)="time steps (0, 1, 2, 3, etc.) are allowed."               SUTERR.......74600
      ELSE IF (ERRCOD.EQ.'BCS-1-3') THEN                                 SUTERR.......74700
        DS(1)="Undefined schedule " // CHERR(1)                          SUTERR.......74800
        DS(2)="specified in BCS file " // CHERR(2)                       SUTERR.......74900
        EX(1)="When transport is steady-state, user-defined"             SUTERR.......75000
        EX(2)="schedules are not in effect, and steady-state boundary"   SUTERR.......75100
        EX(3)="conditions in BCS files must be controlled using the"     SUTERR.......75200
        EX(4)="following schedules automatically defined by SUTRA:"      SUTERR.......75300
        EX(5)=" "                                                        SUTERR.......75400
        EX(6)="TIME_STEPS (time steps 0 and 1)"                          SUTERR.......75500
        EX(7)="STEP_0     (time step 0 only)"                            SUTERR.......75600
        EX(8)="STEP_1     (time step 1 only)"                            SUTERR.......75700
        EX(9)="STEPS_1&UP (equivalent to 'STEP_1' in this case)"         SUTERR.......75800
      ELSE IF (ERRCOD.EQ.'BCS-1-4') THEN                                 SUTERR.......75900
        DS(1)="Schedule name " // CHERR(1)                               SUTERR.......76000
        DS(2)="specified in BCS file " // CHERR(2)                       SUTERR.......76100
        DS(3)="is too long"                                              SUTERR.......76200
        EX(1)="Schedule names are limited to 10 characters."             SUTERR.......76300
      ELSE IF (ERRCOD.EQ.'BCS-2-1') THEN                                 SUTERR.......76400
        DS(1)="Transport boundary conditions"                            SUTERR.......76500
        DS(2)="are specified for time step 0"                            SUTERR.......76600
        DS(3)="in the BCS file mentioned above."                         SUTERR.......76700
        EX(1)="Boundary conditions for transport (BCS datasets 4 and 6)" SUTERR.......76800
        EX(2)="cannot be specified for time step 0.  If transport is"    SUTERR.......76900
        EX(3)="steady-state, use time step 1 (not 0) to specify"         SUTERR.......77000
        EX(4)="boundary conditions for transport in BCS files."          SUTERR.......77100
      ELSE IF (ERRCOD.EQ.'BCS-2,3-1') THEN                               SUTERR.......77200
        DS(1)="The actual number of time-"                               SUTERR.......77300
        DS(2)="varying fluid source nodes,     " // CINERR(1) // ","     SUTERR.......77400
        DS(3)="does not equal the input value, " // CINERR(2) // ","     SUTERR.......77500
        DS(4)="for BCS time step " // CINERR(3) // "."                   SUTERR.......77600
        EX(1)="In dataset 2 of the BCS file, the variable NSOP1"         SUTERR.......77700
        EX(2)="must specify the exact number of time-dependent fluid"    SUTERR.......77800
        EX(3)="source nodes listed in dataset 3."                        SUTERR.......77900
      ELSE IF (ERRCOD.EQ.'BCS-2,4-1') THEN                               SUTERR.......78000
        DS(1)="The actual number of time-"                               SUTERR.......78100
        DS(2)="varying " // CHERR(1)(1:6) // " source nodes,    "        SUTERR.......78200
     1         // CINERR(1) // ","                                       SUTERR.......78300
        DS(3)="does not equal the input value, " // CINERR(2) // ","     SUTERR.......78400
        DS(4)="for BCS time step " // CINERR(3) // "."                   SUTERR.......78500
        EX(1)="In dataset 2 of the BCS file, the variable NSOU1"         SUTERR.......78600
        EX(2)="must specify the exact number of time-dependent "         SUTERR.......78700
     1         // CHERR(1)(1:6) // " source"                             SUTERR.......78800
        EX(3)="nodes listed in dataset 4."                               SUTERR.......78900
      ELSE IF (ERRCOD.EQ.'BCS-2,5-1') THEN                               SUTERR.......79000
        DS(1)="The actual number of"                                     SUTERR.......79100
        DS(2)="TIME-DEPENDENT pressure nodes,    " // CINERR(1) // ","   SUTERR.......79200
        DS(3)="does not equal the input value, " // CINERR(2) // ","     SUTERR.......79300
        DS(4)="for BCS time step " // CINERR(3) // "."                   SUTERR.......79400
        EX(1)="In dataset 2 of the BCS file, the variable NPBC1"         SUTERR.......79500
        EX(2)="must specify the exact number of time-dependent"          SUTERR.......79600
        EX(3)="pressure nodes listed in dataset 5."                      SUTERR.......79700
      ELSE IF (ERRCOD.EQ.'BCS-2,6-1') THEN                               SUTERR.......79800
        DS(1)="The actual number of"                                     SUTERR.......79900
        DS(2)="TIME-DEPENDENT " // CHERR(1)(1:13) // " nodes,  "         SUTERR.......80000
     1         // CINERR(1) // ","                                       SUTERR.......80100
        DS(3)="does not equal the input value,   " // CINERR(2) // ","   SUTERR.......80200
        DS(4)="for BCS time step " // CINERR(3) // "."                   SUTERR.......80300
        EX(1)="In dataset 2 of the BCS file, the variable NUBC1"         SUTERR.......80400
        EX(2)="must specify the exact number of time-dependent "         SUTERR.......80500
     1         // CHERR(1)(1:13)                                         SUTERR.......80600
        EX(3)="nodes listed in dataset 6."                               SUTERR.......80700
      ELSE IF (ERRCOD.EQ.'BCS-3-1') THEN                                 SUTERR.......80800
        DS(1)="Invalid node number referenced in dataset 3: "            SUTERR.......80900
     1         // CINERR(1)                                              SUTERR.......81000
        DS(2)="on BCS time step " // CINERR(3) // "."                    SUTERR.......81100
        EX(1)="Dataset 3 of the BCS file contains a reference"           SUTERR.......81200
        EX(2)="to a non-existent node number.  All node numbers must"    SUTERR.......81300
        EX(3)="be less than or equal to the total number of nodes,"      SUTERR.......81400
        EX(4)="NN = " // CINERR(2)                                       SUTERR.......81500
        EX(5)="(excluding the negative sign that precedes node"          SUTERR.......81600
        EX(6)="numbers for inactive boundary conditions)."               SUTERR.......81700
      ELSE IF (ERRCOD.EQ.'BCS-3-2') THEN                                 SUTERR.......81800
        DS(1)="Invalid node number referenced in dataset 3: "            SUTERR.......81900
     1         // CINERR(1)                                              SUTERR.......82000
        DS(2)="on BCS time step " // CINERR(2) // "."                    SUTERR.......82100
        EX(1)="Dataset 3 of the BCS file contains a reference"           SUTERR.......82200
        EX(2)="to an unrecognized boundary-condition node number."       SUTERR.......82300
        EX(3)="Any node number used in dataset 3 of the BCS file must"   SUTERR.......82400
        EX(4)="also appear in dataset 17 of the main input file"         SUTERR.......82500
        EX(5)="(excluding the negative signs that precede node"          SUTERR.......82600
        EX(6)="numbers for inactive and BCTIME boundary conditions)."    SUTERR.......82700
      ELSE IF (ERRCOD.EQ.'BCS-4-1') THEN                                 SUTERR.......82800
        DS(1)="Invalid node number referenced in dataset 4: "            SUTERR.......82900
     1         // CINERR(1)                                              SUTERR.......83000
        DS(2)="on BCS time step " // CINERR(3) // "."                    SUTERR.......83100
        EX(1)="Dataset 4 of the BCS file contains a reference"           SUTERR.......83200
        EX(2)="to a non-existent node number.  All node numbers must"    SUTERR.......83300
        EX(3)="be less than or equal to the total number of nodes,"      SUTERR.......83400
        EX(4)="NN = " // CINERR(2)                                       SUTERR.......83500
        EX(5)="(excluding the negative sign that precedes node"          SUTERR.......83600
        EX(6)="numbers for inactive boundary conditions)."               SUTERR.......83700
      ELSE IF (ERRCOD.EQ.'BCS-4-2') THEN                                 SUTERR.......83800
        DS(1)="Invalid node number referenced in dataset 4: "            SUTERR.......83900
     1         // CINERR(1)                                              SUTERR.......84000
        DS(2)="on BCS time step " // CINERR(2) // "."                    SUTERR.......84100
        EX(1)="Dataset 4 of the BCS file contains a reference"           SUTERR.......84200
        EX(2)="to an unrecognized boundary-condition node number."       SUTERR.......84300
        EX(3)="Any node number used in dataset 4 of the BCS file must"   SUTERR.......84400
        EX(4)="also appear in dataset 18 of the main input file"         SUTERR.......84500
        EX(5)="(excluding the negative signs that precede node"          SUTERR.......84600
        EX(6)="numbers for inactive and BCTIME boundary conditions)."    SUTERR.......84700
      ELSE IF (ERRCOD.EQ.'BCS-5-1') THEN                                 SUTERR.......84800
        DS(1)="Invalid node number referenced in dataset 5: "            SUTERR.......84900
     1         // CINERR(1)                                              SUTERR.......85000
        DS(2)="on BCS time step " // CINERR(3) // "."                    SUTERR.......85100
        EX(1)="Dataset 5 of the BCS file contains a reference"           SUTERR.......85200
        EX(2)="to a non-existent node number.  All node numbers must"    SUTERR.......85300
        EX(3)="be less than or equal to the total number of nodes,"      SUTERR.......85400
        EX(4)="NN = " // CINERR(2)                                       SUTERR.......85500
        EX(5)="(excluding the negative sign that precedes node"          SUTERR.......85600
        EX(6)="numbers for inactive boundary conditions)."               SUTERR.......85700
      ELSE IF (ERRCOD.EQ.'BCS-5-2') THEN                                 SUTERR.......85800
        DS(1)="Invalid node number referenced in dataset 5: "            SUTERR.......85900
     1         // CINERR(1)                                              SUTERR.......86000
        DS(2)="on BCS time step " // CINERR(2) // "."                    SUTERR.......86100
        EX(1)="Dataset 5 of the BCS file contains a reference"           SUTERR.......86200
        EX(2)="to an unrecognized boundary-condition node number."       SUTERR.......86300
        EX(3)="Any node number used in dataset 5 of the BCS file must"   SUTERR.......86400
        EX(4)="also appear in dataset 19 of the main input file"         SUTERR.......86500
        EX(5)="(excluding the negative signs that precede node"          SUTERR.......86600
        EX(6)="numbers for inactive and BCTIME boundary conditions)."    SUTERR.......86700
      ELSE IF (ERRCOD.EQ.'BCS-6-1') THEN                                 SUTERR.......86800
        DS(1)="Invalid node number referenced in dataset 6: "            SUTERR.......86900
     1         // CINERR(1)                                              SUTERR.......87000
        DS(2)="on BCS time step " // CINERR(3) // "."                    SUTERR.......87100
        EX(1)="Dataset 6 of the BCS file contains a reference"           SUTERR.......87200
        EX(2)="to a non-existent node number.  All node numbers must"    SUTERR.......87300
        EX(3)="be less than or equal to the total number of nodes,"      SUTERR.......87400
        EX(4)="NN = " // CINERR(2)                                       SUTERR.......87500
        EX(5)="(excluding the negative sign that precedes node"          SUTERR.......87600
        EX(6)="numbers for inactive boundary conditions)."               SUTERR.......87700
      ELSE IF (ERRCOD.EQ.'BCS-6-2') THEN                                 SUTERR.......87800
        DS(1)="Invalid node number referenced in dataset 6: "            SUTERR.......87900
     1         // CINERR(1)                                              SUTERR.......88000
        DS(2)="on BCS time step " // CINERR(2) // "."                    SUTERR.......88100
        EX(1)="Dataset 6 of the BCS file contains a reference"           SUTERR.......88200
        EX(2)="to an unrecognized boundary-condition node number."       SUTERR.......88300
        EX(3)="Any node number used in dataset 6 of the BCS file must"   SUTERR.......88400
        EX(4)="also appear in dataset 20 of the main input file"         SUTERR.......88500
        EX(5)="(excluding the negative signs that precede node"          SUTERR.......88600
        EX(6)="numbers for inactive and BCTIME boundary conditions)."    SUTERR.......88700
      ELSE IF (ERRCOD.EQ.'CON-1') THEN                                   SUTERR.......88800
        CDUM80 = 's'                                                     SUTERR.......88900
        IF (INERR(4).GT.13) THEN                                         SUTERR.......89000
           LDUM = 1                                                      SUTERR.......89100
        ELSE                                                             SUTERR.......89200
           LDUM = 0                                                      SUTERR.......89300
        END IF                                                           SUTERR.......89400
        DS(1)="Simulation terminated due to unconverged non-linearity"   SUTERR.......89500
        DS(2)="iterations.  Tolerance" // CDUM80(1:LDUM)                 SUTERR.......89600
     1         // " for " // CHERR(1)(1:INERR(4))                        SUTERR.......89700
        DS(3)="not reached."                                             SUTERR.......89800
        EX(1)="The " // CHERR(1)(1:INERR(4)) // " solution"              SUTERR.......89900
     1         // CDUM80(1:LDUM) // " failed"                            SUTERR.......90000
        EX(2)="to converge to the specified tolerance"                   SUTERR.......90100
     1         // CDUM80(1:LDUM) // " within"                            SUTERR.......90200
        EX(3)="the maximum number of iterations allowed to resolve"      SUTERR.......90300
        EX(4)="non-linearities.  The parameters that control these"      SUTERR.......90400
        EX(5)="iterations are set in dataset 7A of the main input file." SUTERR.......90500
      ELSE IF ((CODE(1).EQ.'REA').AND.                                   SUTERR.......90600
     1         ((CODE(2).EQ.'INP').OR.(CODE(2).EQ.'ICS').OR.             SUTERR.......90700
     2          (CODE(2).EQ.'BCS'))) THEN                                SUTERR.......90800
        IF (CODE(2).EQ.'INP') THEN                                       SUTERR.......90900
           CDUM80 = 'main input'                                         SUTERR.......91000
           LDUM = 10                                                     SUTERR.......91100
        ELSE IF (CODE(2).EQ.'ICS') THEN                                  SUTERR.......91200
           CDUM80 = 'initial conditions'                                 SUTERR.......91300
           LDUM = 18                                                     SUTERR.......91400
        ELSE IF (CODE(2).EQ.'BCS') THEN                                  SUTERR.......91500
           CDUM80 = 'boundary conditions'                                SUTERR.......91600
           LDUM = 19                                                     SUTERR.......91700
        END IF                                                           SUTERR.......91800
        IF ((CODE(2).EQ.'ICS').AND.(CODE(3).EQ.'4')) THEN                SUTERR.......91900
          DS(1)="FORTRAN returned an error while reading the restart"    SUTERR.......92000
          DS(2)="information following dataset 3 of the initial"         SUTERR.......92100
          DS(3)="conditions."                                            SUTERR.......92200
        ELSE IF (CODE(3).EQ.'INS') THEN                                  SUTERR.......92300
          CALL PRSWDS(CHERR(1), '-', 3, CODUM, NWORDS)                   SUTERR.......92400
          DS(1)="FORTRAN returned an error while reading an '@INSERT'"   SUTERR.......92500
          DS(2)="statement in the vicinity of dataset " // CODUM(3)(1:3) SUTERR.......92600
          DS(3)="of the " // CDUM80(1:LDUM) // "."                       SUTERR.......92700
        ELSE                                                             SUTERR.......92800
          DS(1)="FORTRAN returned an error while reading"                SUTERR.......92900
          DS(2)="dataset " // CODE(3)(1:3)                               SUTERR.......93000
     1           // " of the " // CDUM80(1:LDUM) // "."                  SUTERR.......93100
        END IF                                                           SUTERR.......93200
        EX(1)="A FORTRAN error has occurred while reading input data."   SUTERR.......93300
        EX(2)="Error status flag values are interpreted as follows:"     SUTERR.......93400
        EX(3)=" "                                                        SUTERR.......93500
        EX(4)="IOSTAT < 0  =>  The end of a line was reached before"     SUTERR.......93600
        EX(5)="                all the required data were read from"     SUTERR.......93700
        EX(6)="                that line.  Check the specified dataset"  SUTERR.......93800
        EX(7)="                for missing data or lines of data that"   SUTERR.......93900
        EX(8)="                exceed 1000 characters."                  SUTERR.......94000
        EX(9)="IOSTAT > 0  =>  An error occurred while the specified"    SUTERR.......94100
        EX(10)="                dataset was being read.  Usually, this"  SUTERR.......94200
        EX(11)="                indicates that the READ statement"       SUTERR.......94300
        EX(12)="                encountered data of a type that is"      SUTERR.......94400
        EX(13)="                incompatible with the type it expected." SUTERR.......94500
        EX(14)="                Check the dataset for typographical"     SUTERR.......94600
        EX(15)="                errors and missing or extraneous data."  SUTERR.......94700
      ELSE IF ((CODE(1).EQ.'REA').AND.(CODE(2).EQ.'FIL')) THEN           SUTERR.......94800
        DS(1)='FORTRAN returned an error while reading "SUTRA.FIL".'     SUTERR.......94900
        EX(1)='A FORTRAN error has occurred while reading "SUTRA.FIL".'  SUTERR.......95000
        EX(2)="Error status flag values are interpreted as follows:"     SUTERR.......95100
        EX(3)=" "                                                        SUTERR.......95200
        EX(4)="IOSTAT < 0  =>  The end of a line was reached before"     SUTERR.......95300
        EX(5)="                all the required data were read from"     SUTERR.......95400
        EX(6)='                that line.  Check "SUTRA.FIL" for'        SUTERR.......95500
        EX(7)="                missing data."                            SUTERR.......95600
        EX(8)="IOSTAT > 0  =>  An error occurred while the input"        SUTERR.......95700
        EX(9)="                file was being read.  Usually, this"      SUTERR.......95800
        EX(10)="                indicates that the READ statement"       SUTERR.......95900
        EX(11)="                encountered data of a type that is"      SUTERR.......96000
        EX(12)="                incompatible with the type it expected." SUTERR.......96100
        EX(13)='                Check "SUTRA.FIL" for typographical'     SUTERR.......96200
        EX(14)="                errors and missing or extraneous data."  SUTERR.......96300
      END IF                                                             SUTERR.......96400
C                                                                        SUTERR.......96500
C.....WRITE ERROR MESSAGE.  FORMAT DEPENDS ON THE TYPE OF ERROR.         SUTERR.......96600
      IF ((CODE(1).EQ.'INP').OR.(CODE(1).EQ.'ICS').OR.                   SUTERR.......96700
     1    (CODE(1).EQ.'BCS')) THEN                                       SUTERR.......96800
C........ERROR TYPES 'INP', 'ICS', AND 'BCS' (INPUT DATA ERROR)          SUTERR.......96900
         IF (KSCRN.EQ.1)                                                 SUTERR.......97000
     1      WRITE (*,1888) '           INPUT DATA ERROR           '      SUTERR.......97100
         WRITE (K00,1888) '           INPUT DATA ERROR           '       SUTERR.......97200
         IF (KSCRN.EQ.1) WRITE (*,1011)                                  SUTERR.......97300
         WRITE (K00,1011)                                                SUTERR.......97400
 1011    FORMAT (/1X,'DESCRIPTION')                                      SUTERR.......97500
         IF (CODE(1).EQ.'INP') THEN                                      SUTERR.......97600
            CDUM80 = FNAME(1)                                            SUTERR.......97700
         ELSE IF (CODE(1).EQ.'ICS') THEN                                 SUTERR.......97800
            CDUM80 = FNAME(2)                                            SUTERR.......97900
         ELSE                                                            SUTERR.......98000
            CDUM80 = FNAME(9)                                            SUTERR.......98100
         END IF                                                          SUTERR.......98200
         IF (KSCRN.EQ.1) WRITE (*,1013) ERRCOD, CDUM80, CODE(2)          SUTERR.......98300
         WRITE (K00,1013) ERRCOD, CDUM80, CODE(2)                        SUTERR.......98400
 1013    FORMAT (/4X,'Error code:',2X,A40                                SUTERR.......98500
     1           /4X,'File:      ',2X,A40                                SUTERR.......98600
     1           /4X,'Dataset(s):',2X,A40/)                              SUTERR.......98700
         DO 1015 I=1,50                                                  SUTERR.......98800
            IF (DS(I).EQ.'null_line') EXIT                               SUTERR.......98900
            IF (KSCRN.EQ.1) WRITE(*,'(4X,A70)') DS(I)                    SUTERR.......99000
            WRITE(K00,'(4X,A70)') DS(I)                                  SUTERR.......99100
 1015    CONTINUE                                                        SUTERR.......99200
         IF (KSCRN.EQ.1) WRITE (*,1021)                                  SUTERR.......99300
         WRITE (K00,1021)                                                SUTERR.......99400
 1021    FORMAT (/1X,'EXPLANATION'/)                                     SUTERR.......99500
         DO 1025 I=1,50                                                  SUTERR.......99600
            IF (EX(I).EQ.'null_line') EXIT                               SUTERR.......99700
            IF (KSCRN.EQ.1) WRITE(*,'(4X,A70)') EX(I)                    SUTERR.......99800
            WRITE(K00,'(4X,A70)') EX(I)                                  SUTERR.......99900
 1025    CONTINUE                                                        SUTERR......100000
         IF (KSCRN.EQ.1) WRITE (*,1081)                                  SUTERR......100100
         WRITE (K00,1081)                                                SUTERR......100200
 1081    FORMAT (/1X,'GENERAL NOTE'/                                     SUTERR......100300
     1     /4X,'If the dataset for which SUTRA has reported an error'    SUTERR......100400
     1     /4X,'appears to be correct, check the preceding lines'        SUTERR......100500
     1     /4X,'for missing data or extraneous characters.')             SUTERR......100600
      ELSE IF (CODE(1).EQ.'FIL') THEN                                    SUTERR......100700
C........ERROR TYPE 'FIL' (FILE ERROR)                                   SUTERR......100800
         IF (KSCRN.EQ.1)                                                 SUTERR......100900
     1      WRITE (*,1888)'              FILE ERROR              '       SUTERR......101000
         WRITE (K00,1888) '              FILE ERROR              '       SUTERR......101100
         IF (KSCRN.EQ.1) WRITE (*,1211)                                  SUTERR......101200
         WRITE (K00,1211)                                                SUTERR......101300
 1211    FORMAT (/1X,'DESCRIPTION')                                      SUTERR......101400
         IF (KSCRN.EQ.1) WRITE (*,1213) ERRCOD, CHERR(1)                 SUTERR......101500
         WRITE (K00,1213) ERRCOD, CHERR(1)                               SUTERR......101600
 1213    FORMAT (/4X,'Error code:',2X,A40                                SUTERR......101700
     1           /4X,'File:      ',2X,A40/)                              SUTERR......101800
         DO 1215 I=1,50                                                  SUTERR......101900
            IF (DS(I).EQ.'null_line') EXIT                               SUTERR......102000
            IF (KSCRN.EQ.1) WRITE(*,'(4X,A70)') DS(I)                    SUTERR......102100
            WRITE(K00,'(4X,A70)') DS(I)                                  SUTERR......102200
 1215    CONTINUE                                                        SUTERR......102300
         IF (KSCRN.EQ.1) WRITE (*,1221)                                  SUTERR......102400
         WRITE (K00,1221)                                                SUTERR......102500
 1221    FORMAT (/1X,'EXPLANATION'/)                                     SUTERR......102600
         DO 1225 I=1,50                                                  SUTERR......102700
            IF (EX(I).EQ.'null_line') EXIT                               SUTERR......102800
            IF (KSCRN.EQ.1) WRITE(*,'(4X,A70)') EX(I)                    SUTERR......102900
            WRITE(K00,'(4X,A70)') EX(I)                                  SUTERR......103000
 1225    CONTINUE                                                        SUTERR......103100
      ELSE IF (CODE(1).EQ.'SOL') THEN                                    SUTERR......103200
C........ERROR TYPE 'SOL' (MATRIX SOLVER ERROR)                          SUTERR......103300
         IF (KSCRN.EQ.1)                                                 SUTERR......103400
     1      WRITE (*,1888) '         MATRIX SOLVER ERROR          '      SUTERR......103500
         WRITE (K00,1888) '         MATRIX SOLVER ERROR          '       SUTERR......103600
         IF (KSCRN.EQ.1) WRITE (*,1311)                                  SUTERR......103700
         WRITE (K00,1311)                                                SUTERR......103800
 1311    FORMAT (/1X,'DESCRIPTION')                                      SUTERR......103900
         IF (KSCRN.EQ.1) WRITE (*,1313) ERRCOD, CHERR(2),                SUTERR......104000
     1      INERR(1), INERR(2), RLERR(1), RLERR(2)                       SUTERR......104100
         WRITE (K00,1313) ERRCOD, CHERR(2), INERR(1), INERR(2),          SUTERR......104200
     1      RLERR(1), RLERR(2)                                           SUTERR......104300
 1313    FORMAT (/4X,'Error code:',2X,A40                                SUTERR......104400
     1           /4X,'Solver:    ',2X,A40                                SUTERR......104500
     1          //4X,'Error flag..........IERR = ',I3                    SUTERR......104600
     1           /4X,'# of solver iters...ITRS = ',I5                    SUTERR......104700
     1           /4X,'Error estimate.......ERR = ',1PE8.1                SUTERR......104800
     1           /4X,'Error tolerance......TOL = ',1PE8.1/)              SUTERR......104900
         DO 1315 I=1,50                                                  SUTERR......105000
            IF (DS(I).EQ.'null_line') EXIT                               SUTERR......105100
            IF (KSCRN.EQ.1) WRITE(*,'(4X,A70)') DS(I)                    SUTERR......105200
            WRITE(K00,'(4X,A70)') DS(I)                                  SUTERR......105300
 1315    CONTINUE                                                        SUTERR......105400
         IF (KSCRN.EQ.1) WRITE (*,1321)                                  SUTERR......105500
         WRITE (K00,1321)                                                SUTERR......105600
 1321    FORMAT (/1X,'EXPLANATION'/)                                     SUTERR......105700
         DO 1325 I=1,50                                                  SUTERR......105800
            IF (EX(I).EQ.'null_line') EXIT                               SUTERR......105900
            IF (KSCRN.EQ.1) WRITE(*,'(4X,A70)') EX(I)                    SUTERR......106000
            WRITE(K00,'(4X,A70)') EX(I)                                  SUTERR......106100
 1325    CONTINUE                                                        SUTERR......106200
      ELSE IF (CODE(1).EQ.'CON') THEN                                    SUTERR......106300
C........ERROR TYPE 'CON' (CONVERGENCE ERROR)                            SUTERR......106400
         IF (KSCRN.EQ.1)                                                 SUTERR......106500
     1      WRITE (*,1888) '          CONVERGENCE ERROR           '      SUTERR......106600
         WRITE (K00,1888) '         CONVERGENCE ERROR          '         SUTERR......106700
         IF (KSCRN.EQ.1) WRITE (*,1411)                                  SUTERR......106800
         WRITE (K00,1411)                                                SUTERR......106900
 1411    FORMAT (/1X,'DESCRIPTION')                                      SUTERR......107000
         IF (KSCRN.EQ.1) WRITE (*,1413) ERRCOD, CHERR(1), INERR(3),      SUTERR......107100
     1       RLERR(1), INERR(1), RLERR(2), RLERR(3), INERR(2), RLERR(4)  SUTERR......107200
         WRITE (K00,1413) ERRCOD, CHERR(1), INERR(3),                    SUTERR......107300
     1       RLERR(1), INERR(1), RLERR(2), RLERR(3), INERR(2), RLERR(4)  SUTERR......107400
 1413    FORMAT (/4X,'Error code: ',2X,A40                               SUTERR......107500
     1           /4X,'Unconverged:',2X,A40                               SUTERR......107600
     1      //4X,'# of iterations.....ITER = ',I5                        SUTERR......107700
     1       /4X,'Maximum P change.....RPM = ',1PE14.5,' (node ',I9,')'  SUTERR......107800
     1       /4X,'Tolerance for P....RPMAX = ',1PE14.5                   SUTERR......107900
     1       /4X,'Maximum U change.....RUM = ',1PE14.5,' (node ',I9,')'  SUTERR......108000
     1       /4X,'Tolerance for U....RUMAX = ',1PE14.5/)                 SUTERR......108100
         DO 1415 I=1,50                                                  SUTERR......108200
            IF (DS(I).EQ.'null_line') EXIT                               SUTERR......108300
            IF (KSCRN.EQ.1) WRITE(*,'(4X,A70)') DS(I)                    SUTERR......108400
            WRITE(K00,'(4X,A70)') DS(I)                                  SUTERR......108500
 1415    CONTINUE                                                        SUTERR......108600
         IF (KSCRN.EQ.1) WRITE (*,1421)                                  SUTERR......108700
         WRITE (K00,1421)                                                SUTERR......108800
 1421    FORMAT (/1X,'EXPLANATION'/)                                     SUTERR......108900
         DO 1425 I=1,50                                                  SUTERR......109000
            IF (EX(I).EQ.'null_line') EXIT                               SUTERR......109100
            IF (KSCRN.EQ.1) WRITE(*,'(4X,A70)') EX(I)                    SUTERR......109200
            WRITE(K00,'(4X,A70)') EX(I)                                  SUTERR......109300
 1425    CONTINUE                                                        SUTERR......109400
      ELSE IF ((CODE(1).EQ.'REA').AND.                                   SUTERR......109500
     1         ((CODE(2).EQ.'INP').OR.(CODE(2).EQ.'ICS').OR.             SUTERR......109600
     2          (CODE(2).EQ.'BCS'))) THEN                                SUTERR......109700
C........ERROR TYPE 'REA-INP', 'REA-ICS', OR 'REA-BCS'                   SUTERR......109800
C           (FORTRAN READ ERROR)                                         SUTERR......109900
         IF (KSCRN.EQ.1)                                                 SUTERR......110000
     1      WRITE (*,1888) '          FORTRAN READ ERROR          '      SUTERR......110100
         WRITE (K00,1888) '          FORTRAN READ ERROR          '       SUTERR......110200
         IF (KSCRN.EQ.1) WRITE (*,1511)                                  SUTERR......110300
         WRITE (K00,1511)                                                SUTERR......110400
 1511    FORMAT (/1X,'DESCRIPTION')                                      SUTERR......110500
         IF (CODE(2).EQ.'INP') THEN                                      SUTERR......110600
            CDUM80 = FNAME(1)                                            SUTERR......110700
         ELSE IF (CODE(2).EQ.'ICS') THEN                                 SUTERR......110800
            CDUM80 = FNAME(2)                                            SUTERR......110900
         ELSE                                                            SUTERR......111000
            CDUM80 = FNAME(9)                                            SUTERR......111100
         END IF                                                          SUTERR......111200
         IF (((CODE(2).EQ.'ICS').AND.(CODE(3).EQ.'4')).OR.               SUTERR......111300
     1       (CODE(3).EQ.'INS')) THEN                                    SUTERR......111400
           IF (KSCRN.EQ.1) WRITE (*,1512) ERRCOD, CDUM80, INERR(1)       SUTERR......111500
           WRITE (K00,1512) ERRCOD, CDUM80, INERR(1)                     SUTERR......111600
 1512      FORMAT (/4X,'Error code:',2X,A40                              SUTERR......111700
     1             /4X,'File:      ',2X,A40                              SUTERR......111800
     1            //4X,'Error status flag.....IOSTAT = ',I5/)            SUTERR......111900
         ELSE IF (CODE(2).EQ.'BCS') THEN                                 SUTERR......112000
           IF (KSCRN.EQ.1) WRITE (*,1513) ERRCOD, CDUM80,                SUTERR......112100
     1        ADJUSTL(TRIM(CHERR(1))), ADJUSTL(TRIM(CHERR(2))),          SUTERR......112200
     2        CODE(3)(1:3), INERR(1)                                     SUTERR......112300
           WRITE (K00,1513) ERRCOD, CDUM80, ADJUSTL(TRIM(CHERR(1))),     SUTERR......112400
     1        ADJUSTL(TRIM(CHERR(2))), CODE(3)(1:3), INERR(1)            SUTERR......112500
 1513      FORMAT (/4X,'Error code:',2X,A40                              SUTERR......112600
     1             /4X,'File:      ',2X,A40                              SUTERR......112700
     1             /4X,'Time step: ',2X,A                                SUTERR......112800
     1             /4X,'Identifier:',2X,A                                SUTERR......112900
     1             /4X,'Dataset:   ',2X,A3                               SUTERR......113000
     1            //4X,'Error status flag.....IOSTAT = ',I5/)            SUTERR......113100
         ELSE                                                            SUTERR......113200
           IF (KSCRN.EQ.1) WRITE (*,1514) ERRCOD, CDUM80, CODE(3)(1:3),  SUTERR......113300
     1        INERR(1)                                                   SUTERR......113400
           WRITE (K00,1514) ERRCOD, CDUM80, CODE(3)(1:3), INERR(1)       SUTERR......113500
 1514      FORMAT (/4X,'Error code:',2X,A40                              SUTERR......113600
     1             /4X,'File:      ',2X,A40                              SUTERR......113700
     1             /4X,'Dataset:   ',2X,A3                               SUTERR......113800
     1            //4X,'Error status flag.....IOSTAT = ',I5/)            SUTERR......113900
         END IF                                                          SUTERR......114000
         DO 1515 I=1,50                                                  SUTERR......114100
            IF (DS(I).EQ.'null_line') EXIT                               SUTERR......114200
            IF (KSCRN.EQ.1) WRITE(*,'(4X,A70)') DS(I)                    SUTERR......114300
            WRITE(K00,'(4X,A70)') DS(I)                                  SUTERR......114400
 1515    CONTINUE                                                        SUTERR......114500
         IF (KSCRN.EQ.1) WRITE (*,1521)                                  SUTERR......114600
         WRITE (K00,1521)                                                SUTERR......114700
 1521    FORMAT (/1X,'EXPLANATION'/)                                     SUTERR......114800
         DO 1525 I=1,50                                                  SUTERR......114900
            IF (EX(I).EQ.'null_line') EXIT                               SUTERR......115000
            IF (KSCRN.EQ.1) WRITE(*,'(4X,A70)') EX(I)                    SUTERR......115100
            WRITE(K00,'(4X,A70)') EX(I)                                  SUTERR......115200
 1525    CONTINUE                                                        SUTERR......115300
         IF (KSCRN.EQ.1) WRITE (*,1581)                                  SUTERR......115400
         WRITE (K00,1581)                                                SUTERR......115500
 1581    FORMAT (/1X,'GENERAL NOTE'/                                     SUTERR......115600
     1     /4X,'If the dataset for which SUTRA has reported an error'    SUTERR......115700
     1     /4X,'appears to be correct, check the preceding lines'        SUTERR......115800
     1     /4X,'for missing data or extraneous characters.')             SUTERR......115900
      ELSE IF ((CODE(1).EQ.'REA').AND.(CODE(2).EQ.'FIL')) THEN           SUTERR......116000
C........ERROR TYPE 'REA-FIL' (FORTRAN READ ERROR)                       SUTERR......116100
         IF (KSCRN.EQ.1)                                                 SUTERR......116200
     1      WRITE (*,1888) '          FORTRAN READ ERROR          '      SUTERR......116300
         WRITE (K00,1888) '          FORTRAN READ ERROR          '       SUTERR......116400
         IF (KSCRN.EQ.1) WRITE (*,1611)                                  SUTERR......116500
         WRITE (K00,1611)                                                SUTERR......116600
 1611    FORMAT (/1X,'DESCRIPTION')                                      SUTERR......116700
         IF (KSCRN.EQ.1) WRITE (*,1613) ERRCOD, INERR(1)                 SUTERR......116800
         WRITE (K00,1613) ERRCOD, INERR(1)                               SUTERR......116900
 1613    FORMAT (/4X,'Error code:',2X,A40                                SUTERR......117000
     1           /4X,'File:      ',2X,'SUTRA.FIL'                        SUTERR......117100
     1          //4X,'Error status flag.....IOSTAT = ',I5/)              SUTERR......117200
         DO 1615 I=1,50                                                  SUTERR......117300
            IF (DS(I).EQ.'null_line') EXIT                               SUTERR......117400
            IF (KSCRN.EQ.1) WRITE(*,'(4X,A70)') DS(I)                    SUTERR......117500
            WRITE(K00,'(4X,A70)') DS(I)                                  SUTERR......117600
 1615    CONTINUE                                                        SUTERR......117700
         IF (KSCRN.EQ.1) WRITE (*,1621)                                  SUTERR......117800
         WRITE (K00,1621)                                                SUTERR......117900
 1621    FORMAT (/1X,'EXPLANATION'/)                                     SUTERR......118000
         DO 1625 I=1,50                                                  SUTERR......118100
            IF (EX(I).EQ.'null_line') EXIT                               SUTERR......118200
            IF (KSCRN.EQ.1) WRITE(*,'(4X,A70)') EX(I)                    SUTERR......118300
            WRITE(K00,'(4X,A70)') EX(I)                                  SUTERR......118400
 1625    CONTINUE                                                        SUTERR......118500
      END IF                                                             SUTERR......118600
 1888 FORMAT (                                                           SUTERR......118700
     1   /1X,'+--------+',38('-'),'+--------+'                           SUTERR......118800
     1   /1X,'| \\  // |',38('-'),'| \\  // |'                           SUTERR......118900
     1   /1X,'|  \\//  |',38(' '),'|  \\//  |'                           SUTERR......119000
     1   /1X,'|   //   |',A38,    '|   //   |'                           SUTERR......119100
     1   /1X,'|  //\\  |',38(' '),'|  //\\  |'                           SUTERR......119200
     1   /1X,'| //  \\ |',38('-'),'| //  \\ |'                           SUTERR......119300
     1   /1X,'+--------+',38('-'),'+--------+')                          SUTERR......119400
C                                                                        SUTERR......119500
C.....WRITE RUN TERMINATION MESSAGES AND CALL TERMINATION SEQUENCE       SUTERR......119600
      IF (KSCRN.EQ.1) WRITE (*,8888)                                     SUTERR......119700
      WRITE (K00,8888)                                                   SUTERR......119800
      IF (K3.NE.-1) WRITE (K3,8889)                                      SUTERR......119900
      IF (K5.NE.-1) WRITE (K5,8889)                                      SUTERR......120000
      IF (K6.NE.-1) WRITE (K6,8889)                                      SUTERR......120100
 8888 FORMAT (/1X,'+',56('-'),'+'/1X,'| ',54X,' |'/1X,'|',3X,            SUTERR......120200
     1   8('*'),3X,'RUN TERMINATED DUE TO ERROR',3X,9('*'),              SUTERR......120300
     1   3X,'|'/1X,'| ',54X,' |'/1X,'+',56('-'),'+')                     SUTERR......120400
 8889 FORMAT (//13X,'+',56('-'),'+'/13X,'| ',54X,' |'/13X,'|',3X,        SUTERR......120500
     1   8('*'),3X,'RUN TERMINATED DUE TO ERROR',3X,9('*'),              SUTERR......120600
     1   3X,'|'/13X,'| ',54X,' |'/13X,'+',56('-'),'+')                   SUTERR......120700
      IF (KSCRN.EQ.1) WRITE (*,8890)                                     SUTERR......120800
 8890 FORMAT (/' The above error message also appears in the SMY file,'  SUTERR......120900
     1        /' which may contain additional error information.')       SUTERR......121000
      CALL TERSEQ()                                                      SUTERR......121100
C                                                                        SUTERR......121200
      RETURN                                                             SUTERR......121300
      END                                                                SUTERR......121400
C                                                                        SUTERR......121500
C     SUBROUTINE        S  U  T  R  A              SUTRA VERSION 2.2     SUTRA..........100
C                                                                        SUTRA..........200
C *** PURPOSE :                                                          SUTRA..........300
C ***  MAIN CONTROL ROUTINE FOR SUTRA SIMULATION.  ORGANIZES             SUTRA..........400
C ***  INITIALIZATION, CALCULATIONS FOR EACH TIME STEP AND ITERATION,    SUTRA..........500
C ***  AND VARIOUS OUTPUTS.                                              SUTRA..........600
C                                                                        SUTRA..........700
      SUBROUTINE SUTRA(TITLE1,TITLE2,PMAT,UMAT,PITER,UITER,PM1,DPDTITR,  SUTRA..........800
     1   UM1,UM2,PVEL,SL,SR,X,Y,Z,VOL,POR,CS1,CS2,CS3,SW,DSWDP,RHO,SOP,  SUTRA..........900
     2   QIN,UIN,QUIN,QINITR,RCIT,RCITM1,PVEC,UVEC,                      SUTRA.........1000
     3   ALMAX,ALMID,ALMIN,ATMAX,ATMID,ATMIN,VMAG,VANG1,VANG2,           SUTRA.........1100
     4   PERMXX,PERMXY,PERMXZ,PERMYX,PERMYY,PERMYZ,PERMZX,PERMZY,PERMZZ, SUTRA.........1200
     5   PANGL1,PANGL2,PANGL3,PBC,UBC,QPLITR,GXSI,GETA,GZET,FWK,B,       SUTRA.........1300
     6   GNUP1,GNUU1,IN,IQSOP,IQSOU,IPBC,IUBC,OBSPTS,NREG,LREG,IWK,      SUTRA.........1400
     7   IA,JA,IBCPBC,IBCUBC,IBCSOP,IBCSOU,IIDPBC,IIDUBC,IIDSOP,IIDSOU,  SUTRA.........1500
     8   IQSOPT,IQSOUT,IPBCT,IUBCT,BCSFL,BCSTR,SM,NDPT,NREF,WMA,SMA
     9   ,POR1,REK,HAREA,VAREA,FAREA,TPT,QLX,QLY,YY,XX,QVYN,TPT1,
     1   HANN,VANN,FANN,HSS,QXF,QYF,SPF,RPF)   
C     8   IQSOPT,IQSOUT,IPBCT,IUBCT,BCSFL,BCSTR)                          SUTRA.........1600
      USE ALLARR, ONLY : OBSDAT,CIDBCS                                   SUTRA.........1700
      USE LLDEF                                                          SUTRA.........1800
      USE EXPINT                                                         SUTRA.........1900
      USE SCHDEF                                                         SUTRA.........2000
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                SUTRA.........2100
      PARAMETER (NCOLMX=9)                                               SUTRA.........2200
      CHARACTER*8 VERNUM, VERNIN                                         SUTRA.........2300
      CHARACTER*1 TITLE1(80),TITLE2(80)                                  SUTRA.........2400
      CHARACTER*10 ADSMOD                                                SUTRA.........2500
      CHARACTER*80 ERRCOD,CHERR(10),UNAME,FNAME(0:13),CDUM80             SUTRA.........2600
      CHARACTER*40 SOLNAM(0:10)                                          SUTRA.........2700
      CHARACTER*10 SOLWRD(0:10)                                          SUTRA.........2800
      LOGICAL PRNALL,PRN0,PRNDEF,PRNK3,PRNK5,PRNK6                       SUTRA.........2900
      LOGICAL PRNBCF,PRNBCS,PRNBCP,PRNBCU                                SUTRA.........3000
      LOGICAL TSPRTD                                                     SUTRA.........3100
      LOGICAL ONCEK5,ONCEK6,ONCEK7,ONCEK8                                SUTRA.........3200
      LOGICAL ONCEK10,ONCEK11,ONCEK12,ONCEK13                            SUTRA.........3300
      LOGICAL ONCEP                                                      SUTRA.........3400
      LOGICAL ONCEBCS, SETBCS, BCSFL(0:ITMAX), BCSTR(0:ITMAX)            SUTRA.........3500
      LOGICAL NWS
      INTEGER(1) IBCPBC(NBCN),IBCUBC(NBCN),IBCSOP(NSOP),IBCSOU(NSOU)     SUTRA.........3600
      INTEGER IIDPBC(NBCN),IIDUBC(NBCN),IIDSOP(NSOP),IIDSOU(NSOU)        SUTRA.........3700
      DIMENSION INERR(10),RLERR(10)                                      SUTRA.........3800
      DIMENSION J5COL(NCOLMX), J6COL(NCOLMX)                             SUTRA.........3900
      DIMENSION PMAT(NELT,NCBI),UMAT(NELT,NCBI)                          SUTRA.........4000
      DIMENSION PITER(NN),UITER(NN),PM1(NN),DPDTITR(NN),UM1(NN),UM2(NN), SUTRA.........4100
     1   PVEL(NN),SL(NN),SR(NN),X(NN),Y(NN),Z(NN),VOL(NN),POR(NN),       SUTRA.........4200
     2   CS1(NN),CS2(NN),CS3(NN),SW(NN),DSWDP(NN),RHO(NN),SOP(NN),       SUTRA.........4300
     3   QIN(NN),QINITR(NN),UIN(NN),QUIN(NN),RCIT(NN),RCITM1(NN)         SUTRA.........4400
      DIMENSION PVEC(NNVEC),UVEC(NNVEC)                                  SUTRA.........4500
      DIMENSION ALMAX(NE),ALMIN(NE),ATMAX(NE),ATMIN(NE),VMAG(NE),        SUTRA.........4600
     1   VANG1(NE),PERMXX(NE),PERMXY(NE),PERMYX(NE),PERMYY(NE),          SUTRA.........4700
     2   PANGL1(NE)                                                      SUTRA.........4800
      DIMENSION ALMID(NEX),ATMID(NEX),                                   SUTRA.........4900
     1   VANG2(NEX),PERMXZ(NEX),PERMYZ(NEX),PERMZX(NEX),                 SUTRA.........5000
     2   PERMZY(NEX),PERMZZ(NEX),PANGL2(NEX),PANGL3(NEX)                 SUTRA.........5100
      DIMENSION SM(NNVEC),SM1(NNVEC),RHVS(NN1)
      DIMENSION QVYN(NN1-1),YY(NN),XX(NN),HMA(NN1)
      DIMENSION PBC(NBCN),UBC(NBCN),QPLITR(NBCN),GNUP1(NBCN),GNUU1(NBCN) SUTRA.........5200
      DIMENSION GXSI(NE,N48),GETA(NE,N48),GZET(NEX,N48)                  SUTRA.........5300
      DIMENSION FWK(NWF),B(NNNX)                                         SUTRA.........5400
      DIMENSION IN(NIN),IQSOP(NSOP),IQSOU(NSOU),IPBC(NBCN),IUBC(NBCN),   SUTRA.........5500
     1   NREG(NN),LREG(NE),IWK(NWI),IA(NDIMIA),JA(NDIMJA)                SUTRA.........5600
      TYPE (OBSDAT), DIMENSION (NOBSN) :: OBSPTS                         SUTRA.........5700
      DIMENSION KTYPE(2)                                                 SUTRA.........5800
      DIMENSION IET(3),ISEEP(3),IPRE(3),IRD(2)
      DIMENSION IPN(NN),IUN(NN)
      DIMENSION WMA(NN),SMA(NN),POR1(NN),REK(NE),HAREA(NSOP),VAREA(NSOP)
     1,FAREA(NSOP),QLX(NE),QLY(NE),QXF(NE),QYF(NE),SPF(NE),RPF(NE)
      DIMENSION HANN(NN),VANN(NN),FANN(NN),HSS(NN1)
      DIMENSION QSB(NN), USB(NN), QPB(NPBC), UPB(NPBC)
      DIMENSION VOL1(NN),TPT(NN),TPT1(NN)
      INTEGER NDPT(NSOP)
      INTEGER NREF(NSOP)
      DIMENSION DFR(NSOP),PWFR(NSOP),PCFR(NSOP)
      DIMENSION WMAM(NN),DWMADT(NN)
      DIMENSION ACET(NFY)
      DIMENSION QVX(MXD,NFY-1),QVY(MXD-1,NFY)
      TYPE (LLD), POINTER :: DENTS                                       SUTRA.........5900
      TYPE (LLD), ALLOCATABLE :: DENOB(:)                                SUTRA.........6000
      DIMENSION LCNT(NFLOMX)                                             SUTRA.........6100
      COMMON /BCSL/ ONCEBCS                                              SUTRA.........6200
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  SUTRA.........6300
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           SUTRA.........6400
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      SUTRA.........6500
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              SUTRA.........6600
     1   NSOP,NSOU,NBCN,NCIDB                                            SUTRA.........6700
      COMMON /DIMX/ NWI,NWF,NWL,NELT,NNNX,NEX,N48                        SUTRA.........6800
      COMMON /DIMX2/ NELTA, NNVEC, NDIMIA, NDIMJA                        SUTRA.........6900
      COMMON /FNAMES/ UNAME,FNAME                                        SUTRA.........7000
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 SUTRA.........7100
     1   K10,K11,K12,K13                                                 SUTRA.........7200
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS      SUTRA.........7300
      COMMON /ITSOLR/ TOLP,TOLU                                          SUTRA.........7400
      COMMON /JCOLS/ NCOLPR,LCOLPR,NCOLS5,NCOLS6,J5COL,J6COL             SUTRA.........7500
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                SUTRA.........7600
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            SUTRA.........7700
      COMMON /MODSOR/ ADSMOD                                             SUTRA.........7800
      COMMON /OBS/ NOBSN,NTOBS,NOBCYC,NOBLIN,NFLOMX                      SUTRA.........7900
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,      SUTRA.........8000
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2        SUTRA.........8100
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /PLT1/ ONCEK5, ONCEK6, ONCEK7, ONCEK8                       SUTRA.........8200
      COMMON /PLT2/ ONCEK10, ONCEK11, ONCEK12, ONCEK13                   SUTRA.........8300
      COMMON /SCH/ NSCH,ISCHTS,NSCHAU                                    SUTRA.........8400
      COMMON /SOLVC/ SOLWRD,SOLNAM                                       SUTRA.........8500
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                           SUTRA.........8600
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       SUTRA.........8700
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      SUTRA.........8800
      COMMON /VER/ VERNUM, VERNIN                                        SUTRA.........8900
      COMMON /ET/ QET,UET,PET,UVM,NGT,ITE,TMA,TMI,ALF,RS,RH,AP,BP,U2,
     1   TSD,SCF
      COMMON /DEPTH/ MXD,NFY
      COMMON /AERORESIS/ RAVT,RAVS,SWRAT
      COMMON /FILMFLOW/ CORF,AGR,SWM3,SWM4,PHICM,ASVL
C                                                                        SUTRA.........9000
C.....INITIALIZE FLAG TO INDICATE THAT BCSTEP HAS NOT YET BEEN CALLED    SUTRA.........9100
C        IN THIS SUBROUTINE                                              SUTRA.........9200
      ONCEBCS = .FALSE.                                                  SUTRA.........9300
C                                                                        SUTRA.........9400
C.....WRITE TITLE TO CONSOLE                                             SUTRA.........9500
      DO 100 I=80,1,-1                                                   SUTRA.........9600
         IF (TITLE1(I).NE.' ') THEN                                      SUTRA.........9700
            LENT1 = I                                                    SUTRA.........9800
            GOTO 101                                                     SUTRA.........9900
         END IF                                                          SUTRA........10000
  100 CONTINUE                                                           SUTRA........10100
      LENT1 = 1                                                          SUTRA........10200
  101 DO 105 I=80,1,-1                                                   SUTRA........10300
         IF (TITLE2(I).NE.' ') THEN                                      SUTRA........10400
            LENT2 = I                                                    SUTRA........10500
            GOTO 106                                                     SUTRA........10600
         END IF                                                          SUTRA........10700
  105 CONTINUE                                                           SUTRA........10800
      LENT2 = 1                                                          SUTRA........10900
  106 CONTINUE                                                           SUTRA........11000
      IF (KSCRN.EQ.1) WRITE (*,121) VERNUM                               SUTRA........11100
      WRITE (K00,121) VERNUM                                             SUTRA........11200
  121 FORMAT (/1X,9X,53("=")//1X,25X,"S    U    T    R    A",//          SUTRA........11300
     1   31X,"Version ",A8//1X,9X,53("=")/)                              SUTRA........11400
      IF (KSCRN.EQ.1) WRITE (*,122) (TITLE1(I),I=1,LENT1)                SUTRA........11500
      WRITE (K00,122) (TITLE1(I),I=1,LENT1)                              SUTRA........11600
      IF (KSCRN.EQ.1) WRITE (*,122) (TITLE2(I),I=1,LENT2)                SUTRA........11700
      WRITE (K00,122) (TITLE2(I),I=1,LENT2)                              SUTRA........11800
  122 FORMAT (1X,80A1)                                                   SUTRA........11900
      IF (KSCRN.EQ.1) WRITE (*,*)                                        SUTRA........12000
      WRITE (K00,*)                                                      SUTRA........12100
C                                                                        SUTRA........12200
C.....DETERMINE MAXIMUM SIMULATION TIME AND DURATION FROM TIME           SUTRA........12300
C        STEP SCHEDULE.                                                  SUTRA........12400
      IF (ISSTRA.EQ.0) THEN                                              SUTRA........12500
         DENTS => SCHDLS(ISCHTS)%SLIST                                   SUTRA........12600
         TMAX = DENTS%DVALU1                                             SUTRA........12700
         DO 310 K=1,ITMAX                                                SUTRA........12800
            DENTS => DENTS%NENT                                          SUTRA........12900
            TMAX = DENTS%DVALU1                                          SUTRA........13000
  310    CONTINUE                                                        SUTRA........13100
      ELSE                                                               SUTRA........13200
         TMAX = TSTART                                                   SUTRA........13300
      END IF                                                             SUTRA........13400
      TEMAX = TMAX - TSTART                                              SUTRA........13500
C                                                                        SUTRA........13600
C.....INITIALIZE TIME STEP NUMBER AND SCHEDULE POINTERS.  IF RESTART,    SUTRA........13700
C        SKIP AHEAD THROUGH TIME STEPS AND OBSERVATION SCHEDULES AND     SUTRA........13800
C        UPDATE TSEC.                                                    SUTRA........13900
      IT = ITRST                                                         SUTRA........14000
      ITBCS = IT                                                         SUTRA........14100
      DIT = DNINT(DBLE(IT))                                              SUTRA........14200
      IF (IT.EQ.0) THEN                                                  SUTRA........14300
         DELTLC = DELT                                                   SUTRA........14400
         DENTS => SCHDLS(ISCHTS)%SLIST                                   SUTRA........14500
      ELSE                                                               SUTRA........14600
         DENTS => SCHDLS(ISCHTS)%SLIST                                   SUTRA........14700
         DO 320 K=1,IT-1                                                 SUTRA........14800
            DENTS => DENTS%NENT                                          SUTRA........14900
  320    CONTINUE                                                        SUTRA........15000
         TMITM1 = DENTS%DVALU1                                           SUTRA........15100
         DENTS => DENTS%NENT                                             SUTRA........15200
         TMIT = DENTS%DVALU1                                             SUTRA........15300
         DELT = TMIT - TMITM1                                            SUTRA........15400
         DELTLC = DELT                                                   SUTRA........15500
         TSEC = TMIT                                                     SUTRA........15600
      END IF                                                             SUTRA........15700
      ALLOCATE(DENOB(NFLOMX))                                            SUTRA........15800
      DO 400 NFLO=1,NFLOMX                                               SUTRA........15900
         DENOB(NFLO)%NENT => SCHDLS(OFP(NFLO)%ISCHED)%SLIST              SUTRA........16000
         LCNT(NFLO) = 1                                                  SUTRA........16100
         IF ((IT.NE.0).AND.(IUNIO(NFLO).NE.-1).AND.(ISSTRA.EQ.0)) THEN   SUTRA........16200
            LENSCH = SCHDLS(OFP(NFLO)%ISCHED)%LLEN                       SUTRA........16300
            STEP = DENOB(NFLO)%NENT%DVALU2                               SUTRA........16400
            DO WHILE ((DIT.GE.STEP).AND.(LCNT(NFLO).LE.LENSCH))          SUTRA........16500
               IF (LCNT(NFLO).LT.LENSCH) THEN                            SUTRA........16600
                  DENOB(NFLO)%NENT => DENOB(NFLO)%NENT%NENT              SUTRA........16700
                  STEP = DENOB(NFLO)%NENT%DVALU2                         SUTRA........16800
               END IF                                                    SUTRA........16900
               LCNT(NFLO) = LCNT(NFLO) + 1                               SUTRA........17000
            END DO                                                       SUTRA........17100
         END IF                                                          SUTRA........17200
  400 CONTINUE                                                           SUTRA........17300
C                                                                        SUTRA........17400
C.....INITIALIZE FLAG THAT INDICATES WHETHER P HAS BEEN SOLVED FOR       SUTRA........17500
C         AT LEAST ONCE.  SET FLAG TO MAKE CALLS TO BCSTEP ACTUALLY      SUTRA........17600
C         SET THE BOUNDARY CONDITIONS (AS OPPOSED TO SIMPLY READING      SUTRA........17700
C         THEM IN SEARCH IF INPUT ERRORS).                               SUTRA........17800
      ONCEP = .FALSE.                                                    SUTRA........17900
      SETBCS = .TRUE.                                                    SUTRA........18000
C                                                                        SUTRA........18100
C.....SET FLAG FOR TIME-DEPENDENT SOURCES OR BOUNDARY CONDITIONS         SUTRA........18200
C        SET IN BCTIME. WHEN IBCT=+4, THERE ARE NO TIME-DEPENDENT        SUTRA........18300
C        SPECIFICATIONS IN BCTIME.                                       SUTRA........18400
      IBCT=IQSOPT+IQSOUT+IPBCT+IUBCT                                     SUTRA........18500
C                                                                        SUTRA........18600
C.....SET STARTING TIME OF SIMULATION CLOCK                              SUTRA........18700
C     TSEC=TSTART                                                        SUTRA........18800
      TSECP0=TSEC                                                        SUTRA........18900
      TSECU0=TSEC                                                        SUTRA........19000
      TMIN=TSEC/60.D0                                                    SUTRA........19100
      THOUR=TMIN/60.D0                                                   SUTRA........19200
      TDAY=THOUR/24.D0                                                   SUTRA........19300
      TWEEK=TDAY/7.D0                                                    SUTRA........19400
      TMONTH=TDAY/30.4375D0                                              SUTRA........19500
      TYEAR=TDAY/365.25D0                                                SUTRA........19600
C.....SET INITIAL CONSTANTS
      CALL INITCONS()
C.....WHEN HYDRAULIC CONDUCTIVITY DUE TO FILM FLOW IS CONSIDERED BY 
C          LEBEAU AND CONRAD (2010) EQUATION, SATURATION AT LARGE 
C          CAPILLARY PRESSURE HEAD HAS TO BE CALCULATED WHICH DENOTES
C          THE AMOUNT OF WATER BOUNDED AROUND THE SOLID GRAIN. SEE 
C          PAPER TULLER AND OR (2005) FOR REFERENCE
C... .BASED ON TULLER AND OR (2005) THE MATRIC HEAD THAT SURFACE
C          ROUGHNESS BECOMES NEGNIGIBLE IS AT -1000 M
C ....3 AND 4 IN UNSAT DENOTES BROOKS AND COREY WATER RETENTION CURVE
C          DSWDP AND RELK ARE JUST DUMMY VARIABLES
      IF (IUNSAT.GT.0.AND.MFT.EQ.3) THEN
        CALL UNSAT(SWM3,0.D0,0.D0,-PHICM*RHOW0*GVA,3)
        CALL UNSAT(SWM4,0.D0,0.D0,-PHICM*RHOW0*GVA,4)
      ENDIF

CM.....SET INTEGER TO COUNT THE UNCONVERGED NUMBERS.
      IUNO=0
C.....INITIALIZE THE WATER VAPOR MATRIX. THIS IS ADDED HERE BECAUSE THE INITIALIZATION
C     AT BCTIME IS NOT USED AT THE FIRST TIME STEP
      DO 112 I=1,MXD
       DO 112 J=1,NFY
         IF (I.LT.MXD) QVY(I,J)=0.D0
112         IF (J.LT.NFY) QVX(I,J)=0.D0 
C       (H)EAT GAIN/LOSS DUE TO (E)VAPORA(T)ION
C       (H)EAT GAIN/LOSS DUE TO (S)ENSIBLE HEAT EXCHANGE FROM (T)OP
C       (H)EAT (G)AIN FROM THE (T)OP
C       (H)HEAT (MA)SS
        HST=0.D0
        HET=0.D0
        HGT=0.D0
      CALL ZERO(HSS,NN1,0.D0)
      CALL ZERO(HMA,NN1,0.D0)
      CALL ZERO(DFR,NSOP,0.D0)
      CALL ZERO(PWFR,NSOP,0.D0)
      CALL ZERO(PCFR,NSOP,0.D0)
      CALL ZERO(ACET,NFY,0.D0)
C     SET THE AERODYNAMIC RESISTANCE. FOR THE TOP CELL, IT HAS A LOW RESISTANCE DUE TO THE EXCHANGE
C     FOR THE DEEPERSOIL IT IS LOW SINCE THE CORE IS COVERED BY 
      DO 12 I=1,NN1
12      RHVS(I)=RAVS
C                                                                        SUTRA........19700
C.....OUTPUT INITIAL/STARTING CONDITIONS FOR TRANSIENT TRANSPORT         SUTRA........19800
      IF(ISSTRA.NE.1) THEN                                               SUTRA........19900
C........PRINT TO LST OUTPUT FILE                                        SUTRA........20000
         IF (KTYPE(1).EQ.3) THEN                                         SUTRA........20100
            CALL OUTLST3(0,0,0,0,0,0D0,0,0,0D0,PVEC,UVEC,VMAG,VANG1,     SUTRA........20200
     1         VANG2,SW)                                                 SUTRA........20300
         ELSE                                                            SUTRA........20400
            CALL OUTLST2(0,0,0,0,0,0D0,0,0,0D0,PVEC,UVEC,VMAG,VANG1,SW)  SUTRA........20500
         END IF                                                          SUTRA........20600
C........IF TRANSIENT FLOW, PRINT TO NODEWISE AND OBSERVATION OUTPUT     SUTRA........20700
C           FILES NOW.  (OTHERWISE, WAIT UNTIL STEADY-STATE FLOW         SUTRA........20800
C           SOLUTION IS COMPUTED.)                                       SUTRA........20900
         IF (ISSFLO.EQ.0) THEN                                           SUTRA........21000
            IF (K5.NE.-1)                                                SUTRA........21100
C     1         CALL OUTNOD(PVEC,UVEC,SW,X,Y,Z,TITLE1,TITLE2,BCSFL,BCSTR) SUTRA........21200
     1      CALL OUTNOD(PVEC,UVEC,SW,X,Y,Z,TITLE1,TITLE2,BCSFL,BCSTR,SM
     1,POR1,WMA,SMA,DSWDP,TPT)
            DO 650 NFLO=1,NFLOMX                                         SUTRA........21300
               IF (IUNIO(NFLO).NE.-1) THEN                               SUTRA........21400
                  IF (OFP(NFLO)%FRMT.EQ."OBS") THEN                      SUTRA........21500
                     TIME = TSEC                                         SUTRA........21550
                     CALL OUTOBS(NFLO,OBSPTS,TIME,DIT,PM1,UM1,           SUTRA........21600
     1                  PVEC,UVEC,TITLE1,TITLE2,IN,LREG,BCSFL,BCSTR)     SUTRA........21700
                  ELSE                                                   SUTRA........21800
                     CALL OUTOBC(NFLO,OBSPTS,TIME,DIT,PM1,UM1,           SUTRA........21900
     1                  PVEC,UVEC,TITLE1,TITLE2,IN,LREG,BCSFL,BCSTR)     SUTRA........22000
                  END IF                                                 SUTRA........22100
                  STEP = DENOB(NFLO)%NENT%DVALU2                         SUTRA........22200
                  LENSCH = SCHDLS(OFP(NFLO)%ISCHED)%LLEN                 SUTRA........22300
                  IF ((STEP.EQ.0D0).AND.(LCNT(NFLO).LT.LENSCH)) THEN     SUTRA........22400
                     DENOB(NFLO)%NENT => DENOB(NFLO)%NENT%NENT           SUTRA........22500
                     LCNT(NFLO) = LCNT(NFLO) + 1                         SUTRA........22600
                  END IF                                                 SUTRA........22700
               END IF                                                    SUTRA........22800
  650       CONTINUE                                                     SUTRA........22900
         END IF                                                          SUTRA........23000
      END IF                                                             SUTRA........23100
C                                                                        SUTRA........23200
C.....SET SWITCHES AND PARAMETERS FOR SOLUTION WITH STEADY-STATE FLOW    SUTRA........23300
      IF(ISSFLO.NE.1) GOTO 1000                                          SUTRA........23400
      ML=1                                                               SUTRA........23500
      NOUMAT=0                                                           SUTRA........23600
      ISSFLO=2                                                           SUTRA........23700
      ITER=0                                                             SUTRA........23800
      DLTPM1=DELTP                                                       SUTRA........23900
      DLTUM1=DELTU                                                       SUTRA........24000
      BDELP1 = 1D0                                                       SUTRA........24100
      BDELP=0.0D0                                                        SUTRA........24200
      BDELU=0.0D0                                                        SUTRA........24300
      IF (ISSTRA.NE.0) THEN                                              SUTRA........24400
         IF (KSCRN.EQ.1) WRITE (*,902) IT, ITMAX                         SUTRA........24500
         WRITE (K00,902) IT, ITMAX                                       SUTRA........24600
      ELSE                                                               SUTRA........24700
         TELAPS = TSEC - TSTART                                          SUTRA........24800
         IF (KSCRN.EQ.1) WRITE (*,903) IT, ITMAX, TELAPS, TEMAX          SUTRA........24900
         WRITE (K00,903) IT, ITMAX, TSEC, TEMAX                          SUTRA........25000
      END IF                                                             SUTRA........25100
  902 FORMAT (1X, 'TIME STEP ', I8, ' OF ', I8)                          SUTRA........25200
  903 FORMAT (1X, 'TIME STEP ', I8, ' OF ', I8, ';',                     SUTRA........25300
     1        3X, 'ELAPSED TIME: ', 1PE11.4, ' OF ', 1PE11.4, ' [s]')    SUTRA........25400
      GOTO 1100                                                          SUTRA........25500
C                                                                        SUTRA........25600
C                                                                        SUTRA........25700
C ********************************************************************** SUTRA........25800
C.....BEGIN TIME STEP ************************************************** SUTRA........25900
C ********************************************************************** SUTRA........26000
C.....INCREMENT TIME STEP NUMBER                                         SUTRA........26100
 1000 IT=IT+1                                                            SUTRA........26200

      IF (UVM.NE.0.)THEN
      DO 1032 I=1,NN
      SM1(I)=SM(I)
1032      CONTINUE
      ENDIF
      ITREL = IT - ITRST                                                 SUTRA........26300
      ITBCS = IT                                                         SUTRA........26400
      DIT = DNINT(DBLE(IT))                                              SUTRA........26500
      DENTS => DENTS%NENT                                                SUTRA........26600
      ITER=0                                                             SUTRA........26700
      ML=0                                                               SUTRA........26800
      NOUMAT=0                                                           SUTRA........26900
C.....SET NOUMAT TO OBTAIN U SOLUTION BY SIMPLE BACK SUBSTITUTION        SUTRA........27000
C        BEGINNING ON SECOND TIME STEP AFTER A PRESSURE SOLUTION         SUTRA........27100
C        IF THE SOLUTION IS NON-ITERATIVE (ITRMAX=1)                     SUTRA........27200
      IF (ONCEP.AND.ITREL.GT.2) THEN                                     SUTRA........27300
      IF(MOD(IT-1,NPCYC).NE.0.AND.MOD(IT,NPCYC).NE.0                     SUTRA........27400
     1   .AND.(.NOT.BCSFL(IT-1)).AND.(.NOT.BCSFL(IT))                    SUTRA........27500
     2   .AND.ITRMAX.EQ.1) NOUMAT=1                                      SUTRA........27600
      END IF                                                             SUTRA........27700
C.....CHOOSE SOLUTION VARIABLE ON THIS TIME STEP:                        SUTRA........27800
C        ML=0 FOR P AND U, ML=1 FOR P ONLY, AND ML=2 FOR U ONLY.         SUTRA........27900
      IF(IT.EQ.1.AND.ISSFLO.NE.2) GOTO 1005                              SUTRA........28000
      IF(MOD(IT,NPCYC).NE.0 .AND. (.NOT.BCSFL(IT))) ML=2                 SUTRA........28100
      IF(MOD(IT,NUCYC).NE.0 .AND. (.NOT.BCSTR(IT))) ML=1                 SUTRA........28200
C.....INCREMENT SIMULATION CLOCK, TSEC, TO END OF NEW TIME STEP          SUTRA........28300
 1005 TSECM1 = TSEC                                                      SUTRA........28400
      TSEC = DENTS%DVALU1                                                SUTRA........28500
      TMIN=TSEC/60.D0                                                    SUTRA........28600
      THOUR=TMIN/60.D0                                                   SUTRA........28700
      TDAY=THOUR/24.D0                                                   SUTRA........28800
      TWEEK=TDAY/7.D0                                                    SUTRA........28900
      TMONTH=TDAY/30.4375D0                                              SUTRA........29000
      TYEAR=TDAY/365.25D0                                                SUTRA........29100
C.....UPDATE TIME STEP SIZE                                              SUTRA........29200
      DELTM1 = DELT                                                      SUTRA........29300
      DELT = TSEC - TSECM1                                               SUTRA........29400
C.....NO SIMPLE BACK SUBSTITUTION FOR U IF TIME STEP HAS CHANGED         SUTRA........29500
C        BY MORE THAN A VERY SMALL TOLERANCE                             SUTRA........29600
      RELCHG = DABS((DELT - DELTLC)/DELTLC)                              SUTRA........29700
      IF (RELCHG.GT.1D-14) THEN                                          SUTRA........29800
         DELTLC = DELT                                                   SUTRA........29900
         NOUMAT = 0                                                      SUTRA........30000
      END IF                                                             SUTRA........30100
C                                                                        SUTRA........30200
C.....WRITE TIME STEP NUMBER AND ELAPSED TIME                            SUTRA........30300
      IF (ISSTRA.NE.0) THEN                                              SUTRA........30400
         IF (KSCRN.EQ.1) WRITE (*,902) IT, ITMAX                         SUTRA........30500
         WRITE (K00,902) IT, ITMAX                                       SUTRA........30600
      ELSE                                                               SUTRA........30700
         TELAPS = TSEC - TSTART                                          SUTRA........30800
         IF (KSCRN.EQ.1) WRITE (*,903) IT, ITMAX, TELAPS, TEMAX          SUTRA........30900
         WRITE (K00,903) IT, ITMAX, TELAPS, TEMAX                        SUTRA........31000
      END IF                                                             SUTRA........31100
C                                                                        SUTRA........31200
C.....SET TIME STEP (DELTP AND/OR DELTU) AND INCREMENT CLOCK             SUTRA........31300
C        FOR WHICHEVER OF P AND/OR U ARE SOLVED FOR ON THIS TIME STEP    SUTRA........31400
      IF(ML-1) 1010,1020,1030                                            SUTRA........31500
 1010 DLTPM1=DELTP                                                       SUTRA........31600
      DLTUM1=DELTU                                                       SUTRA........31700
      DELTP=TSEC-TSECP0                                                  SUTRA........31800
      DELTU=TSEC-TSECU0                                                  SUTRA........31900
      TSECP0=TSEC                                                        SUTRA........32000
      TSECU0=TSEC                                                        SUTRA........32100
      GOTO 1040                                                          SUTRA........32200
 1020 DLTPM1=DELTP                                                       SUTRA........32300
      DELTP=TSEC-TSECP0                                                  SUTRA........32400
      TSECP0=TSEC                                                        SUTRA........32500
      GOTO 1040                                                          SUTRA........32600
 1030 DLTUM1=DELTU                                                       SUTRA........32700
      DELTU=TSEC-TSECU0                                                  SUTRA........32800
      TSECU0=TSEC                                                        SUTRA........32900
 1040 CONTINUE                                                           SUTRA........33000
C.....SET PROJECTION FACTORS USED ON FIRST ITERATION TO EXTRAPOLATE      SUTRA........33100
C        AHEAD ONE-HALF TIME STEP                                        SUTRA........33200
      BDELP=(DELTP/DLTPM1)*0.50D0                                        SUTRA........33300
      BDELU=(DELTU/DLTUM1)*0.50D0                                        SUTRA........33400
      BDELP1=BDELP+1.0D0                                                 SUTRA........33500
      BDELU1=BDELU+1.0D0                                                 SUTRA........33600
C                                                                        SUTRA........33700
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  SUTRA........33800
C.....BEGIN ITERATION - - - - - - - - - - - - - - - - - - - - - - - - -  SUTRA........33900
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  SUTRA........34000
C.....INCREMENT ITERATION NUMBER                                         SUTRA........34100
 1100 ITER=ITER+1                                                        SUTRA........34200
C.....IF ITERATIVE SOLUTION, WRITE ITERATION NUMBER                      SUTRA........34300
      IF (ITRMAX.NE.1) THEN                                              SUTRA........34400
         IF (KSCRN.EQ.1) WRITE (*,1104) ITER                             SUTRA........34500
         WRITE (K00,1104) ITER                                           SUTRA........34600
      END IF                                                             SUTRA........34700
 1104 FORMAT (1X, 3X, 'NON-LINEARITY ITERATION ', I5)                    SUTRA........34800
C                                                                        SUTRA........34900
      IF(ML-1) 2000,2200,2400                                            SUTRA........35000
C.....SHIFT AND SET VECTORS FOR TIME STEP WITH BOTH P AND U SOLUTIONS    SUTRA........35100
 2000 DO 2025 I=1,NN                                                     SUTRA........35200
C.....SET DPDT-ITERATE TO VALUE FROM PREVIOUS ITERATION FOR PRESSURE     SUTRA........35300
C      COMING FROM THIS TIME STEP                                        SUTRA........35400
C       (THIS IS OVERWRITTEN ON THE FIRST ITERATION JUST BELOW)          SUTRA........35500
C     NOTE: DPDTITR IS USED ONLY IN THE BUDGET                           SUTRA........35600
      DPDTITR(I)=(PVEC(I)-PM1(I))/DELTP                                  SUTRA........35700
      PITER(I)=PVEC(I)                                                   SUTRA........35800
      PVEL(I)=PVEC(I)                                                    SUTRA........35900
      UITER(I)=UVEC(I)                                                   SUTRA........36000
      RCITM1(I)=RCIT(I)                                                  SUTRA........36100
 2025 RCIT(I)=RHOW0+DRWDU*(UITER(I)-URHOW0)                              SUTRA........36200
      DO 2050 IP=1,NPBC                                                  SUTRA........36300
      I=IABS(IPBC(IP))                                                   SUTRA........36400
      QPLITR(IP)=GNUP1(IP)*(PBC(IP)-PITER(I))                            SUTRA........36500
 2050 CONTINUE                                                           SUTRA........36600
C.....QINITR VALUE DIFFERS FROM QIN ONLY IF BCTIME OR BCSTEP CHANGED QIN SUTRA........36700
      IF (ITER.LE.2) THEN                                                SUTRA........36800
         DO 2060 I=1,NN                                                  SUTRA........36900
 2060    QINITR(I)=QIN(I)                                                SUTRA........37000
      END IF                                                             SUTRA........37100
      IF(ITER.GT.1) GOTO 2600                                            SUTRA........37200
      DO 2075 I=1,NN                                                     SUTRA........37300
      PITER(I)=BDELP1*PVEC(I)-BDELP*PM1(I)                               SUTRA........37400
      UITER(I)=BDELU1*UVEC(I)-BDELU*UM1(I)                               SUTRA........37500
C.....RESETS DPDT-ITERATE TO VALUE FROM MOST RECENT PRESSURE TIME STEP   SUTRA........37600
C      ON THE FIRST ITERATION FOR THIS TIME STEP                         SUTRA........37700
      DPDTITR(I)=(PVEC(I)-PM1(I))/DLTPM1                                 SUTRA........37800
      PM1(I)=PVEC(I)                                                     SUTRA........37900
      UM2(I)=UM1(I)                                                      SUTRA........38000
      VOL1(I)=VOL(I)
 2075 UM1(I)=UVEC(I)                                                     SUTRA........38100
      GOTO 2600                                                          SUTRA........38200
C.....SHIFT AND SET VECTORS FOR TIME STEP WITH P SOLUTION ONLY           SUTRA........38300
 2200 DO 2225 I=1,NN                                                     SUTRA........38400
      PVEL(I)=PVEC(I)                                                    SUTRA........38500
 2225 PITER(I)=PVEC(I)                                                   SUTRA........38600
      IF(ITER.GT.1) GOTO 2600                                            SUTRA........38700
      DO 2250 I=1,NN                                                     SUTRA........38800
      PITER(I)=BDELP1*PVEC(I)-BDELP*PM1(I)                               SUTRA........38900
      UITER(I)=UVEC(I)                                                   SUTRA........39000
      RCITM1(I)=RCIT(I)                                                  SUTRA........39100
      RCIT(I)=RHOW0+DRWDU*(UITER(I)-URHOW0)                              SUTRA........39200
 2250 PM1(I)=PVEC(I)                                                     SUTRA........39300
      GOTO 2600                                                          SUTRA........39400
C.....SHIFT AND SET VECTORS FOR TIME STEP WITH U SOLUTION ONLY           SUTRA........39500
 2400 IF (ITER.EQ.1) THEN                                                SUTRA........39600
         DO 2405 I=1,NN                                                  SUTRA........39700
 2405       UITER(I)=BDELU1*UVEC(I)-BDELU*UM1(I)                         SUTRA........39800
      ELSE                                                               SUTRA........39900
         DO 2410 I=1,NN                                                  SUTRA........40000
 2410       UITER(I)=UVEC(I)                                             SUTRA........40100
      END IF                                                             SUTRA........40200
      IF(NOUMAT.EQ.1) GOTO 2480                                          SUTRA........40300
C.....SET PARAMETERS FROM MOST RECENT PRESSURE TIME STEP                 SUTRA........40400
      IF(ITER.GT.1) GOTO 2600                                            SUTRA........40500
      DO 2450 I=1,NN                                                     SUTRA........40600
      DPDTITR(I)=(PVEC(I)-PM1(I))/DELTP                                  SUTRA........40700
      QINITR(I)=QIN(I)                                                   SUTRA........40800
      PITER(I)=PVEC(I)                                                   SUTRA........40900
      PVEL(I)=PVEC(I)                                                    SUTRA........41000
 2450 RCITM1(I)=RCIT(I)                                                  SUTRA........41100
      DO 2475 IP=1,NPBC                                                  SUTRA........41200
      I=IABS(IPBC(IP))                                                   SUTRA........41300
      QPLITR(IP)=GNUP1(IP)*(PBC(IP)-PITER(I))                            SUTRA........41400
 2475 CONTINUE                                                           SUTRA........41500
 2480 DO 2500 I=1,NN                                                     SUTRA........41600
      UM2(I)=UM1(I)                                                      SUTRA........41700
 2500 UM1(I)=UVEC(I)                                                     SUTRA........41800
 2600 CONTINUE                                                           SUTRA........41900
C                                                                        SUTRA........42000
C.....INITIALIZE ARRAYS WITH VALUE OF ZERO                               SUTRA........42100
      MATDIM=NELT*NCBI                                                   SUTRA........42200
      IF(ML-1) 3000,3000,3300                                            SUTRA........42300
 3000 CALL ZERO(PMAT,MATDIM,0.0D0)                                       SUTRA........42400
      CALL ZERO(PVEC,NNVEC,0.0D0)                                        SUTRA........42500
      CALL ZERO(VOL,NN,0.0D0)                                            SUTRA........42600
      CALL ZERO(REK,NE,0.0D0)
      CALL ZERO(SPF,NE,0.0D0)
      CALL ZERO(RPF,NE,0.0D0)
      CALL ZERO(QXF,NE,0.0D0)
      CALL ZERO(QYF,NE,0.0D0)

      IF(ML-1) 3300,3400,3300                                            SUTRA........42700
 3300 IF(NOUMAT) 3350,3350,3375                                          SUTRA........42800
 3350 CALL ZERO(UMAT,MATDIM,0.0D0)                                       SUTRA........42900
 3375 CALL ZERO(UVEC,NNVEC,0.0D0)                                        SUTRA........43000
 3400 CONTINUE                                                           SUTRA........43100

C                                                                        SUTRA........43200
C.....SET TIME-DEPENDENT BOUNDARY CONDITIONS, SOURCES AND SINKS          SUTRA........43300
C        FOR THIS TIME STEP                                              SUTRA........43400
C      IF (ITER.EQ.1.AND.IBCT.NE.4)                                       SUTRA........43500
CM----- IN THIS CASE, ALL OF THE INPUT IN BCTIME IS INVOLVED IN THE ITERATION PROCESS.
C       IN SOME EXTREMELY CASES, 
C...... BCTIME IS NOT USED FOR THE FIRST TIME STEP. THIS IS BECAUSE THE VOLUME OF THE ELEMENT
C      OF THE CELL AND NODE HAS NOT BEEN EVALUATED BY ELEMN2. THE VOLUMES ARE INPORTANT FOR 
C      CALCULATING THE WATER VAPOR FLOW AS WELL AS EVAPORATION RATE. 
      IF (ITER.LT.10.AND.IBCT.NE.4.AND.IT.GT.1) 
     1   CALL BCTIME(IPBC,PBC,IUBC,UBC,QIN,UIN,QUIN,IQSOP,IQSOU, 
     1   IPBCT,IUBCT,IQSOPT,IQSOUT,X,Y,Z,IBCPBC,IBCUBC,IBCSOP,IBCSOU,
     2   PITER,UITER,GNUP1,GNUU1,IET,ISEEP,IPRE,IRD,RCIT,SW,VOL1,POR,SM,
     3   NDPT,NREF,WMA,HAREA,VAREA,DFR,PWFR,PCFR,POR1,TPT,ACET,QVYN
     4    ,QVX,QVY,TPT1,NREG)
276   IF ((ITER.EQ.1).AND.(K9.NE.-1))                                    SUTRA........43800
     1   CALL BCSTEP(SETBCS,IPBC,PBC,IUBC,UBC,QIN,UIN,QUIN,IQSOP,IQSOU,  SUTRA........43900
     2   IPBCT1,IUBCT1,IQSOPT1,IQSOUT1,GNUP1,GNUU1,                      SUTRA........44000
     3   IBCPBC,IBCUBC,IBCSOP,IBCSOU,IIDPBC,IIDUBC,IIDSOP,IIDSOU,        SUTRA........44100
     4   NCID,BCSFL,BCSTR)                                               SUTRA........44200
C                                                                        SUTRA........44300
C.....SET SORPTION PARAMETERS FOR THIS TIME STEP                         SUTRA........44400
      IF(ML.NE.1.AND.ME.EQ.-1.AND.NOUMAT.EQ.0.AND.                       SUTRA........44500
     1   ADSMOD.NE.'NONE      ') CALL ADSORB(CS1,CS2,CS3,SL,SR,UITER)    SUTRA........44600
C                                                                        SUTRA........44700
C.....DO ELEMENTWISE CALCULATIONS IN MATRIX EQUATION FOR P AND/OR U      SUTRA........44800
      IF (NOUMAT.EQ.0) THEN                                              SUTRA........44900
       IF (KTYPE(1).EQ.3) THEN                                           SUTRA........45000
C..... 3D PROBLEM                                                        SUTRA........45100
       CALL ELEMN3(ML,IN,X,Y,Z,PITER,UITER,RCIT,RCITM1,POR,              SUTRA........45200
     2   ALMAX,ALMID,ALMIN,ATMAX,ATMID,ATMIN,                            SUTRA........45300
     3   PERMXX,PERMXY,PERMXZ,PERMYX,PERMYY,PERMYZ,PERMZX,PERMZY,PERMZZ, SUTRA........45400
     4   PANGL1,PANGL2,PANGL3,VMAG,VANG1,VANG2,VOL,PMAT,PVEC,            SUTRA........45500
     5   UMAT,UVEC,GXSI,GETA,GZET,PVEL,LREG,IA,JA,POR1,REK)
C     5   UMAT,UVEC,GXSI,GETA,GZET,PVEL,LREG,IA,JA)                       SUTRA........45600
       ELSE                                                              SUTRA........45700
C..... 2D PROBLEM                                                        SUTRA........45800
       CALL ELEMN2(ML,IN,X,Y,Z,PITER,UITER,RCIT,RCITM1,POR,              SUTRA........45900
     2   ALMAX,ALMIN,ATMAX,ATMIN,PERMXX,PERMXY,PERMYX,PERMYY,PANGL1,     SUTRA........46000
     3   VMAG,VANG1,VOL,PMAT,PVEC,UMAT,UVEC,GXSI,GETA,PVEL,LREG,IA,JA
     4    ,POR1,REK,QLX,QLY,TPT,QXF,QYF,SPF,RPF)
C     3   VMAG,VANG1,VOL,PMAT,PVEC,UMAT,UVEC,GXSI,GETA,PVEL,LREG,IA,JA)   SUTRA........46100
       END IF                                                            SUTRA........46200
      END IF                                                             SUTRA........46300
C    IQSOPT=-1 WHEN SOURCE AND SINK ARE DETERMINED BY BCTIME()
      IF (IT.EQ.1.AND.ITER.EQ.1.AND.IQSOPT.EQ.-1) CALL 
     1 SINKAREA(X,Y,Z,
     1HAREA,VAREA,FAREA,IQSOP,NDPT,NREF,YY, XX,VOL,HANN,VANN,FANN)
C                                                                        SUTRA........46400
C.....DO NODEWISE CALCULATIONS IN MATRIX EQUATION FOR P AND/OR U         SUTRA........46500
      CALL NODAL(ML,VOL,PMAT,PVEC,UMAT,UVEC,PITER,UITER,PM1,UM1,UM2,     SUTRA........46600
     1   POR,QIN,UIN,QUIN,QINITR,CS1,CS2,CS3,SL,SR,SW,DSWDP,RHO,SOP,     SUTRA........46700
     2   NREG,JA)                                                        SUTRA........46800
C                                                                        SUTRA........46900
C.....SET SPECIFIED P AND U CONDITIONS IN MATRIX EQUATION FOR P AND/OR U SUTRA........47000
      CALL BC(ML,PMAT,PVEC,UMAT,UVEC,IPBC,PBC,IUBC,UBC,QPLITR,JA,        SUTRA........47100
     1   GNUP1,GNUU1)                                                    SUTRA........47200
C      CALCULATE THE FIRST WATER AND SOLUTE STORAGE BY MWATER=VOL*POR*SW*RHO AND
C     MSOLUTE=VOL*POR*SW*RHO*UM1 (UM1 IS TESTIFIED FROM HERE). THE REASON OF 
C      ALLOCATING THE TERM HERE IS DUE TO FACT OF VOL GETTING VALUE AT SUB GLOBAN
C     NOT AT THE BEGINNING OF THE TIME ITERATION.
C     ANOTHER REASON THAT THIS CAN NOT BE MERGED WITH THE FOLLOWING CALL IS THAT 
C     SATURATION ARRAY DO NOT HAVE PAST ONES

      IF (IT.EQ.ITRST+1.AND.ITER.EQ.1) THEN
      NWS=.FALSE.
      CALL WSMASS(WMA,SMA,VOL,POR
     1,SW,RHO,SOP,DSWDP,PVEC,PM1,UM1,UM2,CS1,CS2,CS3,SL,SR,DPDTITR,UVEC,
     2ITER,POR1,SM,QPLITR,QIN,QINITR,UIN,IPBC,GNUP1,PBC,UBC,ISTOP
     3,QSB,USB,QPB,UPB,NWS,WMAM,DWMADT,NDPT,IQSOP)
      NWS=.TRUE.
      NHEAT=.FALSE.
      CALL HEATBALANCE (NHEAT,HSS,HST,HET,HGT,HANN,VANN,TPT,TPT1,VOL,
     1 WMA,RHVS,ACET,DWMADT,HMA,ISTOP)
      NHEAT=.TRUE.
      ENDIF
C                                                                        SUTRA........47300
C.....MATRIX EQUATION FOR P AND/OR U COMPLETE.  SOLVE EQUATIONS:         SUTRA........47400
C        WITH DIRECT SOLVER,                                             SUTRA........47500
C           WHEN KMT=0, DECOMPOSE AND BACK-SUBSTITUTE,                   SUTRA........47600
C           WHEN KMT=2, BACK-SUBSTITUTE ONLY.                            SUTRA........47700
C        KPU=1 WHEN SOLVING FOR P,                                       SUTRA........47800
C        KPU=2 WHEN SOLVING FOR U.                                       SUTRA........47900
      IHALFB=NBHALF-1                                                    SUTRA........48000
      IERRP = 0                                                          SUTRA........48100
      IERRU = 0                                                          SUTRA........48200
      IF(ML-1) 5000,5000,5500                                            SUTRA........48300
C                                                                        SUTRA........48400
C.....SOLVE FOR P                                                        SUTRA........48500
 5000 KMT=000000                                                         SUTRA........48600
      KPU=1                                                              SUTRA........48700
      KSOLVR = KSOLVP                                                    SUTRA........48800
      CALL SOLVER(KMT,KPU,KSOLVR,PMAT,PVEC,PITER,B,NN,IHALFB,NELT,NCBI,  SUTRA........48900
     1            IWK,FWK,IA,JA,IERRP,ITRSP,ERRP)                        SUTRA........49000
      ONCEP = .TRUE.                                                     SUTRA........49100
C.....P SOLUTION NOW IN PVEC                                             SUTRA........49200
C                                                                        SUTRA........49300
C.....IF STEADY FLOW, SET PM1=PVEC SO THAT INTERPOLATION AT FRACTIONAL   SUTRA........49400
C        TIME STEPS YIELDS THE STEADY-STATE PRESSURE.                    SUTRA........49500
      IF (ISSFLO.NE.0) THEN                                              SUTRA........49600
         DO 5200 I=1,NN                                                  SUTRA........49700
            PM1(I) = PVEC(I)                                             SUTRA........49800
 5200    CONTINUE                                                        SUTRA........49900
      END IF                                                             SUTRA........50000
C                                                                        SUTRA........50100
      IF(ML-1) 5500,6000,5500                                            SUTRA........50200
C                                                                        SUTRA........50300
C.....SOLVE FOR U                                                        SUTRA........50400
 5500 KMT=000000                                                         SUTRA........50500
      KPU=2                                                              SUTRA........50600
      IF(NOUMAT) 5700,5700,5600                                          SUTRA........50700
 5600 KMT=2                                                              SUTRA........50800
 5700 KSOLVR = KSOLVU                                                    SUTRA........50900
      CALL SOLVER(KMT,KPU,KSOLVR,UMAT,UVEC,UITER,B,NN,IHALFB,NELT,NCBI,  SUTRA........51000
     1            IWK,FWK,IA,JA,IERRU,ITRSU,ERRU)                        SUTRA........51100
 6000 CONTINUE                                                           SUTRA........51200
C.....U SOLUTION NOW IN UVEC                                             SUTRA........51300
C                                                                        SUTRA........51400
      IERR = IABS(IERRP) + IABS(IERRU)                                   SUTRA........51500
C                                                                        SUTRA........51600
C.....CHECK PROGRESS AND CONVERGENCE OF NON-LINEARITY ITERATIONS         SUTRA........51700
C        AND SET STOP AND GO FLAGS:                                      SUTRA........51800
C           ISTOP = -1   NOT CONVERGED - STOP SIMULATION                 SUTRA........51900
C           ISTOP =  0   ITERATIONS LEFT OR CONVERGED - KEEP SIMULATING  SUTRA........52000
C           ISTOP =  1   LAST TIME STEP REACHED - STOP SIMULATION        SUTRA........52100
C           IGOI = 0   P AND U CONVERGED, OR NO ITERATIONS DONE          SUTRA........52200
C           IGOI = 1   ONLY P HAS NOT YET CONVERGED TO CRITERION         SUTRA........52300
C           IGOI = 2   ONLY U HAS NOT YET CONVERGED TO CRITERION         SUTRA........52400
C           IGOI = 3   BOTH P AND U HAVE NOT YET CONVERGED TO CRITERIA   SUTRA........52500
      ISTOP=0                                                            SUTRA........52600
      IGOI=0                                                             SUTRA........52700
      IPO=0
      IUO=0
C      IOPT=.FALSE.
      DO 7381 I=1,NN
      IPN(I)=0
7381      IUN(I)=0
      IF(ITRMAX-1) 7500,7500,7000                                        SUTRA........52800
 7000 RPM=0.D0                                                           SUTRA........52900
      RUM=0.D0                                                           SUTRA........53000
      IPWORS=0                                                           SUTRA........53100
      IUWORS=0                                                           SUTRA........53200
      IF(ML-1) 7050,7050,7150                                            SUTRA........53300
 7050 DO 7100 I=1,NN                                                     SUTRA........53400
      RP=DABS(PVEC(I)-PITER(I))                                          SUTRA........53500
      IF(RP-RPM) 7100,7060,7060                                          SUTRA........53600
 7060 RPM=RP                                                             SUTRA........53700
      IPWORS=I                                                           SUTRA........53800
      IPO=IPO+1
      IPN(IPO)=I
 7100 CONTINUE                                                           SUTRA........53900
      IF(RPM.GT.RPMAX) IGOI=IGOI+1                                       SUTRA........54000
 7150 IF(ML-1) 7200,7350,7200                                            SUTRA........54100
 7200 DO 7300 I=1,NN                                                     SUTRA........54200
      RU=DABS(UVEC(I)-UITER(I))                                          SUTRA........54300
      IF(RU-RUM) 7300,7260,7260                                          SUTRA........54400
 7260 RUM=RU                                                             SUTRA........54500
      IUWORS=I                                                           SUTRA........54600
      IUO=IUO+1
      IUN(IUO)=I
 7300 CONTINUE                                                           SUTRA........54700
      IF(RUM.GT.RUMAX) IGOI=IGOI+2                                       SUTRA........54800
 7350 CONTINUE                                                           SUTRA........54900
      IF (KSCRN.EQ.1) WRITE (*,7377) RPM, RUM                            SUTRA........55000
      WRITE (K00,7377) RPM, RUM                                          SUTRA........55100
 7377 FORMAT (1X, 6X, 'Maximum changes in P, U: ',1PE8.1,", ",1PE8.1)    SUTRA........55200
      IF(IGOI.GT.0.AND.ITER.EQ.ITRMAX) ISTOP=-1                          SUTRA........55300
      IF(IGOI.GT.0.AND.ISTOP.EQ.0.AND.IERR.EQ.0) GOTO 1100               SUTRA........55400
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  SUTRA........55500
C.....END ITERATION - - - - - - - - - - - - - - - - - - - - - - - - - -  SUTRA........55600
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  SUTRA........55700
C                                                                        SUTRA........55800
 7500 CONTINUE                                                           SUTRA........55900
      IF(ISTOP.NE.-1.AND.IT.EQ.ITMAX) ISTOP=1                            SUTRA........56000
C.....IRD(1) STORES THE LAST ITERATION VALUE AND OUTPUT TO ETINFO FILE
      IRD(1)=ITER
      IF (MOD(IT,NCOLPR).EQ.0.OR.IT.EQ.1) THEN
          CALL QVOPT(QVX,QVY)
      ENDIF
C.....WARNING: NBCSPR IS USED FOR COUNTING THE OUTPUT OF THE EVAPORATION
C.....THE REASON OF HAVING ALL EVAPORATION RATE OUTPUT IS BECAUSE ET RATE AT EACH TIME STEP IS 
C     CRUCIAL FOR CALCULATING THE WATER LOSS FOR ET. THIS IS DIFFERENT FROM .NOD OR .ELE, WHICH 
C     IS ONLY A SNAPSHOT OF THE CURRENT CONDITION.
        IF (MOD(IT,NBCSPR).EQ.0.OR.IT.EQ.1) THEN
          CALL ETOPT(IT,DELT,NFY,ACET)
        ENDIF
C     OUTPUT HEAT BOUNDARD CONDITIONS
        IF (MOD(IT,NBCUPR).EQ.0.OR.IT.EQ.1) THEN
          CALL  OUTHEAT (X,Y,Z,HANN,VANN,
     1   XX,YY,TPT,HSS,HST,HET,HGT)       
        ENDIF


      CALL WSMASS(WMA,SMA,VOL,POR,SW,RHO
     1,SOP,DSWDP,PVEC,PM1,UM1,UM2,CS1,CS2,CS3,SL,SR,DPDTITR,UVEC,ITER
     2,POR1,SM,QPLITR,QIN,QINITR,UIN,IPBC,GNUP1,PBC,UBC,ISTOP,QSB,USB
     3,QPB,UPB,NWS,WMAM,DWMADT,NDPT,IQSOP)

C     CALCULATING NEW TEMPERATURE AT EACH CELL.
C     THIS WILL BE USED IN BCTIME FOR VAPOR MOVEMENT CALCULATION
C.....SET FLAG FOR TIME-DEPENDENT SOURCES OR BOUNDARY CONDITIONS        
C        SET IN BCTIME. WHEN IBCT=+4, THERE ARE NO TIME-DEPENDENT      
C        SPECIFICATIONS IN BCTIME.                                
C    IT ONLY CALLS AFTER THE P U RESULT GET STABLIZED.
      IF (IBCT.NE.4.AND.IT.GE.2)THEN
        CALL HEAT (TPT,NDPT,NREF,DWMADT,WMAM,WMA,HAREA,FAREA,ACET
     2    ,IQSOP,VOL,POR,Y,YY,XX,QVYN,QLY,SW,RCIT,TPT1,RHVS)
        CALL HEATBALANCE (NHEAT,HSS,HST,HET,HGT,HANN,VANN,TPT,TPT1,VOL,
     1 WMA,RHVS,ACET,DWMADT,HMA,ISTOP)
      ENDIF
C                                                                        SUTRA........56100
C.....OUTPUT RESULTS FOR TIME STEP IN ACCORDANCE WITH PRINT CYCLES       SUTRA........56200
C                                                                        SUTRA........56300
C.....COMPUTE SOME LOGICAL CONDITIONS.  PRNALL=.TRUE. INDICATES THAT     SUTRA........56400
C        ALL RESULTS SHOULD BE PRINTED BECAUSE THIS IS THE LAST TIME     SUTRA........56500
C        STEP (EITHER BY DESIGN OR BECAUSE OF AN ERROR).  PRN0=.TRUE.    SUTRA........56600
C        INDICATES THAT INITIAL CONDITIONS ARE TO BE PRINTED FOR A       SUTRA........56700
C        STEADY-FLOW, TRANSIENT-TRANSPORT RUN.  PRNDEF=.TRUE. IF         SUTRA........56800
C        EITHER OF THE TWO PRECEDING CONDITIONS IS TRUE.                 SUTRA........56900
      PRNALL = ((ISTOP.NE.0).OR.(IERR.NE.0))                             SUTRA........57000
      PRN0 = ((ITREL.EQ.0).AND.(ISSFLO.NE.0).AND.(ISSTRA.NE.1))          SUTRA........57100
      PRNDEF = (PRNALL.OR.PRN0)                                          SUTRA........57200
C.....PRINT RESULTS TO THE LST OUTPUT FILE                               SUTRA........57300
      PRNK3 = (PRNDEF.OR.(MOD(IT,NPRINT).EQ.0)                           SUTRA........57400
     1         .OR.((ITREL.EQ.1).AND.(NPRINT.GT.0)))                     SUTRA........57500
      IF (PRNK3) THEN                                                    SUTRA........57600
      IF (KTYPE(1).EQ.3) THEN                                            SUTRA........57700
         CALL OUTLST3(ML,ISTOP,IGOI,IERRP,ITRSP,ERRP,IERRU,ITRSU,ERRU,   SUTRA........57800
     1      PVEC,UVEC,VMAG,VANG1,VANG2,SW)                               SUTRA........57900
      ELSE                                                               SUTRA........58000
         CALL OUTLST2(ML,ISTOP,IGOI,IERRP,ITRSP,ERRP,IERRU,ITRSU,ERRU,   SUTRA........58100
     1      PVEC,UVEC,VMAG,VANG1,SW)                                     SUTRA........58200
      END IF                                                             SUTRA........58300
C.....CALCULATE AND PRINT FLUID MASS AND/OR ENERGY OR SOLUTE MASS BUDGET SUTRA........58400
      IF(KBUDG.EQ.1)                                                     SUTRA........58500
     1   CALL BUDGET(ML,IBCT,VOL,SW,DSWDP,RHO,SOP,QIN,PVEC,PM1,DPDTITR,  SUTRA........58600
     2      PBC,QPLITR,IPBC,IQSOP,POR,UVEC,UM1,UM2,UIN,QUIN,QINITR,      SUTRA........58700
     3      IQSOU,UBC,IUBC,CS1,CS2,CS3,SL,SR,NREG,GNUP1,GNUU1,           SUTRA........58800
     4      IBCSOP,IBCSOU,SM,SM1)
C     4      IBCSOP,IBCSOU)                                               SUTRA........58900
      END IF                                                             SUTRA........59000
C.....PRINT NODEWISE AND ELEMENTWISE RESULTS TO OUTPUT FILES             SUTRA........59100
      PRNK5 = ((PRNDEF.OR.((IT.NE.0).AND.(MOD(IT,NCOLPR).EQ.0))          SUTRA........59200
     1         .OR.((ITREL.EQ.1).AND.(NCOLPR.GT.0))).AND.(K5.NE.-1))     SUTRA........59300
      IF (PRNK5) CALL OUTNOD(PVEC,UVEC,SW,X,Y,Z,TITLE1,TITLE2,           SUTRA........59400
     1   BCSFL,BCSTR,SM,POR1,WMA,SMA,DSWDP,TPT)
C     1   BCSFL,BCSTR)                                                    SUTRA........59500
      PRNK6 = ((PRNALL.OR.((IT.NE.0).AND.(MOD(IT,LCOLPR).EQ.0))          SUTRA........59600
     1         .OR.(ITREL.EQ.1)).AND.(K6.NE.-1))                         SUTRA........59700
      IF (PRNK6) CALL OUTELE(VMAG,VANG1,VANG2,IN,X,Y,Z,TITLE1,TITLE2,    SUTRA........59800
     1   BCSFL,BCSTR,QLX,QLY,REK,QXF,QYF,SPF,RPF)
C     1   BCSFL,BCSTR)                                                    SUTRA........59900
C.....PRINT RESULTS TO BOUNDARY CONDITION OUTPUT FILES.                  SUTRA........60000
      PRNBCF = ((PRNALL.OR.((IT.NE.0).AND.(MOD(IT,NBCFPR).EQ.0))         SUTRA........60100
     1          .OR.((ITREL.EQ.1).AND.(NBCFPR.GT.0))).AND.(K10.NE.-1))   SUTRA........60200
      PRNBCS = ((PRNALL.OR.((IT.NE.0).AND.(MOD(IT,NBCSPR).EQ.0))         SUTRA........60300
     1          .OR.((ITREL.EQ.1).AND.(NBCSPR.GT.0))).AND.(K11.NE.-1))   SUTRA........60400
      PRNBCP = ((PRNALL.OR.((IT.NE.0).AND.(MOD(IT,NBCPPR).EQ.0))         SUTRA........60500
     1          .OR.((ITREL.EQ.1).AND.(NBCPPR.GT.0))).AND.(K12.NE.-1))   SUTRA........60600
      PRNBCU = ((PRNALL.OR.((IT.NE.0).AND.(MOD(IT,NBCUPR).EQ.0))         SUTRA........60700
     1          .OR.((ITREL.EQ.1).AND.(NBCUPR.GT.0))).AND.(K13.NE.-1))   SUTRA........60800
      IF (PRNBCF)                                                        SUTRA........60900
     1   CALL OUTBCOF(QIN,IQSOP,UVEC,UIN,QINITR,IBCSOP,TITLE1,TITLE2,    SUTRA........61000
     2      IIDSOP,X,Y,Z,DFR,PWFR,PCFR)           
C     2      IIDSOP)                                                      SUTRA........61100
      IF (PRNBCS)                                                        SUTRA........61200
     1   CALL OUTBCOS(QUIN,IQSOU,IBCSOU,TITLE1,TITLE2,IIDSOU)            SUTRA........61300
      IF (PRNBCP)                                                        SUTRA........61400
     1   CALL OUTBCOP(PVEC,UVEC,PBC,UBC,QPLITR,GNUP1,IPBC,IBCPBC,        SUTRA........61500
     2      TITLE1,TITLE2,IIDPBC,X,Y,Z)
C     2      TITLE1,TITLE2,IIDPBC)                                        SUTRA........61600
      IF (PRNBCU)                                                        SUTRA........61700
     1   CALL OUTBCOU(UVEC,UBC,GNUU1,IUBC,IBCUBC,TITLE1,TITLE2,          SUTRA........61800
     2      IIDUBC)                                                      SUTRA........61900
C.....PRINT RESULTS TO OBSERVATION OUTPUT FILES.  CHECK FOR OUTPUT       SUTRA........62000
C       SCHEDULED WITHIN THE CURRENT TIME STEP AND PRINT IT.  IF THIS    SUTRA........62100
C       IS THE INITIAL CONDITION (IT=0) OR THE FINAL TIME STEP, PRINT    SUTRA........62200
C       RESULTS IF THEY HAVE NOT ALREADY BEEN PRINTED.                   SUTRA........62300
C.....LOOP OVER OBSERVATION OUTPUT SCHEDULES.                            SUTRA........62400
      DO 7650 NFLO=1,NFLOMX                                              SUTRA........62500
C........IF NO FILE FOR THIS OUTPUT, SKIP IT                             SUTRA........62600
         IF (IUNIO(NFLO).EQ.-1) CYCLE                                    SUTRA........62700
C........SET FLAG INDICATING THAT OUTPUT HAS NOT (YET) BEEN PRINTED      SUTRA........62800
C           FOR THE END OF THE CURRENT TIME STEP                         SUTRA........62900
         TSPRTD = .FALSE.                                                SUTRA........63000
C........IF TRANSPORT IS TRANSIENT AND THIS IS NOT THE INITIAL           SUTRA........63100
C            CONDITION, CHECK FOR SCHEDULED OUTPUT AND PRINT IT.         SUTRA........63200
         IF ((ISSTRA.EQ.0).AND.(ITREL.NE.0)) THEN                        SUTRA........63300
C...........GET THE LENGTH OF THE SCHEDULE AND THE NEXT TIME/STEP        SUTRA........63400
C              SCHEDULED TO BE OUTPUT.                                   SUTRA........63500
            LENSCH = SCHDLS(OFP(NFLO)%ISCHED)%LLEN                       SUTRA........63600
            TIME = DENOB(NFLO)%NENT%DVALU1                               SUTRA........63700
            STEP = DENOB(NFLO)%NENT%DVALU2                               SUTRA........63800
C...........LOOP THROUGH THE SCHEDULE, PRINTING ANY OUTPUT SCHEDULED     SUTRA........63900
C              WITHIN THE CURRENT TIME STEP.  (LOOP AS LONG AS THE       SUTRA........64000
C              SCHEDULED OUTPUT IS WITHIN THE CURRENT TIME STEP          SUTRA........64100
C              AND THE SCHEDULE HAS NOT BEEN EXHAUSTED.)                 SUTRA........64200
            DO WHILE ((DIT.GE.STEP).AND.(LCNT(NFLO).LE.LENSCH))          SUTRA........64300
C..............IF THE SCHEDULED STEP IS NOT ZERO, PRINT RESULTS.         SUTRA........64400
               IF (STEP.NE.0D0) THEN                                     SUTRA........64500
                  IF (OFP(NFLO)%FRMT.EQ."OBS") THEN                      SUTRA........64600
                     CALL OUTOBS(NFLO,OBSPTS,TIME,STEP,PM1,UM1,          SUTRA........64700
     1                  PVEC,UVEC,TITLE1,TITLE2,IN,LREG,BCSFL,BCSTR)     SUTRA........64800
                  ELSE                                                   SUTRA........64900
                     CALL OUTOBC(NFLO,OBSPTS,TIME,STEP,PM1,UM1,          SUTRA........65000
     1                  PVEC,UVEC,TITLE1,TITLE2,IN,LREG,BCSFL,BCSTR)     SUTRA........65100
                  END IF                                                 SUTRA........65200
C.................IF END OF TIME STEP HAS JUST BEEN PRINTED, SET FLAG.   SUTRA........65300
                  IF (DIT.EQ.STEP) TSPRTD = .TRUE.                       SUTRA........65400
               END IF                                                    SUTRA........65500
C..............GO TO THE NEXT ENTRY IN THE SCHEDULE, IF THERE IS ONE.    SUTRA........65600
               IF (LCNT(NFLO).LT.LENSCH) THEN                            SUTRA........65700
                  DENOB(NFLO)%NENT => DENOB(NFLO)%NENT%NENT              SUTRA........65800
                  TIME = DENOB(NFLO)%NENT%DVALU1                         SUTRA........65900
                  STEP = DENOB(NFLO)%NENT%DVALU2                         SUTRA........66000
               END IF                                                    SUTRA........66100
C..............INCREMENT THE COUNTER.                                    SUTRA........66200
               LCNT(NFLO) = LCNT(NFLO) + 1                               SUTRA........66300
            END DO                                                       SUTRA........66400
         END IF                                                          SUTRA........66500
C........IF THIS IS THE INITIAL OR FINAL CONDITION, PRINT IT IF IT       SUTRA........66600
C           HAS NOT ALREADY BEEN PRINTED.                                SUTRA........66700
         IF (PRNDEF.AND.(.NOT.TSPRTD)) THEN                              SUTRA........66800
            IF (OFP(NFLO)%FRMT.EQ."OBS") THEN                            SUTRA........66900
               TIME = TSEC                                               SUTRA........66950
               CALL OUTOBS(NFLO,OBSPTS,TIME,DIT,PM1,UM1,PVEC,UVEC,       SUTRA........67000
     1            TITLE1,TITLE2,IN,LREG,BCSFL,BCSTR)                     SUTRA........67100
            ELSE                                                         SUTRA........67200
               CALL OUTOBC(NFLO,OBSPTS,TIME,DIT,PM1,UM1,PVEC,UVEC,       SUTRA........67300
     1            TITLE1,TITLE2,IN,LREG,BCSFL,BCSTR)                     SUTRA........67400
            END IF                                                       SUTRA........67500
         END IF                                                          SUTRA........67600
 7650 CONTINUE                                                           SUTRA........67700
C                                                                        SUTRA........67800
C.....STORE RESULTS FOR POSSIBLE RESTART OF SIMULATION EACH              SUTRA........67900
C        ISTORE TIME STEPS AND AFTER LAST TIME STEP, THEN GO             SUTRA........68000
C        TO NEXT TIME STEP                                               SUTRA........68100
      IF (IERR.EQ.0) THEN                                                SUTRA........68200
         IF ((K4.NE.-1).AND.(ISTORE.NE.0).AND.((ISTOP.NE.0).OR.          SUTRA........68300
     1      (MOD(IT,ISTORE).EQ.0)))                                      SUTRA........68400
     2      CALL OUTRST(PVEC,UVEC,PM1,UM1,CS1,RCIT,SW,QIN,PBC,           SUTRA........68500
     3         UIN,UBC,QUIN,IBCPBC,IBCUBC,IBCSOP,IBCSOU,                 SUTRA........68600
     4         IIDPBC,IIDUBC,IIDSOP,IIDSOU)                              SUTRA........68700
         IF (ISTOP.EQ.0) GOTO 1000                                       SUTRA........68800
      END IF                                                             SUTRA........68900
C                                                                        SUTRA........69000
C ********************************************************************** SUTRA........69100
C.....END TIME STEP **************************************************** SUTRA........69200
C ********************************************************************** SUTRA........69300
C                                                                        SUTRA........69400
C                                                                        SUTRA........69500
C.....DEALLOCATE ARRAY DENOB                                             SUTRA........69600
      DEALLOCATE (DENOB)                                                 SUTRA........69700
C                                                                        SUTRA........69800
C.....COMPLETE OUTPUT AND TERMINATE SIMULATION                           SUTRA........69900
      IF (IERRP.NE.0) THEN                                               SUTRA........70000
         ERRCOD = 'SOL-1'                                                SUTRA........70100
         CHERR(1) = 'P'                                                  SUTRA........70200
         CHERR(2) = SOLWRD(KSOLVP)                                       SUTRA........70300
         INERR(1) = IERRP                                                SUTRA........70400
         INERR(2) = ITRSP                                                SUTRA........70500
         RLERR(1) = ERRP                                                 SUTRA........70600
         RLERR(2) = TOLP                                                 SUTRA........70700
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SUTRA........70800
      ELSE IF (IERRU.NE.0) THEN                                          SUTRA........70900
         ERRCOD = 'SOL-1'                                                SUTRA........71000
         CHERR(1) = 'U'                                                  SUTRA........71100
         CHERR(2) = SOLWRD(KSOLVU)                                       SUTRA........71200
         INERR(1) = IERRU                                                SUTRA........71300
         INERR(2) = ITRSU                                                SUTRA........71400
         RLERR(1) = ERRU                                                 SUTRA........71500
         RLERR(2) = TOLU                                                 SUTRA........71600
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SUTRA........71700
      END IF                                                             SUTRA........71800
C                                                                        SUTRA........71900
      IF(ISTORE.GT.0) WRITE(K3,8100)                                     SUTRA........72000
 8100 FORMAT(//////11X,'*** LAST SOLUTION HAS BEEN STORED ',             SUTRA........72100
     1   'IN THE RESTART DATA FILE ***')                                 SUTRA........72200
C                                                                        SUTRA........72300
C.....OUTPUT END OF SIMULATION MESSAGE AND RETURN TO MAIN FOR STOP       SUTRA........72400
      IF(ISTOP.EQ.-1) THEN                                               SUTRA........72500
         ERRCOD = 'CON-1'                                                SUTRA........72600
         IF (ME.EQ.1) THEN                                               SUTRA........72700
            CDUM80 = 'temperature'                                       SUTRA........72800
            LENC = 11                                                    SUTRA........72900
         ELSE                                                            SUTRA........73000
            CDUM80 = 'concentration'                                     SUTRA........73100
            LENC = 13                                                    SUTRA........73200
         END IF                                                          SUTRA........73300
         IF (IGOI.EQ.1) THEN                                             SUTRA........73400
            CHERR(1) = 'pressure'                                        SUTRA........73500
            LENC = 8                                                     SUTRA........73600
         ELSE IF (IGOI.EQ.2) THEN                                        SUTRA........73700
            CHERR(1) = CDUM80                                            SUTRA........73800
         ELSE IF (IGOI.EQ.3) THEN                                        SUTRA........73900
            CHERR(1) = 'pressure and ' // CDUM80(1:LENC)                 SUTRA........74000
            LENC = 13 + LENC                                             SUTRA........74100
         END IF                                                          SUTRA........74200
         INERR(1) = IPWORS                                               SUTRA........74300
         INERR(2) = IUWORS                                               SUTRA........74400
         INERR(3) = ITER                                                 SUTRA........74500
         INERR(4) = LENC                                                 SUTRA........74600
         RLERR(1) = RPM                                                  SUTRA........74700
         RLERR(2) = RPMAX                                                SUTRA........74800
         RLERR(3) = RUM                                                  SUTRA........74900
         RLERR(4) = RUMAX                                                SUTRA........75000
         CALL SUTERR(ERRCOD, CHERR, INERR, RLERR)                        SUTRA........75100
      ELSE IF (ISTOP.EQ.2) THEN                                          SUTRA........75200
         WRITE(K3,8450)                                                  SUTRA........75300
 8450    FORMAT(////////11X,'SUTRA SIMULATION TERMINATED AT',            SUTRA........75400
     1      ' COMPLETION OF TIME PERIOD'/                                SUTRA........75500
     2                  11X,'***** ********** ********** **',            SUTRA........75600
     3      ' ********** ** **** ******')                                SUTRA........75700
      ELSE                                                               SUTRA........75800
         WRITE(K3,8550)                                                  SUTRA........75900
 8550    FORMAT(////////11X,'SUTRA SIMULATION TERMINATED AT',            SUTRA........76000
     1      ' COMPLETION OF TIME STEPS'/                                 SUTRA........76100
     2                  11X,'***** ********** ********** **',            SUTRA........76200
     3      ' ********** ** **** *****')                                 SUTRA........76300
      END IF                                                             SUTRA........76400
C                                                                        SUTRA........76500
      IF (KSCRN.EQ.1) WRITE(*,8590)                                      SUTRA........76600
      WRITE(K00,8590)                                                    SUTRA........76700
 8590 FORMAT(/1X,'S I M U L A T I O N   E N D E D'/)                     SUTRA........76800
      RETURN                                                             SUTRA........76900
C                                                                        SUTRA........77000
      END                                                                SUTRA........77100
C                                                                        SUTRA........77200
C     SUBROUTINE        T  E  N  S  Y  M           SUTRA VERSION 2.2     TENSYM.........100
C                                                                        TENSYM.........200
C *** PURPOSE :                                                          TENSYM.........300
C ***  TO TRANSFORM A DIAGONAL MATRIX TO A NEW COORDINATE SYSTEM.        TENSYM.........400
C ***  [T] IS THE DIAGONAL MATRIX EXPRESSED IN THE FIRST (INPUT)         TENSYM.........500
C ***  COORDINATE SYSTEM; [P] IS THE (SYMMETRIC) MATRIX EXPRESSED        TENSYM.........600
C ***  IN THE SECOND (OUTPUT) COORDINATE SYSTEM; AND [Q] IS THE          TENSYM.........700
C ***  THE TRANSFORMATION MATRIX.                                        TENSYM.........800
C                                                                        TENSYM.........900
      SUBROUTINE TENSYM(T11,T22,T33,Q11,Q12,Q13,Q21,Q22,Q23,             TENSYM........1000
     1   Q31,Q32,Q33,P11,P12,P13,P21,P22,P23,P31,P32,P33)                TENSYM........1100
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                TENSYM........1200
C                                                                        TENSYM........1300
C.....COMPUTE TRANSFORMED MATRIX.                                        TENSYM........1400
      P11= T11*Q11*Q11 + T22*Q12*Q12 + T33*Q13*Q13                       TENSYM........1500
      P12= T11*Q11*Q21 + T22*Q12*Q22 + T33*Q13*Q23                       TENSYM........1600
      P13= T11*Q11*Q31 + T22*Q12*Q32 + T33*Q13*Q33                       TENSYM........1700
      P22= T11*Q21*Q21 + T22*Q22*Q22 + T33*Q23*Q23                       TENSYM........1800
      P23= T11*Q21*Q31 + T22*Q22*Q32 + T33*Q23*Q33                       TENSYM........1900
      P33= T11*Q31*Q31 + T22*Q32*Q32 + T33*Q33*Q33                       TENSYM........2000
      P21= P12                                                           TENSYM........2100
      P31= P13                                                           TENSYM........2200
      P32= P23                                                           TENSYM........2300
C                                                                        TENSYM........2400
      RETURN                                                             TENSYM........2500
      END                                                                TENSYM........2600
C                                                                        TENSYM........2700
C     SUBROUTINE        T  E  R  S  E  Q           SUTRA VERSION 2.2     TERSEQ.........100
C                                                                        TERSEQ.........200
C *** PURPOSE :                                                          TERSEQ.........300
C ***  TO GRACEFULLY TERMINATE A SUTRA RUN BY DEALLOCATING THE MAIN      TERSEQ.........400
C ***  ALLOCATABLE ARRAYS AND CLOSING ALL FILES.                         TERSEQ.........500
C                                                                        TERSEQ.........600
      SUBROUTINE TERSEQ()                                                TERSEQ.........700
      USE ALLARR                                                         TERSEQ.........800
      USE BCSDEF                                                         TERSEQ.........900
      USE FINDEF                                                         TERSEQ........1000
      USE SCHDEF                                                         TERSEQ........1100
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                TERSEQ........1200
      CHARACTER CDUM*1                                                   TERSEQ........1300
      LOGICAL ALCBCS,ALCFIN,ALCOBS                                       TERSEQ........1400
      COMMON /ALC/ ALCBCS,ALCFIN,ALCOBS                                  TERSEQ........1500
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 TERSEQ........1600
     1   K10,K11,K12,K13                                                 TERSEQ........1700
      COMMON /KPRINT/ KNODAL,KELMNT,KINCID,KPLOTP,KPLOTU,                TERSEQ........1800
     1   KPANDS,KVEL,KCORT,KBUDG,KSCRN,KPAUSE                            TERSEQ........1900
      COMMON /OBS/ NOBSN,NTOBS,NOBCYC,NOBLIN,NFLOMX                      TERSEQ........2000
C                                                                        TERSEQ........2100
C.....TERMINATION SEQUENCE: DEALLOCATE ARRAYS, CLOSE FILES, AND STOP     TERSEQ........2200
      IF (ALLO1) THEN                                                    TERSEQ........2300
         DEALLOCATE(PITER,UITER,PM1,DPDTITR,UM1,UM2,PVEL,SL,SR,X,Y,Z,    TERSEQ........2400
     1      VOL,POR,CS1,CS2,CS3,SW,DSWDP,RHO,SOP,QIN,UIN,QUIN,QINITR,    TERSEQ........2500
     2      RCIT,RCITM1,GNUP1,GNUU1)                                     TERSEQ........2600
         DEALLOCATE(PVEC,UVEC)                                           TERSEQ........2700
         DEALLOCATE(ALMAX,ALMIN,ATMAX,ATMIN,VMAG,VANG1,PERMXX,PERMXY,    TERSEQ........2800
     1      PERMYX,PERMYY,PANGL1)                                        TERSEQ........2900
         DEALLOCATE(ALMID,ATMID,VANG2,PERMXZ,PERMYZ,PERMZX,PERMZY,       TERSEQ........3000
     1      PERMZZ,PANGL2,PANGL3)                                        TERSEQ........3100
         DEALLOCATE(PBC,UBC,QPLITR)                                      TERSEQ........3200
         DEALLOCATE(GXSI,GETA,GZET)                                      TERSEQ........3300
         DEALLOCATE(B)                                                   TERSEQ........3400
         DEALLOCATE(IN,IQSOP,IQSOU,IPBC,IUBC,NREG,LREG,JA)               TERSEQ........3500
         DEALLOCATE(IBCPBC,IBCUBC,IBCSOP,IBCSOU)                         TERSEQ........3600
         DEALLOCATE(IIDPBC,IIDUBC,IIDSOP,IIDSOU)                         TERSEQ........3610
         DEALLOCATE(BCSFL,BCSTR)                                         TERSEQ........3620
         DEALLOCATE(OBSPTS)                                              TERSEQ........3700
      END IF                                                             TERSEQ........3800
      IF (ALLO2) THEN                                                    TERSEQ........3900
         DEALLOCATE(PMAT,UMAT,FWK)                                       TERSEQ........4000
         DEALLOCATE(IWK)                                                 TERSEQ........4100
      END IF                                                             TERSEQ........4200
      IF (ALLO3) THEN                                                    TERSEQ........4300
         DEALLOCATE(IA)                                                  TERSEQ........4400
      END IF                                                             TERSEQ........4500
      IF (ALCFIN) THEN                                                   TERSEQ........4600
         DEALLOCATE(NKS,KLIST,FNAIN)                                     TERSEQ........4700
      END IF                                                             TERSEQ........4800
      IF (ALCBCS) THEN                                                   TERSEQ........4900
         DEALLOCATE(IUNIB,FNAMB)                                         TERSEQ........5000
      END IF                                                             TERSEQ........5100
      IF (ALLOCATED(SCHDLS)) DEALLOCATE(SCHDLS)                          TERSEQ........5200
      IF (ALLOCATED(OFP)) DEALLOCATE(OFP)                                TERSEQ........5300
      IF (ALCOBS) DEALLOCATE(FNAMO)                                      TERSEQ........5400
      IF (ALLOCATED(ONCK78)) DEALLOCATE(ONCK78)                          TERSEQ........5500
      IF (ALLOCATED(CIDBCS)) DEALLOCATE(CIDBCS)                          TERSEQ........5510
C.....ARRAY IUNIO WILL BE DEALLOCATED AFTER THE OBSERVATION OUTPUT       TERSEQ........5600
C        FILES ARE CLOSED                                                TERSEQ........5700
      CLOSE(K00)                                                         TERSEQ........5800
      CLOSE(K0)                                                          TERSEQ........5900
      CLOSE(K1)                                                          TERSEQ........6000
      CLOSE(K2)                                                          TERSEQ........6100
      CLOSE(K3)                                                          TERSEQ........6200
      CLOSE(K4)                                                          TERSEQ........6300
      CLOSE(K5)                                                          TERSEQ........6400
      CLOSE(K6)                                                          TERSEQ........6500
      CLOSE(K7)                                                          TERSEQ........6600
      CLOSE(K8)                                                          TERSEQ........6700
      DO 8000 NFO=1,NFLOMX                                               TERSEQ........6800
         CLOSE(IUNIO(NFO))                                               TERSEQ........6900
 8000 CONTINUE                                                           TERSEQ........7000
      IF (ALCOBS) DEALLOCATE(IUNIO)                                      TERSEQ........7100
      IF ((KSCRN.EQ.1).AND.(KPAUSE.EQ.1)) THEN                           TERSEQ........7200
         WRITE(*,9990)                                                   TERSEQ........7300
 9990    FORMAT(/' Press ENTER to exit ...')                             TERSEQ........7400
         READ(*,'(A1)') CDUM                                             TERSEQ........7500
      END IF                                                             TERSEQ........7600
      STOP ' '                                                           TERSEQ........7700
C                                                                        TERSEQ........7800
      RETURN                                                             TERSEQ........7900
      END                                                                TERSEQ........8000
C                                                                        TERSEQ........8100
C     FUNCTION          T  I  M  E  T  S           SUTRA VERSION 2.2     TIMETS.........100
C                                                                        TIMETS.........200
C *** PURPOSE :                                                          TIMETS.........300
C ***  TO RETURN THE TIME ASSOCIATED WITH A GIVEN TIME STEP.  IF THE     TIMETS.........400
C ***  SPECIFIED TIME STEP IS GREATER THAN THE MAXIMUM, A VALUE OF       TIMETS.........500
C ***  +HUGE(1D0) (THE LARGEST NUMBER THAT CAN BE REPRESENTED IN DOUBLE  TIMETS.........600
C ***  PRECISION) IS RETURNED.  IF THE SPECIFIED TIME STEP IS LESS THAN  TIMETS.........700
C ***  ZERO, A VALUE OF -HUGE(1D0) IS RETURNED.  IF THE TIME STEP        TIMETS.........800
C ***  SCHEDULE HAS NOT YET BEEN DEFINED, A VALUE OF ZERO IS RETURNED.   TIMETS.........900
C                                                                        TIMETS........1000
      DOUBLE PRECISION FUNCTION TIMETS(NSTEP)                            TIMETS........1100
      USE LLDEF                                                          TIMETS........1200
      USE SCHDEF                                                         TIMETS........1300
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                TIMETS........1400
      TYPE (LLD), POINTER :: DEN                                         TIMETS........1500
      COMMON /SCH/ NSCH,ISCHTS,NSCHAU                                    TIMETS........1600
C                                                                        TIMETS........1700
      IF (ISCHTS.EQ.0) THEN                                              TIMETS........1800
         TIMETS = 0D0                                                    TIMETS........1900
         RETURN                                                          TIMETS........2000
      END IF                                                             TIMETS........2100
C                                                                        TIMETS........2200
      NSMAX = SCHDLS(ISCHTS)%LLEN - 1                                    TIMETS........2300
C                                                                        TIMETS........2400
      IF (NSTEP.LT.0) THEN                                               TIMETS........2500
         TIMETS = -HUGE(1D0)                                             TIMETS........2600
         RETURN                                                          TIMETS........2700
      ELSE IF (NSTEP.GT.NSMAX) THEN                                      TIMETS........2800
         TIMETS = +HUGE(1D0)                                             TIMETS........2900
         RETURN                                                          TIMETS........3000
      END IF                                                             TIMETS........3100
C                                                                        TIMETS........3200
      DEN => SCHDLS(ISCHTS)%SLIST                                        TIMETS........3300
      DO 100 NS=1,NSTEP                                                  TIMETS........3400
         DEN => DEN%NENT                                                 TIMETS........3500
  100 CONTINUE                                                           TIMETS........3600
      TIMETS = DEN%DVALU1                                                TIMETS........3700
C                                                                        TIMETS........3800
      RETURN                                                             TIMETS........3900
      END                                                                TIMETS........4000
C                                                                        TIMETS........4100
C     SUBROUTINE        Z  E  R  O                 SUTRA VERSION 2.2     ZERO...........100
C                                                                        ZERO...........200
C *** PURPOSE :                                                          ZERO...........300
C ***  TO FILL AN ARRAY WITH A CONSTANT VALUE (USUALLY ZERO).            ZERO...........400
C                                                                        ZERO...........500
      SUBROUTINE ZERO(A,IADIM,FILL)                                      ZERO...........600
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                ZERO...........700
      DIMENSION A(IADIM)                                                 ZERO...........800
C                                                                        ZERO...........900
C.....FILL ARRAY A WITH VALUE IN VARIABLE 'FILL'                         ZERO..........1000
      DO 10 I=1,IADIM                                                    ZERO..........1100
   10 A(I)=FILL                                                          ZERO..........1200
C                                                                        ZERO..........1300
C                                                                        ZERO..........1400
      RETURN                                                             ZERO..........1500
      END                                                                ZERO..........1600

C     ITERATIVE MATRIX SOLVERS (SLAP) ............ SUTRA VERSION 2.2     SLAP...........100
C                                                                        SLAP...........200
C *** PURPOSE :                                                          SLAP...........300
C ***  TO SOLVE MATRIX PROBLEMS USING ITERATIVE METHODS.  THE COMPUTER   SLAP...........400
C ***  CODE IN THIS FILE IS FROM THE SLATEC SOFTWARE LIBRARY.  IT        SLAP...........500
C ***  INCLUDES A SUBSET OF THE SLAP SOLVER PACKAGE AND ADDITIONAL CODE  SLAP...........600
C ***  UPON WHICH SLAP DEPENDS.  CREDITS ARE LISTED AT THE BEGINNING     SLAP...........700
C ***  OF EACH SUBROUTINE.  MODIFICATIONS TO THE ORIGINAL CODE MADE BY   SLAP...........800
C ***  THE AUTHORS OF SUTRA ARE MARKED AS SUCH; SEARCH FOR THE KEYWORD   SLAP...........900
C ***  "SUTRA".  GENERAL DOCUMENTATION FOR THE SLAP SOLVERS APPEARS IN   SLAP..........1000
C ***  SUBROUTINE DLPDOC BELOW.                                          SLAP..........1100
C ***                                                                    SLAP..........1200
C ***  THE FOLLOWING DISCLAIMER APPEARS IN FILE "aaaaaa.f" OF THE        SLAP..........1300
C ***  SLATEC LIBRARY v4.1:                                              SLAP..........1400
C ***                                                                    SLAP..........1500
C =====================================================================  SLAP..........1600
C                                                                        SLAP..........1700
C   "The SLATEC Common Mathematical Library is issued by the following   SLAP..........1800
C                                                                        SLAP..........1900
C           Air Force Weapons Laboratory, Albuquerque                    SLAP..........2000
C           Lawrence Livermore National Laboratory, Livermore            SLAP..........2100
C           Los Alamos National Laboratory, Los Alamos                   SLAP..........2200
C           National Institute of Standards and Technology, Washington   SLAP..........2300
C           National Energy Research Supercomputer Center, Livermore     SLAP..........2400
C           Oak Ridge National Laboratory, Oak Ridge                     SLAP..........2500
C           Sandia National Laboratories, Albuquerque                    SLAP..........2600
C           Sandia National Laboratories, Livermore                      SLAP..........2700
C                                                                        SLAP..........2800
C   All questions concerning the distribution of the library should be   SLAP..........2900
C   directed to the NATIONAL ENERGY SOFTWARE CENTER, 9700 Cass Ave.,     SLAP..........3000
C   Argonne, Illinois  60439, and not to the authors of the subprograms. SLAP..........3100
C                                                                        SLAP..........3200
C                    * * * * * Notice * * * * *                          SLAP..........3300
C                                                                        SLAP..........3400
C   This material was prepared as an account of work sponsored by the    SLAP..........3500
C   United States Government.  Neither the United States, nor the        SLAP..........3600
C   Department of Energy, nor the Department of Defense, nor any of      SLAP..........3700
C   their employees, nor any of their contractors, subcontractors, or    SLAP..........3800
C   their employees, makes any warranty, expressed or implied, or        SLAP..........3900
C   assumes any legal liability or responsibility for the accuracy,      SLAP..........4000
C   completeness, or usefulness of any information, apparatus, product,  SLAP..........4100
C   or process disclosed, or represents that its use would not infringe  SLAP..........4200
C   upon privately owned rights."                                        SLAP..........4300
C                                                                        SLAP..........4400
C =====================================================================  SLAP..........4500
C ***                                                                    SLAP..........4600
C ***  NOTE:  AS OF THIS WRITING, THE NATIONAL ENERGY SOFTWARE CENTER    SLAP..........4700
C ***  HAD RELOCATED TO OAK RIDGE NATIONAL LABORATORY AND HAD BEEN       SLAP..........4800
C ***  RENAMED THE ENERGY SCIENCE & TECHNOLOGY SOFTWARE CENTER (ESTSC).  SLAP..........4900
C ***                                                                    SLAP..........5000
C ***  BASED ON COMMUNICATIONS WITH ESTSC AND THE PRIMARY AUTHOR OF      SLAP..........5100
C ***  SLAP, THE AUTHORS OF SUTRA UNDERSTAND THAT THE CODE IN THIS FILE  SLAP..........5200
C ***  MAY BE FREELY DISTRIBUTED WITH SUTRA.  HOWEVER, NEITHER THE       SLAP..........5300
C ***  UNITED STATES GOVERNMENT, THE DEPARTMENT OF THE INTERIOR, THE     SLAP..........5400
C ***  U.S. GEOLOGICAL SURVEY, NOR THE AUTHORS OF SUTRA MAKE ANY         SLAP..........5500
C ***  WARRANTY, EXPRESSED OR IMPLIED, OR ASSUME ANY LEGAL LIABILITY OR  SLAP..........5600
C ***  RESPONSIBILITY FOR THE ACCURACY, COMPLETENESS, OR USEFULNESS OF   SLAP..........5700
C ***  THIS CODE OR ANY MODIFICATIONS MADE TO THIS CODE, OR GUARANTEE    SLAP..........5800
C ***  THAT ITS UNLIMITED USE WOULD NOT INFRINGE UPON PRIVATELY OWNED    SLAP..........5900
C ***  RIGHTS.                                                           SLAP..........6000
C ***                                                                    SLAP..........6100
C ***  THE CODE LISTING BEGINS BELOW WITH SUBROUTINE DLPDOC, WHICH       SLAP..........6200
C ***  PROVIDES GENERAL DOCUMENTATION FOR THE DOUBLE-PRECISION VERSION   SLAP..........6300
C ***  OF THE SLAP SOLVER PACKAGE.  THE REMAINING SUBROUTINES AND        SLAP..........6400
C ***  FUNCTIONS ARE THEN LISTED IN ALPHABETICAL ORDER.                  SLAP..........6500
C ***                                                                    SLAP..........6600
C =====================================================================  SLAP..........6700
C =====================================================================  SLAP..........6800
C                                                                        SLAP..........6900
*DECK DLPDOC                                                             SLAP..........7000
      SUBROUTINE DLPDOC                                                  SLAP..........7100
C***BEGIN PROLOGUE  DLPDOC                                               SLAP..........7200
C***PURPOSE  Sparse Linear Algebra Package Version 2.0.2 Documentation.  SLAP..........7300
C            Routines to solve large sparse symmetric and nonsymmetric   SLAP..........7400
C            positive definite linear systems, Ax = b, using precondi-   SLAP..........7500
C            tioned iterative methods.                                   SLAP..........7600
C***LIBRARY   SLATEC (SLAP)                                              SLAP..........7700
C***CATEGORY  D2A4, D2B4, Z                                              SLAP..........7800
C***TYPE      DOUBLE PRECISION (SLPDOC-S, DLPDOC-D)                      SLAP..........7900
C***KEYWORDS  BICONJUGATE GRADIENT SQUARED, DOCUMENTATION,               SLAP..........8000
C             GENERALIZED MINIMUM RESIDUAL, ITERATIVE IMPROVEMENT,       SLAP..........8100
C             NORMAL EQUATIONS, ORTHOMIN,                                SLAP..........8200
C             PRECONDITIONED CONJUGATE GRADIENT, SLAP,                   SLAP..........8300
C             SPARSE ITERATIVE METHODS                                   SLAP..........8400
C***AUTHOR  Seager, Mark. K., (LLNL)                                     SLAP..........8500
C             User Systems Division                                      SLAP..........8600
C             Lawrence Livermore National Laboratory                     SLAP..........8700
C             PO BOX 808, L-60                                           SLAP..........8800
C             Livermore, CA 94550                                        SLAP..........8900
C             (FTS) 543-3141, (510) 423-3141                             SLAP..........9000
C             seager@llnl.gov                                            SLAP..........9100
C***DESCRIPTION                                                          SLAP..........9200
C                                 The                                    SLAP..........9300
C                    Sparse Linear Algebra Package                       SLAP..........9400
C                      Double Precision Routines                         SLAP..........9500
C                                                                        SLAP..........9600
C                @@@@@@@  @            @@@    @@@@@@@@                   SLAP..........9700
C               @       @ @           @   @   @       @                  SLAP..........9800
C               @         @          @     @  @       @                  SLAP..........9900
C                @@@@@@@  @         @       @ @@@@@@@@                   SLAP.........10000
C                       @ @         @@@@@@@@@ @                          SLAP.........10100
C               @       @ @         @       @ @                          SLAP.........10200
C                @@@@@@@  @@@@@@@@@ @       @ @                          SLAP.........10300
C                                                                        SLAP.........10400
C      @       @                            @@@@@@@        @@@@@         SLAP.........10500
C      @       @                           @       @      @    @@        SLAP.........10600
C      @       @  @@@@@@@  @ @@                    @     @    @  @       SLAP.........10700
C      @       @ @       @ @@  @             @@@@@@      @   @   @       SLAP.........10800
C       @     @  @@@@@@@@@ @                @            @  @    @       SLAP.........10900
C        @   @   @         @               @         @@@  @@    @        SLAP.........11000
C         @@@     @@@@@@@  @               @@@@@@@@@ @@@   @@@@@         SLAP.........11100
C                                                                        SLAP.........11200
C                                                                        SLAP.........11300
C    =================================================================   SLAP.........11400
C    ========================== Introduction =========================   SLAP.........11500
C    =================================================================   SLAP.........11600
C      This package was  originally derived from a set of  iterative     SLAP.........11700
C      routines written by Anne Greenbaum, as announced in "Routines     SLAP.........11800
C      for Solving Large Sparse Linear Systems",  Tentacle, Lawrence     SLAP.........11900
C      Livermore  National  Laboratory,  Livermore  Computing Center     SLAP.........12000
C      (January 1986), pp 15-21.                                         SLAP.........12100
C                                                                        SLAP.........12200
C    This document  contains the specifications for  the  SLAP Version   SLAP.........12300
C    2.0 package, a Fortran 77  package  for  the  solution  of  large   SLAP.........12400
C    sparse   linear systems, Ax  =  b,  via  preconditioned iterative   SLAP.........12500
C    methods.   Included in  this  package are "core"  routines  to do   SLAP.........12600
C    Iterative   Refinement  (Jacobi's  method),  Conjugate  Gradient,   SLAP.........12700
C    Conjugate Gradient on the normal equations, AA'y = b,  (where x =   SLAP.........12800
C    A'y and  A' denotes the  transpose of   A), BiConjugate Gradient,   SLAP.........12900
C    BiConjugate  Gradient  Squared, Orthomin and  Generalized Minimum   SLAP.........13000
C    Residual Iteration.    These "core" routines   do  not  require a   SLAP.........13100
C    "fixed"   data  structure   for storing  the   matrix  A  and the   SLAP.........13200
C    preconditioning   matrix  M.   The  user  is free  to  choose any   SLAP.........13300
C    structure that facilitates  efficient solution  of the problem at   SLAP.........13400
C    hand.  The drawback  to this approach  is that the user must also   SLAP.........13500
C    supply at least two routines  (MATVEC and MSOLVE,  say).   MATVEC   SLAP.........13600
C    must calculate, y = Ax, given x and the user's data structure for   SLAP.........13700
C    A.  MSOLVE must solve,  r = Mz, for z (*NOT*  r) given r  and the   SLAP.........13800
C    user's data  structure for  M (or its  inverse).  The user should   SLAP.........13900
C    choose M so that  inv(M)*A  is approximately the identity and the   SLAP.........14000
C    solution step r = Mz is "easy" to  solve.  For some of the "core"   SLAP.........14100
C    routines (Orthomin,  BiConjugate Gradient and  Conjugate Gradient   SLAP.........14200
C    on the  normal equations)   the user must  also  supply  a matrix   SLAP.........14300
C    transpose times   vector  routine  (MTTVEC,  say)  and (possibly,   SLAP.........14400
C    depending    on the "core"  method)   a  routine  that solves the   SLAP.........14500
C    transpose  of   the   preconditioning    step     (MTSOLV,  say).   SLAP.........14600
C    Specifically, MTTVEC is a routine which calculates y = A'x, given   SLAP.........14700
C    x and the user's data structure for A (A' is the transpose of A).   SLAP.........14800
C    MTSOLV is a routine which solves the system r = M'z for z given r   SLAP.........14900
C    and the user's data structure for M.                                SLAP.........15000
C                                                                        SLAP.........15100
C    This process of writing the matrix vector operations  can be time   SLAP.........15200
C    consuming and error  prone.  To alleviate  these problems we have   SLAP.........15300
C    written drivers   for  the  "core" methods  that  assume the user   SLAP.........15400
C    supplies one of two specific data structures (SLAP Triad and SLAP   SLAP.........15500
C    Column format), see  below.  Utilizing these  data structures  we   SLAP.........15600
C    have augmented   each  "core" method  with   two preconditioners:   SLAP.........15700
C    Diagonal  Scaling and Incomplete Factorization.  Diagonal scaling   SLAP.........15800
C    is easy to implement, vectorizes very  well and for problems that   SLAP.........15900
C    are  not too  ill-conditioned  reduces the  number  of iterations   SLAP.........16000
C    enough   to warrant its use.  On   the other  hand, an Incomplete   SLAP.........16100
C    factorization  (Incomplete  Cholesky for  symmetric systems   and   SLAP.........16200
C    Incomplete LU for nonsymmetric  systems) may  take much longer to   SLAP.........16300
C    calculate, but it reduces the iteration count (for most problems)   SLAP.........16400
C    significantly.  Our implementations  of IC and ILU  vectorize for   SLAP.........16500
C    machines with hardware gather scatter, but the vector lengths can   SLAP.........16600
C    be quite short if  the  number  of non-zeros  in a column is  not   SLAP.........16700
C    large.                                                              SLAP.........16800
C                                                                        SLAP.........16900
C    =================================================================   SLAP.........17000
C    ==================== Supplied Data Structures ===================   SLAP.........17100
C    =================================================================   SLAP.........17200
C    The following describes the data   structures supplied  with  the   SLAP.........17300
C    package: SLAP Triad and Column formats.                             SLAP.........17400
C                                                                        SLAP.........17500
C    ====================== S L A P Triad format =====================   SLAP.........17600
C                                                                        SLAP.........17700
C    In the SLAP Triad format only the non-zeros are stored.  They may   SLAP.........17800
C    appear in *ANY* order.  The user supplies three  arrays of length   SLAP.........17900
C    NELT, where NELT  is the   number of  non-zeros  in the   matrix:   SLAP.........18000
C    (IA(NELT),  JA(NELT), A(NELT)).  If  the matrix is symmetric then   SLAP.........18100
C    one need only store the lower triangle (including  the  diagonal)   SLAP.........18200
C    and NELT would be the corresponding  number  of non-zeros stored.   SLAP.........18300
C    For each non-zero the user puts the row and column  index of that   SLAP.........18400
C    matrix  element   in the  IA  and JA  arrays.  The  value  of the   SLAP.........18500
C    non-zero matrix element is placed  in  the corresponding location   SLAP.........18600
C    of  the A array.   This  is an extremely  easy  data structure to   SLAP.........18700
C    generate.  On the other hand, it is not very  efficient on vector   SLAP.........18800
C    computers for the iterative  solution of  linear systems.  Hence,   SLAP.........18900
C    SLAP changes this input data structure to  the SLAP Column format   SLAP.........19000
C    for the iteration (but does not change it back).                    SLAP.........19100
C                                                                        SLAP.........19200
C    Here  is an example   of  the  SLAP  Triad storage  format  for a   SLAP.........19300
C    nonsymmetric 5x5 Matrix.  NELT=11.   Recall that the  entries may   SLAP.........19400
C    appear in any order.                                                SLAP.........19500
C                                                                        SLAP.........19600
C     5x5 Matrix       SLAP Triad format for 5x5 matrix on left.         SLAP.........19700
C                           1  2  3  4  5  6  7  8  9 10 11              SLAP.........19800
C    |11 12  0  0 15|   A: 51 12 11 33 15 53 55 22 35 44 21              SLAP.........19900
C    |21 22  0  0  0|  IA:  5  1  1  3  1  5  5  2  3  4  2              SLAP.........20000
C    | 0  0 33  0 35|  JA:  1  2  1  3  5  3  5  2  5  4  1              SLAP.........20100
C    | 0  0  0 44  0|                                                    SLAP.........20200
C    |51  0 53  0 55|                                                    SLAP.........20300
C                                                                        SLAP.........20400
C    ====================== S L A P Column format ====================   SLAP.........20500
C                                                                        SLAP.........20600
C    In the SLAP Column format  the non-zeros are stored counting down   SLAP.........20700
C    columns (except for the  diagonal entry,  which must appear first   SLAP.........20800
C    in each "column") and are stored in the double precision array A.   SLAP.........20900
C    In  other words,  for each  column  in the matrix  first put  the   SLAP.........21000
C    diagonal  entry  in A.  Then  put in the other  non-zero elements   SLAP.........21100
C    going  down the column  (except the  diagonal)  in order.  The IA   SLAP.........21200
C    array holds the row index  for each non-zero.  The JA array holds   SLAP.........21300
C    the  offsets  into the  IA, A  arrays for the  beginning of  each   SLAP.........21400
C    column. That is, IA(JA(ICOL)), A(JA(ICOL)) are the first elements   SLAP.........21500
C    of  the  ICOL-th  column  in  IA  and  A,  and  IA(JA(ICOL+1)-1),   SLAP.........21600
C    A(JA(ICOL+1)-1) are the last elements of the ICOL-th column. Note   SLAP.........21700
C    that we  always have  JA(N+1) = NELT+1, where  N is the number of   SLAP.........21800
C    columns in the matrix  and NELT is the number of non-zeros in the   SLAP.........21900
C    matrix.  If the matrix is symmetric one need only store the lower   SLAP.........22000
C    triangle  (including the diagonal)  and NELT would be the  corre-   SLAP.........22100
C    sponding number of non-zeros stored.                                SLAP.........22200
C                                                                        SLAP.........22300
C    Here is  an  example of the  SLAP   Column storage format  for  a   SLAP.........22400
C    nonsymmetric 5x5 Matrix (in the  A and  IA arrays '|' denotes the   SLAP.........22500
C    end of a column):                                                   SLAP.........22600
C                                                                        SLAP.........22700
C       5x5 Matrix      SLAP Column format for 5x5 matrix on left.       SLAP.........22800
C                           1  2  3    4  5    6  7    8    9 10 11      SLAP.........22900
C    |11 12  0  0 15|   A: 11 21 51 | 22 12 | 33 53 | 44 | 55 15 35      SLAP.........23000
C    |21 22  0  0  0|  IA:  1  2  5 |  2  1 |  3  5 |  4 |  5  1  3      SLAP.........23100
C    | 0  0 33  0 35|  JA:  1  4  6    8  9   12                         SLAP.........23200
C    | 0  0  0 44  0|                                                    SLAP.........23300
C    |51  0 53  0 55|                                                    SLAP.........23400
C                                                                        SLAP.........23500
C    =================================================================   SLAP.........23600
C    ====================== Which Method To Use ======================   SLAP.........23700
C    =================================================================   SLAP.........23800
C                                                                        SLAP.........23900
C                          BACKGROUND                                    SLAP.........24000
C    In solving a large sparse linear system Ax = b using an iterative   SLAP.........24100
C    method, it   is  not necessary to actually   store  the matrix A.   SLAP.........24200
C    Rather, what is needed is a procedure  for multiplying the matrix   SLAP.........24300
C    A times a given vector y to obtain the matrix-vector product, Ay.   SLAP.........24400
C    SLAP has been written to take advantage of this fact.  The higher   SLAP.........24500
C    level routines in the package require storage only of the non-zero  SLAP.........24600
C    elements of   A (and  their  positions), and  even this   can  be   SLAP.........24700
C    avoided, if the  user  writes his own subroutine for  multiplying   SLAP.........24800
C    the matrix times a vector  and   calls the lower-level  iterative   SLAP.........24900
C    routines in the package.                                            SLAP.........25000
C                                                                        SLAP.........25100
C    If  the matrix A is ill-conditioned,  then most iterative methods   SLAP.........25200
C    will be slow to converge (if they converge  at all!).  To improve   SLAP.........25300
C    the  convergence  rate,  one  may use  a "matrix  splitting," or,   SLAP.........25400
C    "preconditioning matrix," say, M.  It is then necessary to solve,   SLAP.........25500
C    at each iteration, a linear system  with coefficient matrix M.  A   SLAP.........25600
C    good preconditioner  M should have  two  properties: (1) M should   SLAP.........25700
C    "approximate" A, in the sense that the  matrix inv(M)*A  (or some   SLAP.........25800
C    variant  thereof) is better conditioned  than the original matrix   SLAP.........25900
C    A; and  (2) linear  systems with coefficient  matrix M should  be   SLAP.........26000
C    much easier  to solve  than  the original system with coefficient   SLAP.........26100
C    matrix   A.   Preconditioning routines  in the   SLAP package are   SLAP.........26200
C    separate from the  iterative   routines,  so   that any of    the   SLAP.........26300
C    preconditioners provided in the package,   or one that the   user   SLAP.........26400
C    codes himself, can be used with any of the iterative routines.      SLAP.........26500
C                                                                        SLAP.........26600
C                        CHOICE OF PRECONDITIONER                        SLAP.........26700
C    If you  willing   to live with   either the SLAP Triad or  Column   SLAP.........26800
C    matrix data structure  you  can then  choose one  of two types of   SLAP.........26900
C    preconditioners   to   use:   diagonal  scaling    or  incomplete   SLAP.........27000
C    factorization.  To  choose   between these two   methods requires   SLAP.........27100
C    knowing  something  about the computer you're going  to run these   SLAP.........27200
C    codes on  and how well incomplete factorization  approximates the   SLAP.........27300
C    inverse of your matrix.                                             SLAP.........27400
C                                                                        SLAP.........27500
C    Let us  suppose you have   a scalar  machine.   Then,  unless the   SLAP.........27600
C    incomplete factorization is very,  very poor this  is *GENERALLY*   SLAP.........27700
C    the method to choose.  It  will reduce the  number of  iterations   SLAP.........27800
C    significantly and is not all  that expensive  to compute.  So  if   SLAP.........27900
C    you have just one  linear system to solve  and  "just want to get   SLAP.........28000
C    the job  done" then try  incomplete factorization first.   If you   SLAP.........28100
C    are thinking of integrating some SLAP  iterative method into your   SLAP.........28200
C    favorite   "production  code" then  try incomplete  factorization   SLAP.........28300
C    first,  but  also check  to see that  diagonal  scaling is indeed   SLAP.........28400
C    slower for a large sample of test problems.                         SLAP.........28500
C                                                                        SLAP.........28600
C    Let us now suppose  you have  a  vector  computer  with  hardware   SLAP.........28700
C    gather/scatter support (Cray X-MP, Y-MP, SCS-40 or Cyber 205, ETA   SLAP.........28800
C    10,  ETA Piper,  Convex C-1,  etc.).   Then  it is much harder to   SLAP.........28900
C    choose  between the  two  methods.   The  versions  of incomplete   SLAP.........29000
C    factorization in SLAP do in fact vectorize, but have short vector   SLAP.........29100
C    lengths and the factorization step is relatively  more expensive.   SLAP.........29200
C    Hence,  for  most problems (i.e.,  unless  your  problem  is  ill   SLAP.........29300
C    conditioned,  sic!)  diagonal  scaling is  faster,  with its very   SLAP.........29400
C    fast    set up  time    and  vectorized  (with   long    vectors)   SLAP.........29500
C    preconditioning step (even though  it  may take more iterations).   SLAP.........29600
C    If you have several systems (or  right hand sides) to  solve that   SLAP.........29700
C    can  utilize  the  same  preconditioner  then the   cost   of the   SLAP.........29800
C    incomplete factorization can   be  amortized over these  several    SLAP.........29900
C    solutions.  This situation gives more advantage to the incomplete   SLAP.........30000
C    factorization methods.  If  you have  a  vector  machine  without   SLAP.........30100
C    hardware  gather/scatter (Cray  1,  Cray  2  &  Cray 3) then  the   SLAP.........30200
C    advantages for incomplete factorization are even less.              SLAP.........30300
C                                                                        SLAP.........30400
C    If you're trying to shoehorn SLAP into your  favorite "production   SLAP.........30500
C    code" and can not easily generate either the SLAP Triad or Column   SLAP.........30600
C    format  then  you are  left  to   your  own  devices in terms  of   SLAP.........30700
C    preconditioning.  Also,  you may  find that the   preconditioners   SLAP.........30800
C    supplied with SLAP are not sufficient  for your problem.  In this   SLAP.........30900
C    situation we would  recommend  that you   talk  with a  numerical   SLAP.........31000
C    analyst  versed in   iterative   methods   about   writing  other   SLAP.........31100
C    preconditioning  subroutines (e.g.,  polynomial  preconditioning,   SLAP.........31200
C    shifted incomplete factorization,  SOR  or SSOR  iteration).  You   SLAP.........31300
C    can always "roll your own"  by using the "core" iterative methods   SLAP.........31400
C    and supplying your own MSOLVE and MATVEC (and possibly MTSOLV and   SLAP.........31500
C    MTTVEC) routines.                                                   SLAP.........31600
C                                                                        SLAP.........31700
C                          SYMMETRIC SYSTEMS                             SLAP.........31800
C    If your matrix is symmetric then you would want to use one of the   SLAP.........31900
C    symmetric system  solvers.    If  your  system  is  also positive   SLAP.........32000
C    definite,   (Ax,x) (Ax dot  product  with x) is  positive for all   SLAP.........32100
C    non-zero  vectors x,  then use   Conjugate Gradient (DCG,  DSDCG,   SLAP.........32200
C    DSICSG).  If you're  not sure it's SPD   (symmetric and  Positive   SLAP.........32300
C    Definite)  then try DCG anyway and  if it works, fine.  If you're   SLAP.........32400
C    sure your matrix is not  positive definite  then you  may want to   SLAP.........32500
C    try the iterative refinement   methods  (DIR)  or the  GMRES code   SLAP.........32600
C    (DGMRES) if DIR converges too slowly.                               SLAP.........32700
C                                                                        SLAP.........32800
C                         NONSYMMETRIC SYSTEMS                           SLAP.........32900
C    This   is currently  an  area  of  active research  in  numerical   SLAP.........33000
C    analysis  and   there   are   new  strategies  being   developed.   SLAP.........33100
C    Consequently take the following advice with a grain of salt.   If   SLAP.........33200
C    you matrix is positive definite, (Ax,x)  (Ax  dot product  with x   SLAP.........33300
C    is positive for all non-zero  vectors x), then you can use any of   SLAP.........33400
C    the    methods   for   nonsymmetric   systems (Orthomin,   GMRES,   SLAP.........33500
C    BiConjugate Gradient, BiConjugate Gradient  Squared and Conjugate   SLAP.........33600
C    Gradient applied to the normal equations).  If your system is not   SLAP.........33700
C    too ill conditioned then try  BiConjugate Gradient Squared (BCGS)   SLAP.........33800
C    or GMRES (DGMRES).  Both  of  these methods converge very quickly   SLAP.........33900
C    and do  not require A'  or M' ('  denotes transpose) information.   SLAP.........34000
C    DGMRES  does require  some  additional storage,  though.  If  the   SLAP.........34100
C    system is very  ill conditioned  or   nearly positive  indefinite   SLAP.........34200
C    ((Ax,x) is positive,  but may be  very small),  then GMRES should   SLAP.........34300
C    be the first choice,  but try the  other  methods  if you have to   SLAP.........34400
C    fine tune  the solution process for a  "production code".  If you   SLAP.........34500
C    have a great preconditioner for the normal  equations (i.e., M is   SLAP.........34600
C    an approximation to the inverse of AA' rather than  just  A) then   SLAP.........34700
C    this is not a bad route to travel.  Old wisdom would say that the   SLAP.........34800
C    normal equations are a disaster  (since it squares the  condition   SLAP.........34900
C    number of the system and DCG convergence is linked to this number   SLAP.........35000
C    of    infamy), but   some     preconditioners    (like incomplete   SLAP.........35100
C    factorization) can reduce the condition number back below that of   SLAP.........35200
C    the original system.                                                SLAP.........35300
C                                                                        SLAP.........35400
C    =================================================================   SLAP.........35500
C    ======================= Naming Conventions ======================   SLAP.........35600
C    =================================================================   SLAP.........35700
C    SLAP  iterative  methods,    matrix vector    and  preconditioner   SLAP.........35800
C    calculation  routines   follow a naming   convention  which, when   SLAP.........35900
C    understood, allows one to determine the iterative method and data   SLAP.........36000
C    structure(s) used.  The  subroutine  naming convention  takes the   SLAP.........36100
C    following form:                                                     SLAP.........36200
C                          P[S][M]DESC                                   SLAP.........36300
C    where                                                               SLAP.........36400
C        P  stands for the precision (or data type) of the routine and   SLAP.........36500
C           is required in all names,                                    SLAP.........36600
C        S  denotes whether or not the routine requires the SLAP Triad   SLAP.........36700
C           or Column format (it does if the second letter of the name   SLAP.........36800
C           is S and does not otherwise),                                SLAP.........36900
C        M  stands for the type of preconditioner used (only appears     SLAP.........37000
C           in drivers for "core" routines), and                         SLAP.........37100
C     DESC  is some number of letters describing the method or purpose   SLAP.........37200
C           of the routine.  The following is a list of the "DESC"       SLAP.........37300
C           fields for iterative methods and their meaning:              SLAP.........37400
C             BCG,BC:       BiConjugate Gradient                         SLAP.........37500
C             CG:           Conjugate Gradient                           SLAP.........37600
C             CGN,CN:       Conjugate Gradient on the Normal equations   SLAP.........37700
C             CGS,CS:       biConjugate Gradient Squared                 SLAP.........37800
C             GMRES,GMR,GM: Generalized Minimum RESidual                 SLAP.........37900
C             IR,R:         Iterative Refinement                         SLAP.........38000
C             JAC:          JACobi's method                              SLAP.........38100
C             GS:           Gauss-Seidel                                 SLAP.........38200
C             OMN,OM:       OrthoMiN                                     SLAP.........38300
C                                                                        SLAP.........38400
C    In the double precision version of SLAP, all routine names start    SLAP.........38500
C    with a D. The brackets around the S and M designate that these      SLAP.........38600
C    fields are optional.                                                SLAP.........38700
C                                                                        SLAP.........38800
C    Here are some examples of the routines:                             SLAP.........38900
C    1) DBCG: Double precision BiConjugate Gradient "core" routine.      SLAP.........39000
C       One can deduce that this is a "core" routine, because the S and  SLAP.........39100
C       M fields are missing and BiConjugate Gradient is an iterative    SLAP.........39200
C       method.                                                          SLAP.........39300
C    2) DSDBCG: Double precision, SLAP data structure BCG with Diagonal  SLAP.........39400
C       scaling.                                                         SLAP.........39500
C    3) DSLUBC: Double precision, SLAP data structure BCG with incom-    SLAP.........39600
C       plete LU factorization as the preconditioning.                   SLAP.........39700
C    4) DCG: Double precision Conjugate Gradient "core" routine.         SLAP.........39800
C    5) DSDCG: Double precision, SLAP data structure Conjugate Gradient  SLAP.........39900
C       with Diagonal scaling.                                           SLAP.........40000
C    6) DSICCG: Double precision, SLAP data structure Conjugate Gra-     SLAP.........40100
C       dient with Incomplete Cholesky factorization preconditioning.    SLAP.........40200
C                                                                        SLAP.........40300
C                                                                        SLAP.........40400
C    =================================================================   SLAP.........40500
C    ===================== USER CALLABLE ROUTINES ====================   SLAP.........40600
C    =================================================================   SLAP.........40700
C    The following is a list of  the "user callable" SLAP routines and   SLAP.........40800
C    their one line descriptions.  The headers denote  the  file names   SLAP.........40900
C    where the routines can be found, as distributed for UNIX systems.   SLAP.........41000
C                                                                        SLAP.........41100
C    Note:  Each core routine, DXXX, has a corresponding stop routine,   SLAP.........41200
C         ISDXXX.  If the stop routine does not have the specific stop   SLAP.........41300
C         test the user requires (e.g., weighted infinity norm),  then   SLAP.........41400
C         the user should modify the source for ISDXXX accordingly.      SLAP.........41500
C                                                                        SLAP.........41600
C    ============================= dir.f =============================   SLAP.........41700
C    DIR: Preconditioned Iterative Refinement Sparse Ax = b Solver.      SLAP.........41800
C    DSJAC: Jacobi's Method Iterative Sparse Ax = b Solver.              SLAP.........41900
C    DSGS: Gauss-Seidel Method Iterative Sparse Ax = b Solver.           SLAP.........42000
C    DSILUR: Incomplete LU Iterative Refinement Sparse Ax = b Solver.    SLAP.........42100
C                                                                        SLAP.........42200
C    ============================= dcg.f =============================   SLAP.........42300
C    DCG: Preconditioned Conjugate Gradient Sparse Ax=b Solver.          SLAP.........42400
C    DSDCG: Diagonally Scaled Conjugate Gradient Sparse Ax=b Solver.     SLAP.........42500
C    DSICCG: Incomplete Cholesky Conjugate Gradient Sparse Ax=b Solver.  SLAP.........42600
C                                                                        SLAP.........42700
C    ============================= dcgn.f ============================   SLAP.........42800
C    DCGN: Preconditioned CG Sparse Ax=b Solver for Normal Equations.    SLAP.........42900
C    DSDCGN: Diagonally Scaled CG Sparse Ax=b Solver for Normal Eqn's.   SLAP.........43000
C    DSLUCN: Incomplete LU CG Sparse Ax=b Solver for Normal Equations.   SLAP.........43100
C                                                                        SLAP.........43200
C    ============================= dbcg.f ============================   SLAP.........43300
C    DBCG: Preconditioned BiConjugate Gradient Sparse Ax = b Solver.     SLAP.........43400
C    DSDBCG: Diagonally Scaled BiConjugate Gradient Sparse Ax=b Solver.  SLAP.........43500
C    DSLUBC: Incomplete LU BiConjugate Gradient Sparse Ax=b Solver.      SLAP.........43600
C                                                                        SLAP.........43700
C    ============================= dcgs.f ============================   SLAP.........43800
C    DCGS: Preconditioned BiConjugate Gradient Squared Ax=b Solver.      SLAP.........43900
C    DSDCGS: Diagonally Scaled CGS Sparse Ax=b Solver.                   SLAP.........44000
C    DSLUCS: Incomplete LU BiConjugate Gradient Squared Ax=b Solver.     SLAP.........44100
C                                                                        SLAP.........44200
C    ============================= domn.f ============================   SLAP.........44300
C    DOMN: Preconditioned Orthomin Sparse Iterative Ax=b Solver.         SLAP.........44400
C    DSDOMN: Diagonally Scaled Orthomin Sparse Iterative Ax=b Solver.    SLAP.........44500
C    DSLUOM: Incomplete LU Orthomin Sparse Iterative Ax=b Solver.        SLAP.........44600
C                                                                        SLAP.........44700
C    ============================ dgmres.f ===========================   SLAP.........44800
C    DGMRES: Preconditioned GMRES Iterative Sparse Ax=b Solver.          SLAP.........44900
C    DSDGMR: Diagonally Scaled GMRES Iterative Sparse Ax=b Solver.       SLAP.........45000
C    DSLUGM: Incomplete LU GMRES Iterative Sparse Ax=b Solver.           SLAP.........45100
C                                                                        SLAP.........45200
C    ============================ dmset.f ============================   SLAP.........45300
C       The following routines are used to set up preconditioners.       SLAP.........45400
C                                                                        SLAP.........45500
C    DSDS: Diagonal Scaling Preconditioner SLAP Set Up.                  SLAP.........45600
C    DSDSCL: Diagonally Scales/Unscales a SLAP Column Matrix.            SLAP.........45700
C    DSD2S: Diagonal Scaling Preconditioner SLAP Normal Eqns Set Up.     SLAP.........45800
C    DS2LT: Lower Triangle Preconditioner SLAP Set Up.                   SLAP.........45900
C    DSICS: Incomplete Cholesky Decomp. Preconditioner SLAP Set Up.      SLAP.........46000
C    DSILUS: Incomplete LU Decomposition Preconditioner SLAP Set Up.     SLAP.........46100
C                                                                        SLAP.........46200
C    ============================ dmvops.f ===========================   SLAP.........46300
C       Most of the incomplete  factorization  (LL' and LDU) solvers     SLAP.........46400
C       in this  file require an  intermediate routine  to translate     SLAP.........46500
C       from the SLAP MSOLVE(N, R, Z, NELT, IA,  JA, A, ISYM, RWORK,     SLAP.........46600
C       IWORK) calling  convention to the calling  sequence required     SLAP.........46700
C       by  the solve routine.   This generally  is  accomplished by     SLAP.........46800
C       fishing out pointers to the preconditioner (stored in RWORK)     SLAP.........46900
C       from the  IWORK  array and then making a call to the routine     SLAP.........47000
C       that actually does the backsolve.                                SLAP.........47100
C                                                                        SLAP.........47200
C    DSMV: SLAP Column Format Sparse Matrix Vector Product.              SLAP.........47300
C    DSMTV: SLAP Column Format Sparse Matrix (transpose) Vector Prod.    SLAP.........47400
C    DSDI: Diagonal Matrix Vector Multiply.                              SLAP.........47500
C    DSLI: SLAP MSOLVE for Lower Triangle Matrix (set up for DSLI2).     SLAP.........47600
C    DSLI2: Lower Triangle Matrix Backsolve.                             SLAP.........47700
C    DSLLTI: SLAP MSOLVE for LDL' (IC) Fact. (set up for DLLTI2).        SLAP.........47800
C    DLLTI2: Backsolve routine for LDL' Factorization.                   SLAP.........47900
C    DSLUI: SLAP MSOLVE for LDU Factorization (set up for DSLUI2).       SLAP.........48000
C    DSLUI2: SLAP Backsolve for LDU Factorization.                       SLAP.........48100
C    DSLUTI: SLAP MTSOLV for LDU Factorization (set up for DSLUI4).      SLAP.........48200
C    DSLUI4: SLAP Backsolve for LDU Factorization.                       SLAP.........48300
C    DSMMTI: SLAP MSOLVE for LDU Fact of Normal Eq (set up for DSMMI2).  SLAP.........48400
C    DSMMI2: SLAP Backsolve for LDU Factorization of Normal Equations.   SLAP.........48500
C                                                                        SLAP.........48600
C    =========================== dlaputil.f ==========================   SLAP.........48700
C       The following utility routines are useful additions to SLAP.     SLAP.........48800
C                                                                        SLAP.........48900
C    DBHIN: Read Sparse Linear System in the Boeing/Harwell Format.      SLAP.........49000
C    DCHKW: SLAP WORK/IWORK Array Bounds Checker.                        SLAP.........49100
C    DCPPLT: Printer Plot of SLAP Column Format Matrix.                  SLAP.........49200
C    DS2Y: SLAP Triad to SLAP Column Format Converter.                   SLAP.........49300
C    QS2I1D: Quick Sort Integer array, moving integer and DP arrays.     SLAP.........49400
C            (Used by DS2Y.)                                             SLAP.........49500
C    DTIN: Read in SLAP Triad Format Linear System.                      SLAP.........49600
C    DTOUT: Write out SLAP Triad Format Linear System.                   SLAP.........49700
C                                                                        SLAP.........49800
C                                                                        SLAP.........49900
C***REFERENCES  1. Mark K. Seager, A SLAP for the Masses, in             SLAP.........50000
C                  G. F. Carey, Ed., Parallel Supercomputing: Methods,   SLAP.........50100
C                  Algorithms and Applications, Wiley, 1989, pp.135-155. SLAP.........50200
C***ROUTINES CALLED  (NONE)                                              SLAP.........50300
C***REVISION HISTORY  (YYMMDD)                                           SLAP.........50400
C   890404  DATE WRITTEN                                                 SLAP.........50500
C   890404  Previous REVISION DATE                                       SLAP.........50600
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP.........50700
C   890921  Removed TeX from comments.  (FNF)                            SLAP.........50800
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP.........50900
C           standard.  (FNF)                                             SLAP.........51000
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP.........51100
C           -----( This produced Version 2.0.1. )-----                   SLAP.........51200
C   891003  Rearranged list of user callable routines to agree with      SLAP.........51300
C           order in source deck.  (FNF)                                 SLAP.........51400
C   891004  Updated reference.                                           SLAP.........51500
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP.........51600
C           -----( This produced Version 2.0.2. )-----                   SLAP.........51700
C   910506  Minor improvements to prologue.  (FNF)                       SLAP.........51800
C   920511  Added complete declaration section.  (WRB)                   SLAP.........51900
C   920929  Corrected format of reference.  (FNF)                        SLAP.........52000
C   921019  Improved one-line descriptions, reordering some.  (FNF)      SLAP.........52100
C***END PROLOGUE  DLPDOC                                                 SLAP.........52200
C***FIRST EXECUTABLE STATEMENT  DLPDOC                                   SLAP.........52300
C                                                                        SLAP.........52400
C     This is a *DUMMY* subroutine and should never be called.           SLAP.........52500
C                                                                        SLAP.........52600
      RETURN                                                             SLAP.........52700
C------------- LAST LINE OF DLPDOC FOLLOWS ----------------------------- SLAP.........52800
      END                                                                SLAP.........52900
*DECK D1MACH                                                             SLAP.........53000
      DOUBLE PRECISION FUNCTION D1MACH (I)                               SLAP.........53100
C***BEGIN PROLOGUE  D1MACH                                               SLAP.........53200
C***PURPOSE  Return floating point machine dependent constants.          SLAP.........53300
C***LIBRARY   SLATEC                                                     SLAP.........53400
C***CATEGORY  R1                                                         SLAP.........53500
C***TYPE      DOUBLE PRECISION (R1MACH-S, D1MACH-D)                      SLAP.........53600
C***KEYWORDS  MACHINE CONSTANTS                                          SLAP.........53700
C***AUTHOR  Fox, P. A., (Bell Labs)                                      SLAP.........53800
C           Hall, A. D., (Bell Labs)                                     SLAP.........53900
C           Schryer, N. L., (Bell Labs)                                  SLAP.........54000
C***DESCRIPTION                                                          SLAP.........54100
C                                                                        SLAP.........54200
C   D1MACH can be used to obtain machine-dependent parameters for the    SLAP.........54300
C   local machine environment.  It is a function subprogram with one     SLAP.........54400
C   (input) argument, and can be referenced as follows:                  SLAP.........54500
C                                                                        SLAP.........54600
C        D = D1MACH(I)                                                   SLAP.........54700
C                                                                        SLAP.........54800
C   where I=1,...,5.  The (output) value of D above is determined by     SLAP.........54900
C   the (input) value of I.  The results for various values of I are     SLAP.........55000
C   discussed below.                                                     SLAP.........55100
C                                                                        SLAP.........55200
C   D1MACH( 1) = B**(EMIN-1), the smallest positive magnitude.           SLAP.........55300
C   D1MACH( 2) = B**EMAX*(1 - B**(-T)), the largest magnitude.           SLAP.........55400
C   D1MACH( 3) = B**(-T), the smallest relative spacing.                 SLAP.........55500
C   D1MACH( 4) = B**(1-T), the largest relative spacing.                 SLAP.........55600
C   D1MACH( 5) = LOG10(B)                                                SLAP.........55700
C                                                                        SLAP.........55800
C   Assume double precision numbers are represented in the T-digit,      SLAP.........55900
C   base-B form                                                          SLAP.........56000
C                                                                        SLAP.........56100
C              sign (B**E)*( (X(1)/B) + ... + (X(T)/B**T) )              SLAP.........56200
C                                                                        SLAP.........56300
C   where 0 .LE. X(I) .LT. B for I=1,...,T, 0 .LT. X(1), and             SLAP.........56400
C   EMIN .LE. E .LE. EMAX.                                               SLAP.........56500
C                                                                        SLAP.........56600
C   The values of B, T, EMIN and EMAX are provided in I1MACH as          SLAP.........56700
C   follows:                                                             SLAP.........56800
C   I1MACH(10) = B, the base.                                            SLAP.........56900
C   I1MACH(14) = T, the number of base-B digits.                         SLAP.........57000
C   I1MACH(15) = EMIN, the smallest exponent E.                          SLAP.........57100
C   I1MACH(16) = EMAX, the largest exponent E.                           SLAP.........57200
C                                                                        SLAP.........57300
C   To alter this function for a particular environment, the desired     SLAP.........57400
C   set of DATA statements should be activated by removing the C from    SLAP.........57500
C   column 1.  Also, the values of D1MACH(1) - D1MACH(4) should be       SLAP.........57600
C   checked for consistency with the local operating system.             SLAP.........57700
C                                                                        SLAP.........57800
C***REFERENCES  P. A. Fox, A. D. Hall and N. L. Schryer, Framework for   SLAP.........57900
C                 a portable library, ACM Transactions on Mathematical   SLAP.........58000
C                 Software 4, 2 (June 1978), pp. 177-188.                SLAP.........58100
C***ROUTINES CALLED  XERMSG                                              SLAP.........58200
C***REVISION HISTORY  (YYMMDD)                                           SLAP.........58300
C   750101  DATE WRITTEN                                                 SLAP.........58400
C   890213  REVISION DATE from Version 3.2                               SLAP.........58500
C   891214  Prologue converted to Version 4.0 format.  (BAB)             SLAP.........58600
C   900315  CALLs to XERROR changed to CALLs to XERMSG.  (THJ)           SLAP.........58700
C   900618  Added DEC RISC constants.  (WRB)                             SLAP.........58800
C   900723  Added IBM RS 6000 constants.  (WRB)                          SLAP.........58900
C   900911  Added SUN 386i constants.  (WRB)                             SLAP.........59000
C   910710  Added HP 730 constants.  (SMR)                               SLAP.........59100
C   911114  Added Convex IEEE constants.  (WRB)                          SLAP.........59200
C   920121  Added SUN -r8 compiler option constants.  (WRB)              SLAP.........59300
C   920229  Added Touchstone Delta i860 constants.  (WRB)                SLAP.........59400
C   920501  Reformatted the REFERENCES section.  (WRB)                   SLAP.........59500
C   920625  Added CONVEX -p8 and -pd8 compiler option constants.         SLAP.........59600
C           (BKS, WRB)                                                   SLAP.........59700
C   930201  Added DEC Alpha and SGI constants.  (RWC and WRB)            SLAP.........59800
C***END PROLOGUE  D1MACH                                                 SLAP.........59900
C                                                                        SLAP.........60000
      INTEGER SMALL(4)                                                   SLAP.........60100
      INTEGER LARGE(4)                                                   SLAP.........60200
      INTEGER RIGHT(4)                                                   SLAP.........60300
      INTEGER DIVER(4)                                                   SLAP.........60400
      INTEGER LOG10(4)                                                   SLAP.........60500
C                                                                        SLAP.........60600
      DOUBLE PRECISION DMACH(5)                                          SLAP.........60700
      SAVE DMACH                                                         SLAP.........60800
C                                                                        SLAP.........60900
      EQUIVALENCE (DMACH(1),SMALL(1))                                    SLAP.........61000
      EQUIVALENCE (DMACH(2),LARGE(1))                                    SLAP.........61100
      EQUIVALENCE (DMACH(3),RIGHT(1))                                    SLAP.........61200
      EQUIVALENCE (DMACH(4),DIVER(1))                                    SLAP.........61300
      EQUIVALENCE (DMACH(5),LOG10(1))                                    SLAP.........61400
C                                                                        SLAP.........61500
C     MACHINE CONSTANTS FOR THE AMIGA                                    SLAP.........61600
C     ABSOFT FORTRAN COMPILER USING THE 68020/68881 COMPILER OPTION      SLAP.........61700
C                                                                        SLAP.........61800
C     DATA SMALL(1), SMALL(2) / Z'00100000', Z'00000000' /               SLAP.........61900
C     DATA LARGE(1), LARGE(2) / Z'7FEFFFFF', Z'FFFFFFFF' /               SLAP.........62000
C     DATA RIGHT(1), RIGHT(2) / Z'3CA00000', Z'00000000' /               SLAP.........62100
C     DATA DIVER(1), DIVER(2) / Z'3CB00000', Z'00000000' /               SLAP.........62200
C     DATA LOG10(1), LOG10(2) / Z'3FD34413', Z'509F79FF' /               SLAP.........62300
C                                                                        SLAP.........62400
C     MACHINE CONSTANTS FOR THE AMIGA                                    SLAP.........62500
C     ABSOFT FORTRAN COMPILER USING SOFTWARE FLOATING POINT              SLAP.........62600
C                                                                        SLAP.........62700
C     DATA SMALL(1), SMALL(2) / Z'00100000', Z'00000000' /               SLAP.........62800
C     DATA LARGE(1), LARGE(2) / Z'7FDFFFFF', Z'FFFFFFFF' /               SLAP.........62900
C     DATA RIGHT(1), RIGHT(2) / Z'3CA00000', Z'00000000' /               SLAP.........63000
C     DATA DIVER(1), DIVER(2) / Z'3CB00000', Z'00000000' /               SLAP.........63100
C     DATA LOG10(1), LOG10(2) / Z'3FD34413', Z'509F79FF' /               SLAP.........63200
C                                                                        SLAP.........63300
C     MACHINE CONSTANTS FOR THE APOLLO                                   SLAP.........63400
C                                                                        SLAP.........63500
C     DATA SMALL(1), SMALL(2) / 16#00100000, 16#00000000 /               SLAP.........63600
C     DATA LARGE(1), LARGE(2) / 16#7FFFFFFF, 16#FFFFFFFF /               SLAP.........63700
C     DATA RIGHT(1), RIGHT(2) / 16#3CA00000, 16#00000000 /               SLAP.........63800
C     DATA DIVER(1), DIVER(2) / 16#3CB00000, 16#00000000 /               SLAP.........63900
C     DATA LOG10(1), LOG10(2) / 16#3FD34413, 16#509F79FF /               SLAP.........64000
C                                                                        SLAP.........64100
C     MACHINE CONSTANTS FOR THE BURROUGHS 1700 SYSTEM                    SLAP.........64200
C                                                                        SLAP.........64300
C     DATA SMALL(1) / ZC00800000 /                                       SLAP.........64400
C     DATA SMALL(2) / Z000000000 /                                       SLAP.........64500
C     DATA LARGE(1) / ZDFFFFFFFF /                                       SLAP.........64600
C     DATA LARGE(2) / ZFFFFFFFFF /                                       SLAP.........64700
C     DATA RIGHT(1) / ZCC5800000 /                                       SLAP.........64800
C     DATA RIGHT(2) / Z000000000 /                                       SLAP.........64900
C     DATA DIVER(1) / ZCC6800000 /                                       SLAP.........65000
C     DATA DIVER(2) / Z000000000 /                                       SLAP.........65100
C     DATA LOG10(1) / ZD00E730E7 /                                       SLAP.........65200
C     DATA LOG10(2) / ZC77800DC0 /                                       SLAP.........65300
C                                                                        SLAP.........65400
C     MACHINE CONSTANTS FOR THE BURROUGHS 5700 SYSTEM                    SLAP.........65500
C                                                                        SLAP.........65600
C     DATA SMALL(1) / O1771000000000000 /                                SLAP.........65700
C     DATA SMALL(2) / O0000000000000000 /                                SLAP.........65800
C     DATA LARGE(1) / O0777777777777777 /                                SLAP.........65900
C     DATA LARGE(2) / O0007777777777777 /                                SLAP.........66000
C     DATA RIGHT(1) / O1461000000000000 /                                SLAP.........66100
C     DATA RIGHT(2) / O0000000000000000 /                                SLAP.........66200
C     DATA DIVER(1) / O1451000000000000 /                                SLAP.........66300
C     DATA DIVER(2) / O0000000000000000 /                                SLAP.........66400
C     DATA LOG10(1) / O1157163034761674 /                                SLAP.........66500
C     DATA LOG10(2) / O0006677466732724 /                                SLAP.........66600
C                                                                        SLAP.........66700
C     MACHINE CONSTANTS FOR THE BURROUGHS 6700/7700 SYSTEMS              SLAP.........66800
C                                                                        SLAP.........66900
C     DATA SMALL(1) / O1771000000000000 /                                SLAP.........67000
C     DATA SMALL(2) / O7770000000000000 /                                SLAP.........67100
C     DATA LARGE(1) / O0777777777777777 /                                SLAP.........67200
C     DATA LARGE(2) / O7777777777777777 /                                SLAP.........67300
C     DATA RIGHT(1) / O1461000000000000 /                                SLAP.........67400
C     DATA RIGHT(2) / O0000000000000000 /                                SLAP.........67500
C     DATA DIVER(1) / O1451000000000000 /                                SLAP.........67600
C     DATA DIVER(2) / O0000000000000000 /                                SLAP.........67700
C     DATA LOG10(1) / O1157163034761674 /                                SLAP.........67800
C     DATA LOG10(2) / O0006677466732724 /                                SLAP.........67900
C                                                                        SLAP.........68000
C     MACHINE CONSTANTS FOR THE CDC 170/180 SERIES USING NOS/VE          SLAP.........68100
C                                                                        SLAP.........68200
C     DATA SMALL(1) / Z"3001800000000000" /                              SLAP.........68300
C     DATA SMALL(2) / Z"3001000000000000" /                              SLAP.........68400
C     DATA LARGE(1) / Z"4FFEFFFFFFFFFFFE" /                              SLAP.........68500
C     DATA LARGE(2) / Z"4FFE000000000000" /                              SLAP.........68600
C     DATA RIGHT(1) / Z"3FD2800000000000" /                              SLAP.........68700
C     DATA RIGHT(2) / Z"3FD2000000000000" /                              SLAP.........68800
C     DATA DIVER(1) / Z"3FD3800000000000" /                              SLAP.........68900
C     DATA DIVER(2) / Z"3FD3000000000000" /                              SLAP.........69000
C     DATA LOG10(1) / Z"3FFF9A209A84FBCF" /                              SLAP.........69100
C     DATA LOG10(2) / Z"3FFFF7988F8959AC" /                              SLAP.........69200
C                                                                        SLAP.........69300
C     MACHINE CONSTANTS FOR THE CDC 6000/7000 SERIES                     SLAP.........69400
C                                                                        SLAP.........69500
C     DATA SMALL(1) / 00564000000000000000B /                            SLAP.........69600
C     DATA SMALL(2) / 00000000000000000000B /                            SLAP.........69700
C     DATA LARGE(1) / 37757777777777777777B /                            SLAP.........69800
C     DATA LARGE(2) / 37157777777777777777B /                            SLAP.........69900
C     DATA RIGHT(1) / 15624000000000000000B /                            SLAP.........70000
C     DATA RIGHT(2) / 00000000000000000000B /                            SLAP.........70100
C     DATA DIVER(1) / 15634000000000000000B /                            SLAP.........70200
C     DATA DIVER(2) / 00000000000000000000B /                            SLAP.........70300
C     DATA LOG10(1) / 17164642023241175717B /                            SLAP.........70400
C     DATA LOG10(2) / 16367571421742254654B /                            SLAP.........70500
C                                                                        SLAP.........70600
C     MACHINE CONSTANTS FOR THE CELERITY C1260                           SLAP.........70700
C                                                                        SLAP.........70800
C     DATA SMALL(1), SMALL(2) / Z'00100000', Z'00000000' /               SLAP.........70900
C     DATA LARGE(1), LARGE(2) / Z'7FEFFFFF', Z'FFFFFFFF' /               SLAP.........71000
C     DATA RIGHT(1), RIGHT(2) / Z'3CA00000', Z'00000000' /               SLAP.........71100
C     DATA DIVER(1), DIVER(2) / Z'3CB00000', Z'00000000' /               SLAP.........71200
C     DATA LOG10(1), LOG10(2) / Z'3FD34413', Z'509F79FF' /               SLAP.........71300
C                                                                        SLAP.........71400
C     MACHINE CONSTANTS FOR THE CONVEX                                   SLAP.........71500
C     USING THE -fn OR -pd8 COMPILER OPTION                              SLAP.........71600
C                                                                        SLAP.........71700
C     DATA DMACH(1) / Z'0010000000000000' /                              SLAP.........71800
C     DATA DMACH(2) / Z'7FFFFFFFFFFFFFFF' /                              SLAP.........71900
C     DATA DMACH(3) / Z'3CC0000000000000' /                              SLAP.........72000
C     DATA DMACH(4) / Z'3CD0000000000000' /                              SLAP.........72100
C     DATA DMACH(5) / Z'3FF34413509F79FF' /                              SLAP.........72200
C                                                                        SLAP.........72300
C     MACHINE CONSTANTS FOR THE CONVEX                                   SLAP.........72400
C     USING THE -fi COMPILER OPTION                                      SLAP.........72500
C                                                                        SLAP.........72600
C     DATA DMACH(1) / Z'0010000000000000' /                              SLAP.........72700
C     DATA DMACH(2) / Z'7FEFFFFFFFFFFFFF' /                              SLAP.........72800
C     DATA DMACH(3) / Z'3CA0000000000000' /                              SLAP.........72900
C     DATA DMACH(4) / Z'3CB0000000000000' /                              SLAP.........73000
C     DATA DMACH(5) / Z'3FD34413509F79FF' /                              SLAP.........73100
C                                                                        SLAP.........73200
C     MACHINE CONSTANTS FOR THE CONVEX                                   SLAP.........73300
C     USING THE -p8 COMPILER OPTION                                      SLAP.........73400
C                                                                        SLAP.........73500
C     DATA DMACH(1) / Z'00010000000000000000000000000000' /              SLAP.........73600
C     DATA DMACH(2) / Z'7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' /              SLAP.........73700
C     DATA DMACH(3) / Z'3F900000000000000000000000000000' /              SLAP.........73800
C     DATA DMACH(4) / Z'3F910000000000000000000000000000' /              SLAP.........73900
C     DATA DMACH(5) / Z'3FFF34413509F79FEF311F12B35816F9' /              SLAP.........74000
C                                                                        SLAP.........74100
C     MACHINE CONSTANTS FOR THE CRAY                                     SLAP.........74200
C                                                                        SLAP.........74300
C     DATA SMALL(1) / 201354000000000000000B /                           SLAP.........74400
C     DATA SMALL(2) / 000000000000000000000B /                           SLAP.........74500
C     DATA LARGE(1) / 577767777777777777777B /                           SLAP.........74600
C     DATA LARGE(2) / 000007777777777777774B /                           SLAP.........74700
C     DATA RIGHT(1) / 376434000000000000000B /                           SLAP.........74800
C     DATA RIGHT(2) / 000000000000000000000B /                           SLAP.........74900
C     DATA DIVER(1) / 376444000000000000000B /                           SLAP.........75000
C     DATA DIVER(2) / 000000000000000000000B /                           SLAP.........75100
C     DATA LOG10(1) / 377774642023241175717B /                           SLAP.........75200
C     DATA LOG10(2) / 000007571421742254654B /                           SLAP.........75300
C                                                                        SLAP.........75400
C     MACHINE CONSTANTS FOR THE DATA GENERAL ECLIPSE S/200               SLAP.........75500
C     NOTE - IT MAY BE APPROPRIATE TO INCLUDE THE FOLLOWING CARD -       SLAP.........75600
C     STATIC DMACH(5)                                                    SLAP.........75700
C                                                                        SLAP.........75800
C     DATA SMALL /    20K, 3*0 /                                         SLAP.........75900
C     DATA LARGE / 77777K, 3*177777K /                                   SLAP.........76000
C     DATA RIGHT / 31420K, 3*0 /                                         SLAP.........76100
C     DATA DIVER / 32020K, 3*0 /                                         SLAP.........76200
C     DATA LOG10 / 40423K, 42023K, 50237K, 74776K /                      SLAP.........76300
C                                                                        SLAP.........76400
C     MACHINE CONSTANTS FOR THE DEC ALPHA                                SLAP.........76500
C     USING G_FLOAT                                                      SLAP.........76600
C                                                                        SLAP.........76700
C     DATA DMACH(1) / '0000000000000010'X /                              SLAP.........76800
C     DATA DMACH(2) / 'FFFFFFFFFFFF7FFF'X /                              SLAP.........76900
C     DATA DMACH(3) / '0000000000003CC0'X /                              SLAP.........77000
C     DATA DMACH(4) / '0000000000003CD0'X /                              SLAP.........77100
C     DATA DMACH(5) / '79FF509F44133FF3'X /                              SLAP.........77200
C                                                                        SLAP.........77300
C     MACHINE CONSTANTS FOR THE DEC ALPHA                                SLAP.........77400
C     USING IEEE_FORMAT                                                  SLAP.........77500
C                                                                        SLAP.........77600
C     DATA DMACH(1) / '0010000000000000'X /                              SLAP.........77700
C     DATA DMACH(2) / '7FEFFFFFFFFFFFFF'X /                              SLAP.........77800
C     DATA DMACH(3) / '3CA0000000000000'X /                              SLAP.........77900
C     DATA DMACH(4) / '3CB0000000000000'X /                              SLAP.........78000
C     DATA DMACH(5) / '3FD34413509F79FF'X /                              SLAP.........78100
C                                                                        SLAP.........78200
C     MACHINE CONSTANTS FOR THE DEC RISC                                 SLAP.........78300
C                                                                        SLAP.........78400
C     DATA SMALL(1), SMALL(2) / Z'00000000', Z'00100000'/                SLAP.........78500
C     DATA LARGE(1), LARGE(2) / Z'FFFFFFFF', Z'7FEFFFFF'/                SLAP.........78600
C     DATA RIGHT(1), RIGHT(2) / Z'00000000', Z'3CA00000'/                SLAP.........78700
C     DATA DIVER(1), DIVER(2) / Z'00000000', Z'3CB00000'/                SLAP.........78800
C     DATA LOG10(1), LOG10(2) / Z'509F79FF', Z'3FD34413'/                SLAP.........78900
C                                                                        SLAP.........79000
C     MACHINE CONSTANTS FOR THE DEC VAX                                  SLAP.........79100
C     USING D_FLOATING                                                   SLAP.........79200
C     (EXPRESSED IN INTEGER AND HEXADECIMAL)                             SLAP.........79300
C     THE HEX FORMAT BELOW MAY NOT BE SUITABLE FOR UNIX SYSTEMS          SLAP.........79400
C     THE INTEGER FORMAT SHOULD BE OK FOR UNIX SYSTEMS                   SLAP.........79500
C                                                                        SLAP.........79600
C     DATA SMALL(1), SMALL(2) /        128,           0 /                SLAP.........79700
C     DATA LARGE(1), LARGE(2) /     -32769,          -1 /                SLAP.........79800
C     DATA RIGHT(1), RIGHT(2) /       9344,           0 /                SLAP.........79900
C     DATA DIVER(1), DIVER(2) /       9472,           0 /                SLAP.........80000
C     DATA LOG10(1), LOG10(2) /  546979738,  -805796613 /                SLAP.........80100
C                                                                        SLAP.........80200
C     DATA SMALL(1), SMALL(2) / Z00000080, Z00000000 /                   SLAP.........80300
C     DATA LARGE(1), LARGE(2) / ZFFFF7FFF, ZFFFFFFFF /                   SLAP.........80400
C     DATA RIGHT(1), RIGHT(2) / Z00002480, Z00000000 /                   SLAP.........80500
C     DATA DIVER(1), DIVER(2) / Z00002500, Z00000000 /                   SLAP.........80600
C     DATA LOG10(1), LOG10(2) / Z209A3F9A, ZCFF884FB /                   SLAP.........80700
C                                                                        SLAP.........80800
C     MACHINE CONSTANTS FOR THE DEC VAX                                  SLAP.........80900
C     USING G_FLOATING                                                   SLAP.........81000
C     (EXPRESSED IN INTEGER AND HEXADECIMAL)                             SLAP.........81100
C     THE HEX FORMAT BELOW MAY NOT BE SUITABLE FOR UNIX SYSTEMS          SLAP.........81200
C     THE INTEGER FORMAT SHOULD BE OK FOR UNIX SYSTEMS                   SLAP.........81300
C                                                                        SLAP.........81400
C     DATA SMALL(1), SMALL(2) /         16,           0 /                SLAP.........81500
C     DATA LARGE(1), LARGE(2) /     -32769,          -1 /                SLAP.........81600
C     DATA RIGHT(1), RIGHT(2) /      15552,           0 /                SLAP.........81700
C     DATA DIVER(1), DIVER(2) /      15568,           0 /                SLAP.........81800
C     DATA LOG10(1), LOG10(2) /  1142112243, 2046775455 /                SLAP.........81900
C                                                                        SLAP.........82000
C     DATA SMALL(1), SMALL(2) / Z00000010, Z00000000 /                   SLAP.........82100
C     DATA LARGE(1), LARGE(2) / ZFFFF7FFF, ZFFFFFFFF /                   SLAP.........82200
C     DATA RIGHT(1), RIGHT(2) / Z00003CC0, Z00000000 /                   SLAP.........82300
C     DATA DIVER(1), DIVER(2) / Z00003CD0, Z00000000 /                   SLAP.........82400
C     DATA LOG10(1), LOG10(2) / Z44133FF3, Z79FF509F /                   SLAP.........82500
C                                                                        SLAP.........82600
C     MACHINE CONSTANTS FOR THE ELXSI 6400                               SLAP.........82700
C     (ASSUMING REAL*8 IS THE DEFAULT DOUBLE PRECISION)                  SLAP.........82800
C                                                                        SLAP.........82900
C     DATA SMALL(1), SMALL(2) / '00100000'X,'00000000'X /                SLAP.........83000
C     DATA LARGE(1), LARGE(2) / '7FEFFFFF'X,'FFFFFFFF'X /                SLAP.........83100
C     DATA RIGHT(1), RIGHT(2) / '3CB00000'X,'00000000'X /                SLAP.........83200
C     DATA DIVER(1), DIVER(2) / '3CC00000'X,'00000000'X /                SLAP.........83300
C     DATA LOG10(1), LOG10(2) / '3FD34413'X,'509F79FF'X /                SLAP.........83400
C                                                                        SLAP.........83500
C     MACHINE CONSTANTS FOR THE HARRIS 220                               SLAP.........83600
C                                                                        SLAP.........83700
C     DATA SMALL(1), SMALL(2) / '20000000, '00000201 /                   SLAP.........83800
C     DATA LARGE(1), LARGE(2) / '37777777, '37777577 /                   SLAP.........83900
C     DATA RIGHT(1), RIGHT(2) / '20000000, '00000333 /                   SLAP.........84000
C     DATA DIVER(1), DIVER(2) / '20000000, '00000334 /                   SLAP.........84100
C     DATA LOG10(1), LOG10(2) / '23210115, '10237777 /                   SLAP.........84200
C                                                                        SLAP.........84300
C     MACHINE CONSTANTS FOR THE HONEYWELL 600/6000 SERIES                SLAP.........84400
C                                                                        SLAP.........84500
C     DATA SMALL(1), SMALL(2) / O402400000000, O000000000000 /           SLAP.........84600
C     DATA LARGE(1), LARGE(2) / O376777777777, O777777777777 /           SLAP.........84700
C     DATA RIGHT(1), RIGHT(2) / O604400000000, O000000000000 /           SLAP.........84800
C     DATA DIVER(1), DIVER(2) / O606400000000, O000000000000 /           SLAP.........84900
C     DATA LOG10(1), LOG10(2) / O776464202324, O117571775714 /           SLAP.........85000
C                                                                        SLAP.........85100
C     MACHINE CONSTANTS FOR THE HP 730                                   SLAP.........85200
C                                                                        SLAP.........85300
C     DATA DMACH(1) / Z'0010000000000000' /                              SLAP.........85400
C     DATA DMACH(2) / Z'7FEFFFFFFFFFFFFF' /                              SLAP.........85500
C     DATA DMACH(3) / Z'3CA0000000000000' /                              SLAP.........85600
C     DATA DMACH(4) / Z'3CB0000000000000' /                              SLAP.........85700
C     DATA DMACH(5) / Z'3FD34413509F79FF' /                              SLAP.........85800
C                                                                        SLAP.........85900
C     MACHINE CONSTANTS FOR THE HP 2100                                  SLAP.........86000
C     THREE WORD DOUBLE PRECISION OPTION WITH FTN4                       SLAP.........86100
C                                                                        SLAP.........86200
C     DATA SMALL(1), SMALL(2), SMALL(3) / 40000B,       0,       1 /     SLAP.........86300
C     DATA LARGE(1), LARGE(2), LARGE(3) / 77777B, 177777B, 177776B /     SLAP.........86400
C     DATA RIGHT(1), RIGHT(2), RIGHT(3) / 40000B,       0,    265B /     SLAP.........86500
C     DATA DIVER(1), DIVER(2), DIVER(3) / 40000B,       0,    276B /     SLAP.........86600
C     DATA LOG10(1), LOG10(2), LOG10(3) / 46420B,  46502B,  77777B /     SLAP.........86700
C                                                                        SLAP.........86800
C     MACHINE CONSTANTS FOR THE HP 2100                                  SLAP.........86900
C     FOUR WORD DOUBLE PRECISION OPTION WITH FTN4                        SLAP.........87000
C                                                                        SLAP.........87100
C     DATA SMALL(1), SMALL(2) /  40000B,       0 /                       SLAP.........87200
C     DATA SMALL(3), SMALL(4) /       0,       1 /                       SLAP.........87300
C     DATA LARGE(1), LARGE(2) /  77777B, 177777B /                       SLAP.........87400
C     DATA LARGE(3), LARGE(4) / 177777B, 177776B /                       SLAP.........87500
C     DATA RIGHT(1), RIGHT(2) /  40000B,       0 /                       SLAP.........87600
C     DATA RIGHT(3), RIGHT(4) /       0,    225B /                       SLAP.........87700
C     DATA DIVER(1), DIVER(2) /  40000B,       0 /                       SLAP.........87800
C     DATA DIVER(3), DIVER(4) /       0,    227B /                       SLAP.........87900
C     DATA LOG10(1), LOG10(2) /  46420B,  46502B /                       SLAP.........88000
C     DATA LOG10(3), LOG10(4) /  76747B, 176377B /                       SLAP.........88100
C                                                                        SLAP.........88200
C     MACHINE CONSTANTS FOR THE HP 9000                                  SLAP.........88300
C                                                                        SLAP.........88400
C     DATA SMALL(1), SMALL(2) / 00040000000B, 00000000000B /             SLAP.........88500
C     DATA LARGE(1), LARGE(2) / 17737777777B, 37777777777B /             SLAP.........88600
C     DATA RIGHT(1), RIGHT(2) / 07454000000B, 00000000000B /             SLAP.........88700
C     DATA DIVER(1), DIVER(2) / 07460000000B, 00000000000B /             SLAP.........88800
C     DATA LOG10(1), LOG10(2) / 07764642023B, 12047674777B /             SLAP.........88900
C                                                                        SLAP.........89000
C     MACHINE CONSTANTS FOR THE IBM 360/370 SERIES,                      SLAP.........89100
C     THE XEROX SIGMA 5/7/9, THE SEL SYSTEMS 85/86, AND                  SLAP.........89200
C     THE PERKIN ELMER (INTERDATA) 7/32.                                 SLAP.........89300
C                                                                        SLAP.........89400
C     DATA SMALL(1), SMALL(2) / Z00100000, Z00000000 /                   SLAP.........89500
C     DATA LARGE(1), LARGE(2) / Z7FFFFFFF, ZFFFFFFFF /                   SLAP.........89600
C     DATA RIGHT(1), RIGHT(2) / Z33100000, Z00000000 /                   SLAP.........89700
C     DATA DIVER(1), DIVER(2) / Z34100000, Z00000000 /                   SLAP.........89800
C     DATA LOG10(1), LOG10(2) / Z41134413, Z509F79FF /                   SLAP.........89900
C                                                                        SLAP.........90000
C     MACHINE CONSTANTS FOR THE IBM PC                                   SLAP.........90100
C     ASSUMES THAT ALL ARITHMETIC IS DONE IN DOUBLE PRECISION            SLAP.........90200
C     ON 8088, I.E., NOT IN 80 BIT FORM FOR THE 8087.                    SLAP.........90300
C                                                                        SLAP.........90400
C     DATA SMALL(1) / 2.23D-308  /                                       SLAP.........90500
C     DATA LARGE(1) / 1.79D+308  /                                       SLAP.........90600
C     DATA RIGHT(1) / 1.11D-16   /                                       SLAP.........90700
C     DATA DIVER(1) / 2.22D-16   /                                       SLAP.........90800
C     DATA LOG10(1) / 0.301029995663981195D0 /                           SLAP.........90900
C                                                                        SLAP.........91000
C     MACHINE CONSTANTS FOR THE IBM RS 6000                              SLAP.........91100
C                                                                        SLAP.........91200
C     DATA DMACH(1) / Z'0010000000000000' /                              SLAP.........91300
C     DATA DMACH(2) / Z'7FEFFFFFFFFFFFFF' /                              SLAP.........91400
C     DATA DMACH(3) / Z'3CA0000000000000' /                              SLAP.........91500
C     DATA DMACH(4) / Z'3CB0000000000000' /                              SLAP.........91600
C     DATA DMACH(5) / Z'3FD34413509F79FF' /                              SLAP.........91700
C                                                                        SLAP.........91800
C     MACHINE CONSTANTS FOR THE INTEL i860                               SLAP.........91900
C                                                                        SLAP.........92000
C     DATA DMACH(1) / Z'0010000000000000' /                              SLAP.........92100
C     DATA DMACH(2) / Z'7FEFFFFFFFFFFFFF' /                              SLAP.........92200
C     DATA DMACH(3) / Z'3CA0000000000000' /                              SLAP.........92300
C     DATA DMACH(4) / Z'3CB0000000000000' /                              SLAP.........92400
C     DATA DMACH(5) / Z'3FD34413509F79FF' /                              SLAP.........92500
C                                                                        SLAP.........92600
C     MACHINE CONSTANTS FOR THE PDP-10 (KA PROCESSOR)                    SLAP.........92700
C                                                                        SLAP.........92800
C     DATA SMALL(1), SMALL(2) / "033400000000, "000000000000 /           SLAP.........92900
C     DATA LARGE(1), LARGE(2) / "377777777777, "344777777777 /           SLAP.........93000
C     DATA RIGHT(1), RIGHT(2) / "113400000000, "000000000000 /           SLAP.........93100
C     DATA DIVER(1), DIVER(2) / "114400000000, "000000000000 /           SLAP.........93200
C     DATA LOG10(1), LOG10(2) / "177464202324, "144117571776 /           SLAP.........93300
C                                                                        SLAP.........93400
C     MACHINE CONSTANTS FOR THE PDP-10 (KI PROCESSOR)                    SLAP.........93500
C                                                                        SLAP.........93600
C     DATA SMALL(1), SMALL(2) / "000400000000, "000000000000 /           SLAP.........93700
C     DATA LARGE(1), LARGE(2) / "377777777777, "377777777777 /           SLAP.........93800
C     DATA RIGHT(1), RIGHT(2) / "103400000000, "000000000000 /           SLAP.........93900
C     DATA DIVER(1), DIVER(2) / "104400000000, "000000000000 /           SLAP.........94000
C     DATA LOG10(1), LOG10(2) / "177464202324, "476747767461 /           SLAP.........94100
C                                                                        SLAP.........94200
C     MACHINE CONSTANTS FOR PDP-11 FORTRAN SUPPORTING                    SLAP.........94300
C     32-BIT INTEGERS (EXPRESSED IN INTEGER AND OCTAL).                  SLAP.........94400
C                                                                        SLAP.........94500
C     DATA SMALL(1), SMALL(2) /    8388608,           0 /                SLAP.........94600
C     DATA LARGE(1), LARGE(2) / 2147483647,          -1 /                SLAP.........94700
C     DATA RIGHT(1), RIGHT(2) /  612368384,           0 /                SLAP.........94800
C     DATA DIVER(1), DIVER(2) /  620756992,           0 /                SLAP.........94900
C     DATA LOG10(1), LOG10(2) / 1067065498, -2063872008 /                SLAP.........95000
C                                                                        SLAP.........95100
C     DATA SMALL(1), SMALL(2) / O00040000000, O00000000000 /             SLAP.........95200
C     DATA LARGE(1), LARGE(2) / O17777777777, O37777777777 /             SLAP.........95300
C     DATA RIGHT(1), RIGHT(2) / O04440000000, O00000000000 /             SLAP.........95400
C     DATA DIVER(1), DIVER(2) / O04500000000, O00000000000 /             SLAP.........95500
C     DATA LOG10(1), LOG10(2) / O07746420232, O20476747770 /             SLAP.........95600
C                                                                        SLAP.........95700
C     MACHINE CONSTANTS FOR PDP-11 FORTRAN SUPPORTING                    SLAP.........95800
C     16-BIT INTEGERS (EXPRESSED IN INTEGER AND OCTAL).                  SLAP.........95900
C                                                                        SLAP.........96000
C     DATA SMALL(1), SMALL(2) /    128,      0 /                         SLAP.........96100
C     DATA SMALL(3), SMALL(4) /      0,      0 /                         SLAP.........96200
C     DATA LARGE(1), LARGE(2) /  32767,     -1 /                         SLAP.........96300
C     DATA LARGE(3), LARGE(4) /     -1,     -1 /                         SLAP.........96400
C     DATA RIGHT(1), RIGHT(2) /   9344,      0 /                         SLAP.........96500
C     DATA RIGHT(3), RIGHT(4) /      0,      0 /                         SLAP.........96600
C     DATA DIVER(1), DIVER(2) /   9472,      0 /                         SLAP.........96700
C     DATA DIVER(3), DIVER(4) /      0,      0 /                         SLAP.........96800
C     DATA LOG10(1), LOG10(2) /  16282,   8346 /                         SLAP.........96900
C     DATA LOG10(3), LOG10(4) / -31493, -12296 /                         SLAP.........97000
C                                                                        SLAP.........97100
C     DATA SMALL(1), SMALL(2) / O000200, O000000 /                       SLAP.........97200
C     DATA SMALL(3), SMALL(4) / O000000, O000000 /                       SLAP.........97300
C     DATA LARGE(1), LARGE(2) / O077777, O177777 /                       SLAP.........97400
C     DATA LARGE(3), LARGE(4) / O177777, O177777 /                       SLAP.........97500
C     DATA RIGHT(1), RIGHT(2) / O022200, O000000 /                       SLAP.........97600
C     DATA RIGHT(3), RIGHT(4) / O000000, O000000 /                       SLAP.........97700
C     DATA DIVER(1), DIVER(2) / O022400, O000000 /                       SLAP.........97800
C     DATA DIVER(3), DIVER(4) / O000000, O000000 /                       SLAP.........97900
C     DATA LOG10(1), LOG10(2) / O037632, O020232 /                       SLAP.........98000
C     DATA LOG10(3), LOG10(4) / O102373, O147770 /                       SLAP.........98100
C                                                                        SLAP.........98200
C     MACHINE CONSTANTS FOR THE SILICON GRAPHICS                         SLAP.........98300
C                                                                        SLAP.........98400
C     DATA SMALL(1), SMALL(2) / Z'00100000', Z'00000000' /               SLAP.........98500
C     DATA LARGE(1), LARGE(2) / Z'7FEFFFFF', Z'FFFFFFFF' /               SLAP.........98600
C     DATA RIGHT(1), RIGHT(2) / Z'3CA00000', Z'00000000' /               SLAP.........98700
C     DATA DIVER(1), DIVER(2) / Z'3CB00000', Z'00000000' /               SLAP.........98800
C     DATA LOG10(1), LOG10(2) / Z'3FD34413', Z'509F79FF' /               SLAP.........98900
C                                                                        SLAP.........99000
C     MACHINE CONSTANTS FOR THE SUN                                      SLAP.........99100
C                                                                        SLAP.........99200
C     DATA DMACH(1) / Z'0010000000000000' /                              SLAP.........99300
C     DATA DMACH(2) / Z'7FEFFFFFFFFFFFFF' /                              SLAP.........99400
C     DATA DMACH(3) / Z'3CA0000000000000' /                              SLAP.........99500
C     DATA DMACH(4) / Z'3CB0000000000000' /                              SLAP.........99600
C     DATA DMACH(5) / Z'3FD34413509F79FF' /                              SLAP.........99700
C                                                                        SLAP.........99800
C     MACHINE CONSTANTS FOR THE SUN                                      SLAP.........99900
C     USING THE -r8 COMPILER OPTION                                      SLAP........100000
C                                                                        SLAP........100100
C     DATA DMACH(1) / Z'00010000000000000000000000000000' /              SLAP........100200
C     DATA DMACH(2) / Z'7FFEFFFFFFFFFFFFFFFFFFFFFFFFFFFF' /              SLAP........100300
C     DATA DMACH(3) / Z'3F8E0000000000000000000000000000' /              SLAP........100400
C     DATA DMACH(4) / Z'3F8F0000000000000000000000000000' /              SLAP........100500
C     DATA DMACH(5) / Z'3FFD34413509F79FEF311F12B35816F9' /              SLAP........100600
C                                                                        SLAP........100700
C     MACHINE CONSTANTS FOR THE SUN 386i                                 SLAP........100800
C                                                                        SLAP........100900
C     DATA SMALL(1), SMALL(2) / Z'FFFFFFFD', Z'000FFFFF' /               SLAP........101000
C     DATA LARGE(1), LARGE(2) / Z'FFFFFFB0', Z'7FEFFFFF' /               SLAP........101100
C     DATA RIGHT(1), RIGHT(2) / Z'000000B0', Z'3CA00000' /               SLAP........101200
C     DATA DIVER(1), DIVER(2) / Z'FFFFFFCB', Z'3CAFFFFF'                 SLAP........101300
C     DATA LOG10(1), LOG10(2) / Z'509F79E9', Z'3FD34413' /               SLAP........101400
C                                                                        SLAP........101500
C     MACHINE CONSTANTS FOR THE UNIVAC 1100 SERIES FTN COMPILER          SLAP........101600
C                                                                        SLAP........101700
C     DATA SMALL(1), SMALL(2) / O000040000000, O000000000000 /           SLAP........101800
C     DATA LARGE(1), LARGE(2) / O377777777777, O777777777777 /           SLAP........101900
C     DATA RIGHT(1), RIGHT(2) / O170540000000, O000000000000 /           SLAP........102000
C     DATA DIVER(1), DIVER(2) / O170640000000, O000000000000 /           SLAP........102100
C     DATA LOG10(1), LOG10(2) / O177746420232, O411757177572 /           SLAP........102200
C                                                                        SLAP........102300
C.....GENERAL-PURPOSE VALUES INSERTED DURING INTEGRATION OF SLAP         SLAP........102400
C        WITH SUTRA. (ONLY SPECIFIED VALUES USED BY SLAP ROUTINES.       SLAP........102500
C        DMACH(2) IS NOT CRITICAL.)                                      SLAP........102600
C                                                                        SLAP........102700
      DATA DMACH(1) / 1.00D-200  /                                       SLAP........102800
      DATA DMACH(2) / 1.00D+200  /                                       SLAP........102900
      DATA DMACH(3) / 1.00D-16   /                                       SLAP........103000
C                                                                        SLAP........103100
C***FIRST EXECUTABLE STATEMENT  D1MACH                                   SLAP........103200
      IF (I .LT. 1 .OR. I .GT. 5) CALL XERMSG ('SLATEC', 'D1MACH',       SLAP........103300
     +   'I OUT OF BOUNDS', 1, 2)                                        SLAP........103400
C                                                                        SLAP........103500
      D1MACH = DMACH(I)                                                  SLAP........103600
      RETURN                                                             SLAP........103700
C                                                                        SLAP........103800
      END                                                                SLAP........103900
*DECK DAXPY                                                              SLAP........104000
      SUBROUTINE DAXPY (N, DA, DX, INCX, DY, INCY)                       SLAP........104100
C***BEGIN PROLOGUE  DAXPY                                                SLAP........104200
C***PURPOSE  Compute a constant times a vector plus a vector.            SLAP........104300
C***LIBRARY   SLATEC (BLAS)                                              SLAP........104400
C***CATEGORY  D1A7                                                       SLAP........104500
C***TYPE      DOUBLE PRECISION (SAXPY-S, DAXPY-D, CAXPY-C)               SLAP........104600
C***KEYWORDS  BLAS, LINEAR ALGEBRA, TRIAD, VECTOR                        SLAP........104700
C***AUTHOR  Lawson, C. L., (JPL)                                         SLAP........104800
C           Hanson, R. J., (SNLA)                                        SLAP........104900
C           Kincaid, D. R., (U. of Texas)                                SLAP........105000
C           Krogh, F. T., (JPL)                                          SLAP........105100
C***DESCRIPTION                                                          SLAP........105200
C                                                                        SLAP........105300
C                B L A S  Subprogram                                     SLAP........105400
C    Description of Parameters                                           SLAP........105500
C                                                                        SLAP........105600
C     --Input--                                                          SLAP........105700
C        N  number of elements in input vector(s)                        SLAP........105800
C       DA  double precision scalar multiplier                           SLAP........105900
C       DX  double precision vector with N elements                      SLAP........106000
C     INCX  storage spacing between elements of DX                       SLAP........106100
C       DY  double precision vector with N elements                      SLAP........106200
C     INCY  storage spacing between elements of DY                       SLAP........106300
C                                                                        SLAP........106400
C     --Output--                                                         SLAP........106500
C       DY  double precision result (unchanged if N .LE. 0)              SLAP........106600
C                                                                        SLAP........106700
C     Overwrite double precision DY with double precision DA*DX + DY.    SLAP........106800
C     For I = 0 to N-1, replace  DY(LY+I*INCY) with DA*DX(LX+I*INCX) +   SLAP........106900
C       DY(LY+I*INCY),                                                   SLAP........107000
C     where LX = 1 if INCX .GE. 0, else LX = 1+(1-N)*INCX, and LY is     SLAP........107100
C     defined in a similar way using INCY.                               SLAP........107200
C                                                                        SLAP........107300
C***REFERENCES  C. L. Lawson, R. J. Hanson, D. R. Kincaid and F. T.      SLAP........107400
C                 Krogh, Basic linear algebra subprograms for Fortran    SLAP........107500
C                 usage, Algorithm No. 539, Transactions on Mathematical SLAP........107600
C                 Software 5, 3 (September 1979), pp. 308-323.           SLAP........107700
C***ROUTINES CALLED  (NONE)                                              SLAP........107800
C***REVISION HISTORY  (YYMMDD)                                           SLAP........107900
C   791001  DATE WRITTEN                                                 SLAP........108000
C   890831  Modified array declarations.  (WRB)                          SLAP........108100
C   890831  REVISION DATE from Version 3.2                               SLAP........108200
C   891214  Prologue converted to Version 4.0 format.  (BAB)             SLAP........108300
C   920310  Corrected definition of LX in DESCRIPTION.  (WRB)            SLAP........108400
C   920501  Reformatted the REFERENCES section.  (WRB)                   SLAP........108500
C***END PROLOGUE  DAXPY                                                  SLAP........108600
      DOUBLE PRECISION DX(*), DY(*), DA                                  SLAP........108700
C***FIRST EXECUTABLE STATEMENT  DAXPY                                    SLAP........108800
      IF (N.LE.0 .OR. DA.EQ.0.0D0) RETURN                                SLAP........108900
      IF (INCX .EQ. INCY) IF (INCX-1) 5,20,60                            SLAP........109000
C                                                                        SLAP........109100
C     Code for unequal or nonpositive increments.                        SLAP........109200
C                                                                        SLAP........109300
    5 IX = 1                                                             SLAP........109400
      IY = 1                                                             SLAP........109500
      IF (INCX .LT. 0) IX = (-N+1)*INCX + 1                              SLAP........109600
      IF (INCY .LT. 0) IY = (-N+1)*INCY + 1                              SLAP........109700
      DO 10 I = 1,N                                                      SLAP........109800
        DY(IY) = DY(IY) + DA*DX(IX)                                      SLAP........109900
        IX = IX + INCX                                                   SLAP........110000
        IY = IY + INCY                                                   SLAP........110100
   10 CONTINUE                                                           SLAP........110200
      RETURN                                                             SLAP........110300
C                                                                        SLAP........110400
C     Code for both increments equal to 1.                               SLAP........110500
C                                                                        SLAP........110600
C     Clean-up loop so remaining vector length is a multiple of 4.       SLAP........110700
C                                                                        SLAP........110800
   20 M = MOD(N,4)                                                       SLAP........110900
      IF (M .EQ. 0) GO TO 40                                             SLAP........111000
      DO 30 I = 1,M                                                      SLAP........111100
        DY(I) = DY(I) + DA*DX(I)                                         SLAP........111200
   30 CONTINUE                                                           SLAP........111300
      IF (N .LT. 4) RETURN                                               SLAP........111400
   40 MP1 = M + 1                                                        SLAP........111500
      DO 50 I = MP1,N,4                                                  SLAP........111600
        DY(I) = DY(I) + DA*DX(I)                                         SLAP........111700
        DY(I+1) = DY(I+1) + DA*DX(I+1)                                   SLAP........111800
        DY(I+2) = DY(I+2) + DA*DX(I+2)                                   SLAP........111900
        DY(I+3) = DY(I+3) + DA*DX(I+3)                                   SLAP........112000
   50 CONTINUE                                                           SLAP........112100
      RETURN                                                             SLAP........112200
C                                                                        SLAP........112300
C     Code for equal, positive, non-unit increments.                     SLAP........112400
C                                                                        SLAP........112500
   60 NS = N*INCX                                                        SLAP........112600
      DO 70 I = 1,NS,INCX                                                SLAP........112700
        DY(I) = DA*DX(I) + DY(I)                                         SLAP........112800
   70 CONTINUE                                                           SLAP........112900
      RETURN                                                             SLAP........113000
      END                                                                SLAP........113100
*DECK DCG                                                                SLAP........113200
      SUBROUTINE DCG (N, B, X, NELT, IA, JA, A, ISYM, MATVEC, MSOLVE,    SLAP........113300
     +   ITOL, TOL, ITMAX, ITER, ERR, IERR, IUNIT, R, Z, P, DZ, RWORK,   SLAP........113400
     +   IWORK)                                                          SLAP........113500
C***BEGIN PROLOGUE  DCG                                                  SLAP........113600
C***PURPOSE  Preconditioned Conjugate Gradient Sparse Ax=b Solver.       SLAP........113700
C            Routine to solve a symmetric positive definite linear       SLAP........113800
C            system  Ax = b  using the Preconditioned Conjugate          SLAP........113900
C            Gradient method.                                            SLAP........114000
C***LIBRARY   SLATEC (SLAP)                                              SLAP........114100
C***CATEGORY  D2B4                                                       SLAP........114200
C***TYPE      DOUBLE PRECISION (SCG-S, DCG-D)                            SLAP........114300
C***KEYWORDS  ITERATIVE PRECONDITION, SLAP, SPARSE,                      SLAP........114400
C             SYMMETRIC LINEAR SYSTEM                                    SLAP........114500
C***AUTHOR  Greenbaum, Anne, (Courant Institute)                         SLAP........114600
C           Seager, Mark K., (LLNL)                                      SLAP........114700
C             Lawrence Livermore National Laboratory                     SLAP........114800
C             PO BOX 808, L-60                                           SLAP........114900
C             Livermore, CA 94550 (510) 423-3141                         SLAP........115000
C             seager@llnl.gov                                            SLAP........115100
C***DESCRIPTION                                                          SLAP........115200
C                                                                        SLAP........115300
C *Usage:                                                                SLAP........115400
C     INTEGER  N, NELT, IA(NELT), JA(NELT), ISYM, ITOL, ITMAX            SLAP........115500
C     INTEGER  ITER, IERR, IUNIT, IWORK(USER DEFINED)                    SLAP........115600
C     DOUBLE PRECISION B(N), X(N), A(NELT), TOL, ERR, R(N), Z(N)         SLAP........115700
C     DOUBLE PRECISION P(N), DZ(N), RWORK(USER DEFINED)                  SLAP........115800
C     EXTERNAL MATVEC, MSOLVE                                            SLAP........115900
C                                                                        SLAP........116000
C     CALL DCG(N, B, X, NELT, IA, JA, A, ISYM, MATVEC, MSOLVE,           SLAP........116100
C    $     ITOL, TOL, ITMAX, ITER, ERR, IERR, IUNIT, R, Z, P, DZ,        SLAP........116200
C    $     RWORK, IWORK )                                                SLAP........116300
C                                                                        SLAP........116400
C *Arguments:                                                            SLAP........116500
C N      :IN       Integer.                                              SLAP........116600
C         Order of the Matrix.                                           SLAP........116700
C B      :IN       Double Precision B(N).                                SLAP........116800
C         Right-hand side vector.                                        SLAP........116900
C X      :INOUT    Double Precision X(N).                                SLAP........117000
C         On input X is your initial guess for solution vector.          SLAP........117100
C         On output X is the final approximate solution.                 SLAP........117200
C NELT   :IN       Integer.                                              SLAP........117300
C         Number of Non-Zeros stored in A.                               SLAP........117400
C IA     :IN       Integer IA(NELT).                                     SLAP........117500
C JA     :IN       Integer JA(NELT).                                     SLAP........117600
C A      :IN       Double Precision A(NELT).                             SLAP........117700
C         These arrays contain the matrix data structure for A.          SLAP........117800
C         It could take any form.  See "Description", below,             SLAP........117900
C         for more details.                                              SLAP........118000
C ISYM   :IN       Integer.                                              SLAP........118100
C         Flag to indicate symmetric storage format.                     SLAP........118200
C         If ISYM=0, all non-zero entries of the matrix are stored.      SLAP........118300
C         If ISYM=1, the matrix is symmetric, and only the upper         SLAP........118400
C         or lower triangle of the matrix is stored.                     SLAP........118500
C MATVEC :EXT      External.                                             SLAP........118600
C         Name of a routine which performs the matrix vector multiply    SLAP........118700
C         Y = A*X given A and X.  The name of the MATVEC routine must    SLAP........118800
C         be declared external in the calling program.  The calling      SLAP........118900
C         sequence to MATVEC is:                                         SLAP........119000
C                                                                        SLAP........119100
C             CALL MATVEC( N, X, Y, NELT, IA, JA, A, ISYM )              SLAP........119200
C                                                                        SLAP........119300
C         Where N is the number of unknowns, Y is the product A*X        SLAP........119400
C         upon return X is an input vector, NELT is the number of        SLAP........119500
C         non-zeros in the SLAP IA, JA, A storage for the matrix A.      SLAP........119600
C         ISYM is a flag which, if non-zero, denotest that A is          SLAP........119700
C         symmetric and only the lower or upper triangle is stored.      SLAP........119800
C MSOLVE :EXT      External.                                             SLAP........119900
C         Name of a routine which solves a linear system MZ = R for      SLAP........120000
C         Z given R with the preconditioning matrix M (M is supplied via SLAP........120100
C         RWORK and IWORK arrays).  The name of the MSOLVE routine must  SLAP........120200
C         be declared external in the calling program.  The calling      SLAP........120300
C         sequence to MSOLVE is:                                         SLAP........120400
C                                                                        SLAP........120500
C             CALL MSOLVE(N, R, Z, NELT, IA, JA, A, ISYM, RWORK, IWORK)  SLAP........120600
C                                                                        SLAP........120700
C         Where N is the number of unknowns, R is the right-hand side    SLAP........120800
C         vector and Z is the solution upon return.  NELT, IA, JA, A and SLAP........120900
C         ISYM are defined as above.  RWORK is a double precision array  SLAP........121000
C         that can be used to pass necessary preconditioning information SLAP........121100
C         and/or workspace to MSOLVE.  IWORK is an integer work array    SLAP........121200
C         for the same purpose as RWORK.                                 SLAP........121300
C ITOL   :IN       Integer.                                              SLAP........121400
C         Flag to indicate type of convergence criterion.                SLAP........121500
C         If ITOL=1, iteration stops when the 2-norm of the residual     SLAP........121600
C         divided by the 2-norm of the right-hand side is less than TOL. SLAP........121700
C         If ITOL=2, iteration stops when the 2-norm of M-inv times the  SLAP........121800
C         residual divided by the 2-norm of M-inv times the right hand   SLAP........121900
C         side is less than TOL, where M-inv is the inverse of the       SLAP........122000
C         diagonal of A.                                                 SLAP........122100
C         ITOL=11 is often useful for checking and comparing different   SLAP........122200
C         routines.  For this case, the user must supply the "exact"     SLAP........122300
C         solution or a very accurate approximation (one with an error   SLAP........122400
C         much less than TOL) through a common block,                    SLAP........122500
C             COMMON /DSLBLK/ SOLN( )                                    SLAP........122600
C         If ITOL=11, iteration stops when the 2-norm of the difference  SLAP........122700
C         between the iterative approximation and the user-supplied      SLAP........122800
C         solution divided by the 2-norm of the user-supplied solution   SLAP........122900
C         is less than TOL.  Note that this requires the user to set up  SLAP........123000
C         the "COMMON /DSLBLK/ SOLN(LENGTH)" in the calling routine.     SLAP........123100
C         The routine with this declaration should be loaded before the  SLAP........123200
C         stop test so that the correct length is used by the loader.    SLAP........123300
C         This procedure is not standard Fortran and may not work        SLAP........123400
C         correctly on your system (although it has worked on every      SLAP........123500
C         system the authors have tried).  If ITOL is not 11 then this   SLAP........123600
C         common block is indeed standard Fortran.                       SLAP........123700
C TOL    :INOUT    Double Precision.                                     SLAP........123800
C         Convergence criterion, as described above.  (Reset if IERR=4.) SLAP........123900
C ITMAX  :IN       Integer.                                              SLAP........124000
C         Maximum number of iterations.                                  SLAP........124100
C ITER   :OUT      Integer.                                              SLAP........124200
C         Number of iterations required to reach convergence, or         SLAP........124300
C         ITMAX+1 if convergence criterion could not be achieved in      SLAP........124400
C         ITMAX iterations.                                              SLAP........124500
C ERR    :OUT      Double Precision.                                     SLAP........124600
C         Error estimate of error in final approximate solution, as      SLAP........124700
C         defined by ITOL.                                               SLAP........124800
C IERR   :OUT      Integer.                                              SLAP........124900
C         Return error flag.                                             SLAP........125000
C           IERR = 0 => All went well.                                   SLAP........125100
C           IERR = 1 => Insufficient space allocated for WORK or IWORK.  SLAP........125200
C           IERR = 2 => Method failed to converge in ITMAX steps.        SLAP........125300
C           IERR = 3 => Error in user input.                             SLAP........125400
C                       Check input values of N, ITOL.                   SLAP........125500
C           IERR = 4 => User error tolerance set too tight.              SLAP........125600
C                       Reset to 500*D1MACH(3).  Iteration proceeded.    SLAP........125700
C           IERR = 5 => Preconditioning matrix, M, is not positive       SLAP........125800
C                       definite.  (r,z) < 0.                            SLAP........125900
C           IERR = 6 => Matrix A is not positive definite.  (p,Ap) < 0.  SLAP........126000
C IUNIT  :IN       Integer.                                              SLAP........126100
C         Unit number on which to write the error at each iteration,     SLAP........126200
C         if this is desired for monitoring convergence.  If unit        SLAP........126300
C         number is 0, no writing will occur.                            SLAP........126400
C R      :WORK     Double Precision R(N).                                SLAP........126500
C Z      :WORK     Double Precision Z(N).                                SLAP........126600
C P      :WORK     Double Precision P(N).                                SLAP........126700
C DZ     :WORK     Double Precision DZ(N).                               SLAP........126800
C         Double Precision arrays used for workspace.                    SLAP........126900
C RWORK  :WORK     Double Precision RWORK(USER DEFINED).                 SLAP........127000
C         Double Precision array that can be used by  MSOLVE.            SLAP........127100
C IWORK  :WORK     Integer IWORK(USER DEFINED).                          SLAP........127200
C         Integer array that can be used by  MSOLVE.                     SLAP........127300
C                                                                        SLAP........127400
C *Description                                                           SLAP........127500
C       This routine does  not care  what matrix data   structure is     SLAP........127600
C       used for  A and M.  It simply   calls  the MATVEC and MSOLVE     SLAP........127700
C       routines, with  the arguments as  described above.  The user     SLAP........127800
C       could write any type of structure and the appropriate MATVEC     SLAP........127900
C       and MSOLVE routines.  It is assumed  that A is stored in the     SLAP........128000
C       IA, JA, A  arrays in some fashion and  that M (or INV(M)) is     SLAP........128100
C       stored  in  IWORK  and  RWORK   in  some fashion.   The SLAP     SLAP........128200
C       routines DSDCG and DSICCG are examples of this procedure.        SLAP........128300
C                                                                        SLAP........128400
C       Two  examples  of  matrix  data structures  are the: 1) SLAP     SLAP........128500
C       Triad  format and 2) SLAP Column format.                         SLAP........128600
C                                                                        SLAP........128700
C       =================== S L A P Triad format ===================     SLAP........128800
C                                                                        SLAP........128900
C       In  this   format only the  non-zeros are  stored.  They may     SLAP........129000
C       appear  in *ANY* order.   The user  supplies three arrays of     SLAP........129100
C       length NELT, where  NELT  is the number  of non-zeros in the     SLAP........129200
C       matrix:  (IA(NELT), JA(NELT),  A(NELT)).  For each  non-zero     SLAP........129300
C       the  user puts   the row  and  column index   of that matrix     SLAP........129400
C       element in the IA and JA arrays.  The  value of the non-zero     SLAP........129500
C       matrix  element is  placed in  the corresponding location of     SLAP........129600
C       the A  array.  This is  an extremely easy data  structure to     SLAP........129700
C       generate.  On  the other hand it  is  not too  efficient  on     SLAP........129800
C       vector  computers   for the  iterative  solution  of  linear     SLAP........129900
C       systems.  Hence, SLAP  changes this input  data structure to     SLAP........130000
C       the SLAP   Column  format for the  iteration (but   does not     SLAP........130100
C       change it back).                                                 SLAP........130200
C                                                                        SLAP........130300
C       Here is an example of the  SLAP Triad   storage format for a     SLAP........130400
C       5x5 Matrix.  Recall that the entries may appear in any order.    SLAP........130500
C                                                                        SLAP........130600
C           5x5 Matrix      SLAP Triad format for 5x5 matrix on left.    SLAP........130700
C                              1  2  3  4  5  6  7  8  9 10 11           SLAP........130800
C       |11 12  0  0 15|   A: 51 12 11 33 15 53 55 22 35 44 21           SLAP........130900
C       |21 22  0  0  0|  IA:  5  1  1  3  1  5  5  2  3  4  2           SLAP........131000
C       | 0  0 33  0 35|  JA:  1  2  1  3  5  3  5  2  5  4  1           SLAP........131100
C       | 0  0  0 44  0|                                                 SLAP........131200
C       |51  0 53  0 55|                                                 SLAP........131300
C                                                                        SLAP........131400
C       =================== S L A P Column format ==================     SLAP........131500
C                                                                        SLAP........131600
C       In  this format   the non-zeros are    stored counting  down     SLAP........131700
C       columns (except  for the diagonal  entry, which must  appear     SLAP........131800
C       first  in each "column") and are  stored in the  double pre-     SLAP........131900
C       cision array  A. In  other  words,  for each  column  in the     SLAP........132000
C       matrix  first put  the diagonal entry in A.  Then put in the     SLAP........132100
C       other non-zero  elements going  down the column  (except the     SLAP........132200
C       diagonal)  in order.  The IA array  holds the  row index for     SLAP........132300
C       each non-zero.  The JA array  holds the offsets into the IA,     SLAP........132400
C       A  arrays  for  the  beginning  of  each  column.  That  is,     SLAP........132500
C       IA(JA(ICOL)),A(JA(ICOL)) are the first elements of the ICOL-     SLAP........132600
C       th column in IA and A, and IA(JA(ICOL+1)-1), A(JA(ICOL+1)-1)     SLAP........132700
C       are  the last elements of the ICOL-th column.   Note that we     SLAP........132800
C       always have JA(N+1)=NELT+1, where N is the number of columns     SLAP........132900
C       in the matrix  and NELT  is the number  of non-zeros  in the     SLAP........133000
C       matrix.                                                          SLAP........133100
C                                                                        SLAP........133200
C       Here is an example of the  SLAP Column  storage format for a     SLAP........133300
C       5x5 Matrix (in the A and IA arrays '|'  denotes the end of a     SLAP........133400
C       column):                                                         SLAP........133500
C                                                                        SLAP........133600
C           5x5 Matrix      SLAP Column format for 5x5 matrix on left.   SLAP........133700
C                              1  2  3    4  5    6  7    8    9 10 11   SLAP........133800
C       |11 12  0  0 15|   A: 11 21 51 | 22 12 | 33 53 | 44 | 55 15 35   SLAP........133900
C       |21 22  0  0  0|  IA:  1  2  5 |  2  1 |  3  5 |  4 |  5  1  3   SLAP........134000
C       | 0  0 33  0 35|  JA:  1  4  6    8  9   12                      SLAP........134100
C       | 0  0  0 44  0|                                                 SLAP........134200
C       |51  0 53  0 55|                                                 SLAP........134300
C                                                                        SLAP........134400
C *Cautions:                                                             SLAP........134500
C     This routine will attempt to write to the Fortran logical output   SLAP........134600
C     unit IUNIT, if IUNIT .ne. 0.  Thus, the user must make sure that   SLAP........134700
C     this logical unit is attached to a file or terminal before calling SLAP........134800
C     this routine with a non-zero value for IUNIT.  This routine does   SLAP........134900
C     not check for the validity of a non-zero IUNIT unit number.        SLAP........135000
C                                                                        SLAP........135100
C***SEE ALSO  DSDCG, DSICCG                                              SLAP........135200
C***REFERENCES  1. Louis Hageman and David Young, Applied Iterative      SLAP........135300
C                  Methods, Academic Press, New York, 1981.              SLAP........135400
C               2. Concus, Golub and O'Leary, A Generalized Conjugate    SLAP........135500
C                  Gradient Method for the Numerical Solution of         SLAP........135600
C                  Elliptic Partial Differential Equations, in Sparse    SLAP........135700
C                  Matrix Computations, Bunch and Rose, Eds., Academic   SLAP........135800
C                  Press, New York, 1979.                                SLAP........135900
C               3. Mark K. Seager, A SLAP for the Masses, in             SLAP........136000
C                  G. F. Carey, Ed., Parallel Supercomputing: Methods,   SLAP........136100
C                  Algorithms and Applications, Wiley, 1989, pp.135-155. SLAP........136200
C***ROUTINES CALLED  D1MACH, DAXPY, DCOPY, DDOT, ISDCG                   SLAP........136300
C***REVISION HISTORY  (YYMMDD)                                           SLAP........136400
C   890404  DATE WRITTEN                                                 SLAP........136500
C   890404  Previous REVISION DATE                                       SLAP........136600
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........136700
C   890921  Removed TeX from comments.  (FNF)                            SLAP........136800
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........136900
C           standard.  (FNF)                                             SLAP........137000
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........137100
C   891004  Added new reference.                                         SLAP........137200
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........137300
C   910502  Removed MATVEC and MSOLVE from ROUTINES CALLED list.  (FNF)  SLAP........137400
C   920407  COMMON BLOCK renamed DSLBLK.  (WRB)                          SLAP........137500
C   920511  Added complete declaration section.  (WRB)                   SLAP........137600
C   920929  Corrected format of references.  (FNF)                       SLAP........137700
C   921019  Changed 500.0 to 500 to reduce SP/DP differences.  (FNF)     SLAP........137800
C***END PROLOGUE  DCG                                                    SLAP........137900
C     .. Scalar Arguments ..                                             SLAP........138000
      DOUBLE PRECISION ERR, TOL                                          SLAP........138100
      INTEGER IERR, ISYM, ITER, ITMAX, ITOL, IUNIT, N, NELT              SLAP........138200
C     .. Array Arguments ..                                              SLAP........138300
      DOUBLE PRECISION A(NELT), B(N), DZ(N), P(N), R(N), RWORK(*), X(N), SLAP........138400
     +                 Z(N)                                              SLAP........138500
      INTEGER IA(NELT), IWORK(*), JA(NELT)                               SLAP........138600
C     .. Subroutine Arguments ..                                         SLAP........138700
      EXTERNAL MATVEC, MSOLVE                                            SLAP........138800
C     .. Local Scalars ..                                                SLAP........138900
      DOUBLE PRECISION AK, AKDEN, BK, BKDEN, BKNUM, BNRM, SOLNRM, TOLMIN SLAP........139000
      INTEGER I, K                                                       SLAP........139100
C     .. External Functions ..                                           SLAP........139200
      DOUBLE PRECISION D1MACH, DDOT                                      SLAP........139300
      INTEGER ISDCG                                                      SLAP........139400
      EXTERNAL D1MACH, DDOT, ISDCG                                       SLAP........139500
C     .. External Subroutines ..                                         SLAP........139600
      EXTERNAL DAXPY, DCOPY                                              SLAP........139700
C***FIRST EXECUTABLE STATEMENT  DCG                                      SLAP........139800
C                                                                        SLAP........139900
C         Check some of the input data.                                  SLAP........140000
C                                                                        SLAP........140100
      ITER = 0                                                           SLAP........140200
      IERR = 0                                                           SLAP........140300
      IF( N.LT.1 ) THEN                                                  SLAP........140400
         IERR = 3                                                        SLAP........140500
         RETURN                                                          SLAP........140600
      ENDIF                                                              SLAP........140700
      TOLMIN = 500*D1MACH(3)                                             SLAP........140800
      IF( TOL.LT.TOLMIN ) THEN                                           SLAP........140900
         TOL = TOLMIN                                                    SLAP........141000
         IERR = 4                                                        SLAP........141100
      ENDIF                                                              SLAP........141200
C                                                                        SLAP........141300
C         Calculate initial residual and pseudo-residual, and check      SLAP........141400
C         stopping criterion.                                            SLAP........141500
      CALL MATVEC(N, X, R, NELT, IA, JA, A, ISYM)                        SLAP........141600
      DO 10 I = 1, N                                                     SLAP........141700
         R(I) = B(I) - R(I)                                              SLAP........141800
 10   CONTINUE                                                           SLAP........141900
      CALL MSOLVE(N, R, Z, NELT, IA, JA, A, ISYM, RWORK, IWORK)          SLAP........142000
C                                                                        SLAP........142100
      IF( ISDCG(N, B, X, NELT, IA, JA, A, ISYM, MSOLVE, ITOL, TOL,       SLAP........142200
     $     ITMAX, ITER, ERR, IERR, IUNIT, R, Z, P, DZ,                   SLAP........142300
     $     RWORK, IWORK, AK, BK, BNRM, SOLNRM) .NE. 0 ) GO TO 200        SLAP........142400
      IF( IERR.NE.0 ) RETURN                                             SLAP........142500
C                                                                        SLAP........142600
C         ***** Iteration loop *****                                     SLAP........142700
C                                                                        SLAP........142800
      DO 100 K=1,ITMAX                                                   SLAP........142900
         ITER = K                                                        SLAP........143000
C                                                                        SLAP........143100
C         Calculate coefficient bk and direction vector p.               SLAP........143200
         BKNUM = DDOT(N, Z, 1, R, 1)                                     SLAP........143300
         IF( BKNUM.LE.0.0D0 ) THEN                                       SLAP........143400
            IERR = 5                                                     SLAP........143500
            RETURN                                                       SLAP........143600
         ENDIF                                                           SLAP........143700
         IF(ITER .EQ. 1) THEN                                            SLAP........143800
            CALL DCOPY(N, Z, 1, P, 1)                                    SLAP........143900
         ELSE                                                            SLAP........144000
            BK = BKNUM/BKDEN                                             SLAP........144100
            DO 20 I = 1, N                                               SLAP........144200
               P(I) = Z(I) + BK*P(I)                                     SLAP........144300
 20         CONTINUE                                                     SLAP........144400
         ENDIF                                                           SLAP........144500
         BKDEN = BKNUM                                                   SLAP........144600
C                                                                        SLAP........144700
C         Calculate coefficient ak, new iterate x, new residual r,       SLAP........144800
C         and new pseudo-residual z.                                     SLAP........144900
         CALL MATVEC(N, P, Z, NELT, IA, JA, A, ISYM)                     SLAP........145000
         AKDEN = DDOT(N, P, 1, Z, 1)                                     SLAP........145100
         IF( AKDEN.LE.0.0D0 ) THEN                                       SLAP........145200
            IERR = 6                                                     SLAP........145300
            RETURN                                                       SLAP........145400
         ENDIF                                                           SLAP........145500
         AK = BKNUM/AKDEN                                                SLAP........145600
         CALL DAXPY(N, AK, P, 1, X, 1)                                   SLAP........145700
         CALL DAXPY(N, -AK, Z, 1, R, 1)                                  SLAP........145800
         CALL MSOLVE(N, R, Z, NELT, IA, JA, A, ISYM, RWORK, IWORK)       SLAP........145900
C                                                                        SLAP........146000
C         check stopping criterion.                                      SLAP........146100
         IF( ISDCG(N, B, X, NELT, IA, JA, A, ISYM, MSOLVE, ITOL, TOL,    SLAP........146200
     $        ITMAX, ITER, ERR, IERR, IUNIT, R, Z, P, DZ, RWORK,         SLAP........146300
     $        IWORK, AK, BK, BNRM, SOLNRM) .NE. 0 ) GO TO 200            SLAP........146400
C                                                                        SLAP........146500
 100  CONTINUE                                                           SLAP........146600
C                                                                        SLAP........146700
C         *****   end of loop  *****                                     SLAP........146800
C                                                                        SLAP........146900
C         stopping criterion not satisfied.                              SLAP........147000
      ITER = ITMAX + 1                                                   SLAP........147100
      IERR = 2                                                           SLAP........147200
C                                                                        SLAP........147300
 200  RETURN                                                             SLAP........147400
C------------- LAST LINE OF DCG FOLLOWS -----------------------------    SLAP........147500
      END                                                                SLAP........147600
*DECK DCHKW                                                              SLAP........147700
      SUBROUTINE DCHKW (NAME, LOCIW, LENIW, LOCW, LENW, IERR, ITER, ERR) SLAP........147800
C***BEGIN PROLOGUE  DCHKW                                                SLAP........147900
C***SUBSIDIARY                                                           SLAP........148000
C***PURPOSE  SLAP WORK/IWORK Array Bounds Checker.                       SLAP........148100
C            This routine checks the work array lengths and interfaces   SLAP........148200
C            to the SLATEC error handler if a problem is found.          SLAP........148300
C***LIBRARY   SLATEC (SLAP)                                              SLAP........148400
C***CATEGORY  R2                                                         SLAP........148500
C***TYPE      DOUBLE PRECISION (SCHKW-S, DCHKW-D)                        SLAP........148600
C***KEYWORDS  ERROR CHECKING, SLAP, WORKSPACE CHECKING                   SLAP........148700
C***AUTHOR  Seager, Mark K., (LLNL)                                      SLAP........148800
C             Lawrence Livermore National Laboratory                     SLAP........148900
C             PO BOX 808, L-60                                           SLAP........149000
C             Livermore, CA 94550 (510) 423-3141                         SLAP........149100
C             seager@llnl.gov                                            SLAP........149200
C***DESCRIPTION                                                          SLAP........149300
C                                                                        SLAP........149400
C *Usage:                                                                SLAP........149500
C     CHARACTER*(*) NAME                                                 SLAP........149600
C     INTEGER LOCIW, LENIW, LOCW, LENW, IERR, ITER                       SLAP........149700
C     DOUBLE PRECISION ERR                                               SLAP........149800
C                                                                        SLAP........149900
C     CALL DCHKW( NAME, LOCIW, LENIW, LOCW, LENW, IERR, ITER, ERR )      SLAP........150000
C                                                                        SLAP........150100
C *Arguments:                                                            SLAP........150200
C NAME   :IN       Character*(*).                                        SLAP........150300
C         Name of the calling routine.  This is used in the output       SLAP........150400
C         message, if an error is detected.                              SLAP........150500
C LOCIW  :IN       Integer.                                              SLAP........150600
C         Location of the first free element in the integer workspace    SLAP........150700
C         array.                                                         SLAP........150800
C LENIW  :IN       Integer.                                              SLAP........150900
C         Length of the integer workspace array.                         SLAP........151000
C LOCW   :IN       Integer.                                              SLAP........151100
C         Location of the first free element in the double precision     SLAP........151200
C         workspace array.                                               SLAP........151300
C LENRW  :IN       Integer.                                              SLAP........151400
C         Length of the double precision workspace array.                SLAP........151500
C IERR   :OUT      Integer.                                              SLAP........151600
C         Return error flag.                                             SLAP........151700
C               IERR = 0 => All went well.                               SLAP........151800
C               IERR = 1 => Insufficient storage allocated for           SLAP........151900
C                           WORK or IWORK.                               SLAP........152000
C ITER   :OUT      Integer.                                              SLAP........152100
C         Set to zero on return.                                         SLAP........152200
C ERR    :OUT      Double Precision.                                     SLAP........152300
C         Set to the smallest positive magnitude if all went well.       SLAP........152400
C         Set to a very large number if an error is detected.            SLAP........152500
C                                                                        SLAP........152600
C***REFERENCES  (NONE)                                                   SLAP........152700
C***ROUTINES CALLED  D1MACH, XERMSG                                      SLAP........152800
C***REVISION HISTORY  (YYMMDD)                                           SLAP........152900
C   880225  DATE WRITTEN                                                 SLAP........153000
C   881213  Previous REVISION DATE                                       SLAP........153100
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........153200
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........153300
C           standard.  (FNF)                                             SLAP........153400
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........153500
C   900805  Changed XERRWV calls to calls to XERMSG.  (RWC)              SLAP........153600
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........153700
C   910502  Corrected XERMSG calls to satisfy Section 6.2.2 of ANSI      SLAP........153800
C           X3.9-1978.  (FNF)                                            SLAP........153900
C   910506  Made subsidiary.  (FNF)                                      SLAP........154000
C   920511  Added complete declaration section.  (WRB)                   SLAP........154100
C   921015  Added code to initialize ITER and ERR when IERR=0.  (FNF)    SLAP........154200
C***END PROLOGUE  DCHKW                                                  SLAP........154300
C     .. Scalar Arguments ..                                             SLAP........154400
      DOUBLE PRECISION ERR                                               SLAP........154500
      INTEGER IERR, ITER, LENIW, LENW, LOCIW, LOCW                       SLAP........154600
      CHARACTER NAME*(*)                                                 SLAP........154700
C     .. Local Scalars ..                                                SLAP........154800
      CHARACTER XERN1*8, XERN2*8, XERNAM*8                               SLAP........154900
C     .. External Functions ..                                           SLAP........155000
      DOUBLE PRECISION D1MACH                                            SLAP........155100
      EXTERNAL D1MACH                                                    SLAP........155200
C     .. External Subroutines ..                                         SLAP........155300
      EXTERNAL XERMSG                                                    SLAP........155400
C***FIRST EXECUTABLE STATEMENT  DCHKW                                    SLAP........155500
C                                                                        SLAP........155600
C         Check the Integer workspace situation.                         SLAP........155700
C                                                                        SLAP........155800
      IERR = 0                                                           SLAP........155900
      ITER = 0                                                           SLAP........156000
      ERR = D1MACH(1)                                                    SLAP........156100
      IF( LOCIW.GT.LENIW ) THEN                                          SLAP........156200
         IERR = 1                                                        SLAP........156300
         ERR = D1MACH(2)                                                 SLAP........156400
         XERNAM = NAME                                                   SLAP........156500
         WRITE (XERN1, '(I8)') LOCIW                                     SLAP........156600
         WRITE (XERN2, '(I8)') LENIW                                     SLAP........156700
         CALL XERMSG ('SLATEC', 'DCHKW',                                 SLAP........156800
     $      'In ' // XERNAM // ', INTEGER work array too short.  ' //    SLAP........156900
     $      'IWORK needs ' // XERN1 // '; have allocated ' // XERN2,     SLAP........157000
     $      1, 1)                                                        SLAP........157100
      ENDIF                                                              SLAP........157200
C                                                                        SLAP........157300
C         Check the Double Precision workspace situation.                SLAP........157400
      IF( LOCW.GT.LENW ) THEN                                            SLAP........157500
         IERR = 1                                                        SLAP........157600
         ERR = D1MACH(2)                                                 SLAP........157700
         XERNAM = NAME                                                   SLAP........157800
         WRITE (XERN1, '(I8)') LOCW                                      SLAP........157900
         WRITE (XERN2, '(I8)') LENW                                      SLAP........158000
         CALL XERMSG ('SLATEC', 'DCHKW',                                 SLAP........158100
     $      'In ' // XERNAM // ', DOUBLE PRECISION work array too ' //   SLAP........158200
     $      'short.  RWORK needs ' // XERN1 // '; have allocated ' //    SLAP........158300
     $      XERN2, 1, 1)                                                 SLAP........158400
      ENDIF                                                              SLAP........158500
      RETURN                                                             SLAP........158600
C------------- LAST LINE OF DCHKW FOLLOWS ----------------------------   SLAP........158700
      END                                                                SLAP........158800
*DECK DCOPY                                                              SLAP........158900
      SUBROUTINE DCOPY (N, DX, INCX, DY, INCY)                           SLAP........159000
C***BEGIN PROLOGUE  DCOPY                                                SLAP........159100
C***PURPOSE  Copy a vector.                                              SLAP........159200
C***LIBRARY   SLATEC (BLAS)                                              SLAP........159300
C***CATEGORY  D1A5                                                       SLAP........159400
C***TYPE      DOUBLE PRECISION (SCOPY-S, DCOPY-D, CCOPY-C, ICOPY-I)      SLAP........159500
C***KEYWORDS  BLAS, COPY, LINEAR ALGEBRA, VECTOR                         SLAP........159600
C***AUTHOR  Lawson, C. L., (JPL)                                         SLAP........159700
C           Hanson, R. J., (SNLA)                                        SLAP........159800
C           Kincaid, D. R., (U. of Texas)                                SLAP........159900
C           Krogh, F. T., (JPL)                                          SLAP........160000
C***DESCRIPTION                                                          SLAP........160100
C                                                                        SLAP........160200
C                B L A S  Subprogram                                     SLAP........160300
C    Description of Parameters                                           SLAP........160400
C                                                                        SLAP........160500
C     --Input--                                                          SLAP........160600
C        N  number of elements in input vector(s)                        SLAP........160700
C       DX  double precision vector with N elements                      SLAP........160800
C     INCX  storage spacing between elements of DX                       SLAP........160900
C       DY  double precision vector with N elements                      SLAP........161000
C     INCY  storage spacing between elements of DY                       SLAP........161100
C                                                                        SLAP........161200
C     --Output--                                                         SLAP........161300
C       DY  copy of vector DX (unchanged if N .LE. 0)                    SLAP........161400
C                                                                        SLAP........161500
C     Copy double precision DX to double precision DY.                   SLAP........161600
C     For I = 0 to N-1, copy DX(LX+I*INCX) to DY(LY+I*INCY),             SLAP........161700
C     where LX = 1 if INCX .GE. 0, else LX = 1+(1-N)*INCX, and LY is     SLAP........161800
C     defined in a similar way using INCY.                               SLAP........161900
C                                                                        SLAP........162000
C***REFERENCES  C. L. Lawson, R. J. Hanson, D. R. Kincaid and F. T.      SLAP........162100
C                 Krogh, Basic linear algebra subprograms for Fortran    SLAP........162200
C                 usage, Algorithm No. 539, Transactions on Mathematical SLAP........162300
C                 Software 5, 3 (September 1979), pp. 308-323.           SLAP........162400
C***ROUTINES CALLED  (NONE)                                              SLAP........162500
C***REVISION HISTORY  (YYMMDD)                                           SLAP........162600
C   791001  DATE WRITTEN                                                 SLAP........162700
C   890831  Modified array declarations.  (WRB)                          SLAP........162800
C   890831  REVISION DATE from Version 3.2                               SLAP........162900
C   891214  Prologue converted to Version 4.0 format.  (BAB)             SLAP........163000
C   920310  Corrected definition of LX in DESCRIPTION.  (WRB)            SLAP........163100
C   920501  Reformatted the REFERENCES section.  (WRB)                   SLAP........163200
C***END PROLOGUE  DCOPY                                                  SLAP........163300
      DOUBLE PRECISION DX(*), DY(*)                                      SLAP........163400
C***FIRST EXECUTABLE STATEMENT  DCOPY                                    SLAP........163500
      IF (N .LE. 0) RETURN                                               SLAP........163600
      IF (INCX .EQ. INCY) IF (INCX-1) 5,20,60                            SLAP........163700
C                                                                        SLAP........163800
C     Code for unequal or nonpositive increments.                        SLAP........163900
C                                                                        SLAP........164000
    5 IX = 1                                                             SLAP........164100
      IY = 1                                                             SLAP........164200
      IF (INCX .LT. 0) IX = (-N+1)*INCX + 1                              SLAP........164300
      IF (INCY .LT. 0) IY = (-N+1)*INCY + 1                              SLAP........164400
      DO 10 I = 1,N                                                      SLAP........164500
        DY(IY) = DX(IX)                                                  SLAP........164600
        IX = IX + INCX                                                   SLAP........164700
        IY = IY + INCY                                                   SLAP........164800
   10 CONTINUE                                                           SLAP........164900
      RETURN                                                             SLAP........165000
C                                                                        SLAP........165100
C     Code for both increments equal to 1.                               SLAP........165200
C                                                                        SLAP........165300
C     Clean-up loop so remaining vector length is a multiple of 7.       SLAP........165400
C                                                                        SLAP........165500
   20 M = MOD(N,7)                                                       SLAP........165600
      IF (M .EQ. 0) GO TO 40                                             SLAP........165700
      DO 30 I = 1,M                                                      SLAP........165800
        DY(I) = DX(I)                                                    SLAP........165900
   30 CONTINUE                                                           SLAP........166000
      IF (N .LT. 7) RETURN                                               SLAP........166100
   40 MP1 = M + 1                                                        SLAP........166200
      DO 50 I = MP1,N,7                                                  SLAP........166300
        DY(I) = DX(I)                                                    SLAP........166400
        DY(I+1) = DX(I+1)                                                SLAP........166500
        DY(I+2) = DX(I+2)                                                SLAP........166600
        DY(I+3) = DX(I+3)                                                SLAP........166700
        DY(I+4) = DX(I+4)                                                SLAP........166800
        DY(I+5) = DX(I+5)                                                SLAP........166900
        DY(I+6) = DX(I+6)                                                SLAP........167000
   50 CONTINUE                                                           SLAP........167100
      RETURN                                                             SLAP........167200
C                                                                        SLAP........167300
C     Code for equal, positive, non-unit increments.                     SLAP........167400
C                                                                        SLAP........167500
   60 NS = N*INCX                                                        SLAP........167600
      DO 70 I = 1,NS,INCX                                                SLAP........167700
        DY(I) = DX(I)                                                    SLAP........167800
   70 CONTINUE                                                           SLAP........167900
      RETURN                                                             SLAP........168000
      END                                                                SLAP........168100
*DECK DDOT                                                               SLAP........168200
      DOUBLE PRECISION FUNCTION DDOT (N, DX, INCX, DY, INCY)             SLAP........168300
C***BEGIN PROLOGUE  DDOT                                                 SLAP........168400
C***PURPOSE  Compute the inner product of two vectors.                   SLAP........168500
C***LIBRARY   SLATEC (BLAS)                                              SLAP........168600
C***CATEGORY  D1A4                                                       SLAP........168700
C***TYPE      DOUBLE PRECISION (SDOT-S, DDOT-D, CDOTU-C)                 SLAP........168800
C***KEYWORDS  BLAS, INNER PRODUCT, LINEAR ALGEBRA, VECTOR                SLAP........168900
C***AUTHOR  Lawson, C. L., (JPL)                                         SLAP........169000
C           Hanson, R. J., (SNLA)                                        SLAP........169100
C           Kincaid, D. R., (U. of Texas)                                SLAP........169200
C           Krogh, F. T., (JPL)                                          SLAP........169300
C***DESCRIPTION                                                          SLAP........169400
C                                                                        SLAP........169500
C                B L A S  Subprogram                                     SLAP........169600
C    Description of Parameters                                           SLAP........169700
C                                                                        SLAP........169800
C     --Input--                                                          SLAP........169900
C        N  number of elements in input vector(s)                        SLAP........170000
C       DX  double precision vector with N elements                      SLAP........170100
C     INCX  storage spacing between elements of DX                       SLAP........170200
C       DY  double precision vector with N elements                      SLAP........170300
C     INCY  storage spacing between elements of DY                       SLAP........170400
C                                                                        SLAP........170500
C     --Output--                                                         SLAP........170600
C     DDOT  double precision dot product (zero if N .LE. 0)              SLAP........170700
C                                                                        SLAP........170800
C     Returns the dot product of double precision DX and DY.             SLAP........170900
C     DDOT = sum for I = 0 to N-1 of  DX(LX+I*INCX) * DY(LY+I*INCY),     SLAP........171000
C     where LX = 1 if INCX .GE. 0, else LX = 1+(1-N)*INCX, and LY is     SLAP........171100
C     defined in a similar way using INCY.                               SLAP........171200
C                                                                        SLAP........171300
C***REFERENCES  C. L. Lawson, R. J. Hanson, D. R. Kincaid and F. T.      SLAP........171400
C                 Krogh, Basic linear algebra subprograms for Fortran    SLAP........171500
C                 usage, Algorithm No. 539, Transactions on Mathematical SLAP........171600
C                 Software 5, 3 (September 1979), pp. 308-323.           SLAP........171700
C***ROUTINES CALLED  (NONE)                                              SLAP........171800
C***REVISION HISTORY  (YYMMDD)                                           SLAP........171900
C   791001  DATE WRITTEN                                                 SLAP........172000
C   890831  Modified array declarations.  (WRB)                          SLAP........172100
C   890831  REVISION DATE from Version 3.2                               SLAP........172200
C   891214  Prologue converted to Version 4.0 format.  (BAB)             SLAP........172300
C   920310  Corrected definition of LX in DESCRIPTION.  (WRB)            SLAP........172400
C   920501  Reformatted the REFERENCES section.  (WRB)                   SLAP........172500
C***END PROLOGUE  DDOT                                                   SLAP........172600
      DOUBLE PRECISION DX(*), DY(*)                                      SLAP........172700
C***FIRST EXECUTABLE STATEMENT  DDOT                                     SLAP........172800
      DDOT = 0.0D0                                                       SLAP........172900
      IF (N .LE. 0) RETURN                                               SLAP........173000
      IF (INCX .EQ. INCY) IF (INCX-1) 5,20,60                            SLAP........173100
C                                                                        SLAP........173200
C     Code for unequal or nonpositive increments.                        SLAP........173300
C                                                                        SLAP........173400
    5 IX = 1                                                             SLAP........173500
      IY = 1                                                             SLAP........173600
      IF (INCX .LT. 0) IX = (-N+1)*INCX + 1                              SLAP........173700
      IF (INCY .LT. 0) IY = (-N+1)*INCY + 1                              SLAP........173800
      DO 10 I = 1,N                                                      SLAP........173900
        DDOT = DDOT + DX(IX)*DY(IY)                                      SLAP........174000
        IX = IX + INCX                                                   SLAP........174100
        IY = IY + INCY                                                   SLAP........174200
   10 CONTINUE                                                           SLAP........174300
      RETURN                                                             SLAP........174400
C                                                                        SLAP........174500
C     Code for both increments equal to 1.                               SLAP........174600
C                                                                        SLAP........174700
C     Clean-up loop so remaining vector length is a multiple of 5.       SLAP........174800
C                                                                        SLAP........174900
   20 M = MOD(N,5)                                                       SLAP........175000
      IF (M .EQ. 0) GO TO 40                                             SLAP........175100
      DO 30 I = 1,M                                                      SLAP........175200
         DDOT = DDOT + DX(I)*DY(I)                                       SLAP........175300
   30 CONTINUE                                                           SLAP........175400
      IF (N .LT. 5) RETURN                                               SLAP........175500
   40 MP1 = M + 1                                                        SLAP........175600
      DO 50 I = MP1,N,5                                                  SLAP........175700
      DDOT = DDOT + DX(I)*DY(I) + DX(I+1)*DY(I+1) + DX(I+2)*DY(I+2) +    SLAP........175800
     1              DX(I+3)*DY(I+3) + DX(I+4)*DY(I+4)                    SLAP........175900
   50 CONTINUE                                                           SLAP........176000
      RETURN                                                             SLAP........176100
C                                                                        SLAP........176200
C     Code for equal, positive, non-unit increments.                     SLAP........176300
C                                                                        SLAP........176400
   60 NS = N*INCX                                                        SLAP........176500
      DO 70 I = 1,NS,INCX                                                SLAP........176600
        DDOT = DDOT + DX(I)*DY(I)                                        SLAP........176700
   70 CONTINUE                                                           SLAP........176800
      RETURN                                                             SLAP........176900
      END                                                                SLAP........177000
*DECK DGMRES                                                             SLAP........177100
      SUBROUTINE DGMRES (N, B, X, NELT, IA, JA, A, ISYM, MATVEC, MSOLVE, SLAP........177200
     +   ITOL, TOL, ITMAX, ITER, ERR, IERR, IUNIT, SB, SX, RGWK, LRGW,   SLAP........177300
     +   IGWK, LIGW, RWORK, IWORK)                                       SLAP........177400
C***BEGIN PROLOGUE  DGMRES                                               SLAP........177500
C***PURPOSE  Preconditioned GMRES iterative sparse Ax=b solver.          SLAP........177600
C            This routine uses the generalized minimum residual          SLAP........177700
C            (GMRES) method with preconditioning to solve                SLAP........177800
C            non-symmetric linear systems of the form: Ax = b.           SLAP........177900
C***LIBRARY   SLATEC (SLAP)                                              SLAP........178000
C***CATEGORY  D2A4, D2B4                                                 SLAP........178100
C***TYPE      DOUBLE PRECISION (SGMRES-S, DGMRES-D)                      SLAP........178200
C***KEYWORDS  GENERALIZED MINIMUM RESIDUAL, ITERATIVE PRECONDITION,      SLAP........178300
C             NON-SYMMETRIC LINEAR SYSTEM, SLAP, SPARSE                  SLAP........178400
C***AUTHOR  Brown, Peter, (LLNL), pnbrown@llnl.gov                       SLAP........178500
C           Hindmarsh, Alan, (LLNL), alanh@llnl.gov                      SLAP........178600
C           Seager, Mark K., (LLNL), seager@llnl.gov                     SLAP........178700
C             Lawrence Livermore National Laboratory                     SLAP........178800
C             PO Box 808, L-60                                           SLAP........178900
C             Livermore, CA 94550 (510) 423-3141                         SLAP........179000
C***DESCRIPTION                                                          SLAP........179100
C                                                                        SLAP........179200
C *Usage:                                                                SLAP........179300
C      INTEGER   N, NELT, IA(NELT), JA(NELT), ISYM, ITOL, ITMAX          SLAP........179400
C      INTEGER   ITER, IERR, IUNIT, LRGW, IGWK(LIGW), LIGW               SLAP........179500
C      INTEGER   IWORK(USER DEFINED)                                     SLAP........179600
C      DOUBLE PRECISION B(N), X(N), A(NELT), TOL, ERR, SB(N), SX(N)      SLAP........179700
C      DOUBLE PRECISION RGWK(LRGW), RWORK(USER DEFINED)                  SLAP........179800
C      EXTERNAL  MATVEC, MSOLVE                                          SLAP........179900
C                                                                        SLAP........180000
C      CALL DGMRES(N, B, X, NELT, IA, JA, A, ISYM, MATVEC, MSOLVE,       SLAP........180100
C     $     ITOL, TOL, ITMAX, ITER, ERR, IERR, IUNIT, SB, SX,            SLAP........180200
C     $     RGWK, LRGW, IGWK, LIGW, RWORK, IWORK)                        SLAP........180300
C                                                                        SLAP........180400
C *Arguments:                                                            SLAP........180500
C N      :IN       Integer.                                              SLAP........180600
C         Order of the Matrix.                                           SLAP........180700
C B      :IN       Double Precision B(N).                                SLAP........180800
C         Right-hand side vector.                                        SLAP........180900
C X      :INOUT    Double Precision X(N).                                SLAP........181000
C         On input X is your initial guess for the solution vector.      SLAP........181100
C         On output X is the final approximate solution.                 SLAP........181200
C NELT   :IN       Integer.                                              SLAP........181300
C         Number of Non-Zeros stored in A.                               SLAP........181400
C IA     :IN       Integer IA(NELT).                                     SLAP........181500
C JA     :IN       Integer JA(NELT).                                     SLAP........181600
C A      :IN       Double Precision A(NELT).                             SLAP........181700
C         These arrays contain the matrix data structure for A.          SLAP........181800
C         It could take any form.  See "Description", below,             SLAP........181900
C         for more details.                                              SLAP........182000
C ISYM   :IN       Integer.                                              SLAP........182100
C         Flag to indicate symmetric storage format.                     SLAP........182200
C         If ISYM=0, all non-zero entries of the matrix are stored.      SLAP........182300
C         If ISYM=1, the matrix is symmetric, and only the upper         SLAP........182400
C         or lower triangle of the matrix is stored.                     SLAP........182500
C MATVEC :EXT      External.                                             SLAP........182600
C         Name of a routine which performs the matrix vector multiply    SLAP........182700
C         Y = A*X given A and X.  The name of the MATVEC routine must    SLAP........182800
C         be declared external in the calling program.  The calling      SLAP........182900
C         sequence to MATVEC is:                                         SLAP........183000
C             CALL MATVEC(N, X, Y, NELT, IA, JA, A, ISYM)                SLAP........183100
C         where N is the number of unknowns, Y is the product A*X        SLAP........183200
C         upon return, X is an input vector, and NELT is the number of   SLAP........183300
C         non-zeros in the SLAP IA, JA, A storage for the matrix A.      SLAP........183400
C         ISYM is a flag which, if non-zero, denotes that A is           SLAP........183500
C         symmetric and only the lower or upper triangle is stored.      SLAP........183600
C MSOLVE :EXT      External.                                             SLAP........183700
C         Name of the routine which solves a linear system Mz = r for    SLAP........183800
C         z given r with the preconditioning matrix M (M is supplied via SLAP........183900
C         RWORK and IWORK arrays.  The name of the MSOLVE routine must   SLAP........184000
C         be declared external in the calling program.  The calling      SLAP........184100
C         sequence to MSOLVE is:                                         SLAP........184200
C             CALL MSOLVE(N, R, Z, NELT, IA, JA, A, ISYM, RWORK, IWORK)  SLAP........184300
C         Where N is the number of unknowns, R is the right-hand side    SLAP........184400
C         vector and Z is the solution upon return.  NELT, IA, JA, A and SLAP........184500
C         ISYM are defined as above.  RWORK is a double precision array  SLAP........184600
C         that can be used to pass necessary preconditioning information SLAP........184700
C         and/or workspace to MSOLVE.  IWORK is an integer work array    SLAP........184800
C         for the same purpose as RWORK.                                 SLAP........184900
C ITOL   :IN       Integer.                                              SLAP........185000
C         Flag to indicate the type of convergence criterion used.       SLAP........185100
C         ITOL=0  Means the  iteration stops when the test described     SLAP........185200
C                 below on  the  residual RL  is satisfied.  This is     SLAP........185300
C                 the  "Natural Stopping Criteria" for this routine.     SLAP........185400
C                 Other values  of   ITOL  cause  extra,   otherwise     SLAP........185500
C                 unnecessary, computation per iteration and     are     SLAP........185600
C                 therefore  much less  efficient.  See  ISDGMR (the     SLAP........185700
C                 stop test routine) for more information.               SLAP........185800
C         ITOL=1  Means   the  iteration stops   when the first test     SLAP........185900
C                 described below on  the residual RL  is satisfied,     SLAP........186000
C                 and there  is either right  or  no preconditioning     SLAP........186100
C                 being used.                                            SLAP........186200
C         ITOL=2  Implies     that   the  user    is   using    left     SLAP........186300
C                 preconditioning, and the second stopping criterion     SLAP........186400
C                 below is used.                                         SLAP........186500
C         ITOL=3  Means the  iteration stops   when  the  third test     SLAP........186600
C                 described below on Minv*Residual is satisfied, and     SLAP........186700
C                 there is either left  or no  preconditioning being     SLAP........186800
C                 used.                                                  SLAP........186900
C         ITOL=11 is    often  useful  for   checking  and comparing     SLAP........187000
C                 different routines.  For this case, the  user must     SLAP........187100
C                 supply  the  "exact" solution or  a  very accurate     SLAP........187200
C                 approximation (one with  an  error much less  than     SLAP........187300
C                 TOL) through a common block,                           SLAP........187400
C                     COMMON /DSLBLK/ SOLN( )                            SLAP........187500
C                 If ITOL=11, iteration stops when the 2-norm of the     SLAP........187600
C                 difference between the iterative approximation and     SLAP........187700
C                 the user-supplied solution  divided by the  2-norm     SLAP........187800
C                 of the  user-supplied solution  is  less than TOL.     SLAP........187900
C                 Note that this requires  the  user to  set up  the     SLAP........188000
C                 "COMMON     /DSLBLK/ SOLN(LENGTH)"  in the calling     SLAP........188100
C                 routine.  The routine with this declaration should     SLAP........188200
C                 be loaded before the stop test so that the correct     SLAP........188300
C                 length is used by  the loader.  This procedure  is     SLAP........188400
C                 not standard Fortran and may not work correctly on     SLAP........188500
C                 your   system (although  it  has  worked  on every     SLAP........188600
C                 system the authors have tried).  If ITOL is not 11     SLAP........188700
C                 then this common block is indeed standard Fortran.     SLAP........188800
C TOL    :INOUT    Double Precision.                                     SLAP........188900
C         Convergence criterion, as described below.  If TOL is set      SLAP........189000
C         to zero on input, then a default value of 500*(the smallest    SLAP........189100
C         positive magnitude, machine epsilon) is used.                  SLAP........189200
C ITMAX  :DUMMY    Integer.                                              SLAP........189300
C         Maximum number of iterations in most SLAP routines.  In        SLAP........189400
C         this routine this does not make sense.  The maximum number     SLAP........189500
C         of iterations here is given by ITMAX = MAXL*(NRMAX+1).         SLAP........189600
C         See IGWK for definitions of MAXL and NRMAX.                    SLAP........189700
C ITER   :OUT      Integer.                                              SLAP........189800
C         Number of iterations required to reach convergence, or         SLAP........189900
C         ITMAX if convergence criterion could not be achieved in        SLAP........190000
C         ITMAX iterations.                                              SLAP........190100
C ERR    :OUT      Double Precision.                                     SLAP........190200
C         Error estimate of error in final approximate solution, as      SLAP........190300
C         defined by ITOL.  Letting norm() denote the Euclidean          SLAP........190400
C         norm, ERR is defined as follows..                              SLAP........190500
C                                                                        SLAP........190600
C         If ITOL=0, then ERR = norm(SB*(B-A*X(L)))/norm(SB*B),          SLAP........190700
C                               for right or no preconditioning, and     SLAP........190800
C                         ERR = norm(SB*(M-inverse)*(B-A*X(L)))/         SLAP........190900
C                                norm(SB*(M-inverse)*B),                 SLAP........191000
C                               for left preconditioning.                SLAP........191100
C         If ITOL=1, then ERR = norm(SB*(B-A*X(L)))/norm(SB*B),          SLAP........191200
C                               since right or no preconditioning        SLAP........191300
C                               being used.                              SLAP........191400
C         If ITOL=2, then ERR = norm(SB*(M-inverse)*(B-A*X(L)))/         SLAP........191500
C                                norm(SB*(M-inverse)*B),                 SLAP........191600
C                               since left preconditioning is being      SLAP........191700
C                               used.                                    SLAP........191800
C         If ITOL=3, then ERR =  Max  |(Minv*(B-A*X(L)))(i)/x(i)|        SLAP........191900
C                               i=1,n                                    SLAP........192000
C         If ITOL=11, then ERR = norm(SB*(X(L)-SOLN))/norm(SB*SOLN).     SLAP........192100
C IERR   :OUT      Integer.                                              SLAP........192200
C         Return error flag.                                             SLAP........192300
C               IERR = 0 => All went well.                               SLAP........192400
C               IERR = 1 => Insufficient storage allocated for           SLAP........192500
C                           RGWK or IGWK.                                SLAP........192600
C               IERR = 2 => Routine DGMRES failed to reduce the norm     SLAP........192700
C                           of the current residual on its last call,    SLAP........192800
C                           and so the iteration has stalled.  In        SLAP........192900
C                           this case, X equals the last computed        SLAP........193000
C                           approximation.  The user must either         SLAP........193100
C                           increase MAXL, or choose a different         SLAP........193200
C                           initial guess.                               SLAP........193300
C               IERR =-1 => Insufficient length for RGWK array.          SLAP........193400
C                           IGWK(6) contains the required minimum        SLAP........193500
C                           length of the RGWK array.                    SLAP........193600
C               IERR =-2 => Illegal value of ITOL, or ITOL and JPRE      SLAP........193700
C                           values are inconsistent.                     SLAP........193800
C         For IERR <= 2, RGWK(1) = RHOL, which is the norm on the        SLAP........193900
C         left-hand-side of the relevant stopping test defined           SLAP........194000
C         below associated with the residual for the current             SLAP........194100
C         approximation X(L).                                            SLAP........194200
C IUNIT  :IN       Integer.                                              SLAP........194300
C         Unit number on which to write the error at each iteration,     SLAP........194400
C         if this is desired for monitoring convergence.  If unit        SLAP........194500
C         number is 0, no writing will occur.                            SLAP........194600
C SB     :IN       Double Precision SB(N).                               SLAP........194700
C         Array of length N containing scale factors for the right       SLAP........194800
C         hand side vector B.  If JSCAL.eq.0 (see below), SB need        SLAP........194900
C         not be supplied.                                               SLAP........195000
C SX     :IN       Double Precision SX(N).                               SLAP........195100
C         Array of length N containing scale factors for the solution    SLAP........195200
C         vector X.  If JSCAL.eq.0 (see below), SX need not be           SLAP........195300
C         supplied.  SB and SX can be the same array in the calling      SLAP........195400
C         program if desired.                                            SLAP........195500
C RGWK   :INOUT    Double Precision RGWK(LRGW).                          SLAP........195600
C         Double Precision array used for workspace by DGMRES.           SLAP........195700
C         On return, RGWK(1) = RHOL.  See IERR for definition of RHOL.   SLAP........195800
C LRGW   :IN       Integer.                                              SLAP........195900
C         Length of the double precision workspace, RGWK.                SLAP........196000
C         LRGW >= 1 + N*(MAXL+6) + MAXL*(MAXL+3).                        SLAP........196100
C         See below for definition of MAXL.                              SLAP........196200
C         For the default values, RGWK has size at least 131 + 16*N.     SLAP........196300
C IGWK   :INOUT    Integer IGWK(LIGW).                                   SLAP........196400
C         The following IGWK parameters should be set by the user        SLAP........196500
C         before calling this routine.                                   SLAP........196600
C         IGWK(1) = MAXL.  Maximum dimension of Krylov subspace in       SLAP........196700
C            which X - X0 is to be found (where, X0 is the initial       SLAP........196800
C            guess).  The default value of MAXL is 10.                   SLAP........196900
C         IGWK(2) = KMP.  Maximum number of previous Krylov basis        SLAP........197000
C            vectors to which each new basis vector is made orthogonal.  SLAP........197100
C            The default value of KMP is MAXL.                           SLAP........197200
C         IGWK(3) = JSCAL.  Flag indicating whether the scaling          SLAP........197300
C            arrays SB and SX are to be used.                            SLAP........197400
C            JSCAL = 0 => SB and SX are not used and the algorithm       SLAP........197500
C               will perform as if all SB(I) = 1 and SX(I) = 1.          SLAP........197600
C            JSCAL = 1 =>  Only SX is used, and the algorithm            SLAP........197700
C               performs as if all SB(I) = 1.                            SLAP........197800
C            JSCAL = 2 =>  Only SB is used, and the algorithm            SLAP........197900
C               performs as if all SX(I) = 1.                            SLAP........198000
C            JSCAL = 3 =>  Both SB and SX are used.                      SLAP........198100
C         IGWK(4) = JPRE.  Flag indicating whether preconditioning       SLAP........198200
C            is being used.                                              SLAP........198300
C            JPRE = 0  =>  There is no preconditioning.                  SLAP........198400
C            JPRE > 0  =>  There is preconditioning on the right         SLAP........198500
C               only, and the solver will call routine MSOLVE.           SLAP........198600
C            JPRE < 0  =>  There is preconditioning on the left          SLAP........198700
C               only, and the solver will call routine MSOLVE.           SLAP........198800
C         IGWK(5) = NRMAX.  Maximum number of restarts of the            SLAP........198900
C            Krylov iteration.  The default value of NRMAX = 10.         SLAP........199000
C            if IWORK(5) = -1,  then no restarts are performed (in       SLAP........199100
C            this case, NRMAX is set to zero internally).                SLAP........199200
C         The following IWORK parameters are diagnostic information      SLAP........199300
C         made available to the user after this routine completes.       SLAP........199400
C         IGWK(6) = MLWK.  Required minimum length of RGWK array.        SLAP........199500
C         IGWK(7) = NMS.  The total number of calls to MSOLVE.           SLAP........199600
C LIGW   :IN       Integer.                                              SLAP........199700
C         Length of the integer workspace, IGWK.  LIGW >= 20.            SLAP........199800
C RWORK  :WORK     Double Precision RWORK(USER DEFINED).                 SLAP........199900
C         Double Precision array that can be used for workspace in       SLAP........200000
C         MSOLVE.                                                        SLAP........200100
C IWORK  :WORK     Integer IWORK(USER DEFINED).                          SLAP........200200
C         Integer array that can be used for workspace in MSOLVE.        SLAP........200300
C                                                                        SLAP........200400
C *Description:                                                          SLAP........200500
C       DGMRES solves a linear system A*X = B rewritten in the form:     SLAP........200600
C                                                                        SLAP........200700
C        (SB*A*(M-inverse)*(SX-inverse))*(SX*M*X) = SB*B,                SLAP........200800
C                                                                        SLAP........200900
C       with right preconditioning, or                                   SLAP........201000
C                                                                        SLAP........201100
C        (SB*(M-inverse)*A*(SX-inverse))*(SX*X) = SB*(M-inverse)*B,      SLAP........201200
C                                                                        SLAP........201300
C       with left preconditioning, where A is an N-by-N double precision SLAP........201400
C       matrix, X and B are N-vectors,  SB and SX  are diagonal scaling  SLAP........201500
C       matrices,   and M is  a preconditioning    matrix.   It uses     SLAP........201600
C       preconditioned  Krylov   subpace  methods  based     on  the     SLAP........201700
C       generalized minimum residual  method (GMRES).   This routine     SLAP........201800
C       optionally performs  either  the  full     orthogonalization     SLAP........201900
C       version of the  GMRES  algorithm or an incomplete variant of     SLAP........202000
C       it.  Both versions use restarting of the linear iteration by     SLAP........202100
C       default, although the user can disable this feature.             SLAP........202200
C                                                                        SLAP........202300
C       The GMRES  algorithm generates a sequence  of approximations     SLAP........202400
C       X(L) to the  true solution of the above  linear system.  The     SLAP........202500
C       convergence criteria for stopping the  iteration is based on     SLAP........202600
C       the size  of the  scaled norm of  the residual  R(L)  =  B -     SLAP........202700
C       A*X(L).  The actual stopping test is either:                     SLAP........202800
C                                                                        SLAP........202900
C               norm(SB*(B-A*X(L))) .le. TOL*norm(SB*B),                 SLAP........203000
C                                                                        SLAP........203100
C       for right preconditioning, or                                    SLAP........203200
C                                                                        SLAP........203300
C               norm(SB*(M-inverse)*(B-A*X(L))) .le.                     SLAP........203400
C                       TOL*norm(SB*(M-inverse)*B),                      SLAP........203500
C                                                                        SLAP........203600
C       for left preconditioning, where norm() denotes the Euclidean     SLAP........203700
C       norm, and TOL is  a positive scalar less  than one  input by     SLAP........203800
C       the user.  If TOL equals zero  when DGMRES is called, then a     SLAP........203900
C       default  value  of 500*(the   smallest  positive  magnitude,     SLAP........204000
C       machine epsilon) is used.  If the  scaling arrays SB  and SX     SLAP........204100
C       are used, then  ideally they  should be chosen  so  that the     SLAP........204200
C       vectors SX*X(or SX*M*X) and  SB*B have all their  components     SLAP........204300
C       approximately equal  to  one in  magnitude.  If one wants to     SLAP........204400
C       use the same scaling in X  and B, then  SB and SX can be the     SLAP........204500
C       same array in the calling program.                               SLAP........204600
C                                                                        SLAP........204700
C       The following is a list of the other routines and their          SLAP........204800
C       functions used by DGMRES:                                        SLAP........204900
C       DPIGMR  Contains the main iteration loop for GMRES.              SLAP........205000
C       DORTH   Orthogonalizes a new vector against older basis vectors. SLAP........205100
C       DHEQR   Computes a QR decomposition of a Hessenberg matrix.      SLAP........205200
C       DHELS   Solves a Hessenberg least-squares system, using QR       SLAP........205300
C               factors.                                                 SLAP........205400
C       DRLCAL  Computes the scaled residual RL.                         SLAP........205500
C       DXLCAL  Computes the solution XL.                                SLAP........205600
C       ISDGMR  User-replaceable stopping routine.                       SLAP........205700
C                                                                        SLAP........205800
C       This routine does  not care  what matrix data   structure is     SLAP........205900
C       used for  A and M.  It simply   calls  the MATVEC and MSOLVE     SLAP........206000
C       routines, with  the arguments as  described above.  The user     SLAP........206100
C       could write any type of structure and the appropriate MATVEC     SLAP........206200
C       and MSOLVE routines.  It is assumed  that A is stored in the     SLAP........206300
C       IA, JA, A  arrays in some fashion and  that M (or INV(M)) is     SLAP........206400
C       stored  in  IWORK  and  RWORK   in  some fashion.   The SLAP     SLAP........206500
C       routines DSDCG and DSICCG are examples of this procedure.        SLAP........206600
C                                                                        SLAP........206700
C       Two  examples  of  matrix  data structures  are the: 1) SLAP     SLAP........206800
C       Triad  format and 2) SLAP Column format.                         SLAP........206900
C                                                                        SLAP........207000
C       =================== S L A P Triad format ===================     SLAP........207100
C       This routine requires that the  matrix A be   stored in  the     SLAP........207200
C       SLAP  Triad format.  In  this format only the non-zeros  are     SLAP........207300
C       stored.  They may appear in  *ANY* order.  The user supplies     SLAP........207400
C       three arrays of  length NELT, where  NELT is  the number  of     SLAP........207500
C       non-zeros in the matrix: (IA(NELT), JA(NELT), A(NELT)).  For     SLAP........207600
C       each non-zero the user puts the row and column index of that     SLAP........207700
C       matrix element  in the IA and  JA arrays.  The  value of the     SLAP........207800
C       non-zero   matrix  element is  placed  in  the corresponding     SLAP........207900
C       location of the A array.   This is  an  extremely  easy data     SLAP........208000
C       structure to generate.  On  the  other hand it   is  not too     SLAP........208100
C       efficient on vector computers for  the iterative solution of     SLAP........208200
C       linear systems.  Hence,   SLAP changes   this  input    data     SLAP........208300
C       structure to the SLAP Column format  for  the iteration (but     SLAP........208400
C       does not change it back).                                        SLAP........208500
C                                                                        SLAP........208600
C       Here is an example of the  SLAP Triad   storage format for a     SLAP........208700
C       5x5 Matrix.  Recall that the entries may appear in any order.    SLAP........208800
C                                                                        SLAP........208900
C           5x5 Matrix      SLAP Triad format for 5x5 matrix on left.    SLAP........209000
C                              1  2  3  4  5  6  7  8  9 10 11           SLAP........209100
C       |11 12  0  0 15|   A: 51 12 11 33 15 53 55 22 35 44 21           SLAP........209200
C       |21 22  0  0  0|  IA:  5  1  1  3  1  5  5  2  3  4  2           SLAP........209300
C       | 0  0 33  0 35|  JA:  1  2  1  3  5  3  5  2  5  4  1           SLAP........209400
C       | 0  0  0 44  0|                                                 SLAP........209500
C       |51  0 53  0 55|                                                 SLAP........209600
C                                                                        SLAP........209700
C       =================== S L A P Column format ==================     SLAP........209800
C                                                                        SLAP........209900
C       This routine  requires that  the matrix A  be stored in  the     SLAP........210000
C       SLAP Column format.  In this format the non-zeros are stored     SLAP........210100
C       counting down columns (except for  the diagonal entry, which     SLAP........210200
C       must appear first in each  "column")  and are stored  in the     SLAP........210300
C       double precision array A.   In other words,  for each column     SLAP........210400
C       in the matrix put the diagonal entry in  A.  Then put in the     SLAP........210500
C       other non-zero  elements going down  the column (except  the     SLAP........210600
C       diagonal) in order.   The  IA array holds the  row index for     SLAP........210700
C       each non-zero.  The JA array holds the offsets  into the IA,     SLAP........210800
C       A arrays  for  the  beginning  of each   column.   That  is,     SLAP........210900
C       IA(JA(ICOL)),  A(JA(ICOL)) points   to the beginning  of the     SLAP........211000
C       ICOL-th   column    in    IA and   A.      IA(JA(ICOL+1)-1),     SLAP........211100
C       A(JA(ICOL+1)-1) points to  the  end of the   ICOL-th column.     SLAP........211200
C       Note that we always have  JA(N+1) = NELT+1,  where N is  the     SLAP........211300
C       number of columns in  the matrix and NELT  is the number  of     SLAP........211400
C       non-zeros in the matrix.                                         SLAP........211500
C                                                                        SLAP........211600
C       Here is an example of the  SLAP Column  storage format for a     SLAP........211700
C       5x5 Matrix (in the A and IA arrays '|'  denotes the end of a     SLAP........211800
C       column):                                                         SLAP........211900
C                                                                        SLAP........212000
C           5x5 Matrix      SLAP Column format for 5x5 matrix on left.   SLAP........212100
C                              1  2  3    4  5    6  7    8    9 10 11   SLAP........212200
C       |11 12  0  0 15|   A: 11 21 51 | 22 12 | 33 53 | 44 | 55 15 35   SLAP........212300
C       |21 22  0  0  0|  IA:  1  2  5 |  2  1 |  3  5 |  4 |  5  1  3   SLAP........212400
C       | 0  0 33  0 35|  JA:  1  4  6    8  9   12                      SLAP........212500
C       | 0  0  0 44  0|                                                 SLAP........212600
C       |51  0 53  0 55|                                                 SLAP........212700
C                                                                        SLAP........212800
C *Cautions:                                                             SLAP........212900
C     This routine will attempt to write to the Fortran logical output   SLAP........213000
C     unit IUNIT, if IUNIT .ne. 0.  Thus, the user must make sure that   SLAP........213100
C     this logical unit is attached to a file or terminal before calling SLAP........213200
C     this routine with a non-zero value for IUNIT.  This routine does   SLAP........213300
C     not check for the validity of a non-zero IUNIT unit number.        SLAP........213400
C                                                                        SLAP........213500
C***REFERENCES  1. Peter N. Brown and A. C. Hindmarsh, Reduced Storage   SLAP........213600
C                  Matrix Methods in Stiff ODE Systems, Lawrence Liver-  SLAP........213700
C                  more National Laboratory Report UCRL-95088, Rev. 1,   SLAP........213800
C                  Livermore, California, June 1987.                     SLAP........213900
C               2. Mark K. Seager, A SLAP for the Masses, in             SLAP........214000
C                  G. F. Carey, Ed., Parallel Supercomputing: Methods,   SLAP........214100
C                  Algorithms and Applications, Wiley, 1989, pp.135-155. SLAP........214200
C***ROUTINES CALLED  D1MACH, DCOPY, DNRM2, DPIGMR                        SLAP........214300
C***REVISION HISTORY  (YYMMDD)                                           SLAP........214400
C   890404  DATE WRITTEN                                                 SLAP........214500
C   890404  Previous REVISION DATE                                       SLAP........214600
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........214700
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........214800
C           standard.  (FNF)                                             SLAP........214900
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........215000
C   891004  Added new reference.                                         SLAP........215100
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........215200
C   910506  Corrected errors in C***ROUTINES CALLED list.  (FNF)         SLAP........215300
C   920407  COMMON BLOCK renamed DSLBLK.  (WRB)                          SLAP........215400
C   920511  Added complete declaration section.  (WRB)                   SLAP........215500
C   920929  Corrected format of references.  (FNF)                       SLAP........215600
C   921019  Changed 500.0 to 500 to reduce SP/DP differences.  (FNF)     SLAP........215700
C   921026  Added check for valid value of ITOL.  (FNF)                  SLAP........215800
C***END PROLOGUE  DGMRES                                                 SLAP........215900
C         The following is for optimized compilation on LLNL/LTSS Crays. SLAP........216000
CLLL. OPTIMIZE                                                           SLAP........216100
C     .. Scalar Arguments ..                                             SLAP........216200
      DOUBLE PRECISION ERR, TOL                                          SLAP........216300
      INTEGER IERR, ISYM, ITER, ITMAX, ITOL, IUNIT, LIGW, LRGW, N, NELT  SLAP........216400
C     .. Array Arguments ..                                              SLAP........216500
      DOUBLE PRECISION A(NELT), B(N), RGWK(LRGW), RWORK(*), SB(N),       SLAP........216600
     +                 SX(N), X(N)                                       SLAP........216700
      INTEGER IA(NELT), IGWK(LIGW), IWORK(*), JA(NELT)                   SLAP........216800
C     .. Subroutine Arguments ..                                         SLAP........216900
      EXTERNAL MATVEC, MSOLVE                                            SLAP........217000
C     .. Local Scalars ..                                                SLAP........217100
      DOUBLE PRECISION BNRM, RHOL, SUM                                   SLAP........217200
      INTEGER I, IFLAG, JPRE, JSCAL, KMP, LDL, LGMR, LHES, LQ, LR, LV,   SLAP........217300
     +        LW, LXL, LZ, LZM1, MAXL, MAXLP1, NMS, NMSL, NRMAX, NRSTS   SLAP........217400
C     .. External Functions ..                                           SLAP........217500
      DOUBLE PRECISION D1MACH, DNRM2                                     SLAP........217600
      EXTERNAL D1MACH, DNRM2                                             SLAP........217700
C     .. External Subroutines ..                                         SLAP........217800
      EXTERNAL DCOPY, DPIGMR                                             SLAP........217900
C     .. Intrinsic Functions ..                                          SLAP........218000
      INTRINSIC SQRT                                                     SLAP........218100
C***FIRST EXECUTABLE STATEMENT  DGMRES                                   SLAP........218200
      IERR = 0                                                           SLAP........218300
C   ------------------------------------------------------------------   SLAP........218400
C         Load method parameters with user values or defaults.           SLAP........218500
C   ------------------------------------------------------------------   SLAP........218600
      MAXL = IGWK(1)                                                     SLAP........218700
      IF (MAXL .EQ. 0) MAXL = 10                                         SLAP........218800
      IF (MAXL .GT. N) MAXL = N                                          SLAP........218900
      KMP = IGWK(2)                                                      SLAP........219000
      IF (KMP .EQ. 0) KMP = MAXL                                         SLAP........219100
      IF (KMP .GT. MAXL) KMP = MAXL                                      SLAP........219200
      JSCAL = IGWK(3)                                                    SLAP........219300
      JPRE = IGWK(4)                                                     SLAP........219400
C         Check for valid value of ITOL.                                 SLAP........219500
      IF( (ITOL.LT.0) .OR. ((ITOL.GT.3).AND.(ITOL.NE.11)) ) GOTO 650     SLAP........219600
C         Check for consistent values of ITOL and JPRE.                  SLAP........219700
      IF( ITOL.EQ.1 .AND. JPRE.LT.0 ) GOTO 650                           SLAP........219800
      IF( ITOL.EQ.2 .AND. JPRE.GE.0 ) GOTO 650                           SLAP........219900
      NRMAX = IGWK(5)                                                    SLAP........220000
C.....THE COMMENT LINE THAT BEGINS WITH "CCC" IMMEDIATELY BELOW          SLAP........220100
C        THIS COMMENT WAS ORIGINALLY ACTIVE CODE AND WAS COMMENTED       SLAP........220200
C        OUT DURING INTEGRATION OF SLAP WITH SUTRA.                      SLAP........220300
CCC   IF( NRMAX.EQ.0 ) NRMAX = 10                                        SLAP........220400
C         If NRMAX .eq. -1, then set NRMAX = 0 to turn off restarting.   SLAP........220500
      IF( NRMAX.EQ.-1 ) NRMAX = 0                                        SLAP........220600
C         If input value of TOL is zero, set it to its default value.    SLAP........220700
      IF( TOL.EQ.0.0D0 ) TOL = 500*D1MACH(3)                             SLAP........220800
C                                                                        SLAP........220900
C         Initialize counters.                                           SLAP........221000
      ITER = 0                                                           SLAP........221100
      NMS = 0                                                            SLAP........221200
      NRSTS = 0                                                          SLAP........221300
C   ------------------------------------------------------------------   SLAP........221400
C         Form work array segment pointers.                              SLAP........221500
C   ------------------------------------------------------------------   SLAP........221600
      MAXLP1 = MAXL + 1                                                  SLAP........221700
      LV = 1                                                             SLAP........221800
      LR = LV + N*MAXLP1                                                 SLAP........221900
      LHES = LR + N + 1                                                  SLAP........222000
      LQ = LHES + MAXL*MAXLP1                                            SLAP........222100
      LDL = LQ + 2*MAXL                                                  SLAP........222200
      LW = LDL + N                                                       SLAP........222300
      LXL = LW + N                                                       SLAP........222400
      LZ = LXL + N                                                       SLAP........222500
C                                                                        SLAP........222600
C         Load IGWK(6) with required minimum length of the RGWK array.   SLAP........222700
      IGWK(6) = LZ + N - 1                                               SLAP........222800
      IF( LZ+N-1.GT.LRGW ) GOTO 640                                      SLAP........222900
C   ------------------------------------------------------------------   SLAP........223000
C         Calculate scaled-preconditioned norm of RHS vector b.          SLAP........223100
C   ------------------------------------------------------------------   SLAP........223200
      IF (JPRE .LT. 0) THEN                                              SLAP........223300
         CALL MSOLVE(N, B, RGWK(LR), NELT, IA, JA, A, ISYM,              SLAP........223400
     $        RWORK, IWORK)                                              SLAP........223500
         NMS = NMS + 1                                                   SLAP........223600
      ELSE                                                               SLAP........223700
         CALL DCOPY(N, B, 1, RGWK(LR), 1)                                SLAP........223800
      ENDIF                                                              SLAP........223900
      IF( JSCAL.EQ.2 .OR. JSCAL.EQ.3 ) THEN                              SLAP........224000
         SUM = 0                                                         SLAP........224100
         DO 10 I = 1,N                                                   SLAP........224200
            SUM = SUM + (RGWK(LR-1+I)*SB(I))**2                          SLAP........224300
 10      CONTINUE                                                        SLAP........224400
         BNRM = SQRT(SUM)                                                SLAP........224500
      ELSE                                                               SLAP........224600
         BNRM = DNRM2(N,RGWK(LR),1)                                      SLAP........224700
      ENDIF                                                              SLAP........224800
C   ------------------------------------------------------------------   SLAP........224900
C         Calculate initial residual.                                    SLAP........225000
C   ------------------------------------------------------------------   SLAP........225100
      CALL MATVEC(N, X, RGWK(LR), NELT, IA, JA, A, ISYM)                 SLAP........225200
      DO 50 I = 1,N                                                      SLAP........225300
         RGWK(LR-1+I) = B(I) - RGWK(LR-1+I)                              SLAP........225400
 50   CONTINUE                                                           SLAP........225500
C   ------------------------------------------------------------------   SLAP........225600
C         If performing restarting, then load the residual into the      SLAP........225700
C         correct location in the RGWK array.                            SLAP........225800
C   ------------------------------------------------------------------   SLAP........225900
 100  CONTINUE                                                           SLAP........226000
      IF( NRSTS.GT.NRMAX ) GOTO 610                                      SLAP........226100
      IF( NRSTS.GT.0 ) THEN                                              SLAP........226200
C         Copy the current residual to a different location in the RGWK  SLAP........226300
C         array.                                                         SLAP........226400
         CALL DCOPY(N, RGWK(LDL), 1, RGWK(LR), 1)                        SLAP........226500
      ENDIF                                                              SLAP........226600
C   ------------------------------------------------------------------   SLAP........226700
C         Use the DPIGMR algorithm to solve the linear system A*Z = R.   SLAP........226800
C   ------------------------------------------------------------------   SLAP........226900
      CALL DPIGMR(N, RGWK(LR), SB, SX, JSCAL, MAXL, MAXLP1, KMP,         SLAP........227000
     $       NRSTS, JPRE, MATVEC, MSOLVE, NMSL, RGWK(LZ), RGWK(LV),      SLAP........227100
     $       RGWK(LHES), RGWK(LQ), LGMR, RWORK, IWORK, RGWK(LW),         SLAP........227200
     $       RGWK(LDL), RHOL, NRMAX, B, BNRM, X, RGWK(LXL), ITOL,        SLAP........227300
C............THE NEXT LINE OF CODE WAS MODIFIED DURING INTEGRATION OF    SLAP........227400
C               SLAP WITH SUTRA.  IT ORIGINALLY READ:                    SLAP........227500
C               $       TOL, NELT, IA, JA, A, ISYM, IUNIT, IFLAG, ERR)   SLAP........227600
     $       TOL, NELT, IA, JA, A, ISYM, IUNIT, IFLAG, ERR, ITMAX)       SLAP........227700
      ITER = ITER + LGMR                                                 SLAP........227800
      NMS = NMS + NMSL                                                   SLAP........227900
C                                                                        SLAP........228000
C         Increment X by the current approximate solution Z of A*Z = R.  SLAP........228100
C                                                                        SLAP........228200
      LZM1 = LZ - 1                                                      SLAP........228300
      DO 110 I = 1,N                                                     SLAP........228400
         X(I) = X(I) + RGWK(LZM1+I)                                      SLAP........228500
 110  CONTINUE                                                           SLAP........228600
      IF( IFLAG.EQ.0 ) GOTO 600                                          SLAP........228700
      IF( IFLAG.EQ.1 ) THEN                                              SLAP........228800
         NRSTS = NRSTS + 1                                               SLAP........228900
         GOTO 100                                                        SLAP........229000
      ENDIF                                                              SLAP........229100
      IF( IFLAG.EQ.2 ) GOTO 620                                          SLAP........229200
C   ------------------------------------------------------------------   SLAP........229300
C         All returns are made through this section.                     SLAP........229400
C   ------------------------------------------------------------------   SLAP........229500
C         The iteration has converged.                                   SLAP........229600
C                                                                        SLAP........229700
 600  CONTINUE                                                           SLAP........229800
      IGWK(7) = NMS                                                      SLAP........229900
      RGWK(1) = RHOL                                                     SLAP........230000
      IERR = 0                                                           SLAP........230100
      RETURN                                                             SLAP........230200
C                                                                        SLAP........230300
C         Max number((NRMAX+1)*MAXL) of linear iterations performed.     SLAP........230400
 610  CONTINUE                                                           SLAP........230500
      IGWK(7) = NMS                                                      SLAP........230600
      RGWK(1) = RHOL                                                     SLAP........230700
      IERR = 1                                                           SLAP........230800
      RETURN                                                             SLAP........230900
C                                                                        SLAP........231000
C         GMRES failed to reduce last residual in MAXL iterations.       SLAP........231100
C         The iteration has stalled.                                     SLAP........231200
 620  CONTINUE                                                           SLAP........231300
      IGWK(7) = NMS                                                      SLAP........231400
      RGWK(1) = RHOL                                                     SLAP........231500
      IERR = 2                                                           SLAP........231600
      RETURN                                                             SLAP........231700
C         Error return.  Insufficient length for RGWK array.             SLAP........231800
 640  CONTINUE                                                           SLAP........231900
      ERR = TOL                                                          SLAP........232000
      IERR = -1                                                          SLAP........232100
      RETURN                                                             SLAP........232200
C         Error return.  Inconsistent ITOL and JPRE values.              SLAP........232300
 650  CONTINUE                                                           SLAP........232400
      ERR = TOL                                                          SLAP........232500
      IERR = -2                                                          SLAP........232600
      RETURN                                                             SLAP........232700
C------------- LAST LINE OF DGMRES FOLLOWS ----------------------------  SLAP........232800
      END                                                                SLAP........232900
*DECK DHELS                                                              SLAP........233000
      SUBROUTINE DHELS (A, LDA, N, Q, B)                                 SLAP........233100
C***BEGIN PROLOGUE  DHELS                                                SLAP........233200
C***SUBSIDIARY                                                           SLAP........233300
C***PURPOSE  Internal routine for DGMRES.                                SLAP........233400
C***LIBRARY   SLATEC (SLAP)                                              SLAP........233500
C***CATEGORY  D2A4, D2B4                                                 SLAP........233600
C***TYPE      DOUBLE PRECISION (SHELS-S, DHELS-D)                        SLAP........233700
C***KEYWORDS  GENERALIZED MINIMUM RESIDUAL, ITERATIVE PRECONDITION,      SLAP........233800
C             NON-SYMMETRIC LINEAR SYSTEM, SLAP, SPARSE                  SLAP........233900
C***AUTHOR  Brown, Peter, (LLNL), pnbrown@llnl.gov                       SLAP........234000
C           Hindmarsh, Alan, (LLNL), alanh@llnl.gov                      SLAP........234100
C           Seager, Mark K., (LLNL), seager@llnl.gov                     SLAP........234200
C             Lawrence Livermore National Laboratory                     SLAP........234300
C             PO Box 808, L-60                                           SLAP........234400
C             Livermore, CA 94550 (510) 423-3141                         SLAP........234500
C***DESCRIPTION                                                          SLAP........234600
C        This routine is extracted from the LINPACK routine SGESL with   SLAP........234700
C        changes due to the fact that A is an upper Hessenberg matrix.   SLAP........234800
C                                                                        SLAP........234900
C        DHELS solves the least squares problem:                         SLAP........235000
C                                                                        SLAP........235100
C                   MIN(B-A*X,B-A*X)                                     SLAP........235200
C                                                                        SLAP........235300
C        using the factors computed by DHEQR.                            SLAP........235400
C                                                                        SLAP........235500
C *Usage:                                                                SLAP........235600
C      INTEGER LDA, N                                                    SLAP........235700
C      DOUBLE PRECISION A(LDA,N), Q(2*N), B(N+1)                         SLAP........235800
C                                                                        SLAP........235900
C      CALL DHELS(A, LDA, N, Q, B)                                       SLAP........236000
C                                                                        SLAP........236100
C *Arguments:                                                            SLAP........236200
C A       :IN       Double Precision A(LDA,N)                            SLAP........236300
C          The output from DHEQR which contains the upper                SLAP........236400
C          triangular factor R in the QR decomposition of A.             SLAP........236500
C LDA     :IN       Integer                                              SLAP........236600
C          The leading dimension of the array A.                         SLAP........236700
C N       :IN       Integer                                              SLAP........236800
C          A is originally an (N+1) by N matrix.                         SLAP........236900
C Q       :IN       Double Precision Q(2*N)                              SLAP........237000
C          The coefficients of the N Givens rotations                    SLAP........237100
C          used in the QR factorization of A.                            SLAP........237200
C B       :INOUT    Double Precision B(N+1)                              SLAP........237300
C          On input, B is the right hand side vector.                    SLAP........237400
C          On output, B is the solution vector X.                        SLAP........237500
C                                                                        SLAP........237600
C***SEE ALSO  DGMRES                                                     SLAP........237700
C***ROUTINES CALLED  DAXPY                                               SLAP........237800
C***REVISION HISTORY  (YYMMDD)                                           SLAP........237900
C   890404  DATE WRITTEN                                                 SLAP........238000
C   890404  Previous REVISION DATE                                       SLAP........238100
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........238200
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........238300
C           standard.  (FNF)                                             SLAP........238400
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........238500
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........238600
C   910502  Added C***FIRST EXECUTABLE STATEMENT line.  (FNF)            SLAP........238700
C   910506  Made subsidiary to DGMRES.  (FNF)                            SLAP........238800
C   920511  Added complete declaration section.  (WRB)                   SLAP........238900
C***END PROLOGUE  DHELS                                                  SLAP........239000
C         The following is for optimized compilation on LLNL/LTSS Crays. SLAP........239100
CLLL. OPTIMIZE                                                           SLAP........239200
C     .. Scalar Arguments ..                                             SLAP........239300
      INTEGER LDA, N                                                     SLAP........239400
C     .. Array Arguments ..                                              SLAP........239500
      DOUBLE PRECISION A(LDA,*), B(*), Q(*)                              SLAP........239600
C     .. Local Scalars ..                                                SLAP........239700
      DOUBLE PRECISION C, S, T, T1, T2                                   SLAP........239800
      INTEGER IQ, K, KB, KP1                                             SLAP........239900
C     .. External Subroutines ..                                         SLAP........240000
      EXTERNAL DAXPY                                                     SLAP........240100
C***FIRST EXECUTABLE STATEMENT  DHELS                                    SLAP........240200
C                                                                        SLAP........240300
C         Minimize(B-A*X,B-A*X).  First form Q*B.                        SLAP........240400
C                                                                        SLAP........240500
      DO 20 K = 1, N                                                     SLAP........240600
         KP1 = K + 1                                                     SLAP........240700
         IQ = 2*(K-1) + 1                                                SLAP........240800
         C = Q(IQ)                                                       SLAP........240900
         S = Q(IQ+1)                                                     SLAP........241000
         T1 = B(K)                                                       SLAP........241100
         T2 = B(KP1)                                                     SLAP........241200
         B(K) = C*T1 - S*T2                                              SLAP........241300
         B(KP1) = S*T1 + C*T2                                            SLAP........241400
 20   CONTINUE                                                           SLAP........241500
C                                                                        SLAP........241600
C         Now solve  R*X = Q*B.                                          SLAP........241700
C                                                                        SLAP........241800
      DO 40 KB = 1, N                                                    SLAP........241900
         K = N + 1 - KB                                                  SLAP........242000
         B(K) = B(K)/A(K,K)                                              SLAP........242100
         T = -B(K)                                                       SLAP........242200
         CALL DAXPY(K-1, T, A(1,K), 1, B(1), 1)                          SLAP........242300
 40   CONTINUE                                                           SLAP........242400
      RETURN                                                             SLAP........242500
C------------- LAST LINE OF DHELS FOLLOWS ----------------------------   SLAP........242600
      END                                                                SLAP........242700
*DECK DHEQR                                                              SLAP........242800
      SUBROUTINE DHEQR (A, LDA, N, Q, INFO, IJOB)                        SLAP........242900
C***BEGIN PROLOGUE  DHEQR                                                SLAP........243000
C***SUBSIDIARY                                                           SLAP........243100
C***PURPOSE  Internal routine for DGMRES.                                SLAP........243200
C***LIBRARY   SLATEC (SLAP)                                              SLAP........243300
C***CATEGORY  D2A4, D2B4                                                 SLAP........243400
C***TYPE      DOUBLE PRECISION (SHEQR-S, DHEQR-D)                        SLAP........243500
C***KEYWORDS  GENERALIZED MINIMUM RESIDUAL, ITERATIVE PRECONDITION,      SLAP........243600
C             NON-SYMMETRIC LINEAR SYSTEM, SLAP, SPARSE                  SLAP........243700
C***AUTHOR  Brown, Peter, (LLNL), pnbrown@llnl.gov                       SLAP........243800
C           Hindmarsh, Alan, (LLNL), alanh@llnl.gov                      SLAP........243900
C           Seager, Mark K., (LLNL), seager@llnl.gov                     SLAP........244000
C             Lawrence Livermore National Laboratory                     SLAP........244100
C             PO Box 808, L-60                                           SLAP........244200
C             Livermore, CA 94550 (510) 423-3141                         SLAP........244300
C***DESCRIPTION                                                          SLAP........244400
C        This   routine  performs  a QR   decomposition  of an  upper    SLAP........244500
C        Hessenberg matrix A using Givens  rotations.  There  are two    SLAP........244600
C        options  available: 1)  Performing  a fresh decomposition 2)    SLAP........244700
C        updating the QR factors by adding a row and  a column to the    SLAP........244800
C        matrix A.                                                       SLAP........244900
C                                                                        SLAP........245000
C *Usage:                                                                SLAP........245100
C      INTEGER LDA, N, INFO, IJOB                                        SLAP........245200
C      DOUBLE PRECISION A(LDA,N), Q(2*N)                                 SLAP........245300
C                                                                        SLAP........245400
C      CALL DHEQR(A, LDA, N, Q, INFO, IJOB)                              SLAP........245500
C                                                                        SLAP........245600
C *Arguments:                                                            SLAP........245700
C A      :INOUT    Double Precision A(LDA,N)                             SLAP........245800
C         On input, the matrix to be decomposed.                         SLAP........245900
C         On output, the upper triangular matrix R.                      SLAP........246000
C         The factorization can be written Q*A = R, where                SLAP........246100
C         Q is a product of Givens rotations and R is upper              SLAP........246200
C         triangular.                                                    SLAP........246300
C LDA    :IN       Integer                                               SLAP........246400
C         The leading dimension of the array A.                          SLAP........246500
C N      :IN       Integer                                               SLAP........246600
C         A is an (N+1) by N Hessenberg matrix.                          SLAP........246700
C Q      :OUT      Double Precision Q(2*N)                               SLAP........246800
C         The factors c and s of each Givens rotation used               SLAP........246900
C         in decomposing A.                                              SLAP........247000
C INFO   :OUT      Integer                                               SLAP........247100
C         = 0  normal value.                                             SLAP........247200
C         = K  if  A(K,K) .eq. 0.0 .  This is not an error               SLAP........247300
C           condition for this subroutine, but it does                   SLAP........247400
C           indicate that DHELS will divide by zero                      SLAP........247500
C           if called.                                                   SLAP........247600
C IJOB   :IN       Integer                                               SLAP........247700
C         = 1     means that a fresh decomposition of the                SLAP........247800
C                 matrix A is desired.                                   SLAP........247900
C         .ge. 2  means that the current decomposition of A              SLAP........248000
C                 will be updated by the addition of a row               SLAP........248100
C                 and a column.                                          SLAP........248200
C                                                                        SLAP........248300
C***SEE ALSO  DGMRES                                                     SLAP........248400
C***ROUTINES CALLED  (NONE)                                              SLAP........248500
C***REVISION HISTORY  (YYMMDD)                                           SLAP........248600
C   890404  DATE WRITTEN                                                 SLAP........248700
C   890404  Previous REVISION DATE                                       SLAP........248800
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........248900
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........249000
C           standard.  (FNF)                                             SLAP........249100
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........249200
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........249300
C   910506  Made subsidiary to DGMRES.  (FNF)                            SLAP........249400
C   920511  Added complete declaration section.  (WRB)                   SLAP........249500
C***END PROLOGUE  DHEQR                                                  SLAP........249600
C         The following is for optimized compilation on LLNL/LTSS Crays. SLAP........249700
CLLL. OPTIMIZE                                                           SLAP........249800
C     .. Scalar Arguments ..                                             SLAP........249900
      INTEGER IJOB, INFO, LDA, N                                         SLAP........250000
C     .. Array Arguments ..                                              SLAP........250100
      DOUBLE PRECISION A(LDA,*), Q(*)                                    SLAP........250200
C     .. Local Scalars ..                                                SLAP........250300
      DOUBLE PRECISION C, S, T, T1, T2                                   SLAP........250400
      INTEGER I, IQ, J, K, KM1, KP1, NM1                                 SLAP........250500
C     .. Intrinsic Functions ..                                          SLAP........250600
      INTRINSIC ABS, SQRT                                                SLAP........250700
C***FIRST EXECUTABLE STATEMENT  DHEQR                                    SLAP........250800
      IF (IJOB .GT. 1) GO TO 70                                          SLAP........250900
C   -------------------------------------------------------------------  SLAP........251000
C         A new factorization is desired.                                SLAP........251100
C   -------------------------------------------------------------------  SLAP........251200
C         QR decomposition without pivoting.                             SLAP........251300
C                                                                        SLAP........251400
      INFO = 0                                                           SLAP........251500
      DO 60 K = 1, N                                                     SLAP........251600
         KM1 = K - 1                                                     SLAP........251700
         KP1 = K + 1                                                     SLAP........251800
C                                                                        SLAP........251900
C           Compute K-th column of R.                                    SLAP........252000
C           First, multiply the K-th column of A by the previous         SLAP........252100
C           K-1 Givens rotations.                                        SLAP........252200
C                                                                        SLAP........252300
         IF (KM1 .LT. 1) GO TO 20                                        SLAP........252400
         DO 10 J = 1, KM1                                                SLAP........252500
            I = 2*(J-1) + 1                                              SLAP........252600
            T1 = A(J,K)                                                  SLAP........252700
            T2 = A(J+1,K)                                                SLAP........252800
            C = Q(I)                                                     SLAP........252900
            S = Q(I+1)                                                   SLAP........253000
            A(J,K) = C*T1 - S*T2                                         SLAP........253100
            A(J+1,K) = S*T1 + C*T2                                       SLAP........253200
 10      CONTINUE                                                        SLAP........253300
C                                                                        SLAP........253400
C         Compute Givens components C and S.                             SLAP........253500
C                                                                        SLAP........253600
 20      CONTINUE                                                        SLAP........253700
         IQ = 2*KM1 + 1                                                  SLAP........253800
         T1 = A(K,K)                                                     SLAP........253900
         T2 = A(KP1,K)                                                   SLAP........254000
         IF( T2.EQ.0.0D0 ) THEN                                          SLAP........254100
            C = 1                                                        SLAP........254200
            S = 0                                                        SLAP........254300
         ELSEIF( ABS(T2).GE.ABS(T1) ) THEN                               SLAP........254400
            T = T1/T2                                                    SLAP........254500
            S = -1.0D0/SQRT(1.0D0+T*T)                                   SLAP........254600
            C = -S*T                                                     SLAP........254700
         ELSE                                                            SLAP........254800
            T = T2/T1                                                    SLAP........254900
            C = 1.0D0/SQRT(1.0D0+T*T)                                    SLAP........255000
            S = -C*T                                                     SLAP........255100
         ENDIF                                                           SLAP........255200
         Q(IQ) = C                                                       SLAP........255300
         Q(IQ+1) = S                                                     SLAP........255400
         A(K,K) = C*T1 - S*T2                                            SLAP........255500
         IF( A(K,K).EQ.0.0D0 ) INFO = K                                  SLAP........255600
 60   CONTINUE                                                           SLAP........255700
      RETURN                                                             SLAP........255800
C   -------------------------------------------------------------------  SLAP........255900
C         The old factorization of a will be updated.  A row and a       SLAP........256000
C         column has been added to the matrix A.  N by N-1 is now        SLAP........256100
C         the old size of the matrix.                                    SLAP........256200
C   -------------------------------------------------------------------  SLAP........256300
 70   CONTINUE                                                           SLAP........256400
      NM1 = N - 1                                                        SLAP........256500
C   -------------------------------------------------------------------  SLAP........256600
C         Multiply the new column by the N previous Givens rotations.    SLAP........256700
C   -------------------------------------------------------------------  SLAP........256800
      DO 100 K = 1,NM1                                                   SLAP........256900
         I = 2*(K-1) + 1                                                 SLAP........257000
         T1 = A(K,N)                                                     SLAP........257100
         T2 = A(K+1,N)                                                   SLAP........257200
         C = Q(I)                                                        SLAP........257300
         S = Q(I+1)                                                      SLAP........257400
         A(K,N) = C*T1 - S*T2                                            SLAP........257500
         A(K+1,N) = S*T1 + C*T2                                          SLAP........257600
 100  CONTINUE                                                           SLAP........257700
C   -------------------------------------------------------------------  SLAP........257800
C         Complete update of decomposition by forming last Givens        SLAP........257900
C         rotation, and multiplying it times the column                  SLAP........258000
C         vector(A(N,N),A(NP1,N)).                                       SLAP........258100
C   -------------------------------------------------------------------  SLAP........258200
      INFO = 0                                                           SLAP........258300
      T1 = A(N,N)                                                        SLAP........258400
      T2 = A(N+1,N)                                                      SLAP........258500
      IF ( T2.EQ.0.0D0 ) THEN                                            SLAP........258600
         C = 1                                                           SLAP........258700
         S = 0                                                           SLAP........258800
      ELSEIF( ABS(T2).GE.ABS(T1) ) THEN                                  SLAP........258900
         T = T1/T2                                                       SLAP........259000
         S = -1.0D0/SQRT(1.0D0+T*T)                                      SLAP........259100
         C = -S*T                                                        SLAP........259200
      ELSE                                                               SLAP........259300
         T = T2/T1                                                       SLAP........259400
         C = 1.0D0/SQRT(1.0D0+T*T)                                       SLAP........259500
         S = -C*T                                                        SLAP........259600
      ENDIF                                                              SLAP........259700
      IQ = 2*N - 1                                                       SLAP........259800
      Q(IQ) = C                                                          SLAP........259900
      Q(IQ+1) = S                                                        SLAP........260000
      A(N,N) = C*T1 - S*T2                                               SLAP........260100
      IF (A(N,N) .EQ. 0.0D0) INFO = N                                    SLAP........260200
      RETURN                                                             SLAP........260300
C------------- LAST LINE OF DHEQR FOLLOWS ----------------------------   SLAP........260400
      END                                                                SLAP........260500
*DECK DLLTI2                                                             SLAP........260600
      SUBROUTINE DLLTI2 (N, B, X, NEL, IEL, JEL, EL, DINV)               SLAP........260700
C***BEGIN PROLOGUE  DLLTI2                                               SLAP........260800
C***PURPOSE  SLAP Backsolve routine for LDL' Factorization.              SLAP........260900
C            Routine to solve a system of the form  L*D*L' X = B,        SLAP........261000
C            where L is a unit lower triangular matrix and D is a        SLAP........261100
C            diagonal matrix and ' means transpose.                      SLAP........261200
C***LIBRARY   SLATEC (SLAP)                                              SLAP........261300
C***CATEGORY  D2E                                                        SLAP........261400
C***TYPE      DOUBLE PRECISION (SLLTI2-S, DLLTI2-D)                      SLAP........261500
C***KEYWORDS  INCOMPLETE FACTORIZATION, ITERATIVE PRECONDITION, SLAP,    SLAP........261600
C             SPARSE, SYMMETRIC LINEAR SYSTEM SOLVE                      SLAP........261700
C***AUTHOR  Greenbaum, Anne, (Courant Institute)                         SLAP........261800
C           Seager, Mark K., (LLNL)                                      SLAP........261900
C             Lawrence Livermore National Laboratory                     SLAP........262000
C             PO BOX 808, L-60                                           SLAP........262100
C             Livermore, CA 94550 (510) 423-3141                         SLAP........262200
C             seager@llnl.gov                                            SLAP........262300
C***DESCRIPTION                                                          SLAP........262400
C                                                                        SLAP........262500
C *Usage:                                                                SLAP........262600
C     INTEGER N, NEL, IEL(NEL), JEL(NEL)                                 SLAP........262700
C     DOUBLE PRECISION B(N), X(N), EL(NEL), DINV(N)                      SLAP........262800
C                                                                        SLAP........262900
C     CALL DLLTI2( N, B, X, NEL, IEL, JEL, EL, DINV )                    SLAP........263000
C                                                                        SLAP........263100
C *Arguments:                                                            SLAP........263200
C N      :IN       Integer                                               SLAP........263300
C         Order of the Matrix.                                           SLAP........263400
C B      :IN       Double Precision B(N).                                SLAP........263500
C         Right hand side vector.                                        SLAP........263600
C X      :OUT      Double Precision X(N).                                SLAP........263700
C         Solution to L*D*L' x = b.                                      SLAP........263800
C NEL    :IN       Integer.                                              SLAP........263900
C         Number of non-zeros in the EL array.                           SLAP........264000
C IEL    :IN       Integer IEL(NEL).                                     SLAP........264100
C JEL    :IN       Integer JEL(NEL).                                     SLAP........264200
C EL     :IN       Double Precision     EL(NEL).                         SLAP........264300
C         IEL, JEL, EL contain the unit lower triangular factor   of     SLAP........264400
C         the incomplete decomposition   of the A  matrix  stored in     SLAP........264500
C         SLAP Row format.   The diagonal of ones *IS* stored.  This     SLAP........264600
C         structure can be set  up  by  the DS2LT routine.  See  the     SLAP........264700
C         "Description", below for more details about the  SLAP  Row     SLAP........264800
C         format.                                                        SLAP........264900
C DINV   :IN       Double Precision DINV(N).                             SLAP........265000
C         Inverse of the diagonal matrix D.                              SLAP........265100
C                                                                        SLAP........265200
C *Description:                                                          SLAP........265300
C       This routine is supplied with  the SLAP package as a routine     SLAP........265400
C       to perform the MSOLVE operation in the SCG iteration routine     SLAP........265500
C       for  the driver  routine DSICCG.   It must be called via the     SLAP........265600
C       SLAP  MSOLVE calling sequence  convention  interface routine     SLAP........265700
C       DSLLI.                                                           SLAP........265800
C         **** THIS ROUTINE ITSELF DOES NOT CONFORM TO THE ****          SLAP........265900
C               **** SLAP MSOLVE CALLING CONVENTION ****                 SLAP........266000
C                                                                        SLAP........266100
C       IEL, JEL, EL should contain the unit lower triangular factor     SLAP........266200
C       of  the incomplete decomposition of  the A matrix  stored in     SLAP........266300
C       SLAP Row format.   This IC factorization  can be computed by     SLAP........266400
C       the  DSICS routine.  The  diagonal  (which is all one's) is      SLAP........266500
C       stored.                                                          SLAP........266600
C                                                                        SLAP........266700
C       ==================== S L A P Row format ====================     SLAP........266800
C                                                                        SLAP........266900
C       This routine requires  that the matrix A  be  stored  in the     SLAP........267000
C       SLAP  Row format.   In this format  the non-zeros are stored     SLAP........267100
C       counting across  rows (except for the diagonal  entry, which     SLAP........267200
C       must  appear first  in each  "row")  and  are stored  in the     SLAP........267300
C       double precision  array A.  In other words, for each row  in     SLAP........267400
C       the matrix  put the diagonal  entry in A.   Then put in  the     SLAP........267500
C       other  non-zero elements  going across  the row  (except the     SLAP........267600
C       diagonal) in order.  The JA array holds the column index for     SLAP........267700
C       each non-zero.  The IA array holds the offsets  into the JA,     SLAP........267800
C       A  arrays  for  the   beginning  of  each  row.    That  is,     SLAP........267900
C       JA(IA(IROW)),A(IA(IROW)) are the first elements of the IROW-     SLAP........268000
C       th row in  JA and A,  and  JA(IA(IROW+1)-1), A(IA(IROW+1)-1)     SLAP........268100
C       are  the last elements  of the  IROW-th row.   Note  that we     SLAP........268200
C       always have  IA(N+1) = NELT+1, where N is the number of rows     SLAP........268300
C       in the matrix  and  NELT is the  number of non-zeros  in the     SLAP........268400
C       matrix.                                                          SLAP........268500
C                                                                        SLAP........268600
C       Here is an example of the SLAP Row storage format for a  5x5     SLAP........268700
C       Matrix (in the A and JA arrays '|' denotes the end of a row):    SLAP........268800
C                                                                        SLAP........268900
C           5x5 Matrix         SLAP Row format for 5x5 matrix on left.   SLAP........269000
C                              1  2  3    4  5    6  7    8    9 10 11   SLAP........269100
C       |11 12  0  0 15|   A: 11 12 15 | 22 21 | 33 35 | 44 | 55 51 53   SLAP........269200
C       |21 22  0  0  0|  JA:  1  2  5 |  2  1 |  3  5 |  4 |  5  1  3   SLAP........269300
C       | 0  0 33  0 35|  IA:  1  4  6    8  9   12                      SLAP........269400
C       | 0  0  0 44  0|                                                 SLAP........269500
C       |51  0 53  0 55|                                                 SLAP........269600
C                                                                        SLAP........269700
C       With  the SLAP  Row format  the "inner loop" of this routine     SLAP........269800
C       should vectorize   on machines with   hardware  support  for     SLAP........269900
C       vector gather/scatter operations.  Your compiler may require     SLAP........270000
C       a  compiler directive  to  convince   it that there  are  no     SLAP........270100
C       implicit vector  dependencies.  Compiler directives  for the     SLAP........270200
C       Alliant FX/Fortran and CRI CFT/CFT77 compilers  are supplied     SLAP........270300
C       with the standard SLAP distribution.                             SLAP........270400
C                                                                        SLAP........270500
C***SEE ALSO  DSICCG, DSICS                                              SLAP........270600
C***REFERENCES  (NONE)                                                   SLAP........270700
C***ROUTINES CALLED  (NONE)                                              SLAP........270800
C***REVISION HISTORY  (YYMMDD)                                           SLAP........270900
C   871119  DATE WRITTEN                                                 SLAP........271000
C   881213  Previous REVISION DATE                                       SLAP........271100
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........271200
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........271300
C           standard.  (FNF)                                             SLAP........271400
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........271500
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........271600
C   920511  Added complete declaration section.  (WRB)                   SLAP........271700
C   921113  Corrected C***CATEGORY line.  (FNF)                          SLAP........271800
C   930701  Updated CATEGORY section.  (FNF, WRB)                        SLAP........271900
C***END PROLOGUE  DLLTI2                                                 SLAP........272000
C     .. Scalar Arguments ..                                             SLAP........272100
      INTEGER N, NEL                                                     SLAP........272200
C     .. Array Arguments ..                                              SLAP........272300
      DOUBLE PRECISION B(N), DINV(N), EL(NEL), X(N)                      SLAP........272400
      INTEGER IEL(NEL), JEL(NEL)                                         SLAP........272500
C     .. Local Scalars ..                                                SLAP........272600
      INTEGER I, IBGN, IEND, IROW                                        SLAP........272700
C***FIRST EXECUTABLE STATEMENT  DLLTI2                                   SLAP........272800
C                                                                        SLAP........272900
C         Solve  L*y = b,  storing result in x.                          SLAP........273000
C                                                                        SLAP........273100
      DO 10 I=1,N                                                        SLAP........273200
         X(I) = B(I)                                                     SLAP........273300
 10   CONTINUE                                                           SLAP........273400
      DO 30 IROW = 1, N                                                  SLAP........273500
         IBGN = IEL(IROW) + 1                                            SLAP........273600
         IEND = IEL(IROW+1) - 1                                          SLAP........273700
         IF( IBGN.LE.IEND ) THEN                                         SLAP........273800
CLLL. OPTION ASSERT (NOHAZARD)                                           SLAP........273900
CDIR$ IVDEP                                                              SLAP........274000
CVD$ NOCONCUR                                                            SLAP........274100
CVD$ NODEPCHK                                                            SLAP........274200
            DO 20 I = IBGN, IEND                                         SLAP........274300
               X(IROW) = X(IROW) - EL(I)*X(JEL(I))                       SLAP........274400
 20         CONTINUE                                                     SLAP........274500
         ENDIF                                                           SLAP........274600
 30   CONTINUE                                                           SLAP........274700
C                                                                        SLAP........274800
C         Solve  D*Z = Y,  storing result in X.                          SLAP........274900
C                                                                        SLAP........275000
      DO 40 I=1,N                                                        SLAP........275100
         X(I) = X(I)*DINV(I)                                             SLAP........275200
 40   CONTINUE                                                           SLAP........275300
C                                                                        SLAP........275400
C         Solve  L-trans*X = Z.                                          SLAP........275500
C                                                                        SLAP........275600
      DO 60 IROW = N, 2, -1                                              SLAP........275700
         IBGN = IEL(IROW) + 1                                            SLAP........275800
         IEND = IEL(IROW+1) - 1                                          SLAP........275900
         IF( IBGN.LE.IEND ) THEN                                         SLAP........276000
CLLL. OPTION ASSERT (NOHAZARD)                                           SLAP........276100
CDIR$ IVDEP                                                              SLAP........276200
CVD$ NOCONCUR                                                            SLAP........276300
CVD$ NODEPCHK                                                            SLAP........276400
            DO 50 I = IBGN, IEND                                         SLAP........276500
               X(JEL(I)) = X(JEL(I)) - EL(I)*X(IROW)                     SLAP........276600
 50         CONTINUE                                                     SLAP........276700
         ENDIF                                                           SLAP........276800
 60   CONTINUE                                                           SLAP........276900
C                                                                        SLAP........277000
      RETURN                                                             SLAP........277100
C------------- LAST LINE OF DLLTI2 FOLLOWS ----------------------------  SLAP........277200
      END                                                                SLAP........277300
*DECK DNRM2                                                              SLAP........277400
      DOUBLE PRECISION FUNCTION DNRM2 (N, DX, INCX)                      SLAP........277500
C***BEGIN PROLOGUE  DNRM2                                                SLAP........277600
C***PURPOSE  Compute the Euclidean length (L2 norm) of a vector.         SLAP........277700
C***LIBRARY   SLATEC (BLAS)                                              SLAP........277800
C***CATEGORY  D1A3B                                                      SLAP........277900
C***TYPE      DOUBLE PRECISION (SNRM2-S, DNRM2-D, SCNRM2-C)              SLAP........278000
C***KEYWORDS  BLAS, EUCLIDEAN LENGTH, EUCLIDEAN NORM, L2,                SLAP........278100
C             LINEAR ALGEBRA, UNITARY, VECTOR                            SLAP........278200
C***AUTHOR  Lawson, C. L., (JPL)                                         SLAP........278300
C           Hanson, R. J., (SNLA)                                        SLAP........278400
C           Kincaid, D. R., (U. of Texas)                                SLAP........278500
C           Krogh, F. T., (JPL)                                          SLAP........278600
C***DESCRIPTION                                                          SLAP........278700
C                                                                        SLAP........278800
C                B L A S  Subprogram                                     SLAP........278900
C    Description of parameters                                           SLAP........279000
C                                                                        SLAP........279100
C     --Input--                                                          SLAP........279200
C        N  number of elements in input vector(s)                        SLAP........279300
C       DX  double precision vector with N elements                      SLAP........279400
C     INCX  storage spacing between elements of DX                       SLAP........279500
C                                                                        SLAP........279600
C     --Output--                                                         SLAP........279700
C    DNRM2  double precision result (zero if N .LE. 0)                   SLAP........279800
C                                                                        SLAP........279900
C     Euclidean norm of the N-vector stored in DX with storage           SLAP........280000
C     increment INCX.                                                    SLAP........280100
C     If N .LE. 0, return with result = 0.                               SLAP........280200
C     If N .GE. 1, then INCX must be .GE. 1                              SLAP........280300
C                                                                        SLAP........280400
C     Four phase method using two built-in constants that are            SLAP........280500
C     hopefully applicable to all machines.                              SLAP........280600
C         CUTLO = maximum of  SQRT(U/EPS)  over all known machines.      SLAP........280700
C         CUTHI = minimum of  SQRT(V)      over all known machines.      SLAP........280800
C     where                                                              SLAP........280900
C         EPS = smallest no. such that EPS + 1. .GT. 1.                  SLAP........281000
C         U   = smallest positive no.   (underflow limit)                SLAP........281100
C         V   = largest  no.            (overflow  limit)                SLAP........281200
C                                                                        SLAP........281300
C     Brief outline of algorithm.                                        SLAP........281400
C                                                                        SLAP........281500
C     Phase 1 scans zero components.                                     SLAP........281600
C     move to phase 2 when a component is nonzero and .LE. CUTLO         SLAP........281700
C     move to phase 3 when a component is .GT. CUTLO                     SLAP........281800
C     move to phase 4 when a component is .GE. CUTHI/M                   SLAP........281900
C     where M = N for X() real and M = 2*N for complex.                  SLAP........282000
C                                                                        SLAP........282100
C     Values for CUTLO and CUTHI.                                        SLAP........282200
C     From the environmental parameters listed in the IMSL converter     SLAP........282300
C     document the limiting values are as follows:                       SLAP........282400
C     CUTLO, S.P.   U/EPS = 2**(-102) for  Honeywell.  Close seconds are SLAP........282500
C                   Univac and DEC at 2**(-103)                          SLAP........282600
C                   Thus CUTLO = 2**(-51) = 4.44089E-16                  SLAP........282700
C     CUTHI, S.P.   V = 2**127 for Univac, Honeywell, and DEC.           SLAP........282800
C                   Thus CUTHI = 2**(63.5) = 1.30438E19                  SLAP........282900
C     CUTLO, D.P.   U/EPS = 2**(-67) for Honeywell and DEC.              SLAP........283000
C                   Thus CUTLO = 2**(-33.5) = 8.23181D-11                SLAP........283100
C     CUTHI, D.P.   same as S.P.  CUTHI = 1.30438D19                     SLAP........283200
C     DATA CUTLO, CUTHI /8.232D-11,  1.304D19/                           SLAP........283300
C     DATA CUTLO, CUTHI /4.441E-16,  1.304E19/                           SLAP........283400
C                                                                        SLAP........283500
C***REFERENCES  C. L. Lawson, R. J. Hanson, D. R. Kincaid and F. T.      SLAP........283600
C                 Krogh, Basic linear algebra subprograms for Fortran    SLAP........283700
C                 usage, Algorithm No. 539, Transactions on Mathematical SLAP........283800
C                 Software 5, 3 (September 1979), pp. 308-323.           SLAP........283900
C***ROUTINES CALLED  (NONE)                                              SLAP........284000
C***REVISION HISTORY  (YYMMDD)                                           SLAP........284100
C   791001  DATE WRITTEN                                                 SLAP........284200
C   890531  Changed all specific intrinsics to generic.  (WRB)           SLAP........284300
C   890831  Modified array declarations.  (WRB)                          SLAP........284400
C   890831  REVISION DATE from Version 3.2                               SLAP........284500
C   891214  Prologue converted to Version 4.0 format.  (BAB)             SLAP........284600
C   920501  Reformatted the REFERENCES section.  (WRB)                   SLAP........284700
C***END PROLOGUE  DNRM2                                                  SLAP........284800
CM  SEVERAL LINES HAVE BEEN MODIFIED TO BE COMPATIBLE WITH HPC (MAINLY DUE TO ASSIGN COMMAND)
      INTEGER NEXT                                                       SLAP........284900
      DOUBLE PRECISION DX(*), CUTLO, CUTHI, HITEST, SUM, XMAX, ZERO,     SLAP........285000
     +                 ONE                                               SLAP........285100
      SAVE CUTLO, CUTHI, ZERO, ONE                                       SLAP........285200
      DATA ZERO, ONE /0.0D0, 1.0D0/                                      SLAP........285300
C                                                                        SLAP........285400
      DATA CUTLO, CUTHI /8.232D-11,  1.304D19/                           SLAP........285500
C***FIRST EXECUTABLE STATEMENT  DNRM2                                    SLAP........285600
      IF (N .GT. 0) GO TO 10                                             SLAP........285700
         DNRM2  = ZERO                                                   SLAP........285800
         GO TO 300                                                       SLAP........285900
C                                                                        SLAP........286000
CM   10 ASSIGN 30 TO NEXT                                                  SLAP........286100
10      NEXT=30
      SUM = ZERO                                                         SLAP........286200
      NN = N * INCX                                                      SLAP........286300
C                                                                        SLAP........286400
C                                                 BEGIN MAIN LOOP        SLAP........286500
C                                                                        SLAP........286600
      I = 1                                                              SLAP........286700
CM   20    GO TO NEXT,(30, 50, 70, 110)                                    SLAP........286800
20      IF (NEXT.EQ.30) THEN
      GOTO 30
      ELSEIF (NEXT.EQ.50) THEN
      GOTO 50
      ELSEIF (NEXT.EQ.70) THEN
      GOTO 70
      ELSEIF (NEXT.EQ.110) THEN
      GOTO 110
      ENDIF
   30 IF (ABS(DX(I)) .GT. CUTLO) GO TO 85                                SLAP........286900
CM      ASSIGN 50 TO NEXT                                                  SLAP........287000
      NEXT=50
      XMAX = ZERO                                                        SLAP........287100
C                                                                        SLAP........287200
C                        PHASE 1.  SUM IS ZERO                           SLAP........287300
C                                                                        SLAP........287400
   50 IF (DX(I) .EQ. ZERO) GO TO 200                                     SLAP........287500
      IF (ABS(DX(I)) .GT. CUTLO) GO TO 85                                SLAP........287600
C                                                                        SLAP........287700
C                                PREPARE FOR PHASE 2.                    SLAP........287800
C                                                                        SLAP........287900
CM      ASSIGN 70 TO NEXT                                                  SLAP........288000
      NEXT=70
      GO TO 105                                                          SLAP........288100
C                                                                        SLAP........288200
C                                PREPARE FOR PHASE 4.                    SLAP........288300
C                                                                        SLAP........288400
  100 I = J                                                              SLAP........288500
CM      ASSIGN 110 TO NEXT                                                 SLAP........288600
      NEXT=110
      SUM = (SUM / DX(I)) / DX(I)                                        SLAP........288700
  105 XMAX = ABS(DX(I))                                                  SLAP........288800
      GO TO 115                                                          SLAP........288900
C                                                                        SLAP........289000
C                   PHASE 2.  SUM IS SMALL.                              SLAP........289100
C                             SCALE TO AVOID DESTRUCTIVE UNDERFLOW.      SLAP........289200
C                                                                        SLAP........289300
   70 IF (ABS(DX(I)) .GT. CUTLO) GO TO 75                                SLAP........289400
C                                                                        SLAP........289500
C                     COMMON CODE FOR PHASES 2 AND 4.                    SLAP........289600
C                     IN PHASE 4 SUM IS LARGE.  SCALE TO AVOID OVERFLOW. SLAP........289700
C                                                                        SLAP........289800
  110 IF (ABS(DX(I)) .LE. XMAX) GO TO 115                                SLAP........289900
         SUM = ONE + SUM * (XMAX / DX(I))**2                             SLAP........290000
         XMAX = ABS(DX(I))                                               SLAP........290100
         GO TO 200                                                       SLAP........290200
C                                                                        SLAP........290300
  115 SUM = SUM + (DX(I)/XMAX)**2                                        SLAP........290400
      GO TO 200                                                          SLAP........290500
C                                                                        SLAP........290600
C                  PREPARE FOR PHASE 3.                                  SLAP........290700
C                                                                        SLAP........290800
   75 SUM = (SUM * XMAX) * XMAX                                          SLAP........290900
C                                                                        SLAP........291000
C     FOR REAL OR D.P. SET HITEST = CUTHI/N                              SLAP........291100
C     FOR COMPLEX      SET HITEST = CUTHI/(2*N)                          SLAP........291200
C                                                                        SLAP........291300
   85 HITEST = CUTHI / N                                                 SLAP........291400
C                                                                        SLAP........291500
C                   PHASE 3.  SUM IS MID-RANGE.  NO SCALING.             SLAP........291600
C                                                                        SLAP........291700
      DO 95 J = I,NN,INCX                                                SLAP........291800
      IF (ABS(DX(J)) .GE. HITEST) GO TO 100                              SLAP........291900
   95    SUM = SUM + DX(J)**2                                            SLAP........292000
      DNRM2 = SQRT(SUM)                                                  SLAP........292100
      GO TO 300                                                          SLAP........292200
C                                                                        SLAP........292300
  200 CONTINUE                                                           SLAP........292400
      I = I + INCX                                                       SLAP........292500
      IF (I .LE. NN) GO TO 20                                            SLAP........292600
C                                                                        SLAP........292700
C              END OF MAIN LOOP.                                         SLAP........292800
C                                                                        SLAP........292900
C              COMPUTE SQUARE ROOT AND ADJUST FOR SCALING.               SLAP........293000
C                                                                        SLAP........293100
      DNRM2 = XMAX * SQRT(SUM)                                           SLAP........293200
  300 CONTINUE                                                           SLAP........293300
      RETURN                                                             SLAP........293400
      END                                                                SLAP........293500
*DECK DOMN                                                               SLAP........293600
      SUBROUTINE DOMN (N, B, X, NELT, IA, JA, A, ISYM, MATVEC, MSOLVE,   SLAP........293700
     +   NSAVE, ITOL, TOL, ITMAX, ITER, ERR, IERR, IUNIT, R, Z, P, AP,   SLAP........293800
     +   EMAP, DZ, CSAV, RWORK, IWORK)                                   SLAP........293900
C***BEGIN PROLOGUE  DOMN                                                 SLAP........294000
C***PURPOSE  Preconditioned Orthomin Sparse Iterative Ax=b Solver.       SLAP........294100
C            Routine to solve a general linear system  Ax = b  using     SLAP........294200
C            the Preconditioned Orthomin method.                         SLAP........294300
C***LIBRARY   SLATEC (SLAP)                                              SLAP........294400
C***CATEGORY  D2A4, D2B4                                                 SLAP........294500
C***TYPE      DOUBLE PRECISION (SOMN-S, DOMN-D)                          SLAP........294600
C***KEYWORDS  ITERATIVE PRECONDITION, NON-SYMMETRIC LINEAR SYSTEM,       SLAP........294700
C             ORTHOMIN, SLAP, SPARSE                                     SLAP........294800
C***AUTHOR  Greenbaum, Anne, (Courant Institute)                         SLAP........294900
C           Seager, Mark K., (LLNL)                                      SLAP........295000
C             Lawrence Livermore National Laboratory                     SLAP........295100
C             PO BOX 808, L-60                                           SLAP........295200
C             Livermore, CA 94550 (510) 423-3141                         SLAP........295300
C             seager@llnl.gov                                            SLAP........295400
C***DESCRIPTION                                                          SLAP........295500
C                                                                        SLAP........295600
C *Usage:                                                                SLAP........295700
C     INTEGER  N, NELT, IA(NELT), JA(NELT), ISYM, NSAVE, ITOL, ITMAX     SLAP........295800
C     INTEGER  ITER, IERR, IUNIT, IWORK(USER DEFINED)                    SLAP........295900
C     DOUBLE PRECISION B(N), X(N), A(NELT), TOL, ERR, R(N), Z(N)         SLAP........296000
C     DOUBLE PRECISION P(N,0:NSAVE), AP(N,0:NSAVE), EMAP(N,0:NSAVE)      SLAP........296100
C     DOUBLE PRECISION DZ(N), CSAV(NSAVE), RWORK(USER DEFINED)           SLAP........296200
C     EXTERNAL MATVEC, MSOLVE                                            SLAP........296300
C                                                                        SLAP........296400
C     CALL DOMN(N, B, X, NELT, IA, JA, A, ISYM, MATVEC, MSOLVE,          SLAP........296500
C    $     NSAVE, ITOL, TOL, ITMAX, ITER, ERR, IERR, IUNIT, R,           SLAP........296600
C    $     Z, P, AP, EMAP, DZ, CSAV, RWORK, IWORK)                       SLAP........296700
C                                                                        SLAP........296800
C *Arguments:                                                            SLAP........296900
C N      :IN       Integer.                                              SLAP........297000
C         Order of the Matrix.                                           SLAP........297100
C B      :IN       Double Precision B(N).                                SLAP........297200
C         Right-hand side vector.                                        SLAP........297300
C X      :INOUT    Double Precision X(N).                                SLAP........297400
C         On input X is your initial guess for solution vector.          SLAP........297500
C         On output X is the final approximate solution.                 SLAP........297600
C NELT   :IN       Integer.                                              SLAP........297700
C         Number of Non-Zeros stored in A.                               SLAP........297800
C IA     :IN       Integer IA(NELT).                                     SLAP........297900
C JA     :IN       Integer JA(NELT).                                     SLAP........298000
C A      :IN       Double Precision A(NELT).                             SLAP........298100
C         These arrays contain the matrix data structure for A.          SLAP........298200
C         It could take any form.  See "Description", below, for more    SLAP........298300
C         details.                                                       SLAP........298400
C ISYM   :IN       Integer.                                              SLAP........298500
C         Flag to indicate symmetric storage format.                     SLAP........298600
C         If ISYM=0, all non-zero entries of the matrix are stored.      SLAP........298700
C         If ISYM=1, the matrix is symmetric, and only the upper         SLAP........298800
C         or lower triangle of the matrix is stored.                     SLAP........298900
C MATVEC :EXT      External.                                             SLAP........299000
C         Name of a routine which performs the matrix vector multiply    SLAP........299100
C         Y = A*X given A and X.  The name of the MATVEC routine must    SLAP........299200
C         be declared external in the calling program.  The calling      SLAP........299300
C         sequence to MATVEC is:                                         SLAP........299400
C             CALL MATVEC( N, X, Y, NELT, IA, JA, A, ISYM )              SLAP........299500
C         Where N is the number of unknowns, Y is the product A*X        SLAP........299600
C         upon return X is an input vector, NELT is the number of        SLAP........299700
C         non-zeros in the SLAP IA, JA, A storage for the matrix A.      SLAP........299800
C         ISYM is a flag which, if non-zero, denotest that A is          SLAP........299900
C         symmetric and only the lower or upper triangle is stored.      SLAP........300000
C MSOLVE :EXT      External.                                             SLAP........300100
C         Name of a routine which solves a linear system MZ = R for      SLAP........300200
C         Z given R with the preconditioning matrix M (M is supplied via SLAP........300300
C         RWORK and IWORK arrays).  The name of the MSOLVE routine must  SLAP........300400
C         be declared external in the calling program.  The calling      SLAP........300500
C         sequence to MSOLVE is:                                         SLAP........300600
C             CALL MSOLVE(N, R, Z, NELT, IA, JA, A, ISYM, RWORK, IWORK)  SLAP........300700
C         Where N is the number of unknowns, R is the right-hand side    SLAP........300800
C         vector and Z is the solution upon return.  NELT, IA, JA, A and SLAP........300900
C         ISYM are defined as above.  RWORK is a double precision array  SLAP........301000
C         that can be used to pass necessary preconditioning information SLAP........301100
C         and/or workspace to MSOLVE.  IWORK is an integer work array    SLAP........301200
C         for the same purpose as RWORK.                                 SLAP........301300
C NSAVE  :IN       Integer.                                              SLAP........301400
C         Number of  direction vectors to save and orthogonalize         SLAP........301500
C         against.  NSAVE >= 0.                                          SLAP........301600
C ITOL   :IN       Integer.                                              SLAP........301700
C         Flag to indicate type of convergence criterion.                SLAP........301800
C         If ITOL=1, iteration stops when the 2-norm of the residual     SLAP........301900
C         divided by the 2-norm of the right-hand side is less than TOL. SLAP........302000
C         If ITOL=2, iteration stops when the 2-norm of M-inv times the  SLAP........302100
C         residual divided by the 2-norm of M-inv times the right hand   SLAP........302200
C         side is less than TOL, where M-inv is the inverse of the       SLAP........302300
C         diagonal of A.                                                 SLAP........302400
C         ITOL=11 is often useful for checking and comparing different   SLAP........302500
C         routines.  For this case, the user must supply the "exact"     SLAP........302600
C         solution or a very accurate approximation (one with an error   SLAP........302700
C         much less than TOL) through a common block,                    SLAP........302800
C             COMMON /DSLBLK/ SOLN( )                                    SLAP........302900
C         If ITOL=11, iteration stops when the 2-norm of the difference  SLAP........303000
C         between the iterative approximation and the user-supplied      SLAP........303100
C         solution divided by the 2-norm of the user-supplied solution   SLAP........303200
C         is less than TOL.  Note that this requires the user to set up  SLAP........303300
C         the "COMMON /DSLBLK/ SOLN(LENGTH)" in the calling routine.     SLAP........303400
C         The routine with this declaration should be loaded before the  SLAP........303500
C         stop test so that the correct length is used by the loader.    SLAP........303600
C         This procedure is not standard Fortran and may not work        SLAP........303700
C         correctly on your system (although it has worked on every      SLAP........303800
C         system the authors have tried).  If ITOL is not 11 then this   SLAP........303900
C         common block is indeed standard Fortran.                       SLAP........304000
C TOL    :INOUT    Double Precision.                                     SLAP........304100
C         Convergence criterion, as described above.  (Reset if IERR=4.) SLAP........304200
C ITMAX  :IN       Integer.                                              SLAP........304300
C         Maximum number of iterations.                                  SLAP........304400
CC..THE NEXT FOUR COMMENT LINES *NOT* MARKED WITH "CC" WERE MODIFIED     SLAP........304500
CC    DURING INTEGRATION OF SLAP WITH SUTRA.  THEY ORIGINALLY READ:      SLAP........304600
CC  C ITER   :OUT      Integer.                                          SLAP........304700
CC  C         Number of iterations required to reach convergence, or     SLAP........304800
CC  C         ITMAX+1 if convergence criterion could not be achieved in  SLAP........304900
CC  C         ITMAX iterations.                                          SLAP........305000
C ITER   :OUT      Integer.                                              SLAP........305100
C         Number of iterations required to reach convergence, or         SLAP........305200
C         ITMAX if convergence criterion could not be achieved in        SLAP........305300
C         ITMAX iterations.                                              SLAP........305400
C ERR    :OUT      Double Precision.                                     SLAP........305500
C         Error estimate of error in final approximate solution, as      SLAP........305600
C         defined by ITOL.                                               SLAP........305700
C IERR   :OUT      Integer.                                              SLAP........305800
C         Return error flag.                                             SLAP........305900
C           IERR = 0 => All went well.                                   SLAP........306000
C           IERR = 1 => Insufficient space allocated for WORK or IWORK.  SLAP........306100
C           IERR = 2 => Method failed to converge in ITMAX steps.        SLAP........306200
C           IERR = 3 => Error in user input.                             SLAP........306300
C                       Check input values of N, ITOL.                   SLAP........306400
C           IERR = 4 => User error tolerance set too tight.              SLAP........306500
C                       Reset to 500*D1MACH(3).  Iteration proceeded.    SLAP........306600
C           IERR = 5 => Preconditioning matrix, M, is not positive       SLAP........306700
C                       definite.  (r,z) < 0.                            SLAP........306800
C           IERR = 6 => Breakdown of method detected.                    SLAP........306900
C                       (p,Ap) < epsilon**2.                             SLAP........307000
C IUNIT  :IN       Integer.                                              SLAP........307100
C         Unit number on which to write the error at each iteration,     SLAP........307200
C         if this is desired for monitoring convergence.  If unit        SLAP........307300
C         number is 0, no writing will occur.                            SLAP........307400
C R      :WORK     Double Precision R(N).                                SLAP........307500
C Z      :WORK     Double Precision Z(N).                                SLAP........307600
C P      :WORK     Double Precision P(N,0:NSAVE).                        SLAP........307700
C AP     :WORK     Double Precision AP(N,0:NSAVE).                       SLAP........307800
C EMAP   :WORK     Double Precision EMAP(N,0:NSAVE).                     SLAP........307900
C DZ     :WORK     Double Precision DZ(N).                               SLAP........308000
C CSAV   :WORK     Double Precision CSAV(NSAVE)                          SLAP........308100
C         Double Precision arrays used for workspace.                    SLAP........308200
C RWORK  :WORK     Double Precision RWORK(USER DEFINED).                 SLAP........308300
C         Double Precision array that can be used for workspace in       SLAP........308400
C         MSOLVE.                                                        SLAP........308500
C IWORK  :WORK     Integer IWORK(USER DEFINED).                          SLAP........308600
C         Integer array that can be used for workspace in MSOLVE.        SLAP........308700
C                                                                        SLAP........308800
C *Description                                                           SLAP........308900
C       This routine does  not care  what matrix data   structure is     SLAP........309000
C       used for  A and M.  It simply   calls  the MATVEC and MSOLVE     SLAP........309100
C       routines, with  the arguments as  described above.  The user     SLAP........309200
C       could write any type of structure and the appropriate MATVEC     SLAP........309300
C       and MSOLVE routines.  It is assumed  that A is stored in the     SLAP........309400
C       IA, JA, A  arrays in some fashion and  that M (or INV(M)) is     SLAP........309500
C       stored  in  IWORK  and  RWORK)  in  some fashion.   The SLAP     SLAP........309600
C       routines DSDOMN and DSLUOM are examples of this procedure.       SLAP........309700
C                                                                        SLAP........309800
C       Two  examples  of  matrix  data structures  are the: 1) SLAP     SLAP........309900
C       Triad  format and 2) SLAP Column format.                         SLAP........310000
C                                                                        SLAP........310100
C       =================== S L A P Triad format ===================     SLAP........310200
C       In  this   format only the  non-zeros are  stored.  They may     SLAP........310300
C       appear  in *ANY* order.   The user  supplies three arrays of     SLAP........310400
C       length NELT, where  NELT  is the number  of non-zeros in the     SLAP........310500
C       matrix:  (IA(NELT), JA(NELT),  A(NELT)).  For each  non-zero     SLAP........310600
C       the  user puts   the row  and  column index   of that matrix     SLAP........310700
C       element in the IA and JA arrays.  The  value of the non-zero     SLAP........310800
C       matrix  element is  placed in  the corresponding location of     SLAP........310900
C       the A  array.  This is  an extremely easy data  structure to     SLAP........311000
C       generate.  On  the other hand it  is  not too  efficient  on     SLAP........311100
C       vector  computers   for the  iterative  solution  of  linear     SLAP........311200
C       systems.  Hence, SLAP  changes this input  data structure to     SLAP........311300
C       the SLAP   Column  format for the  iteration (but   does not     SLAP........311400
C       change it back).                                                 SLAP........311500
C                                                                        SLAP........311600
C       Here is an example of the  SLAP Triad   storage format for a     SLAP........311700
C       5x5 Matrix.  Recall that the entries may appear in any order.    SLAP........311800
C                                                                        SLAP........311900
C           5x5 Matrix      SLAP Triad format for 5x5 matrix on left.    SLAP........312000
C                              1  2  3  4  5  6  7  8  9 10 11           SLAP........312100
C       |11 12  0  0 15|   A: 51 12 11 33 15 53 55 22 35 44 21           SLAP........312200
C       |21 22  0  0  0|  IA:  5  1  1  3  1  5  5  2  3  4  2           SLAP........312300
C       | 0  0 33  0 35|  JA:  1  2  1  3  5  3  5  2  5  4  1           SLAP........312400
C       | 0  0  0 44  0|                                                 SLAP........312500
C       |51  0 53  0 55|                                                 SLAP........312600
C                                                                        SLAP........312700
C       =================== S L A P Column format ==================     SLAP........312800
C                                                                        SLAP........312900
C       In  this format   the non-zeros are    stored counting  down     SLAP........313000
C       columns (except  for the diagonal  entry, which must  appear     SLAP........313100
C       first  in each "column") and are  stored in the  double pre-     SLAP........313200
C       cision array  A. In  other  words,  for each  column  in the     SLAP........313300
C       matrix  first put  the diagonal entry in A.  Then put in the     SLAP........313400
C       other non-zero  elements going  down the column  (except the     SLAP........313500
C       diagonal)  in order.  The IA array  holds the  row index for     SLAP........313600
C       each non-zero.  The JA array  holds the offsets into the IA,     SLAP........313700
C       A  arrays  for  the  beginning  of  each  column.  That  is,     SLAP........313800
C       IA(JA(ICOL)),A(JA(ICOL)) are the first elements of the ICOL-     SLAP........313900
C       th column in IA and A, and IA(JA(ICOL+1)-1), A(JA(ICOL+1)-1)     SLAP........314000
C       are  the last elements of the ICOL-th column.   Note that we     SLAP........314100
C       always have JA(N+1)=NELT+1, where N is the number of columns     SLAP........314200
C       in the matrix  and NELT  is the number  of non-zeros  in the     SLAP........314300
C       matrix.                                                          SLAP........314400
C                                                                        SLAP........314500
C       Here is an example of the  SLAP Column  storage format for a     SLAP........314600
C       5x5 Matrix (in the A and IA arrays '|'  denotes the end of a     SLAP........314700
C       column):                                                         SLAP........314800
C                                                                        SLAP........314900
C           5x5 Matrix      SLAP Column format for 5x5 matrix on left.   SLAP........315000
C                              1  2  3    4  5    6  7    8    9 10 11   SLAP........315100
C       |11 12  0  0 15|   A: 11 21 51 | 22 12 | 33 53 | 44 | 55 15 35   SLAP........315200
C       |21 22  0  0  0|  IA:  1  2  5 |  2  1 |  3  5 |  4 |  5  1  3   SLAP........315300
C       | 0  0 33  0 35|  JA:  1  4  6    8  9   12                      SLAP........315400
C       | 0  0  0 44  0|                                                 SLAP........315500
C       |51  0 53  0 55|                                                 SLAP........315600
C                                                                        SLAP........315700
C *Cautions:                                                             SLAP........315800
C     This routine will attempt to write to the Fortran logical output   SLAP........315900
C     unit IUNIT, if IUNIT .ne. 0.  Thus, the user must make sure that   SLAP........316000
C     this logical unit is attached to a file or terminal before calling SLAP........316100
C     this routine with a non-zero value for IUNIT.  This routine does   SLAP........316200
C     not check for the validity of a non-zero IUNIT unit number.        SLAP........316300
C                                                                        SLAP........316400
C***SEE ALSO  DSDOMN, DSLUOM, ISDOMN                                     SLAP........316500
C***REFERENCES  1. Mark K. Seager, A SLAP for the Masses, in             SLAP........316600
C                  G. F. Carey, Ed., Parallel Supercomputing: Methods,   SLAP........316700
C                  Algorithms and Applications, Wiley, 1989, pp.135-155. SLAP........316800
C***ROUTINES CALLED  D1MACH, DAXPY, DCOPY, DDOT, ISDOMN                  SLAP........316900
C***REVISION HISTORY  (YYMMDD)                                           SLAP........317000
C   890404  DATE WRITTEN                                                 SLAP........317100
C   890404  Previous REVISION DATE                                       SLAP........317200
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........317300
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........317400
C           standard.  (FNF)                                             SLAP........317500
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........317600
C   891004  Added new reference.                                         SLAP........317700
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........317800
C   910502  Removed MATVEC and MSOLVE from ROUTINES CALLED list.  (FNF)  SLAP........317900
C   920407  COMMON BLOCK renamed DSLBLK.  (WRB)                          SLAP........318000
C   920511  Added complete declaration section.  (WRB)                   SLAP........318100
C   920929  Corrected format of reference.  (FNF)                        SLAP........318200
C   921019  Changed 500.0 to 500 to reduce SP/DP differences.  (FNF)     SLAP........318300
C   921113  Corrected C***CATEGORY line.  (FNF)                          SLAP........318400
C   930326  Removed unused variable.  (FNF)                              SLAP........318500
C***END PROLOGUE  DOMN                                                   SLAP........318600
C     .. Scalar Arguments ..                                             SLAP........318700
      DOUBLE PRECISION ERR, TOL                                          SLAP........318800
      INTEGER IERR, ISYM, ITER, ITMAX, ITOL, IUNIT, N, NELT, NSAVE       SLAP........318900
C     .. Array Arguments ..                                              SLAP........319000
      DOUBLE PRECISION A(NELT), AP(N,0:NSAVE), B(N), CSAV(NSAVE),        SLAP........319100
     +                 DZ(N), EMAP(N,0:NSAVE), P(N,0:NSAVE), R(N),       SLAP........319200
     +                 RWORK(*), X(N), Z(N)                              SLAP........319300
      INTEGER IA(NELT), IWORK(*), JA(NELT)                               SLAP........319400
C     .. Subroutine Arguments ..                                         SLAP........319500
      EXTERNAL MATVEC, MSOLVE                                            SLAP........319600
C     .. Local Scalars ..                                                SLAP........319700
      DOUBLE PRECISION AK, AKDEN, AKNUM, BKL, BNRM, FUZZ, SOLNRM         SLAP........319800
      INTEGER I, IP, IPO, K, L, LMAX                                     SLAP........319900
C     .. External Functions ..                                           SLAP........320000
      DOUBLE PRECISION D1MACH, DDOT                                      SLAP........320100
      INTEGER ISDOMN                                                     SLAP........320200
      EXTERNAL D1MACH, DDOT, ISDOMN                                      SLAP........320300
C     .. External Subroutines ..                                         SLAP........320400
      EXTERNAL DAXPY, DCOPY                                              SLAP........320500
C     .. Intrinsic Functions ..                                          SLAP........320600
      INTRINSIC ABS, MIN, MOD                                            SLAP........320700
C***FIRST EXECUTABLE STATEMENT  DOMN                                     SLAP........320800
C                                                                        SLAP........320900
C         Check some of the input data.                                  SLAP........321000
C                                                                        SLAP........321100
      ITER = 0                                                           SLAP........321200
      IERR = 0                                                           SLAP........321300
      IF( N.LT.1 ) THEN                                                  SLAP........321400
         IERR = 3                                                        SLAP........321500
         RETURN                                                          SLAP........321600
      ENDIF                                                              SLAP........321700
      FUZZ = D1MACH(3)                                                   SLAP........321800
      IF( TOL.LT.500*FUZZ ) THEN                                         SLAP........321900
         TOL = 500*FUZZ                                                  SLAP........322000
         IERR = 4                                                        SLAP........322100
      ENDIF                                                              SLAP........322200
      FUZZ = FUZZ*FUZZ                                                   SLAP........322300
C                                                                        SLAP........322400
C         Calculate initial residual and pseudo-residual, and check      SLAP........322500
C         stopping criterion.                                            SLAP........322600
      CALL MATVEC(N, X, R, NELT, IA, JA, A, ISYM)                        SLAP........322700
      DO 10 I = 1, N                                                     SLAP........322800
         R(I)  = B(I) - R(I)                                             SLAP........322900
 10   CONTINUE                                                           SLAP........323000
      CALL MSOLVE(N, R, Z, NELT, IA, JA, A, ISYM, RWORK, IWORK)          SLAP........323100
C                                                                        SLAP........323200
      IF( ISDOMN(N, B, X, NELT, IA, JA, A, ISYM, MSOLVE, NSAVE,          SLAP........323300
     $     ITOL, TOL, ITMAX, ITER, ERR, IERR, IUNIT,                     SLAP........323400
     $     R, Z, P, AP, EMAP, DZ, CSAV,                                  SLAP........323500
     $     RWORK, IWORK, AK, BNRM, SOLNRM) .NE. 0 ) GO TO 200            SLAP........323600
      IF( IERR.NE.0 ) RETURN                                             SLAP........323700
C                                                                        SLAP........323800
C                                                                        SLAP........323900
C         ***** iteration loop *****                                     SLAP........324000
C                                                                        SLAP........324100
CVD$R NOVECTOR                                                           SLAP........324200
CVD$R NOCONCUR                                                           SLAP........324300
      DO 100 K = 1, ITMAX                                                SLAP........324400
         ITER = K                                                        SLAP........324500
         IP = MOD( ITER-1, NSAVE+1 )                                     SLAP........324600
C                                                                        SLAP........324700
C         calculate direction vector p, a*p, and (m-inv)*a*p,            SLAP........324800
C         and save if desired.                                           SLAP........324900
         CALL DCOPY(N, Z, 1, P(1,IP), 1)                                 SLAP........325000
         CALL MATVEC(N, P(1,IP), AP(1,IP), NELT, IA, JA, A, ISYM)        SLAP........325100
         CALL MSOLVE(N, AP(1,IP), EMAP(1,IP), NELT, IA, JA, A, ISYM,     SLAP........325200
     $        RWORK, IWORK)                                              SLAP........325300
         IF( NSAVE.EQ.0 ) THEN                                           SLAP........325400
            AKDEN = DDOT(N, EMAP, 1, EMAP, 1)                            SLAP........325500
         ELSE                                                            SLAP........325600
            IF( ITER.GT.1 ) THEN                                         SLAP........325700
               LMAX = MIN( NSAVE, ITER-1 )                               SLAP........325800
               DO 20 L = 1, LMAX                                         SLAP........325900
                  IPO = MOD(IP+(NSAVE+1-L),NSAVE+1)                      SLAP........326000
                  BKL = DDOT(N, EMAP(1,IP), 1, EMAP(1,IPO), 1)           SLAP........326100
                  BKL = BKL*CSAV(L)                                      SLAP........326200
                  CALL DAXPY(N, -BKL,    P(1,IPO), 1,    P(1,IP), 1)     SLAP........326300
                  CALL DAXPY(N, -BKL,   AP(1,IPO), 1,   AP(1,IP), 1)     SLAP........326400
                  CALL DAXPY(N, -BKL, EMAP(1,IPO), 1, EMAP(1,IP), 1)     SLAP........326500
 20            CONTINUE                                                  SLAP........326600
               IF( NSAVE.GT.1 ) THEN                                     SLAP........326700
                  DO 30 L = NSAVE-1, 1, -1                               SLAP........326800
                     CSAV(L+1) = CSAV(L)                                 SLAP........326900
 30               CONTINUE                                               SLAP........327000
               ENDIF                                                     SLAP........327100
            ENDIF                                                        SLAP........327200
            AKDEN = DDOT(N, EMAP(1,IP), 1, EMAP(1,IP), 1)                SLAP........327300
            IF( ABS(AKDEN).LT.FUZZ ) THEN                                SLAP........327400
               IERR = 6                                                  SLAP........327500
               RETURN                                                    SLAP........327600
            ENDIF                                                        SLAP........327700
            CSAV(1) = 1.0D0/AKDEN                                        SLAP........327800
C                                                                        SLAP........327900
C         calculate coefficient ak, new iterate x, new residual r, and   SLAP........328000
C         new pseudo-residual z.                                         SLAP........328100
         ENDIF                                                           SLAP........328200
         AKNUM = DDOT(N, Z, 1, EMAP(1,IP), 1)                            SLAP........328300
         AK = AKNUM/AKDEN                                                SLAP........328400
         CALL DAXPY(N,  AK,    P(1,IP), 1, X, 1)                         SLAP........328500
         CALL DAXPY(N, -AK,   AP(1,IP), 1, R, 1)                         SLAP........328600
         CALL DAXPY(N, -AK, EMAP(1,IP), 1, Z, 1)                         SLAP........328700
C                                                                        SLAP........328800
C         check stopping criterion.                                      SLAP........328900
         IF( ISDOMN(N, B, X, NELT, IA, JA, A, ISYM, MSOLVE, NSAVE,       SLAP........329000
     $        ITOL, TOL, ITMAX, ITER, ERR, IERR, IUNIT,                  SLAP........329100
     $        R, Z, P, AP, EMAP, DZ, CSAV,                               SLAP........329200
     $        RWORK, IWORK, AK, BNRM, SOLNRM) .NE. 0 ) GO TO 200         SLAP........329300
C                                                                        SLAP........329400
 100  CONTINUE                                                           SLAP........329500
C                                                                        SLAP........329600
C         *****   end of loop  *****                                     SLAP........329700
C                                                                        SLAP........329800
C         Stopping criterion not satisfied.                              SLAP........329900
C.....THE COMMENT LINE MARKED WITH "CCC" BELOW WAS ORIGINALLY ACTIVE     SLAP........330000
C        CODE AND WAS COMMENTED OUT DURING INTEGRATION OF SLAP           SLAP........330100
C        WITH SUTRA.                                                     SLAP........330200
CCC   ITER = ITMAX + 1                                                   SLAP........330300
      IERR = 2                                                           SLAP........330400
C                                                                        SLAP........330500
 200  RETURN                                                             SLAP........330600
C------------- LAST LINE OF DOMN FOLLOWS ----------------------------    SLAP........330700
      END                                                                SLAP........330800
*DECK DORTH                                                              SLAP........330900
      SUBROUTINE DORTH (VNEW, V, HES, N, LL, LDHES, KMP, SNORMW)         SLAP........331000
C***BEGIN PROLOGUE  DORTH                                                SLAP........331100
C***SUBSIDIARY                                                           SLAP........331200
C***PURPOSE  Internal routine for DGMRES.                                SLAP........331300
C***LIBRARY   SLATEC (SLAP)                                              SLAP........331400
C***CATEGORY  D2A4, D2B4                                                 SLAP........331500
C***TYPE      DOUBLE PRECISION (SORTH-S, DORTH-D)                        SLAP........331600
C***KEYWORDS  GENERALIZED MINIMUM RESIDUAL, ITERATIVE PRECONDITION,      SLAP........331700
C             NON-SYMMETRIC LINEAR SYSTEM, SLAP, SPARSE                  SLAP........331800
C***AUTHOR  Brown, Peter, (LLNL), pnbrown@llnl.gov                       SLAP........331900
C           Hindmarsh, Alan, (LLNL), alanh@llnl.gov                      SLAP........332000
C           Seager, Mark K., (LLNL), seager@llnl.gov                     SLAP........332100
C             Lawrence Livermore National Laboratory                     SLAP........332200
C             PO Box 808, L-60                                           SLAP........332300
C             Livermore, CA 94550 (510) 423-3141                         SLAP........332400
C***DESCRIPTION                                                          SLAP........332500
C        This routine  orthogonalizes  the  vector  VNEW  against the    SLAP........332600
C        previous KMP  vectors in the   V array.  It uses  a modified    SLAP........332700
C        Gram-Schmidt   orthogonalization procedure with  conditional    SLAP........332800
C        reorthogonalization.                                            SLAP........332900
C                                                                        SLAP........333000
C *Usage:                                                                SLAP........333100
C      INTEGER N, LL, LDHES, KMP                                         SLAP........333200
C      DOUBLE PRECISION VNEW(N), V(N,LL), HES(LDHES,LL), SNORMW          SLAP........333300
C                                                                        SLAP........333400
C      CALL DORTH(VNEW, V, HES, N, LL, LDHES, KMP, SNORMW)               SLAP........333500
C                                                                        SLAP........333600
C *Arguments:                                                            SLAP........333700
C VNEW   :INOUT    Double Precision VNEW(N)                              SLAP........333800
C         On input, the vector of length N containing a scaled           SLAP........333900
C         product of the Jacobian and the vector V(*,LL).                SLAP........334000
C         On output, the new vector orthogonal to V(*,i0) to V(*,LL),    SLAP........334100
C         where i0 = max(1, LL-KMP+1).                                   SLAP........334200
C V      :IN       Double Precision V(N,LL)                              SLAP........334300
C         The N x LL array containing the previous LL                    SLAP........334400
C         orthogonal vectors V(*,1) to V(*,LL).                          SLAP........334500
C HES    :INOUT    Double Precision HES(LDHES,LL)                        SLAP........334600
C         On input, an LL x LL upper Hessenberg matrix containing,       SLAP........334700
C         in HES(I,K), K.lt.LL, the scaled inner products of             SLAP........334800
C         A*V(*,K) and V(*,i).                                           SLAP........334900
C         On return, column LL of HES is filled in with                  SLAP........335000
C         the scaled inner products of A*V(*,LL) and V(*,i).             SLAP........335100
C N      :IN       Integer                                               SLAP........335200
C         The order of the matrix A, and the length of VNEW.             SLAP........335300
C LL     :IN       Integer                                               SLAP........335400
C         The current order of the matrix HES.                           SLAP........335500
C LDHES  :IN       Integer                                               SLAP........335600
C         The leading dimension of the HES array.                        SLAP........335700
C KMP    :IN       Integer                                               SLAP........335800
C         The number of previous vectors the new vector VNEW             SLAP........335900
C         must be made orthogonal to (KMP .le. MAXL).                    SLAP........336000
C SNORMW :OUT      DOUBLE PRECISION                                      SLAP........336100
C         Scalar containing the l-2 norm of VNEW.                        SLAP........336200
C                                                                        SLAP........336300
C***SEE ALSO  DGMRES                                                     SLAP........336400
C***ROUTINES CALLED  DAXPY, DDOT, DNRM2                                  SLAP........336500
C***REVISION HISTORY  (YYMMDD)                                           SLAP........336600
C   890404  DATE WRITTEN                                                 SLAP........336700
C   890404  Previous REVISION DATE                                       SLAP........336800
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........336900
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........337000
C           standard.  (FNF)                                             SLAP........337100
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........337200
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........337300
C   910506  Made subsidiary to DGMRES.  (FNF)                            SLAP........337400
C   920511  Added complete declaration section.  (WRB)                   SLAP........337500
C***END PROLOGUE  DORTH                                                  SLAP........337600
C         The following is for optimized compilation on LLNL/LTSS Crays. SLAP........337700
CLLL. OPTIMIZE                                                           SLAP........337800
C     .. Scalar Arguments ..                                             SLAP........337900
      DOUBLE PRECISION SNORMW                                            SLAP........338000
      INTEGER KMP, LDHES, LL, N                                          SLAP........338100
C     .. Array Arguments ..                                              SLAP........338200
      DOUBLE PRECISION HES(LDHES,*), V(N,*), VNEW(*)                     SLAP........338300
C     .. Local Scalars ..                                                SLAP........338400
      DOUBLE PRECISION ARG, SUMDSQ, TEM, VNRM                            SLAP........338500
      INTEGER I, I0                                                      SLAP........338600
C     .. External Functions ..                                           SLAP........338700
      DOUBLE PRECISION DDOT, DNRM2                                       SLAP........338800
      EXTERNAL DDOT, DNRM2                                               SLAP........338900
C     .. External Subroutines ..                                         SLAP........339000
      EXTERNAL DAXPY                                                     SLAP........339100
C     .. Intrinsic Functions ..                                          SLAP........339200
      INTRINSIC MAX, SQRT                                                SLAP........339300
C***FIRST EXECUTABLE STATEMENT  DORTH                                    SLAP........339400
C                                                                        SLAP........339500
C         Get norm of unaltered VNEW for later use.                      SLAP........339600
C                                                                        SLAP........339700
      VNRM = DNRM2(N, VNEW, 1)                                           SLAP........339800
C   -------------------------------------------------------------------  SLAP........339900
C         Perform the modified Gram-Schmidt procedure on VNEW =A*V(LL).  SLAP........340000
C         Scaled inner products give new column of HES.                  SLAP........340100
C         Projections of earlier vectors are subtracted from VNEW.       SLAP........340200
C   -------------------------------------------------------------------  SLAP........340300
      I0 = MAX(1,LL-KMP+1)                                               SLAP........340400
      DO 10 I = I0,LL                                                    SLAP........340500
         HES(I,LL) = DDOT(N, V(1,I), 1, VNEW, 1)                         SLAP........340600
         TEM = -HES(I,LL)                                                SLAP........340700
         CALL DAXPY(N, TEM, V(1,I), 1, VNEW, 1)                          SLAP........340800
 10   CONTINUE                                                           SLAP........340900
C   -------------------------------------------------------------------  SLAP........341000
C         Compute SNORMW = norm of VNEW.  If VNEW is small compared      SLAP........341100
C         to its input value (in norm), then reorthogonalize VNEW to     SLAP........341200
C         V(*,1) through V(*,LL).  Correct if relative correction        SLAP........341300
C         exceeds 1000*(unit roundoff).  Finally, correct SNORMW using   SLAP........341400
C         the dot products involved.                                     SLAP........341500
C   -------------------------------------------------------------------  SLAP........341600
      SNORMW = DNRM2(N, VNEW, 1)                                         SLAP........341700
      IF (VNRM + 0.001D0*SNORMW .NE. VNRM) RETURN                        SLAP........341800
      SUMDSQ = 0                                                         SLAP........341900
      DO 30 I = I0,LL                                                    SLAP........342000
         TEM = -DDOT(N, V(1,I), 1, VNEW, 1)                              SLAP........342100
         IF (HES(I,LL) + 0.001D0*TEM .EQ. HES(I,LL)) GO TO 30            SLAP........342200
         HES(I,LL) = HES(I,LL) - TEM                                     SLAP........342300
         CALL DAXPY(N, TEM, V(1,I), 1, VNEW, 1)                          SLAP........342400
         SUMDSQ = SUMDSQ + TEM**2                                        SLAP........342500
 30   CONTINUE                                                           SLAP........342600
      IF (SUMDSQ .EQ. 0.0D0) RETURN                                      SLAP........342700
      ARG = MAX(0.0D0,SNORMW**2 - SUMDSQ)                                SLAP........342800
      SNORMW = SQRT(ARG)                                                 SLAP........342900
C                                                                        SLAP........343000
      RETURN                                                             SLAP........343100
C------------- LAST LINE OF DORTH FOLLOWS ----------------------------   SLAP........343200
      END                                                                SLAP........343300
*DECK DPIGMR                                                             SLAP........343400
      SUBROUTINE DPIGMR (N, R0, SR, SZ, JSCAL, MAXL, MAXLP1, KMP, NRSTS, SLAP........343500
     +   JPRE, MATVEC, MSOLVE, NMSL, Z, V, HES, Q, LGMR, RPAR, IPAR, WK, SLAP........343600
     +   DL, RHOL, NRMAX, B, BNRM, X, XL, ITOL, TOL, NELT, IA, JA, A,    SLAP........343700
C........THE NEXT LINE OF CODE WAS MODIFIED DURING INTEGRATION OF        SLAP........343800
C           SLAP WITH SUTRA.  IT ORIGINALLY READ:                        SLAP........343900
C           +   ISYM, IUNIT, IFLAG, ERR)                                 SLAP........344000
     +   ISYM, IUNIT, IFLAG, ERR, ITMAX)                                 SLAP........344100
C***BEGIN PROLOGUE  DPIGMR                                               SLAP........344200
C***SUBSIDIARY                                                           SLAP........344300
C***PURPOSE  Internal routine for DGMRES.                                SLAP........344400
C***LIBRARY   SLATEC (SLAP)                                              SLAP........344500
C***CATEGORY  D2A4, D2B4                                                 SLAP........344600
C***TYPE      DOUBLE PRECISION (SPIGMR-S, DPIGMR-D)                      SLAP........344700
C***KEYWORDS  GENERALIZED MINIMUM RESIDUAL, ITERATIVE PRECONDITION,      SLAP........344800
C             NON-SYMMETRIC LINEAR SYSTEM, SLAP, SPARSE                  SLAP........344900
C***AUTHOR  Brown, Peter, (LLNL), pnbrown@llnl.gov                       SLAP........345000
C           Hindmarsh, Alan, (LLNL), alanh@llnl.gov                      SLAP........345100
C           Seager, Mark K., (LLNL), seager@llnl.gov                     SLAP........345200
C             Lawrence Livermore National Laboratory                     SLAP........345300
C             PO Box 808, L-60                                           SLAP........345400
C             Livermore, CA 94550 (510) 423-3141                         SLAP........345500
C***DESCRIPTION                                                          SLAP........345600
C         This routine solves the linear system A * Z = R0 using a       SLAP........345700
C         scaled preconditioned version of the generalized minimum       SLAP........345800
C         residual method.  An initial guess of Z = 0 is assumed.        SLAP........345900
C                                                                        SLAP........346000
C *Usage:                                                                SLAP........346100
C      INTEGER N, JSCAL, MAXL, MAXLP1, KMP, NRSTS, JPRE, NMSL, LGMR      SLAP........346200
C      INTEGER IPAR(USER DEFINED), NRMAX, ITOL, NELT, IA(NELT), JA(NELT) SLAP........346300
C      INTEGER ISYM, IUNIT, IFLAG                                        SLAP........346400
C      DOUBLE PRECISION R0(N), SR(N), SZ(N), Z(N), V(N,MAXLP1),          SLAP........346500
C     $                 HES(MAXLP1,MAXL), Q(2*MAXL), RPAR(USER DEFINED), SLAP........346600
C     $                 WK(N), DL(N), RHOL, B(N), BNRM, X(N), XL(N),     SLAP........346700
C     $                 TOL, A(NELT), ERR                                SLAP........346800
C      EXTERNAL MATVEC, MSOLVE                                           SLAP........346900
C                                                                        SLAP........347000
C      CALL DPIGMR(N, R0, SR, SZ, JSCAL, MAXL, MAXLP1, KMP,              SLAP........347100
C     $     NRSTS, JPRE, MATVEC, MSOLVE, NMSL, Z, V, HES, Q, LGMR,       SLAP........347200
C     $     RPAR, IPAR, WK, DL, RHOL, NRMAX, B, BNRM, X, XL,             SLAP........347300
CC..........THE NEXT COMMENT LINE *NOT* MARKED WITH "CC" WAS MODIFIED    SLAP........347400
CC             DURING INTEGRATION OF SLAP WITH SUTRA.  IT ORIGINALLY     SLAP........347500
CC             READ:                                                     SLAP........347600
CC    C     $     ITOL, TOL, NELT, IA, JA, A, ISYM, IUNIT, IFLAG, ERR)   SLAP........347700
C     $     ITOL, TOL, NELT, IA, JA, A, ISYM, IUNIT, IFLAG, ERR, ITMAX)  SLAP........347800
C                                                                        SLAP........347900
C *Arguments:                                                            SLAP........348000
C N      :IN       Integer                                               SLAP........348100
C         The order of the matrix A, and the lengths                     SLAP........348200
C         of the vectors SR, SZ, R0 and Z.                               SLAP........348300
C R0     :IN       Double Precision R0(N)                                SLAP........348400
C         R0 = the right hand side of the system A*Z = R0.               SLAP........348500
C         R0 is also used as workspace when computing                    SLAP........348600
C         the final approximation.                                       SLAP........348700
C         (R0 is the same as V(*,MAXL+1) in the call to DPIGMR.)         SLAP........348800
C SR     :IN       Double Precision SR(N)                                SLAP........348900
C         SR is a vector of length N containing the non-zero             SLAP........349000
C         elements of the diagonal scaling matrix for R0.                SLAP........349100
C SZ     :IN       Double Precision SZ(N)                                SLAP........349200
C         SZ is a vector of length N containing the non-zero             SLAP........349300
C         elements of the diagonal scaling matrix for Z.                 SLAP........349400
C JSCAL  :IN       Integer                                               SLAP........349500
C         A flag indicating whether arrays SR and SZ are used.           SLAP........349600
C         JSCAL=0 means SR and SZ are not used and the                   SLAP........349700
C                 algorithm will perform as if all                       SLAP........349800
C                 SR(i) = 1 and SZ(i) = 1.                               SLAP........349900
C         JSCAL=1 means only SZ is used, and the algorithm               SLAP........350000
C                 performs as if all SR(i) = 1.                          SLAP........350100
C         JSCAL=2 means only SR is used, and the algorithm               SLAP........350200
C                 performs as if all SZ(i) = 1.                          SLAP........350300
C         JSCAL=3 means both SR and SZ are used.                         SLAP........350400
C MAXL   :IN       Integer                                               SLAP........350500
C         The maximum allowable order of the matrix H.                   SLAP........350600
C MAXLP1 :IN       Integer                                               SLAP........350700
C         MAXPL1 = MAXL + 1, used for dynamic dimensioning of HES.       SLAP........350800
C KMP    :IN       Integer                                               SLAP........350900
C         The number of previous vectors the new vector VNEW             SLAP........351000
C         must be made orthogonal to.  (KMP .le. MAXL)                   SLAP........351100
C NRSTS  :IN       Integer                                               SLAP........351200
C         Counter for the number of restarts on the current              SLAP........351300
C         call to DGMRES.  If NRSTS .gt. 0, then the residual            SLAP........351400
C         R0 is already scaled, and so scaling of it is                  SLAP........351500
C         not necessary.                                                 SLAP........351600
C JPRE   :IN       Integer                                               SLAP........351700
C         Preconditioner type flag.                                      SLAP........351800
C MATVEC :EXT      External.                                             SLAP........351900
C         Name of a routine which performs the matrix vector multiply    SLAP........352000
C         Y = A*X given A and X.  The name of the MATVEC routine must    SLAP........352100
C         be declared external in the calling program.  The calling      SLAP........352200
C         sequence to MATVEC is:                                         SLAP........352300
C             CALL MATVEC(N, X, Y, NELT, IA, JA, A, ISYM)                SLAP........352400
C         where N is the number of unknowns, Y is the product A*X        SLAP........352500
C         upon return, X is an input vector, and NELT is the number of   SLAP........352600
C         non-zeros in the SLAP IA, JA, A storage for the matrix A.      SLAP........352700
C         ISYM is a flag which, if non-zero, denotes that A is           SLAP........352800
C         symmetric and only the lower or upper triangle is stored.      SLAP........352900
C MSOLVE :EXT      External.                                             SLAP........353000
C         Name of the routine which solves a linear system Mz = r for    SLAP........353100
C         z given r with the preconditioning matrix M (M is supplied via SLAP........353200
C         RPAR and IPAR arrays.  The name of the MSOLVE routine must     SLAP........353300
C         be declared external in the calling program.  The calling      SLAP........353400
C         sequence to MSOLVE is:                                         SLAP........353500
C             CALL MSOLVE(N, R, Z, NELT, IA, JA, A, ISYM, RPAR, IPAR)    SLAP........353600
C         Where N is the number of unknowns, R is the right-hand side    SLAP........353700
C         vector and Z is the solution upon return.  NELT, IA, JA, A and SLAP........353800
C         ISYM are defined as below.  RPAR is a double precision array   SLAP........353900
C         that can be used to pass necessary preconditioning information SLAP........354000
C         and/or workspace to MSOLVE.  IPAR is an integer work array     SLAP........354100
C         for the same purpose as RPAR.                                  SLAP........354200
C NMSL   :OUT      Integer                                               SLAP........354300
C         The number of calls to MSOLVE.                                 SLAP........354400
C Z      :OUT      Double Precision Z(N)                                 SLAP........354500
C         The final computed approximation to the solution               SLAP........354600
C         of the system A*Z = R0.                                        SLAP........354700
C V      :OUT      Double Precision V(N,MAXLP1)                          SLAP........354800
C         The N by (LGMR+1) array containing the LGMR                    SLAP........354900
C         orthogonal vectors V(*,1) to V(*,LGMR).                        SLAP........355000
C HES    :OUT      Double Precision HES(MAXLP1,MAXL)                     SLAP........355100
C         The upper triangular factor of the QR decomposition            SLAP........355200
C         of the (LGMR+1) by LGMR upper Hessenberg matrix whose          SLAP........355300
C         entries are the scaled inner-products of A*V(*,I)              SLAP........355400
C         and V(*,K).                                                    SLAP........355500
C Q      :OUT      Double Precision Q(2*MAXL)                            SLAP........355600
C         A double precision array of length 2*MAXL containing the       SLAP........355700
C         components of the Givens rotations used in the QR              SLAP........355800
C         decomposition of HES.  It is loaded in DHEQR and used in       SLAP........355900
C         DHELS.                                                         SLAP........356000
C LGMR   :OUT      Integer                                               SLAP........356100
C         The number of iterations performed and                         SLAP........356200
C         the current order of the upper Hessenberg                      SLAP........356300
C         matrix HES.                                                    SLAP........356400
C RPAR   :IN       Double Precision RPAR(USER DEFINED)                   SLAP........356500
C         Double Precision workspace passed directly to the MSOLVE       SLAP........356600
C         routine.                                                       SLAP........356700
C IPAR   :IN       Integer IPAR(USER DEFINED)                            SLAP........356800
C         Integer workspace passed directly to the MSOLVE routine.       SLAP........356900
C WK     :IN       Double Precision WK(N)                                SLAP........357000
C         A double precision work array of length N used by routines     SLAP........357100
C         MATVEC and MSOLVE.                                             SLAP........357200
C DL     :INOUT    Double Precision DL(N)                                SLAP........357300
C         On input, a double precision work array of length N used for   SLAP........357400
C         calculation of the residual norm RHO when the method is        SLAP........357500
C         incomplete (KMP.lt.MAXL), and/or when using restarting.        SLAP........357600
C         On output, the scaled residual vector RL.  It is only loaded   SLAP........357700
C         when performing restarts of the Krylov iteration.              SLAP........357800
C RHOL   :OUT      Double Precision                                      SLAP........357900
C         A double precision scalar containing the norm of the final     SLAP........358000
C         residual.                                                      SLAP........358100
C NRMAX  :IN       Integer                                               SLAP........358200
C         The maximum number of restarts of the Krylov iteration.        SLAP........358300
C         NRMAX .gt. 0 means restarting is active, while                 SLAP........358400
C         NRMAX = 0 means restarting is not being used.                  SLAP........358500
C B      :IN       Double Precision B(N)                                 SLAP........358600
C         The right hand side of the linear system A*X = b.              SLAP........358700
C BNRM   :IN       Double Precision                                      SLAP........358800
C         The scaled norm of b.                                          SLAP........358900
C X      :IN       Double Precision X(N)                                 SLAP........359000
C         The current approximate solution as of the last                SLAP........359100
C         restart.                                                       SLAP........359200
C XL     :IN       Double Precision XL(N)                                SLAP........359300
C         An array of length N used to hold the approximate              SLAP........359400
C         solution X(L) when ITOL=11.                                    SLAP........359500
C ITOL   :IN       Integer                                               SLAP........359600
C         A flag to indicate the type of convergence criterion           SLAP........359700
C         used.  See the driver for its description.                     SLAP........359800
C TOL    :IN       Double Precision                                      SLAP........359900
C         The tolerance on residuals R0-A*Z in scaled norm.              SLAP........360000
C NELT   :IN       Integer                                               SLAP........360100
C         The length of arrays IA, JA and A.                             SLAP........360200
C IA     :IN       Integer IA(NELT)                                      SLAP........360300
C         An integer array of length NELT containing matrix data.        SLAP........360400
C         It is passed directly to the MATVEC and MSOLVE routines.       SLAP........360500
C JA     :IN       Integer JA(NELT)                                      SLAP........360600
C         An integer array of length NELT containing matrix data.        SLAP........360700
C         It is passed directly to the MATVEC and MSOLVE routines.       SLAP........360800
C A      :IN       Double Precision A(NELT)                              SLAP........360900
C         A double precision array of length NELT containing matrix      SLAP........361000
C         data. It is passed directly to the MATVEC and MSOLVE routines. SLAP........361100
C ISYM   :IN       Integer                                               SLAP........361200
C         A flag to indicate symmetric matrix storage.                   SLAP........361300
C         If ISYM=0, all non-zero entries of the matrix are              SLAP........361400
C         stored.  If ISYM=1, the matrix is symmetric and                SLAP........361500
C         only the upper or lower triangular part is stored.             SLAP........361600
C IUNIT  :IN       Integer                                               SLAP........361700
C         The i/o unit number for writing intermediate residual          SLAP........361800
C         norm values.                                                   SLAP........361900
C IFLAG  :OUT      Integer                                               SLAP........362000
C         An integer error flag..                                        SLAP........362100
C         0 means convergence in LGMR iterations, LGMR.le.MAXL.          SLAP........362200
C         1 means the convergence test did not pass in MAXL              SLAP........362300
C           iterations, but the residual norm is .lt. norm(R0),          SLAP........362400
C           and so Z is computed.                                        SLAP........362500
C         2 means the convergence test did not pass in MAXL              SLAP........362600
C           iterations, residual .ge. norm(R0), and Z = 0.               SLAP........362700
C ERR    :OUT      Double Precision.                                     SLAP........362800
C         Error estimate of error in final approximate solution, as      SLAP........362900
C         defined by ITOL.                                               SLAP........363000
C                                                                        SLAP........363100
C *Cautions:                                                             SLAP........363200
C     This routine will attempt to write to the Fortran logical output   SLAP........363300
C     unit IUNIT, if IUNIT .ne. 0.  Thus, the user must make sure that   SLAP........363400
C     this logical unit is attached to a file or terminal before calling SLAP........363500
C     this routine with a non-zero value for IUNIT.  This routine does   SLAP........363600
C     not check for the validity of a non-zero IUNIT unit number.        SLAP........363700
C                                                                        SLAP........363800
C***SEE ALSO  DGMRES                                                     SLAP........363900
C***ROUTINES CALLED  DAXPY, DCOPY, DHELS, DHEQR, DNRM2, DORTH, DRLCAL,   SLAP........364000
C                    DSCAL, ISDGMR                                       SLAP........364100
C***REVISION HISTORY  (YYMMDD)                                           SLAP........364200
C   890404  DATE WRITTEN                                                 SLAP........364300
C   890404  Previous REVISION DATE                                       SLAP........364400
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........364500
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........364600
C           standard.  (FNF)                                             SLAP........364700
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........364800
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........364900
C   910502  Removed MATVEC and MSOLVE from ROUTINES CALLED list.  (FNF)  SLAP........365000
C   910506  Made subsidiary to DGMRES.  (FNF)                            SLAP........365100
C   920511  Added complete declaration section.  (WRB)                   SLAP........365200
C***END PROLOGUE  DPIGMR                                                 SLAP........365300
C         The following is for optimized compilation on LLNL/LTSS Crays. SLAP........365400
CLLL. OPTIMIZE                                                           SLAP........365500
C     .. Scalar Arguments ..                                             SLAP........365600
      DOUBLE PRECISION BNRM, ERR, RHOL, TOL                              SLAP........365700
      INTEGER IFLAG, ISYM, ITOL, IUNIT, JPRE, JSCAL, KMP, LGMR, MAXL,    SLAP........365800
     +        MAXLP1, N, NELT, NMSL, NRMAX, NRSTS                        SLAP........365900
C     .. Array Arguments ..                                              SLAP........366000
      DOUBLE PRECISION A(NELT), B(*), DL(*), HES(MAXLP1,*), Q(*), R0(*), SLAP........366100
     +                 RPAR(*), SR(*), SZ(*), V(N,*), WK(*), X(*),       SLAP........366200
     +                 XL(*), Z(*)                                       SLAP........366300
      INTEGER IA(NELT), IPAR(*), JA(NELT)                                SLAP........366400
C     .. Subroutine Arguments ..                                         SLAP........366500
      EXTERNAL MATVEC, MSOLVE                                            SLAP........366600
C     .. Local Scalars ..                                                SLAP........366700
      DOUBLE PRECISION C, DLNRM, PROD, R0NRM, RHO, S, SNORMW, TEM        SLAP........366800
      INTEGER I, I2, INFO, IP1, ITER, ITMAX, J, K, LL, LLP1              SLAP........366900
C     .. External Functions ..                                           SLAP........367000
      DOUBLE PRECISION DNRM2                                             SLAP........367100
      INTEGER ISDGMR                                                     SLAP........367200
      EXTERNAL DNRM2, ISDGMR                                             SLAP........367300
C     .. External Subroutines ..                                         SLAP........367400
      EXTERNAL DAXPY, DCOPY, DHELS, DHEQR, DORTH, DRLCAL, DSCAL          SLAP........367500
C     .. Intrinsic Functions ..                                          SLAP........367600
      INTRINSIC ABS                                                      SLAP........367700
C***FIRST EXECUTABLE STATEMENT  DPIGMR                                   SLAP........367800
C                                                                        SLAP........367900
C         Zero out the Z array.                                          SLAP........368000
C                                                                        SLAP........368100
      DO 5 I = 1,N                                                       SLAP........368200
         Z(I) = 0                                                        SLAP........368300
 5    CONTINUE                                                           SLAP........368400
C                                                                        SLAP........368500
      IFLAG = 0                                                          SLAP........368600
      LGMR = 0                                                           SLAP........368700
      NMSL = 0                                                           SLAP........368800
C         Load ITMAX, the maximum number of iterations.                  SLAP........368900
C.....THE COMMENT LINE MARKED "CCC" BELOW WAS ORIGINALLY ACTIVE CODE     SLAP........369000
C        AND WAS COMMENTED OUT DURING INTEGRATION OF SLAP WITH SUTRA.    SLAP........369100
CCC   ITMAX =(NRMAX+1)*MAXL                                              SLAP........369200
C   -------------------------------------------------------------------  SLAP........369300
C         The initial residual is the vector R0.                         SLAP........369400
C         Apply left precon. if JPRE < 0 and this is not a restart.      SLAP........369500
C         Apply scaling to R0 if JSCAL = 2 or 3.                         SLAP........369600
C   -------------------------------------------------------------------  SLAP........369700
      IF ((JPRE .LT. 0) .AND.(NRSTS .EQ. 0)) THEN                        SLAP........369800
         CALL DCOPY(N, R0, 1, WK, 1)                                     SLAP........369900
         CALL MSOLVE(N, WK, R0, NELT, IA, JA, A, ISYM, RPAR, IPAR)       SLAP........370000
         NMSL = NMSL + 1                                                 SLAP........370100
      ENDIF                                                              SLAP........370200
      IF (((JSCAL.EQ.2) .OR.(JSCAL.EQ.3)) .AND.(NRSTS.EQ.0)) THEN        SLAP........370300
         DO 10 I = 1,N                                                   SLAP........370400
            V(I,1) = R0(I)*SR(I)                                         SLAP........370500
 10      CONTINUE                                                        SLAP........370600
      ELSE                                                               SLAP........370700
         DO 20 I = 1,N                                                   SLAP........370800
            V(I,1) = R0(I)                                               SLAP........370900
 20      CONTINUE                                                        SLAP........371000
      ENDIF                                                              SLAP........371100
      R0NRM = DNRM2(N, V, 1)                                             SLAP........371200
      ITER = NRSTS*MAXL                                                  SLAP........371300
C                                                                        SLAP........371400
C         Call stopping routine ISDGMR.                                  SLAP........371500
C                                                                        SLAP........371600
      IF (ISDGMR(N, B, X, XL, NELT, IA, JA, A, ISYM, MSOLVE,             SLAP........371700
     $    NMSL, ITOL, TOL, ITMAX, ITER, ERR, IUNIT, V(1,1), Z, WK,       SLAP........371800
     $    RPAR, IPAR, R0NRM, BNRM, SR, SZ, JSCAL,                        SLAP........371900
     $    KMP, LGMR, MAXL, MAXLP1, V, Q, SNORMW, PROD, R0NRM,            SLAP........372000
     $    HES, JPRE) .NE. 0) RETURN                                      SLAP........372100
      TEM = 1.0D0/R0NRM                                                  SLAP........372200
      CALL DSCAL(N, TEM, V(1,1), 1)                                      SLAP........372300
C                                                                        SLAP........372400
C         Zero out the HES array.                                        SLAP........372500
C                                                                        SLAP........372600
      DO 50 J = 1,MAXL                                                   SLAP........372700
         DO 40 I = 1,MAXLP1                                              SLAP........372800
            HES(I,J) = 0                                                 SLAP........372900
 40      CONTINUE                                                        SLAP........373000
 50   CONTINUE                                                           SLAP........373100
C   -------------------------------------------------------------------  SLAP........373200
C         Main loop to compute the vectors V(*,2) to V(*,MAXL).          SLAP........373300
C         The running product PROD is needed for the convergence test.   SLAP........373400
C   -------------------------------------------------------------------  SLAP........373500
      PROD = 1                                                           SLAP........373600
      DO 90 LL = 1,MAXL                                                  SLAP........373700
         LGMR = LL                                                       SLAP........373800
C   -------------------------------------------------------------------  SLAP........373900
C        Unscale  the  current V(LL)  and store  in WK.  Call routine    SLAP........374000
C        MSOLVE    to   compute(M-inverse)*WK,   where    M   is  the    SLAP........374100
C        preconditioner matrix.  Save the answer in Z.   Call routine    SLAP........374200
C        MATVEC to compute  VNEW  = A*Z,  where  A is  the the system    SLAP........374300
C        matrix.  save the answer in  V(LL+1).  Scale V(LL+1).   Call    SLAP........374400
C        routine DORTH  to  orthogonalize the    new vector VNEW   =     SLAP........374500
C        V(*,LL+1).  Call routine DHEQR to update the factors of HES.    SLAP........374600
C   -------------------------------------------------------------------  SLAP........374700
        IF ((JSCAL .EQ. 1) .OR.(JSCAL .EQ. 3)) THEN                      SLAP........374800
           DO 60 I = 1,N                                                 SLAP........374900
              WK(I) = V(I,LL)/SZ(I)                                      SLAP........375000
 60        CONTINUE                                                      SLAP........375100
        ELSE                                                             SLAP........375200
           CALL DCOPY(N, V(1,LL), 1, WK, 1)                              SLAP........375300
        ENDIF                                                            SLAP........375400
        IF (JPRE .GT. 0) THEN                                            SLAP........375500
           CALL MSOLVE(N, WK, Z, NELT, IA, JA, A, ISYM, RPAR, IPAR)      SLAP........375600
           NMSL = NMSL + 1                                               SLAP........375700
           CALL MATVEC(N, Z, V(1,LL+1), NELT, IA, JA, A, ISYM)           SLAP........375800
        ELSE                                                             SLAP........375900
           CALL MATVEC(N, WK, V(1,LL+1), NELT, IA, JA, A, ISYM)          SLAP........376000
        ENDIF                                                            SLAP........376100
        IF (JPRE .LT. 0) THEN                                            SLAP........376200
           CALL DCOPY(N, V(1,LL+1), 1, WK, 1)                            SLAP........376300
           CALL MSOLVE(N,WK,V(1,LL+1),NELT,IA,JA,A,ISYM,RPAR,IPAR)       SLAP........376400
           NMSL = NMSL + 1                                               SLAP........376500
        ENDIF                                                            SLAP........376600
        IF ((JSCAL .EQ. 2) .OR.(JSCAL .EQ. 3)) THEN                      SLAP........376700
           DO 65 I = 1,N                                                 SLAP........376800
              V(I,LL+1) = V(I,LL+1)*SR(I)                                SLAP........376900
 65        CONTINUE                                                      SLAP........377000
        ENDIF                                                            SLAP........377100
        CALL DORTH(V(1,LL+1), V, HES, N, LL, MAXLP1, KMP, SNORMW)        SLAP........377200
        HES(LL+1,LL) = SNORMW                                            SLAP........377300
        CALL DHEQR(HES, MAXLP1, LL, Q, INFO, LL)                         SLAP........377400
        IF (INFO .EQ. LL) GO TO 120                                      SLAP........377500
C   -------------------------------------------------------------------  SLAP........377600
C         Update RHO, the estimate of the norm of the residual R0-A*ZL.  SLAP........377700
C         If KMP <  MAXL, then the vectors V(*,1),...,V(*,LL+1) are not  SLAP........377800
C         necessarily orthogonal for LL > KMP.  The vector DL must then  SLAP........377900
C         be computed, and its norm used in the calculation of RHO.      SLAP........378000
C   -------------------------------------------------------------------  SLAP........378100
        PROD = PROD*Q(2*LL)                                              SLAP........378200
        RHO = ABS(PROD*R0NRM)                                            SLAP........378300
        IF ((LL.GT.KMP) .AND.(KMP.LT.MAXL)) THEN                         SLAP........378400
           IF (LL .EQ. KMP+1) THEN                                       SLAP........378500
              CALL DCOPY(N, V(1,1), 1, DL, 1)                            SLAP........378600
              DO 75 I = 1,KMP                                            SLAP........378700
                 IP1 = I + 1                                             SLAP........378800
                 I2 = I*2                                                SLAP........378900
                 S = Q(I2)                                               SLAP........379000
                 C = Q(I2-1)                                             SLAP........379100
                 DO 70 K = 1,N                                           SLAP........379200
                    DL(K) = S*DL(K) + C*V(K,IP1)                         SLAP........379300
 70              CONTINUE                                                SLAP........379400
 75           CONTINUE                                                   SLAP........379500
           ENDIF                                                         SLAP........379600
           S = Q(2*LL)                                                   SLAP........379700
           C = Q(2*LL-1)/SNORMW                                          SLAP........379800
           LLP1 = LL + 1                                                 SLAP........379900
           DO 80 K = 1,N                                                 SLAP........380000
              DL(K) = S*DL(K) + C*V(K,LLP1)                              SLAP........380100
 80        CONTINUE                                                      SLAP........380200
           DLNRM = DNRM2(N, DL, 1)                                       SLAP........380300
           RHO = RHO*DLNRM                                               SLAP........380400
        ENDIF                                                            SLAP........380500
        RHOL = RHO                                                       SLAP........380600
C   -------------------------------------------------------------------  SLAP........380700
C         Test for convergence.  If passed, compute approximation ZL.    SLAP........380800
C         If failed and LL < MAXL, then continue iterating.              SLAP........380900
C   -------------------------------------------------------------------  SLAP........381000
        ITER = NRSTS*MAXL + LGMR                                         SLAP........381100
        IF (ISDGMR(N, B, X, XL, NELT, IA, JA, A, ISYM, MSOLVE,           SLAP........381200
     $      NMSL, ITOL, TOL, ITMAX, ITER, ERR, IUNIT, DL, Z, WK,         SLAP........381300
     $      RPAR, IPAR, RHOL, BNRM, SR, SZ, JSCAL,                       SLAP........381400
     $      KMP, LGMR, MAXL, MAXLP1, V, Q, SNORMW, PROD, R0NRM,          SLAP........381500
     $      HES, JPRE) .NE. 0) GO TO 200                                 SLAP........381600
C.......THE NEXT LINE OF CODE WAS MODIFIED DURING INTEGRATION OF SLAP    SLAP........381700
C          WITH SUTRA.  IT ORGINALLY READ:                               SLAP........381800
C          IF (LL .EQ. MAXL) GO TO 100                                   SLAP........381900
        IF ((ITER.EQ.ITMAX).OR.(LL .EQ. MAXL)) GO TO 100                 SLAP........382000
C   -------------------------------------------------------------------  SLAP........382100
C         Rescale so that the norm of V(1,LL+1) is one.                  SLAP........382200
C   -------------------------------------------------------------------  SLAP........382300
        TEM = 1.0D0/SNORMW                                               SLAP........382400
        CALL DSCAL(N, TEM, V(1,LL+1), 1)                                 SLAP........382500
 90   CONTINUE                                                           SLAP........382600
 100  CONTINUE                                                           SLAP........382700
      IF (RHO .LT. R0NRM) GO TO 150                                      SLAP........382800
 120  CONTINUE                                                           SLAP........382900
      IFLAG = 2                                                          SLAP........383000
C                                                                        SLAP........383100
C         Load approximate solution with zero.                           SLAP........383200
C                                                                        SLAP........383300
      DO 130 I = 1,N                                                     SLAP........383400
         Z(I) = 0                                                        SLAP........383500
 130  CONTINUE                                                           SLAP........383600
      RETURN                                                             SLAP........383700
 150  IFLAG = 1                                                          SLAP........383800
C                                                                        SLAP........383900
C         Tolerance not met, but residual norm reduced.                  SLAP........384000
C                                                                        SLAP........384100
      IF (NRMAX .GT. 0) THEN                                             SLAP........384200
C                                                                        SLAP........384300
C        If performing restarting (NRMAX > 0)  calculate the residual    SLAP........384400
C        vector RL and  store it in the DL  array.  If the incomplete    SLAP........384500
C        version is being used (KMP < MAXL) then DL has  already been    SLAP........384600
C        calculated up to a scaling factor.   Use DRLCAL to calculate    SLAP........384700
C        the scaled residual vector.                                     SLAP........384800
C                                                                        SLAP........384900
         CALL DRLCAL(N, KMP, MAXL, MAXL, V, Q, DL, SNORMW, PROD,         SLAP........385000
     $        R0NRM)                                                     SLAP........385100
      ENDIF                                                              SLAP........385200
C   -------------------------------------------------------------------  SLAP........385300
C         Compute the approximation ZL to the solution.  Since the       SLAP........385400
C         vector Z was used as workspace, and the initial guess          SLAP........385500
C         of the linear iteration is zero, Z must be reset to zero.      SLAP........385600
C   -------------------------------------------------------------------  SLAP........385700
 200  CONTINUE                                                           SLAP........385800
      LL = LGMR                                                          SLAP........385900
      LLP1 = LL + 1                                                      SLAP........386000
      DO 210 K = 1,LLP1                                                  SLAP........386100
         R0(K) = 0                                                       SLAP........386200
 210  CONTINUE                                                           SLAP........386300
      R0(1) = R0NRM                                                      SLAP........386400
      CALL DHELS(HES, MAXLP1, LL, Q, R0)                                 SLAP........386500
      DO 220 K = 1,N                                                     SLAP........386600
         Z(K) = 0                                                        SLAP........386700
 220  CONTINUE                                                           SLAP........386800
      DO 230 I = 1,LL                                                    SLAP........386900
         CALL DAXPY(N, R0(I), V(1,I), 1, Z, 1)                           SLAP........387000
 230  CONTINUE                                                           SLAP........387100
      IF ((JSCAL .EQ. 1) .OR.(JSCAL .EQ. 3)) THEN                        SLAP........387200
         DO 240 I = 1,N                                                  SLAP........387300
            Z(I) = Z(I)/SZ(I)                                            SLAP........387400
 240     CONTINUE                                                        SLAP........387500
      ENDIF                                                              SLAP........387600
      IF (JPRE .GT. 0) THEN                                              SLAP........387700
         CALL DCOPY(N, Z, 1, WK, 1)                                      SLAP........387800
         CALL MSOLVE(N, WK, Z, NELT, IA, JA, A, ISYM, RPAR, IPAR)        SLAP........387900
         NMSL = NMSL + 1                                                 SLAP........388000
      ENDIF                                                              SLAP........388100
      RETURN                                                             SLAP........388200
C------------- LAST LINE OF DPIGMR FOLLOWS ----------------------------  SLAP........388300
      END                                                                SLAP........388400
*DECK DRLCAL                                                             SLAP........388500
      SUBROUTINE DRLCAL (N, KMP, LL, MAXL, V, Q, RL, SNORMW, PROD,       SLAP........388600
     +   R0NRM)                                                          SLAP........388700
C***BEGIN PROLOGUE  DRLCAL                                               SLAP........388800
C***SUBSIDIARY                                                           SLAP........388900
C***PURPOSE  Internal routine for DGMRES.                                SLAP........389000
C***LIBRARY   SLATEC (SLAP)                                              SLAP........389100
C***CATEGORY  D2A4, D2B4                                                 SLAP........389200
C***TYPE      DOUBLE PRECISION (SRLCAL-S, DRLCAL-D)                      SLAP........389300
C***KEYWORDS  GENERALIZED MINIMUM RESIDUAL, ITERATIVE PRECONDITION,      SLAP........389400
C             NON-SYMMETRIC LINEAR SYSTEM, SLAP, SPARSE                  SLAP........389500
C***AUTHOR  Brown, Peter, (LLNL), pnbrown@llnl.gov                       SLAP........389600
C           Hindmarsh, Alan, (LLNL), alanh@llnl.gov                      SLAP........389700
C           Seager, Mark K., (LLNL), seager@llnl.gov                     SLAP........389800
C             Lawrence Livermore National Laboratory                     SLAP........389900
C             PO Box 808, L-60                                           SLAP........390000
C             Livermore, CA 94550 (510) 423-3141                         SLAP........390100
C***DESCRIPTION                                                          SLAP........390200
C         This routine calculates the scaled residual RL from the        SLAP........390300
C         V(I)'s.                                                        SLAP........390400
C *Usage:                                                                SLAP........390500
C      INTEGER N, KMP, LL, MAXL                                          SLAP........390600
C      DOUBLE PRECISION V(N,LL), Q(2*MAXL), RL(N), SNORMW, PROD, R0NORM  SLAP........390700
C                                                                        SLAP........390800
C      CALL DRLCAL(N, KMP, LL, MAXL, V, Q, RL, SNORMW, PROD, R0NRM)      SLAP........390900
C                                                                        SLAP........391000
C *Arguments:                                                            SLAP........391100
C N      :IN       Integer                                               SLAP........391200
C         The order of the matrix A, and the lengths                     SLAP........391300
C         of the vectors SR, SZ, R0 and Z.                               SLAP........391400
C KMP    :IN       Integer                                               SLAP........391500
C         The number of previous V vectors the new vector VNEW           SLAP........391600
C         must be made orthogonal to. (KMP .le. MAXL)                    SLAP........391700
C LL     :IN       Integer                                               SLAP........391800
C         The current dimension of the Krylov subspace.                  SLAP........391900
C MAXL   :IN       Integer                                               SLAP........392000
C         The maximum dimension of the Krylov subspace.                  SLAP........392100
C V      :IN       Double Precision V(N,LL)                              SLAP........392200
C         The N x LL array containing the orthogonal vectors             SLAP........392300
C         V(*,1) to V(*,LL).                                             SLAP........392400
C Q      :IN       Double Precision Q(2*MAXL)                            SLAP........392500
C         A double precision array of length 2*MAXL containing the       SLAP........392600
C         components of the Givens rotations used in the QR              SLAP........392700
C         decomposition of HES.  It is loaded in DHEQR and used in       SLAP........392800
C         DHELS.                                                         SLAP........392900
C RL     :OUT      Double Precision RL(N)                                SLAP........393000
C         The residual vector RL.  This is either SB*(B-A*XL) if         SLAP........393100
C         not preconditioning or preconditioning on the right,           SLAP........393200
C         or SB*(M-inverse)*(B-A*XL) if preconditioning on the           SLAP........393300
C         left.                                                          SLAP........393400
C SNORMW :IN       Double Precision                                      SLAP........393500
C         Scale factor.                                                  SLAP........393600
C PROD   :IN       Double Precision                                      SLAP........393700
C         The product s1*s2*...*sl = the product of the sines of the     SLAP........393800
C         Givens rotations used in the QR factorization of               SLAP........393900
C         the Hessenberg matrix HES.                                     SLAP........394000
C R0NRM  :IN       Double Precision                                      SLAP........394100
C         The scaled norm of initial residual R0.                        SLAP........394200
C                                                                        SLAP........394300
C***SEE ALSO  DGMRES                                                     SLAP........394400
C***ROUTINES CALLED  DCOPY, DSCAL                                        SLAP........394500
C***REVISION HISTORY  (YYMMDD)                                           SLAP........394600
C   890404  DATE WRITTEN                                                 SLAP........394700
C   890404  Previous REVISION DATE                                       SLAP........394800
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........394900
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........395000
C           standard.  (FNF)                                             SLAP........395100
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........395200
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........395300
C   910506  Made subsidiary to DGMRES.  (FNF)                            SLAP........395400
C   920511  Added complete declaration section.  (WRB)                   SLAP........395500
C***END PROLOGUE  DRLCAL                                                 SLAP........395600
C         The following is for optimized compilation on LLNL/LTSS Crays. SLAP........395700
CLLL. OPTIMIZE                                                           SLAP........395800
C     .. Scalar Arguments ..                                             SLAP........395900
      DOUBLE PRECISION PROD, R0NRM, SNORMW                               SLAP........396000
      INTEGER KMP, LL, MAXL, N                                           SLAP........396100
C     .. Array Arguments ..                                              SLAP........396200
      DOUBLE PRECISION Q(*), RL(N), V(N,*)                               SLAP........396300
C     .. Local Scalars ..                                                SLAP........396400
      DOUBLE PRECISION C, S, TEM                                         SLAP........396500
      INTEGER I, I2, IP1, K, LLM1, LLP1                                  SLAP........396600
C     .. External Subroutines ..                                         SLAP........396700
      EXTERNAL DCOPY, DSCAL                                              SLAP........396800
C***FIRST EXECUTABLE STATEMENT  DRLCAL                                   SLAP........396900
      IF (KMP .EQ. MAXL) THEN                                            SLAP........397000
C                                                                        SLAP........397100
C         calculate RL.  Start by copying V(*,1) into RL.                SLAP........397200
C                                                                        SLAP........397300
         CALL DCOPY(N, V(1,1), 1, RL, 1)                                 SLAP........397400
         LLM1 = LL - 1                                                   SLAP........397500
         DO 20 I = 1,LLM1                                                SLAP........397600
            IP1 = I + 1                                                  SLAP........397700
            I2 = I*2                                                     SLAP........397800
            S = Q(I2)                                                    SLAP........397900
            C = Q(I2-1)                                                  SLAP........398000
            DO 10 K = 1,N                                                SLAP........398100
               RL(K) = S*RL(K) + C*V(K,IP1)                              SLAP........398200
 10         CONTINUE                                                     SLAP........398300
 20      CONTINUE                                                        SLAP........398400
         S = Q(2*LL)                                                     SLAP........398500
         C = Q(2*LL-1)/SNORMW                                            SLAP........398600
         LLP1 = LL + 1                                                   SLAP........398700
         DO 30 K = 1,N                                                   SLAP........398800
            RL(K) = S*RL(K) + C*V(K,LLP1)                                SLAP........398900
 30      CONTINUE                                                        SLAP........399000
      ENDIF                                                              SLAP........399100
C                                                                        SLAP........399200
C         When KMP < MAXL, RL vector already partially calculated.       SLAP........399300
C         Scale RL by R0NRM*PROD to obtain the residual RL.              SLAP........399400
C                                                                        SLAP........399500
      TEM = R0NRM*PROD                                                   SLAP........399600
      CALL DSCAL(N, TEM, RL, 1)                                          SLAP........399700
      RETURN                                                             SLAP........399800
C------------- LAST LINE OF DRLCAL FOLLOWS ----------------------------  SLAP........399900
      END                                                                SLAP........400000
*DECK DS2Y                                                               SLAP........400100
      SUBROUTINE DS2Y (N, NELT, IA, JA, A, ISYM)                         SLAP........400200
C***BEGIN PROLOGUE  DS2Y                                                 SLAP........400300
C***PURPOSE  SLAP Triad to SLAP Column Format Converter.                 SLAP........400400
C            Routine to convert from the SLAP Triad to SLAP Column       SLAP........400500
C            format.                                                     SLAP........400600
C***LIBRARY   SLATEC (SLAP)                                              SLAP........400700
C***CATEGORY  D1B9                                                       SLAP........400800
C***TYPE      DOUBLE PRECISION (SS2Y-S, DS2Y-D)                          SLAP........400900
C***KEYWORDS  LINEAR SYSTEM, SLAP SPARSE                                 SLAP........401000
C***AUTHOR  Seager, Mark K., (LLNL)                                      SLAP........401100
C             Lawrence Livermore National Laboratory                     SLAP........401200
C             PO BOX 808, L-60                                           SLAP........401300
C             Livermore, CA 94550 (510) 423-3141                         SLAP........401400
C             seager@llnl.gov                                            SLAP........401500
C***DESCRIPTION                                                          SLAP........401600
C                                                                        SLAP........401700
C *Usage:                                                                SLAP........401800
C     INTEGER N, NELT, IA(NELT), JA(NELT), ISYM                          SLAP........401900
C     DOUBLE PRECISION A(NELT)                                           SLAP........402000
C                                                                        SLAP........402100
C     CALL DS2Y( N, NELT, IA, JA, A, ISYM )                              SLAP........402200
C                                                                        SLAP........402300
C *Arguments:                                                            SLAP........402400
C N      :IN       Integer                                               SLAP........402500
C         Order of the Matrix.                                           SLAP........402600
C NELT   :IN       Integer.                                              SLAP........402700
C         Number of non-zeros stored in A.                               SLAP........402800
C IA     :INOUT    Integer IA(NELT).                                     SLAP........402900
C JA     :INOUT    Integer JA(NELT).                                     SLAP........403000
C A      :INOUT    Double Precision A(NELT).                             SLAP........403100
C         These arrays should hold the matrix A in either the SLAP       SLAP........403200
C         Triad format or the SLAP Column format.  See "Description",    SLAP........403300
C         below.  If the SLAP Triad format is used, this format is       SLAP........403400
C         translated to the SLAP Column format by this routine.          SLAP........403500
C ISYM   :IN       Integer.                                              SLAP........403600
C         Flag to indicate symmetric storage format.                     SLAP........403700
C         If ISYM=0, all non-zero entries of the matrix are stored.      SLAP........403800
C         If ISYM=1, the matrix is symmetric, and only the lower         SLAP........403900
C         triangle of the matrix is stored.                              SLAP........404000
C                                                                        SLAP........404100
C *Description:                                                          SLAP........404200
C       The Sparse Linear Algebra Package (SLAP) utilizes two matrix     SLAP........404300
C       data structures: 1) the  SLAP Triad  format or  2)  the SLAP     SLAP........404400
C       Column format.  The user can hand this routine either of the     SLAP........404500
C       of these data structures.  If the SLAP Triad format is give      SLAP........404600
C       as input then this routine transforms it into SLAP Column        SLAP........404700
C       format.  The way this routine tells which format is given as     SLAP........404800
C       input is to look at JA(N+1).  If JA(N+1) = NELT+1 then we        SLAP........404900
C       have the SLAP Column format.  If that equality does not hold     SLAP........405000
C       then it is assumed that the IA, JA, A arrays contain the         SLAP........405100
C       SLAP Triad format.                                               SLAP........405200
C                                                                        SLAP........405300
C       =================== S L A P Triad format ===================     SLAP........405400
C       This routine requires that the  matrix A be   stored in  the     SLAP........405500
C       SLAP  Triad format.  In  this format only the non-zeros  are     SLAP........405600
C       stored.  They may appear in  *ANY* order.  The user supplies     SLAP........405700
C       three arrays of  length NELT, where  NELT is  the number  of     SLAP........405800
C       non-zeros in the matrix: (IA(NELT), JA(NELT), A(NELT)).  For     SLAP........405900
C       each non-zero the user puts the row and column index of that     SLAP........406000
C       matrix element  in the IA and  JA arrays.  The  value of the     SLAP........406100
C       non-zero   matrix  element is  placed  in  the corresponding     SLAP........406200
C       location of the A array.   This is  an  extremely  easy data     SLAP........406300
C       structure to generate.  On  the  other hand it   is  not too     SLAP........406400
C       efficient on vector computers for  the iterative solution of     SLAP........406500
C       linear systems.  Hence,   SLAP changes   this  input    data     SLAP........406600
C       structure to the SLAP Column format  for  the iteration (but     SLAP........406700
C       does not change it back).                                        SLAP........406800
C                                                                        SLAP........406900
C       Here is an example of the  SLAP Triad   storage format for a     SLAP........407000
C       5x5 Matrix.  Recall that the entries may appear in any order.    SLAP........407100
C                                                                        SLAP........407200
C           5x5 Matrix      SLAP Triad format for 5x5 matrix on left.    SLAP........407300
C                              1  2  3  4  5  6  7  8  9 10 11           SLAP........407400
C       |11 12  0  0 15|   A: 51 12 11 33 15 53 55 22 35 44 21           SLAP........407500
C       |21 22  0  0  0|  IA:  5  1  1  3  1  5  5  2  3  4  2           SLAP........407600
C       | 0  0 33  0 35|  JA:  1  2  1  3  5  3  5  2  5  4  1           SLAP........407700
C       | 0  0  0 44  0|                                                 SLAP........407800
C       |51  0 53  0 55|                                                 SLAP........407900
C                                                                        SLAP........408000
C       =================== S L A P Column format ==================     SLAP........408100
C                                                                        SLAP........408200
C       This routine  requires that  the matrix A  be stored in  the     SLAP........408300
C       SLAP Column format.  In this format the non-zeros are stored     SLAP........408400
C       counting down columns (except for  the diagonal entry, which     SLAP........408500
C       must appear first in each  "column")  and are stored  in the     SLAP........408600
C       double precision array A.   In other words,  for each column     SLAP........408700
C       in the matrix put the diagonal entry in  A.  Then put in the     SLAP........408800
C       other non-zero  elements going down  the column (except  the     SLAP........408900
C       diagonal) in order.   The  IA array holds the  row index for     SLAP........409000
C       each non-zero.  The JA array holds the offsets  into the IA,     SLAP........409100
C       A arrays  for  the  beginning  of each   column.   That  is,     SLAP........409200
C       IA(JA(ICOL)),  A(JA(ICOL)) points   to the beginning  of the     SLAP........409300
C       ICOL-th   column    in    IA and   A.      IA(JA(ICOL+1)-1),     SLAP........409400
C       A(JA(ICOL+1)-1) points to  the  end of the   ICOL-th column.     SLAP........409500
C       Note that we always have  JA(N+1) = NELT+1,  where N is  the     SLAP........409600
C       number of columns in  the matrix and NELT  is the number  of     SLAP........409700
C       non-zeros in the matrix.                                         SLAP........409800
C                                                                        SLAP........409900
C       Here is an example of the  SLAP Column  storage format for a     SLAP........410000
C       5x5 Matrix (in the A and IA arrays '|'  denotes the end of a     SLAP........410100
C       column):                                                         SLAP........410200
C                                                                        SLAP........410300
C           5x5 Matrix      SLAP Column format for 5x5 matrix on left.   SLAP........410400
C                              1  2  3    4  5    6  7    8    9 10 11   SLAP........410500
C       |11 12  0  0 15|   A: 11 21 51 | 22 12 | 33 53 | 44 | 55 15 35   SLAP........410600
C       |21 22  0  0  0|  IA:  1  2  5 |  2  1 |  3  5 |  4 |  5  1  3   SLAP........410700
C       | 0  0 33  0 35|  JA:  1  4  6    8  9   12                      SLAP........410800
C       | 0  0  0 44  0|                                                 SLAP........410900
C       |51  0 53  0 55|                                                 SLAP........411000
C                                                                        SLAP........411100
C***REFERENCES  (NONE)                                                   SLAP........411200
C***ROUTINES CALLED  QS2I1D                                              SLAP........411300
C***REVISION HISTORY  (YYMMDD)                                           SLAP........411400
C   871119  DATE WRITTEN                                                 SLAP........411500
C   881213  Previous REVISION DATE                                       SLAP........411600
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........411700
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........411800
C           standard.  (FNF)                                             SLAP........411900
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........412000
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........412100
C   910502  Corrected C***FIRST EXECUTABLE STATEMENT line.  (FNF)        SLAP........412200
C   920511  Added complete declaration section.  (WRB)                   SLAP........412300
C   930701  Updated CATEGORY section.  (FNF, WRB)                        SLAP........412400
C***END PROLOGUE  DS2Y                                                   SLAP........412500
C     .. Scalar Arguments ..                                             SLAP........412600
      INTEGER ISYM, N, NELT                                              SLAP........412700
C     .. Array Arguments ..                                              SLAP........412800
      DOUBLE PRECISION A(NELT)                                           SLAP........412900
      INTEGER IA(NELT), JA(NELT)                                         SLAP........413000
C     .. Local Scalars ..                                                SLAP........413100
      DOUBLE PRECISION TEMP                                              SLAP........413200
      INTEGER I, IBGN, ICOL, IEND, ITEMP, J                              SLAP........413300
C     .. External Subroutines ..                                         SLAP........413400
      EXTERNAL QS2I1D                                                    SLAP........413500
C***FIRST EXECUTABLE STATEMENT  DS2Y                                     SLAP........413600
C                                                                        SLAP........413700
C         Check to see if the (IA,JA,A) arrays are in SLAP Column        SLAP........413800
C         format.  If it's not then transform from SLAP Triad.           SLAP........413900
C                                                                        SLAP........414000
      IF( JA(N+1).EQ.NELT+1 ) RETURN                                     SLAP........414100
C                                                                        SLAP........414200
C         Sort into ascending order by COLUMN (on the ja array).         SLAP........414300
C         This will line up the columns.                                 SLAP........414400
C                                                                        SLAP........414500
      CALL QS2I1D( JA, IA, A, NELT, 1 )                                  SLAP........414600
C                                                                        SLAP........414700
C         Loop over each column to see where the column indices change   SLAP........414800
C         in the column index array ja.  This marks the beginning of the SLAP........414900
C         next column.                                                   SLAP........415000
C                                                                        SLAP........415100
CVD$R NOVECTOR                                                           SLAP........415200
      JA(1) = 1                                                          SLAP........415300
      DO 20 ICOL = 1, N-1                                                SLAP........415400
         DO 10 J = JA(ICOL)+1, NELT                                      SLAP........415500
            IF( JA(J).NE.ICOL ) THEN                                     SLAP........415600
               JA(ICOL+1) = J                                            SLAP........415700
               GOTO 20                                                   SLAP........415800
            ENDIF                                                        SLAP........415900
 10      CONTINUE                                                        SLAP........416000
 20   CONTINUE                                                           SLAP........416100
      JA(N+1) = NELT+1                                                   SLAP........416200
C                                                                        SLAP........416300
C         Mark the n+2 element so that future calls to a SLAP routine    SLAP........416400
C         utilizing the YSMP-Column storage format will be able to tell. SLAP........416500
C                                                                        SLAP........416600
      JA(N+2) = 0                                                        SLAP........416700
C                                                                        SLAP........416800
C         Now loop through the IA array making sure that the diagonal    SLAP........416900
C         matrix element appears first in the column.  Then sort the     SLAP........417000
C         rest of the column in ascending order.                         SLAP........417100
C                                                                        SLAP........417200
      DO 70 ICOL = 1, N                                                  SLAP........417300
         IBGN = JA(ICOL)                                                 SLAP........417400
         IEND = JA(ICOL+1)-1                                             SLAP........417500
         DO 30 I = IBGN, IEND                                            SLAP........417600
            IF( IA(I).EQ.ICOL ) THEN                                     SLAP........417700
C                                                                        SLAP........417800
C              Swap the diagonal element with the first element in the   SLAP........417900
C              column.                                                   SLAP........418000
C                                                                        SLAP........418100
               ITEMP = IA(I)                                             SLAP........418200
               IA(I) = IA(IBGN)                                          SLAP........418300
               IA(IBGN) = ITEMP                                          SLAP........418400
               TEMP = A(I)                                               SLAP........418500
               A(I) = A(IBGN)                                            SLAP........418600
               A(IBGN) = TEMP                                            SLAP........418700
               GOTO 40                                                   SLAP........418800
            ENDIF                                                        SLAP........418900
 30      CONTINUE                                                        SLAP........419000
 40      IBGN = IBGN + 1                                                 SLAP........419100
         IF( IBGN.LT.IEND ) THEN                                         SLAP........419200
            DO 60 I = IBGN, IEND                                         SLAP........419300
               DO 50 J = I+1, IEND                                       SLAP........419400
                  IF( IA(I).GT.IA(J) ) THEN                              SLAP........419500
                     ITEMP = IA(I)                                       SLAP........419600
                     IA(I) = IA(J)                                       SLAP........419700
                     IA(J) = ITEMP                                       SLAP........419800
                     TEMP = A(I)                                         SLAP........419900
                     A(I) = A(J)                                         SLAP........420000
                     A(J) = TEMP                                         SLAP........420100
                  ENDIF                                                  SLAP........420200
 50            CONTINUE                                                  SLAP........420300
 60         CONTINUE                                                     SLAP........420400
         ENDIF                                                           SLAP........420500
 70   CONTINUE                                                           SLAP........420600
      RETURN                                                             SLAP........420700
C------------- LAST LINE OF DS2Y FOLLOWS ----------------------------    SLAP........420800
      END                                                                SLAP........420900
*DECK DSCAL                                                              SLAP........421000
      SUBROUTINE DSCAL (N, DA, DX, INCX)                                 SLAP........421100
C***BEGIN PROLOGUE  DSCAL                                                SLAP........421200
C***PURPOSE  Multiply a vector by a constant.                            SLAP........421300
C***LIBRARY   SLATEC (BLAS)                                              SLAP........421400
C***CATEGORY  D1A6                                                       SLAP........421500
C***TYPE      DOUBLE PRECISION (SSCAL-S, DSCAL-D, CSCAL-C)               SLAP........421600
C***KEYWORDS  BLAS, LINEAR ALGEBRA, SCALE, VECTOR                        SLAP........421700
C***AUTHOR  Lawson, C. L., (JPL)                                         SLAP........421800
C           Hanson, R. J., (SNLA)                                        SLAP........421900
C           Kincaid, D. R., (U. of Texas)                                SLAP........422000
C           Krogh, F. T., (JPL)                                          SLAP........422100
C***DESCRIPTION                                                          SLAP........422200
C                                                                        SLAP........422300
C                B L A S  Subprogram                                     SLAP........422400
C    Description of Parameters                                           SLAP........422500
C                                                                        SLAP........422600
C     --Input--                                                          SLAP........422700
C        N  number of elements in input vector(s)                        SLAP........422800
C       DA  double precision scale factor                                SLAP........422900
C       DX  double precision vector with N elements                      SLAP........423000
C     INCX  storage spacing between elements of DX                       SLAP........423100
C                                                                        SLAP........423200
C     --Output--                                                         SLAP........423300
C       DX  double precision result (unchanged if N.LE.0)                SLAP........423400
C                                                                        SLAP........423500
C     Replace double precision DX by double precision DA*DX.             SLAP........423600
C     For I = 0 to N-1, replace DX(IX+I*INCX) with  DA * DX(IX+I*INCX),  SLAP........423700
C     where IX = 1 if INCX .GE. 0, else IX = 1+(1-N)*INCX.               SLAP........423800
C                                                                        SLAP........423900
C***REFERENCES  C. L. Lawson, R. J. Hanson, D. R. Kincaid and F. T.      SLAP........424000
C                 Krogh, Basic linear algebra subprograms for Fortran    SLAP........424100
C                 usage, Algorithm No. 539, Transactions on Mathematical SLAP........424200
C                 Software 5, 3 (September 1979), pp. 308-323.           SLAP........424300
C***ROUTINES CALLED  (NONE)                                              SLAP........424400
C***REVISION HISTORY  (YYMMDD)                                           SLAP........424500
C   791001  DATE WRITTEN                                                 SLAP........424600
C   890831  Modified array declarations.  (WRB)                          SLAP........424700
C   890831  REVISION DATE from Version 3.2                               SLAP........424800
C   891214  Prologue converted to Version 4.0 format.  (BAB)             SLAP........424900
C   900821  Modified to correct problem with a negative increment.       SLAP........425000
C           (WRB)                                                        SLAP........425100
C   920501  Reformatted the REFERENCES section.  (WRB)                   SLAP........425200
C***END PROLOGUE  DSCAL                                                  SLAP........425300
      DOUBLE PRECISION DA, DX(*)                                         SLAP........425400
      INTEGER I, INCX, IX, M, MP1, N                                     SLAP........425500
C***FIRST EXECUTABLE STATEMENT  DSCAL                                    SLAP........425600
      IF (N .LE. 0) RETURN                                               SLAP........425700
      IF (INCX .EQ. 1) GOTO 20                                           SLAP........425800
C                                                                        SLAP........425900
C     Code for increment not equal to 1.                                 SLAP........426000
C                                                                        SLAP........426100
      IX = 1                                                             SLAP........426200
      IF (INCX .LT. 0) IX = (-N+1)*INCX + 1                              SLAP........426300
      DO 10 I = 1,N                                                      SLAP........426400
        DX(IX) = DA*DX(IX)                                               SLAP........426500
        IX = IX + INCX                                                   SLAP........426600
   10 CONTINUE                                                           SLAP........426700
      RETURN                                                             SLAP........426800
C                                                                        SLAP........426900
C     Code for increment equal to 1.                                     SLAP........427000
C                                                                        SLAP........427100
C     Clean-up loop so remaining vector length is a multiple of 5.       SLAP........427200
C                                                                        SLAP........427300
   20 M = MOD(N,5)                                                       SLAP........427400
      IF (M .EQ. 0) GOTO 40                                              SLAP........427500
      DO 30 I = 1,M                                                      SLAP........427600
        DX(I) = DA*DX(I)                                                 SLAP........427700
   30 CONTINUE                                                           SLAP........427800
      IF (N .LT. 5) RETURN                                               SLAP........427900
   40 MP1 = M + 1                                                        SLAP........428000
      DO 50 I = MP1,N,5                                                  SLAP........428100
        DX(I) = DA*DX(I)                                                 SLAP........428200
        DX(I+1) = DA*DX(I+1)                                             SLAP........428300
        DX(I+2) = DA*DX(I+2)                                             SLAP........428400
        DX(I+3) = DA*DX(I+3)                                             SLAP........428500
        DX(I+4) = DA*DX(I+4)                                             SLAP........428600
   50 CONTINUE                                                           SLAP........428700
      RETURN                                                             SLAP........428800
      END                                                                SLAP........428900
*DECK DSICCG                                                             SLAP........429000
      SUBROUTINE DSICCG (N, B, X, NELT, IA, JA, A, ISYM, ITOL, TOL,      SLAP........429100
     +   ITMAX, ITER, ERR, IERR, IUNIT, RWORK, LENW, IWORK, LENIW)       SLAP........429200
C***BEGIN PROLOGUE  DSICCG                                               SLAP........429300
C***PURPOSE  Incomplete Cholesky Conjugate Gradient Sparse Ax=b Solver.  SLAP........429400
C            Routine to solve a symmetric positive definite linear       SLAP........429500
C            system  Ax = b  using the incomplete Cholesky               SLAP........429600
C            Preconditioned Conjugate Gradient method.                   SLAP........429700
C***LIBRARY   SLATEC (SLAP)                                              SLAP........429800
C***CATEGORY  D2B4                                                       SLAP........429900
C***TYPE      DOUBLE PRECISION (SSICCG-S, DSICCG-D)                      SLAP........430000
C***KEYWORDS  INCOMPLETE CHOLESKY, ITERATIVE PRECONDITION, SLAP, SPARSE, SLAP........430100
C             SYMMETRIC LINEAR SYSTEM                                    SLAP........430200
C***AUTHOR  Greenbaum, Anne, (Courant Institute)                         SLAP........430300
C           Seager, Mark K., (LLNL)                                      SLAP........430400
C             Lawrence Livermore National Laboratory                     SLAP........430500
C             PO BOX 808, L-60                                           SLAP........430600
C             Livermore, CA 94550 (510) 423-3141                         SLAP........430700
C             seager@llnl.gov                                            SLAP........430800
C***DESCRIPTION                                                          SLAP........430900
C                                                                        SLAP........431000
C *Usage:                                                                SLAP........431100
C     INTEGER N, NELT, IA(NELT), JA(NELT), ISYM, ITOL, ITMAX             SLAP........431200
C     INTEGER ITER, IERR, IUNIT, LENW, IWORK(NL+2*N+1), LENIW            SLAP........431300
C     DOUBLE PRECISION B(N), X(N), A(NELT), TOL, ERR, RWORK(NL+5*N)      SLAP........431400
C                                                                        SLAP........431500
C     CALL DSICCG(N, B, X, NELT, IA, JA, A, ISYM, ITOL, TOL,             SLAP........431600
C    $     ITMAX, ITER, ERR, IERR, IUNIT, RWORK, LENW, IWORK, LENIW )    SLAP........431700
C                                                                        SLAP........431800
C *Arguments:                                                            SLAP........431900
C N      :IN       Integer.                                              SLAP........432000
C         Order of the Matrix.                                           SLAP........432100
C B      :IN       Double Precision B(N).                                SLAP........432200
C         Right-hand side vector.                                        SLAP........432300
C X      :INOUT    Double Precision X(N).                                SLAP........432400
C         On input X is your initial guess for solution vector.          SLAP........432500
C         On output X is the final approximate solution.                 SLAP........432600
C NELT   :IN       Integer.                                              SLAP........432700
C         Number of Non-Zeros stored in A.                               SLAP........432800
C IA     :INOUT    Integer IA(NELT).                                     SLAP........432900
C JA     :INOUT    Integer JA(NELT).                                     SLAP........433000
C A      :INOUT    Double Precision A(NELT).                             SLAP........433100
C         These arrays should hold the matrix A in either the SLAP       SLAP........433200
C         Triad format or the SLAP Column format.  See "Description",    SLAP........433300
C         below.  If the SLAP Triad format is chosen it is changed       SLAP........433400
C         internally to the SLAP Column format.                          SLAP........433500
C ISYM   :IN       Integer.                                              SLAP........433600
C         Flag to indicate symmetric storage format.                     SLAP........433700
C         If ISYM=0, all non-zero entries of the matrix are stored.      SLAP........433800
C         If ISYM=1, the matrix is symmetric, and only the upper         SLAP........433900
C         or lower triangle of the matrix is stored.                     SLAP........434000
C ITOL   :IN       Integer.                                              SLAP........434100
C         Flag to indicate type of convergence criterion.                SLAP........434200
C         If ITOL=1, iteration stops when the 2-norm of the residual     SLAP........434300
C         divided by the 2-norm of the right-hand side is less than TOL. SLAP........434400
C         If ITOL=2, iteration stops when the 2-norm of M-inv times the  SLAP........434500
C         residual divided by the 2-norm of M-inv times the right hand   SLAP........434600
C         side is less than TOL, where M-inv is the inverse of the       SLAP........434700
C         diagonal of A.                                                 SLAP........434800
C         ITOL=11 is often useful for checking and comparing different   SLAP........434900
C         routines.  For this case, the user must supply the "exact"     SLAP........435000
C         solution or a very accurate approximation (one with an error   SLAP........435100
C         much less than TOL) through a common block,                    SLAP........435200
C             COMMON /DSLBLK/ SOLN( )                                    SLAP........435300
C         If ITOL=11, iteration stops when the 2-norm of the difference  SLAP........435400
C         between the iterative approximation and the user-supplied      SLAP........435500
C         solution divided by the 2-norm of the user-supplied solution   SLAP........435600
C         is less than TOL.  Note that this requires the user to set up  SLAP........435700
C         the "COMMON /DSLBLK/ SOLN(LENGTH)" in the calling routine.     SLAP........435800
C         The routine with this declaration should be loaded before the  SLAP........435900
C         stop test so that the correct length is used by the loader.    SLAP........436000
C         This procedure is not standard Fortran and may not work        SLAP........436100
C         correctly on your system (although it has worked on every      SLAP........436200
C         system the authors have tried).  If ITOL is not 11 then this   SLAP........436300
C         common block is indeed standard Fortran.                       SLAP........436400
C TOL    :INOUT    Double Precision.                                     SLAP........436500
C         Convergence criterion, as described above.  (Reset if IERR=4.) SLAP........436600
C ITMAX  :IN       Integer.                                              SLAP........436700
C         Maximum number of iterations.                                  SLAP........436800
C ITER   :OUT      Integer.                                              SLAP........436900
C         Number of iterations required to reach convergence, or         SLAP........437000
C         ITMAX+1 if convergence criterion could not be achieved in      SLAP........437100
C         ITMAX iterations.                                              SLAP........437200
C ERR    :OUT      Double Precision.                                     SLAP........437300
C         Error estimate of error in final approximate solution, as      SLAP........437400
C         defined by ITOL.                                               SLAP........437500
C IERR   :OUT      Integer.                                              SLAP........437600
C         Return error flag.                                             SLAP........437700
C           IERR = 0 => All went well.                                   SLAP........437800
C           IERR = 1 => Insufficient space allocated for WORK or IWORK.  SLAP........437900
C           IERR = 2 => Method failed to converge in ITMAX steps.        SLAP........438000
C           IERR = 3 => Error in user input.                             SLAP........438100
C                       Check input values of N, ITOL.                   SLAP........438200
C           IERR = 4 => User error tolerance set too tight.              SLAP........438300
C                       Reset to 500*D1MACH(3).  Iteration proceeded.    SLAP........438400
C           IERR = 5 => Preconditioning matrix, M, is not positive       SLAP........438500
C                       definite.  (r,z) < 0.                            SLAP........438600
C           IERR = 6 => Matrix A is not positive definite.  (p,Ap) < 0.  SLAP........438700
C           IERR = 7 => Incomplete factorization broke down and was      SLAP........438800
C                       fudged.  Resulting preconditioning may be less   SLAP........438900
C                       than the best.                                   SLAP........439000
C IUNIT  :IN       Integer.                                              SLAP........439100
C         Unit number on which to write the error at each iteration,     SLAP........439200
C         if this is desired for monitoring convergence.  If unit        SLAP........439300
C         number is 0, no writing will occur.                            SLAP........439400
C RWORK  :WORK     Double Precision RWORK(LENW).                         SLAP........439500
C         Double Precision array used for workspace.                     SLAP........439600
C LENW   :IN       Integer.                                              SLAP........439700
C         Length of the double precision workspace, RWORK.               SLAP........439800
C         LENW >= NL+5*N.                                                SLAP........439900
C         NL is the number of non-zeros in the lower triangle of the     SLAP........440000
C         matrix (including the diagonal).                               SLAP........440100
C IWORK  :WORK     Integer IWORK(LENIW).                                 SLAP........440200
C         Integer array used for workspace.                              SLAP........440300
C         Upon return the following locations of IWORK hold information  SLAP........440400
C         which may be of use to the user:                               SLAP........440500
C         IWORK(9)  Amount of Integer workspace actually used.           SLAP........440600
C         IWORK(10) Amount of Double Precision workspace actually used.  SLAP........440700
C LENIW  :IN       Integer.                                              SLAP........440800
C         Length of the integer workspace, IWORK.  LENIW >= NL+N+11.     SLAP........440900
C         NL is the number of non-zeros in the lower triangle of the     SLAP........441000
C         matrix (including the diagonal).                               SLAP........441100
C                                                                        SLAP........441200
C *Description:                                                          SLAP........441300
C       This routine  performs  preconditioned  conjugate   gradient     SLAP........441400
C       method on the   symmetric positive  definite  linear  system     SLAP........441500
C       Ax=b.   The preconditioner  is  the incomplete Cholesky (IC)     SLAP........441600
C       factorization of the matrix A.  See  DSICS for details about     SLAP........441700
C       the incomplete   factorization algorithm.  One   should note     SLAP........441800
C       here however, that the  IC factorization is a  slow  process     SLAP........441900
C       and  that  one should   save  factorizations  for  reuse, if     SLAP........442000
C       possible.  The   MSOLVE operation (handled  in  DSLLTI) does     SLAP........442100
C       vectorize on machines  with  hardware  gather/scatter and is     SLAP........442200
C       quite fast.                                                      SLAP........442300
C                                                                        SLAP........442400
C       The Sparse Linear Algebra Package (SLAP) utilizes two matrix     SLAP........442500
C       data structures: 1) the  SLAP Triad  format or  2)  the SLAP     SLAP........442600
C       Column format.  The user can hand this routine either of the     SLAP........442700
C       of these data structures and SLAP  will figure out  which on     SLAP........442800
C       is being used and act accordingly.                               SLAP........442900
C                                                                        SLAP........443000
C       =================== S L A P Triad format ===================     SLAP........443100
C                                                                        SLAP........443200
C       This routine requires that the  matrix A be   stored in  the     SLAP........443300
C       SLAP  Triad format.  In  this format only the non-zeros  are     SLAP........443400
C       stored.  They may appear in  *ANY* order.  The user supplies     SLAP........443500
C       three arrays of  length NELT, where  NELT is  the number  of     SLAP........443600
C       non-zeros in the matrix: (IA(NELT), JA(NELT), A(NELT)).  For     SLAP........443700
C       each non-zero the user puts the row and column index of that     SLAP........443800
C       matrix element  in the IA and  JA arrays.  The  value of the     SLAP........443900
C       non-zero   matrix  element is  placed  in  the corresponding     SLAP........444000
C       location of the A array.   This is  an  extremely  easy data     SLAP........444100
C       structure to generate.  On  the  other hand it   is  not too     SLAP........444200
C       efficient on vector computers for  the iterative solution of     SLAP........444300
C       linear systems.  Hence,   SLAP changes   this  input    data     SLAP........444400
C       structure to the SLAP Column format  for  the iteration (but     SLAP........444500
C       does not change it back).                                        SLAP........444600
C                                                                        SLAP........444700
C       Here is an example of the  SLAP Triad   storage format for a     SLAP........444800
C       5x5 Matrix.  Recall that the entries may appear in any order.    SLAP........444900
C                                                                        SLAP........445000
C           5x5 Matrix      SLAP Triad format for 5x5 matrix on left.    SLAP........445100
C                              1  2  3  4  5  6  7  8  9 10 11           SLAP........445200
C       |11 12  0  0 15|   A: 51 12 11 33 15 53 55 22 35 44 21           SLAP........445300
C       |21 22  0  0  0|  IA:  5  1  1  3  1  5  5  2  3  4  2           SLAP........445400
C       | 0  0 33  0 35|  JA:  1  2  1  3  5  3  5  2  5  4  1           SLAP........445500
C       | 0  0  0 44  0|                                                 SLAP........445600
C       |51  0 53  0 55|                                                 SLAP........445700
C                                                                        SLAP........445800
C       =================== S L A P Column format ==================     SLAP........445900
C                                                                        SLAP........446000
C       This routine  requires that  the matrix A  be stored in  the     SLAP........446100
C       SLAP Column format.  In this format the non-zeros are stored     SLAP........446200
C       counting down columns (except for  the diagonal entry, which     SLAP........446300
C       must appear first in each  "column")  and are stored  in the     SLAP........446400
C       double precision array A.   In other words,  for each column     SLAP........446500
C       in the matrix put the diagonal entry in  A.  Then put in the     SLAP........446600
C       other non-zero  elements going down  the column (except  the     SLAP........446700
C       diagonal) in order.   The  IA array holds the  row index for     SLAP........446800
C       each non-zero.  The JA array holds the offsets  into the IA,     SLAP........446900
C       A arrays  for  the  beginning  of each   column.   That  is,     SLAP........447000
C       IA(JA(ICOL)),  A(JA(ICOL)) points   to the beginning  of the     SLAP........447100
C       ICOL-th   column    in    IA and   A.      IA(JA(ICOL+1)-1),     SLAP........447200
C       A(JA(ICOL+1)-1) points to  the  end of the   ICOL-th column.     SLAP........447300
C       Note that we always have  JA(N+1) = NELT+1,  where N is  the     SLAP........447400
C       number of columns in  the matrix and NELT  is the number  of     SLAP........447500
C       non-zeros in the matrix.                                         SLAP........447600
C                                                                        SLAP........447700
C       Here is an example of the  SLAP Column  storage format for a     SLAP........447800
C       5x5 Matrix (in the A and IA arrays '|'  denotes the end of a     SLAP........447900
C       column):                                                         SLAP........448000
C                                                                        SLAP........448100
C           5x5 Matrix      SLAP Column format for 5x5 matrix on left.   SLAP........448200
C                              1  2  3    4  5    6  7    8    9 10 11   SLAP........448300
C       |11 12  0  0 15|   A: 11 21 51 | 22 12 | 33 53 | 44 | 55 15 35   SLAP........448400
C       |21 22  0  0  0|  IA:  1  2  5 |  2  1 |  3  5 |  4 |  5  1  3   SLAP........448500
C       | 0  0 33  0 35|  JA:  1  4  6    8  9   12                      SLAP........448600
C       | 0  0  0 44  0|                                                 SLAP........448700
C       |51  0 53  0 55|                                                 SLAP........448800
C                                                                        SLAP........448900
C *Side Effects:                                                         SLAP........449000
C       The SLAP Triad format (IA, JA, A) is modified internally to be   SLAP........449100
C       the SLAP Column format.  See above.                              SLAP........449200
C                                                                        SLAP........449300
C *Cautions:                                                             SLAP........449400
C     This routine will attempt to write to the Fortran logical output   SLAP........449500
C     unit IUNIT, if IUNIT .ne. 0.  Thus, the user must make sure that   SLAP........449600
C     this logical unit is attached to a file or terminal before calling SLAP........449700
C     this routine with a non-zero value for IUNIT.  This routine does   SLAP........449800
C     not check for the validity of a non-zero IUNIT unit number.        SLAP........449900
C                                                                        SLAP........450000
C***SEE ALSO  DCG, DSLLTI                                                SLAP........450100
C***REFERENCES  1. Louis Hageman and David Young, Applied Iterative      SLAP........450200
C                  Methods, Academic Press, New York, 1981.              SLAP........450300
C               2. Concus, Golub and O'Leary, A Generalized Conjugate    SLAP........450400
C                  Gradient Method for the Numerical Solution of         SLAP........450500
C                  Elliptic Partial Differential Equations, in Sparse    SLAP........450600
C                  Matrix Computations, Bunch and Rose, Eds., Academic   SLAP........450700
C                  Press, New York, 1979.                                SLAP........450800
C***ROUTINES CALLED  DCG, DCHKW, DS2Y, DSICS, DSLLTI, DSMV, XERMSG       SLAP........450900
C***REVISION HISTORY  (YYMMDD)                                           SLAP........451000
C   890404  DATE WRITTEN                                                 SLAP........451100
C   890404  Previous REVISION DATE                                       SLAP........451200
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........451300
C   890921  Removed TeX from comments.  (FNF)                            SLAP........451400
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........451500
C           standard.  (FNF)                                             SLAP........451600
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........451700
C   900805  Changed XERRWV calls to calls to XERMSG.  (RWC)              SLAP........451800
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........451900
C   920407  COMMON BLOCK renamed DSLBLK.  (WRB)                          SLAP........452000
C   920511  Added complete declaration section.  (WRB)                   SLAP........452100
C   920929  Corrected format of references.  (FNF)                       SLAP........452200
C   921019  Corrected NEL to NL.  (FNF)                                  SLAP........452300
C***END PROLOGUE  DSICCG                                                 SLAP........452400
C     .. Parameters ..                                                   SLAP........452500
      INTEGER LOCRB, LOCIB                                               SLAP........452600
      PARAMETER (LOCRB=1, LOCIB=11)                                      SLAP........452700
C     .. Scalar Arguments ..                                             SLAP........452800
      DOUBLE PRECISION ERR, TOL                                          SLAP........452900
      INTEGER IERR, ISYM, ITER, ITMAX, ITOL, IUNIT, LENIW, LENW, N, NELT SLAP........453000
C     .. Array Arguments ..                                              SLAP........453100
      DOUBLE PRECISION A(NELT), B(N), RWORK(LENW), X(N)                  SLAP........453200
      INTEGER IA(NELT), IWORK(LENIW), JA(NELT)                           SLAP........453300
C     .. Local Scalars ..                                                SLAP........453400
      INTEGER LOCDIN, LOCDZ, LOCEL, LOCIEL, LOCIW, LOCJEL, LOCP, LOCR,   SLAP........453500
     +        LOCW, LOCZ, NL                                             SLAP........453600
      CHARACTER XERN1*8                                                  SLAP........453700
C     .. External Subroutines ..                                         SLAP........453800
      EXTERNAL DCG, DCHKW, DS2Y, DSICS, DSLLTI, DSMV, XERMSG             SLAP........453900
C***FIRST EXECUTABLE STATEMENT  DSICCG                                   SLAP........454000
C                                                                        SLAP........454100
      IERR = 0                                                           SLAP........454200
      IF( N.LT.1 .OR. NELT.LT.1 ) THEN                                   SLAP........454300
         IERR = 3                                                        SLAP........454400
         RETURN                                                          SLAP........454500
      ENDIF                                                              SLAP........454600
C                                                                        SLAP........454700
C         Change the SLAP input matrix IA, JA, A to SLAP-Column format.  SLAP........454800
      CALL DS2Y( N, NELT, IA, JA, A, ISYM )                              SLAP........454900
C                                                                        SLAP........455000
C         Count number of elements in lower triangle of the matrix.      SLAP........455100
C         Then set up the work arrays.                                   SLAP........455200
      IF( ISYM.EQ.0 ) THEN                                               SLAP........455300
         NL = (NELT + N)/2                                               SLAP........455400
      ELSE                                                               SLAP........455500
         NL = NELT                                                       SLAP........455600
      ENDIF                                                              SLAP........455700
C                                                                        SLAP........455800
      LOCJEL = LOCIB                                                     SLAP........455900
      LOCIEL = LOCJEL + NL                                               SLAP........456000
C.....THE NEXT LINE OF CODE INCORPORATES A BUG FIX MADE DURING           SLAP........456100
C        INTEGRATION OF SLAP WITH SUTRA.  IT ORIGINALLY READ:            SLAP........456200
C        LOCIW = LOCIEL + N + 1                                          SLAP........456300
      LOCIW = LOCIEL + NL                                                SLAP........456400
C                                                                        SLAP........456500
      LOCEL = LOCRB                                                      SLAP........456600
      LOCDIN = LOCEL + NL                                                SLAP........456700
      LOCR = LOCDIN + N                                                  SLAP........456800
      LOCZ = LOCR + N                                                    SLAP........456900
      LOCP = LOCZ + N                                                    SLAP........457000
      LOCDZ = LOCP + N                                                   SLAP........457100
      LOCW = LOCDZ + N                                                   SLAP........457200
C                                                                        SLAP........457300
C         Check the workspace allocations.                               SLAP........457400
      CALL DCHKW( 'DSICCG', LOCIW, LENIW, LOCW, LENW, IERR, ITER, ERR )  SLAP........457500
      IF( IERR.NE.0 ) RETURN                                             SLAP........457600
C                                                                        SLAP........457700
      IWORK(1) = NL                                                      SLAP........457800
      IWORK(2) = LOCJEL                                                  SLAP........457900
      IWORK(3) = LOCIEL                                                  SLAP........458000
      IWORK(4) = LOCEL                                                   SLAP........458100
      IWORK(5) = LOCDIN                                                  SLAP........458200
      IWORK(9) = LOCIW                                                   SLAP........458300
      IWORK(10) = LOCW                                                   SLAP........458400
C                                                                        SLAP........458500
C         Compute the Incomplete Cholesky decomposition.                 SLAP........458600
C                                                                        SLAP........458700
      CALL DSICS(N, NELT, IA, JA, A, ISYM, NL, IWORK(LOCIEL),            SLAP........458800
     $     IWORK(LOCJEL), RWORK(LOCEL), RWORK(LOCDIN),                   SLAP........458900
     $     RWORK(LOCR), IERR )                                           SLAP........459000
      IF( IERR.NE.0 ) THEN                                               SLAP........459100
         WRITE (XERN1, '(I8)') IERR                                      SLAP........459200
         CALL XERMSG ('SLATEC', 'DSICCG',                                SLAP........459300
     $      'IC factorization broke down on step ' // XERN1 //           SLAP........459400
     $      '.  Diagonal was set to unity and factorization proceeded.', SLAP........459500
     $      1, 1)                                                        SLAP........459600
         IERR = 7                                                        SLAP........459700
      ENDIF                                                              SLAP........459800
C                                                                        SLAP........459900
C         Do the Preconditioned Conjugate Gradient.                      SLAP........460000
      CALL DCG(N, B, X, NELT, IA, JA, A, ISYM, DSMV, DSLLTI,             SLAP........460100
     $     ITOL, TOL, ITMAX, ITER, ERR, IERR, IUNIT, RWORK(LOCR),        SLAP........460200
     $     RWORK(LOCZ), RWORK(LOCP), RWORK(LOCDZ), RWORK(1),             SLAP........460300
     $     IWORK(1))                                                     SLAP........460400
      RETURN                                                             SLAP........460500
C------------- LAST LINE OF DSICCG FOLLOWS ----------------------------  SLAP........460600
      END                                                                SLAP........460700
*DECK DSICS                                                              SLAP........460800
      SUBROUTINE DSICS (N, NELT, IA, JA, A, ISYM, NEL, IEL, JEL, EL, D,  SLAP........460900
     +   R, IWARN)                                                       SLAP........461000
C***BEGIN PROLOGUE  DSICS                                                SLAP........461100
C***PURPOSE  Incompl. Cholesky Decomposition Preconditioner SLAP Set Up. SLAP........461200
C            Routine to generate the Incomplete Cholesky decomposition,  SLAP........461300
C            L*D*L-trans, of a symmetric positive definite matrix, A,    SLAP........461400
C            which is stored in SLAP Column format.  The unit lower      SLAP........461500
C            triangular matrix L is stored by rows, and the inverse of   SLAP........461600
C            the diagonal matrix D is stored.                            SLAP........461700
C***LIBRARY   SLATEC (SLAP)                                              SLAP........461800
C***CATEGORY  D2E                                                        SLAP........461900
C***TYPE      DOUBLE PRECISION (SSICS-S, DSICS-D)                        SLAP........462000
C***KEYWORDS  INCOMPLETE CHOLESKY FACTORIZATION,                         SLAP........462100
C             ITERATIVE PRECONDITION, LINEAR SYSTEM, SLAP SPARSE         SLAP........462200
C***AUTHOR  Greenbaum, Anne, (Courant Institute)                         SLAP........462300
C           Seager, Mark K., (LLNL)                                      SLAP........462400
C             Lawrence Livermore National Laboratory                     SLAP........462500
C             PO BOX 808, L-60                                           SLAP........462600
C             Livermore, CA 94550 (510) 423-3141                         SLAP........462700
C             seager@llnl.gov                                            SLAP........462800
C***DESCRIPTION                                                          SLAP........462900
C                                                                        SLAP........463000
C *Usage:                                                                SLAP........463100
C     INTEGER N, NELT, IA(NELT), JA(NELT), ISYM                          SLAP........463200
C     INTEGER NEL, IEL(NEL), JEL(NEL), IWARN                             SLAP........463300
C     DOUBLE PRECISION A(NELT), EL(NEL), D(N), R(N)                      SLAP........463400
C                                                                        SLAP........463500
C     CALL DSICS( N, NELT, IA, JA, A, ISYM, NEL, IEL, JEL, EL, D, R,     SLAP........463600
C    $    IWARN )                                                        SLAP........463700
C                                                                        SLAP........463800
C *Arguments:                                                            SLAP........463900
C N      :IN       Integer.                                              SLAP........464000
C         Order of the Matrix.                                           SLAP........464100
C NELT   :IN       Integer.                                              SLAP........464200
C         Number of elements in arrays IA, JA, and A.                    SLAP........464300
C IA     :INOUT    Integer IA(NELT).                                     SLAP........464400
C JA     :INOUT    Integer JA(NELT).                                     SLAP........464500
C A      :INOUT    Double Precision A(NELT).                             SLAP........464600
C         These arrays should hold the matrix A in the SLAP Column       SLAP........464700
C         format.  See "Description", below.                             SLAP........464800
C ISYM   :IN       Integer.                                              SLAP........464900
C         Flag to indicate symmetric storage format.                     SLAP........465000
C         If ISYM=0, all non-zero entries of the matrix are stored.      SLAP........465100
C         If ISYM=1, the matrix is symmetric, and only the lower         SLAP........465200
C         triangle of the matrix is stored.                              SLAP........465300
C NEL    :OUT      Integer.                                              SLAP........465400
C         Number of non-zeros in the lower triangle of A.   Also         SLAP........465500
C         corresponds to the length of the IEL, JEL, EL arrays.          SLAP........465600
C IEL    :OUT      Integer IEL(NEL).                                     SLAP........465700
C JEL    :OUT      Integer JEL(NEL).                                     SLAP........465800
C EL     :OUT      Double Precision EL(NEL).                             SLAP........465900
C         IEL, JEL, EL contain the unit lower triangular factor  of the  SLAP........466000
C         incomplete decomposition   of the A  matrix  stored  in  SLAP  SLAP........466100
C         Row format.   The Diagonal of   ones   *IS*   stored.     See  SLAP........466200
C         "Description", below for more details about the SLAP Row fmt.  SLAP........466300
C D      :OUT      Double Precision D(N)                                 SLAP........466400
C         Upon return this array holds D(I) = 1./DIAG(A).                SLAP........466500
C R      :WORK     Double Precision R(N).                                SLAP........466600
C         Temporary double precision workspace needed for the            SLAP........466700
C         factorization.                                                 SLAP........466800
C IWARN  :OUT      Integer.                                              SLAP........466900
C         This is a warning variable and is zero if the IC factoriza-    SLAP........467000
C         tion goes well.  It is set to the row index corresponding to   SLAP........467100
C         the last zero pivot found.  See "Description", below.          SLAP........467200
C                                                                        SLAP........467300
C *Description                                                           SLAP........467400
C       =================== S L A P Column format ==================     SLAP........467500
C       This routine  requires that  the matrix A  be stored in  the     SLAP........467600
C       SLAP Column format.  In this format the non-zeros are stored     SLAP........467700
C       counting down columns (except for  the diagonal entry, which     SLAP........467800
C       must appear first in each  "column")  and are stored  in the     SLAP........467900
C       double precision array A.   In other words,  for each column     SLAP........468000
C       in the matrix put the diagonal entry in  A.  Then put in the     SLAP........468100
C       other non-zero  elements going down  the column (except  the     SLAP........468200
C       diagonal) in order.   The  IA array holds the  row index for     SLAP........468300
C       each non-zero.  The JA array holds the offsets  into the IA,     SLAP........468400
C       A arrays  for  the  beginning  of each   column.   That  is,     SLAP........468500
C       IA(JA(ICOL)),  A(JA(ICOL)) points   to the beginning  of the     SLAP........468600
C       ICOL-th   column    in    IA and   A.      IA(JA(ICOL+1)-1),     SLAP........468700
C       A(JA(ICOL+1)-1) points to  the  end of the   ICOL-th column.     SLAP........468800
C       Note that we always have  JA(N+1) = NELT+1,  where N is  the     SLAP........468900
C       number of columns in  the matrix and NELT  is the number  of     SLAP........469000
C       non-zeros in the matrix.                                         SLAP........469100
C                                                                        SLAP........469200
C       Here is an example of the  SLAP Column  storage format for a     SLAP........469300
C       5x5 Matrix (in the A and IA arrays '|'  denotes the end of a     SLAP........469400
C       column):                                                         SLAP........469500
C                                                                        SLAP........469600
C           5x5 Matrix      SLAP Column format for 5x5 matrix on left.   SLAP........469700
C                              1  2  3    4  5    6  7    8    9 10 11   SLAP........469800
C       |11 12  0  0 15|   A: 11 21 51 | 22 12 | 33 53 | 44 | 55 15 35   SLAP........469900
C       |21 22  0  0  0|  IA:  1  2  5 |  2  1 |  3  5 |  4 |  5  1  3   SLAP........470000
C       | 0  0 33  0 35|  JA:  1  4  6    8  9   12                      SLAP........470100
C       | 0  0  0 44  0|                                                 SLAP........470200
C       |51  0 53  0 55|                                                 SLAP........470300
C                                                                        SLAP........470400
C       ==================== S L A P Row format ====================     SLAP........470500
C                                                                        SLAP........470600
C       This routine requires  that the matrix A  be  stored  in the     SLAP........470700
C       SLAP  Row format.   In this format  the non-zeros are stored     SLAP........470800
C       counting across  rows (except for the diagonal  entry, which     SLAP........470900
C       must  appear first  in each  "row")  and  are stored  in the     SLAP........471000
C       double precision  array A.  In other words, for each row  in     SLAP........471100
C       the matrix  put the diagonal  entry in A.   Then put in  the     SLAP........471200
C       other  non-zero elements  going across  the row  (except the     SLAP........471300
C       diagonal) in order.  The JA array holds the column index for     SLAP........471400
C       each non-zero.  The IA array holds the offsets  into the JA,     SLAP........471500
C       A  arrays  for  the   beginning  of  each  row.    That  is,     SLAP........471600
C       JA(IA(IROW)),A(IA(IROW)) are the first elements of the IROW-     SLAP........471700
C       th row in  JA and A,  and  JA(IA(IROW+1)-1), A(IA(IROW+1)-1)     SLAP........471800
C       are  the last elements  of the  IROW-th row.   Note  that we     SLAP........471900
C       always have  IA(N+1) = NELT+1, where N is the number of rows     SLAP........472000
C       in the matrix  and  NELT is the  number of non-zeros  in the     SLAP........472100
C       matrix.                                                          SLAP........472200
C                                                                        SLAP........472300
C       Here is an example of the SLAP Row storage format for a  5x5     SLAP........472400
C       Matrix (in the A and JA arrays '|' denotes the end of a row):    SLAP........472500
C                                                                        SLAP........472600
C           5x5 Matrix         SLAP Row format for 5x5 matrix on left.   SLAP........472700
C                              1  2  3    4  5    6  7    8    9 10 11   SLAP........472800
C       |11 12  0  0 15|   A: 11 12 15 | 22 21 | 33 35 | 44 | 55 51 53   SLAP........472900
C       |21 22  0  0  0|  JA:  1  2  5 |  2  1 |  3  5 |  4 |  5  1  3   SLAP........473000
C       | 0  0 33  0 35|  IA:  1  4  6    8  9   12                      SLAP........473100
C       | 0  0  0 44  0|                                                 SLAP........473200
C       |51  0 53  0 55|                                                 SLAP........473300
C                                                                        SLAP........473400
C       With the SLAP  format some  of  the   "inner  loops" of this     SLAP........473500
C       routine should vectorize  on  machines with hardware support     SLAP........473600
C       for vector   gather/scatter  operations.  Your compiler  may     SLAP........473700
C       require a compiler directive to  convince it that  there are     SLAP........473800
C       no  implicit  vector  dependencies.  Compiler directives for     SLAP........473900
C       the Alliant    FX/Fortran and CRI   CFT/CFT77 compilers  are     SLAP........474000
C       supplied with the standard SLAP distribution.                    SLAP........474100
C                                                                        SLAP........474200
C       The IC factorization does not always exist for SPD matrices.     SLAP........474300
C       In the event that a zero pivot is found it is set  to be 1.0     SLAP........474400
C       and the factorization proceeds.   The integer variable IWARN     SLAP........474500
C       is set to the last row where the Diagonal was fudged.  This      SLAP........474600
C       eventuality hardly ever occurs in practice.                      SLAP........474700
C                                                                        SLAP........474800
C***SEE ALSO  DCG, DSICCG                                                SLAP........474900
C***REFERENCES  1. Gene Golub and Charles Van Loan, Matrix Computations, SLAP........475000
C                  Johns Hopkins University Press, Baltimore, Maryland,  SLAP........475100
C                  1983.                                                 SLAP........475200
C***ROUTINES CALLED  XERMSG                                              SLAP........475300
C***REVISION HISTORY  (YYMMDD)                                           SLAP........475400
C   890404  DATE WRITTEN                                                 SLAP........475500
C   890404  Previous REVISION DATE                                       SLAP........475600
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........475700
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........475800
C           standard.  (FNF)                                             SLAP........475900
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........476000
C   900805  Changed XERRWV calls to calls to XERMSG.  (RWC)              SLAP........476100
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........476200
C   920511  Added complete declaration section.  (WRB)                   SLAP........476300
C   920929  Corrected format of reference.  (FNF)                        SLAP........476400
C   930701  Updated CATEGORY section.  (FNF, WRB)                        SLAP........476500
C***END PROLOGUE  DSICS                                                  SLAP........476600
C     .. Scalar Arguments ..                                             SLAP........476700
      INTEGER ISYM, IWARN, N, NEL, NELT                                  SLAP........476800
C     .. Array Arguments ..                                              SLAP........476900
      DOUBLE PRECISION A(NELT), D(N), EL(NEL), R(N)                      SLAP........477000
      INTEGER IA(NELT), IEL(NEL), JA(NELT), JEL(NEL)                     SLAP........477100
C     .. Local Scalars ..                                                SLAP........477200
      DOUBLE PRECISION ELTMP                                             SLAP........477300
      INTEGER I, IBGN, IC, ICBGN, ICEND, ICOL, IEND, IR, IRBGN, IREND,   SLAP........477400
     +        IROW, IRR, J, JBGN, JELTMP, JEND                           SLAP........477500
      CHARACTER XERN1*8                                                  SLAP........477600
C     .. External Subroutines ..                                         SLAP........477700
      EXTERNAL XERMSG                                                    SLAP........477800
C***FIRST EXECUTABLE STATEMENT  DSICS                                    SLAP........477900
C                                                                        SLAP........478000
C         Set the lower triangle in IEL, JEL, EL                         SLAP........478100
C                                                                        SLAP........478200
      IWARN = 0                                                          SLAP........478300
C                                                                        SLAP........478400
C         All matrix elements stored in IA, JA, A.  Pick out the lower   SLAP........478500
C         triangle (making sure that the Diagonal of EL is one) and      SLAP........478600
C         store by rows.                                                 SLAP........478700
C                                                                        SLAP........478800
      NEL = 1                                                            SLAP........478900
      IEL(1) = 1                                                         SLAP........479000
      JEL(1) = 1                                                         SLAP........479100
      EL(1) = 1                                                          SLAP........479200
      D(1) = A(1)                                                        SLAP........479300
CVD$R NOCONCUR                                                           SLAP........479400
      DO 30 IROW = 2, N                                                  SLAP........479500
C         Put in the Diagonal.                                           SLAP........479600
         NEL = NEL + 1                                                   SLAP........479700
         IEL(IROW) = NEL                                                 SLAP........479800
         JEL(NEL) = IROW                                                 SLAP........479900
         EL(NEL) = 1                                                     SLAP........480000
         D(IROW) = A(JA(IROW))                                           SLAP........480100
C                                                                        SLAP........480200
C         Look in all the lower triangle columns for a matching row.     SLAP........480300
C         Since the matrix is symmetric, we can look across the          SLAP........480400
C         IROW-th row by looking down the IROW-th column (if it is       SLAP........480500
C         stored ISYM=0)...                                              SLAP........480600
         IF( ISYM.EQ.0 ) THEN                                            SLAP........480700
            ICBGN = JA(IROW)                                             SLAP........480800
            ICEND = JA(IROW+1)-1                                         SLAP........480900
         ELSE                                                            SLAP........481000
            ICBGN = 1                                                    SLAP........481100
            ICEND = IROW-1                                               SLAP........481200
         ENDIF                                                           SLAP........481300
         DO 20 IC = ICBGN, ICEND                                         SLAP........481400
            IF( ISYM.EQ.0 ) THEN                                         SLAP........481500
               ICOL = IA(IC)                                             SLAP........481600
               IF( ICOL.GE.IROW ) GOTO 20                                SLAP........481700
            ELSE                                                         SLAP........481800
               ICOL = IC                                                 SLAP........481900
            ENDIF                                                        SLAP........482000
            JBGN = JA(ICOL)+1                                            SLAP........482100
            JEND = JA(ICOL+1)-1                                          SLAP........482200
            IF( JBGN.LE.JEND .AND. IA(JEND).GE.IROW ) THEN               SLAP........482300
CVD$ NOVECTOR                                                            SLAP........482400
               DO 10 J = JBGN, JEND                                      SLAP........482500
                  IF( IA(J).EQ.IROW ) THEN                               SLAP........482600
                     NEL = NEL + 1                                       SLAP........482700
                     JEL(NEL) = ICOL                                     SLAP........482800
                     EL(NEL)  = A(J)                                     SLAP........482900
                     GOTO 20                                             SLAP........483000
                  ENDIF                                                  SLAP........483100
 10            CONTINUE                                                  SLAP........483200
            ENDIF                                                        SLAP........483300
 20      CONTINUE                                                        SLAP........483400
 30   CONTINUE                                                           SLAP........483500
      IEL(N+1) = NEL+1                                                   SLAP........483600
C                                                                        SLAP........483700
C         Sort ROWS of lower triangle into descending order (count out   SLAP........483800
C         along rows out from Diagonal).                                 SLAP........483900
C                                                                        SLAP........484000
      DO 60 IROW = 2, N                                                  SLAP........484100
         IBGN = IEL(IROW)+1                                              SLAP........484200
         IEND = IEL(IROW+1)-1                                            SLAP........484300
         IF( IBGN.LT.IEND ) THEN                                         SLAP........484400
            DO 50 I = IBGN, IEND-1                                       SLAP........484500
CVD$ NOVECTOR                                                            SLAP........484600
               DO 40 J = I+1, IEND                                       SLAP........484700
                  IF( JEL(I).GT.JEL(J) ) THEN                            SLAP........484800
                     JELTMP = JEL(J)                                     SLAP........484900
                     JEL(J) = JEL(I)                                     SLAP........485000
                     JEL(I) = JELTMP                                     SLAP........485100
                     ELTMP = EL(J)                                       SLAP........485200
                     EL(J) = EL(I)                                       SLAP........485300
                     EL(I) = ELTMP                                       SLAP........485400
                  ENDIF                                                  SLAP........485500
 40            CONTINUE                                                  SLAP........485600
 50         CONTINUE                                                     SLAP........485700
         ENDIF                                                           SLAP........485800
 60   CONTINUE                                                           SLAP........485900
C                                                                        SLAP........486000
C         Perform the Incomplete Cholesky decomposition by looping       SLAP........486100
C         over the rows.                                                 SLAP........486200
C         Scale the first column.  Use the structure of A to pick out    SLAP........486300
C         the rows with something in column 1.                           SLAP........486400
C                                                                        SLAP........486500
      IRBGN = JA(1)+1                                                    SLAP........486600
      IREND = JA(2)-1                                                    SLAP........486700
      DO 65 IRR = IRBGN, IREND                                           SLAP........486800
         IR = IA(IRR)                                                    SLAP........486900
C         Find the index into EL for EL(1,IR).                           SLAP........487000
C         Hint: it's the second entry.                                   SLAP........487100
         I = IEL(IR)+1                                                   SLAP........487200
         EL(I) = EL(I)/D(1)                                              SLAP........487300
 65   CONTINUE                                                           SLAP........487400
C                                                                        SLAP........487500
      DO 110 IROW = 2, N                                                 SLAP........487600
C                                                                        SLAP........487700
C         Update the IROW-th diagonal.                                   SLAP........487800
C                                                                        SLAP........487900
         DO 66 I = 1, IROW-1                                             SLAP........488000
            R(I) = 0                                                     SLAP........488100
 66      CONTINUE                                                        SLAP........488200
         IBGN = IEL(IROW)+1                                              SLAP........488300
         IEND = IEL(IROW+1)-1                                            SLAP........488400
         IF( IBGN.LE.IEND ) THEN                                         SLAP........488500
CLLL. OPTION ASSERT (NOHAZARD)                                           SLAP........488600
CDIR$ IVDEP                                                              SLAP........488700
CVD$ NODEPCHK                                                            SLAP........488800
            DO 70 I = IBGN, IEND                                         SLAP........488900
               R(JEL(I)) = EL(I)*D(JEL(I))                               SLAP........489000
               D(IROW) = D(IROW) - EL(I)*R(JEL(I))                       SLAP........489100
 70         CONTINUE                                                     SLAP........489200
C                                                                        SLAP........489300
C         Check to see if we have a problem with the diagonal.           SLAP........489400
C                                                                        SLAP........489500
            IF( D(IROW).LE.0.0D0 ) THEN                                  SLAP........489600
               IF( IWARN.EQ.0 ) IWARN = IROW                             SLAP........489700
               D(IROW) = 1                                               SLAP........489800
            ENDIF                                                        SLAP........489900
         ENDIF                                                           SLAP........490000
C                                                                        SLAP........490100
C         Update each EL(IROW+1:N,IROW), if there are any.               SLAP........490200
C         Use the structure of A to determine the Non-zero elements      SLAP........490300
C         of the IROW-th column of EL.                                   SLAP........490400
C                                                                        SLAP........490500
         IRBGN = JA(IROW)                                                SLAP........490600
         IREND = JA(IROW+1)-1                                            SLAP........490700
         DO 100 IRR = IRBGN, IREND                                       SLAP........490800
            IR = IA(IRR)                                                 SLAP........490900
            IF( IR.LE.IROW ) GOTO 100                                    SLAP........491000
C         Find the index into EL for EL(IR,IROW)                         SLAP........491100
            IBGN = IEL(IR)+1                                             SLAP........491200
            IEND = IEL(IR+1)-1                                           SLAP........491300
            IF( JEL(IBGN).GT.IROW ) GOTO 100                             SLAP........491400
            DO 90 I = IBGN, IEND                                         SLAP........491500
               IF( JEL(I).EQ.IROW ) THEN                                 SLAP........491600
                  ICEND = IEND                                           SLAP........491700
 91               IF( JEL(ICEND).GE.IROW ) THEN                          SLAP........491800
                     ICEND = ICEND - 1                                   SLAP........491900
                     GOTO 91                                             SLAP........492000
                  ENDIF                                                  SLAP........492100
C         Sum up the EL(IR,1:IROW-1)*R(1:IROW-1) contributions.          SLAP........492200
CLLL. OPTION ASSERT (NOHAZARD)                                           SLAP........492300
CDIR$ IVDEP                                                              SLAP........492400
CVD$ NODEPCHK                                                            SLAP........492500
                  DO 80 IC = IBGN, ICEND                                 SLAP........492600
                     EL(I) = EL(I) - EL(IC)*R(JEL(IC))                   SLAP........492700
 80               CONTINUE                                               SLAP........492800
                  EL(I) = EL(I)/D(IROW)                                  SLAP........492900
                  GOTO 100                                               SLAP........493000
               ENDIF                                                     SLAP........493100
 90         CONTINUE                                                     SLAP........493200
C                                                                        SLAP........493300
C         If we get here, we have real problems...                       SLAP........493400
            WRITE (XERN1, '(I8)') IROW                                   SLAP........493500
            CALL XERMSG ('SLATEC', 'DSICS',                              SLAP........493600
     $         'A and EL data structure mismatch in row '// XERN1, 1, 2) SLAP........493700
 100     CONTINUE                                                        SLAP........493800
 110  CONTINUE                                                           SLAP........493900
C                                                                        SLAP........494000
C         Replace diagonals by their inverses.                           SLAP........494100
C                                                                        SLAP........494200
CVD$ CONCUR                                                              SLAP........494300
      DO 120 I =1, N                                                     SLAP........494400
         D(I) = 1.0D0/D(I)                                               SLAP........494500
 120  CONTINUE                                                           SLAP........494600
      RETURN                                                             SLAP........494700
C------------- LAST LINE OF DSICS FOLLOWS ----------------------------   SLAP........494800
      END                                                                SLAP........494900
*DECK DSILUS                                                             SLAP........495000
      SUBROUTINE DSILUS (N, NELT, IA, JA, A, ISYM, NL, IL, JL, L, DINV,  SLAP........495100
     +   NU, IU, JU, U, NROW, NCOL)                                      SLAP........495200
C***BEGIN PROLOGUE  DSILUS                                               SLAP........495300
C***PURPOSE  Incomplete LU Decomposition Preconditioner SLAP Set Up.     SLAP........495400
C            Routine to generate the incomplete LDU decomposition of a   SLAP........495500
C            matrix.  The unit lower triangular factor L is stored by    SLAP........495600
C            rows and the unit upper triangular factor U is stored by    SLAP........495700
C            columns.  The inverse of the diagonal matrix D is stored.   SLAP........495800
C            No fill in is allowed.                                      SLAP........495900
C***LIBRARY   SLATEC (SLAP)                                              SLAP........496000
C***CATEGORY  D2E                                                        SLAP........496100
C***TYPE      DOUBLE PRECISION (SSILUS-S, DSILUS-D)                      SLAP........496200
C***KEYWORDS  INCOMPLETE LU FACTORIZATION, ITERATIVE PRECONDITION,       SLAP........496300
C             NON-SYMMETRIC LINEAR SYSTEM, SLAP, SPARSE                  SLAP........496400
C***AUTHOR  Greenbaum, Anne, (Courant Institute)                         SLAP........496500
C           Seager, Mark K., (LLNL)                                      SLAP........496600
C             Lawrence Livermore National Laboratory                     SLAP........496700
C             PO BOX 808, L-60                                           SLAP........496800
C             Livermore, CA 94550 (510) 423-3141                         SLAP........496900
C             seager@llnl.gov                                            SLAP........497000
C***DESCRIPTION                                                          SLAP........497100
C                                                                        SLAP........497200
C *Usage:                                                                SLAP........497300
C     INTEGER N, NELT, IA(NELT), JA(NELT), ISYM                          SLAP........497400
C     INTEGER NL, IL(NL), JL(NL), NU, IU(NU), JU(NU)                     SLAP........497500
C     INTEGER NROW(N), NCOL(N)                                           SLAP........497600
C     DOUBLE PRECISION A(NELT), L(NL), DINV(N), U(NU)                    SLAP........497700
C                                                                        SLAP........497800
C     CALL DSILUS( N, NELT, IA, JA, A, ISYM, NL, IL, JL, L,              SLAP........497900
C    $    DINV, NU, IU, JU, U, NROW, NCOL )                              SLAP........498000
C                                                                        SLAP........498100
C *Arguments:                                                            SLAP........498200
C N      :IN       Integer                                               SLAP........498300
C         Order of the Matrix.                                           SLAP........498400
C NELT   :IN       Integer.                                              SLAP........498500
C         Number of elements in arrays IA, JA, and A.                    SLAP........498600
C IA     :IN       Integer IA(NELT).                                     SLAP........498700
C JA     :IN       Integer JA(NELT).                                     SLAP........498800
C A      :IN       Double Precision A(NELT).                             SLAP........498900
C         These arrays should hold the matrix A in the SLAP Column       SLAP........499000
C         format.  See "Description", below.                             SLAP........499100
C ISYM   :IN       Integer.                                              SLAP........499200
C         Flag to indicate symmetric storage format.                     SLAP........499300
C         If ISYM=0, all non-zero entries of the matrix are stored.      SLAP........499400
C         If ISYM=1, the matrix is symmetric, and only the lower         SLAP........499500
C         triangle of the matrix is stored.                              SLAP........499600
C NL     :OUT      Integer.                                              SLAP........499700
C         Number of non-zeros in the L array.                            SLAP........499800
C IL     :OUT      Integer IL(NL).                                       SLAP........499900
C JL     :OUT      Integer JL(NL).                                       SLAP........500000
C L      :OUT      Double Precision L(NL).                               SLAP........500100
C         IL, JL, L  contain the unit lower triangular factor of  the    SLAP........500200
C         incomplete decomposition  of some  matrix stored  in   SLAP    SLAP........500300
C         Row format.     The   Diagonal  of ones  *IS*  stored.  See    SLAP........500400
C         "DESCRIPTION", below for more details about the SLAP format.   SLAP........500500
C NU     :OUT      Integer.                                              SLAP........500600
C         Number of non-zeros in the U array.                            SLAP........500700
C IU     :OUT      Integer IU(NU).                                       SLAP........500800
C JU     :OUT      Integer JU(NU).                                       SLAP........500900
C U      :OUT      Double Precision     U(NU).                           SLAP........501000
C         IU, JU, U contain   the unit upper triangular factor of the    SLAP........501100
C         incomplete  decomposition    of some matrix  stored in SLAP    SLAP........501200
C         Column  format.   The Diagonal of ones   *IS*  stored.  See    SLAP........501300
C         "Description", below  for  more  details  about  the   SLAP    SLAP........501400
C         format.                                                        SLAP........501500
C NROW   :WORK     Integer NROW(N).                                      SLAP........501600
C         NROW(I) is the number of non-zero elements in the I-th row     SLAP........501700
C         of L.                                                          SLAP........501800
C NCOL   :WORK     Integer NCOL(N).                                      SLAP........501900
C         NCOL(I) is the number of non-zero elements in the I-th         SLAP........502000
C         column of U.                                                   SLAP........502100
C                                                                        SLAP........502200
C *Description                                                           SLAP........502300
C       IL, JL, L should contain the unit  lower triangular factor of    SLAP........502400
C       the incomplete decomposition of the A matrix  stored in SLAP     SLAP........502500
C       Row format.  IU, JU, U should contain  the unit upper factor     SLAP........502600
C       of the  incomplete decomposition of  the A matrix  stored in     SLAP........502700
C       SLAP Column format This ILU factorization can be computed by     SLAP........502800
C       the DSILUS routine. The diagonals (which are all one's) are      SLAP........502900
C       stored.                                                          SLAP........503000
C                                                                        SLAP........503100
C       =================== S L A P Column format ==================     SLAP........503200
C                                                                        SLAP........503300
C       This routine  requires that  the matrix A  be stored in  the     SLAP........503400
C       SLAP Column format.  In this format the non-zeros are stored     SLAP........503500
C       counting down columns (except for  the diagonal entry, which     SLAP........503600
C       must appear first in each  "column")  and are stored  in the     SLAP........503700
C       double precision array A.   In other words,  for each column     SLAP........503800
C       in the matrix put the diagonal entry in  A.  Then put in the     SLAP........503900
C       other non-zero  elements going down  the column (except  the     SLAP........504000
C       diagonal) in order.   The  IA array holds the  row index for     SLAP........504100
C       each non-zero.  The JA array holds the offsets  into the IA,     SLAP........504200
C       A arrays  for  the  beginning  of each   column.   That  is,     SLAP........504300
C       IA(JA(ICOL)),  A(JA(ICOL)) points   to the beginning  of the     SLAP........504400
C       ICOL-th   column    in    IA and   A.      IA(JA(ICOL+1)-1),     SLAP........504500
C       A(JA(ICOL+1)-1) points to  the  end of the   ICOL-th column.     SLAP........504600
C       Note that we always have  JA(N+1) = NELT+1,  where N is  the     SLAP........504700
C       number of columns in  the matrix and NELT  is the number  of     SLAP........504800
C       non-zeros in the matrix.                                         SLAP........504900
C                                                                        SLAP........505000
C       Here is an example of the  SLAP Column  storage format for a     SLAP........505100
C       5x5 Matrix (in the A and IA arrays '|'  denotes the end of a     SLAP........505200
C       column):                                                         SLAP........505300
C                                                                        SLAP........505400
C           5x5 Matrix      SLAP Column format for 5x5 matrix on left.   SLAP........505500
C                              1  2  3    4  5    6  7    8    9 10 11   SLAP........505600
C       |11 12  0  0 15|   A: 11 21 51 | 22 12 | 33 53 | 44 | 55 15 35   SLAP........505700
C       |21 22  0  0  0|  IA:  1  2  5 |  2  1 |  3  5 |  4 |  5  1  3   SLAP........505800
C       | 0  0 33  0 35|  JA:  1  4  6    8  9   12                      SLAP........505900
C       | 0  0  0 44  0|                                                 SLAP........506000
C       |51  0 53  0 55|                                                 SLAP........506100
C                                                                        SLAP........506200
C       ==================== S L A P Row format ====================     SLAP........506300
C                                                                        SLAP........506400
C       This routine requires  that the matrix A  be  stored  in the     SLAP........506500
C       SLAP  Row format.   In this format  the non-zeros are stored     SLAP........506600
C       counting across  rows (except for the diagonal  entry, which     SLAP........506700
C       must  appear first  in each  "row")  and  are stored  in the     SLAP........506800
C       double precision  array A.  In other words, for each row  in     SLAP........506900
C       the matrix  put the diagonal  entry in A.   Then put in  the     SLAP........507000
C       other  non-zero elements  going across  the row  (except the     SLAP........507100
C       diagonal) in order.  The JA array holds the column index for     SLAP........507200
C       each non-zero.  The IA array holds the offsets  into the JA,     SLAP........507300
C       A  arrays  for  the   beginning  of  each  row.    That  is,     SLAP........507400
C       JA(IA(IROW)),A(IA(IROW)) are the first elements of the IROW-     SLAP........507500
C       th row in  JA and A,  and  JA(IA(IROW+1)-1), A(IA(IROW+1)-1)     SLAP........507600
C       are  the last elements  of the  IROW-th row.   Note  that we     SLAP........507700
C       always have  IA(N+1) = NELT+1, where N is the number of rows     SLAP........507800
C       in the matrix  and  NELT is the  number of non-zeros  in the     SLAP........507900
C       matrix.                                                          SLAP........508000
C                                                                        SLAP........508100
C       Here is an example of the SLAP Row storage format for a  5x5     SLAP........508200
C       Matrix (in the A and JA arrays '|' denotes the end of a row):    SLAP........508300
C                                                                        SLAP........508400
C           5x5 Matrix         SLAP Row format for 5x5 matrix on left.   SLAP........508500
C                              1  2  3    4  5    6  7    8    9 10 11   SLAP........508600
C       |11 12  0  0 15|   A: 11 12 15 | 22 21 | 33 35 | 44 | 55 51 53   SLAP........508700
C       |21 22  0  0  0|  JA:  1  2  5 |  2  1 |  3  5 |  4 |  5  1  3   SLAP........508800
C       | 0  0 33  0 35|  IA:  1  4  6    8  9   12                      SLAP........508900
C       | 0  0  0 44  0|                                                 SLAP........509000
C       |51  0 53  0 55|                                                 SLAP........509100
C                                                                        SLAP........509200
C***SEE ALSO  SILUR                                                      SLAP........509300
C***REFERENCES  1. Gene Golub and Charles Van Loan, Matrix Computations, SLAP........509400
C                  Johns Hopkins University Press, Baltimore, Maryland,  SLAP........509500
C                  1983.                                                 SLAP........509600
C***ROUTINES CALLED  (NONE)                                              SLAP........509700
C***REVISION HISTORY  (YYMMDD)                                           SLAP........509800
C   890404  DATE WRITTEN                                                 SLAP........509900
C   890404  Previous REVISION DATE                                       SLAP........510000
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........510100
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........510200
C           standard.  (FNF)                                             SLAP........510300
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........510400
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........510500
C   920511  Added complete declaration section.  (WRB)                   SLAP........510600
C   920929  Corrected format of reference.  (FNF)                        SLAP........510700
C   930701  Updated CATEGORY section.  (FNF, WRB)                        SLAP........510800
C***END PROLOGUE  DSILUS                                                 SLAP........510900
C     .. Scalar Arguments ..                                             SLAP........511000
      INTEGER ISYM, N, NELT, NL, NU                                      SLAP........511100
C     .. Array Arguments ..                                              SLAP........511200
      DOUBLE PRECISION A(NELT), DINV(N), L(NL), U(NU)                    SLAP........511300
      INTEGER IA(NELT), IL(NL), IU(NU), JA(NELT), JL(NL), JU(NU),        SLAP........511400
     +        NCOL(N), NROW(N)                                           SLAP........511500
C     .. Local Scalars ..                                                SLAP........511600
      DOUBLE PRECISION TEMP                                              SLAP........511700
      INTEGER I, IBGN, ICOL, IEND, INDX, INDX1, INDX2, INDXC1, INDXC2,   SLAP........511800
     +        INDXR1, INDXR2, IROW, ITEMP, J, JBGN, JEND, JTEMP, K, KC,  SLAP........511900
     +        KR                                                         SLAP........512000
C***FIRST EXECUTABLE STATEMENT  DSILUS                                   SLAP........512100
C                                                                        SLAP........512200
C         Count number of elements in each row of the lower triangle.    SLAP........512300
C                                                                        SLAP........512400
      DO 10 I=1,N                                                        SLAP........512500
         NROW(I) = 0                                                     SLAP........512600
         NCOL(I) = 0                                                     SLAP........512700
 10   CONTINUE                                                           SLAP........512800
CVD$R NOCONCUR                                                           SLAP........512900
CVD$R NOVECTOR                                                           SLAP........513000
      DO 30 ICOL = 1, N                                                  SLAP........513100
         JBGN = JA(ICOL)+1                                               SLAP........513200
         JEND = JA(ICOL+1)-1                                             SLAP........513300
         IF( JBGN.LE.JEND ) THEN                                         SLAP........513400
            DO 20 J = JBGN, JEND                                         SLAP........513500
               IF( IA(J).LT.ICOL ) THEN                                  SLAP........513600
                  NCOL(ICOL) = NCOL(ICOL) + 1                            SLAP........513700
               ELSE                                                      SLAP........513800
                  NROW(IA(J)) = NROW(IA(J)) + 1                          SLAP........513900
                  IF( ISYM.NE.0 ) NCOL(IA(J)) = NCOL(IA(J)) + 1          SLAP........514000
               ENDIF                                                     SLAP........514100
 20         CONTINUE                                                     SLAP........514200
         ENDIF                                                           SLAP........514300
 30   CONTINUE                                                           SLAP........514400
      JU(1) = 1                                                          SLAP........514500
      IL(1) = 1                                                          SLAP........514600
      DO 40 ICOL = 1, N                                                  SLAP........514700
         IL(ICOL+1) = IL(ICOL) + NROW(ICOL)                              SLAP........514800
         JU(ICOL+1) = JU(ICOL) + NCOL(ICOL)                              SLAP........514900
         NROW(ICOL) = IL(ICOL)                                           SLAP........515000
         NCOL(ICOL) = JU(ICOL)                                           SLAP........515100
 40   CONTINUE                                                           SLAP........515200
C                                                                        SLAP........515300
C         Copy the matrix A into the L and U structures.                 SLAP........515400
      DO 60 ICOL = 1, N                                                  SLAP........515500
         DINV(ICOL) = A(JA(ICOL))                                        SLAP........515600
         JBGN = JA(ICOL)+1                                               SLAP........515700
         JEND = JA(ICOL+1)-1                                             SLAP........515800
         IF( JBGN.LE.JEND ) THEN                                         SLAP........515900
            DO 50 J = JBGN, JEND                                         SLAP........516000
               IROW = IA(J)                                              SLAP........516100
               IF( IROW.LT.ICOL ) THEN                                   SLAP........516200
C         Part of the upper triangle.                                    SLAP........516300
                  IU(NCOL(ICOL)) = IROW                                  SLAP........516400
                  U(NCOL(ICOL)) = A(J)                                   SLAP........516500
                  NCOL(ICOL) = NCOL(ICOL) + 1                            SLAP........516600
               ELSE                                                      SLAP........516700
C         Part of the lower triangle (stored by row).                    SLAP........516800
                  JL(NROW(IROW)) = ICOL                                  SLAP........516900
                  L(NROW(IROW)) = A(J)                                   SLAP........517000
                  NROW(IROW) = NROW(IROW) + 1                            SLAP........517100
                  IF( ISYM.NE.0 ) THEN                                   SLAP........517200
C         Symmetric...Copy lower triangle into upper triangle as well.   SLAP........517300
                     IU(NCOL(IROW)) = ICOL                               SLAP........517400
                     U(NCOL(IROW)) = A(J)                                SLAP........517500
                     NCOL(IROW) = NCOL(IROW) + 1                         SLAP........517600
                  ENDIF                                                  SLAP........517700
               ENDIF                                                     SLAP........517800
 50         CONTINUE                                                     SLAP........517900
         ENDIF                                                           SLAP........518000
 60   CONTINUE                                                           SLAP........518100
C                                                                        SLAP........518200
C         Sort the rows of L and the columns of U.                       SLAP........518300
      DO 110 K = 2, N                                                    SLAP........518400
         JBGN = JU(K)                                                    SLAP........518500
         JEND = JU(K+1)-1                                                SLAP........518600
         IF( JBGN.LT.JEND ) THEN                                         SLAP........518700
            DO 80 J = JBGN, JEND-1                                       SLAP........518800
               DO 70 I = J+1, JEND                                       SLAP........518900
                  IF( IU(J).GT.IU(I) ) THEN                              SLAP........519000
                     ITEMP = IU(J)                                       SLAP........519100
                     IU(J) = IU(I)                                       SLAP........519200
                     IU(I) = ITEMP                                       SLAP........519300
                     TEMP = U(J)                                         SLAP........519400
                     U(J) = U(I)                                         SLAP........519500
                     U(I) = TEMP                                         SLAP........519600
                  ENDIF                                                  SLAP........519700
 70            CONTINUE                                                  SLAP........519800
 80         CONTINUE                                                     SLAP........519900
         ENDIF                                                           SLAP........520000
         IBGN = IL(K)                                                    SLAP........520100
         IEND = IL(K+1)-1                                                SLAP........520200
         IF( IBGN.LT.IEND ) THEN                                         SLAP........520300
            DO 100 I = IBGN, IEND-1                                      SLAP........520400
               DO 90 J = I+1, IEND                                       SLAP........520500
                  IF( JL(I).GT.JL(J) ) THEN                              SLAP........520600
                     JTEMP = JU(I)                                       SLAP........520700
                     JU(I) = JU(J)                                       SLAP........520800
                     JU(J) = JTEMP                                       SLAP........520900
                     TEMP = L(I)                                         SLAP........521000
                     L(I) = L(J)                                         SLAP........521100
                     L(J) = TEMP                                         SLAP........521200
                  ENDIF                                                  SLAP........521300
 90            CONTINUE                                                  SLAP........521400
 100        CONTINUE                                                     SLAP........521500
         ENDIF                                                           SLAP........521600
 110  CONTINUE                                                           SLAP........521700
C                                                                        SLAP........521800
C         Perform the incomplete LDU decomposition.                      SLAP........521900
      DO 300 I=2,N                                                       SLAP........522000
C                                                                        SLAP........522100
C           I-th row of L                                                SLAP........522200
         INDX1 = IL(I)                                                   SLAP........522300
         INDX2 = IL(I+1) - 1                                             SLAP........522400
         IF(INDX1 .GT. INDX2) GO TO 200                                  SLAP........522500
         DO 190 INDX=INDX1,INDX2                                         SLAP........522600
            IF(INDX .EQ. INDX1) GO TO 180                                SLAP........522700
            INDXR1 = INDX1                                               SLAP........522800
            INDXR2 = INDX - 1                                            SLAP........522900
            INDXC1 = JU(JL(INDX))                                        SLAP........523000
            INDXC2 = JU(JL(INDX)+1) - 1                                  SLAP........523100
            IF(INDXC1 .GT. INDXC2) GO TO 180                             SLAP........523200
 160        KR = JL(INDXR1)                                              SLAP........523300
 170        KC = IU(INDXC1)                                              SLAP........523400
            IF(KR .GT. KC) THEN                                          SLAP........523500
               INDXC1 = INDXC1 + 1                                       SLAP........523600
               IF(INDXC1 .LE. INDXC2) GO TO 170                          SLAP........523700
            ELSEIF(KR .LT. KC) THEN                                      SLAP........523800
               INDXR1 = INDXR1 + 1                                       SLAP........523900
               IF(INDXR1 .LE. INDXR2) GO TO 160                          SLAP........524000
            ELSEIF(KR .EQ. KC) THEN                                      SLAP........524100
               L(INDX) = L(INDX) - L(INDXR1)*DINV(KC)*U(INDXC1)          SLAP........524200
               INDXR1 = INDXR1 + 1                                       SLAP........524300
               INDXC1 = INDXC1 + 1                                       SLAP........524400
               IF(INDXR1 .LE. INDXR2 .AND. INDXC1 .LE. INDXC2) GO TO 160 SLAP........524500
            ENDIF                                                        SLAP........524600
 180        L(INDX) = L(INDX)/DINV(JL(INDX))                             SLAP........524700
 190     CONTINUE                                                        SLAP........524800
C                                                                        SLAP........524900
C         I-th column of U                                               SLAP........525000
 200     INDX1 = JU(I)                                                   SLAP........525100
         INDX2 = JU(I+1) - 1                                             SLAP........525200
         IF(INDX1 .GT. INDX2) GO TO 260                                  SLAP........525300
         DO 250 INDX=INDX1,INDX2                                         SLAP........525400
            IF(INDX .EQ. INDX1) GO TO 240                                SLAP........525500
            INDXC1 = INDX1                                               SLAP........525600
            INDXC2 = INDX - 1                                            SLAP........525700
            INDXR1 = IL(IU(INDX))                                        SLAP........525800
            INDXR2 = IL(IU(INDX)+1) - 1                                  SLAP........525900
            IF(INDXR1 .GT. INDXR2) GO TO 240                             SLAP........526000
 210        KR = JL(INDXR1)                                              SLAP........526100
 220        KC = IU(INDXC1)                                              SLAP........526200
            IF(KR .GT. KC) THEN                                          SLAP........526300
               INDXC1 = INDXC1 + 1                                       SLAP........526400
               IF(INDXC1 .LE. INDXC2) GO TO 220                          SLAP........526500
            ELSEIF(KR .LT. KC) THEN                                      SLAP........526600
               INDXR1 = INDXR1 + 1                                       SLAP........526700
               IF(INDXR1 .LE. INDXR2) GO TO 210                          SLAP........526800
            ELSEIF(KR .EQ. KC) THEN                                      SLAP........526900
               U(INDX) = U(INDX) - L(INDXR1)*DINV(KC)*U(INDXC1)          SLAP........527000
               INDXR1 = INDXR1 + 1                                       SLAP........527100
               INDXC1 = INDXC1 + 1                                       SLAP........527200
               IF(INDXR1 .LE. INDXR2 .AND. INDXC1 .LE. INDXC2) GO TO 210 SLAP........527300
            ENDIF                                                        SLAP........527400
 240        U(INDX) = U(INDX)/DINV(IU(INDX))                             SLAP........527500
 250     CONTINUE                                                        SLAP........527600
C                                                                        SLAP........527700
C         I-th diagonal element                                          SLAP........527800
 260     INDXR1 = IL(I)                                                  SLAP........527900
         INDXR2 = IL(I+1) - 1                                            SLAP........528000
         IF(INDXR1 .GT. INDXR2) GO TO 300                                SLAP........528100
         INDXC1 = JU(I)                                                  SLAP........528200
         INDXC2 = JU(I+1) - 1                                            SLAP........528300
         IF(INDXC1 .GT. INDXC2) GO TO 300                                SLAP........528400
 270     KR = JL(INDXR1)                                                 SLAP........528500
 280     KC = IU(INDXC1)                                                 SLAP........528600
         IF(KR .GT. KC) THEN                                             SLAP........528700
            INDXC1 = INDXC1 + 1                                          SLAP........528800
            IF(INDXC1 .LE. INDXC2) GO TO 280                             SLAP........528900
         ELSEIF(KR .LT. KC) THEN                                         SLAP........529000
            INDXR1 = INDXR1 + 1                                          SLAP........529100
            IF(INDXR1 .LE. INDXR2) GO TO 270                             SLAP........529200
         ELSEIF(KR .EQ. KC) THEN                                         SLAP........529300
            DINV(I) = DINV(I) - L(INDXR1)*DINV(KC)*U(INDXC1)             SLAP........529400
            INDXR1 = INDXR1 + 1                                          SLAP........529500
            INDXC1 = INDXC1 + 1                                          SLAP........529600
            IF(INDXR1 .LE. INDXR2 .AND. INDXC1 .LE. INDXC2) GO TO 270    SLAP........529700
         ENDIF                                                           SLAP........529800
C                                                                        SLAP........529900
 300  CONTINUE                                                           SLAP........530000
C                                                                        SLAP........530100
C         Replace diagonal elements by their inverses.                   SLAP........530200
CVD$ VECTOR                                                              SLAP........530300
      DO 430 I=1,N                                                       SLAP........530400
         DINV(I) = 1.0D0/DINV(I)                                         SLAP........530500
 430  CONTINUE                                                           SLAP........530600
C                                                                        SLAP........530700
      RETURN                                                             SLAP........530800
C------------- LAST LINE OF DSILUS FOLLOWS ----------------------------  SLAP........530900
      END                                                                SLAP........531000
*DECK DSLLTI                                                             SLAP........531100
      SUBROUTINE DSLLTI (N, B, X, NELT, IA, JA, A, ISYM, RWORK, IWORK)   SLAP........531200
C***BEGIN PROLOGUE  DSLLTI                                               SLAP........531300
C***PURPOSE  SLAP MSOLVE for LDL' (IC) Factorization.                    SLAP........531400
C            This routine acts as an interface between the SLAP generic  SLAP........531500
C            MSOLVE calling convention and the routine that actually     SLAP........531600
C                           -1                                           SLAP........531700
C            computes (LDL')  B = X.                                     SLAP........531800
C***LIBRARY   SLATEC (SLAP)                                              SLAP........531900
C***CATEGORY  D2E                                                        SLAP........532000
C***TYPE      DOUBLE PRECISION (SSLLTI-S, DSLLTI-D)                      SLAP........532100
C***KEYWORDS  ITERATIVE PRECONDITION, LINEAR SYSTEM SOLVE, SLAP, SPARSE  SLAP........532200
C***AUTHOR  Greenbaum, Anne, (Courant Institute)                         SLAP........532300
C           Seager, Mark K., (LLNL)                                      SLAP........532400
C             Lawrence Livermore National Laboratory                     SLAP........532500
C             PO BOX 808, L-60                                           SLAP........532600
C             Livermore, CA 94550 (510) 423-3141                         SLAP........532700
C             seager@llnl.gov                                            SLAP........532800
C***DESCRIPTION                                                          SLAP........532900
C       It is assumed that RWORK and IWORK have initialized with         SLAP........533000
C       the information required for DLLTI2:                             SLAP........533100
C          IWORK(1) = NEL                                                SLAP........533200
C          IWORK(2) = Starting location of IEL in IWORK.                 SLAP........533300
C          IWORK(3) = Starting location of JEL in IWORK.                 SLAP........533400
C          IWORK(4) = Starting location of EL in RWORK.                  SLAP........533500
C          IWORK(5) = Starting location of DINV in RWORK.                SLAP........533600
C       See the DESCRIPTION of DLLTI2 for details.                       SLAP........533700
C***REFERENCES  (NONE)                                                   SLAP........533800
C***ROUTINES CALLED  DLLTI2                                              SLAP........533900
C***REVISION HISTORY  (YYMMDD)                                           SLAP........534000
C   871119  DATE WRITTEN                                                 SLAP........534100
C   881213  Previous REVISION DATE                                       SLAP........534200
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........534300
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........534400
C           standard.  (FNF)                                             SLAP........534500
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........534600
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........534700
C   910502  Corrected conversion error.  (FNF)                           SLAP........534800
C   920511  Added complete declaration section.  (WRB)                   SLAP........534900
C   921113  Corrected C***CATEGORY line.  (FNF)                          SLAP........535000
C   930701  Updated CATEGORY section.  (FNF, WRB)                        SLAP........535100
C***END PROLOGUE  DSLLTI                                                 SLAP........535200
C     .. Scalar Arguments ..                                             SLAP........535300
      INTEGER ISYM, N, NELT                                              SLAP........535400
C     .. Array Arguments ..                                              SLAP........535500
      DOUBLE PRECISION A(NELT), B(*), RWORK(*), X(*)                     SLAP........535600
      INTEGER IA(NELT), IWORK(*), JA(NELT)                               SLAP........535700
C     .. Local Scalars ..                                                SLAP........535800
      INTEGER LOCDIN, LOCEL, LOCIEL, LOCJEL, NEL                         SLAP........535900
C     .. External Subroutines ..                                         SLAP........536000
      EXTERNAL DLLTI2                                                    SLAP........536100
C***FIRST EXECUTABLE STATEMENT  DSLLTI                                   SLAP........536200
      NEL = IWORK(1)                                                     SLAP........536300
      LOCIEL = IWORK(3)                                                  SLAP........536400
      LOCJEL = IWORK(2)                                                  SLAP........536500
      LOCEL  = IWORK(4)                                                  SLAP........536600
      LOCDIN = IWORK(5)                                                  SLAP........536700
      CALL DLLTI2(N, B, X, NEL, IWORK(LOCIEL), IWORK(LOCJEL),            SLAP........536800
     $     RWORK(LOCEL), RWORK(LOCDIN))                                  SLAP........536900
C                                                                        SLAP........537000
      RETURN                                                             SLAP........537100
C------------- LAST LINE OF DSLLTI FOLLOWS ----------------------------  SLAP........537200
      END                                                                SLAP........537300
*DECK DSLUGM                                                             SLAP........537400
      SUBROUTINE DSLUGM (N, B, X, NELT, IA, JA, A, ISYM, NSAVE, ITOL,    SLAP........537500
     +   TOL, ITMAX, ITER, ERR, IERR, IUNIT, RWORK, LENW, IWORK, LENIW)  SLAP........537600
C***BEGIN PROLOGUE  DSLUGM                                               SLAP........537700
C***PURPOSE  Incomplete LU GMRES iterative sparse Ax=b solver.           SLAP........537800
C            This routine uses the generalized minimum residual          SLAP........537900
C            (GMRES) method with incomplete LU factorization for         SLAP........538000
C            preconditioning to solve possibly non-symmetric linear      SLAP........538100
C            systems of the form: Ax = b.                                SLAP........538200
C***LIBRARY   SLATEC (SLAP)                                              SLAP........538300
C***CATEGORY  D2A4, D2B4                                                 SLAP........538400
C***TYPE      DOUBLE PRECISION (SSLUGM-S, DSLUGM-D)                      SLAP........538500
C***KEYWORDS  GENERALIZED MINIMUM RESIDUAL, ITERATIVE PRECONDITION,      SLAP........538600
C             NON-SYMMETRIC LINEAR SYSTEM, SLAP, SPARSE                  SLAP........538700
C***AUTHOR  Brown, Peter, (LLNL), pnbrown@llnl.gov                       SLAP........538800
C           Hindmarsh, Alan, (LLNL), alanh@llnl.gov                      SLAP........538900
C           Seager, Mark K., (LLNL), seager@llnl.gov                     SLAP........539000
C             Lawrence Livermore National Laboratory                     SLAP........539100
C             PO Box 808, L-60                                           SLAP........539200
C             Livermore, CA 94550 (510) 423-3141                         SLAP........539300
C***DESCRIPTION                                                          SLAP........539400
C                                                                        SLAP........539500
C *Usage:                                                                SLAP........539600
C      INTEGER   N, NELT, IA(NELT), JA(NELT), ISYM, NSAVE, ITOL          SLAP........539700
C      INTEGER   ITMAX, ITER, IERR, IUNIT, LENW, IWORK(LENIW), LENIW     SLAP........539800
C      DOUBLE PRECISION B(N), X(N), A(NELT), TOL, ERR, RWORK(LENW)       SLAP........539900
C                                                                        SLAP........540000
C      CALL DSLUGM(N, B, X, NELT, IA, JA, A, ISYM, NSAVE,                SLAP........540100
C     $     ITOL, TOL, ITMAX, ITER, ERR, IERR, IUNIT,                    SLAP........540200
C     $     RWORK, LENW, IWORK, LENIW)                                   SLAP........540300
C                                                                        SLAP........540400
C *Arguments:                                                            SLAP........540500
C N      :IN       Integer.                                              SLAP........540600
C         Order of the Matrix.                                           SLAP........540700
C B      :IN       Double Precision B(N).                                SLAP........540800
C         Right-hand side vector.                                        SLAP........540900
C X      :INOUT    Double Precision X(N).                                SLAP........541000
C         On input X is your initial guess for solution vector.          SLAP........541100
C         On output X is the final approximate solution.                 SLAP........541200
C NELT   :IN       Integer.                                              SLAP........541300
C         Number of Non-Zeros stored in A.                               SLAP........541400
C IA     :IN       Integer IA(NELT).                                     SLAP........541500
C JA     :IN       Integer JA(NELT).                                     SLAP........541600
C A      :IN       Double Precision A(NELT).                             SLAP........541700
C         These arrays should hold the matrix A in either the SLAP       SLAP........541800
C         Triad format or the SLAP Column format.  See "Description",    SLAP........541900
C         below.  If the SLAP Triad format is chosen it is changed       SLAP........542000
C         internally to the SLAP Column format.                          SLAP........542100
C ISYM   :IN       Integer.                                              SLAP........542200
C         Flag to indicate symmetric storage format.                     SLAP........542300
C         If ISYM=0, all non-zero entries of the matrix are stored.      SLAP........542400
C         If ISYM=1, the matrix is symmetric, and only the upper         SLAP........542500
C         or lower triangle of the matrix is stored.                     SLAP........542600
C NSAVE  :IN       Integer.                                              SLAP........542700
C         Number of direction vectors to save and orthogonalize against. SLAP........542800
C         Must be greater than 1.                                        SLAP........542900
C ITOL   :IN       Integer.                                              SLAP........543000
C         Flag to indicate the type of convergence criterion used.       SLAP........543100
C         ITOL=0  Means the  iteration stops when the test described     SLAP........543200
C                 below on  the  residual RL  is satisfied.  This is     SLAP........543300
C                 the  "Natural Stopping Criteria" for this routine.     SLAP........543400
C                 Other values  of   ITOL  cause  extra,   otherwise     SLAP........543500
C                 unnecessary, computation per iteration and     are     SLAP........543600
C                 therefore  much less  efficient.  See  ISDGMR (the     SLAP........543700
C                 stop test routine) for more information.               SLAP........543800
C         ITOL=1  Means   the  iteration stops   when the first test     SLAP........543900
C                 described below on  the residual RL  is satisfied,     SLAP........544000
C                 and there  is either right  or  no preconditioning     SLAP........544100
C                 being used.                                            SLAP........544200
C         ITOL=2  Implies     that   the  user    is   using    left     SLAP........544300
C                 preconditioning, and the second stopping criterion     SLAP........544400
C                 below is used.                                         SLAP........544500
C         ITOL=3  Means the  iteration stops   when  the  third test     SLAP........544600
C                 described below on Minv*Residual is satisfied, and     SLAP........544700
C                 there is either left  or no  preconditioning begin     SLAP........544800
C                 used.                                                  SLAP........544900
C         ITOL=11 is    often  useful  for   checking  and comparing     SLAP........545000
C                 different routines.  For this case, the  user must     SLAP........545100
C                 supply  the  "exact" solution or  a  very accurate     SLAP........545200
C                 approximation (one with  an  error much less  than     SLAP........545300
C                 TOL) through a common block,                           SLAP........545400
C                     COMMON /DSLBLK/ SOLN( )                            SLAP........545500
C                 If ITOL=11, iteration stops when the 2-norm of the     SLAP........545600
C                 difference between the iterative approximation and     SLAP........545700
C                 the user-supplied solution  divided by the  2-norm     SLAP........545800
C                 of the  user-supplied solution  is  less than TOL.     SLAP........545900
C                 Note that this requires  the  user to  set up  the     SLAP........546000
C                 "COMMON     /DSLBLK/ SOLN(LENGTH)"  in the calling     SLAP........546100
C                 routine.  The routine with this declaration should     SLAP........546200
C                 be loaded before the stop test so that the correct     SLAP........546300
C                 length is used by  the loader.  This procedure  is     SLAP........546400
C                 not standard Fortran and may not work correctly on     SLAP........546500
C                 your   system (although  it  has  worked  on every     SLAP........546600
C                 system the authors have tried).  If ITOL is not 11     SLAP........546700
C                 then this common block is indeed standard Fortran.     SLAP........546800
C TOL    :INOUT    Double Precision.                                     SLAP........546900
C         Convergence criterion, as described below.  If TOL is set      SLAP........547000
C         to zero on input, then a default value of 500*(the smallest    SLAP........547100
C         positive magnitude, machine epsilon) is used.                  SLAP........547200
C ITMAX  :IN       Integer.                                              SLAP........547300
C         Maximum number of iterations.  This routine uses the default   SLAP........547400
C         of NRMAX = ITMAX/NSAVE to determine the when each restart      SLAP........547500
C         should occur.  See the description of NRMAX and MAXL in        SLAP........547600
C         DGMRES for a full and frightfully interesting discussion of    SLAP........547700
C         this topic.                                                    SLAP........547800
C ITER   :OUT      Integer.                                              SLAP........547900
C         Number of iterations required to reach convergence, or         SLAP........548000
C         ITMAX+1 if convergence criterion could not be achieved in      SLAP........548100
C         ITMAX iterations.                                              SLAP........548200
C ERR    :OUT      Double Precision.                                     SLAP........548300
C         Error estimate of error in final approximate solution, as      SLAP........548400
C         defined by ITOL.  Letting norm() denote the Euclidean          SLAP........548500
C         norm, ERR is defined as follows...                             SLAP........548600
C         If ITOL=0, then ERR = norm(SB*(B-A*X(L)))/norm(SB*B),          SLAP........548700
C                               for right or no preconditioning, and     SLAP........548800
C                         ERR = norm(SB*(M-inverse)*(B-A*X(L)))/         SLAP........548900
C                                norm(SB*(M-inverse)*B),                 SLAP........549000
C                               for left preconditioning.                SLAP........549100
C         If ITOL=1, then ERR = norm(SB*(B-A*X(L)))/norm(SB*B),          SLAP........549200
C                               since right or no preconditioning        SLAP........549300
C                               being used.                              SLAP........549400
C         If ITOL=2, then ERR = norm(SB*(M-inverse)*(B-A*X(L)))/         SLAP........549500
C                                norm(SB*(M-inverse)*B),                 SLAP........549600
C                               since left preconditioning is being      SLAP........549700
C                               used.                                    SLAP........549800
C         If ITOL=3, then ERR =  Max  |(Minv*(B-A*X(L)))(i)/x(i)|        SLAP........549900
C                               i=1,n                                    SLAP........550000
C         If ITOL=11, then ERR = norm(SB*(X(L)-SOLN))/norm(SB*SOLN).     SLAP........550100
C IERR   :OUT      Integer.                                              SLAP........550200
C         Return error flag.                                             SLAP........550300
C               IERR = 0 => All went well.                               SLAP........550400
C               IERR = 1 => Insufficient storage allocated for           SLAP........550500
C                           RGWK or IGWK.                                SLAP........550600
C               IERR = 2 => Routine DPIGMR failed to reduce the norm     SLAP........550700
C                           of the current residual on its last call,    SLAP........550800
C                           and so the iteration has stalled.  In        SLAP........550900
C                           this case, X equals the last computed        SLAP........551000
C                           approximation.  The user must either         SLAP........551100
C                           increase MAXL, or choose a different         SLAP........551200
C                           initial guess.                               SLAP........551300
C               IERR =-1 => Insufficient length for RGWK array.          SLAP........551400
C                           IGWK(6) contains the required minimum        SLAP........551500
C                           length of the RGWK array.                    SLAP........551600
C               IERR =-2 => Inconsistent ITOL and JPRE values.           SLAP........551700
C         For IERR <= 2, RGWK(1) = RHOL, which is the norm on the        SLAP........551800
C         left-hand-side of the relevant stopping test defined           SLAP........551900
C         below associated with the residual for the current             SLAP........552000
C         approximation X(L).                                            SLAP........552100
C IUNIT  :IN       Integer.                                              SLAP........552200
C         Unit number on which to write the error at each iteration,     SLAP........552300
C         if this is desired for monitoring convergence.  If unit        SLAP........552400
C         number is 0, no writing will occur.                            SLAP........552500
C RWORK  :WORK    Double Precision RWORK(LENW).                          SLAP........552600
C         Double Precision array of size LENW.                           SLAP........552700
C LENW   :IN       Integer.                                              SLAP........552800
C         Length of the double precision workspace, RWORK.               SLAP........552900
C         LENW >= 1 + N*(NSAVE+7) +  NSAVE*(NSAVE+3)+NL+NU.              SLAP........553000
C         Here NL is the number of non-zeros in the lower triangle of    SLAP........553100
C         the matrix (including the diagonal) and NU is the number of    SLAP........553200
C         non-zeros in the upper triangle of the matrix (including the   SLAP........553300
C         diagonal).                                                     SLAP........553400
C         For the recommended values,  RWORK  has size at least          SLAP........553500
C         131 + 17*N + NL + NU.                                          SLAP........553600
C IWORK  :INOUT    Integer IWORK(LENIW).                                 SLAP........553700
C         Used to hold pointers into the RWORK array.                    SLAP........553800
C         Upon return the following locations of IWORK hold information  SLAP........553900
C         which may be of use to the user:                               SLAP........554000
C         IWORK(9)  Amount of Integer workspace actually used.           SLAP........554100
C         IWORK(10) Amount of Double Precision workspace actually used.  SLAP........554200
C LENIW  :IN       Integer.                                              SLAP........554300
C         Length of the integer workspace, IWORK.                        SLAP........554400
C         LENIW >= NL+NU+4*N+32.                                         SLAP........554500
C                                                                        SLAP........554600
C *Description:                                                          SLAP........554700
C       DSLUGM solves a linear system A*X = B rewritten in the form:     SLAP........554800
C                                                                        SLAP........554900
C        (SB*A*(M-inverse)*(SX-inverse))*(SX*M*X) = SB*B,                SLAP........555000
C                                                                        SLAP........555100
C       with right preconditioning, or                                   SLAP........555200
C                                                                        SLAP........555300
C        (SB*(M-inverse)*A*(SX-inverse))*(SX*X) = SB*(M-inverse)*B,      SLAP........555400
C                                                                        SLAP........555500
C       with left preconditioning, where A is an n-by-n double precision SLAP........555600
C       matrix, X and B are N-vectors, SB and SX are  diagonal scaling   SLAP........555700
C       matrices, and M is the Incomplete LU factorization of A.  It     SLAP........555800
C       uses preconditioned  Krylov subpace   methods  based on  the     SLAP........555900
C       generalized minimum residual  method (GMRES).   This routine     SLAP........556000
C       is a  driver  routine  which  assumes a SLAP   matrix   data     SLAP........556100
C       structure   and  sets  up  the  necessary  information to do     SLAP........556200
C       diagonal  preconditioning  and calls the main GMRES  routine     SLAP........556300
C       DGMRES for the   solution   of the linear   system.   DGMRES     SLAP........556400
C       optionally   performs  either  the full    orthogonalization     SLAP........556500
C       version of the  GMRES algorithm or  an incomplete variant of     SLAP........556600
C       it.  Both versions use restarting of the linear iteration by     SLAP........556700
C       default, although the user can disable this feature.             SLAP........556800
C                                                                        SLAP........556900
C       The GMRES  algorithm generates a sequence  of approximations     SLAP........557000
C       X(L) to the  true solution of the above  linear system.  The     SLAP........557100
C       convergence criteria for stopping the  iteration is based on     SLAP........557200
C       the size  of the  scaled norm of  the residual  R(L)  =  B -     SLAP........557300
C       A*X(L).  The actual stopping test is either:                     SLAP........557400
C                                                                        SLAP........557500
C               norm(SB*(B-A*X(L))) .le. TOL*norm(SB*B),                 SLAP........557600
C                                                                        SLAP........557700
C       for right preconditioning, or                                    SLAP........557800
C                                                                        SLAP........557900
C               norm(SB*(M-inverse)*(B-A*X(L))) .le.                     SLAP........558000
C                       TOL*norm(SB*(M-inverse)*B),                      SLAP........558100
C                                                                        SLAP........558200
C       for left preconditioning, where norm() denotes the Euclidean     SLAP........558300
C       norm, and TOL is  a positive scalar less  than one  input by     SLAP........558400
C       the user.  If TOL equals zero  when DSLUGM is called, then a     SLAP........558500
C       default  value  of 500*(the   smallest  positive  magnitude,     SLAP........558600
C       machine epsilon) is used.  If the  scaling arrays SB  and SX     SLAP........558700
C       are used, then  ideally they  should be chosen  so  that the     SLAP........558800
C       vectors SX*X(or SX*M*X) and  SB*B have all their  components     SLAP........558900
C       approximately equal  to  one in  magnitude.  If one wants to     SLAP........559000
C       use the same scaling in X  and B, then  SB and SX can be the     SLAP........559100
C       same array in the calling program.                               SLAP........559200
C                                                                        SLAP........559300
C       The following is a list of the other routines and their          SLAP........559400
C       functions used by GMRES:                                         SLAP........559500
C       DGMRES  Contains the matrix structure independent driver         SLAP........559600
C               routine for GMRES.                                       SLAP........559700
C       DPIGMR  Contains the main iteration loop for GMRES.              SLAP........559800
C       DORTH   Orthogonalizes a new vector against older basis vectors. SLAP........559900
C       DHEQR   Computes a QR decomposition of a Hessenberg matrix.      SLAP........560000
C       DHELS   Solves a Hessenberg least-squares system, using QR       SLAP........560100
C               factors.                                                 SLAP........560200
C       RLCALC  Computes the scaled residual RL.                         SLAP........560300
C       XLCALC  Computes the solution XL.                                SLAP........560400
C       ISDGMR  User-replaceable stopping routine.                       SLAP........560500
C                                                                        SLAP........560600
C       The Sparse Linear Algebra Package (SLAP) utilizes two matrix     SLAP........560700
C       data structures: 1) the  SLAP Triad  format or  2)  the SLAP     SLAP........560800
C       Column format.  The user can hand this routine either of the     SLAP........560900
C       of these data structures and SLAP  will figure out  which on     SLAP........561000
C       is being used and act accordingly.                               SLAP........561100
C                                                                        SLAP........561200
C       =================== S L A P Triad format ===================     SLAP........561300
C       This routine requires that the  matrix A be   stored in  the     SLAP........561400
C       SLAP  Triad format.  In  this format only the non-zeros  are     SLAP........561500
C       stored.  They may appear in  *ANY* order.  The user supplies     SLAP........561600
C       three arrays of  length NELT, where  NELT is  the number  of     SLAP........561700
C       non-zeros in the matrix: (IA(NELT), JA(NELT), A(NELT)).  For     SLAP........561800
C       each non-zero the user puts the row and column index of that     SLAP........561900
C       matrix element  in the IA and  JA arrays.  The  value of the     SLAP........562000
C       non-zero   matrix  element is  placed  in  the corresponding     SLAP........562100
C       location of the A array.   This is  an  extremely  easy data     SLAP........562200
C       structure to generate.  On  the  other hand it   is  not too     SLAP........562300
C       efficient on vector computers for  the iterative solution of     SLAP........562400
C       linear systems.  Hence,   SLAP changes   this  input    data     SLAP........562500
C       structure to the SLAP Column format  for  the iteration (but     SLAP........562600
C       does not change it back).                                        SLAP........562700
C                                                                        SLAP........562800
C       Here is an example of the  SLAP Triad   storage format for a     SLAP........562900
C       5x5 Matrix.  Recall that the entries may appear in any order.    SLAP........563000
C                                                                        SLAP........563100
C           5x5 Matrix      SLAP Triad format for 5x5 matrix on left.    SLAP........563200
C                              1  2  3  4  5  6  7  8  9 10 11           SLAP........563300
C       |11 12  0  0 15|   A: 51 12 11 33 15 53 55 22 35 44 21           SLAP........563400
C       |21 22  0  0  0|  IA:  5  1  1  3  1  5  5  2  3  4  2           SLAP........563500
C       | 0  0 33  0 35|  JA:  1  2  1  3  5  3  5  2  5  4  1           SLAP........563600
C       | 0  0  0 44  0|                                                 SLAP........563700
C       |51  0 53  0 55|                                                 SLAP........563800
C                                                                        SLAP........563900
C       =================== S L A P Column format ==================     SLAP........564000
C                                                                        SLAP........564100
C       This routine  requires that  the matrix A  be stored in  the     SLAP........564200
C       SLAP Column format.  In this format the non-zeros are stored     SLAP........564300
C       counting down columns (except for  the diagonal entry, which     SLAP........564400
C       must appear first in each  "column")  and are stored  in the     SLAP........564500
C       double precision array A.   In other words,  for each column     SLAP........564600
C       in the matrix put the diagonal entry in  A.  Then put in the     SLAP........564700
C       other non-zero  elements going down  the column (except  the     SLAP........564800
C       diagonal) in order.   The  IA array holds the  row index for     SLAP........564900
C       each non-zero.  The JA array holds the offsets  into the IA,     SLAP........565000
C       A arrays  for  the  beginning  of each   column.   That  is,     SLAP........565100
C       IA(JA(ICOL)),  A(JA(ICOL)) points   to the beginning  of the     SLAP........565200
C       ICOL-th   column    in    IA and   A.      IA(JA(ICOL+1)-1),     SLAP........565300
C       A(JA(ICOL+1)-1) points to  the  end of the   ICOL-th column.     SLAP........565400
C       Note that we always have  JA(N+1) = NELT+1,  where N is  the     SLAP........565500
C       number of columns in  the matrix and NELT  is the number  of     SLAP........565600
C       non-zeros in the matrix.                                         SLAP........565700
C                                                                        SLAP........565800
C       Here is an example of the  SLAP Column  storage format for a     SLAP........565900
C       5x5 Matrix (in the A and IA arrays '|'  denotes the end of a     SLAP........566000
C       column):                                                         SLAP........566100
C                                                                        SLAP........566200
C           5x5 Matrix      SLAP Column format for 5x5 matrix on left.   SLAP........566300
C                              1  2  3    4  5    6  7    8    9 10 11   SLAP........566400
C       |11 12  0  0 15|   A: 11 21 51 | 22 12 | 33 53 | 44 | 55 15 35   SLAP........566500
C       |21 22  0  0  0|  IA:  1  2  5 |  2  1 |  3  5 |  4 |  5  1  3   SLAP........566600
C       | 0  0 33  0 35|  JA:  1  4  6    8  9   12                      SLAP........566700
C       | 0  0  0 44  0|                                                 SLAP........566800
C       |51  0 53  0 55|                                                 SLAP........566900
C                                                                        SLAP........567000
C *Side Effects:                                                         SLAP........567100
C       The SLAP Triad format (IA, JA, A) is modified internally to be   SLAP........567200
C       the SLAP Column format.  See above.                              SLAP........567300
C                                                                        SLAP........567400
C *Cautions:                                                             SLAP........567500
C     This routine will attempt to write to the Fortran logical output   SLAP........567600
C     unit IUNIT, if IUNIT .ne. 0.  Thus, the user must make sure that   SLAP........567700
C     this logical unit is attached to a file or terminal before calling SLAP........567800
C     this routine with a non-zero value for IUNIT.  This routine does   SLAP........567900
C     not check for the validity of a non-zero IUNIT unit number.        SLAP........568000
C                                                                        SLAP........568100
C***REFERENCES  1. Peter N. Brown and A. C. Hindmarsh, Reduced Storage   SLAP........568200
C                  Matrix Methods in Stiff ODE Systems, Lawrence Liver-  SLAP........568300
C                  more National Laboratory Report UCRL-95088, Rev. 1,   SLAP........568400
C                  Livermore, California, June 1987.                     SLAP........568500
C***ROUTINES CALLED  DCHKW, DGMRES, DS2Y, DSILUS, DSLUI, DSMV            SLAP........568600
C***REVISION HISTORY  (YYMMDD)                                           SLAP........568700
C   890404  DATE WRITTEN                                                 SLAP........568800
C   890404  Previous REVISION DATE                                       SLAP........568900
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........569000
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........569100
C           standard.  (FNF)                                             SLAP........569200
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........569300
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........569400
C   920407  COMMON BLOCK renamed DSLBLK.  (WRB)                          SLAP........569500
C   920511  Added complete declaration section.  (WRB)                   SLAP........569600
C   920929  Corrected format of references.  (FNF)                       SLAP........569700
C   921019  Corrected NEL to NL.  (FNF)                                  SLAP........569800
C***END PROLOGUE  DSLUGM                                                 SLAP........569900
C         The following is for optimized compilation on LLNL/LTSS Crays. SLAP........570000
CLLL. OPTIMIZE                                                           SLAP........570100
C     .. Parameters ..                                                   SLAP........570200
      INTEGER LOCRB, LOCIB                                               SLAP........570300
      PARAMETER (LOCRB=1, LOCIB=11)                                      SLAP........570400
C     .. Scalar Arguments ..                                             SLAP........570500
      DOUBLE PRECISION ERR, TOL                                          SLAP........570600
      INTEGER IERR, ISYM, ITER, ITMAX, ITOL, IUNIT, LENIW, LENW, N,      SLAP........570700
     +        NELT, NSAVE                                                SLAP........570800
C     .. Array Arguments ..                                              SLAP........570900
      DOUBLE PRECISION A(NELT), B(N), RWORK(LENW), X(N)                  SLAP........571000
      INTEGER IA(NELT), IWORK(LENIW), JA(NELT)                           SLAP........571100
C     .. Local Scalars ..                                                SLAP........571200
      INTEGER ICOL, J, JBGN, JEND, LOCDIN, LOCIGW, LOCIL, LOCIU, LOCIW,  SLAP........571300
     +        LOCJL, LOCJU, LOCL, LOCNC, LOCNR, LOCRGW, LOCU, LOCW,      SLAP........571400
     +        MYITOL, NL, NU                                             SLAP........571500
C     .. External Subroutines ..                                         SLAP........571600
      EXTERNAL DCHKW, DGMRES, DS2Y, DSILUS, DSLUI, DSMV                  SLAP........571700
C***FIRST EXECUTABLE STATEMENT  DSLUGM                                   SLAP........571800
C                                                                        SLAP........571900
      IERR = 0                                                           SLAP........572000
      ERR  = 0                                                           SLAP........572100
      IF( NSAVE.LE.1 ) THEN                                              SLAP........572200
         IERR = 3                                                        SLAP........572300
         RETURN                                                          SLAP........572400
      ENDIF                                                              SLAP........572500
C                                                                        SLAP........572600
C         Change the SLAP input matrix IA, JA, A to SLAP-Column format.  SLAP........572700
      CALL DS2Y( N, NELT, IA, JA, A, ISYM )                              SLAP........572800
C                                                                        SLAP........572900
C         Count number of Non-Zero elements preconditioner ILU matrix.   SLAP........573000
C         Then set up the work arrays.  We assume MAXL=KMP=NSAVE.        SLAP........573100
      NL = 0                                                             SLAP........573200
      NU = 0                                                             SLAP........573300
      DO 20 ICOL = 1, N                                                  SLAP........573400
C         Don't count diagonal.                                          SLAP........573500
         JBGN = JA(ICOL)+1                                               SLAP........573600
         JEND = JA(ICOL+1)-1                                             SLAP........573700
         IF( JBGN.LE.JEND ) THEN                                         SLAP........573800
CVD$ NOVECTOR                                                            SLAP........573900
            DO 10 J = JBGN, JEND                                         SLAP........574000
               IF( IA(J).GT.ICOL ) THEN                                  SLAP........574100
                  NL = NL + 1                                            SLAP........574200
                  IF( ISYM.NE.0 ) NU = NU + 1                            SLAP........574300
               ELSE                                                      SLAP........574400
                  NU = NU + 1                                            SLAP........574500
               ENDIF                                                     SLAP........574600
 10         CONTINUE                                                     SLAP........574700
         ENDIF                                                           SLAP........574800
 20   CONTINUE                                                           SLAP........574900
C                                                                        SLAP........575000
      LOCIGW = LOCIB                                                     SLAP........575100
      LOCIL = LOCIGW + 20                                                SLAP........575200
C.....THE NEXT LINE OF CODE INCORPORATES A BUG FIX MADE DURING           SLAP........575300
C        INTEGRATION OF SLAP WITH SUTRA.  IT ORIGINALLY READ:            SLAP........575400
C        LOCJL = LOCIL + N+1                                             SLAP........575500
      LOCJL = LOCIL + NL                                                 SLAP........575600
      LOCIU = LOCJL + NL                                                 SLAP........575700
      LOCJU = LOCIU + NU                                                 SLAP........575800
C.....THE NEXT LINE OF CODE INCORPORATES A BUG FIX MADE DURING           SLAP........575900
C        INTEGRATION OF SLAP WITH SUTRA.  IT ORIGINALLY READ:            SLAP........576000
C        LOCNR = LOCJU + N+1                                             SLAP........576100
      LOCNR = LOCJU + NU                                                 SLAP........576200
      LOCNC = LOCNR + N                                                  SLAP........576300
      LOCIW = LOCNC + N                                                  SLAP........576400
C                                                                        SLAP........576500
      LOCL = LOCRB                                                       SLAP........576600
      LOCDIN = LOCL + NL                                                 SLAP........576700
      LOCU = LOCDIN + N                                                  SLAP........576800
      LOCRGW = LOCU + NU                                                 SLAP........576900
      LOCW = LOCRGW + 1+N*(NSAVE+6)+NSAVE*(NSAVE+3)                      SLAP........577000
C                                                                        SLAP........577100
C         Check the workspace allocations.                               SLAP........577200
      CALL DCHKW( 'DSLUGM', LOCIW, LENIW, LOCW, LENW, IERR, ITER, ERR )  SLAP........577300
      IF( IERR.NE.0 ) RETURN                                             SLAP........577400
C                                                                        SLAP........577500
      IWORK(1) = LOCIL                                                   SLAP........577600
      IWORK(2) = LOCJL                                                   SLAP........577700
      IWORK(3) = LOCIU                                                   SLAP........577800
      IWORK(4) = LOCJU                                                   SLAP........577900
      IWORK(5) = LOCL                                                    SLAP........578000
      IWORK(6) = LOCDIN                                                  SLAP........578100
      IWORK(7) = LOCU                                                    SLAP........578200
      IWORK(9) = LOCIW                                                   SLAP........578300
      IWORK(10) = LOCW                                                   SLAP........578400
C                                                                        SLAP........578500
C         Compute the Incomplete LU decomposition.                       SLAP........578600
      CALL DSILUS( N, NELT, IA, JA, A, ISYM, NL, IWORK(LOCIL),           SLAP........578700
     $     IWORK(LOCJL), RWORK(LOCL), RWORK(LOCDIN), NU, IWORK(LOCIU),   SLAP........578800
     $     IWORK(LOCJU), RWORK(LOCU), IWORK(LOCNR), IWORK(LOCNC) )       SLAP........578900
C                                                                        SLAP........579000
C         Perform the Incomplete LU Preconditioned Generalized Minimum   SLAP........579100
C         Residual iteration algorithm.  The following DGMRES            SLAP........579200
C         defaults are used MAXL = KMP = NSAVE, JSCAL = 0,               SLAP........579300
C         JPRE = -1, NRMAX = ITMAX/NSAVE                                 SLAP........579400
      IWORK(LOCIGW  ) = NSAVE                                            SLAP........579500
      IWORK(LOCIGW+1) = NSAVE                                            SLAP........579600
      IWORK(LOCIGW+2) = 0                                                SLAP........579700
      IWORK(LOCIGW+3) = -1                                               SLAP........579800
      IWORK(LOCIGW+4) = ITMAX/NSAVE                                      SLAP........579900
      MYITOL = 0                                                         SLAP........580000
C                                                                        SLAP........580100
      CALL DGMRES( N, B, X, NELT, IA, JA, A, ISYM, DSMV, DSLUI,          SLAP........580200
     $     MYITOL, TOL, ITMAX, ITER, ERR, IERR, IUNIT, RWORK, RWORK,     SLAP........580300
     $     RWORK(LOCRGW), LENW-LOCRGW, IWORK(LOCIGW), 20,                SLAP........580400
     $     RWORK, IWORK )                                                SLAP........580500
C                                                                        SLAP........580600
C.....THE NEXT LINE OF CODE WAS MODIFIED DURING INTEGRATION OF SLAP      SLAP........580700
C        WITH SUTRA.  IT ORIGINALLY READ:                                SLAP........580800
C        IF( ITER.GT.ITMAX ) IERR = 2                                    SLAP........580900
      IF (IERR.EQ.1) IERR = 2                                            SLAP........581000
      RETURN                                                             SLAP........581100
C------------- LAST LINE OF DSLUGM FOLLOWS ----------------------------  SLAP........581200
      END                                                                SLAP........581300
*DECK DSLUI                                                              SLAP........581400
      SUBROUTINE DSLUI (N, B, X, NELT, IA, JA, A, ISYM, RWORK, IWORK)    SLAP........581500
C***BEGIN PROLOGUE  DSLUI                                                SLAP........581600
C***PURPOSE  SLAP MSOLVE for LDU Factorization.                          SLAP........581700
C            This routine acts as an interface between the SLAP generic  SLAP........581800
C            MSOLVE calling convention and the routine that actually     SLAP........581900
C                           -1                                           SLAP........582000
C            computes  (LDU)  B = X.                                     SLAP........582100
C***LIBRARY   SLATEC (SLAP)                                              SLAP........582200
C***CATEGORY  D2E                                                        SLAP........582300
C***TYPE      DOUBLE PRECISION (SSLUI-S, DSLUI-D)                        SLAP........582400
C***KEYWORDS  ITERATIVE PRECONDITION, NON-SYMMETRIC LINEAR SYSTEM SOLVE, SLAP........582500
C             SLAP, SPARSE                                               SLAP........582600
C***AUTHOR  Greenbaum, Anne, (Courant Institute)                         SLAP........582700
C           Seager, Mark K., (LLNL)                                      SLAP........582800
C             Lawrence Livermore National Laboratory                     SLAP........582900
C             PO BOX 808, L-60                                           SLAP........583000
C             Livermore, CA 94550 (510) 423-3141                         SLAP........583100
C             seager@llnl.gov                                            SLAP........583200
C***DESCRIPTION                                                          SLAP........583300
C       It is assumed that RWORK and IWORK have initialized with         SLAP........583400
C       the information required for DSLUI2:                             SLAP........583500
C          IWORK(1) = Starting location of IL in IWORK.                  SLAP........583600
C          IWORK(2) = Starting location of JL in IWORK.                  SLAP........583700
C          IWORK(3) = Starting location of IU in IWORK.                  SLAP........583800
C          IWORK(4) = Starting location of JU in IWORK.                  SLAP........583900
C          IWORK(5) = Starting location of L in RWORK.                   SLAP........584000
C          IWORK(6) = Starting location of DINV in RWORK.                SLAP........584100
C          IWORK(7) = Starting location of U in RWORK.                   SLAP........584200
C       See the DESCRIPTION of DSLUI2 for details.                       SLAP........584300
C***REFERENCES  (NONE)                                                   SLAP........584400
C***ROUTINES CALLED  DSLUI2                                              SLAP........584500
C***REVISION HISTORY  (YYMMDD)                                           SLAP........584600
C   871119  DATE WRITTEN                                                 SLAP........584700
C   881213  Previous REVISION DATE                                       SLAP........584800
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........584900
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........585000
C           standard.  (FNF)                                             SLAP........585100
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........585200
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........585300
C   920511  Added complete declaration section.  (WRB)                   SLAP........585400
C   921113  Corrected C***CATEGORY line.  (FNF)                          SLAP........585500
C   930701  Updated CATEGORY section.  (FNF, WRB)                        SLAP........585600
C***END PROLOGUE  DSLUI                                                  SLAP........585700
C     .. Scalar Arguments ..                                             SLAP........585800
      INTEGER ISYM, N, NELT                                              SLAP........585900
C     .. Array Arguments ..                                              SLAP........586000
      DOUBLE PRECISION A(NELT), B(N), RWORK(*), X(N)                     SLAP........586100
C.....THE NEXT LINE OF CODE INCORPORATES A BUG FIX MADE DURING           SLAP........586200
C        INTEGRATION OF SLAP WITH SUTRA.  IT ORIGINALLY READ:            SLAP........586300
C        INTEGER IA(NELT), IWORK(10), JA(NELT)                           SLAP........586400
      INTEGER IA(NELT), IWORK(*), JA(NELT)                               SLAP........586500
C     .. Local Scalars ..                                                SLAP........586600
      INTEGER LOCDIN, LOCIL, LOCIU, LOCJL, LOCJU, LOCL, LOCU             SLAP........586700
C     .. External Subroutines ..                                         SLAP........586800
      EXTERNAL DSLUI2                                                    SLAP........586900
C***FIRST EXECUTABLE STATEMENT  DSLUI                                    SLAP........587000
C                                                                        SLAP........587100
C         Pull out the locations of the arrays holding the ILU           SLAP........587200
C         factorization.                                                 SLAP........587300
C                                                                        SLAP........587400
      LOCIL = IWORK(1)                                                   SLAP........587500
      LOCJL = IWORK(2)                                                   SLAP........587600
      LOCIU = IWORK(3)                                                   SLAP........587700
      LOCJU = IWORK(4)                                                   SLAP........587800
      LOCL = IWORK(5)                                                    SLAP........587900
      LOCDIN = IWORK(6)                                                  SLAP........588000
      LOCU = IWORK(7)                                                    SLAP........588100
C                                                                        SLAP........588200
C         Solve the system LUx = b                                       SLAP........588300
      CALL DSLUI2(N, B, X, IWORK(LOCIL), IWORK(LOCJL), RWORK(LOCL),      SLAP........588400
     $     RWORK(LOCDIN), IWORK(LOCIU), IWORK(LOCJU), RWORK(LOCU) )      SLAP........588500
C                                                                        SLAP........588600
      RETURN                                                             SLAP........588700
C------------- LAST LINE OF DSLUI FOLLOWS ----------------------------   SLAP........588800
      END                                                                SLAP........588900
*DECK DSLUI2                                                             SLAP........589000
      SUBROUTINE DSLUI2 (N, B, X, IL, JL, L, DINV, IU, JU, U)            SLAP........589100
C***BEGIN PROLOGUE  DSLUI2                                               SLAP........589200
C***PURPOSE  SLAP Backsolve for LDU Factorization.                       SLAP........589300
C            Routine to solve a system of the form  L*D*U X = B,         SLAP........589400
C            where L is a unit lower triangular matrix, D is a diagonal  SLAP........589500
C            matrix, and U is a unit upper triangular matrix.            SLAP........589600
C***LIBRARY   SLATEC (SLAP)                                              SLAP........589700
C***CATEGORY  D2E                                                        SLAP........589800
C***TYPE      DOUBLE PRECISION (SSLUI2-S, DSLUI2-D)                      SLAP........589900
C***KEYWORDS  ITERATIVE PRECONDITION, NON-SYMMETRIC LINEAR SYSTEM SOLVE, SLAP........590000
C             SLAP, SPARSE                                               SLAP........590100
C***AUTHOR  Greenbaum, Anne, (Courant Institute)                         SLAP........590200
C           Seager, Mark K., (LLNL)                                      SLAP........590300
C             Lawrence Livermore National Laboratory                     SLAP........590400
C             PO BOX 808, L-60                                           SLAP........590500
C             Livermore, CA 94550 (510) 423-3141                         SLAP........590600
C             seager@llnl.gov                                            SLAP........590700
C***DESCRIPTION                                                          SLAP........590800
C                                                                        SLAP........590900
C *Usage:                                                                SLAP........591000
C     INTEGER N, IL(NL), JL(NL), IU(NU), JU(NU)                          SLAP........591100
C     DOUBLE PRECISION B(N), X(N), L(NL), DINV(N), U(NU)                 SLAP........591200
C                                                                        SLAP........591300
C     CALL DSLUI2( N, B, X, IL, JL, L, DINV, IU, JU, U )                 SLAP........591400
C                                                                        SLAP........591500
C *Arguments:                                                            SLAP........591600
C N      :IN       Integer                                               SLAP........591700
C         Order of the Matrix.                                           SLAP........591800
C B      :IN       Double Precision B(N).                                SLAP........591900
C         Right hand side.                                               SLAP........592000
C X      :OUT      Double Precision X(N).                                SLAP........592100
C         Solution of L*D*U x = b.                                       SLAP........592200
C IL     :IN       Integer IL(NL).                                       SLAP........592300
C JL     :IN       Integer JL(NL).                                       SLAP........592400
C L      :IN       Double Precision L(NL).                               SLAP........592500
C         IL, JL, L contain the unit  lower triangular factor of the     SLAP........592600
C         incomplete decomposition of some matrix stored in SLAP Row     SLAP........592700
C         format.  The diagonal of ones *IS* stored.  This structure     SLAP........592800
C         can   be   set  up  by   the  DSILUS  routine.   See   the     SLAP........592900
C         "Description", below  for more   details about   the  SLAP     SLAP........593000
C         format.  (NL is the number of non-zeros in the L array.)       SLAP........593100
C DINV   :IN       Double Precision DINV(N).                             SLAP........593200
C         Inverse of the diagonal matrix D.                              SLAP........593300
C IU     :IN       Integer IU(NU).                                       SLAP........593400
C JU     :IN       Integer JU(NU).                                       SLAP........593500
C U      :IN       Double Precision U(NU).                               SLAP........593600
C         IU, JU, U contain the unit upper triangular factor  of the     SLAP........593700
C         incomplete decomposition  of  some  matrix stored in  SLAP     SLAP........593800
C         Column format.   The diagonal of ones  *IS* stored.   This     SLAP........593900
C         structure can be set up  by the DSILUS routine.  See   the     SLAP........594000
C         "Description", below   for  more   details about  the SLAP     SLAP........594100
C         format.  (NU is the number of non-zeros in the U array.)       SLAP........594200
C                                                                        SLAP........594300
C *Description:                                                          SLAP........594400
C       This routine is supplied with  the SLAP package as a routine     SLAP........594500
C       to  perform  the  MSOLVE operation  in   the  SIR and   SBCG     SLAP........594600
C       iteration routines for  the  drivers DSILUR and DSLUBC.   It     SLAP........594700
C       must  be called  via   the  SLAP  MSOLVE  calling   sequence     SLAP........594800
C       convention interface routine DSLUI.                              SLAP........594900
C         **** THIS ROUTINE ITSELF DOES NOT CONFORM TO THE ****          SLAP........595000
C               **** SLAP MSOLVE CALLING CONVENTION ****                 SLAP........595100
C                                                                        SLAP........595200
C       IL, JL, L should contain the unit lower triangular factor of     SLAP........595300
C       the incomplete decomposition of the A matrix  stored in SLAP     SLAP........595400
C       Row format.  IU, JU, U should contain  the unit upper factor     SLAP........595500
C       of the  incomplete decomposition of  the A matrix  stored in     SLAP........595600
C       SLAP Column format This ILU factorization can be computed by     SLAP........595700
C       the DSILUS routine. The diagonals (which are all one's) are      SLAP........595800
C       stored.                                                          SLAP........595900
C                                                                        SLAP........596000
C       =================== S L A P Column format ==================     SLAP........596100
C                                                                        SLAP........596200
C       This routine  requires that  the matrix A  be stored in  the     SLAP........596300
C       SLAP Column format.  In this format the non-zeros are stored     SLAP........596400
C       counting down columns (except for  the diagonal entry, which     SLAP........596500
C       must appear first in each  "column")  and are stored  in the     SLAP........596600
C       double precision array A.   In other words,  for each column     SLAP........596700
C       in the matrix put the diagonal entry in  A.  Then put in the     SLAP........596800
C       other non-zero  elements going down  the column (except  the     SLAP........596900
C       diagonal) in order.   The  IA array holds the  row index for     SLAP........597000
C       each non-zero.  The JA array holds the offsets  into the IA,     SLAP........597100
C       A arrays  for  the  beginning  of each   column.   That  is,     SLAP........597200
C       IA(JA(ICOL)),  A(JA(ICOL)) points   to the beginning  of the     SLAP........597300
C       ICOL-th   column    in    IA and   A.      IA(JA(ICOL+1)-1),     SLAP........597400
C       A(JA(ICOL+1)-1) points to  the  end of the   ICOL-th column.     SLAP........597500
C       Note that we always have  JA(N+1) = NELT+1,  where N is  the     SLAP........597600
C       number of columns in  the matrix and NELT  is the number  of     SLAP........597700
C       non-zeros in the matrix.                                         SLAP........597800
C                                                                        SLAP........597900
C       Here is an example of the  SLAP Column  storage format for a     SLAP........598000
C       5x5 Matrix (in the A and IA arrays '|'  denotes the end of a     SLAP........598100
C       column):                                                         SLAP........598200
C                                                                        SLAP........598300
C           5x5 Matrix      SLAP Column format for 5x5 matrix on left.   SLAP........598400
C                              1  2  3    4  5    6  7    8    9 10 11   SLAP........598500
C       |11 12  0  0 15|   A: 11 21 51 | 22 12 | 33 53 | 44 | 55 15 35   SLAP........598600
C       |21 22  0  0  0|  IA:  1  2  5 |  2  1 |  3  5 |  4 |  5  1  3   SLAP........598700
C       | 0  0 33  0 35|  JA:  1  4  6    8  9   12                      SLAP........598800
C       | 0  0  0 44  0|                                                 SLAP........598900
C       |51  0 53  0 55|                                                 SLAP........599000
C                                                                        SLAP........599100
C       ==================== S L A P Row format ====================     SLAP........599200
C                                                                        SLAP........599300
C       This routine requires  that the matrix A  be  stored  in the     SLAP........599400
C       SLAP  Row format.   In this format  the non-zeros are stored     SLAP........599500
C       counting across  rows (except for the diagonal  entry, which     SLAP........599600
C       must  appear first  in each  "row")  and  are stored  in the     SLAP........599700
C       double precision  array A.  In other words, for each row  in     SLAP........599800
C       the matrix  put the diagonal  entry in A.   Then put in  the     SLAP........599900
C       other  non-zero elements  going across  the row  (except the     SLAP........600000
C       diagonal) in order.  The JA array holds the column index for     SLAP........600100
C       each non-zero.  The IA array holds the offsets  into the JA,     SLAP........600200
C       A  arrays  for  the   beginning  of  each  row.    That  is,     SLAP........600300
C       JA(IA(IROW)),A(IA(IROW)) are the first elements of the IROW-     SLAP........600400
C       th row in  JA and A,  and  JA(IA(IROW+1)-1), A(IA(IROW+1)-1)     SLAP........600500
C       are  the last elements  of the  IROW-th row.   Note  that we     SLAP........600600
C       always have  IA(N+1) = NELT+1, where N is the number of rows     SLAP........600700
C       in the matrix  and  NELT is the  number of non-zeros  in the     SLAP........600800
C       matrix.                                                          SLAP........600900
C                                                                        SLAP........601000
C       Here is an example of the SLAP Row storage format for a  5x5     SLAP........601100
C       Matrix (in the A and JA arrays '|' denotes the end of a row):    SLAP........601200
C                                                                        SLAP........601300
C           5x5 Matrix         SLAP Row format for 5x5 matrix on left.   SLAP........601400
C                              1  2  3    4  5    6  7    8    9 10 11   SLAP........601500
C       |11 12  0  0 15|   A: 11 12 15 | 22 21 | 33 35 | 44 | 55 51 53   SLAP........601600
C       |21 22  0  0  0|  JA:  1  2  5 |  2  1 |  3  5 |  4 |  5  1  3   SLAP........601700
C       | 0  0 33  0 35|  IA:  1  4  6    8  9   12                      SLAP........601800
C       | 0  0  0 44  0|                                                 SLAP........601900
C       |51  0 53  0 55|                                                 SLAP........602000
C                                                                        SLAP........602100
C       With  the SLAP  format  the "inner  loops" of  this  routine     SLAP........602200
C       should vectorize   on machines with   hardware  support  for     SLAP........602300
C       vector gather/scatter operations.  Your compiler may require     SLAP........602400
C       a  compiler directive  to  convince   it that there  are  no     SLAP........602500
C       implicit vector  dependencies.  Compiler directives  for the     SLAP........602600
C       Alliant FX/Fortran and CRI CFT/CFT77 compilers  are supplied     SLAP........602700
C       with the standard SLAP distribution.                             SLAP........602800
C                                                                        SLAP........602900
C***SEE ALSO  DSILUS                                                     SLAP........603000
C***REFERENCES  (NONE)                                                   SLAP........603100
C***ROUTINES CALLED  (NONE)                                              SLAP........603200
C***REVISION HISTORY  (YYMMDD)                                           SLAP........603300
C   871119  DATE WRITTEN                                                 SLAP........603400
C   881213  Previous REVISION DATE                                       SLAP........603500
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........603600
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........603700
C           standard.  (FNF)                                             SLAP........603800
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........603900
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........604000
C   920511  Added complete declaration section.  (WRB)                   SLAP........604100
C   921113  Corrected C***CATEGORY line.  (FNF)                          SLAP........604200
C   930701  Updated CATEGORY section.  (FNF, WRB)                        SLAP........604300
C***END PROLOGUE  DSLUI2                                                 SLAP........604400
C     .. Scalar Arguments ..                                             SLAP........604500
      INTEGER N                                                          SLAP........604600
C     .. Array Arguments ..                                              SLAP........604700
      DOUBLE PRECISION B(N), DINV(N), L(*), U(*), X(N)                   SLAP........604800
      INTEGER IL(*), IU(*), JL(*), JU(*)                                 SLAP........604900
C     .. Local Scalars ..                                                SLAP........605000
      INTEGER I, ICOL, IROW, J, JBGN, JEND                               SLAP........605100
C***FIRST EXECUTABLE STATEMENT  DSLUI2                                   SLAP........605200
C                                                                        SLAP........605300
C         Solve  L*Y = B,  storing result in X, L stored by rows.        SLAP........605400
C                                                                        SLAP........605500
      DO 10 I = 1, N                                                     SLAP........605600
         X(I) = B(I)                                                     SLAP........605700
 10   CONTINUE                                                           SLAP........605800
      DO 30 IROW = 2, N                                                  SLAP........605900
         JBGN = IL(IROW)                                                 SLAP........606000
         JEND = IL(IROW+1)-1                                             SLAP........606100
         IF( JBGN.LE.JEND ) THEN                                         SLAP........606200
CLLL. OPTION ASSERT (NOHAZARD)                                           SLAP........606300
CDIR$ IVDEP                                                              SLAP........606400
CVD$ ASSOC                                                               SLAP........606500
CVD$ NODEPCHK                                                            SLAP........606600
            DO 20 J = JBGN, JEND                                         SLAP........606700
               X(IROW) = X(IROW) - L(J)*X(JL(J))                         SLAP........606800
 20         CONTINUE                                                     SLAP........606900
         ENDIF                                                           SLAP........607000
 30   CONTINUE                                                           SLAP........607100
C                                                                        SLAP........607200
C         Solve  D*Z = Y,  storing result in X.                          SLAP........607300
      DO 40 I=1,N                                                        SLAP........607400
         X(I) = X(I)*DINV(I)                                             SLAP........607500
 40   CONTINUE                                                           SLAP........607600
C                                                                        SLAP........607700
C         Solve  U*X = Z, U stored by columns.                           SLAP........607800
      DO 60 ICOL = N, 2, -1                                              SLAP........607900
         JBGN = JU(ICOL)                                                 SLAP........608000
         JEND = JU(ICOL+1)-1                                             SLAP........608100
         IF( JBGN.LE.JEND ) THEN                                         SLAP........608200
CLLL. OPTION ASSERT (NOHAZARD)                                           SLAP........608300
CDIR$ IVDEP                                                              SLAP........608400
CVD$ NODEPCHK                                                            SLAP........608500
            DO 50 J = JBGN, JEND                                         SLAP........608600
               X(IU(J)) = X(IU(J)) - U(J)*X(ICOL)                        SLAP........608700
 50         CONTINUE                                                     SLAP........608800
         ENDIF                                                           SLAP........608900
 60   CONTINUE                                                           SLAP........609000
C                                                                        SLAP........609100
      RETURN                                                             SLAP........609200
C------------- LAST LINE OF DSLUI2 FOLLOWS ----------------------------  SLAP........609300
      END                                                                SLAP........609400
*DECK DSLUOM                                                             SLAP........609500
      SUBROUTINE DSLUOM (N, B, X, NELT, IA, JA, A, ISYM, NSAVE, ITOL,    SLAP........609600
     +   TOL, ITMAX, ITER, ERR, IERR, IUNIT, RWORK, LENW, IWORK, LENIW)  SLAP........609700
C***BEGIN PROLOGUE  DSLUOM                                               SLAP........609800
C***PURPOSE  Incomplete LU Orthomin Sparse Iterative Ax=b Solver.        SLAP........609900
C            Routine to solve a general linear system  Ax = b  using     SLAP........610000
C            the Orthomin method with Incomplete LU decomposition.       SLAP........610100
C***LIBRARY   SLATEC (SLAP)                                              SLAP........610200
C***CATEGORY  D2A4, D2B4                                                 SLAP........610300
C***TYPE      DOUBLE PRECISION (SSLUOM-S, DSLUOM-D)                      SLAP........610400
C***KEYWORDS  ITERATIVE INCOMPLETE LU PRECONDITION,                      SLAP........610500
C             NON-SYMMETRIC LINEAR SYSTEM, SLAP, SPARSE                  SLAP........610600
C***AUTHOR  Greenbaum, Anne, (Courant Institute)                         SLAP........610700
C           Seager, Mark K., (LLNL)                                      SLAP........610800
C             Lawrence Livermore National Laboratory                     SLAP........610900
C             PO BOX 808, L-60                                           SLAP........611000
C             Livermore, CA 94550 (510) 423-3141                         SLAP........611100
C             seager@llnl.gov                                            SLAP........611200
C***DESCRIPTION                                                          SLAP........611300
C                                                                        SLAP........611400
C *Usage:                                                                SLAP........611500
C     INTEGER N, NELT, IA(NELT), JA(NELT), ISYM, NSAVE, ITOL, ITMAX      SLAP........611600
C     INTEGER ITER, IERR, IUNIT, LENW, IWORK(NL+NU+4*N+2), LENIW         SLAP........611700
C     DOUBLE PRECISION B(N), X(N), A(NELT), TOL, ERR                     SLAP........611800
C     DOUBLE PRECISION RWORK(NL+NU+7*N+3*N*NSAVE+NSAVE)                  SLAP........611900
C                                                                        SLAP........612000
C     CALL DSLUOM(N, B, X, NELT, IA, JA, A, ISYM, NSAVE, ITOL, TOL,      SLAP........612100
C    $     ITMAX, ITER, ERR, IERR, IUNIT, RWORK, LENW, IWORK, LENIW )    SLAP........612200
C                                                                        SLAP........612300
C *Arguments:                                                            SLAP........612400
C N      :IN       Integer.                                              SLAP........612500
C         Order of the matrix.                                           SLAP........612600
C B      :IN       Double Precision B(N).                                SLAP........612700
C         Right-hand side vector.                                        SLAP........612800
C X      :INOUT    Double Precision X(N).                                SLAP........612900
C         On input X is your initial guess for solution vector.          SLAP........613000
C         On output X is the final approximate solution.                 SLAP........613100
C NELT   :IN       Integer.                                              SLAP........613200
C         Number of Non-Zeros stored in A.                               SLAP........613300
C IA     :INOUT    Integer IA(NELT).                                     SLAP........613400
C JA     :INOUT    Integer JA(NELT).                                     SLAP........613500
C A      :INOUT    Double Precision A(NELT).                             SLAP........613600
C         These arrays should hold the matrix A in either the SLAP       SLAP........613700
C         Triad format or the SLAP Column format.  See "Description",    SLAP........613800
C         below.  If the SLAP Triad format is chosen, it is changed      SLAP........613900
C         internally to the SLAP Column format.                          SLAP........614000
C ISYM   :IN       Integer.                                              SLAP........614100
C         Flag to indicate symmetric storage format.                     SLAP........614200
C         If ISYM=0, all non-zero entries of the matrix are stored.      SLAP........614300
C         If ISYM=1, the matrix is symmetric, and only the upper         SLAP........614400
C         or lower triangle of the matrix is stored.                     SLAP........614500
C NSAVE  :IN       Integer.                                              SLAP........614600
C         Number of direction vectors to save and orthogonalize against. SLAP........614700
C ITOL   :IN       Integer.                                              SLAP........614800
C         Flag to indicate type of convergence criterion.                SLAP........614900
C         If ITOL=1, iteration stops when the 2-norm of the residual     SLAP........615000
C         divided by the 2-norm of the right-hand side is less than TOL. SLAP........615100
C         If ITOL=2, iteration stops when the 2-norm of M-inv times the  SLAP........615200
C         residual divided by the 2-norm of M-inv times the right hand   SLAP........615300
C         side is less than TOL, where M-inv is the inverse of the       SLAP........615400
C         diagonal of A.                                                 SLAP........615500
C         ITOL=11 is often useful for checking and comparing different   SLAP........615600
C         routines.  For this case, the user must supply the "exact"     SLAP........615700
C         solution or a very accurate approximation (one with an error   SLAP........615800
C         much less than TOL) through a common block,                    SLAP........615900
C             COMMON /DSLBLK/ SOLN( )                                    SLAP........616000
C         If ITOL=11, iteration stops when the 2-norm of the difference  SLAP........616100
C         between the iterative approximation and the user-supplied      SLAP........616200
C         solution divided by the 2-norm of the user-supplied solution   SLAP........616300
C         is less than TOL.  Note that this requires the user to set up  SLAP........616400
C         the "COMMON /DSLBLK/ SOLN(LENGTH)" in the calling routine.     SLAP........616500
C         The routine with this declaration should be loaded before the  SLAP........616600
C         stop test so that the correct length is used by the loader.    SLAP........616700
C         This procedure is not standard Fortran and may not work        SLAP........616800
C         correctly on your system (although it has worked on every      SLAP........616900
C         system the authors have tried).  If ITOL is not 11 then this   SLAP........617000
C         common block is indeed standard Fortran.                       SLAP........617100
C TOL    :INOUT    Double Precision.                                     SLAP........617200
C         Convergence criterion, as described above.  (Reset if IERR=4.) SLAP........617300
C ITMAX  :IN       Integer.                                              SLAP........617400
C         Maximum number of iterations.                                  SLAP........617500
C ITER   :OUT      Integer.                                              SLAP........617600
C         Number of iterations required to reach convergence, or         SLAP........617700
C         ITMAX+1 if convergence criterion could not be achieved in      SLAP........617800
C         ITMAX iterations.                                              SLAP........617900
C ERR    :OUT      Double Precision.                                     SLAP........618000
C         Error estimate of error in final approximate solution, as      SLAP........618100
C         defined by ITOL.                                               SLAP........618200
C IERR   :OUT      Integer.                                              SLAP........618300
C         Return error flag.                                             SLAP........618400
C           IERR = 0 => All went well.                                   SLAP........618500
C           IERR = 1 => Insufficient space allocated for WORK or IWORK.  SLAP........618600
C           IERR = 2 => Method failed to converge in ITMAX steps.        SLAP........618700
C           IERR = 3 => Error in user input.                             SLAP........618800
C                       Check input values of N, ITOL.                   SLAP........618900
C           IERR = 4 => User error tolerance set too tight.              SLAP........619000
C                       Reset to 500*D1MACH(3).  Iteration proceeded.    SLAP........619100
C           IERR = 5 => Preconditioning matrix, M, is not positive       SLAP........619200
C                       definite.  (r,z) < 0.                            SLAP........619300
C           IERR = 6 => Breakdown of the method detected.                SLAP........619400
C                       (p,Ap) < epsilon**2.                             SLAP........619500
C           IERR = 7 => Incomplete factorization broke down and was      SLAP........619600
C                       fudged.  Resulting preconditioning may be less   SLAP........619700
C                       than the best.                                   SLAP........619800
C IUNIT  :IN       Integer.                                              SLAP........619900
C         Unit number on which to write the error at each iteration,     SLAP........620000
C         if this is desired for monitoring convergence.  If unit        SLAP........620100
C         number is 0, no writing will occur.                            SLAP........620200
C RWORK  :WORK     Double Precision RWORK(LENW).                         SLAP........620300
C         Double Precision array used for workspace.  NL is the number   SLAP........620400
C         of non-zeros in the lower triangle of the matrix (including    SLAP........620500
C         the diagonal).  NU is the number of non-zeros in the upper     SLAP........620600
C         triangle of the matrix (including the diagonal).               SLAP........620700
C LENW   :IN       Integer.                                              SLAP........620800
C         Length of the double precision workspace, RWORK.               SLAP........620900
C         LENW >= NL+NU+4*N+NSAVE*(3*N+1)                                SLAP........621000
C IWORK  :WORK     Integer IWORK(LENIW)                                  SLAP........621100
C         Integer array used for workspace.  NL is the number of non-    SLAP........621200
C         zeros in the lower triangle of the matrix (including the       SLAP........621300
C         diagonal).  NU is the number of non-zeros in the upper         SLAP........621400
C         triangle of the matrix (including the diagonal).               SLAP........621500
C         Upon return the following locations of IWORK hold information  SLAP........621600
C         which may be of use to the user:                               SLAP........621700
C         IWORK(9)  Amount of Integer workspace actually used.           SLAP........621800
C         IWORK(10) Amount of Double Precision workspace actually used.  SLAP........621900
C LENIW  :IN       Integer.                                              SLAP........622000
C         Length of the integer workspace, IWORK.                        SLAP........622100
C         LENIW >= NL+NU+4*N+12.                                         SLAP........622200
C                                                                        SLAP........622300
C *Description:                                                          SLAP........622400
C       This routine is  simply a driver  for  the DOMN routine.  It     SLAP........622500
C       calls the DSILUS routine  to set  up the preconditioning and     SLAP........622600
C       then  calls   DOMN  with the appropriate  MATVEC  and MSOLVE     SLAP........622700
C       routines.                                                        SLAP........622800
C                                                                        SLAP........622900
C       The Sparse Linear Algebra Package (SLAP) utilizes two matrix     SLAP........623000
C       data structures: 1) the  SLAP Triad  format or  2)  the SLAP     SLAP........623100
C       Column format.  The user can hand this routine either of the     SLAP........623200
C       of these data structures and SLAP  will figure out  which on     SLAP........623300
C       is being used and act accordingly.                               SLAP........623400
C                                                                        SLAP........623500
C       =================== S L A P Triad format ===================     SLAP........623600
C                                                                        SLAP........623700
C       This routine requires that the  matrix A be   stored in  the     SLAP........623800
C       SLAP  Triad format.  In  this format only the non-zeros  are     SLAP........623900
C       stored.  They may appear in  *ANY* order.  The user supplies     SLAP........624000
C       three arrays of  length NELT, where  NELT is  the number  of     SLAP........624100
C       non-zeros in the matrix: (IA(NELT), JA(NELT), A(NELT)).  For     SLAP........624200
C       each non-zero the user puts the row and column index of that     SLAP........624300
C       matrix element  in the IA and  JA arrays.  The  value of the     SLAP........624400
C       non-zero   matrix  element is  placed  in  the corresponding     SLAP........624500
C       location of the A array.   This is  an  extremely  easy data     SLAP........624600
C       structure to generate.  On  the  other hand it   is  not too     SLAP........624700
C       efficient on vector computers for  the iterative solution of     SLAP........624800
C       linear systems.  Hence,   SLAP changes   this  input    data     SLAP........624900
C       structure to the SLAP Column format  for  the iteration (but     SLAP........625000
C       does not change it back).                                        SLAP........625100
C                                                                        SLAP........625200
C       Here is an example of the  SLAP Triad   storage format for a     SLAP........625300
C       5x5 Matrix.  Recall that the entries may appear in any order.    SLAP........625400
C                                                                        SLAP........625500
C           5x5 Matrix      SLAP Triad format for 5x5 matrix on left.    SLAP........625600
C                              1  2  3  4  5  6  7  8  9 10 11           SLAP........625700
C       |11 12  0  0 15|   A: 51 12 11 33 15 53 55 22 35 44 21           SLAP........625800
C       |21 22  0  0  0|  IA:  5  1  1  3  1  5  5  2  3  4  2           SLAP........625900
C       | 0  0 33  0 35|  JA:  1  2  1  3  5  3  5  2  5  4  1           SLAP........626000
C       | 0  0  0 44  0|                                                 SLAP........626100
C       |51  0 53  0 55|                                                 SLAP........626200
C                                                                        SLAP........626300
C       =================== S L A P Column format ==================     SLAP........626400
C                                                                        SLAP........626500
C       This routine  requires that  the matrix A  be stored in  the     SLAP........626600
C       SLAP Column format.  In this format the non-zeros are stored     SLAP........626700
C       counting down columns (except for  the diagonal entry, which     SLAP........626800
C       must appear first in each  "column")  and are stored  in the     SLAP........626900
C       double precision array A.   In other words,  for each column     SLAP........627000
C       in the matrix put the diagonal entry in  A.  Then put in the     SLAP........627100
C       other non-zero  elements going down  the column (except  the     SLAP........627200
C       diagonal) in order.   The  IA array holds the  row index for     SLAP........627300
C       each non-zero.  The JA array holds the offsets  into the IA,     SLAP........627400
C       A arrays  for  the  beginning  of each   column.   That  is,     SLAP........627500
C       IA(JA(ICOL)),  A(JA(ICOL)) points   to the beginning  of the     SLAP........627600
C       ICOL-th   column    in    IA and   A.      IA(JA(ICOL+1)-1),     SLAP........627700
C       A(JA(ICOL+1)-1) points to  the  end of the   ICOL-th column.     SLAP........627800
C       Note that we always have  JA(N+1) = NELT+1,  where N is  the     SLAP........627900
C       number of columns in  the matrix and NELT  is the number  of     SLAP........628000
C       non-zeros in the matrix.                                         SLAP........628100
C                                                                        SLAP........628200
C       Here is an example of the  SLAP Column  storage format for a     SLAP........628300
C       5x5 Matrix (in the A and IA arrays '|'  denotes the end of a     SLAP........628400
C       column):                                                         SLAP........628500
C                                                                        SLAP........628600
C           5x5 Matrix      SLAP Column format for 5x5 matrix on left.   SLAP........628700
C                              1  2  3    4  5    6  7    8    9 10 11   SLAP........628800
C       |11 12  0  0 15|   A: 11 21 51 | 22 12 | 33 53 | 44 | 55 15 35   SLAP........628900
C       |21 22  0  0  0|  IA:  1  2  5 |  2  1 |  3  5 |  4 |  5  1  3   SLAP........629000
C       | 0  0 33  0 35|  JA:  1  4  6    8  9   12                      SLAP........629100
C       | 0  0  0 44  0|                                                 SLAP........629200
C       |51  0 53  0 55|                                                 SLAP........629300
C                                                                        SLAP........629400
C *Side Effects:                                                         SLAP........629500
C       The SLAP Triad format (IA, JA,  A) is modified internally to     SLAP........629600
C       be the SLAP Column format.  See above.                           SLAP........629700
C                                                                        SLAP........629800
C *Cautions:                                                             SLAP........629900
C     This routine will attempt to write to the Fortran logical output   SLAP........630000
C     unit IUNIT, if IUNIT .ne. 0.  Thus, the user must make sure that   SLAP........630100
C     this logical unit is attached to a file or terminal before calling SLAP........630200
C     this routine with a non-zero value for IUNIT.  This routine does   SLAP........630300
C     not check for the validity of a non-zero IUNIT unit number.        SLAP........630400
C                                                                        SLAP........630500
C***SEE ALSO  DOMN, DSDOMN                                               SLAP........630600
C***REFERENCES  (NONE)                                                   SLAP........630700
C***ROUTINES CALLED  DCHKW, DOMN, DS2Y, DSILUS, DSLUI, DSMV              SLAP........630800
C***REVISION HISTORY  (YYMMDD)                                           SLAP........630900
C   890404  DATE WRITTEN                                                 SLAP........631000
C   890404  Previous REVISION DATE                                       SLAP........631100
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........631200
C   890921  Removed TeX from comments.  (FNF)                            SLAP........631300
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........631400
C           standard.  (FNF)                                             SLAP........631500
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........631600
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........631700
C   920407  COMMON BLOCK renamed DSLBLK.  (WRB)                          SLAP........631800
C   920511  Added complete declaration section.  (WRB)                   SLAP........631900
C   921019  Corrected NEL to NL.  (FNF)                                  SLAP........632000
C   921113  Corrected C***CATEGORY line.  (FNF)                          SLAP........632100
C***END PROLOGUE  DSLUOM                                                 SLAP........632200
C     .. Parameters ..                                                   SLAP........632300
      INTEGER LOCRB, LOCIB                                               SLAP........632400
      PARAMETER (LOCRB=1, LOCIB=11)                                      SLAP........632500
C     .. Scalar Arguments ..                                             SLAP........632600
      DOUBLE PRECISION ERR, TOL                                          SLAP........632700
      INTEGER IERR, ISYM, ITER, ITMAX, ITOL, IUNIT, LENIW, LENW, N,      SLAP........632800
     +        NELT, NSAVE                                                SLAP........632900
C     .. Array Arguments ..                                              SLAP........633000
      DOUBLE PRECISION A(N), B(N), RWORK(LENW), X(N)                     SLAP........633100
      INTEGER IA(NELT), IWORK(LENIW), JA(NELT)                           SLAP........633200
C     .. Local Scalars ..                                                SLAP........633300
      INTEGER ICOL, J, JBGN, JEND, LOCAP, LOCCSA, LOCDIN, LOCDZ, LOCEMA, SLAP........633400
     +        LOCIL, LOCIU, LOCIW, LOCJL, LOCJU, LOCL, LOCNC, LOCNR,     SLAP........633500
     +        LOCP, LOCR, LOCU, LOCW, LOCZ, NL, NU                       SLAP........633600
C     .. External Subroutines ..                                         SLAP........633700
      EXTERNAL DCHKW, DOMN, DS2Y, DSILUS, DSLUI, DSMV                    SLAP........633800
C***FIRST EXECUTABLE STATEMENT  DSLUOM                                   SLAP........633900
C                                                                        SLAP........634000
      IERR = 0                                                           SLAP........634100
      IF( N.LT.1 .OR. NELT.LT.1 ) THEN                                   SLAP........634200
         IERR = 3                                                        SLAP........634300
         RETURN                                                          SLAP........634400
      ENDIF                                                              SLAP........634500
C                                                                        SLAP........634600
C         Change the SLAP input matrix IA, JA, A to SLAP-Column format.  SLAP........634700
      CALL DS2Y( N, NELT, IA, JA, A, ISYM )                              SLAP........634800
C                                                                        SLAP........634900
C         Count number of Non-Zero elements preconditioner ILU matrix.   SLAP........635000
C         Then set up the work arrays.                                   SLAP........635100
      NL = 0                                                             SLAP........635200
      NU = 0                                                             SLAP........635300
      DO 20 ICOL = 1, N                                                  SLAP........635400
C         Don't count diagonal.                                          SLAP........635500
         JBGN = JA(ICOL)+1                                               SLAP........635600
         JEND = JA(ICOL+1)-1                                             SLAP........635700
         IF( JBGN.LE.JEND ) THEN                                         SLAP........635800
CVD$ NOVECTOR                                                            SLAP........635900
            DO 10 J = JBGN, JEND                                         SLAP........636000
               IF( IA(J).GT.ICOL ) THEN                                  SLAP........636100
                  NL = NL + 1                                            SLAP........636200
                  IF( ISYM.NE.0 ) NU = NU + 1                            SLAP........636300
               ELSE                                                      SLAP........636400
                  NU = NU + 1                                            SLAP........636500
               ENDIF                                                     SLAP........636600
 10         CONTINUE                                                     SLAP........636700
         ENDIF                                                           SLAP........636800
 20   CONTINUE                                                           SLAP........636900
C                                                                        SLAP........637000
      LOCIL = LOCIB                                                      SLAP........637100
C.....THE NEXT LINE OF CODE INCORPORATES A BUG FIX MADE DURING           SLAP........637200
C        INTEGRATION OF SLAP WITH SUTRA.  IT ORIGINALLY READ:            SLAP........637300
C        LOCJL = LOCIL + N+1                                             SLAP........637400
      LOCJL = LOCIL + NL                                                 SLAP........637500
      LOCIU = LOCJL + NL                                                 SLAP........637600
      LOCJU = LOCIU + NU                                                 SLAP........637700
C.....THE NEXT LINE OF CODE INCORPORATES A BUG FIX MADE DURING           SLAP........637800
C        INTEGRATION OF SLAP WITH SUTRA.  IT ORIGINALLY READ:            SLAP........637900
C        LOCNR = LOCJU + N+1                                             SLAP........638000
      LOCNR = LOCJU + NU                                                 SLAP........638100
      LOCNC = LOCNR + N                                                  SLAP........638200
      LOCIW = LOCNC + N                                                  SLAP........638300
C                                                                        SLAP........638400
      LOCL   = LOCRB                                                     SLAP........638500
      LOCDIN = LOCL + NL                                                 SLAP........638600
      LOCU   = LOCDIN + N                                                SLAP........638700
      LOCR   = LOCU + NU                                                 SLAP........638800
      LOCZ   = LOCR + N                                                  SLAP........638900
      LOCP   = LOCZ + N                                                  SLAP........639000
      LOCAP  = LOCP + N*(NSAVE+1)                                        SLAP........639100
      LOCEMA = LOCAP + N*(NSAVE+1)                                       SLAP........639200
      LOCDZ  = LOCEMA + N*(NSAVE+1)                                      SLAP........639300
      LOCCSA = LOCDZ + N                                                 SLAP........639400
      LOCW   = LOCCSA + NSAVE                                            SLAP........639500
C                                                                        SLAP........639600
C         Check the workspace allocations.                               SLAP........639700
      CALL DCHKW( 'DSLUOM', LOCIW, LENIW, LOCW, LENW, IERR, ITER, ERR )  SLAP........639800
      IF( IERR.NE.0 ) RETURN                                             SLAP........639900
C                                                                        SLAP........640000
      IWORK(1) = LOCIL                                                   SLAP........640100
      IWORK(2) = LOCJL                                                   SLAP........640200
      IWORK(3) = LOCIU                                                   SLAP........640300
      IWORK(4) = LOCJU                                                   SLAP........640400
      IWORK(5) = LOCL                                                    SLAP........640500
      IWORK(6) = LOCDIN                                                  SLAP........640600
      IWORK(7) = LOCU                                                    SLAP........640700
      IWORK(9) = LOCIW                                                   SLAP........640800
      IWORK(10) = LOCW                                                   SLAP........640900
C                                                                        SLAP........641000
C         Compute the Incomplete LU decomposition.                       SLAP........641100
      CALL DSILUS( N, NELT, IA, JA, A, ISYM, NL, IWORK(LOCIL),           SLAP........641200
     $     IWORK(LOCJL), RWORK(LOCL), RWORK(LOCDIN), NU, IWORK(LOCIU),   SLAP........641300
     $     IWORK(LOCJU), RWORK(LOCU), IWORK(LOCNR), IWORK(LOCNC) )       SLAP........641400
C                                                                        SLAP........641500
C         Perform the incomplete LU preconditioned OrthoMin algorithm.   SLAP........641600
      CALL DOMN(N, B, X, NELT, IA, JA, A, ISYM, DSMV,                    SLAP........641700
     $     DSLUI, NSAVE, ITOL, TOL, ITMAX, ITER, ERR, IERR, IUNIT,       SLAP........641800
     $     RWORK(LOCR), RWORK(LOCZ), RWORK(LOCP), RWORK(LOCAP),          SLAP........641900
     $     RWORK(LOCEMA), RWORK(LOCDZ), RWORK(LOCCSA),                   SLAP........642000
     $     RWORK, IWORK )                                                SLAP........642100
      RETURN                                                             SLAP........642200
      END                                                                SLAP........642300
*DECK DSMV                                                               SLAP........642400
      SUBROUTINE DSMV (N, X, Y, NELT, IA, JA, A, ISYM)                   SLAP........642500
C***BEGIN PROLOGUE  DSMV                                                 SLAP........642600
C***PURPOSE  SLAP Column Format Sparse Matrix Vector Product.            SLAP........642700
C            Routine to calculate the sparse matrix vector product:      SLAP........642800
C            Y = A*X.                                                    SLAP........642900
C***LIBRARY   SLATEC (SLAP)                                              SLAP........643000
C***CATEGORY  D1B4                                                       SLAP........643100
C***TYPE      DOUBLE PRECISION (SSMV-S, DSMV-D)                          SLAP........643200
C***KEYWORDS  MATRIX VECTOR MULTIPLY, SLAP, SPARSE                       SLAP........643300
C***AUTHOR  Greenbaum, Anne, (Courant Institute)                         SLAP........643400
C           Seager, Mark K., (LLNL)                                      SLAP........643500
C             Lawrence Livermore National Laboratory                     SLAP........643600
C             PO BOX 808, L-60                                           SLAP........643700
C             Livermore, CA 94550 (510) 423-3141                         SLAP........643800
C             seager@llnl.gov                                            SLAP........643900
C***DESCRIPTION                                                          SLAP........644000
C                                                                        SLAP........644100
C *Usage:                                                                SLAP........644200
C     INTEGER  N, NELT, IA(NELT), JA(NELT), ISYM                         SLAP........644300
C     DOUBLE PRECISION X(N), Y(N), A(NELT)                               SLAP........644400
C                                                                        SLAP........644500
C     CALL DSMV(N, X, Y, NELT, IA, JA, A, ISYM )                         SLAP........644600
C                                                                        SLAP........644700
C *Arguments:                                                            SLAP........644800
C N      :IN       Integer.                                              SLAP........644900
C         Order of the Matrix.                                           SLAP........645000
C X      :IN       Double Precision X(N).                                SLAP........645100
C         The vector that should be multiplied by the matrix.            SLAP........645200
C Y      :OUT      Double Precision Y(N).                                SLAP........645300
C         The product of the matrix and the vector.                      SLAP........645400
C NELT   :IN       Integer.                                              SLAP........645500
C         Number of Non-Zeros stored in A.                               SLAP........645600
C IA     :IN       Integer IA(NELT).                                     SLAP........645700
C JA     :IN       Integer JA(NELT).                                     SLAP........645800
C A      :IN       Double Precision A(NELT).                             SLAP........645900
C         These arrays should hold the matrix A in the SLAP Column       SLAP........646000
C         format.  See "Description", below.                             SLAP........646100
C ISYM   :IN       Integer.                                              SLAP........646200
C         Flag to indicate symmetric storage format.                     SLAP........646300
C         If ISYM=0, all non-zero entries of the matrix are stored.      SLAP........646400
C         If ISYM=1, the matrix is symmetric, and only the upper         SLAP........646500
C         or lower triangle of the matrix is stored.                     SLAP........646600
C                                                                        SLAP........646700
C *Description                                                           SLAP........646800
C       =================== S L A P Column format ==================     SLAP........646900
C       This routine  requires that  the matrix A  be stored in  the     SLAP........647000
C       SLAP Column format.  In this format the non-zeros are stored     SLAP........647100
C       counting down columns (except for  the diagonal entry, which     SLAP........647200
C       must appear first in each  "column")  and are stored  in the     SLAP........647300
C       double precision array A.   In other words,  for each column     SLAP........647400
C       in the matrix put the diagonal entry in  A.  Then put in the     SLAP........647500
C       other non-zero  elements going down  the column (except  the     SLAP........647600
C       diagonal) in order.   The  IA array holds the  row index for     SLAP........647700
C       each non-zero.  The JA array holds the offsets  into the IA,     SLAP........647800
C       A arrays  for  the  beginning  of each   column.   That  is,     SLAP........647900
C       IA(JA(ICOL)),  A(JA(ICOL)) points   to the beginning  of the     SLAP........648000
C       ICOL-th   column    in    IA and   A.      IA(JA(ICOL+1)-1),     SLAP........648100
C       A(JA(ICOL+1)-1) points to  the  end of the   ICOL-th column.     SLAP........648200
C       Note that we always have  JA(N+1) = NELT+1,  where N is  the     SLAP........648300
C       number of columns in  the matrix and NELT  is the number  of     SLAP........648400
C       non-zeros in the matrix.                                         SLAP........648500
C                                                                        SLAP........648600
C       Here is an example of the  SLAP Column  storage format for a     SLAP........648700
C       5x5 Matrix (in the A and IA arrays '|'  denotes the end of a     SLAP........648800
C       column):                                                         SLAP........648900
C                                                                        SLAP........649000
C           5x5 Matrix      SLAP Column format for 5x5 matrix on left.   SLAP........649100
C                              1  2  3    4  5    6  7    8    9 10 11   SLAP........649200
C       |11 12  0  0 15|   A: 11 21 51 | 22 12 | 33 53 | 44 | 55 15 35   SLAP........649300
C       |21 22  0  0  0|  IA:  1  2  5 |  2  1 |  3  5 |  4 |  5  1  3   SLAP........649400
C       | 0  0 33  0 35|  JA:  1  4  6    8  9   12                      SLAP........649500
C       | 0  0  0 44  0|                                                 SLAP........649600
C       |51  0 53  0 55|                                                 SLAP........649700
C                                                                        SLAP........649800
C       With  the SLAP  format  the "inner  loops" of  this  routine     SLAP........649900
C       should vectorize   on machines with   hardware  support  for     SLAP........650000
C       vector gather/scatter operations.  Your compiler may require     SLAP........650100
C       a  compiler directive  to  convince   it that there  are  no     SLAP........650200
C       implicit vector  dependencies.  Compiler directives  for the     SLAP........650300
C       Alliant FX/Fortran and CRI CFT/CFT77 compilers  are supplied     SLAP........650400
C       with the standard SLAP distribution.                             SLAP........650500
C                                                                        SLAP........650600
C *Cautions:                                                             SLAP........650700
C     This   routine   assumes  that  the matrix A is stored in SLAP     SLAP........650800
C     Column format.  It does not check  for  this (for  speed)  and     SLAP........650900
C     evil, ugly, ornery and nasty things  will happen if the matrix     SLAP........651000
C     data  structure  is,  in fact, not SLAP Column.  Beware of the     SLAP........651100
C     wrong data structure!!!                                            SLAP........651200
C                                                                        SLAP........651300
C***SEE ALSO  DSMTV                                                      SLAP........651400
C***REFERENCES  (NONE)                                                   SLAP........651500
C***ROUTINES CALLED  (NONE)                                              SLAP........651600
C***REVISION HISTORY  (YYMMDD)                                           SLAP........651700
C   871119  DATE WRITTEN                                                 SLAP........651800
C   881213  Previous REVISION DATE                                       SLAP........651900
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........652000
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........652100
C           standard.  (FNF)                                             SLAP........652200
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........652300
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........652400
C   920511  Added complete declaration section.  (WRB)                   SLAP........652500
C   930701  Updated CATEGORY section.  (FNF, WRB)                        SLAP........652600
C***END PROLOGUE  DSMV                                                   SLAP........652700
C     .. Scalar Arguments ..                                             SLAP........652800
      INTEGER ISYM, N, NELT                                              SLAP........652900
C     .. Array Arguments ..                                              SLAP........653000
      DOUBLE PRECISION A(NELT), X(N), Y(N)                               SLAP........653100
      INTEGER IA(NELT), JA(NELT)                                         SLAP........653200
C     .. Local Scalars ..                                                SLAP........653300
      INTEGER I, IBGN, ICOL, IEND, IROW, J, JBGN, JEND                   SLAP........653400
C***FIRST EXECUTABLE STATEMENT  DSMV                                     SLAP........653500
C                                                                        SLAP........653600
C         Zero out the result vector.                                    SLAP........653700
C                                                                        SLAP........653800
      DO 10 I = 1, N                                                     SLAP........653900
         Y(I) = 0                                                        SLAP........654000
 10   CONTINUE                                                           SLAP........654100
C                                                                        SLAP........654200
C         Multiply by A.                                                 SLAP........654300
C                                                                        SLAP........654400
CVD$R NOCONCUR                                                           SLAP........654500
      DO 30 ICOL = 1, N                                                  SLAP........654600
         IBGN = JA(ICOL)                                                 SLAP........654700
         IEND = JA(ICOL+1)-1                                             SLAP........654800
CLLL. OPTION ASSERT (NOHAZARD)                                           SLAP........654900
CDIR$ IVDEP                                                              SLAP........655000
CVD$ NODEPCHK                                                            SLAP........655100
         DO 20 I = IBGN, IEND                                            SLAP........655200
            Y(IA(I)) = Y(IA(I)) + A(I)*X(ICOL)                           SLAP........655300
 20      CONTINUE                                                        SLAP........655400
 30   CONTINUE                                                           SLAP........655500
C                                                                        SLAP........655600
      IF( ISYM.EQ.1 ) THEN                                               SLAP........655700
C                                                                        SLAP........655800
C         The matrix is non-symmetric.  Need to get the other half in... SLAP........655900
C         This loops assumes that the diagonal is the first entry in     SLAP........656000
C         each column.                                                   SLAP........656100
C                                                                        SLAP........656200
         DO 50 IROW = 1, N                                               SLAP........656300
            JBGN = JA(IROW)+1                                            SLAP........656400
            JEND = JA(IROW+1)-1                                          SLAP........656500
            IF( JBGN.GT.JEND ) GOTO 50                                   SLAP........656600
            DO 40 J = JBGN, JEND                                         SLAP........656700
               Y(IROW) = Y(IROW) + A(J)*X(IA(J))                         SLAP........656800
 40         CONTINUE                                                     SLAP........656900
 50      CONTINUE                                                        SLAP........657000
      ENDIF                                                              SLAP........657100
      RETURN                                                             SLAP........657200
C------------- LAST LINE OF DSMV FOLLOWS ----------------------------    SLAP........657300
      END                                                                SLAP........657400
*DECK DXLCAL                                                             SLAP........657500
      SUBROUTINE DXLCAL (N, LGMR, X, XL, ZL, HES, MAXLP1, Q, V, R0NRM,   SLAP........657600
     +   WK, SZ, JSCAL, JPRE, MSOLVE, NMSL, RPAR, IPAR, NELT, IA, JA, A, SLAP........657700
     +   ISYM)                                                           SLAP........657800
C***BEGIN PROLOGUE  DXLCAL                                               SLAP........657900
C***SUBSIDIARY                                                           SLAP........658000
C***PURPOSE  Internal routine for DGMRES.                                SLAP........658100
C***LIBRARY   SLATEC (SLAP)                                              SLAP........658200
C***CATEGORY  D2A4, D2B4                                                 SLAP........658300
C***TYPE      DOUBLE PRECISION (SXLCAL-S, DXLCAL-D)                      SLAP........658400
C***KEYWORDS  GENERALIZED MINIMUM RESIDUAL, ITERATIVE PRECONDITION,      SLAP........658500
C             NON-SYMMETRIC LINEAR SYSTEM, SLAP, SPARSE                  SLAP........658600
C***AUTHOR  Brown, Peter, (LLNL), pnbrown@llnl.gov                       SLAP........658700
C           Hindmarsh, Alan, (LLNL), alanh@llnl.gov                      SLAP........658800
C           Seager, Mark K., (LLNL), seager@llnl.gov                     SLAP........658900
C             Lawrence Livermore National Laboratory                     SLAP........659000
C             PO Box 808, L-60                                           SLAP........659100
C             Livermore, CA 94550 (510) 423-3141                         SLAP........659200
C***DESCRIPTION                                                          SLAP........659300
C        This  routine computes the solution  XL,  the current DGMRES    SLAP........659400
C        iterate, given the  V(I)'s and  the  QR factorization of the    SLAP........659500
C        Hessenberg  matrix HES.   This routine  is  only called when    SLAP........659600
C        ITOL=11.                                                        SLAP........659700
C                                                                        SLAP........659800
C *Usage:                                                                SLAP........659900
C      INTEGER N, LGMR, MAXLP1, JSCAL, JPRE, NMSL, IPAR(USER DEFINED)    SLAP........660000
C      INTEGER NELT, IA(NELT), JA(NELT), ISYM                            SLAP........660100
C      DOUBLE PRECISION X(N), XL(N), ZL(N), HES(MAXLP1,MAXL), Q(2*MAXL), SLAP........660200
C     $                 V(N,MAXLP1), R0NRM, WK(N), SZ(N),                SLAP........660300
C     $                 RPAR(USER DEFINED), A(NELT)                      SLAP........660400
C      EXTERNAL MSOLVE                                                   SLAP........660500
C                                                                        SLAP........660600
C      CALL DXLCAL(N, LGMR, X, XL, ZL, HES, MAXLP1, Q, V, R0NRM,         SLAP........660700
C     $     WK, SZ, JSCAL, JPRE, MSOLVE, NMSL, RPAR, IPAR,               SLAP........660800
C     $     NELT, IA, JA, A, ISYM)                                       SLAP........660900
C                                                                        SLAP........661000
C *Arguments:                                                            SLAP........661100
C N      :IN       Integer                                               SLAP........661200
C         The order of the matrix A, and the lengths                     SLAP........661300
C         of the vectors SR, SZ, R0 and Z.                               SLAP........661400
C LGMR   :IN       Integer                                               SLAP........661500
C         The number of iterations performed and                         SLAP........661600
C         the current order of the upper Hessenberg                      SLAP........661700
C         matrix HES.                                                    SLAP........661800
C X      :IN       Double Precision X(N)                                 SLAP........661900
C         The current approximate solution as of the last restart.       SLAP........662000
C XL     :OUT      Double Precision XL(N)                                SLAP........662100
C         An array of length N used to hold the approximate              SLAP........662200
C         solution X(L).                                                 SLAP........662300
C         Warning: XL and ZL are the same array in the calling routine.  SLAP........662400
C ZL     :IN       Double Precision ZL(N)                                SLAP........662500
C         An array of length N used to hold the approximate              SLAP........662600
C         solution Z(L).                                                 SLAP........662700
C HES    :IN       Double Precision HES(MAXLP1,MAXL)                     SLAP........662800
C         The upper triangular factor of the QR decomposition            SLAP........662900
C         of the (LGMR+1) by LGMR upper Hessenberg matrix whose          SLAP........663000
C         entries are the scaled inner-products of A*V(*,i) and V(*,k).  SLAP........663100
C MAXLP1 :IN       Integer                                               SLAP........663200
C         MAXLP1 = MAXL + 1, used for dynamic dimensioning of HES.       SLAP........663300
C         MAXL is the maximum allowable order of the matrix HES.         SLAP........663400
C Q      :IN       Double Precision Q(2*MAXL)                            SLAP........663500
C         A double precision array of length 2*MAXL containing the       SLAP........663600
C         components of the Givens rotations used in the QR              SLAP........663700
C         decomposition of HES.  It is loaded in DHEQR.                  SLAP........663800
C V      :IN       Double Precision V(N,MAXLP1)                          SLAP........663900
C         The N by(LGMR+1) array containing the LGMR                     SLAP........664000
C         orthogonal vectors V(*,1) to V(*,LGMR).                        SLAP........664100
C R0NRM  :IN       Double Precision                                      SLAP........664200
C         The scaled norm of the initial residual for the                SLAP........664300
C         current call to DPIGMR.                                        SLAP........664400
C WK     :IN       Double Precision WK(N)                                SLAP........664500
C         A double precision work array of length N.                     SLAP........664600
C SZ     :IN       Double Precision SZ(N)                                SLAP........664700
C         A vector of length N containing the non-zero                   SLAP........664800
C         elements of the diagonal scaling matrix for Z.                 SLAP........664900
C JSCAL  :IN       Integer                                               SLAP........665000
C         A flag indicating whether arrays SR and SZ are used.           SLAP........665100
C         JSCAL=0 means SR and SZ are not used and the                   SLAP........665200
C                 algorithm will perform as if all                       SLAP........665300
C                 SR(i) = 1 and SZ(i) = 1.                               SLAP........665400
C         JSCAL=1 means only SZ is used, and the algorithm               SLAP........665500
C                 performs as if all SR(i) = 1.                          SLAP........665600
C         JSCAL=2 means only SR is used, and the algorithm               SLAP........665700
C                 performs as if all SZ(i) = 1.                          SLAP........665800
C         JSCAL=3 means both SR and SZ are used.                         SLAP........665900
C JPRE   :IN       Integer                                               SLAP........666000
C         The preconditioner type flag.                                  SLAP........666100
C MSOLVE :EXT      External.                                             SLAP........666200
C         Name of the routine which solves a linear system Mz = r for    SLAP........666300
C         z given r with the preconditioning matrix M (M is supplied via SLAP........666400
C         RPAR and IPAR arrays.  The name of the MSOLVE routine must     SLAP........666500
C         be declared external in the calling program.  The calling      SLAP........666600
C         sequence to MSOLVE is:                                         SLAP........666700
C             CALL MSOLVE(N, R, Z, NELT, IA, JA, A, ISYM, RPAR, IPAR)    SLAP........666800
C         Where N is the number of unknowns, R is the right-hand side    SLAP........666900
C         vector and Z is the solution upon return.  NELT, IA, JA, A and SLAP........667000
C         ISYM are defined as below.  RPAR is a double precision array   SLAP........667100
C         that can be used to pass necessary preconditioning information SLAP........667200
C         and/or workspace to MSOLVE.  IPAR is an integer work array     SLAP........667300
C         for the same purpose as RPAR.                                  SLAP........667400
C NMSL   :IN       Integer                                               SLAP........667500
C         The number of calls to MSOLVE.                                 SLAP........667600
C RPAR   :IN       Double Precision RPAR(USER DEFINED)                   SLAP........667700
C         Double Precision workspace passed directly to the MSOLVE       SLAP........667800
C         routine.                                                       SLAP........667900
C IPAR   :IN       Integer IPAR(USER DEFINED)                            SLAP........668000
C         Integer workspace passed directly to the MSOLVE routine.       SLAP........668100
C NELT   :IN       Integer                                               SLAP........668200
C         The length of arrays IA, JA and A.                             SLAP........668300
C IA     :IN       Integer IA(NELT)                                      SLAP........668400
C         An integer array of length NELT containing matrix data.        SLAP........668500
C         It is passed directly to the MATVEC and MSOLVE routines.       SLAP........668600
C JA     :IN       Integer JA(NELT)                                      SLAP........668700
C         An integer array of length NELT containing matrix data.        SLAP........668800
C         It is passed directly to the MATVEC and MSOLVE routines.       SLAP........668900
C A      :IN       Double Precision A(NELT)                              SLAP........669000
C         A double precision array of length NELT containing matrix      SLAP........669100
C         data.                                                          SLAP........669200
C         It is passed directly to the MATVEC and MSOLVE routines.       SLAP........669300
C ISYM   :IN       Integer                                               SLAP........669400
C         A flag to indicate symmetric matrix storage.                   SLAP........669500
C         If ISYM=0, all non-zero entries of the matrix are              SLAP........669600
C         stored.  If ISYM=1, the matrix is symmetric and                SLAP........669700
C         only the upper or lower triangular part is stored.             SLAP........669800
C                                                                        SLAP........669900
C***SEE ALSO  DGMRES                                                     SLAP........670000
C***ROUTINES CALLED  DAXPY, DCOPY, DHELS                                 SLAP........670100
C***REVISION HISTORY  (YYMMDD)                                           SLAP........670200
C   890404  DATE WRITTEN                                                 SLAP........670300
C   890404  Previous REVISION DATE                                       SLAP........670400
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........670500
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........670600
C           standard.  (FNF)                                             SLAP........670700
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........670800
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........670900
C   910502  Removed MSOLVE from ROUTINES CALLED list.  (FNF)             SLAP........671000
C   910506  Made subsidiary to DGMRES.  (FNF)                            SLAP........671100
C   920511  Added complete declaration section.  (WRB)                   SLAP........671200
C***END PROLOGUE  DXLCAL                                                 SLAP........671300
C         The following is for optimized compilation on LLNL/LTSS Crays. SLAP........671400
CLLL. OPTIMIZE                                                           SLAP........671500
C     .. Scalar Arguments ..                                             SLAP........671600
      DOUBLE PRECISION R0NRM                                             SLAP........671700
      INTEGER ISYM, JPRE, JSCAL, LGMR, MAXLP1, N, NELT, NMSL             SLAP........671800
C     .. Array Arguments ..                                              SLAP........671900
      DOUBLE PRECISION A(NELT), HES(MAXLP1,*), Q(*), RPAR(*), SZ(*),     SLAP........672000
     +                 V(N,*), WK(N), X(N), XL(N), ZL(N)                 SLAP........672100
      INTEGER IA(NELT), IPAR(*), JA(NELT)                                SLAP........672200
C     .. Subroutine Arguments ..                                         SLAP........672300
      EXTERNAL MSOLVE                                                    SLAP........672400
C     .. Local Scalars ..                                                SLAP........672500
      INTEGER I, K, LL, LLP1                                             SLAP........672600
C     .. External Subroutines ..                                         SLAP........672700
      EXTERNAL DAXPY, DCOPY, DHELS                                       SLAP........672800
C***FIRST EXECUTABLE STATEMENT  DXLCAL                                   SLAP........672900
      LL = LGMR                                                          SLAP........673000
      LLP1 = LL + 1                                                      SLAP........673100
      DO 10 K = 1,LLP1                                                   SLAP........673200
         WK(K) = 0                                                       SLAP........673300
 10   CONTINUE                                                           SLAP........673400
      WK(1) = R0NRM                                                      SLAP........673500
      CALL DHELS(HES, MAXLP1, LL, Q, WK)                                 SLAP........673600
      DO 20 K = 1,N                                                      SLAP........673700
         ZL(K) = 0                                                       SLAP........673800
 20   CONTINUE                                                           SLAP........673900
      DO 30 I = 1,LL                                                     SLAP........674000
         CALL DAXPY(N, WK(I), V(1,I), 1, ZL, 1)                          SLAP........674100
 30   CONTINUE                                                           SLAP........674200
      IF ((JSCAL .EQ. 1) .OR.(JSCAL .EQ. 3)) THEN                        SLAP........674300
         DO 40 K = 1,N                                                   SLAP........674400
            ZL(K) = ZL(K)/SZ(K)                                          SLAP........674500
 40      CONTINUE                                                        SLAP........674600
      ENDIF                                                              SLAP........674700
      IF (JPRE .GT. 0) THEN                                              SLAP........674800
         CALL DCOPY(N, ZL, 1, WK, 1)                                     SLAP........674900
         CALL MSOLVE(N, WK, ZL, NELT, IA, JA, A, ISYM, RPAR, IPAR)       SLAP........675000
         NMSL = NMSL + 1                                                 SLAP........675100
      ENDIF                                                              SLAP........675200
C         calculate XL from X and ZL.                                    SLAP........675300
      DO 50 K = 1,N                                                      SLAP........675400
         XL(K) = X(K) + ZL(K)                                            SLAP........675500
 50   CONTINUE                                                           SLAP........675600
      RETURN                                                             SLAP........675700
C------------- LAST LINE OF DXLCAL FOLLOWS ----------------------------  SLAP........675800
      END                                                                SLAP........675900
*DECK FDUMP                                                              SLAP........676000
      SUBROUTINE FDUMP                                                   SLAP........676100
C***BEGIN PROLOGUE  FDUMP                                                SLAP........676200
C***PURPOSE  Symbolic dump (should be locally written).                  SLAP........676300
C***LIBRARY   SLATEC (XERROR)                                            SLAP........676400
C***CATEGORY  R3                                                         SLAP........676500
C***TYPE      ALL (FDUMP-A)                                              SLAP........676600
C***KEYWORDS  ERROR, XERMSG                                              SLAP........676700
C***AUTHOR  Jones, R. E., (SNLA)                                         SLAP........676800
C***DESCRIPTION                                                          SLAP........676900
C                                                                        SLAP........677000
C        ***Note*** Machine Dependent Routine                            SLAP........677100
C        FDUMP is intended to be replaced by a locally written           SLAP........677200
C        version which produces a symbolic dump.  Failing this,          SLAP........677300
C        it should be replaced by a version which prints the             SLAP........677400
C        subprogram nesting list.  Note that this dump must be           SLAP........677500
C        printed on each of up to five files, as indicated by the        SLAP........677600
C        XGETUA routine.  See XSETUA and XGETUA for details.             SLAP........677700
C                                                                        SLAP........677800
C     Written by Ron Jones, with SLATEC Common Math Library Subcommittee SLAP........677900
C                                                                        SLAP........678000
C***REFERENCES  (NONE)                                                   SLAP........678100
C***ROUTINES CALLED  (NONE)                                              SLAP........678200
C***REVISION HISTORY  (YYMMDD)                                           SLAP........678300
C   790801  DATE WRITTEN                                                 SLAP........678400
C   861211  REVISION DATE from Version 3.2                               SLAP........678500
C   891214  Prologue converted to Version 4.0 format.  (BAB)             SLAP........678600
C***END PROLOGUE  FDUMP                                                  SLAP........678700
C***FIRST EXECUTABLE STATEMENT  FDUMP                                    SLAP........678800
      RETURN                                                             SLAP........678900
      END                                                                SLAP........679000
*DECK I1MACH                                                             SLAP........679100
      INTEGER FUNCTION I1MACH (I)                                        SLAP........679200
C***BEGIN PROLOGUE  I1MACH                                               SLAP........679300
C***PURPOSE  Return integer machine dependent constants.                 SLAP........679400
C***LIBRARY   SLATEC                                                     SLAP........679500
C***CATEGORY  R1                                                         SLAP........679600
C***TYPE      INTEGER (I1MACH-I)                                         SLAP........679700
C***KEYWORDS  MACHINE CONSTANTS                                          SLAP........679800
C***AUTHOR  Fox, P. A., (Bell Labs)                                      SLAP........679900
C           Hall, A. D., (Bell Labs)                                     SLAP........680000
C           Schryer, N. L., (Bell Labs)                                  SLAP........680100
C***DESCRIPTION                                                          SLAP........680200
C                                                                        SLAP........680300
C   I1MACH can be used to obtain machine-dependent parameters for the    SLAP........680400
C   local machine environment.  It is a function subprogram with one     SLAP........680500
C   (input) argument and can be referenced as follows:                   SLAP........680600
C                                                                        SLAP........680700
C        K = I1MACH(I)                                                   SLAP........680800
C                                                                        SLAP........680900
C   where I=1,...,16.  The (output) value of K above is determined by    SLAP........681000
C   the (input) value of I.  The results for various values of I are     SLAP........681100
C   discussed below.                                                     SLAP........681200
C                                                                        SLAP........681300
C   I/O unit numbers:                                                    SLAP........681400
C     I1MACH( 1) = the standard input unit.                              SLAP........681500
C     I1MACH( 2) = the standard output unit.                             SLAP........681600
C     I1MACH( 3) = the standard punch unit.                              SLAP........681700
C     I1MACH( 4) = the standard error message unit.                      SLAP........681800
C                                                                        SLAP........681900
C   Words:                                                               SLAP........682000
C     I1MACH( 5) = the number of bits per integer storage unit.          SLAP........682100
C     I1MACH( 6) = the number of characters per integer storage unit.    SLAP........682200
C                                                                        SLAP........682300
C   Integers:                                                            SLAP........682400
C     assume integers are represented in the S-digit, base-A form        SLAP........682500
C                                                                        SLAP........682600
C                sign ( X(S-1)*A**(S-1) + ... + X(1)*A + X(0) )          SLAP........682700
C                                                                        SLAP........682800
C                where 0 .LE. X(I) .LT. A for I=0,...,S-1.               SLAP........682900
C     I1MACH( 7) = A, the base.                                          SLAP........683000
C     I1MACH( 8) = S, the number of base-A digits.                       SLAP........683100
C     I1MACH( 9) = A**S - 1, the largest magnitude.                      SLAP........683200
C                                                                        SLAP........683300
C   Floating-Point Numbers:                                              SLAP........683400
C     Assume floating-point numbers are represented in the T-digit,      SLAP........683500
C     base-B form                                                        SLAP........683600
C                sign (B**E)*( (X(1)/B) + ... + (X(T)/B**T) )            SLAP........683700
C                                                                        SLAP........683800
C                where 0 .LE. X(I) .LT. B for I=1,...,T,                 SLAP........683900
C                0 .LT. X(1), and EMIN .LE. E .LE. EMAX.                 SLAP........684000
C     I1MACH(10) = B, the base.                                          SLAP........684100
C                                                                        SLAP........684200
C   Single-Precision:                                                    SLAP........684300
C     I1MACH(11) = T, the number of base-B digits.                       SLAP........684400
C     I1MACH(12) = EMIN, the smallest exponent E.                        SLAP........684500
C     I1MACH(13) = EMAX, the largest exponent E.                         SLAP........684600
C                                                                        SLAP........684700
C   Double-Precision:                                                    SLAP........684800
C     I1MACH(14) = T, the number of base-B digits.                       SLAP........684900
C     I1MACH(15) = EMIN, the smallest exponent E.                        SLAP........685000
C     I1MACH(16) = EMAX, the largest exponent E.                         SLAP........685100
C                                                                        SLAP........685200
C   To alter this function for a particular environment, the desired     SLAP........685300
C   set of DATA statements should be activated by removing the C from    SLAP........685400
C   column 1.  Also, the values of I1MACH(1) - I1MACH(4) should be       SLAP........685500
C   checked for consistency with the local operating system.             SLAP........685600
C                                                                        SLAP........685700
C***REFERENCES  P. A. Fox, A. D. Hall and N. L. Schryer, Framework for   SLAP........685800
C                 a portable library, ACM Transactions on Mathematical   SLAP........685900
C                 Software 4, 2 (June 1978), pp. 177-188.                SLAP........686000
C***ROUTINES CALLED  (NONE)                                              SLAP........686100
C***REVISION HISTORY  (YYMMDD)                                           SLAP........686200
C   750101  DATE WRITTEN                                                 SLAP........686300
C   891012  Added VAX G-floating constants.  (WRB)                       SLAP........686400
C   891012  REVISION DATE from Version 3.2                               SLAP........686500
C   891214  Prologue converted to Version 4.0 format.  (BAB)             SLAP........686600
C   900618  Added DEC RISC constants.  (WRB)                             SLAP........686700
C   900723  Added IBM RS 6000 constants.  (WRB)                          SLAP........686800
C   901009  Correct I1MACH(7) for IBM Mainframes. Should be 2 not 16.    SLAP........686900
C           (RWC)                                                        SLAP........687000
C   910710  Added HP 730 constants.  (SMR)                               SLAP........687100
C   911114  Added Convex IEEE constants.  (WRB)                          SLAP........687200
C   920121  Added SUN -r8 compiler option constants.  (WRB)              SLAP........687300
C   920229  Added Touchstone Delta i860 constants.  (WRB)                SLAP........687400
C   920501  Reformatted the REFERENCES section.  (WRB)                   SLAP........687500
C   920625  Added Convex -p8 and -pd8 compiler option constants.         SLAP........687600
C           (BKS, WRB)                                                   SLAP........687700
C   930201  Added DEC Alpha and SGI constants.  (RWC and WRB)            SLAP........687800
C   930618  Corrected I1MACH(5) for Convex -p8 and -pd8 compiler         SLAP........687900
C           options.  (DWL, RWC and WRB).                                SLAP........688000
C***END PROLOGUE  I1MACH                                                 SLAP........688100
C                                                                        SLAP........688200
      INTEGER IMACH(16),OUTPUT                                           SLAP........688300
      SAVE IMACH                                                         SLAP........688400
      EQUIVALENCE (IMACH(4),OUTPUT)                                      SLAP........688500
C                                                                        SLAP........688600
C     MACHINE CONSTANTS FOR THE AMIGA                                    SLAP........688700
C     ABSOFT COMPILER                                                    SLAP........688800
C                                                                        SLAP........688900
C     DATA IMACH( 1) /          5 /                                      SLAP........689000
C     DATA IMACH( 2) /          6 /                                      SLAP........689100
C     DATA IMACH( 3) /          5 /                                      SLAP........689200
C     DATA IMACH( 4) /          6 /                                      SLAP........689300
C     DATA IMACH( 5) /         32 /                                      SLAP........689400
C     DATA IMACH( 6) /          4 /                                      SLAP........689500
C     DATA IMACH( 7) /          2 /                                      SLAP........689600
C     DATA IMACH( 8) /         31 /                                      SLAP........689700
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........689800
C     DATA IMACH(10) /          2 /                                      SLAP........689900
C     DATA IMACH(11) /         24 /                                      SLAP........690000
C     DATA IMACH(12) /       -126 /                                      SLAP........690100
C     DATA IMACH(13) /        127 /                                      SLAP........690200
C     DATA IMACH(14) /         53 /                                      SLAP........690300
C     DATA IMACH(15) /      -1022 /                                      SLAP........690400
C     DATA IMACH(16) /       1023 /                                      SLAP........690500
C                                                                        SLAP........690600
C     MACHINE CONSTANTS FOR THE APOLLO                                   SLAP........690700
C                                                                        SLAP........690800
C     DATA IMACH( 1) /          5 /                                      SLAP........690900
C     DATA IMACH( 2) /          6 /                                      SLAP........691000
C     DATA IMACH( 3) /          6 /                                      SLAP........691100
C     DATA IMACH( 4) /          6 /                                      SLAP........691200
C     DATA IMACH( 5) /         32 /                                      SLAP........691300
C     DATA IMACH( 6) /          4 /                                      SLAP........691400
C     DATA IMACH( 7) /          2 /                                      SLAP........691500
C     DATA IMACH( 8) /         31 /                                      SLAP........691600
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........691700
C     DATA IMACH(10) /          2 /                                      SLAP........691800
C     DATA IMACH(11) /         24 /                                      SLAP........691900
C     DATA IMACH(12) /       -125 /                                      SLAP........692000
C     DATA IMACH(13) /        129 /                                      SLAP........692100
C     DATA IMACH(14) /         53 /                                      SLAP........692200
C     DATA IMACH(15) /      -1021 /                                      SLAP........692300
C     DATA IMACH(16) /       1025 /                                      SLAP........692400
C                                                                        SLAP........692500
C     MACHINE CONSTANTS FOR THE BURROUGHS 1700 SYSTEM                    SLAP........692600
C                                                                        SLAP........692700
C     DATA IMACH( 1) /          7 /                                      SLAP........692800
C     DATA IMACH( 2) /          2 /                                      SLAP........692900
C     DATA IMACH( 3) /          2 /                                      SLAP........693000
C     DATA IMACH( 4) /          2 /                                      SLAP........693100
C     DATA IMACH( 5) /         36 /                                      SLAP........693200
C     DATA IMACH( 6) /          4 /                                      SLAP........693300
C     DATA IMACH( 7) /          2 /                                      SLAP........693400
C     DATA IMACH( 8) /         33 /                                      SLAP........693500
C     DATA IMACH( 9) / Z1FFFFFFFF /                                      SLAP........693600
C     DATA IMACH(10) /          2 /                                      SLAP........693700
C     DATA IMACH(11) /         24 /                                      SLAP........693800
C     DATA IMACH(12) /       -256 /                                      SLAP........693900
C     DATA IMACH(13) /        255 /                                      SLAP........694000
C     DATA IMACH(14) /         60 /                                      SLAP........694100
C     DATA IMACH(15) /       -256 /                                      SLAP........694200
C     DATA IMACH(16) /        255 /                                      SLAP........694300
C                                                                        SLAP........694400
C     MACHINE CONSTANTS FOR THE BURROUGHS 5700 SYSTEM                    SLAP........694500
C                                                                        SLAP........694600
C     DATA IMACH( 1) /          5 /                                      SLAP........694700
C     DATA IMACH( 2) /          6 /                                      SLAP........694800
C     DATA IMACH( 3) /          7 /                                      SLAP........694900
C     DATA IMACH( 4) /          6 /                                      SLAP........695000
C     DATA IMACH( 5) /         48 /                                      SLAP........695100
C     DATA IMACH( 6) /          6 /                                      SLAP........695200
C     DATA IMACH( 7) /          2 /                                      SLAP........695300
C     DATA IMACH( 8) /         39 /                                      SLAP........695400
C     DATA IMACH( 9) / O0007777777777777 /                               SLAP........695500
C     DATA IMACH(10) /          8 /                                      SLAP........695600
C     DATA IMACH(11) /         13 /                                      SLAP........695700
C     DATA IMACH(12) /        -50 /                                      SLAP........695800
C     DATA IMACH(13) /         76 /                                      SLAP........695900
C     DATA IMACH(14) /         26 /                                      SLAP........696000
C     DATA IMACH(15) /        -50 /                                      SLAP........696100
C     DATA IMACH(16) /         76 /                                      SLAP........696200
C                                                                        SLAP........696300
C     MACHINE CONSTANTS FOR THE BURROUGHS 6700/7700 SYSTEMS              SLAP........696400
C                                                                        SLAP........696500
C     DATA IMACH( 1) /          5 /                                      SLAP........696600
C     DATA IMACH( 2) /          6 /                                      SLAP........696700
C     DATA IMACH( 3) /          7 /                                      SLAP........696800
C     DATA IMACH( 4) /          6 /                                      SLAP........696900
C     DATA IMACH( 5) /         48 /                                      SLAP........697000
C     DATA IMACH( 6) /          6 /                                      SLAP........697100
C     DATA IMACH( 7) /          2 /                                      SLAP........697200
C     DATA IMACH( 8) /         39 /                                      SLAP........697300
C     DATA IMACH( 9) / O0007777777777777 /                               SLAP........697400
C     DATA IMACH(10) /          8 /                                      SLAP........697500
C     DATA IMACH(11) /         13 /                                      SLAP........697600
C     DATA IMACH(12) /        -50 /                                      SLAP........697700
C     DATA IMACH(13) /         76 /                                      SLAP........697800
C     DATA IMACH(14) /         26 /                                      SLAP........697900
C     DATA IMACH(15) /     -32754 /                                      SLAP........698000
C     DATA IMACH(16) /      32780 /                                      SLAP........698100
C                                                                        SLAP........698200
C     MACHINE CONSTANTS FOR THE CDC 170/180 SERIES USING NOS/VE          SLAP........698300
C                                                                        SLAP........698400
C     DATA IMACH( 1) /          5 /                                      SLAP........698500
C     DATA IMACH( 2) /          6 /                                      SLAP........698600
C     DATA IMACH( 3) /          7 /                                      SLAP........698700
C     DATA IMACH( 4) /          6 /                                      SLAP........698800
C     DATA IMACH( 5) /         64 /                                      SLAP........698900
C     DATA IMACH( 6) /          8 /                                      SLAP........699000
C     DATA IMACH( 7) /          2 /                                      SLAP........699100
C     DATA IMACH( 8) /         63 /                                      SLAP........699200
C     DATA IMACH( 9) / 9223372036854775807 /                             SLAP........699300
C     DATA IMACH(10) /          2 /                                      SLAP........699400
C     DATA IMACH(11) /         47 /                                      SLAP........699500
C     DATA IMACH(12) /      -4095 /                                      SLAP........699600
C     DATA IMACH(13) /       4094 /                                      SLAP........699700
C     DATA IMACH(14) /         94 /                                      SLAP........699800
C     DATA IMACH(15) /      -4095 /                                      SLAP........699900
C     DATA IMACH(16) /       4094 /                                      SLAP........700000
C                                                                        SLAP........700100
C     MACHINE CONSTANTS FOR THE CDC 6000/7000 SERIES                     SLAP........700200
C                                                                        SLAP........700300
C     DATA IMACH( 1) /          5 /                                      SLAP........700400
C     DATA IMACH( 2) /          6 /                                      SLAP........700500
C     DATA IMACH( 3) /          7 /                                      SLAP........700600
C     DATA IMACH( 4) /    6LOUTPUT/                                      SLAP........700700
C     DATA IMACH( 5) /         60 /                                      SLAP........700800
C     DATA IMACH( 6) /         10 /                                      SLAP........700900
C     DATA IMACH( 7) /          2 /                                      SLAP........701000
C     DATA IMACH( 8) /         48 /                                      SLAP........701100
C     DATA IMACH( 9) / 00007777777777777777B /                           SLAP........701200
C     DATA IMACH(10) /          2 /                                      SLAP........701300
C     DATA IMACH(11) /         47 /                                      SLAP........701400
C     DATA IMACH(12) /       -929 /                                      SLAP........701500
C     DATA IMACH(13) /       1070 /                                      SLAP........701600
C     DATA IMACH(14) /         94 /                                      SLAP........701700
C     DATA IMACH(15) /       -929 /                                      SLAP........701800
C     DATA IMACH(16) /       1069 /                                      SLAP........701900
C                                                                        SLAP........702000
C     MACHINE CONSTANTS FOR THE CELERITY C1260                           SLAP........702100
C                                                                        SLAP........702200
C     DATA IMACH( 1) /          5 /                                      SLAP........702300
C     DATA IMACH( 2) /          6 /                                      SLAP........702400
C     DATA IMACH( 3) /          6 /                                      SLAP........702500
C     DATA IMACH( 4) /          0 /                                      SLAP........702600
C     DATA IMACH( 5) /         32 /                                      SLAP........702700
C     DATA IMACH( 6) /          4 /                                      SLAP........702800
C     DATA IMACH( 7) /          2 /                                      SLAP........702900
C     DATA IMACH( 8) /         31 /                                      SLAP........703000
C     DATA IMACH( 9) / Z'7FFFFFFF' /                                     SLAP........703100
C     DATA IMACH(10) /          2 /                                      SLAP........703200
C     DATA IMACH(11) /         24 /                                      SLAP........703300
C     DATA IMACH(12) /       -126 /                                      SLAP........703400
C     DATA IMACH(13) /        127 /                                      SLAP........703500
C     DATA IMACH(14) /         53 /                                      SLAP........703600
C     DATA IMACH(15) /      -1022 /                                      SLAP........703700
C     DATA IMACH(16) /       1023 /                                      SLAP........703800
C                                                                        SLAP........703900
C     MACHINE CONSTANTS FOR THE CONVEX                                   SLAP........704000
C     USING THE -fn COMPILER OPTION                                      SLAP........704100
C                                                                        SLAP........704200
C     DATA IMACH( 1) /          5 /                                      SLAP........704300
C     DATA IMACH( 2) /          6 /                                      SLAP........704400
C     DATA IMACH( 3) /          7 /                                      SLAP........704500
C     DATA IMACH( 4) /          6 /                                      SLAP........704600
C     DATA IMACH( 5) /         32 /                                      SLAP........704700
C     DATA IMACH( 6) /          4 /                                      SLAP........704800
C     DATA IMACH( 7) /          2 /                                      SLAP........704900
C     DATA IMACH( 8) /         31 /                                      SLAP........705000
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........705100
C     DATA IMACH(10) /          2 /                                      SLAP........705200
C     DATA IMACH(11) /         24 /                                      SLAP........705300
C     DATA IMACH(12) /       -127 /                                      SLAP........705400
C     DATA IMACH(13) /        127 /                                      SLAP........705500
C     DATA IMACH(14) /         53 /                                      SLAP........705600
C     DATA IMACH(15) /      -1023 /                                      SLAP........705700
C     DATA IMACH(16) /       1023 /                                      SLAP........705800
C                                                                        SLAP........705900
C     MACHINE CONSTANTS FOR THE CONVEX                                   SLAP........706000
C     USING THE -fi COMPILER OPTION                                      SLAP........706100
C                                                                        SLAP........706200
C     DATA IMACH( 1) /          5 /                                      SLAP........706300
C     DATA IMACH( 2) /          6 /                                      SLAP........706400
C     DATA IMACH( 3) /          7 /                                      SLAP........706500
C     DATA IMACH( 4) /          6 /                                      SLAP........706600
C     DATA IMACH( 5) /         32 /                                      SLAP........706700
C     DATA IMACH( 6) /          4 /                                      SLAP........706800
C     DATA IMACH( 7) /          2 /                                      SLAP........706900
C     DATA IMACH( 8) /         31 /                                      SLAP........707000
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........707100
C     DATA IMACH(10) /          2 /                                      SLAP........707200
C     DATA IMACH(11) /         24 /                                      SLAP........707300
C     DATA IMACH(12) /       -125 /                                      SLAP........707400
C     DATA IMACH(13) /        128 /                                      SLAP........707500
C     DATA IMACH(14) /         53 /                                      SLAP........707600
C     DATA IMACH(15) /      -1021 /                                      SLAP........707700
C     DATA IMACH(16) /       1024 /                                      SLAP........707800
C                                                                        SLAP........707900
C     MACHINE CONSTANTS FOR THE CONVEX                                   SLAP........708000
C     USING THE -p8 COMPILER OPTION                                      SLAP........708100
C                                                                        SLAP........708200
C     DATA IMACH( 1) /          5 /                                      SLAP........708300
C     DATA IMACH( 2) /          6 /                                      SLAP........708400
C     DATA IMACH( 3) /          7 /                                      SLAP........708500
C     DATA IMACH( 4) /          6 /                                      SLAP........708600
C     DATA IMACH( 5) /         64 /                                      SLAP........708700
C     DATA IMACH( 6) /          4 /                                      SLAP........708800
C     DATA IMACH( 7) /          2 /                                      SLAP........708900
C     DATA IMACH( 8) /         63 /                                      SLAP........709000
C     DATA IMACH( 9) / 9223372036854775807 /                             SLAP........709100
C     DATA IMACH(10) /          2 /                                      SLAP........709200
C     DATA IMACH(11) /         53 /                                      SLAP........709300
C     DATA IMACH(12) /      -1023 /                                      SLAP........709400
C     DATA IMACH(13) /       1023 /                                      SLAP........709500
C     DATA IMACH(14) /        113 /                                      SLAP........709600
C     DATA IMACH(15) /     -16383 /                                      SLAP........709700
C     DATA IMACH(16) /      16383 /                                      SLAP........709800
C                                                                        SLAP........709900
C     MACHINE CONSTANTS FOR THE CONVEX                                   SLAP........710000
C     USING THE -pd8 COMPILER OPTION                                     SLAP........710100
C                                                                        SLAP........710200
C     DATA IMACH( 1) /          5 /                                      SLAP........710300
C     DATA IMACH( 2) /          6 /                                      SLAP........710400
C     DATA IMACH( 3) /          7 /                                      SLAP........710500
C     DATA IMACH( 4) /          6 /                                      SLAP........710600
C     DATA IMACH( 5) /         64 /                                      SLAP........710700
C     DATA IMACH( 6) /          4 /                                      SLAP........710800
C     DATA IMACH( 7) /          2 /                                      SLAP........710900
C     DATA IMACH( 8) /         63 /                                      SLAP........711000
C     DATA IMACH( 9) / 9223372036854775807 /                             SLAP........711100
C     DATA IMACH(10) /          2 /                                      SLAP........711200
C     DATA IMACH(11) /         53 /                                      SLAP........711300
C     DATA IMACH(12) /      -1023 /                                      SLAP........711400
C     DATA IMACH(13) /       1023 /                                      SLAP........711500
C     DATA IMACH(14) /         53 /                                      SLAP........711600
C     DATA IMACH(15) /      -1023 /                                      SLAP........711700
C     DATA IMACH(16) /       1023 /                                      SLAP........711800
C                                                                        SLAP........711900
C     MACHINE CONSTANTS FOR THE CRAY                                     SLAP........712000
C     USING THE 46 BIT INTEGER COMPILER OPTION                           SLAP........712100
C                                                                        SLAP........712200
C     DATA IMACH( 1) /        100 /                                      SLAP........712300
C     DATA IMACH( 2) /        101 /                                      SLAP........712400
C     DATA IMACH( 3) /        102 /                                      SLAP........712500
C     DATA IMACH( 4) /        101 /                                      SLAP........712600
C     DATA IMACH( 5) /         64 /                                      SLAP........712700
C     DATA IMACH( 6) /          8 /                                      SLAP........712800
C     DATA IMACH( 7) /          2 /                                      SLAP........712900
C     DATA IMACH( 8) /         46 /                                      SLAP........713000
C     DATA IMACH( 9) / 1777777777777777B /                               SLAP........713100
C     DATA IMACH(10) /          2 /                                      SLAP........713200
C     DATA IMACH(11) /         47 /                                      SLAP........713300
C     DATA IMACH(12) /      -8189 /                                      SLAP........713400
C     DATA IMACH(13) /       8190 /                                      SLAP........713500
C     DATA IMACH(14) /         94 /                                      SLAP........713600
C     DATA IMACH(15) /      -8099 /                                      SLAP........713700
C     DATA IMACH(16) /       8190 /                                      SLAP........713800
C                                                                        SLAP........713900
C     MACHINE CONSTANTS FOR THE CRAY                                     SLAP........714000
C     USING THE 64 BIT INTEGER COMPILER OPTION                           SLAP........714100
C                                                                        SLAP........714200
C     DATA IMACH( 1) /        100 /                                      SLAP........714300
C     DATA IMACH( 2) /        101 /                                      SLAP........714400
C     DATA IMACH( 3) /        102 /                                      SLAP........714500
C     DATA IMACH( 4) /        101 /                                      SLAP........714600
C     DATA IMACH( 5) /         64 /                                      SLAP........714700
C     DATA IMACH( 6) /          8 /                                      SLAP........714800
C     DATA IMACH( 7) /          2 /                                      SLAP........714900
C     DATA IMACH( 8) /         63 /                                      SLAP........715000
C     DATA IMACH( 9) / 777777777777777777777B /                          SLAP........715100
C     DATA IMACH(10) /          2 /                                      SLAP........715200
C     DATA IMACH(11) /         47 /                                      SLAP........715300
C     DATA IMACH(12) /      -8189 /                                      SLAP........715400
C     DATA IMACH(13) /       8190 /                                      SLAP........715500
C     DATA IMACH(14) /         94 /                                      SLAP........715600
C     DATA IMACH(15) /      -8099 /                                      SLAP........715700
C     DATA IMACH(16) /       8190 /                                      SLAP........715800
C                                                                        SLAP........715900
C     MACHINE CONSTANTS FOR THE DATA GENERAL ECLIPSE S/200               SLAP........716000
C                                                                        SLAP........716100
C     DATA IMACH( 1) /         11 /                                      SLAP........716200
C     DATA IMACH( 2) /         12 /                                      SLAP........716300
C     DATA IMACH( 3) /          8 /                                      SLAP........716400
C     DATA IMACH( 4) /         10 /                                      SLAP........716500
C     DATA IMACH( 5) /         16 /                                      SLAP........716600
C     DATA IMACH( 6) /          2 /                                      SLAP........716700
C     DATA IMACH( 7) /          2 /                                      SLAP........716800
C     DATA IMACH( 8) /         15 /                                      SLAP........716900
C     DATA IMACH( 9) /      32767 /                                      SLAP........717000
C     DATA IMACH(10) /         16 /                                      SLAP........717100
C     DATA IMACH(11) /          6 /                                      SLAP........717200
C     DATA IMACH(12) /        -64 /                                      SLAP........717300
C     DATA IMACH(13) /         63 /                                      SLAP........717400
C     DATA IMACH(14) /         14 /                                      SLAP........717500
C     DATA IMACH(15) /        -64 /                                      SLAP........717600
C     DATA IMACH(16) /         63 /                                      SLAP........717700
C                                                                        SLAP........717800
C     MACHINE CONSTANTS FOR THE DEC ALPHA                                SLAP........717900
C     USING G_FLOAT                                                      SLAP........718000
C                                                                        SLAP........718100
C     DATA IMACH( 1) /          5 /                                      SLAP........718200
C     DATA IMACH( 2) /          6 /                                      SLAP........718300
C     DATA IMACH( 3) /          5 /                                      SLAP........718400
C     DATA IMACH( 4) /          6 /                                      SLAP........718500
C     DATA IMACH( 5) /         32 /                                      SLAP........718600
C     DATA IMACH( 6) /          4 /                                      SLAP........718700
C     DATA IMACH( 7) /          2 /                                      SLAP........718800
C     DATA IMACH( 8) /         31 /                                      SLAP........718900
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........719000
C     DATA IMACH(10) /          2 /                                      SLAP........719100
C     DATA IMACH(11) /         24 /                                      SLAP........719200
C     DATA IMACH(12) /       -127 /                                      SLAP........719300
C     DATA IMACH(13) /        127 /                                      SLAP........719400
C     DATA IMACH(14) /         53 /                                      SLAP........719500
C     DATA IMACH(15) /      -1023 /                                      SLAP........719600
C     DATA IMACH(16) /       1023 /                                      SLAP........719700
C                                                                        SLAP........719800
C     MACHINE CONSTANTS FOR THE DEC ALPHA                                SLAP........719900
C     USING IEEE_FLOAT                                                   SLAP........720000
C                                                                        SLAP........720100
C     DATA IMACH( 1) /          5 /                                      SLAP........720200
C     DATA IMACH( 2) /          6 /                                      SLAP........720300
C     DATA IMACH( 3) /          6 /                                      SLAP........720400
C     DATA IMACH( 4) /          6 /                                      SLAP........720500
C     DATA IMACH( 5) /         32 /                                      SLAP........720600
C     DATA IMACH( 6) /          4 /                                      SLAP........720700
C     DATA IMACH( 7) /          2 /                                      SLAP........720800
C     DATA IMACH( 8) /         31 /                                      SLAP........720900
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........721000
C     DATA IMACH(10) /          2 /                                      SLAP........721100
C     DATA IMACH(11) /         24 /                                      SLAP........721200
C     DATA IMACH(12) /       -125 /                                      SLAP........721300
C     DATA IMACH(13) /        128 /                                      SLAP........721400
C     DATA IMACH(14) /         53 /                                      SLAP........721500
C     DATA IMACH(15) /      -1021 /                                      SLAP........721600
C     DATA IMACH(16) /       1024 /                                      SLAP........721700
C                                                                        SLAP........721800
C     MACHINE CONSTANTS FOR THE DEC RISC                                 SLAP........721900
C                                                                        SLAP........722000
C     DATA IMACH( 1) /          5 /                                      SLAP........722100
C     DATA IMACH( 2) /          6 /                                      SLAP........722200
C     DATA IMACH( 3) /          6 /                                      SLAP........722300
C     DATA IMACH( 4) /          6 /                                      SLAP........722400
C     DATA IMACH( 5) /         32 /                                      SLAP........722500
C     DATA IMACH( 6) /          4 /                                      SLAP........722600
C     DATA IMACH( 7) /          2 /                                      SLAP........722700
C     DATA IMACH( 8) /         31 /                                      SLAP........722800
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........722900
C     DATA IMACH(10) /          2 /                                      SLAP........723000
C     DATA IMACH(11) /         24 /                                      SLAP........723100
C     DATA IMACH(12) /       -125 /                                      SLAP........723200
C     DATA IMACH(13) /        128 /                                      SLAP........723300
C     DATA IMACH(14) /         53 /                                      SLAP........723400
C     DATA IMACH(15) /      -1021 /                                      SLAP........723500
C     DATA IMACH(16) /       1024 /                                      SLAP........723600
C                                                                        SLAP........723700
C     MACHINE CONSTANTS FOR THE DEC VAX                                  SLAP........723800
C     USING D_FLOATING                                                   SLAP........723900
C                                                                        SLAP........724000
C     DATA IMACH( 1) /          5 /                                      SLAP........724100
C     DATA IMACH( 2) /          6 /                                      SLAP........724200
C     DATA IMACH( 3) /          5 /                                      SLAP........724300
C     DATA IMACH( 4) /          6 /                                      SLAP........724400
C     DATA IMACH( 5) /         32 /                                      SLAP........724500
C     DATA IMACH( 6) /          4 /                                      SLAP........724600
C     DATA IMACH( 7) /          2 /                                      SLAP........724700
C     DATA IMACH( 8) /         31 /                                      SLAP........724800
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........724900
C     DATA IMACH(10) /          2 /                                      SLAP........725000
C     DATA IMACH(11) /         24 /                                      SLAP........725100
C     DATA IMACH(12) /       -127 /                                      SLAP........725200
C     DATA IMACH(13) /        127 /                                      SLAP........725300
C     DATA IMACH(14) /         56 /                                      SLAP........725400
C     DATA IMACH(15) /       -127 /                                      SLAP........725500
C     DATA IMACH(16) /        127 /                                      SLAP........725600
C                                                                        SLAP........725700
C     MACHINE CONSTANTS FOR THE DEC VAX                                  SLAP........725800
C     USING G_FLOATING                                                   SLAP........725900
C                                                                        SLAP........726000
C     DATA IMACH( 1) /          5 /                                      SLAP........726100
C     DATA IMACH( 2) /          6 /                                      SLAP........726200
C     DATA IMACH( 3) /          5 /                                      SLAP........726300
C     DATA IMACH( 4) /          6 /                                      SLAP........726400
C     DATA IMACH( 5) /         32 /                                      SLAP........726500
C     DATA IMACH( 6) /          4 /                                      SLAP........726600
C     DATA IMACH( 7) /          2 /                                      SLAP........726700
C     DATA IMACH( 8) /         31 /                                      SLAP........726800
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........726900
C     DATA IMACH(10) /          2 /                                      SLAP........727000
C     DATA IMACH(11) /         24 /                                      SLAP........727100
C     DATA IMACH(12) /       -127 /                                      SLAP........727200
C     DATA IMACH(13) /        127 /                                      SLAP........727300
C     DATA IMACH(14) /         53 /                                      SLAP........727400
C     DATA IMACH(15) /      -1023 /                                      SLAP........727500
C     DATA IMACH(16) /       1023 /                                      SLAP........727600
C                                                                        SLAP........727700
C     MACHINE CONSTANTS FOR THE ELXSI 6400                               SLAP........727800
C                                                                        SLAP........727900
C     DATA IMACH( 1) /          5 /                                      SLAP........728000
C     DATA IMACH( 2) /          6 /                                      SLAP........728100
C     DATA IMACH( 3) /          6 /                                      SLAP........728200
C     DATA IMACH( 4) /          6 /                                      SLAP........728300
C     DATA IMACH( 5) /         32 /                                      SLAP........728400
C     DATA IMACH( 6) /          4 /                                      SLAP........728500
C     DATA IMACH( 7) /          2 /                                      SLAP........728600
C     DATA IMACH( 8) /         32 /                                      SLAP........728700
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........728800
C     DATA IMACH(10) /          2 /                                      SLAP........728900
C     DATA IMACH(11) /         24 /                                      SLAP........729000
C     DATA IMACH(12) /       -126 /                                      SLAP........729100
C     DATA IMACH(13) /        127 /                                      SLAP........729200
C     DATA IMACH(14) /         53 /                                      SLAP........729300
C     DATA IMACH(15) /      -1022 /                                      SLAP........729400
C     DATA IMACH(16) /       1023 /                                      SLAP........729500
C                                                                        SLAP........729600
C     MACHINE CONSTANTS FOR THE HARRIS 220                               SLAP........729700
C                                                                        SLAP........729800
C     DATA IMACH( 1) /          5 /                                      SLAP........729900
C     DATA IMACH( 2) /          6 /                                      SLAP........730000
C     DATA IMACH( 3) /          0 /                                      SLAP........730100
C     DATA IMACH( 4) /          6 /                                      SLAP........730200
C     DATA IMACH( 5) /         24 /                                      SLAP........730300
C     DATA IMACH( 6) /          3 /                                      SLAP........730400
C     DATA IMACH( 7) /          2 /                                      SLAP........730500
C     DATA IMACH( 8) /         23 /                                      SLAP........730600
C     DATA IMACH( 9) /    8388607 /                                      SLAP........730700
C     DATA IMACH(10) /          2 /                                      SLAP........730800
C     DATA IMACH(11) /         23 /                                      SLAP........730900
C     DATA IMACH(12) /       -127 /                                      SLAP........731000
C     DATA IMACH(13) /        127 /                                      SLAP........731100
C     DATA IMACH(14) /         38 /                                      SLAP........731200
C     DATA IMACH(15) /       -127 /                                      SLAP........731300
C     DATA IMACH(16) /        127 /                                      SLAP........731400
C                                                                        SLAP........731500
C     MACHINE CONSTANTS FOR THE HONEYWELL 600/6000 SERIES                SLAP........731600
C                                                                        SLAP........731700
C     DATA IMACH( 1) /          5 /                                      SLAP........731800
C     DATA IMACH( 2) /          6 /                                      SLAP........731900
C     DATA IMACH( 3) /         43 /                                      SLAP........732000
C     DATA IMACH( 4) /          6 /                                      SLAP........732100
C     DATA IMACH( 5) /         36 /                                      SLAP........732200
C     DATA IMACH( 6) /          6 /                                      SLAP........732300
C     DATA IMACH( 7) /          2 /                                      SLAP........732400
C     DATA IMACH( 8) /         35 /                                      SLAP........732500
C     DATA IMACH( 9) / O377777777777 /                                   SLAP........732600
C     DATA IMACH(10) /          2 /                                      SLAP........732700
C     DATA IMACH(11) /         27 /                                      SLAP........732800
C     DATA IMACH(12) /       -127 /                                      SLAP........732900
C     DATA IMACH(13) /        127 /                                      SLAP........733000
C     DATA IMACH(14) /         63 /                                      SLAP........733100
C     DATA IMACH(15) /       -127 /                                      SLAP........733200
C     DATA IMACH(16) /        127 /                                      SLAP........733300
C                                                                        SLAP........733400
C     MACHINE CONSTANTS FOR THE HP 730                                   SLAP........733500
C                                                                        SLAP........733600
C     DATA IMACH( 1) /          5 /                                      SLAP........733700
C     DATA IMACH( 2) /          6 /                                      SLAP........733800
C     DATA IMACH( 3) /          6 /                                      SLAP........733900
C     DATA IMACH( 4) /          6 /                                      SLAP........734000
C     DATA IMACH( 5) /         32 /                                      SLAP........734100
C     DATA IMACH( 6) /          4 /                                      SLAP........734200
C     DATA IMACH( 7) /          2 /                                      SLAP........734300
C     DATA IMACH( 8) /         31 /                                      SLAP........734400
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........734500
C     DATA IMACH(10) /          2 /                                      SLAP........734600
C     DATA IMACH(11) /         24 /                                      SLAP........734700
C     DATA IMACH(12) /       -125 /                                      SLAP........734800
C     DATA IMACH(13) /        128 /                                      SLAP........734900
C     DATA IMACH(14) /         53 /                                      SLAP........735000
C     DATA IMACH(15) /      -1021 /                                      SLAP........735100
C     DATA IMACH(16) /       1024 /                                      SLAP........735200
C                                                                        SLAP........735300
C     MACHINE CONSTANTS FOR THE HP 2100                                  SLAP........735400
C     3 WORD DOUBLE PRECISION OPTION WITH FTN4                           SLAP........735500
C                                                                        SLAP........735600
C     DATA IMACH( 1) /          5 /                                      SLAP........735700
C     DATA IMACH( 2) /          6 /                                      SLAP........735800
C     DATA IMACH( 3) /          4 /                                      SLAP........735900
C     DATA IMACH( 4) /          1 /                                      SLAP........736000
C     DATA IMACH( 5) /         16 /                                      SLAP........736100
C     DATA IMACH( 6) /          2 /                                      SLAP........736200
C     DATA IMACH( 7) /          2 /                                      SLAP........736300
C     DATA IMACH( 8) /         15 /                                      SLAP........736400
C     DATA IMACH( 9) /      32767 /                                      SLAP........736500
C     DATA IMACH(10) /          2 /                                      SLAP........736600
C     DATA IMACH(11) /         23 /                                      SLAP........736700
C     DATA IMACH(12) /       -128 /                                      SLAP........736800
C     DATA IMACH(13) /        127 /                                      SLAP........736900
C     DATA IMACH(14) /         39 /                                      SLAP........737000
C     DATA IMACH(15) /       -128 /                                      SLAP........737100
C     DATA IMACH(16) /        127 /                                      SLAP........737200
C                                                                        SLAP........737300
C     MACHINE CONSTANTS FOR THE HP 2100                                  SLAP........737400
C     4 WORD DOUBLE PRECISION OPTION WITH FTN4                           SLAP........737500
C                                                                        SLAP........737600
C     DATA IMACH( 1) /          5 /                                      SLAP........737700
C     DATA IMACH( 2) /          6 /                                      SLAP........737800
C     DATA IMACH( 3) /          4 /                                      SLAP........737900
C     DATA IMACH( 4) /          1 /                                      SLAP........738000
C     DATA IMACH( 5) /         16 /                                      SLAP........738100
C     DATA IMACH( 6) /          2 /                                      SLAP........738200
C     DATA IMACH( 7) /          2 /                                      SLAP........738300
C     DATA IMACH( 8) /         15 /                                      SLAP........738400
C     DATA IMACH( 9) /      32767 /                                      SLAP........738500
C     DATA IMACH(10) /          2 /                                      SLAP........738600
C     DATA IMACH(11) /         23 /                                      SLAP........738700
C     DATA IMACH(12) /       -128 /                                      SLAP........738800
C     DATA IMACH(13) /        127 /                                      SLAP........738900
C     DATA IMACH(14) /         55 /                                      SLAP........739000
C     DATA IMACH(15) /       -128 /                                      SLAP........739100
C     DATA IMACH(16) /        127 /                                      SLAP........739200
C                                                                        SLAP........739300
C     MACHINE CONSTANTS FOR THE HP 9000                                  SLAP........739400
C                                                                        SLAP........739500
C     DATA IMACH( 1) /          5 /                                      SLAP........739600
C     DATA IMACH( 2) /          6 /                                      SLAP........739700
C     DATA IMACH( 3) /          6 /                                      SLAP........739800
C     DATA IMACH( 4) /          7 /                                      SLAP........739900
C     DATA IMACH( 5) /         32 /                                      SLAP........740000
C     DATA IMACH( 6) /          4 /                                      SLAP........740100
C     DATA IMACH( 7) /          2 /                                      SLAP........740200
C     DATA IMACH( 8) /         32 /                                      SLAP........740300
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........740400
C     DATA IMACH(10) /          2 /                                      SLAP........740500
C     DATA IMACH(11) /         24 /                                      SLAP........740600
C     DATA IMACH(12) /       -126 /                                      SLAP........740700
C     DATA IMACH(13) /        127 /                                      SLAP........740800
C     DATA IMACH(14) /         53 /                                      SLAP........740900
C     DATA IMACH(15) /      -1015 /                                      SLAP........741000
C     DATA IMACH(16) /       1017 /                                      SLAP........741100
C                                                                        SLAP........741200
C     MACHINE CONSTANTS FOR THE IBM 360/370 SERIES,                      SLAP........741300
C     THE XEROX SIGMA 5/7/9, THE SEL SYSTEMS 85/86, AND                  SLAP........741400
C     THE PERKIN ELMER (INTERDATA) 7/32.                                 SLAP........741500
C                                                                        SLAP........741600
C     DATA IMACH( 1) /          5 /                                      SLAP........741700
C     DATA IMACH( 2) /          6 /                                      SLAP........741800
C     DATA IMACH( 3) /          7 /                                      SLAP........741900
C     DATA IMACH( 4) /          6 /                                      SLAP........742000
C     DATA IMACH( 5) /         32 /                                      SLAP........742100
C     DATA IMACH( 6) /          4 /                                      SLAP........742200
C     DATA IMACH( 7) /          2 /                                      SLAP........742300
C     DATA IMACH( 8) /         31 /                                      SLAP........742400
C     DATA IMACH( 9) /  Z7FFFFFFF /                                      SLAP........742500
C     DATA IMACH(10) /         16 /                                      SLAP........742600
C     DATA IMACH(11) /          6 /                                      SLAP........742700
C     DATA IMACH(12) /        -64 /                                      SLAP........742800
C     DATA IMACH(13) /         63 /                                      SLAP........742900
C     DATA IMACH(14) /         14 /                                      SLAP........743000
C     DATA IMACH(15) /        -64 /                                      SLAP........743100
C     DATA IMACH(16) /         63 /                                      SLAP........743200
C                                                                        SLAP........743300
C     MACHINE CONSTANTS FOR THE IBM PC                                   SLAP........743400
C                                                                        SLAP........743500
C     DATA IMACH( 1) /          5 /                                      SLAP........743600
C     DATA IMACH( 2) /          6 /                                      SLAP........743700
C     DATA IMACH( 3) /          0 /                                      SLAP........743800
C     DATA IMACH( 4) /          0 /                                      SLAP........743900
C     DATA IMACH( 5) /         32 /                                      SLAP........744000
C     DATA IMACH( 6) /          4 /                                      SLAP........744100
C     DATA IMACH( 7) /          2 /                                      SLAP........744200
C     DATA IMACH( 8) /         31 /                                      SLAP........744300
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........744400
C     DATA IMACH(10) /          2 /                                      SLAP........744500
C     DATA IMACH(11) /         24 /                                      SLAP........744600
C     DATA IMACH(12) /       -125 /                                      SLAP........744700
C     DATA IMACH(13) /        127 /                                      SLAP........744800
C     DATA IMACH(14) /         53 /                                      SLAP........744900
C     DATA IMACH(15) /      -1021 /                                      SLAP........745000
C     DATA IMACH(16) /       1023 /                                      SLAP........745100
C                                                                        SLAP........745200
C     MACHINE CONSTANTS FOR THE IBM RS 6000                              SLAP........745300
C                                                                        SLAP........745400
C     DATA IMACH( 1) /          5 /                                      SLAP........745500
C     DATA IMACH( 2) /          6 /                                      SLAP........745600
C     DATA IMACH( 3) /          6 /                                      SLAP........745700
C     DATA IMACH( 4) /          0 /                                      SLAP........745800
C     DATA IMACH( 5) /         32 /                                      SLAP........745900
C     DATA IMACH( 6) /          4 /                                      SLAP........746000
C     DATA IMACH( 7) /          2 /                                      SLAP........746100
C     DATA IMACH( 8) /         31 /                                      SLAP........746200
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........746300
C     DATA IMACH(10) /          2 /                                      SLAP........746400
C     DATA IMACH(11) /         24 /                                      SLAP........746500
C     DATA IMACH(12) /       -125 /                                      SLAP........746600
C     DATA IMACH(13) /        128 /                                      SLAP........746700
C     DATA IMACH(14) /         53 /                                      SLAP........746800
C     DATA IMACH(15) /      -1021 /                                      SLAP........746900
C     DATA IMACH(16) /       1024 /                                      SLAP........747000
C                                                                        SLAP........747100
C     MACHINE CONSTANTS FOR THE INTEL i860                               SLAP........747200
C                                                                        SLAP........747300
C     DATA IMACH( 1) /          5 /                                      SLAP........747400
C     DATA IMACH( 2) /          6 /                                      SLAP........747500
C     DATA IMACH( 3) /          6 /                                      SLAP........747600
C     DATA IMACH( 4) /          6 /                                      SLAP........747700
C     DATA IMACH( 5) /         32 /                                      SLAP........747800
C     DATA IMACH( 6) /          4 /                                      SLAP........747900
C     DATA IMACH( 7) /          2 /                                      SLAP........748000
C     DATA IMACH( 8) /         31 /                                      SLAP........748100
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........748200
C     DATA IMACH(10) /          2 /                                      SLAP........748300
C     DATA IMACH(11) /         24 /                                      SLAP........748400
C     DATA IMACH(12) /       -125 /                                      SLAP........748500
C     DATA IMACH(13) /        128 /                                      SLAP........748600
C     DATA IMACH(14) /         53 /                                      SLAP........748700
C     DATA IMACH(15) /      -1021 /                                      SLAP........748800
C     DATA IMACH(16) /       1024 /                                      SLAP........748900
C                                                                        SLAP........749000
C     MACHINE CONSTANTS FOR THE PDP-10 (KA PROCESSOR)                    SLAP........749100
C                                                                        SLAP........749200
C     DATA IMACH( 1) /          5 /                                      SLAP........749300
C     DATA IMACH( 2) /          6 /                                      SLAP........749400
C     DATA IMACH( 3) /          5 /                                      SLAP........749500
C     DATA IMACH( 4) /          6 /                                      SLAP........749600
C     DATA IMACH( 5) /         36 /                                      SLAP........749700
C     DATA IMACH( 6) /          5 /                                      SLAP........749800
C     DATA IMACH( 7) /          2 /                                      SLAP........749900
C     DATA IMACH( 8) /         35 /                                      SLAP........750000
C     DATA IMACH( 9) / "377777777777 /                                   SLAP........750100
C     DATA IMACH(10) /          2 /                                      SLAP........750200
C     DATA IMACH(11) /         27 /                                      SLAP........750300
C     DATA IMACH(12) /       -128 /                                      SLAP........750400
C     DATA IMACH(13) /        127 /                                      SLAP........750500
C     DATA IMACH(14) /         54 /                                      SLAP........750600
C     DATA IMACH(15) /       -101 /                                      SLAP........750700
C     DATA IMACH(16) /        127 /                                      SLAP........750800
C                                                                        SLAP........750900
C     MACHINE CONSTANTS FOR THE PDP-10 (KI PROCESSOR)                    SLAP........751000
C                                                                        SLAP........751100
C     DATA IMACH( 1) /          5 /                                      SLAP........751200
C     DATA IMACH( 2) /          6 /                                      SLAP........751300
C     DATA IMACH( 3) /          5 /                                      SLAP........751400
C     DATA IMACH( 4) /          6 /                                      SLAP........751500
C     DATA IMACH( 5) /         36 /                                      SLAP........751600
C     DATA IMACH( 6) /          5 /                                      SLAP........751700
C     DATA IMACH( 7) /          2 /                                      SLAP........751800
C     DATA IMACH( 8) /         35 /                                      SLAP........751900
C     DATA IMACH( 9) / "377777777777 /                                   SLAP........752000
C     DATA IMACH(10) /          2 /                                      SLAP........752100
C     DATA IMACH(11) /         27 /                                      SLAP........752200
C     DATA IMACH(12) /       -128 /                                      SLAP........752300
C     DATA IMACH(13) /        127 /                                      SLAP........752400
C     DATA IMACH(14) /         62 /                                      SLAP........752500
C     DATA IMACH(15) /       -128 /                                      SLAP........752600
C     DATA IMACH(16) /        127 /                                      SLAP........752700
C                                                                        SLAP........752800
C     MACHINE CONSTANTS FOR PDP-11 FORTRAN SUPPORTING                    SLAP........752900
C     32-BIT INTEGER ARITHMETIC.                                         SLAP........753000
C                                                                        SLAP........753100
C     DATA IMACH( 1) /          5 /                                      SLAP........753200
C     DATA IMACH( 2) /          6 /                                      SLAP........753300
C     DATA IMACH( 3) /          5 /                                      SLAP........753400
C     DATA IMACH( 4) /          6 /                                      SLAP........753500
C     DATA IMACH( 5) /         32 /                                      SLAP........753600
C     DATA IMACH( 6) /          4 /                                      SLAP........753700
C     DATA IMACH( 7) /          2 /                                      SLAP........753800
C     DATA IMACH( 8) /         31 /                                      SLAP........753900
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........754000
C     DATA IMACH(10) /          2 /                                      SLAP........754100
C     DATA IMACH(11) /         24 /                                      SLAP........754200
C     DATA IMACH(12) /       -127 /                                      SLAP........754300
C     DATA IMACH(13) /        127 /                                      SLAP........754400
C     DATA IMACH(14) /         56 /                                      SLAP........754500
C     DATA IMACH(15) /       -127 /                                      SLAP........754600
C     DATA IMACH(16) /        127 /                                      SLAP........754700
C                                                                        SLAP........754800
C     MACHINE CONSTANTS FOR PDP-11 FORTRAN SUPPORTING                    SLAP........754900
C     16-BIT INTEGER ARITHMETIC.                                         SLAP........755000
C                                                                        SLAP........755100
C     DATA IMACH( 1) /          5 /                                      SLAP........755200
C     DATA IMACH( 2) /          6 /                                      SLAP........755300
C     DATA IMACH( 3) /          5 /                                      SLAP........755400
C     DATA IMACH( 4) /          6 /                                      SLAP........755500
C     DATA IMACH( 5) /         16 /                                      SLAP........755600
C     DATA IMACH( 6) /          2 /                                      SLAP........755700
C     DATA IMACH( 7) /          2 /                                      SLAP........755800
C     DATA IMACH( 8) /         15 /                                      SLAP........755900
C     DATA IMACH( 9) /      32767 /                                      SLAP........756000
C     DATA IMACH(10) /          2 /                                      SLAP........756100
C     DATA IMACH(11) /         24 /                                      SLAP........756200
C     DATA IMACH(12) /       -127 /                                      SLAP........756300
C     DATA IMACH(13) /        127 /                                      SLAP........756400
C     DATA IMACH(14) /         56 /                                      SLAP........756500
C     DATA IMACH(15) /       -127 /                                      SLAP........756600
C     DATA IMACH(16) /        127 /                                      SLAP........756700
C                                                                        SLAP........756800
C     MACHINE CONSTANTS FOR THE SILICON GRAPHICS                         SLAP........756900
C                                                                        SLAP........757000
C     DATA IMACH( 1) /          5 /                                      SLAP........757100
C     DATA IMACH( 2) /          6 /                                      SLAP........757200
C     DATA IMACH( 3) /          6 /                                      SLAP........757300
C     DATA IMACH( 4) /          6 /                                      SLAP........757400
C     DATA IMACH( 5) /         32 /                                      SLAP........757500
C     DATA IMACH( 6) /          4 /                                      SLAP........757600
C     DATA IMACH( 7) /          2 /                                      SLAP........757700
C     DATA IMACH( 8) /         31 /                                      SLAP........757800
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........757900
C     DATA IMACH(10) /          2 /                                      SLAP........758000
C     DATA IMACH(11) /         24 /                                      SLAP........758100
C     DATA IMACH(12) /       -125 /                                      SLAP........758200
C     DATA IMACH(13) /        128 /                                      SLAP........758300
C     DATA IMACH(14) /         53 /                                      SLAP........758400
C     DATA IMACH(15) /      -1021 /                                      SLAP........758500
C     DATA IMACH(16) /       1024 /                                      SLAP........758600
C                                                                        SLAP........758700
C     MACHINE CONSTANTS FOR THE SUN                                      SLAP........758800
C                                                                        SLAP........758900
C     DATA IMACH( 1) /          5 /                                      SLAP........759000
C     DATA IMACH( 2) /          6 /                                      SLAP........759100
C     DATA IMACH( 3) /          6 /                                      SLAP........759200
C     DATA IMACH( 4) /          6 /                                      SLAP........759300
C     DATA IMACH( 5) /         32 /                                      SLAP........759400
C     DATA IMACH( 6) /          4 /                                      SLAP........759500
C     DATA IMACH( 7) /          2 /                                      SLAP........759600
C     DATA IMACH( 8) /         31 /                                      SLAP........759700
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........759800
C     DATA IMACH(10) /          2 /                                      SLAP........759900
C     DATA IMACH(11) /         24 /                                      SLAP........760000
C     DATA IMACH(12) /       -125 /                                      SLAP........760100
C     DATA IMACH(13) /        128 /                                      SLAP........760200
C     DATA IMACH(14) /         53 /                                      SLAP........760300
C     DATA IMACH(15) /      -1021 /                                      SLAP........760400
C     DATA IMACH(16) /       1024 /                                      SLAP........760500
C                                                                        SLAP........760600
C     MACHINE CONSTANTS FOR THE SUN                                      SLAP........760700
C     USING THE -r8 COMPILER OPTION                                      SLAP........760800
C                                                                        SLAP........760900
C     DATA IMACH( 1) /          5 /                                      SLAP........761000
C     DATA IMACH( 2) /          6 /                                      SLAP........761100
C     DATA IMACH( 3) /          6 /                                      SLAP........761200
C     DATA IMACH( 4) /          6 /                                      SLAP........761300
C     DATA IMACH( 5) /         32 /                                      SLAP........761400
C     DATA IMACH( 6) /          4 /                                      SLAP........761500
C     DATA IMACH( 7) /          2 /                                      SLAP........761600
C     DATA IMACH( 8) /         31 /                                      SLAP........761700
C     DATA IMACH( 9) / 2147483647 /                                      SLAP........761800
C     DATA IMACH(10) /          2 /                                      SLAP........761900
C     DATA IMACH(11) /         53 /                                      SLAP........762000
C     DATA IMACH(12) /      -1021 /                                      SLAP........762100
C     DATA IMACH(13) /       1024 /                                      SLAP........762200
C     DATA IMACH(14) /        113 /                                      SLAP........762300
C     DATA IMACH(15) /     -16381 /                                      SLAP........762400
C     DATA IMACH(16) /      16384 /                                      SLAP........762500
C                                                                        SLAP........762600
C     MACHINE CONSTANTS FOR THE UNIVAC 1100 SERIES FTN COMPILER          SLAP........762700
C                                                                        SLAP........762800
C     DATA IMACH( 1) /          5 /                                      SLAP........762900
C     DATA IMACH( 2) /          6 /                                      SLAP........763000
C     DATA IMACH( 3) /          1 /                                      SLAP........763100
C     DATA IMACH( 4) /          6 /                                      SLAP........763200
C     DATA IMACH( 5) /         36 /                                      SLAP........763300
C     DATA IMACH( 6) /          4 /                                      SLAP........763400
C     DATA IMACH( 7) /          2 /                                      SLAP........763500
C     DATA IMACH( 8) /         35 /                                      SLAP........763600
C     DATA IMACH( 9) / O377777777777 /                                   SLAP........763700
C     DATA IMACH(10) /          2 /                                      SLAP........763800
C     DATA IMACH(11) /         27 /                                      SLAP........763900
C     DATA IMACH(12) /       -128 /                                      SLAP........764000
C     DATA IMACH(13) /        127 /                                      SLAP........764100
C     DATA IMACH(14) /         60 /                                      SLAP........764200
C     DATA IMACH(15) /      -1024 /                                      SLAP........764300
C     DATA IMACH(16) /       1023 /                                      SLAP........764400
C                                                                        SLAP........764500
C     MACHINE CONSTANTS FOR THE Z80 MICROPROCESSOR                       SLAP........764600
C                                                                        SLAP........764700
C     DATA IMACH( 1) /          1 /                                      SLAP........764800
C     DATA IMACH( 2) /          1 /                                      SLAP........764900
C     DATA IMACH( 3) /          0 /                                      SLAP........765000
C     DATA IMACH( 4) /          1 /                                      SLAP........765100
C     DATA IMACH( 5) /         16 /                                      SLAP........765200
C     DATA IMACH( 6) /          2 /                                      SLAP........765300
C     DATA IMACH( 7) /          2 /                                      SLAP........765400
C     DATA IMACH( 8) /         15 /                                      SLAP........765500
C     DATA IMACH( 9) /      32767 /                                      SLAP........765600
C     DATA IMACH(10) /          2 /                                      SLAP........765700
C     DATA IMACH(11) /         24 /                                      SLAP........765800
C     DATA IMACH(12) /       -127 /                                      SLAP........765900
C     DATA IMACH(13) /        127 /                                      SLAP........766000
C     DATA IMACH(14) /         56 /                                      SLAP........766100
C     DATA IMACH(15) /       -127 /                                      SLAP........766200
C     DATA IMACH(16) /        127 /                                      SLAP........766300
C                                                                        SLAP........766400
C.....GENERAL-PURPOSE VALUES INSERTED DURING INTEGRATION OF SLAP         SLAP........766500
C        WITH SUTRA.  (ONLY SPECIFIED VALUES USED BY SLAP ROUTINES.)     SLAP........766600
C                                                                        SLAP........766700
      DATA IMACH( 4) /          6 /                                      SLAP........766800
C                                                                        SLAP........766900
C***FIRST EXECUTABLE STATEMENT  I1MACH                                   SLAP........767000
      IF (I .LT. 1  .OR.  I .GT. 16) GO TO 10                            SLAP........767100
C                                                                        SLAP........767200
      I1MACH = IMACH(I)                                                  SLAP........767300
      RETURN                                                             SLAP........767400
C                                                                        SLAP........767500
   10 CONTINUE                                                           SLAP........767600
      WRITE (UNIT = OUTPUT, FMT = 9000)                                  SLAP........767700
 9000 FORMAT ('1ERROR    1 IN I1MACH - I OUT OF BOUNDS')                 SLAP........767800
C                                                                        SLAP........767900
C     CALL FDUMP                                                         SLAP........768000
C                                                                        SLAP........768100
      STOP                                                               SLAP........768200
      END                                                                SLAP........768300
*DECK ISDCG                                                              SLAP........768400
      INTEGER FUNCTION ISDCG (N, B, X, NELT, IA, JA, A, ISYM, MSOLVE,    SLAP........768500
     +   ITOL, TOL, ITMAX, ITER, ERR, IERR, IUNIT, R, Z, P, DZ, RWORK,   SLAP........768600
     +   IWORK, AK, BK, BNRM, SOLNRM)                                    SLAP........768700
C***BEGIN PROLOGUE  ISDCG                                                SLAP........768800
C***SUBSIDIARY                                                           SLAP........768900
C***PURPOSE  Preconditioned Conjugate Gradient Stop Test.                SLAP........769000
C            This routine calculates the stop test for the Conjugate     SLAP........769100
C            Gradient iteration scheme.  It returns a non-zero if the    SLAP........769200
C            error estimate (the type of which is determined by ITOL)    SLAP........769300
C            is less than the user specified tolerance TOL.              SLAP........769400
C***LIBRARY   SLATEC (SLAP)                                              SLAP........769500
C***CATEGORY  D2B4                                                       SLAP........769600
C***TYPE      DOUBLE PRECISION (ISSCG-S, ISDCG-D)                        SLAP........769700
C***KEYWORDS  LINEAR SYSTEM, SLAP, SPARSE, STOP TEST                     SLAP........769800
C***AUTHOR  Greenbaum, Anne, (Courant Institute)                         SLAP........769900
C           Seager, Mark K., (LLNL)                                      SLAP........770000
C             Lawrence Livermore National Laboratory                     SLAP........770100
C             PO BOX 808, L-60                                           SLAP........770200
C             Livermore, CA 94550 (510) 423-3141                         SLAP........770300
C             seager@llnl.gov                                            SLAP........770400
C***DESCRIPTION                                                          SLAP........770500
C                                                                        SLAP........770600
C *Usage:                                                                SLAP........770700
C     INTEGER N, NELT, IA(NELT), JA(NELT), ISYM, ITOL, ITMAX, ITER       SLAP........770800
C     INTEGER IERR, IUNIT, IWORK(USER DEFINED)                           SLAP........770900
C     DOUBLE PRECISION B(N), X(N), A(N), TOL, ERR, R(N), Z(N)            SLAP........771000
C     DOUBLE PRECISION P(N), DZ(N), RWORK(USER DEFINED), AK, BK          SLAP........771100
C     DOUBLE PRECISION BNRM, SOLNRM                                      SLAP........771200
C     EXTERNAL MSOLVE                                                    SLAP........771300
C                                                                        SLAP........771400
C     IF( ISDCG(N, B, X, NELT, IA, JA, A, ISYM, MSOLVE, ITOL, TOL,       SLAP........771500
C    $     ITMAX, ITER, ERR, IERR, IUNIT, R, Z, P, DZ, RWORK, IWORK,     SLAP........771600
C    $     AK, BK, BNRM, SOLNRM) .NE. 0 ) THEN ITERATION DONE            SLAP........771700
C                                                                        SLAP........771800
C *Arguments:                                                            SLAP........771900
C N      :IN       Integer.                                              SLAP........772000
C         Order of the Matrix.                                           SLAP........772100
C B      :IN       Double Precision B(N).                                SLAP........772200
C         Right-hand side vector.                                        SLAP........772300
C X      :IN       Double Precision X(N).                                SLAP........772400
C         The current approximate solution vector.                       SLAP........772500
C NELT   :IN       Integer.                                              SLAP........772600
C         Number of Non-Zeros stored in A.                               SLAP........772700
C IA     :IN       Integer IA(NELT).                                     SLAP........772800
C JA     :IN       Integer JA(NELT).                                     SLAP........772900
C A      :IN       Double Precision A(NELT).                             SLAP........773000
C         These arrays should hold the matrix A in either the SLAP       SLAP........773100
C         Triad format or the SLAP Column format.  See "Description"     SLAP........773200
C         in the DCG, DSDCG or DSICCG routines.                          SLAP........773300
C ISYM   :IN       Integer.                                              SLAP........773400
C         Flag to indicate symmetric storage format.                     SLAP........773500
C         If ISYM=0, all non-zero entries of the matrix are stored.      SLAP........773600
C         If ISYM=1, the matrix is symmetric, and only the upper         SLAP........773700
C         or lower triangle of the matrix is stored.                     SLAP........773800
C MSOLVE :EXT      External.                                             SLAP........773900
C         Name of a routine which solves a linear system MZ = R for      SLAP........774000
C         Z given R with the preconditioning matrix M (M is supplied via SLAP........774100
C         RWORK and IWORK arrays).  The name of the MSOLVE routine must  SLAP........774200
C         be declared external in the calling program.  The calling      SLAP........774300
C         sequence to MSOLVE is:                                         SLAP........774400
C             CALL MSOLVE(N, R, Z, NELT, IA, JA, A, ISYM, RWORK, IWORK)  SLAP........774500
C         Where N is the number of unknowns, R is the right-hand side    SLAP........774600
C         vector and Z is the solution upon return.  NELT, IA, JA, A and SLAP........774700
C         ISYM are defined as above.  RWORK is a double precision array  SLAP........774800
C         that can be used to pass necessary preconditioning information SLAP........774900
C         and/or workspace to MSOLVE.  IWORK is an integer work array    SLAP........775000
C         for the same purpose as RWORK.                                 SLAP........775100
C ITOL   :IN       Integer.                                              SLAP........775200
C         Flag to indicate type of convergence criterion.                SLAP........775300
C         If ITOL=1, iteration stops when the 2-norm of the residual     SLAP........775400
C         divided by the 2-norm of the right-hand side is less than TOL. SLAP........775500
C         If ITOL=2, iteration stops when the 2-norm of M-inv times the  SLAP........775600
C         residual divided by the 2-norm of M-inv times the right hand   SLAP........775700
C         side is less than TOL, where M-inv is the inverse of the       SLAP........775800
C         diagonal of A.                                                 SLAP........775900
C         ITOL=11 is often useful for checking and comparing different   SLAP........776000
C         routines.  For this case, the user must supply the "exact"     SLAP........776100
C         solution or a very accurate approximation (one with an error   SLAP........776200
C         much less than TOL) through a common block,                    SLAP........776300
C             COMMON /DSLBLK/ SOLN( )                                    SLAP........776400
C         If ITOL=11, iteration stops when the 2-norm of the difference  SLAP........776500
C         between the iterative approximation and the user-supplied      SLAP........776600
C         solution divided by the 2-norm of the user-supplied solution   SLAP........776700
C         is less than TOL.  Note that this requires the user to set up  SLAP........776800
C         the "COMMON /DSLBLK/ SOLN(LENGTH)" in the calling routine.     SLAP........776900
C         The routine with this declaration should be loaded before the  SLAP........777000
C         stop test so that the correct length is used by the loader.    SLAP........777100
C         This procedure is not standard Fortran and may not work        SLAP........777200
C         correctly on your system (although it has worked on every      SLAP........777300
C         system the authors have tried).  If ITOL is not 11 then this   SLAP........777400
C         common block is indeed standard Fortran.                       SLAP........777500
C TOL    :IN       Double Precision.                                     SLAP........777600
C         Convergence criterion, as described above.                     SLAP........777700
C ITMAX  :IN       Integer.                                              SLAP........777800
C         Maximum number of iterations.                                  SLAP........777900
C ITER   :IN       Integer.                                              SLAP........778000
C         Current iteration count.  (Must be zero on first call.)        SLAP........778100
C ERR    :OUT      Double Precision.                                     SLAP........778200
C         Error estimate of error in the X(N) approximate solution, as   SLAP........778300
C         defined by ITOL.                                               SLAP........778400
C IERR   :OUT      Integer.                                              SLAP........778500
C         Error flag.  IERR is set to 3 if ITOL is not one of the        SLAP........778600
C         acceptable values, see above.                                  SLAP........778700
C IUNIT  :IN       Integer.                                              SLAP........778800
C         Unit number on which to write the error at each iteration,     SLAP........778900
C         if this is desired for monitoring convergence.  If unit        SLAP........779000
C         number is 0, no writing will occur.                            SLAP........779100
C R      :IN       Double Precision R(N).                                SLAP........779200
C         The residual R = B-AX.                                         SLAP........779300
C Z      :WORK     Double Precision Z(N).                                SLAP........779400
C         Workspace used to hold the pseudo-residual M Z = R.            SLAP........779500
C P      :IN       Double Precision P(N).                                SLAP........779600
C         The conjugate direction vector.                                SLAP........779700
C DZ     :WORK     Double Precision DZ(N).                               SLAP........779800
C         Workspace used to hold temporary vector(s).                    SLAP........779900
C RWORK  :WORK     Double Precision RWORK(USER DEFINED).                 SLAP........780000
C         Double Precision array that can be used by MSOLVE.             SLAP........780100
C IWORK  :WORK     Integer IWORK(USER DEFINED).                          SLAP........780200
C         Integer array that can be used by MSOLVE.                      SLAP........780300
C AK     :IN       Double Precision.                                     SLAP........780400
C BK     :IN       Double Precision.                                     SLAP........780500
C         Current conjugate gradient parameters alpha and beta.          SLAP........780600
C BNRM   :INOUT    Double Precision.                                     SLAP........780700
C         Norm of the right hand side.  Type of norm depends on ITOL.    SLAP........780800
C         Calculated only on the first call.                             SLAP........780900
C SOLNRM :INOUT    Double Precision.                                     SLAP........781000
C         2-Norm of the true solution, SOLN.  Only computed and used     SLAP........781100
C         if ITOL = 11.                                                  SLAP........781200
C                                                                        SLAP........781300
C *Function Return Values:                                               SLAP........781400
C       0 : Error estimate (determined by ITOL) is *NOT* less than the   SLAP........781500
C           specified tolerance, TOL.  The iteration must continue.      SLAP........781600
C       1 : Error estimate (determined by ITOL) is less than the         SLAP........781700
C           specified tolerance, TOL.  The iteration can be considered   SLAP........781800
C           complete.                                                    SLAP........781900
C                                                                        SLAP........782000
C *Cautions:                                                             SLAP........782100
C     This routine will attempt to write to the Fortran logical output   SLAP........782200
C     unit IUNIT, if IUNIT .ne. 0.  Thus, the user must make sure that   SLAP........782300
C     this logical unit is attached to a file or terminal before calling SLAP........782400
C     this routine with a non-zero value for IUNIT.  This routine does   SLAP........782500
C     not check for the validity of a non-zero IUNIT unit number.        SLAP........782600
C                                                                        SLAP........782700
C***SEE ALSO  DCG, DSDCG, DSICCG                                         SLAP........782800
C***ROUTINES CALLED  D1MACH, DNRM2                                       SLAP........782900
C***COMMON BLOCKS    DSLBLK                                              SLAP........783000
C***REVISION HISTORY  (YYMMDD)                                           SLAP........783100
C   890404  DATE WRITTEN                                                 SLAP........783200
C   890404  Previous REVISION DATE                                       SLAP........783300
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........783400
C   890921  Removed TeX from comments.  (FNF)                            SLAP........783500
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........783600
C           standard.  (FNF)                                             SLAP........783700
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........783800
C   891003  Removed C***REFER TO line, per MKS.                          SLAP........783900
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........784000
C   910502  Removed MSOLVE from ROUTINES CALLED list.  (FNF)             SLAP........784100
C   910506  Made subsidiary to DCG.  (FNF)                               SLAP........784200
C   920407  COMMON BLOCK renamed DSLBLK.  (WRB)                          SLAP........784300
C   920511  Added complete declaration section.  (WRB)                   SLAP........784400
C   920930  Corrected to not print AK,BK when ITER=0.  (FNF)             SLAP........784500
C   921026  Changed 1.0E10 to D1MACH(2) and corrected D to E in          SLAP........784600
C           output format.  (FNF)                                        SLAP........784700
C***END PROLOGUE  ISDCG                                                  SLAP........784800
C     .. Scalar Arguments ..                                             SLAP........784900
      DOUBLE PRECISION AK, BK, BNRM, ERR, SOLNRM, TOL                    SLAP........785000
      INTEGER IERR, ISYM, ITER, ITMAX, ITOL, IUNIT, N, NELT              SLAP........785100
C     .. Array Arguments ..                                              SLAP........785200
      DOUBLE PRECISION A(NELT), B(N), DZ(N), P(N), R(N), RWORK(*), X(N), SLAP........785300
     +                 Z(N)                                              SLAP........785400
      INTEGER IA(NELT), IWORK(*), JA(NELT)                               SLAP........785500
C     .. Subroutine Arguments ..                                         SLAP........785600
      EXTERNAL MSOLVE                                                    SLAP........785700
C     .. Arrays in Common ..                                             SLAP........785800
      DOUBLE PRECISION SOLN(1)                                           SLAP........785900
C     .. Local Scalars ..                                                SLAP........786000
      INTEGER I                                                          SLAP........786100
C     .. External Functions ..                                           SLAP........786200
      DOUBLE PRECISION D1MACH, DNRM2                                     SLAP........786300
      EXTERNAL D1MACH, DNRM2                                             SLAP........786400
C     .. Common blocks ..                                                SLAP........786500
      COMMON /DSLBLK/ SOLN                                               SLAP........786600
C***FIRST EXECUTABLE STATEMENT  ISDCG                                    SLAP........786700
      ISDCG = 0                                                          SLAP........786800
C                                                                        SLAP........786900
      IF( ITOL.EQ.1 ) THEN                                               SLAP........787000
C         err = ||Residual||/||RightHandSide|| (2-Norms).                SLAP........787100
         IF(ITER .EQ. 0) BNRM = DNRM2(N, B, 1)                           SLAP........787200
         ERR = DNRM2(N, R, 1)/BNRM                                       SLAP........787300
      ELSE IF( ITOL.EQ.2 ) THEN                                          SLAP........787400
C                  -1              -1                                    SLAP........787500
C         err = ||M  Residual||/||M  RightHandSide|| (2-Norms).          SLAP........787600
         IF(ITER .EQ. 0) THEN                                            SLAP........787700
C...........THE NEXT LINE OF CODE REFLECTS A BUG FIX MADE DURING         SLAP........787800
C              INTEGRATION OF SLAP WITH SUTRA.  IT ORIGINALLY READ:      SLAP........787900
C            CALL MSOLVE(N, R, Z, NELT, IA, JA, A, ISYM, RWORK, IWORK)   SLAP........788000
            CALL MSOLVE(N, R, DZ, NELT, IA, JA, A, ISYM, RWORK, IWORK)   SLAP........788100
            BNRM = DNRM2(N, DZ, 1)                                       SLAP........788200
         ENDIF                                                           SLAP........788300
         ERR = DNRM2(N, Z, 1)/BNRM                                       SLAP........788400
      ELSE IF( ITOL.EQ.11 ) THEN                                         SLAP........788500
C         err = ||x-TrueSolution||/||TrueSolution|| (2-Norms).           SLAP........788600
         IF(ITER .EQ. 0) SOLNRM = DNRM2(N, SOLN, 1)                      SLAP........788700
         DO 10 I = 1, N                                                  SLAP........788800
            DZ(I) = X(I) - SOLN(I)                                       SLAP........788900
 10      CONTINUE                                                        SLAP........789000
         ERR = DNRM2(N, DZ, 1)/SOLNRM                                    SLAP........789100
      ELSE                                                               SLAP........789200
C                                                                        SLAP........789300
C         If we get here ITOL is not one of the acceptable values.       SLAP........789400
         ERR = D1MACH(2)                                                 SLAP........789500
         IERR = 3                                                        SLAP........789600
      ENDIF                                                              SLAP........789700
C                                                                        SLAP........789800
CM    CANCEL OUTPUT TO .SMY FILE FOR CG ALGORITHM
CM      IF(IUNIT .NE. 0) THEN                                              SLAP........789900
CM         IF( ITER.EQ.0 ) THEN                                            SLAP........790000
C...........THE NEXT LINE OF CODE WAS MODIFIED DURING INTEGRATION        SLAP........790100
C              OF SLAP WITH SUTRA.  IT ORIGINALLY READ:                  SLAP........790200
C              WRITE(IUNIT,1000) N, ITOL                                 SLAP........790300
CM            WRITE(IUNIT,1000)                                            SLAP........790400
CM            WRITE(IUNIT,1010) ITER, ERR                                  SLAP........790500
CM         ELSE                                                            SLAP........790600
C...........THE NEXT LINE OF CODE WAS MODIFIED DURING INTEGRATION        SLAP........790700
C              OF SLAP WITH SUTRA.  IT ORIGINALLY READ:                  SLAP........790800
C              WRITE(IUNIT,1010) ITER, ERR, AK, BK                       SLAP........790900
CM            WRITE(IUNIT,1010) ITER, ERR                                  SLAP........791000
CM         ENDIF                                                           SLAP........791100
CM      ENDIF                                                              SLAP........791200
      IF(ERR .LE. TOL) ISDCG = 1                                         SLAP........791300
      RETURN                                                             SLAP........791400
C.....THE NEXT TWO LINES OF CODE REFLECT MODIFICATIONS MADE DURING       SLAP........791500
C        INTEGRATION OF SLAP WITH SUTRA.  THEY ORIGINALLY READ:          SLAP........791600
C        1000 FORMAT(' Preconditioned Conjugate Gradient for ',          SLAP........791700
C            $     'N, ITOL = ',I5, I5,                                  SLAP........791800
C            $     /' ITER','   Error Estimate','            Alpha',     SLAP........791900
C            $     '             Beta')                                  SLAP........792000
C        1010 FORMAT(1X,I4,1X,D16.7,1X,D16.7,1X,D16.7)                   SLAP........792100
1000  FORMAT(1X,6X,'Solver Iteration','   Error Estimate')               SLAP........792200
1010  FORMAT(1X,6X,I16,1X,1PE16.7)                                       SLAP........792300
C------------- LAST LINE OF ISDCG FOLLOWS ------------------------------ SLAP........792400
      END                                                                SLAP........792500
*DECK ISDGMR                                                             SLAP........792600
      INTEGER FUNCTION ISDGMR (N, B, X, XL, NELT, IA, JA, A, ISYM,       SLAP........792700
     +   MSOLVE, NMSL, ITOL, TOL, ITMAX, ITER, ERR, IUNIT, R, Z, DZ,     SLAP........792800
     +   RWORK, IWORK, RNRM, BNRM, SB, SX, JSCAL, KMP, LGMR, MAXL,       SLAP........792900
     +   MAXLP1, V, Q, SNORMW, PROD, R0NRM, HES, JPRE)                   SLAP........793000
C***BEGIN PROLOGUE  ISDGMR                                               SLAP........793100
C***SUBSIDIARY                                                           SLAP........793200
C***PURPOSE  Generalized Minimum Residual Stop Test.                     SLAP........793300
C            This routine calculates the stop test for the Generalized   SLAP........793400
C            Minimum RESidual (GMRES) iteration scheme.  It returns a    SLAP........793500
C            non-zero if the error estimate (the type of which is        SLAP........793600
C            determined by ITOL) is less than the user specified         SLAP........793700
C            tolerance TOL.                                              SLAP........793800
C***LIBRARY   SLATEC (SLAP)                                              SLAP........793900
C***CATEGORY  D2A4, D2B4                                                 SLAP........794000
C***TYPE      DOUBLE PRECISION (ISSGMR-S, ISDGMR-D)                      SLAP........794100
C***KEYWORDS  GMRES, LINEAR SYSTEM, SLAP, SPARSE, STOP TEST              SLAP........794200
C***AUTHOR  Brown, Peter, (LLNL), pnbrown@llnl.gov                       SLAP........794300
C           Hindmarsh, Alan, (LLNL), alanh@llnl.gov                      SLAP........794400
C           Seager, Mark K., (LLNL), seager@llnl.gov                     SLAP........794500
C             Lawrence Livermore National Laboratory                     SLAP........794600
C             PO Box 808, L-60                                           SLAP........794700
C             Livermore, CA 94550 (510) 423-3141                         SLAP........794800
C***DESCRIPTION                                                          SLAP........794900
C                                                                        SLAP........795000
C *Usage:                                                                SLAP........795100
C      INTEGER N, NELT, IA(NELT), JA(NELT), ISYM, NMSL, ITOL             SLAP........795200
C      INTEGER ITMAX, ITER, IUNIT, IWORK(USER DEFINED), JSCAL            SLAP........795300
C      INTEGER KMP, LGMR, MAXL, MAXLP1, JPRE                             SLAP........795400
C      DOUBLE PRECISION B(N), X(N), XL(MAXL), A(NELT), TOL, ERR,         SLAP........795500
C     $                 R(N), Z(N), DZ(N), RWORK(USER DEFINED),          SLAP........795600
C     $                 RNRM, BNRM, SB(N), SX(N), V(N,MAXLP1),           SLAP........795700
C     $                 Q(2*MAXL), SNORMW, PROD, R0NRM,                  SLAP........795800
C     $                 HES(MAXLP1,MAXL)                                 SLAP........795900
C      EXTERNAL MSOLVE                                                   SLAP........796000
C                                                                        SLAP........796100
C      IF (ISDGMR(N, B, X, XL, NELT, IA, JA, A, ISYM, MSOLVE,            SLAP........796200
C     $     NMSL, ITOL, TOL, ITMAX, ITER, ERR, IUNIT, R, Z, DZ,          SLAP........796300
C     $     RWORK, IWORK, RNRM, BNRM, SB, SX, JSCAL,                     SLAP........796400
C     $     KMP, LGMR, MAXL, MAXLP1, V, Q, SNORMW, PROD, R0NRM,          SLAP........796500
C     $     HES, JPRE) .NE. 0) THEN ITERATION DONE                       SLAP........796600
C                                                                        SLAP........796700
C *Arguments:                                                            SLAP........796800
C N      :IN       Integer.                                              SLAP........796900
C         Order of the Matrix.                                           SLAP........797000
C B      :IN       Double Precision B(N).                                SLAP........797100
C         Right-hand-side vector.                                        SLAP........797200
C X      :IN       Double Precision X(N).                                SLAP........797300
C         Approximate solution vector as of the last restart.            SLAP........797400
C XL     :OUT      Double Precision XL(N)                                SLAP........797500
C         An array of length N used to hold the approximate              SLAP........797600
C         solution as of the current iteration.  Only computed by        SLAP........797700
C         this routine when ITOL=11.                                     SLAP........797800
C NELT   :IN       Integer.                                              SLAP........797900
C         Number of Non-Zeros stored in A.                               SLAP........798000
C IA     :IN       Integer IA(NELT).                                     SLAP........798100
C JA     :IN       Integer JA(NELT).                                     SLAP........798200
C A      :IN       Double Precision A(NELT).                             SLAP........798300
C         These arrays contain the matrix data structure for A.          SLAP........798400
C         It could take any form.  See "Description", in the DGMRES,     SLAP........798500
C         DSLUGM and DSDGMR routines for more details.                   SLAP........798600
C ISYM   :IN       Integer.                                              SLAP........798700
C         Flag to indicate symmetric storage format.                     SLAP........798800
C         If ISYM=0, all non-zero entries of the matrix are stored.      SLAP........798900
C         If ISYM=1, the matrix is symmetric, and only the upper         SLAP........799000
C         or lower triangle of the matrix is stored.                     SLAP........799100
C MSOLVE :EXT      External.                                             SLAP........799200
C         Name of a routine which solves a linear system Mz = r for  z   SLAP........799300
C         given r with the preconditioning matrix M (M is supplied via   SLAP........799400
C         RWORK and IWORK arrays.  The name of the MSOLVE routine must   SLAP........799500
C         be declared external in the calling program.  The calling      SLAP........799600
C         sequence to MSOLVE is:                                         SLAP........799700
C             CALL MSOLVE(N, R, Z, NELT, IA, JA, A, ISYM, RWORK, IWORK)  SLAP........799800
C         Where N is the number of unknowns, R is the right-hand side    SLAP........799900
C         vector and Z is the solution upon return.  NELT, IA, JA, A and SLAP........800000
C         ISYM are defined as above.  RWORK is a double precision array  SLAP........800100
C         that can be used to pass necessary preconditioning information SLAP........800200
C         and/or workspace to MSOLVE.  IWORK is an integer work array    SLAP........800300
C         for the same purpose as RWORK.                                 SLAP........800400
C NMSL   :INOUT    Integer.                                              SLAP........800500
C         A counter for the number of calls to MSOLVE.                   SLAP........800600
C ITOL   :IN       Integer.                                              SLAP........800700
C         Flag to indicate the type of convergence criterion used.       SLAP........800800
C         ITOL=0  Means the  iteration stops when the test described     SLAP........800900
C                 below on  the  residual RL  is satisfied.  This is     SLAP........801000
C                 the  "Natural Stopping Criteria" for this routine.     SLAP........801100
C                 Other values  of   ITOL  cause  extra,   otherwise     SLAP........801200
C                 unnecessary, computation per iteration and     are     SLAP........801300
C                 therefore much less efficient.                         SLAP........801400
C         ITOL=1  Means   the  iteration stops   when the first test     SLAP........801500
C                 described below on  the residual RL  is satisfied,     SLAP........801600
C                 and there  is either right  or  no preconditioning     SLAP........801700
C                 being used.                                            SLAP........801800
C         ITOL=2  Implies     that   the  user    is   using    left     SLAP........801900
C                 preconditioning, and the second stopping criterion     SLAP........802000
C                 below is used.                                         SLAP........802100
C         ITOL=3  Means the  iteration stops   when  the  third test     SLAP........802200
C                 described below on Minv*Residual is satisfied, and     SLAP........802300
C                 there is either left  or no  preconditioning begin     SLAP........802400
C                 used.                                                  SLAP........802500
C         ITOL=11 is    often  useful  for   checking  and comparing     SLAP........802600
C                 different routines.  For this case, the  user must     SLAP........802700
C                 supply  the  "exact" solution or  a  very accurate     SLAP........802800
C                 approximation (one with  an  error much less  than     SLAP........802900
C                 TOL) through a common block,                           SLAP........803000
C                     COMMON /DSLBLK/ SOLN( )                            SLAP........803100
C                 If ITOL=11, iteration stops when the 2-norm of the     SLAP........803200
C                 difference between the iterative approximation and     SLAP........803300
C                 the user-supplied solution  divided by the  2-norm     SLAP........803400
C                 of the  user-supplied solution  is  less than TOL.     SLAP........803500
C                 Note that this requires  the  user to  set up  the     SLAP........803600
C                 "COMMON     /DSLBLK/ SOLN(LENGTH)"  in the calling     SLAP........803700
C                 routine.  The routine with this declaration should     SLAP........803800
C                 be loaded before the stop test so that the correct     SLAP........803900
C                 length is used by  the loader.  This procedure  is     SLAP........804000
C                 not standard Fortran and may not work correctly on     SLAP........804100
C                 your   system (although  it  has  worked  on every     SLAP........804200
C                 system the authors have tried).  If ITOL is not 11     SLAP........804300
C                 then this common block is indeed standard Fortran.     SLAP........804400
C TOL    :IN       Double Precision.                                     SLAP........804500
C         Convergence criterion, as described above.                     SLAP........804600
C ITMAX  :IN       Integer.                                              SLAP........804700
C         Maximum number of iterations.                                  SLAP........804800
C ITER   :IN       Integer.                                              SLAP........804900
C         The iteration for which to check for convergence.              SLAP........805000
C ERR    :OUT      Double Precision.                                     SLAP........805100
C         Error estimate of error in final approximate solution, as      SLAP........805200
C         defined by ITOL.  Letting norm() denote the Euclidean          SLAP........805300
C         norm, ERR is defined as follows..                              SLAP........805400
C                                                                        SLAP........805500
C         If ITOL=0, then ERR = norm(SB*(B-A*X(L)))/norm(SB*B),          SLAP........805600
C                               for right or no preconditioning, and     SLAP........805700
C                         ERR = norm(SB*(M-inverse)*(B-A*X(L)))/         SLAP........805800
C                                norm(SB*(M-inverse)*B),                 SLAP........805900
C                               for left preconditioning.                SLAP........806000
C         If ITOL=1, then ERR = norm(SB*(B-A*X(L)))/norm(SB*B),          SLAP........806100
C                               since right or no preconditioning        SLAP........806200
C                               being used.                              SLAP........806300
C         If ITOL=2, then ERR = norm(SB*(M-inverse)*(B-A*X(L)))/         SLAP........806400
C                                norm(SB*(M-inverse)*B),                 SLAP........806500
C                               since left preconditioning is being      SLAP........806600
C                               used.                                    SLAP........806700
C         If ITOL=3, then ERR =  Max  |(Minv*(B-A*X(L)))(i)/x(i)|        SLAP........806800
C                               i=1,n                                    SLAP........806900
C         If ITOL=11, then ERR = norm(SB*(X(L)-SOLN))/norm(SB*SOLN).     SLAP........807000
C IUNIT  :IN       Integer.                                              SLAP........807100
C         Unit number on which to write the error at each iteration,     SLAP........807200
C         if this is desired for monitoring convergence.  If unit        SLAP........807300
C         number is 0, no writing will occur.                            SLAP........807400
C R      :INOUT    Double Precision R(N).                                SLAP........807500
C         Work array used in calling routine.  It contains               SLAP........807600
C         information necessary to compute the residual RL = B-A*XL.     SLAP........807700
C Z      :WORK     Double Precision Z(N).                                SLAP........807800
C         Workspace used to hold the pseudo-residual M z = r.            SLAP........807900
C DZ     :WORK     Double Precision DZ(N).                               SLAP........808000
C         Workspace used to hold temporary vector(s).                    SLAP........808100
C RWORK  :WORK     Double Precision RWORK(USER DEFINED).                 SLAP........808200
C         Double Precision array that can be used by MSOLVE.             SLAP........808300
C IWORK  :WORK     Integer IWORK(USER DEFINED).                          SLAP........808400
C         Integer array that can be used by MSOLVE.                      SLAP........808500
C RNRM   :IN       Double Precision.                                     SLAP........808600
C         Norm of the current residual.  Type of norm depends on ITOL.   SLAP........808700
C BNRM   :IN       Double Precision.                                     SLAP........808800
C         Norm of the right hand side.  Type of norm depends on ITOL.    SLAP........808900
C SB     :IN       Double Precision SB(N).                               SLAP........809000
C         Scaling vector for B.                                          SLAP........809100
C SX     :IN       Double Precision SX(N).                               SLAP........809200
C         Scaling vector for X.                                          SLAP........809300
C JSCAL  :IN       Integer.                                              SLAP........809400
C         Flag indicating if scaling arrays SB and SX are being          SLAP........809500
C         used in the calling routine DPIGMR.                            SLAP........809600
C         JSCAL=0 means SB and SX are not used and the                   SLAP........809700
C                 algorithm will perform as if all                       SLAP........809800
C                 SB(i) = 1 and SX(i) = 1.                               SLAP........809900
C         JSCAL=1 means only SX is used, and the algorithm               SLAP........810000
C                 performs as if all SB(i) = 1.                          SLAP........810100
C         JSCAL=2 means only SB is used, and the algorithm               SLAP........810200
C                 performs as if all SX(i) = 1.                          SLAP........810300
C         JSCAL=3 means both SB and SX are used.                         SLAP........810400
C KMP    :IN       Integer                                               SLAP........810500
C         The number of previous vectors the new vector VNEW             SLAP........810600
C         must be made orthogonal to.  (KMP .le. MAXL)                   SLAP........810700
C LGMR   :IN       Integer                                               SLAP........810800
C         The number of GMRES iterations performed on the current call   SLAP........810900
C         to DPIGMR (i.e., # iterations since the last restart) and      SLAP........811000
C         the current order of the upper Hessenberg                      SLAP........811100
C         matrix HES.                                                    SLAP........811200
C MAXL   :IN       Integer                                               SLAP........811300
C         The maximum allowable order of the matrix H.                   SLAP........811400
C MAXLP1 :IN       Integer                                               SLAP........811500
C         MAXPL1 = MAXL + 1, used for dynamic dimensioning of HES.       SLAP........811600
C V      :IN       Double Precision V(N,MAXLP1)                          SLAP........811700
C         The N by (LGMR+1) array containing the LGMR                    SLAP........811800
C         orthogonal vectors V(*,1) to V(*,LGMR).                        SLAP........811900
C Q      :IN       Double Precision Q(2*MAXL)                            SLAP........812000
C         A double precision array of length 2*MAXL containing the       SLAP........812100
C         components of the Givens rotations used in the QR              SLAP........812200
C         decomposition of HES.                                          SLAP........812300
C SNORMW :IN       Double Precision                                      SLAP........812400
C         A scalar containing the scaled norm of VNEW before it          SLAP........812500
C         is renormalized in DPIGMR.                                     SLAP........812600
C PROD   :IN       Double Precision                                      SLAP........812700
C         The product s1*s2*...*sl = the product of the sines of the     SLAP........812800
C         Givens rotations used in the QR factorization of the           SLAP........812900
C         Hessenberg matrix HES.                                         SLAP........813000
C R0NRM  :IN       Double Precision                                      SLAP........813100
C         The scaled norm of initial residual R0.                        SLAP........813200
C HES    :IN       Double Precision HES(MAXLP1,MAXL)                     SLAP........813300
C         The upper triangular factor of the QR decomposition            SLAP........813400
C         of the (LGMR+1) by LGMR upper Hessenberg matrix whose          SLAP........813500
C         entries are the scaled inner-products of A*V(*,I)              SLAP........813600
C         and V(*,K).                                                    SLAP........813700
C JPRE   :IN       Integer                                               SLAP........813800
C         Preconditioner type flag.                                      SLAP........813900
C         (See description of IGWK(4) in DGMRES.)                        SLAP........814000
C                                                                        SLAP........814100
C *Description                                                           SLAP........814200
C       When using the GMRES solver,  the preferred value  for ITOL      SLAP........814300
C       is 0.  This is due to the fact that when ITOL=0 the norm of      SLAP........814400
C       the residual required in the stopping test is  obtained for      SLAP........814500
C       free, since this value is already  calculated  in the GMRES      SLAP........814600
C       algorithm.   The  variable  RNRM contains the   appropriate      SLAP........814700
C       norm, which is equal to norm(SB*(RL - A*XL))  when right or      SLAP........814800
C       no   preconditioning is  being  performed,   and equal   to      SLAP........814900
C       norm(SB*Minv*(RL - A*XL))  when using left preconditioning.      SLAP........815000
C       Here, norm() is the Euclidean norm.  Nonzero values of ITOL      SLAP........815100
C       require  additional work  to  calculate the  actual  scaled      SLAP........815200
C       residual  or its scaled/preconditioned  form,  and/or   the      SLAP........815300
C       approximate solution XL.  Hence, these values of  ITOL will      SLAP........815400
C       not be as efficient as ITOL=0.                                   SLAP........815500
C                                                                        SLAP........815600
C *Cautions:                                                             SLAP........815700
C     This routine will attempt to write to the Fortran logical output   SLAP........815800
C     unit IUNIT, if IUNIT .ne. 0.  Thus, the user must make sure that   SLAP........815900
C     this logical unit is attached to a file or terminal before calling SLAP........816000
C     this routine with a non-zero value for IUNIT.  This routine does   SLAP........816100
C     not check for the validity of a non-zero IUNIT unit number.        SLAP........816200
C                                                                        SLAP........816300
C     This routine does not verify that ITOL has a valid value.          SLAP........816400
C     The calling routine should make such a test before calling         SLAP........816500
C     ISDGMR, as is done in DGMRES.                                      SLAP........816600
C                                                                        SLAP........816700
C***SEE ALSO  DGMRES                                                     SLAP........816800
C***ROUTINES CALLED  D1MACH, DCOPY, DNRM2, DRLCAL, DSCAL, DXLCAL         SLAP........816900
C***COMMON BLOCKS    DSLBLK                                              SLAP........817000
C***REVISION HISTORY  (YYMMDD)                                           SLAP........817100
C   890404  DATE WRITTEN                                                 SLAP........817200
C   890404  Previous REVISION DATE                                       SLAP........817300
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........817400
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........817500
C           standard.  (FNF)                                             SLAP........817600
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........817700
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........817800
C   910502  Corrected conversion errors, etc.  (FNF)                     SLAP........817900
C   910502  Removed MSOLVE from ROUTINES CALLED list.  (FNF)             SLAP........818000
C   910506  Made subsidiary to DGMRES.  (FNF)                            SLAP........818100
C   920407  COMMON BLOCK renamed DSLBLK.  (WRB)                          SLAP........818200
C   920511  Added complete declaration section.  (WRB)                   SLAP........818300
C   921026  Corrected D to E in output format.  (FNF)                    SLAP........818400
C   921113  Corrected C***CATEGORY line.  (FNF)                          SLAP........818500
C***END PROLOGUE  ISDGMR                                                 SLAP........818600
C     .. Scalar Arguments ..                                             SLAP........818700
      DOUBLE PRECISION BNRM, ERR, PROD, R0NRM, RNRM, SNORMW, TOL         SLAP........818800
      INTEGER ISYM, ITER, ITMAX, ITOL, IUNIT, JPRE, JSCAL, KMP, LGMR,    SLAP........818900
     +        MAXL, MAXLP1, N, NELT, NMSL                                SLAP........819000
C     .. Array Arguments ..                                              SLAP........819100
      DOUBLE PRECISION A(*), B(*), DZ(*), HES(MAXLP1, MAXL), Q(*), R(*), SLAP........819200
     +                 RWORK(*), SB(*), SX(*), V(N,*), X(*), XL(*), Z(*) SLAP........819300
      INTEGER IA(*), IWORK(*), JA(*)                                     SLAP........819400
C     .. Subroutine Arguments ..                                         SLAP........819500
      EXTERNAL MSOLVE                                                    SLAP........819600
C     .. Arrays in Common ..                                             SLAP........819700
      DOUBLE PRECISION SOLN(1)                                           SLAP........819800
C     .. Local Scalars ..                                                SLAP........819900
      DOUBLE PRECISION DXNRM, FUZZ, RAT, RATMAX, SOLNRM, TEM             SLAP........820000
      INTEGER I, IELMAX                                                  SLAP........820100
C     .. External Functions ..                                           SLAP........820200
      DOUBLE PRECISION D1MACH, DNRM2                                     SLAP........820300
      EXTERNAL D1MACH, DNRM2                                             SLAP........820400
C     .. External Subroutines ..                                         SLAP........820500
      EXTERNAL DCOPY, DRLCAL, DSCAL, DXLCAL                              SLAP........820600
C     .. Intrinsic Functions ..                                          SLAP........820700
      INTRINSIC ABS, MAX, SQRT                                           SLAP........820800
C     .. Common blocks ..                                                SLAP........820900
      COMMON /DSLBLK/ SOLN                                               SLAP........821000
C     .. Save statement ..                                               SLAP........821100
      SAVE SOLNRM                                                        SLAP........821200
C***FIRST EXECUTABLE STATEMENT  ISDGMR                                   SLAP........821300
      ISDGMR = 0                                                         SLAP........821400
      IF ( ITOL.EQ.0 ) THEN                                              SLAP........821500
C                                                                        SLAP........821600
C       Use input from DPIGMR to determine if stop conditions are met.   SLAP........821700
C                                                                        SLAP........821800
         ERR = RNRM/BNRM                                                 SLAP........821900
      ENDIF                                                              SLAP........822000
      IF ( (ITOL.GT.0) .AND. (ITOL.LE.3) ) THEN                          SLAP........822100
C                                                                        SLAP........822200
C       Use DRLCAL to calculate the scaled residual vector.              SLAP........822300
C       Store answer in R.                                               SLAP........822400
C                                                                        SLAP........822500
         IF ( LGMR.NE.0 ) CALL DRLCAL(N, KMP, LGMR, MAXL, V, Q, R,       SLAP........822600
     $                                SNORMW, PROD, R0NRM)               SLAP........822700
         IF ( ITOL.LE.2 ) THEN                                           SLAP........822800
C         err = ||Residual||/||RightHandSide||(2-Norms).                 SLAP........822900
            ERR = DNRM2(N, R, 1)/BNRM                                    SLAP........823000
C                                                                        SLAP........823100
C         Unscale R by R0NRM*PROD when KMP < MAXL.                       SLAP........823200
C                                                                        SLAP........823300
            IF ( (KMP.LT.MAXL) .AND. (LGMR.NE.0) ) THEN                  SLAP........823400
               TEM = 1.0D0/(R0NRM*PROD)                                  SLAP........823500
               CALL DSCAL(N, TEM, R, 1)                                  SLAP........823600
            ENDIF                                                        SLAP........823700
         ELSEIF ( ITOL.EQ.3 ) THEN                                       SLAP........823800
C         err = Max |(Minv*Residual)(i)/x(i)|                            SLAP........823900
C         When JPRE .lt. 0, R already contains Minv*Residual.            SLAP........824000
            IF ( JPRE.GT.0 ) THEN                                        SLAP........824100
               CALL MSOLVE(N, R, DZ, NELT, IA, JA, A, ISYM, RWORK,       SLAP........824200
     $              IWORK)                                               SLAP........824300
               NMSL = NMSL + 1                                           SLAP........824400
            ENDIF                                                        SLAP........824500
C                                                                        SLAP........824600
C         Unscale R by R0NRM*PROD when KMP < MAXL.                       SLAP........824700
C                                                                        SLAP........824800
            IF ( (KMP.LT.MAXL) .AND. (LGMR.NE.0) ) THEN                  SLAP........824900
               TEM = 1.0D0/(R0NRM*PROD)                                  SLAP........825000
               CALL DSCAL(N, TEM, R, 1)                                  SLAP........825100
            ENDIF                                                        SLAP........825200
C                                                                        SLAP........825300
            FUZZ = D1MACH(1)                                             SLAP........825400
            IELMAX = 1                                                   SLAP........825500
            RATMAX = ABS(DZ(1))/MAX(ABS(X(1)),FUZZ)                      SLAP........825600
            DO 25 I = 2, N                                               SLAP........825700
               RAT = ABS(DZ(I))/MAX(ABS(X(I)),FUZZ)                      SLAP........825800
               IF( RAT.GT.RATMAX ) THEN                                  SLAP........825900
                  IELMAX = I                                             SLAP........826000
                  RATMAX = RAT                                           SLAP........826100
               ENDIF                                                     SLAP........826200
 25         CONTINUE                                                     SLAP........826300
            ERR = RATMAX                                                 SLAP........826400
            IF( RATMAX.LE.TOL ) ISDGMR = 1                               SLAP........826500
            IF( IUNIT.GT.0 ) WRITE(IUNIT,1020) ITER, IELMAX, RATMAX      SLAP........826600
            RETURN                                                       SLAP........826700
         ENDIF                                                           SLAP........826800
      ENDIF                                                              SLAP........826900
      IF ( ITOL.EQ.11 ) THEN                                             SLAP........827000
C                                                                        SLAP........827100
C       Use DXLCAL to calculate the approximate solution XL.             SLAP........827200
C                                                                        SLAP........827300
         IF ( (LGMR.NE.0) .AND. (ITER.GT.0) ) THEN                       SLAP........827400
            CALL DXLCAL(N, LGMR, X, XL, XL, HES, MAXLP1, Q, V, R0NRM,    SLAP........827500
     $           DZ, SX, JSCAL, JPRE, MSOLVE, NMSL, RWORK, IWORK,        SLAP........827600
     $           NELT, IA, JA, A, ISYM)                                  SLAP........827700
         ELSEIF ( ITER.EQ.0 ) THEN                                       SLAP........827800
C         Copy X to XL to check if initial guess is good enough.         SLAP........827900
            CALL DCOPY(N, X, 1, XL, 1)                                   SLAP........828000
         ELSE                                                            SLAP........828100
C         Return since this is the first call to DPIGMR on a restart.    SLAP........828200
            RETURN                                                       SLAP........828300
         ENDIF                                                           SLAP........828400
C                                                                        SLAP........828500
         IF ((JSCAL .EQ. 0) .OR.(JSCAL .EQ. 2)) THEN                     SLAP........828600
C         err = ||x-TrueSolution||/||TrueSolution||(2-Norms).            SLAP........828700
            IF ( ITER.EQ.0 ) SOLNRM = DNRM2(N, SOLN, 1)                  SLAP........828800
            DO 30 I = 1, N                                               SLAP........828900
               DZ(I) = XL(I) - SOLN(I)                                   SLAP........829000
 30         CONTINUE                                                     SLAP........829100
            ERR = DNRM2(N, DZ, 1)/SOLNRM                                 SLAP........829200
         ELSE                                                            SLAP........829300
            IF (ITER .EQ. 0) THEN                                        SLAP........829400
               SOLNRM = 0                                                SLAP........829500
               DO 40 I = 1,N                                             SLAP........829600
                  SOLNRM = SOLNRM + (SX(I)*SOLN(I))**2                   SLAP........829700
 40            CONTINUE                                                  SLAP........829800
               SOLNRM = SQRT(SOLNRM)                                     SLAP........829900
            ENDIF                                                        SLAP........830000
            DXNRM = 0                                                    SLAP........830100
            DO 50 I = 1,N                                                SLAP........830200
               DXNRM = DXNRM + (SX(I)*(XL(I)-SOLN(I)))**2                SLAP........830300
 50         CONTINUE                                                     SLAP........830400
            DXNRM = SQRT(DXNRM)                                          SLAP........830500
C         err = ||SX*(x-TrueSolution)||/||SX*TrueSolution|| (2-Norms).   SLAP........830600
            ERR = DXNRM/SOLNRM                                           SLAP........830700
         ENDIF                                                           SLAP........830800
      ENDIF                                                              SLAP........830900
C                                                                        SLAP........831000
CM    CANCEL OUT OUTPUT TO THE .SMY FILE FOR GMRES ALGORITHM
CM      IF( IUNIT.NE.0 ) THEN                                              SLAP........831100
CM         IF( ITER.EQ.0 ) THEN                                            SLAP........831200
C...........THE NEXT LINE OF CODE WAS MODIFIED DURING INTEGRATION        SLAP........831300
C              OF SLAP WITH SUTRA.  IT ORIGINALLY READ:                  SLAP........831400
C              WRITE(IUNIT,1000) N, ITOL, MAXL, KMP                      SLAP........831500
CM            WRITE(IUNIT,1000)                                            SLAP........831600
CM         ENDIF                                                           SLAP........831700
C........THE NEXT LINE OF CODE WAS MODIFIED DURING INTEGRATION           SLAP........831800
C           OF SLAP WITH SUTRA.  IT ORIGINALLY READ:                     SLAP........831900
C           WRITE(IUNIT,1010) ITER, RNRM/BNRM, ERR                       SLAP........832000
CM         WRITE(IUNIT,1010) ITER, ERR                                     SLAP........832100
CM      ENDIF                                                              SLAP........832200
      IF ( ERR.LE.TOL ) ISDGMR = 1                                       SLAP........832300
C                                                                        SLAP........832400
      RETURN                                                             SLAP........832500
C.....THE NEXT TWO LINES OF CODE REFLECT MODIFICATIONS MADE DURING       SLAP........832600
C        INTEGRATION FO SLAP WITH SUTRA.  THEY ORIGINALLY READ:          SLAP........832700
C        1000 FORMAT(' Generalized Minimum Residual(',I3,I3,') for ',    SLAP........832800
C            $     'N, ITOL = ',I5, I5,                                  SLAP........832900
C            $     /' ITER','   Natural Err Est','   Error Estimate')    SLAP........833000
C        1010 FORMAT(1X,I4,1X,D16.7,1X,D16.7)                            SLAP........833100
1000  FORMAT(1X,6X,'Solver Iteration','   Error Estimate')               SLAP........833200
1010  FORMAT(1X,6X,I16,1X,1PE16.7)                                       SLAP........833300
 1020 FORMAT(1X,' ITER = ',I5, ' IELMAX = ',I5,                          SLAP........833400
     $     ' |R(IELMAX)/X(IELMAX)| = ',D12.5)                            SLAP........833500
C------------- LAST LINE OF ISDGMR FOLLOWS ----------------------------  SLAP........833600
      END                                                                SLAP........833700
*DECK ISDOMN                                                             SLAP........833800
      INTEGER FUNCTION ISDOMN (N, B, X, NELT, IA, JA, A, ISYM, MSOLVE,   SLAP........833900
     +   NSAVE, ITOL, TOL, ITMAX, ITER, ERR, IERR, IUNIT, R, Z, P, AP,   SLAP........834000
     +   EMAP, DZ, CSAV, RWORK, IWORK, AK, BNRM, SOLNRM)                 SLAP........834100
C***BEGIN PROLOGUE  ISDOMN                                               SLAP........834200
C***SUBSIDIARY                                                           SLAP........834300
C***PURPOSE  Preconditioned Orthomin Stop Test.                          SLAP........834400
C            This routine calculates the stop test for the Orthomin      SLAP........834500
C            iteration scheme.  It returns a non-zero if the error       SLAP........834600
C            estimate (the type of which is determined by ITOL) is       SLAP........834700
C            less than the user specified tolerance TOL.                 SLAP........834800
C***LIBRARY   SLATEC (SLAP)                                              SLAP........834900
C***CATEGORY  D2A4, D2B4                                                 SLAP........835000
C***TYPE      DOUBLE PRECISION (ISSOMN-S, ISDOMN-D)                      SLAP........835100
C***KEYWORDS  ITERATIVE PRECONDITION, NON-SYMMETRIC LINEAR SYSTEM,       SLAP........835200
C             ORTHOMIN, SLAP, SPARSE, STOP TEST                          SLAP........835300
C***AUTHOR  Greenbaum, Anne, (Courant Institute)                         SLAP........835400
C           Seager, Mark K., (LLNL)                                      SLAP........835500
C             Lawrence Livermore National Laboratory                     SLAP........835600
C             PO BOX 808, L-60                                           SLAP........835700
C             Livermore, CA 94550 (510) 423-3141                         SLAP........835800
C             seager@llnl.gov                                            SLAP........835900
C***DESCRIPTION                                                          SLAP........836000
C                                                                        SLAP........836100
C *Usage:                                                                SLAP........836200
C     INTEGER  N, NELT, IA(NELT), JA(NELT), ISYM, NSAVE, ITOL, ITMAX     SLAP........836300
C     INTEGER  ITER, IERR, IUNIT, IWORK(USER DEFINED)                    SLAP........836400
C     DOUBLE PRECISION B(N), X(N), A(NELT), TOL, ERR, R(N), Z(N)         SLAP........836500
C     DOUBLE PRECISION P(N,0:NSAVE), AP(N,0:NSAVE), EMAP(N,0:NSAVE)      SLAP........836600
C     DOUBLE PRECISION DZ(N), CSAV(NSAVE), RWORK(USER DEFINED), AK       SLAP........836700
C     DOUBLE PRECISION BNRM, SOLNRM                                      SLAP........836800
C     EXTERNAL MSOLVE                                                    SLAP........836900
C                                                                        SLAP........837000
C     IF( ISDOMN(N, B, X, NELT, IA, JA, A, ISYM, MSOLVE, NSAVE,          SLAP........837100
C    $     ITOL, TOL, ITMAX, ITER, ERR, IERR, IUNIT, R, Z, P, AP,        SLAP........837200
C    $     EMAP, DZ, CSAV, RWORK, IWORK, AK, BNRM, SOLNRM)               SLAP........837300
C    $     .NE.0 ) THEN ITERATION CONVERGED                              SLAP........837400
C                                                                        SLAP........837500
C *Arguments:                                                            SLAP........837600
C N      :IN       Integer.                                              SLAP........837700
C         Order of the matrix.                                           SLAP........837800
C B      :IN       Double Precision B(N).                                SLAP........837900
C         Right-hand side vector.                                        SLAP........838000
C X      :IN       Double Precision X(N).                                SLAP........838100
C         On input X is your initial guess for solution vector.          SLAP........838200
C         On output X is the final approximate solution.                 SLAP........838300
C NELT   :IN       Integer.                                              SLAP........838400
C         Number of Non-Zeros stored in A.                               SLAP........838500
C IA     :IN       Integer IA(NELT).                                     SLAP........838600
C JA     :IN       Integer JA(NELT).                                     SLAP........838700
C A      :IN       Double Precision A(NELT).                             SLAP........838800
C         These arrays should hold the matrix A in either the SLAP       SLAP........838900
C         Triad format or the SLAP Column format.  See "Description"     SLAP........839000
C         in the DSDOMN or DSLUOM prologue.                              SLAP........839100
C ISYM   :IN       Integer.                                              SLAP........839200
C         Flag to indicate symmetric storage format.                     SLAP........839300
C         If ISYM=0, all non-zero entries of the matrix are stored.      SLAP........839400
C         If ISYM=1, the matrix is symmetric, and only the upper         SLAP........839500
C         or lower triangle of the matrix is stored.                     SLAP........839600
C MSOLVE :EXT      External.                                             SLAP........839700
C         Name of a routine which solves a linear system MZ = R for      SLAP........839800
C         Z given R with the preconditioning matrix M (M is supplied via SLAP........839900
C         RWORK and IWORK arrays).  The name of the MSOLVE routine must  SLAP........840000
C         be declared external in the calling program.  The calling      SLAP........840100
C         sequence to MSOLVE is:                                         SLAP........840200
C             CALL MSOLVE(N, R, Z, NELT, IA, JA, A, ISYM, RWORK, IWORK)  SLAP........840300
C         Where N is the number of unknowns, R is the right-hand side    SLAP........840400
C         vector and Z is the solution upon return.  NELT, IA, JA, A and SLAP........840500
C         ISYM are defined as above.  RWORK is a double precision array  SLAP........840600
C         that can be used to pass necessary preconditioning information SLAP........840700
C         and/or workspace to MSOLVE.  IWORK is an integer work array    SLAP........840800
C         for the same purpose as RWORK.                                 SLAP........840900
C NSAVE  :IN       Integer.                                              SLAP........841000
C         Number of direction vectors to save and orthogonalize against. SLAP........841100
C ITOL   :IN       Integer.                                              SLAP........841200
C         Flag to indicate type of convergence criterion.                SLAP........841300
C         If ITOL=1, iteration stops when the 2-norm of the residual     SLAP........841400
C         divided by the 2-norm of the right-hand side is less than TOL. SLAP........841500
C         If ITOL=2, iteration stops when the 2-norm of M-inv times the  SLAP........841600
C         residual divided by the 2-norm of M-inv times the right hand   SLAP........841700
C         side is less than TOL, where M-inv is the inverse of the       SLAP........841800
C         diagonal of A.                                                 SLAP........841900
C         ITOL=11 is often useful for checking and comparing different   SLAP........842000
C         routines.  For this case, the user must supply the "exact"     SLAP........842100
C         solution or a very accurate approximation (one with an error   SLAP........842200
C         much less than TOL) through a common block,                    SLAP........842300
C             COMMON /DSLBLK/ SOLN( )                                    SLAP........842400
C         If ITOL=11, iteration stops when the 2-norm of the difference  SLAP........842500
C         between the iterative approximation and the user-supplied      SLAP........842600
C         solution divided by the 2-norm of the user-supplied solution   SLAP........842700
C         is less than TOL.  Note that this requires the user to set up  SLAP........842800
C         the "COMMON /DSLBLK/ SOLN(LENGTH)" in the calling routine.     SLAP........842900
C         The routine with this declaration should be loaded before the  SLAP........843000
C         stop test so that the correct length is used by the loader.    SLAP........843100
C         This procedure is not standard Fortran and may not work        SLAP........843200
C         correctly on your system (although it has worked on every      SLAP........843300
C         system the authors have tried).  If ITOL is not 11 then this   SLAP........843400
C         common block is indeed standard Fortran.                       SLAP........843500
C TOL    :IN       Double Precision.                                     SLAP........843600
C         Convergence criterion, as described above.                     SLAP........843700
C ITMAX  :IN       Integer.                                              SLAP........843800
C         Maximum number of iterations.                                  SLAP........843900
C ITER   :IN       Integer.                                              SLAP........844000
C         Current iteration count.  (Must be zero on first call.)        SLAP........844100
C ERR    :OUT      Double Precision.                                     SLAP........844200
C         Error estimate of error in final approximate solution, as      SLAP........844300
C         defined by ITOL.                                               SLAP........844400
C IERR   :OUT      Integer.                                              SLAP........844500
C         Error flag.  IERR is set to 3 if ITOL is not one of the        SLAP........844600
C         acceptable values, see above.                                  SLAP........844700
C IUNIT  :IN       Integer.                                              SLAP........844800
C         Unit number on which to write the error at each iteration,     SLAP........844900
C         if this is desired for monitoring convergence.  If unit        SLAP........845000
C         number is 0, no writing will occur.                            SLAP........845100
C R      :IN       Double Precision R(N).                                SLAP........845200
C         The residual R = B-AX.                                         SLAP........845300
C Z      :WORK     Double Precision Z(N).                                SLAP........845400
C P      :IN       Double Precision P(N,0:NSAVE).                        SLAP........845500
C         Workspace used to hold the conjugate direction vector(s).      SLAP........845600
C AP     :IN       Double Precision AP(N,0:NSAVE).                       SLAP........845700
C         Workspace used to hold the matrix A times the P vector(s).     SLAP........845800
C EMAP   :IN       Double Precision EMAP(N,0:NSAVE).                     SLAP........845900
C         Workspace used to hold M-inv times the AP vector(s).           SLAP........846000
C DZ     :WORK     Double Precision DZ(N).                               SLAP........846100
C         Workspace.                                                     SLAP........846200
C CSAV   :DUMMY    Double Precision CSAV(NSAVE)                          SLAP........846300
C         Reserved for future use.                                       SLAP........846400
C RWORK  :WORK     Double Precision RWORK(USER DEFINED).                 SLAP........846500
C         Double Precision array that can be used for workspace in       SLAP........846600
C         MSOLVE.                                                        SLAP........846700
C IWORK  :WORK     Integer IWORK(USER DEFINED).                          SLAP........846800
C         Integer array that can be used for workspace in MSOLVE.        SLAP........846900
C AK     :IN       Double Precision.                                     SLAP........847000
C         Current iterate Orthomin iteration parameter.                  SLAP........847100
C BNRM   :OUT      Double Precision.                                     SLAP........847200
C         Current solution B-norm, if ITOL = 1 or 2.                     SLAP........847300
C SOLNRM :OUT      Double Precision.                                     SLAP........847400
C         True solution norm, if ITOL = 11.                              SLAP........847500
C                                                                        SLAP........847600
C *Function Return Values:                                               SLAP........847700
C       0 : Error estimate (determined by ITOL) is *NOT* less than the   SLAP........847800
C           specified tolerance, TOL.  The iteration must continue.      SLAP........847900
C       1 : Error estimate (determined by ITOL) is less than the         SLAP........848000
C           specified tolerance, TOL.  The iteration can be considered   SLAP........848100
C           complete.                                                    SLAP........848200
C                                                                        SLAP........848300
C *Cautions:                                                             SLAP........848400
C     This routine will attempt to write to the Fortran logical output   SLAP........848500
C     unit IUNIT, if IUNIT .ne. 0.  Thus, the user must make sure that   SLAP........848600
C     this logical unit is attached to a file or terminal before calling SLAP........848700
C     this routine with a non-zero value for IUNIT.  This routine does   SLAP........848800
C     not check for the validity of a non-zero IUNIT unit number.        SLAP........848900
C                                                                        SLAP........849000
C***SEE ALSO  DOMN, DSDOMN, DSLUOM                                       SLAP........849100
C***ROUTINES CALLED  D1MACH, DNRM2                                       SLAP........849200
C***COMMON BLOCKS    DSLBLK                                              SLAP........849300
C***REVISION HISTORY  (YYMMDD)                                           SLAP........849400
C   890404  DATE WRITTEN                                                 SLAP........849500
C   890404  Previous REVISION DATE                                       SLAP........849600
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........849700
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........849800
C           standard.  (FNF)                                             SLAP........849900
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........850000
C   891003  Removed C***REFER TO line, per MKS.                          SLAP........850100
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........850200
C   910502  Removed MSOLVE from ROUTINES CALLED list.  (FNF)             SLAP........850300
C   910506  Made subsidiary to DOMN.  (FNF)                              SLAP........850400
C   920407  COMMON BLOCK renamed DSLBLK.  (WRB)                          SLAP........850500
C   920511  Added complete declaration section.  (WRB)                   SLAP........850600
C   920930  Corrected to not print AK when ITER=0.  (FNF)                SLAP........850700
C   921026  Changed 1.0E10 to D1MACH(2) and corrected D to E in          SLAP........850800
C           output format.  (FNF)                                        SLAP........850900
C   921113  Corrected C***CATEGORY line.  (FNF)                          SLAP........851000
C***END PROLOGUE  ISDOMN                                                 SLAP........851100
C     .. Scalar Arguments ..                                             SLAP........851200
      DOUBLE PRECISION AK, BNRM, ERR, SOLNRM, TOL                        SLAP........851300
      INTEGER IERR, ISYM, ITER, ITMAX, ITOL, IUNIT, N, NELT, NSAVE       SLAP........851400
C     .. Array Arguments ..                                              SLAP........851500
      DOUBLE PRECISION A(NELT), AP(N,0:NSAVE), B(N), CSAV(NSAVE),        SLAP........851600
     +                 DZ(N), EMAP(N,0:NSAVE), P(N,0:NSAVE), R(N),       SLAP........851700
     +                 RWORK(*), X(N), Z(N)                              SLAP........851800
      INTEGER IA(NELT), IWORK(*), JA(NELT)                               SLAP........851900
C     .. Subroutine Arguments ..                                         SLAP........852000
      EXTERNAL MSOLVE                                                    SLAP........852100
C     .. Arrays in Common ..                                             SLAP........852200
      DOUBLE PRECISION SOLN(1)                                           SLAP........852300
C     .. Local Scalars ..                                                SLAP........852400
      INTEGER I                                                          SLAP........852500
C     .. External Functions ..                                           SLAP........852600
      DOUBLE PRECISION D1MACH, DNRM2                                     SLAP........852700
      EXTERNAL D1MACH, DNRM2                                             SLAP........852800
C     .. Common blocks ..                                                SLAP........852900
      COMMON /DSLBLK/ SOLN                                               SLAP........853000
C***FIRST EXECUTABLE STATEMENT  ISDOMN                                   SLAP........853100
      ISDOMN = 0                                                         SLAP........853200
C                                                                        SLAP........853300
      IF( ITOL.EQ.1 ) THEN                                               SLAP........853400
C         err = ||Residual||/||RightHandSide|| (2-Norms).                SLAP........853500
         IF(ITER .EQ. 0) BNRM = DNRM2(N, B, 1)                           SLAP........853600
         ERR = DNRM2(N, R, 1)/BNRM                                       SLAP........853700
      ELSE IF( ITOL.EQ.2 ) THEN                                          SLAP........853800
C                  -1              -1                                    SLAP........853900
C         err = ||M  Residual||/||M  RightHandSide|| (2-Norms).          SLAP........854000
         IF(ITER .EQ. 0) THEN                                            SLAP........854100
            CALL MSOLVE(N, B, DZ, NELT, IA, JA, A, ISYM, RWORK, IWORK)   SLAP........854200
            BNRM = DNRM2(N, DZ, 1)                                       SLAP........854300
         ENDIF                                                           SLAP........854400
         ERR = DNRM2(N, Z, 1)/BNRM                                       SLAP........854500
      ELSE IF( ITOL.EQ.11 ) THEN                                         SLAP........854600
C         err = ||x-TrueSolution||/||TrueSolution|| (2-Norms).           SLAP........854700
         IF(ITER .EQ. 0) SOLNRM = DNRM2(N, SOLN, 1)                      SLAP........854800
         DO 10 I = 1, N                                                  SLAP........854900
            DZ(I) = X(I) - SOLN(I)                                       SLAP........855000
 10      CONTINUE                                                        SLAP........855100
         ERR = DNRM2(N, DZ, 1)/SOLNRM                                    SLAP........855200
      ELSE                                                               SLAP........855300
C                                                                        SLAP........855400
C         If we get here ITOL is not one of the acceptable values.       SLAP........855500
         ERR = D1MACH(2)                                                 SLAP........855600
         IERR = 3                                                        SLAP........855700
      ENDIF                                                              SLAP........855800
C                                                                        SLAP........855900
C.....THE BLOCK IF STATEMENT THAT IMMEDIATELY FOLLOWS THIS COMMMENT      SLAP........856000
C        WAS MODIFIED DURING INTEGRATION OF SLAP WITH SUTRA.  IT         SLAP........856100
C        ORIGINALLY READ:                                                SLAP........856200
C        IF(IUNIT .NE. 0) THEN                                           SLAP........856300
C           IF( ITER.EQ.0 ) THEN                                         SLAP........856400
C              WRITE(IUNIT,1000) NSAVE, N, ITOL                          SLAP........856500
C              WRITE(IUNIT,1010) ITER, ERR                               SLAP........856600
C           ELSE                                                         SLAP........856700
C              WRITE(IUNIT,1010) ITER, ERR, AK                           SLAP........856800
C           ENDIF                                                        SLAP........856900
C        ENDIF                                                           SLAP........857000
CM  CANCEL OUTPUT TO .SMY FILE FOR ORTHOMIN ALGORITHM
CM      IF(IUNIT .NE. 0) THEN                                              SLAP........857100
CM         IF( ITER.EQ.0 ) WRITE(IUNIT,1000)                               SLAP........857200
CM         WRITE(IUNIT,1010) ITER, ERR                                     SLAP........857300
CM      ENDIF                                                              SLAP........857400
      IF(ERR .LE. TOL) ISDOMN = 1                                        SLAP........857500
C                                                                        SLAP........857600
      RETURN                                                             SLAP........857700
C.....THE NEXT TWO LINES OF CODE REFLECT MODIFICATIONS MADE DURING       SLAP........857800
C        INTEGRATION OF SLAP WITH SUTRA.  THEY ORIGINALLY READ:          SLAP........857900
C        1000 FORMAT(' Preconditioned Orthomin(',I3,') for ',            SLAP........858000
C            $     'N, ITOL = ',I5, I5,                                  SLAP........858100
C            $     /' ITER','   Error Estimate','            Alpha')     SLAP........858200
C        1010 FORMAT(1X,I4,1X,D16.7,1X,D16.7)                            SLAP........858300
1000  FORMAT(1X,6X,'Solver Iteration','   Error Estimate')               SLAP........858400
1010  FORMAT(1X,6X,I16,1X,1PE16.7)                                       SLAP........858500
C------------- LAST LINE OF ISDOMN FOLLOWS ----------------------------  SLAP........858600
      END                                                                SLAP........858700
*DECK J4SAVE                                                             SLAP........858800
      FUNCTION J4SAVE (IWHICH, IVALUE, ISET)                             SLAP........858900
C***BEGIN PROLOGUE  J4SAVE                                               SLAP........859000
C***SUBSIDIARY                                                           SLAP........859100
C***PURPOSE  Save or recall global variables needed by error             SLAP........859200
C            handling routines.                                          SLAP........859300
C***LIBRARY   SLATEC (XERROR)                                            SLAP........859400
C***TYPE      INTEGER (J4SAVE-I)                                         SLAP........859500
C***KEYWORDS  ERROR MESSAGES, ERROR NUMBER, RECALL, SAVE, XERROR         SLAP........859600
C***AUTHOR  Jones, R. E., (SNLA)                                         SLAP........859700
C***DESCRIPTION                                                          SLAP........859800
C                                                                        SLAP........859900
C     Abstract                                                           SLAP........860000
C        J4SAVE saves and recalls several global variables needed        SLAP........860100
C        by the library error handling routines.                         SLAP........860200
C                                                                        SLAP........860300
C     Description of Parameters                                          SLAP........860400
C      --Input--                                                         SLAP........860500
C        IWHICH - Index of item desired.                                 SLAP........860600
C                = 1 Refers to current error number.                     SLAP........860700
C                = 2 Refers to current error control flag.               SLAP........860800
C                = 3 Refers to current unit number to which error        SLAP........860900
C                    messages are to be sent.  (0 means use standard.)   SLAP........861000
C                = 4 Refers to the maximum number of times any           SLAP........861100
C                     message is to be printed (as set by XERMAX).       SLAP........861200
C                = 5 Refers to the total number of units to which        SLAP........861300
C                     each error message is to be written.               SLAP........861400
C                = 6 Refers to the 2nd unit for error messages           SLAP........861500
C                = 7 Refers to the 3rd unit for error messages           SLAP........861600
C                = 8 Refers to the 4th unit for error messages           SLAP........861700
C                = 9 Refers to the 5th unit for error messages           SLAP........861800
C        IVALUE - The value to be set for the IWHICH-th parameter,       SLAP........861900
C                 if ISET is .TRUE. .                                    SLAP........862000
C        ISET   - If ISET=.TRUE., the IWHICH-th parameter will BE        SLAP........862100
C                 given the value, IVALUE.  If ISET=.FALSE., the         SLAP........862200
C                 IWHICH-th parameter will be unchanged, and IVALUE      SLAP........862300
C                 is a dummy parameter.                                  SLAP........862400
C      --Output--                                                        SLAP........862500
C        The (old) value of the IWHICH-th parameter will be returned     SLAP........862600
C        in the function value, J4SAVE.                                  SLAP........862700
C                                                                        SLAP........862800
C***SEE ALSO  XERMSG                                                     SLAP........862900
C***REFERENCES  R. E. Jones and D. K. Kahaner, XERROR, the SLATEC        SLAP........863000
C                 Error-handling Package, SAND82-0800, Sandia            SLAP........863100
C                 Laboratories, 1982.                                    SLAP........863200
C***ROUTINES CALLED  (NONE)                                              SLAP........863300
C***REVISION HISTORY  (YYMMDD)                                           SLAP........863400
C   790801  DATE WRITTEN                                                 SLAP........863500
C   891214  Prologue converted to Version 4.0 format.  (BAB)             SLAP........863600
C   900205  Minor modifications to prologue.  (WRB)                      SLAP........863700
C   900402  Added TYPE section.  (WRB)                                   SLAP........863800
C   910411  Added KEYWORDS section.  (WRB)                               SLAP........863900
C   920501  Reformatted the REFERENCES section.  (WRB)                   SLAP........864000
C***END PROLOGUE  J4SAVE                                                 SLAP........864100
      LOGICAL ISET                                                       SLAP........864200
      INTEGER IPARAM(9)                                                  SLAP........864300
      SAVE IPARAM                                                        SLAP........864400
      DATA IPARAM(1),IPARAM(2),IPARAM(3),IPARAM(4)/0,2,0,10/             SLAP........864500
      DATA IPARAM(5)/1/                                                  SLAP........864600
      DATA IPARAM(6),IPARAM(7),IPARAM(8),IPARAM(9)/0,0,0,0/              SLAP........864700
C***FIRST EXECUTABLE STATEMENT  J4SAVE                                   SLAP........864800
      J4SAVE = IPARAM(IWHICH)                                            SLAP........864900
      IF (ISET) IPARAM(IWHICH) = IVALUE                                  SLAP........865000
      RETURN                                                             SLAP........865100
      END                                                                SLAP........865200
*DECK QS2I1D                                                             SLAP........865300
      SUBROUTINE QS2I1D (IA, JA, A, N, KFLAG)                            SLAP........865400
C***BEGIN PROLOGUE  QS2I1D                                               SLAP........865500
C***SUBSIDIARY                                                           SLAP........865600
C***PURPOSE  Sort an integer array, moving an integer and DP array.      SLAP........865700
C            This routine sorts the integer array IA and makes the same  SLAP........865800
C            interchanges in the integer array JA and the double pre-    SLAP........865900
C            cision array A.  The array IA may be sorted in increasing   SLAP........866000
C            order or decreasing order.  A slightly modified QUICKSORT   SLAP........866100
C            algorithm is used.                                          SLAP........866200
C***LIBRARY   SLATEC (SLAP)                                              SLAP........866300
C***CATEGORY  N6A2A                                                      SLAP........866400
C***TYPE      DOUBLE PRECISION (QS2I1R-S, QS2I1D-D)                      SLAP........866500
C***KEYWORDS  SINGLETON QUICKSORT, SLAP, SORT, SORTING                   SLAP........866600
C***AUTHOR  Jones, R. E., (SNLA)                                         SLAP........866700
C           Kahaner, D. K., (NBS)                                        SLAP........866800
C           Seager, M. K., (LLNL) seager@llnl.gov                        SLAP........866900
C           Wisniewski, J. A., (SNLA)                                    SLAP........867000
C***DESCRIPTION                                                          SLAP........867100
C     Written by Rondall E Jones                                         SLAP........867200
C     Modified by John A. Wisniewski to use the Singleton QUICKSORT      SLAP........867300
C     algorithm. date 18 November 1976.                                  SLAP........867400
C                                                                        SLAP........867500
C     Further modified by David K. Kahaner                               SLAP........867600
C     National Bureau of Standards                                       SLAP........867700
C     August, 1981                                                       SLAP........867800
C                                                                        SLAP........867900
C     Even further modification made to bring the code up to the         SLAP........868000
C     Fortran 77 level and make it more readable and to carry            SLAP........868100
C     along one integer array and one double precision array during      SLAP........868200
C     the sort by                                                        SLAP........868300
C     Mark K. Seager                                                     SLAP........868400
C     Lawrence Livermore National Laboratory                             SLAP........868500
C     November, 1987                                                     SLAP........868600
C     This routine was adapted from the ISORT routine.                   SLAP........868700
C                                                                        SLAP........868800
C     ABSTRACT                                                           SLAP........868900
C         This routine sorts an integer array IA and makes the same      SLAP........869000
C         interchanges in the integer array JA and the double precision  SLAP........869100
C         array A.                                                       SLAP........869200
C         The array IA may be sorted in increasing order or decreasing   SLAP........869300
C         order.  A slightly modified quicksort algorithm is used.       SLAP........869400
C                                                                        SLAP........869500
C     DESCRIPTION OF PARAMETERS                                          SLAP........869600
C        IA - Integer array of values to be sorted.                      SLAP........869700
C        JA - Integer array to be carried along.                         SLAP........869800
C         A - Double Precision array to be carried along.                SLAP........869900
C         N - Number of values in integer array IA to be sorted.         SLAP........870000
C     KFLAG - Control parameter                                          SLAP........870100
C           = 1 means sort IA in INCREASING order.                       SLAP........870200
C           =-1 means sort IA in DECREASING order.                       SLAP........870300
C                                                                        SLAP........870400
C***SEE ALSO  DS2Y                                                       SLAP........870500
C***REFERENCES  R. C. Singleton, Algorithm 347, An Efficient Algorithm   SLAP........870600
C                 for Sorting With Minimal Storage, Communications ACM   SLAP........870700
C                 12:3 (1969), pp.185-7.                                 SLAP........870800
C***ROUTINES CALLED  XERMSG                                              SLAP........870900
C***REVISION HISTORY  (YYMMDD)                                           SLAP........871000
C   761118  DATE WRITTEN                                                 SLAP........871100
C   890125  Previous REVISION DATE                                       SLAP........871200
C   890915  Made changes requested at July 1989 CML Meeting.  (MKS)      SLAP........871300
C   890922  Numerous changes to prologue to make closer to SLATEC        SLAP........871400
C           standard.  (FNF)                                             SLAP........871500
C   890929  Numerous changes to reduce SP/DP differences.  (FNF)         SLAP........871600
C   900805  Changed XERROR calls to calls to XERMSG.  (RWC)              SLAP........871700
C   910411  Prologue converted to Version 4.0 format.  (BAB)             SLAP........871800
C   910506  Made subsidiary to DS2Y and corrected reference.  (FNF)      SLAP........871900
C   920511  Added complete declaration section.  (WRB)                   SLAP........872000
C   920929  Corrected format of reference.  (FNF)                        SLAP........872100
C   921012  Corrected all f.p. constants to double precision.  (FNF)     SLAP........872200
C***END PROLOGUE  QS2I1D                                                 SLAP........872300
CVD$R NOVECTOR                                                           SLAP........872400
CVD$R NOCONCUR                                                           SLAP........872500
C     .. Scalar Arguments ..                                             SLAP........872600
      INTEGER KFLAG, N                                                   SLAP........872700
C     .. Array Arguments ..                                              SLAP........872800
      DOUBLE PRECISION A(N)                                              SLAP........872900
      INTEGER IA(N), JA(N)                                               SLAP........873000
C     .. Local Scalars ..                                                SLAP........873100
      DOUBLE PRECISION R, TA, TTA                                        SLAP........873200
      INTEGER I, IIT, IJ, IT, J, JJT, JT, K, KK, L, M, NN                SLAP........873300
C     .. Local Arrays ..                                                 SLAP........873400
      INTEGER IL(21), IU(21)                                             SLAP........873500
C     .. External Subroutines ..                                         SLAP........873600
      EXTERNAL XERMSG                                                    SLAP........873700
C     .. Intrinsic Functions ..                                          SLAP........873800
      INTRINSIC ABS, INT                                                 SLAP........873900
C***FIRST EXECUTABLE STATEMENT  QS2I1D                                   SLAP........874000
      NN = N                                                             SLAP........874100
      IF (NN.LT.1) THEN                                                  SLAP........874200
         CALL XERMSG ('SLATEC', 'QS2I1D',                                SLAP........874300
     $      'The number of values to be sorted was not positive.', 1, 1) SLAP........874400
         RETURN                                                          SLAP........874500
      ENDIF                                                              SLAP........874600
      IF( N.EQ.1 ) RETURN                                                SLAP........874700
      KK = ABS(KFLAG)                                                    SLAP........874800
      IF ( KK.NE.1 ) THEN                                                SLAP........874900
         CALL XERMSG ('SLATEC', 'QS2I1D',                                SLAP........875000
     $      'The sort control parameter, K, was not 1 or -1.', 2, 1)     SLAP........875100
         RETURN                                                          SLAP........875200
      ENDIF                                                              SLAP........875300
C                                                                        SLAP........875400
C     Alter array IA to get decreasing order if needed.                  SLAP........875500
C                                                                        SLAP........875600
      IF( KFLAG.LT.1 ) THEN                                              SLAP........875700
         DO 20 I=1,NN                                                    SLAP........875800
            IA(I) = -IA(I)                                               SLAP........875900
 20      CONTINUE                                                        SLAP........876000
      ENDIF                                                              SLAP........876100
C                                                                        SLAP........876200
C     Sort IA and carry JA and A along.                                  SLAP........876300
C     And now...Just a little black magic...                             SLAP........876400
      M = 1                                                              SLAP........876500
      I = 1                                                              SLAP........876600
      J = NN                                                             SLAP........876700
      R = .375D0                                                         SLAP........876800
 210  IF( R.LE.0.5898437D0 ) THEN                                        SLAP........876900
         R = R + 3.90625D-2                                              SLAP........877000
      ELSE                                                               SLAP........877100
         R = R-.21875D0                                                  SLAP........877200
      ENDIF                                                              SLAP........877300
 225  K = I                                                              SLAP........877400
C                                                                        SLAP........877500
C     Select a central element of the array and save it in location      SLAP........877600
C     it, jt, at.                                                        SLAP........877700
C                                                                        SLAP........877800
      IJ = I + INT ((J-I)*R)                                             SLAP........877900
      IT = IA(IJ)                                                        SLAP........878000
      JT = JA(IJ)                                                        SLAP........878100
      TA = A(IJ)                                                         SLAP........878200
C                                                                        SLAP........878300
C     If first element of array is greater than it, interchange with it. SLAP........878400
C                                                                        SLAP........878500
      IF( IA(I).GT.IT ) THEN                                             SLAP........878600
         IA(IJ) = IA(I)                                                  SLAP........878700
         IA(I)  = IT                                                     SLAP........878800
         IT     = IA(IJ)                                                 SLAP........878900
         JA(IJ) = JA(I)                                                  SLAP........879000
         JA(I)  = JT                                                     SLAP........879100
         JT     = JA(IJ)                                                 SLAP........879200
         A(IJ)  = A(I)                                                   SLAP........879300
         A(I)   = TA                                                     SLAP........879400
         TA     = A(IJ)                                                  SLAP........879500
      ENDIF                                                              SLAP........879600
      L=J                                                                SLAP........879700
C                                                                        SLAP........879800
C     If last element of array is less than it, swap with it.            SLAP........879900
C                                                                        SLAP........880000
      IF( IA(J).LT.IT ) THEN                                             SLAP........880100
         IA(IJ) = IA(J)                                                  SLAP........880200
         IA(J)  = IT                                                     SLAP........880300
         IT     = IA(IJ)                                                 SLAP........880400
         JA(IJ) = JA(J)                                                  SLAP........880500
         JA(J)  = JT                                                     SLAP........880600
         JT     = JA(IJ)                                                 SLAP........880700
         A(IJ)  = A(J)                                                   SLAP........880800
         A(J)   = TA                                                     SLAP........880900
         TA     = A(IJ)                                                  SLAP........881000
C                                                                        SLAP........881100
C     If first element of array is greater than it, swap with it.        SLAP........881200
C                                                                        SLAP........881300
         IF ( IA(I).GT.IT ) THEN                                         SLAP........881400
            IA(IJ) = IA(I)                                               SLAP........881500
            IA(I)  = IT                                                  SLAP........881600
            IT     = IA(IJ)                                              SLAP........881700
            JA(IJ) = JA(I)                                               SLAP........881800
            JA(I)  = JT                                                  SLAP........881900
            JT     = JA(IJ)                                              SLAP........882000
            A(IJ)  = A(I)                                                SLAP........882100
            A(I)   = TA                                                  SLAP........882200
            TA     = A(IJ)                                               SLAP........882300
         ENDIF                                                           SLAP........882400
      ENDIF                                                              SLAP........882500
C                                                                        SLAP........882600
C     Find an element in the second half of the array which is           SLAP........882700
C     smaller than it.                                                   SLAP........882800
C                                                                        SLAP........882900
  240 L=L-1                                                              SLAP........883000
      IF( IA(L).GT.IT ) GO TO 240                                        SLAP........883100
C                                                                        SLAP........883200
C     Find an element in the first half of the array which is            SLAP........883300
C     greater than it.                                                   SLAP........883400
C                                                                        SLAP........883500
  245 K=K+1                                                              SLAP........883600
      IF( IA(K).LT.IT ) GO TO 245                                        SLAP........883700
C                                                                        SLAP........883800
C     Interchange these elements.                                        SLAP........883900
C                                                                        SLAP........884000
      IF( K.LE.L ) THEN                                                  SLAP........884100
         IIT   = IA(L)                                                   SLAP........884200
         IA(L) = IA(K)                                                   SLAP........884300
         IA(K) = IIT                                                     SLAP........884400
         JJT   = JA(L)                                                   SLAP........884500
         JA(L) = JA(K)                                                   SLAP........884600
         JA(K) = JJT                                                     SLAP........884700
         TTA   = A(L)                                                    SLAP........884800
         A(L)  = A(K)                                                    SLAP........884900
         A(K)  = TTA                                                     SLAP........885000
         GOTO 240                                                        SLAP........885100
      ENDIF                                                              SLAP........885200
C                                                                        SLAP........885300
C     Save upper and lower subscripts of the array yet to be sorted.     SLAP........885400
C                                                                        SLAP........885500
      IF( L-I.GT.J-K ) THEN                                              SLAP........885600
         IL(M) = I                                                       SLAP........885700
         IU(M) = L                                                       SLAP........885800
         I = K                                                           SLAP........885900
         M = M+1                                                         SLAP........886000
      ELSE                                                               SLAP........886100
         IL(M) = K                                                       SLAP........886200
         IU(M) = J                                                       SLAP........886300
         J = L                                                           SLAP........886400
         M = M+1                                                         SLAP........886500
      ENDIF                                                              SLAP........886600
      GO TO 260                                                          SLAP........886700
C                                                                        SLAP........886800
C     Begin again on another portion of the unsorted array.              SLAP........886900
C                                                                        SLAP........887000
  255 M = M-1                                                            SLAP........887100
      IF( M.EQ.0 ) GO TO 300                                             SLAP........887200
      I = IL(M)                                                          SLAP........887300
      J = IU(M)                                                          SLAP........887400
  260 IF( J-I.GE.1 ) GO TO 225                                           SLAP........887500
      IF( I.EQ.J ) GO TO 255                                             SLAP........887600
      IF( I.EQ.1 ) GO TO 210                                             SLAP........887700
      I = I-1                                                            SLAP........887800
  265 I = I+1                                                            SLAP........887900
      IF( I.EQ.J ) GO TO 255                                             SLAP........888000
      IT = IA(I+1)                                                       SLAP........888100
      JT = JA(I+1)                                                       SLAP........888200
      TA =  A(I+1)                                                       SLAP........888300
      IF( IA(I).LE.IT ) GO TO 265                                        SLAP........888400
      K=I                                                                SLAP........888500
  270 IA(K+1) = IA(K)                                                    SLAP........888600
      JA(K+1) = JA(K)                                                    SLAP........888700
      A(K+1)  =  A(K)                                                    SLAP........888800
      K = K-1                                                            SLAP........888900
      IF( IT.LT.IA(K) ) GO TO 270                                        SLAP........889000
      IA(K+1) = IT                                                       SLAP........889100
      JA(K+1) = JT                                                       SLAP........889200
      A(K+1)  = TA                                                       SLAP........889300
      GO TO 265                                                          SLAP........889400
C                                                                        SLAP........889500
C     Clean up, if necessary.                                            SLAP........889600
C                                                                        SLAP........889700
  300 IF( KFLAG.LT.1 ) THEN                                              SLAP........889800
         DO 310 I=1,NN                                                   SLAP........889900
            IA(I) = -IA(I)                                               SLAP........890000
 310     CONTINUE                                                        SLAP........890100
      ENDIF                                                              SLAP........890200
      RETURN                                                             SLAP........890300
C------------- LAST LINE OF QS2I1D FOLLOWS ----------------------------  SLAP........890400
      END                                                                SLAP........890500
*DECK XERCNT                                                             SLAP........890600
      SUBROUTINE XERCNT (LIBRAR, SUBROU, MESSG, NERR, LEVEL, KONTRL)     SLAP........890700
C***BEGIN PROLOGUE  XERCNT                                               SLAP........890800
C***SUBSIDIARY                                                           SLAP........890900
C***PURPOSE  Allow user control over handling of errors.                 SLAP........891000
C***LIBRARY   SLATEC (XERROR)                                            SLAP........891100
C***CATEGORY  R3C                                                        SLAP........891200
C***TYPE      ALL (XERCNT-A)                                             SLAP........891300
C***KEYWORDS  ERROR, XERROR                                              SLAP........891400
C***AUTHOR  Jones, R. E., (SNLA)                                         SLAP........891500
C***DESCRIPTION                                                          SLAP........891600
C                                                                        SLAP........891700
C     Abstract                                                           SLAP........891800
C        Allows user control over handling of individual errors.         SLAP........891900
C        Just after each message is recorded, but before it is           SLAP........892000
C        processed any further (i.e., before it is printed or            SLAP........892100
C        a decision to abort is made), a call is made to XERCNT.         SLAP........892200
C        If the user has provided his own version of XERCNT, he          SLAP........892300
C        can then override the value of KONTROL used in processing       SLAP........892400
C        this message by redefining its value.                           SLAP........892500
C        KONTRL may be set to any value from -2 to 2.                    SLAP........892600
C        The meanings for KONTRL are the same as in XSETF, except        SLAP........892700
C        that the value of KONTRL changes only for this message.         SLAP........892800
C        If KONTRL is set to a value outside the range from -2 to 2,     SLAP........892900
C        it will be moved back into that range.                          SLAP........893000
C                                                                        SLAP........893100
C     Description of Parameters                                          SLAP........893200
C                                                                        SLAP........893300
C      --Input--                                                         SLAP........893400
C        LIBRAR - the library that the routine is in.                    SLAP........893500
C        SUBROU - the subroutine that XERMSG is being called from        SLAP........893600
C        MESSG  - the first 20 characters of the error message.          SLAP........893700
C        NERR   - same as in the call to XERMSG.                         SLAP........893800
C        LEVEL  - same as in the call to XERMSG.                         SLAP........893900
C        KONTRL - the current value of the control flag as set           SLAP........894000
C                 by a call to XSETF.                                    SLAP........894100
C                                                                        SLAP........894200
C      --Output--                                                        SLAP........894300
C        KONTRL - the new value of KONTRL.  If KONTRL is not             SLAP........894400
C                 defined, it will remain at its original value.         SLAP........894500
C                 This changed value of control affects only             SLAP........894600
C                 the current occurrence of the current message.         SLAP........894700
C                                                                        SLAP........894800
C***REFERENCES  R. E. Jones and D. K. Kahaner, XERROR, the SLATEC        SLAP........894900
C                 Error-handling Package, SAND82-0800, Sandia            SLAP........895000
C                 Laboratories, 1982.                                    SLAP........895100
C***ROUTINES CALLED  (NONE)                                              SLAP........895200
C***REVISION HISTORY  (YYMMDD)                                           SLAP........895300
C   790801  DATE WRITTEN                                                 SLAP........895400
C   861211  REVISION DATE from Version 3.2                               SLAP........895500
C   891214  Prologue converted to Version 4.0 format.  (BAB)             SLAP........895600
C   900206  Routine changed from user-callable to subsidiary.  (WRB)     SLAP........895700
C   900510  Changed calling sequence to include LIBRARY and SUBROUTINE   SLAP........895800
C           names, changed routine name from XERCTL to XERCNT.  (RWC)    SLAP........895900
C   920501  Reformatted the REFERENCES section.  (WRB)                   SLAP........896000
C***END PROLOGUE  XERCNT                                                 SLAP........896100
      CHARACTER*(*) LIBRAR, SUBROU, MESSG                                SLAP........896200
C***FIRST EXECUTABLE STATEMENT  XERCNT                                   SLAP........896300
C.....THE NEXT TWO NON-COMMENT LINES (ONE CONTINUED LINE) WERE ADDED     SLAP........896400
C        DURING INTEGRATION OF SLAP WITH SUTRA.  THEY ALLOW THE SOLUTION SLAP........896500
C        PROCESS TO CONTINUE IF THE IC FACTORIZATION FOR THE CG SOLVER   SLAP........896600
C        IS FUDGED.                                                      SLAP........896700
      IF ((LIBRAR.EQ.'SLATEC').AND.(SUBROU.EQ.'DSICCG').AND.             SLAP........896800
     1    (MESSG(1:20).EQ.'IC factorization bro')) KONTRL = 0            SLAP........896900
      RETURN                                                             SLAP........897000
      END                                                                SLAP........897100
*DECK XERHLT                                                             SLAP........897200
      SUBROUTINE XERHLT (MESSG)                                          SLAP........897300
C***BEGIN PROLOGUE  XERHLT                                               SLAP........897400
C***SUBSIDIARY                                                           SLAP........897500
C***PURPOSE  Abort program execution and print error message.            SLAP........897600
C***LIBRARY   SLATEC (XERROR)                                            SLAP........897700
C***CATEGORY  R3C                                                        SLAP........897800
C***TYPE      ALL (XERHLT-A)                                             SLAP........897900
C***KEYWORDS  ABORT PROGRAM EXECUTION, ERROR, XERROR                     SLAP........898000
C***AUTHOR  Jones, R. E., (SNLA)                                         SLAP........898100
C***DESCRIPTION                                                          SLAP........898200
C                                                                        SLAP........898300
C     Abstract                                                           SLAP........898400
C        ***Note*** machine dependent routine                            SLAP........898500
C        XERHLT aborts the execution of the program.                     SLAP........898600
C        The error message causing the abort is given in the calling     SLAP........898700
C        sequence, in case one needs it for printing on a dayfile,       SLAP........898800
C        for example.                                                    SLAP........898900
C                                                                        SLAP........899000
C     Description of Parameters                                          SLAP........899100
C        MESSG is as in XERMSG.                                          SLAP........899200
C                                                                        SLAP........899300
C***REFERENCES  R. E. Jones and D. K. Kahaner, XERROR, the SLATEC        SLAP........899400
C                 Error-handling Package, SAND82-0800, Sandia            SLAP........899500
C                 Laboratories, 1982.                                    SLAP........899600
C***ROUTINES CALLED  (NONE)                                              SLAP........899700
C***REVISION HISTORY  (YYMMDD)                                           SLAP........899800
C   790801  DATE WRITTEN                                                 SLAP........899900
C   861211  REVISION DATE from Version 3.2                               SLAP........900000
C   891214  Prologue converted to Version 4.0 format.  (BAB)             SLAP........900100
C   900206  Routine changed from user-callable to subsidiary.  (WRB)     SLAP........900200
C   900510  Changed calling sequence to delete length of character       SLAP........900300
C           and changed routine name from XERABT to XERHLT.  (RWC)       SLAP........900400
C   920501  Reformatted the REFERENCES section.  (WRB)                   SLAP........900500
C***END PROLOGUE  XERHLT                                                 SLAP........900600
      CHARACTER*(*) MESSG                                                SLAP........900700
C***FIRST EXECUTABLE STATEMENT  XERHLT                                   SLAP........900800
      STOP                                                               SLAP........900900
      END                                                                SLAP........901000
*DECK XERMSG                                                             SLAP........901100
      SUBROUTINE XERMSG (LIBRAR, SUBROU, MESSG, NERR, LEVEL)             SLAP........901200
C***BEGIN PROLOGUE  XERMSG                                               SLAP........901300
C***PURPOSE  Process error messages for SLATEC and other libraries.      SLAP........901400
C***LIBRARY   SLATEC (XERROR)                                            SLAP........901500
C***CATEGORY  R3C                                                        SLAP........901600
C***TYPE      ALL (XERMSG-A)                                             SLAP........901700
C***KEYWORDS  ERROR MESSAGE, XERROR                                      SLAP........901800
C***AUTHOR  Fong, Kirby, (NMFECC at LLNL)                                SLAP........901900
C***DESCRIPTION                                                          SLAP........902000
C                                                                        SLAP........902100
C   XERMSG processes a diagnostic message in a manner determined by the  SLAP........902200
C   value of LEVEL and the current value of the library error control    SLAP........902300
C   flag, KONTRL.  See subroutine XSETF for details.                     SLAP........902400
C                                                                        SLAP........902500
C    LIBRAR   A character constant (or character variable) with the name SLAP........902600
C             of the library.  This will be 'SLATEC' for the SLATEC      SLAP........902700
C             Common Math Library.  The error handling package is        SLAP........902800
C             general enough to be used by many libraries                SLAP........902900
C             simultaneously, so it is desirable for the routine that    SLAP........903000
C             detects and reports an error to identify the library name  SLAP........903100
C             as well as the routine name.                               SLAP........903200
C                                                                        SLAP........903300
C    SUBROU   A character constant (or character variable) with the name SLAP........903400
C             of the routine that detected the error.  Usually it is the SLAP........903500
C             name of the routine that is calling XERMSG.  There are     SLAP........903600
C             some instances where a user callable library routine calls SLAP........903700
C             lower level subsidiary routines where the error is         SLAP........903800
C             detected.  In such cases it may be more informative to     SLAP........903900
C             supply the name of the routine the user called rather than SLAP........904000
C             the name of the subsidiary routine that detected the       SLAP........904100
C             error.                                                     SLAP........904200
C                                                                        SLAP........904300
C    MESSG    A character constant (or character variable) with the text SLAP........904400
C             of the error or warning message.  In the example below,    SLAP........904500
C             the message is a character constant that contains a        SLAP........904600
C             generic message.                                           SLAP........904700
C                                                                        SLAP........904800
C                   CALL XERMSG ('SLATEC', 'MMPY',                       SLAP........904900
C                  *'THE ORDER OF THE MATRIX EXCEEDS THE ROW DIMENSION', SLAP........905000
C                  *3, 1)                                                SLAP........905100
C                                                                        SLAP........905200
C             It is possible (and is sometimes desirable) to generate a  SLAP........905300
C             specific message--e.g., one that contains actual numeric   SLAP........905400
C             values.  Specific numeric values can be converted into     SLAP........905500
C             character strings using formatted WRITE statements into    SLAP........905600
C             character variables.  This is called standard Fortran      SLAP........905700
C             internal file I/O and is exemplified in the first three    SLAP........905800
C             lines of the following example.  You can also catenate     SLAP........905900
C             substrings of characters to construct the error message.   SLAP........906000
C             Here is an example showing the use of both writing to      SLAP........906100
C             an internal file and catenating character strings.         SLAP........906200
C                                                                        SLAP........906300
C                   CHARACTER*5 CHARN, CHARL                             SLAP........906400
C                   WRITE (CHARN,10) N                                   SLAP........906500
C                   WRITE (CHARL,10) LDA                                 SLAP........906600
C                10 FORMAT(I5)                                           SLAP........906700
C                   CALL XERMSG ('SLATEC', 'MMPY', 'THE ORDER'//CHARN//  SLAP........906800
C                  *   ' OF THE MATRIX EXCEEDS ITS ROW DIMENSION OF'//   SLAP........906900
C                  *   CHARL, 3, 1)                                      SLAP........907000
C                                                                        SLAP........907100
C             There are two subtleties worth mentioning.  One is that    SLAP........907200
C             the // for character catenation is used to construct the   SLAP........907300
C             error message so that no single character constant is      SLAP........907400
C             continued to the next line.  This avoids confusion as to   SLAP........907500
C             whether there are trailing blanks at the end of the line.  SLAP........907600
C             The second is that by catenating the parts of the message  SLAP........907700
C             as an actual argument rather than encoding the entire      SLAP........907800
C             message into one large character variable, we avoid        SLAP........907900
C             having to know how long the message will be in order to    SLAP........908000
C             declare an adequate length for that large character        SLAP........908100
C             variable.  XERMSG calls XERPRN to print the message using  SLAP........908200
C             multiple lines if necessary.  If the message is very long, SLAP........908300
C             XERPRN will break it into pieces of 72 characters (as      SLAP........908400
C             requested by XERMSG) for printing on multiple lines.       SLAP........908500
C             Also, XERMSG asks XERPRN to prefix each line with ' *  '   SLAP........908600
C             so that the total line length could be 76 characters.      SLAP........908700
C             Note also that XERPRN scans the error message backwards    SLAP........908800
C             to ignore trailing blanks.  Another feature is that        SLAP........908900
C             the substring '$$' is treated as a new line sentinel       SLAP........909000
C             by XERPRN.  If you want to construct a multiline           SLAP........909100
C             message without having to count out multiples of 72        SLAP........909200
C             characters, just use '$$' as a separator.  '$$'            SLAP........909300
C             obviously must occur within 72 characters of the           SLAP........909400
C             start of each line to have its intended effect since       SLAP........909500
C             XERPRN is asked to wrap around at 72 characters in         SLAP........909600
C             addition to looking for '$$'.                              SLAP........909700
C                                                                        SLAP........909800
C    NERR     An integer value that is chosen by the library routine's   SLAP........909900
C             author.  It must be in the range -99 to 999 (three         SLAP........910000
C             printable digits).  Each distinct error should have its    SLAP........910100
C             own error number.  These error numbers should be described SLAP........910200
C             in the machine readable documentation for the routine.     SLAP........910300
C             The error numbers need be unique only within each routine, SLAP........910400
C             so it is reasonable for each routine to start enumerating  SLAP........910500
C             errors from 1 and proceeding to the next integer.          SLAP........910600
C                                                                        SLAP........910700
C    LEVEL    An integer value in the range 0 to 2 that indicates the    SLAP........910800
C             level (severity) of the error.  Their meanings are         SLAP........910900
C                                                                        SLAP........911000
C            -1  A warning message.  This is used if it is not clear     SLAP........911100
C                that there really is an error, but the user's attention SLAP........911200
C                may be needed.  An attempt is made to only print this   SLAP........911300
C                message once.                                           SLAP........911400
C                                                                        SLAP........911500
C             0  A warning message.  This is used if it is not clear     SLAP........911600
C                that there really is an error, but the user's attention SLAP........911700
C                may be needed.                                          SLAP........911800
C                                                                        SLAP........911900
C             1  A recoverable error.  This is used even if the error is SLAP........912000
C                so serious that the routine cannot return any useful    SLAP........912100
C                answer.  If the user has told the error package to      SLAP........912200
C                return after recoverable errors, then XERMSG will       SLAP........912300
C                return to the Library routine which can then return to  SLAP........912400
C                the user's routine.  The user may also permit the error SLAP........912500
C                package to terminate the program upon encountering a    SLAP........912600
C                recoverable error.                                      SLAP........912700
C                                                                        SLAP........912800
C             2  A fatal error.  XERMSG will not return to its caller    SLAP........912900
C                after it receives a fatal error.  This level should     SLAP........913000
C                hardly ever be used; it is much better to allow the     SLAP........913100
C                user a chance to recover.  An example of one of the few SLAP........913200
C                cases in which it is permissible to declare a level 2   SLAP........913300
C                error is a reverse communication Library routine that   SLAP........913400
C                is likely to be called repeatedly until it integrates   SLAP........913500
C                across some interval.  If there is a serious error in   SLAP........913600
C                the input such that another step cannot be taken and    SLAP........913700
C                the Library routine is called again without the input   SLAP........913800
C                error having been corrected by the caller, the Library  SLAP........913900
C                routine will probably be called forever with improper   SLAP........914000
C                input.  In this case, it is reasonable to declare the   SLAP........914100
C                error to be fatal.                                      SLAP........914200
C                                                                        SLAP........914300
C    Each of the arguments to XERMSG is input; none will be modified by  SLAP........914400
C    XERMSG.  A routine may make multiple calls to XERMSG with warning   SLAP........914500
C    level messages; however, after a call to XERMSG with a recoverable  SLAP........914600
C    error, the routine should return to the user.  Do not try to call   SLAP........914700
C    XERMSG with a second recoverable error after the first recoverable  SLAP........914800
C    error because the error package saves the error number.  The user   SLAP........914900
C    can retrieve this error number by calling another entry point in    SLAP........915000
C    the error handling package and then clear the error number when     SLAP........915100
C    recovering from the error.  Calling XERMSG in succession causes the SLAP........915200
C    old error number to be overwritten by the latest error number.      SLAP........915300
C    This is considered harmless for error numbers associated with       SLAP........915400
C    warning messages but must not be done for error numbers of serious  SLAP........915500
C    errors.  After a call to XERMSG with a recoverable error, the user  SLAP........915600
C    must be given a chance to call NUMXER or XERCLR to retrieve or      SLAP........915700
C    clear the error number.                                             SLAP........915800
C***REFERENCES  R. E. Jones and D. K. Kahaner, XERROR, the SLATEC        SLAP........915900
C                 Error-handling Package, SAND82-0800, Sandia            SLAP........916000
C                 Laboratories, 1982.                                    SLAP........916100
C***ROUTINES CALLED  FDUMP, J4SAVE, XERCNT, XERHLT, XERPRN, XERSVE       SLAP........916200
C***REVISION HISTORY  (YYMMDD)                                           SLAP........916300
C   880101  DATE WRITTEN                                                 SLAP........916400
C   880621  REVISED AS DIRECTED AT SLATEC CML MEETING OF FEBRUARY 1988.  SLAP........916500
C           THERE ARE TWO BASIC CHANGES.                                 SLAP........916600
C           1.  A NEW ROUTINE, XERPRN, IS USED INSTEAD OF XERPRT TO      SLAP........916700
C               PRINT MESSAGES.  THIS ROUTINE WILL BREAK LONG MESSAGES   SLAP........916800
C               INTO PIECES FOR PRINTING ON MULTIPLE LINES.  '$$' IS     SLAP........916900
C               ACCEPTED AS A NEW LINE SENTINEL.  A PREFIX CAN BE        SLAP........917000
C               ADDED TO EACH LINE TO BE PRINTED.  XERMSG USES EITHER    SLAP........917100
C               ' ***' OR ' *  ' AND LONG MESSAGES ARE BROKEN EVERY      SLAP........917200
C               72 CHARACTERS (AT MOST) SO THAT THE MAXIMUM LINE         SLAP........917300
C               LENGTH OUTPUT CAN NOW BE AS GREAT AS 76.                 SLAP........917400
C           2.  THE TEXT OF ALL MESSAGES IS NOW IN UPPER CASE SINCE THE  SLAP........917500
C               FORTRAN STANDARD DOCUMENT DOES NOT ADMIT THE EXISTENCE   SLAP........917600
C               OF LOWER CASE.                                           SLAP........917700
C   880708  REVISED AFTER THE SLATEC CML MEETING OF JUNE 29 AND 30.      SLAP........917800
C           THE PRINCIPAL CHANGES ARE                                    SLAP........917900
C           1.  CLARIFY COMMENTS IN THE PROLOGUES                        SLAP........918000
C           2.  RENAME XRPRNT TO XERPRN                                  SLAP........918100
C           3.  REWORK HANDLING OF '$$' IN XERPRN TO HANDLE BLANK LINES  SLAP........918200
C               SIMILAR TO THE WAY FORMAT STATEMENTS HANDLE THE /        SLAP........918300
C               CHARACTER FOR NEW RECORDS.                               SLAP........918400
C   890706  REVISED WITH THE HELP OF FRED FRITSCH AND REG CLEMENS TO     SLAP........918500
C           CLEAN UP THE CODING.                                         SLAP........918600
C   890721  REVISED TO USE NEW FEATURE IN XERPRN TO COUNT CHARACTERS IN  SLAP........918700
C           PREFIX.                                                      SLAP........918800
C   891013  REVISED TO CORRECT COMMENTS.                                 SLAP........918900
C   891214  Prologue converted to Version 4.0 format.  (WRB)             SLAP........919000
C   900510  Changed test on NERR to be -9999999 < NERR < 99999999, but   SLAP........919100
C           NERR .ne. 0, and on LEVEL to be -2 < LEVEL < 3.  Added       SLAP........919200
C           LEVEL=-1 logic, changed calls to XERSAV to XERSVE, and       SLAP........919300
C           XERCTL to XERCNT.  (RWC)                                     SLAP........919400
C   920501  Reformatted the REFERENCES section.  (WRB)                   SLAP........919500
C***END PROLOGUE  XERMSG                                                 SLAP........919600
      CHARACTER*(*) LIBRAR, SUBROU, MESSG                                SLAP........919700
      CHARACTER*8 XLIBR, XSUBR                                           SLAP........919800
      CHARACTER*72  TEMP                                                 SLAP........919900
      CHARACTER*20  LFIRST                                               SLAP........920000
C***FIRST EXECUTABLE STATEMENT  XERMSG                                   SLAP........920100
      LKNTRL = J4SAVE (2, 0, .FALSE.)                                    SLAP........920200
      MAXMES = J4SAVE (4, 0, .FALSE.)                                    SLAP........920300
C                                                                        SLAP........920400
C       LKNTRL IS A LOCAL COPY OF THE CONTROL FLAG KONTRL.               SLAP........920500
C       MAXMES IS THE MAXIMUM NUMBER OF TIMES ANY PARTICULAR MESSAGE     SLAP........920600
C          SHOULD BE PRINTED.                                            SLAP........920700
C                                                                        SLAP........920800
C       WE PRINT A FATAL ERROR MESSAGE AND TERMINATE FOR AN ERROR IN     SLAP........920900
C          CALLING XERMSG.  THE ERROR NUMBER SHOULD BE POSITIVE,         SLAP........921000
C          AND THE LEVEL SHOULD BE BETWEEN 0 AND 2.                      SLAP........921100
C                                                                        SLAP........921200
      IF (NERR.LT.-9999999 .OR. NERR.GT.99999999 .OR. NERR.EQ.0 .OR.     SLAP........921300
     *   LEVEL.LT.-1 .OR. LEVEL.GT.2) THEN                               SLAP........921400
         CALL XERPRN (' ***', -1, 'FATAL ERROR IN...$$ ' //              SLAP........921500
     *      'XERMSG -- INVALID ERROR NUMBER OR LEVEL$$ '//               SLAP........921600
     *      'JOB ABORT DUE TO FATAL ERROR.', 72)                         SLAP........921700
         CALL XERSVE (' ', ' ', ' ', 0, 0, 0, KDUMMY)                    SLAP........921800
         CALL XERHLT (' ***XERMSG -- INVALID INPUT')                     SLAP........921900
         RETURN                                                          SLAP........922000
      ENDIF                                                              SLAP........922100
C                                                                        SLAP........922200
C       RECORD THE MESSAGE.                                              SLAP........922300
C                                                                        SLAP........922400
      I = J4SAVE (1, NERR, .TRUE.)                                       SLAP........922500
      CALL XERSVE (LIBRAR, SUBROU, MESSG, 1, NERR, LEVEL, KOUNT)         SLAP........922600
C                                                                        SLAP........922700
C       HANDLE PRINT-ONCE WARNING MESSAGES.                              SLAP........922800
C                                                                        SLAP........922900
      IF (LEVEL.EQ.-1 .AND. KOUNT.GT.1) RETURN                           SLAP........923000
C                                                                        SLAP........923100
C       ALLOW TEMPORARY USER OVERRIDE OF THE CONTROL FLAG.               SLAP........923200
C                                                                        SLAP........923300
      XLIBR  = LIBRAR                                                    SLAP........923400
      XSUBR  = SUBROU                                                    SLAP........923500
      LFIRST = MESSG                                                     SLAP........923600
      LERR   = NERR                                                      SLAP........923700
      LLEVEL = LEVEL                                                     SLAP........923800
      CALL XERCNT (XLIBR, XSUBR, LFIRST, LERR, LLEVEL, LKNTRL)           SLAP........923900
C                                                                        SLAP........924000
      LKNTRL = MAX(-2, MIN(2,LKNTRL))                                    SLAP........924100
      MKNTRL = ABS(LKNTRL)                                               SLAP........924200
C                                                                        SLAP........924300
C       SKIP PRINTING IF THE CONTROL FLAG VALUE AS RESET IN XERCNT IS    SLAP........924400
C       ZERO AND THE ERROR IS NOT FATAL.                                 SLAP........924500
C                                                                        SLAP........924600
      IF (LEVEL.LT.2 .AND. LKNTRL.EQ.0) GO TO 30                         SLAP........924700
      IF (LEVEL.EQ.0 .AND. KOUNT.GT.MAXMES) GO TO 30                     SLAP........924800
      IF (LEVEL.EQ.1 .AND. KOUNT.GT.MAXMES .AND. MKNTRL.EQ.1) GO TO 30   SLAP........924900
      IF (LEVEL.EQ.2 .AND. KOUNT.GT.MAX(1,MAXMES)) GO TO 30              SLAP........925000
C                                                                        SLAP........925100
C       ANNOUNCE THE NAMES OF THE LIBRARY AND SUBROUTINE BY BUILDING A   SLAP........925200
C       MESSAGE IN CHARACTER VARIABLE TEMP (NOT EXCEEDING 66 CHARACTERS) SLAP........925300
C       AND SENDING IT OUT VIA XERPRN.  PRINT ONLY IF CONTROL FLAG       SLAP........925400
C       IS NOT ZERO.                                                     SLAP........925500
C                                                                        SLAP........925600
      IF (LKNTRL .NE. 0) THEN                                            SLAP........925700
         TEMP(1:21) = 'MESSAGE FROM ROUTINE '                            SLAP........925800
         I = MIN(LEN(SUBROU), 16)                                        SLAP........925900
         TEMP(22:21+I) = SUBROU(1:I)                                     SLAP........926000
         TEMP(22+I:33+I) = ' IN LIBRARY '                                SLAP........926100
         LTEMP = 33 + I                                                  SLAP........926200
         I = MIN(LEN(LIBRAR), 16)                                        SLAP........926300
         TEMP(LTEMP+1:LTEMP+I) = LIBRAR (1:I)                            SLAP........926400
         TEMP(LTEMP+I+1:LTEMP+I+1) = '.'                                 SLAP........926500
         LTEMP = LTEMP + I + 1                                           SLAP........926600
         CALL XERPRN (' ***', -1, TEMP(1:LTEMP), 72)                     SLAP........926700
      ENDIF                                                              SLAP........926800
C                                                                        SLAP........926900
C       IF LKNTRL IS POSITIVE, PRINT AN INTRODUCTORY LINE BEFORE         SLAP........927000
C       PRINTING THE MESSAGE.  THE INTRODUCTORY LINE TELLS THE CHOICE    SLAP........927100
C       FROM EACH OF THE FOLLOWING THREE OPTIONS.                        SLAP........927200
C       1.  LEVEL OF THE MESSAGE                                         SLAP........927300
C              'INFORMATIVE MESSAGE'                                     SLAP........927400
C              'POTENTIALLY RECOVERABLE ERROR'                           SLAP........927500
C              'FATAL ERROR'                                             SLAP........927600
C       2.  WHETHER CONTROL FLAG WILL ALLOW PROGRAM TO CONTINUE          SLAP........927700
C              'PROG CONTINUES'                                          SLAP........927800
C              'PROG ABORTED'                                            SLAP........927900
C       3.  WHETHER OR NOT A TRACEBACK WAS REQUESTED.  (THE TRACEBACK    SLAP........928000
C           MAY NOT BE IMPLEMENTED AT SOME SITES, SO THIS ONLY TELLS     SLAP........928100
C           WHAT WAS REQUESTED, NOT WHAT WAS DELIVERED.)                 SLAP........928200
C              'TRACEBACK REQUESTED'                                     SLAP........928300
C              'TRACEBACK NOT REQUESTED'                                 SLAP........928400
C       NOTICE THAT THE LINE INCLUDING FOUR PREFIX CHARACTERS WILL NOT   SLAP........928500
C       EXCEED 74 CHARACTERS.                                            SLAP........928600
C       WE SKIP THE NEXT BLOCK IF THE INTRODUCTORY LINE IS NOT NEEDED.   SLAP........928700
C                                                                        SLAP........928800
      IF (LKNTRL .GT. 0) THEN                                            SLAP........928900
C                                                                        SLAP........929000
C       THE FIRST PART OF THE MESSAGE TELLS ABOUT THE LEVEL.             SLAP........929100
C                                                                        SLAP........929200
         IF (LEVEL .LE. 0) THEN                                          SLAP........929300
            TEMP(1:20) = 'INFORMATIVE MESSAGE,'                          SLAP........929400
            LTEMP = 20                                                   SLAP........929500
         ELSEIF (LEVEL .EQ. 1) THEN                                      SLAP........929600
            TEMP(1:30) = 'POTENTIALLY RECOVERABLE ERROR,'                SLAP........929700
            LTEMP = 30                                                   SLAP........929800
         ELSE                                                            SLAP........929900
            TEMP(1:12) = 'FATAL ERROR,'                                  SLAP........930000
            LTEMP = 12                                                   SLAP........930100
         ENDIF                                                           SLAP........930200
C                                                                        SLAP........930300
C       THEN WHETHER THE PROGRAM WILL CONTINUE.                          SLAP........930400
C                                                                        SLAP........930500
         IF ((MKNTRL.EQ.2 .AND. LEVEL.GE.1) .OR.                         SLAP........930600
     *       (MKNTRL.EQ.1 .AND. LEVEL.EQ.2)) THEN                        SLAP........930700
            TEMP(LTEMP+1:LTEMP+14) = ' PROG ABORTED,'                    SLAP........930800
            LTEMP = LTEMP + 14                                           SLAP........930900
         ELSE                                                            SLAP........931000
            TEMP(LTEMP+1:LTEMP+16) = ' PROG CONTINUES,'                  SLAP........931100
            LTEMP = LTEMP + 16                                           SLAP........931200
         ENDIF                                                           SLAP........931300
C                                                                        SLAP........931400
C       FINALLY TELL WHETHER THERE SHOULD BE A TRACEBACK.                SLAP........931500
C                                                                        SLAP........931600
         IF (LKNTRL .GT. 0) THEN                                         SLAP........931700
            TEMP(LTEMP+1:LTEMP+20) = ' TRACEBACK REQUESTED'              SLAP........931800
            LTEMP = LTEMP + 20                                           SLAP........931900
         ELSE                                                            SLAP........932000
            TEMP(LTEMP+1:LTEMP+24) = ' TRACEBACK NOT REQUESTED'          SLAP........932100
            LTEMP = LTEMP + 24                                           SLAP........932200
         ENDIF                                                           SLAP........932300
         CALL XERPRN (' ***', -1, TEMP(1:LTEMP), 72)                     SLAP........932400
      ENDIF                                                              SLAP........932500
C                                                                        SLAP........932600
C       NOW SEND OUT THE MESSAGE.                                        SLAP........932700
C                                                                        SLAP........932800
      CALL XERPRN (' *  ', -1, MESSG, 72)                                SLAP........932900
C                                                                        SLAP........933000
C       IF LKNTRL IS POSITIVE, WRITE THE ERROR NUMBER AND REQUEST A      SLAP........933100
C          TRACEBACK.                                                    SLAP........933200
C                                                                        SLAP........933300
      IF (LKNTRL .GT. 0) THEN                                            SLAP........933400
         WRITE (TEMP, '(''ERROR NUMBER = '', I8)') NERR                  SLAP........933500
         DO 10 I=16,22                                                   SLAP........933600
            IF (TEMP(I:I) .NE. ' ') GO TO 20                             SLAP........933700
   10    CONTINUE                                                        SLAP........933800
C                                                                        SLAP........933900
   20    CALL XERPRN (' *  ', -1, TEMP(1:15) // TEMP(I:23), 72)          SLAP........934000
         CALL FDUMP                                                      SLAP........934100
      ENDIF                                                              SLAP........934200
C                                                                        SLAP........934300
C       IF LKNTRL IS NOT ZERO, PRINT A BLANK LINE AND AN END OF MESSAGE. SLAP........934400
C                                                                        SLAP........934500
      IF (LKNTRL .NE. 0) THEN                                            SLAP........934600
         CALL XERPRN (' *  ', -1, ' ', 72)                               SLAP........934700
         CALL XERPRN (' ***', -1, 'END OF MESSAGE', 72)                  SLAP........934800
         CALL XERPRN ('    ',  0, ' ', 72)                               SLAP........934900
      ENDIF                                                              SLAP........935000
C                                                                        SLAP........935100
C       IF THE ERROR IS NOT FATAL OR THE ERROR IS RECOVERABLE AND THE    SLAP........935200
C       CONTROL FLAG IS SET FOR RECOVERY, THEN RETURN.                   SLAP........935300
C                                                                        SLAP........935400
   30 IF (LEVEL.LE.0 .OR. (LEVEL.EQ.1 .AND. MKNTRL.LE.1)) RETURN         SLAP........935500
C                                                                        SLAP........935600
C       THE PROGRAM WILL BE STOPPED DUE TO AN UNRECOVERED ERROR OR A     SLAP........935700
C       FATAL ERROR.  PRINT THE REASON FOR THE ABORT AND THE ERROR       SLAP........935800
C       SUMMARY IF THE CONTROL FLAG AND THE MAXIMUM ERROR COUNT PERMIT.  SLAP........935900
C                                                                        SLAP........936000
      IF (LKNTRL.GT.0 .AND. KOUNT.LT.MAX(1,MAXMES)) THEN                 SLAP........936100
         IF (LEVEL .EQ. 1) THEN                                          SLAP........936200
            CALL XERPRN                                                  SLAP........936300
     *         (' ***', -1, 'JOB ABORT DUE TO UNRECOVERED ERROR.', 72)   SLAP........936400
         ELSE                                                            SLAP........936500
            CALL XERPRN(' ***', -1, 'JOB ABORT DUE TO FATAL ERROR.', 72) SLAP........936600
         ENDIF                                                           SLAP........936700
         CALL XERSVE (' ', ' ', ' ', -1, 0, 0, KDUMMY)                   SLAP........936800
         CALL XERHLT (' ')                                               SLAP........936900
      ELSE                                                               SLAP........937000
         CALL XERHLT (MESSG)                                             SLAP........937100
      ENDIF                                                              SLAP........937200
      RETURN                                                             SLAP........937300
      END                                                                SLAP........937400
*DECK XERPRN                                                             SLAP........937500
      SUBROUTINE XERPRN (PREFIX, NPREF, MESSG, NWRAP)                    SLAP........937600
C***BEGIN PROLOGUE  XERPRN                                               SLAP........937700
C***SUBSIDIARY                                                           SLAP........937800
C***PURPOSE  Print error messages processed by XERMSG.                   SLAP........937900
C***LIBRARY   SLATEC (XERROR)                                            SLAP........938000
C***CATEGORY  R3C                                                        SLAP........938100
C***TYPE      ALL (XERPRN-A)                                             SLAP........938200
C***KEYWORDS  ERROR MESSAGES, PRINTING, XERROR                           SLAP........938300
C***AUTHOR  Fong, Kirby, (NMFECC at LLNL)                                SLAP........938400
C***DESCRIPTION                                                          SLAP........938500
C                                                                        SLAP........938600
C This routine sends one or more lines to each of the (up to five)       SLAP........938700
C logical units to which error messages are to be sent.  This routine    SLAP........938800
C is called several times by XERMSG, sometimes with a single line to     SLAP........938900
C print and sometimes with a (potentially very long) message that may    SLAP........939000
C wrap around into multiple lines.                                       SLAP........939100
C                                                                        SLAP........939200
C PREFIX  Input argument of type CHARACTER.  This argument contains      SLAP........939300
C         characters to be put at the beginning of each line before      SLAP........939400
C         the body of the message.  No more than 16 characters of        SLAP........939500
C         PREFIX will be used.                                           SLAP........939600
C                                                                        SLAP........939700
C NPREF   Input argument of type INTEGER.  This argument is the number   SLAP........939800
C         of characters to use from PREFIX.  If it is negative, the      SLAP........939900
C         intrinsic function LEN is used to determine its length.  If    SLAP........940000
C         it is zero, PREFIX is not used.  If it exceeds 16 or if        SLAP........940100
C         LEN(PREFIX) exceeds 16, only the first 16 characters will be   SLAP........940200
C         used.  If NPREF is positive and the length of PREFIX is less   SLAP........940300
C         than NPREF, a copy of PREFIX extended with blanks to length    SLAP........940400
C         NPREF will be used.                                            SLAP........940500
C                                                                        SLAP........940600
C MESSG   Input argument of type CHARACTER.  This is the text of a       SLAP........940700
C         message to be printed.  If it is a long message, it will be    SLAP........940800
C         broken into pieces for printing on multiple lines.  Each line  SLAP........940900
C         will start with the appropriate prefix and be followed by a    SLAP........941000
C         piece of the message.  NWRAP is the number of characters per   SLAP........941100
C         piece; that is, after each NWRAP characters, we break and      SLAP........941200
C         start a new line.  In addition the characters '$$' embedded    SLAP........941300
C         in MESSG are a sentinel for a new line.  The counting of       SLAP........941400
C         characters up to NWRAP starts over for each new line.  The     SLAP........941500
C         value of NWRAP typically used by XERMSG is 72 since many       SLAP........941600
C         older error messages in the SLATEC Library are laid out to     SLAP........941700
C         rely on wrap-around every 72 characters.                       SLAP........941800
C                                                                        SLAP........941900
C NWRAP   Input argument of type INTEGER.  This gives the maximum size   SLAP........942000
C         piece into which to break MESSG for printing on multiple       SLAP........942100
C         lines.  An embedded '$$' ends a line, and the count restarts   SLAP........942200
C         at the following character.  If a line break does not occur    SLAP........942300
C         on a blank (it would split a word) that word is moved to the   SLAP........942400
C         next line.  Values of NWRAP less than 16 will be treated as    SLAP........942500
C         16.  Values of NWRAP greater than 132 will be treated as 132.  SLAP........942600
C         The actual line length will be NPREF + NWRAP after NPREF has   SLAP........942700
C         been adjusted to fall between 0 and 16 and NWRAP has been      SLAP........942800
C         adjusted to fall between 16 and 132.                           SLAP........942900
C                                                                        SLAP........943000
C***REFERENCES  R. E. Jones and D. K. Kahaner, XERROR, the SLATEC        SLAP........943100
C                 Error-handling Package, SAND82-0800, Sandia            SLAP........943200
C                 Laboratories, 1982.                                    SLAP........943300
C***ROUTINES CALLED  I1MACH, XGETUA                                      SLAP........943400
C***REVISION HISTORY  (YYMMDD)                                           SLAP........943500
C   880621  DATE WRITTEN                                                 SLAP........943600
C   880708  REVISED AFTER THE SLATEC CML SUBCOMMITTEE MEETING OF         SLAP........943700
C           JUNE 29 AND 30 TO CHANGE THE NAME TO XERPRN AND TO REWORK    SLAP........943800
C           THE HANDLING OF THE NEW LINE SENTINEL TO BEHAVE LIKE THE     SLAP........943900
C           SLASH CHARACTER IN FORMAT STATEMENTS.                        SLAP........944000
C   890706  REVISED WITH THE HELP OF FRED FRITSCH AND REG CLEMENS TO     SLAP........944100
C           STREAMLINE THE CODING AND FIX A BUG THAT CAUSED EXTRA BLANK  SLAP........944200
C           LINES TO BE PRINTED.                                         SLAP........944300
C   890721  REVISED TO ADD A NEW FEATURE.  A NEGATIVE VALUE OF NPREF     SLAP........944400
C           CAUSES LEN(PREFIX) TO BE USED AS THE LENGTH.                 SLAP........944500
C   891013  REVISED TO CORRECT ERROR IN CALCULATING PREFIX LENGTH.       SLAP........944600
C   891214  Prologue converted to Version 4.0 format.  (WRB)             SLAP........944700
C   900510  Added code to break messages between words.  (RWC)           SLAP........944800
C   920501  Reformatted the REFERENCES section.  (WRB)                   SLAP........944900
C***END PROLOGUE  XERPRN                                                 SLAP........945000
      CHARACTER*(*) PREFIX, MESSG                                        SLAP........945100
      INTEGER NPREF, NWRAP                                               SLAP........945200
      CHARACTER*148 CBUFF                                                SLAP........945300
      INTEGER IU(5), NUNIT                                               SLAP........945400
      CHARACTER*2 NEWLIN                                                 SLAP........945500
      PARAMETER (NEWLIN = '$$')                                          SLAP........945600
C***FIRST EXECUTABLE STATEMENT  XERPRN                                   SLAP........945700
      CALL XGETUA(IU,NUNIT)                                              SLAP........945800
C                                                                        SLAP........945900
C       A ZERO VALUE FOR A LOGICAL UNIT NUMBER MEANS TO USE THE STANDARD SLAP........946000
C       ERROR MESSAGE UNIT INSTEAD.  I1MACH(4) RETRIEVES THE STANDARD    SLAP........946100
C       ERROR MESSAGE UNIT.                                              SLAP........946200
C                                                                        SLAP........946300
      N = I1MACH(4)                                                      SLAP........946400
      DO 10 I=1,NUNIT                                                    SLAP........946500
         IF (IU(I) .EQ. 0) IU(I) = N                                     SLAP........946600
   10 CONTINUE                                                           SLAP........946700
C                                                                        SLAP........946800
C       LPREF IS THE LENGTH OF THE PREFIX.  THE PREFIX IS PLACED AT THE  SLAP........946900
C       BEGINNING OF CBUFF, THE CHARACTER BUFFER, AND KEPT THERE DURING  SLAP........947000
C       THE REST OF THIS ROUTINE.                                        SLAP........947100
C                                                                        SLAP........947200
      IF ( NPREF .LT. 0 ) THEN                                           SLAP........947300
         LPREF = LEN(PREFIX)                                             SLAP........947400
      ELSE                                                               SLAP........947500
         LPREF = NPREF                                                   SLAP........947600
      ENDIF                                                              SLAP........947700
      LPREF = MIN(16, LPREF)                                             SLAP........947800
      IF (LPREF .NE. 0) CBUFF(1:LPREF) = PREFIX                          SLAP........947900
C                                                                        SLAP........948000
C       LWRAP IS THE MAXIMUM NUMBER OF CHARACTERS WE WANT TO TAKE AT ONE SLAP........948100
C       TIME FROM MESSG TO PRINT ON ONE LINE.                            SLAP........948200
C                                                                        SLAP........948300
      LWRAP = MAX(16, MIN(132, NWRAP))                                   SLAP........948400
C                                                                        SLAP........948500
C       SET LENMSG TO THE LENGTH OF MESSG, IGNORE ANY TRAILING BLANKS.   SLAP........948600
C                                                                        SLAP........948700
      LENMSG = LEN(MESSG)                                                SLAP........948800
      N = LENMSG                                                         SLAP........948900
      DO 20 I=1,N                                                        SLAP........949000
         IF (MESSG(LENMSG:LENMSG) .NE. ' ') GO TO 30                     SLAP........949100
         LENMSG = LENMSG - 1                                             SLAP........949200
   20 CONTINUE                                                           SLAP........949300
   30 CONTINUE                                                           SLAP........949400
C                                                                        SLAP........949500
C       IF THE MESSAGE IS ALL BLANKS, THEN PRINT ONE BLANK LINE.         SLAP........949600
C                                                                        SLAP........949700
      IF (LENMSG .EQ. 0) THEN                                            SLAP........949800
         CBUFF(LPREF+1:LPREF+1) = ' '                                    SLAP........949900
         DO 40 I=1,NUNIT                                                 SLAP........950000
            WRITE(IU(I), '(A)') CBUFF(1:LPREF+1)                         SLAP........950100
   40    CONTINUE                                                        SLAP........950200
         RETURN                                                          SLAP........950300
      ENDIF                                                              SLAP........950400
C                                                                        SLAP........950500
C       SET NEXTC TO THE POSITION IN MESSG WHERE THE NEXT SUBSTRING      SLAP........950600
C       STARTS.  FROM THIS POSITION WE SCAN FOR THE NEW LINE SENTINEL.   SLAP........950700
C       WHEN NEXTC EXCEEDS LENMSG, THERE IS NO MORE TO PRINT.            SLAP........950800
C       WE LOOP BACK TO LABEL 50 UNTIL ALL PIECES HAVE BEEN PRINTED.     SLAP........950900
C                                                                        SLAP........951000
C       WE LOOK FOR THE NEXT OCCURRENCE OF THE NEW LINE SENTINEL.  THE   SLAP........951100
C       INDEX INTRINSIC FUNCTION RETURNS ZERO IF THERE IS NO OCCURRENCE  SLAP........951200
C       OR IF THE LENGTH OF THE FIRST ARGUMENT IS LESS THAN THE LENGTH   SLAP........951300
C       OF THE SECOND ARGUMENT.                                          SLAP........951400
C                                                                        SLAP........951500
C       THERE ARE SEVERAL CASES WHICH SHOULD BE CHECKED FOR IN THE       SLAP........951600
C       FOLLOWING ORDER.  WE ARE ATTEMPTING TO SET LPIECE TO THE NUMBER  SLAP........951700
C       OF CHARACTERS THAT SHOULD BE TAKEN FROM MESSG STARTING AT        SLAP........951800
C       POSITION NEXTC.                                                  SLAP........951900
C                                                                        SLAP........952000
C       LPIECE .EQ. 0   THE NEW LINE SENTINEL DOES NOT OCCUR IN THE      SLAP........952100
C                       REMAINDER OF THE CHARACTER STRING.  LPIECE       SLAP........952200
C                       SHOULD BE SET TO LWRAP OR LENMSG+1-NEXTC,        SLAP........952300
C                       WHICHEVER IS LESS.                               SLAP........952400
C                                                                        SLAP........952500
C       LPIECE .EQ. 1   THE NEW LINE SENTINEL STARTS AT MESSG(NEXTC:     SLAP........952600
C                       NEXTC).  LPIECE IS EFFECTIVELY ZERO, AND WE      SLAP........952700
C                       PRINT NOTHING TO AVOID PRODUCING UNNECESSARY     SLAP........952800
C                       BLANK LINES.  THIS TAKES CARE OF THE SITUATION   SLAP........952900
C                       WHERE THE LIBRARY ROUTINE HAS A MESSAGE OF       SLAP........953000
C                       EXACTLY 72 CHARACTERS FOLLOWED BY A NEW LINE     SLAP........953100
C                       SENTINEL FOLLOWED BY MORE CHARACTERS.  NEXTC     SLAP........953200
C                       SHOULD BE INCREMENTED BY 2.                      SLAP........953300
C                                                                        SLAP........953400
C       LPIECE .GT. LWRAP+1  REDUCE LPIECE TO LWRAP.                     SLAP........953500
C                                                                        SLAP........953600
C       ELSE            THIS LAST CASE MEANS 2 .LE. LPIECE .LE. LWRAP+1  SLAP........953700
C                       RESET LPIECE = LPIECE-1.  NOTE THAT THIS         SLAP........953800
C                       PROPERLY HANDLES THE END CASE WHERE LPIECE .EQ.  SLAP........953900
C                       LWRAP+1.  THAT IS, THE SENTINEL FALLS EXACTLY    SLAP........954000
C                       AT THE END OF A LINE.                            SLAP........954100
C                                                                        SLAP........954200
      NEXTC = 1                                                          SLAP........954300
   50 LPIECE = INDEX(MESSG(NEXTC:LENMSG), NEWLIN)                        SLAP........954400
      IF (LPIECE .EQ. 0) THEN                                            SLAP........954500
C                                                                        SLAP........954600
C       THERE WAS NO NEW LINE SENTINEL FOUND.                            SLAP........954700
C                                                                        SLAP........954800
         IDELTA = 0                                                      SLAP........954900
         LPIECE = MIN(LWRAP, LENMSG+1-NEXTC)                             SLAP........955000
         IF (LPIECE .LT. LENMSG+1-NEXTC) THEN                            SLAP........955100
            DO 52 I=LPIECE+1,2,-1                                        SLAP........955200
               IF (MESSG(NEXTC+I-1:NEXTC+I-1) .EQ. ' ') THEN             SLAP........955300
                  LPIECE = I-1                                           SLAP........955400
                  IDELTA = 1                                             SLAP........955500
                  GOTO 54                                                SLAP........955600
               ENDIF                                                     SLAP........955700
   52       CONTINUE                                                     SLAP........955800
         ENDIF                                                           SLAP........955900
   54    CBUFF(LPREF+1:LPREF+LPIECE) = MESSG(NEXTC:NEXTC+LPIECE-1)       SLAP........956000
         NEXTC = NEXTC + LPIECE + IDELTA                                 SLAP........956100
      ELSEIF (LPIECE .EQ. 1) THEN                                        SLAP........956200
C                                                                        SLAP........956300
C       WE HAVE A NEW LINE SENTINEL AT MESSG(NEXTC:NEXTC+1).             SLAP........956400
C       DON'T PRINT A BLANK LINE.                                        SLAP........956500
C                                                                        SLAP........956600
         NEXTC = NEXTC + 2                                               SLAP........956700
         GO TO 50                                                        SLAP........956800
      ELSEIF (LPIECE .GT. LWRAP+1) THEN                                  SLAP........956900
C                                                                        SLAP........957000
C       LPIECE SHOULD BE SET DOWN TO LWRAP.                              SLAP........957100
C                                                                        SLAP........957200
         IDELTA = 0                                                      SLAP........957300
         LPIECE = LWRAP                                                  SLAP........957400
         DO 56 I=LPIECE+1,2,-1                                           SLAP........957500
            IF (MESSG(NEXTC+I-1:NEXTC+I-1) .EQ. ' ') THEN                SLAP........957600
               LPIECE = I-1                                              SLAP........957700
               IDELTA = 1                                                SLAP........957800
               GOTO 58                                                   SLAP........957900
            ENDIF                                                        SLAP........958000
   56    CONTINUE                                                        SLAP........958100
   58    CBUFF(LPREF+1:LPREF+LPIECE) = MESSG(NEXTC:NEXTC+LPIECE-1)       SLAP........958200
         NEXTC = NEXTC + LPIECE + IDELTA                                 SLAP........958300
      ELSE                                                               SLAP........958400
C                                                                        SLAP........958500
C       IF WE ARRIVE HERE, IT MEANS 2 .LE. LPIECE .LE. LWRAP+1.          SLAP........958600
C       WE SHOULD DECREMENT LPIECE BY ONE.                               SLAP........958700
C                                                                        SLAP........958800
         LPIECE = LPIECE - 1                                             SLAP........958900
         CBUFF(LPREF+1:LPREF+LPIECE) = MESSG(NEXTC:NEXTC+LPIECE-1)       SLAP........959000
         NEXTC  = NEXTC + LPIECE + 2                                     SLAP........959100
      ENDIF                                                              SLAP........959200
C                                                                        SLAP........959300
C       PRINT                                                            SLAP........959400
C                                                                        SLAP........959500
      DO 60 I=1,NUNIT                                                    SLAP........959600
         WRITE(IU(I), '(A)') CBUFF(1:LPREF+LPIECE)                       SLAP........959700
   60 CONTINUE                                                           SLAP........959800
C                                                                        SLAP........959900
      IF (NEXTC .LE. LENMSG) GO TO 50                                    SLAP........960000
      RETURN                                                             SLAP........960100
      END                                                                SLAP........960200
*DECK XERSVE                                                             SLAP........960300
      SUBROUTINE XERSVE (LIBRAR, SUBROU, MESSG, KFLAG, NERR, LEVEL,      SLAP........960400
     +   ICOUNT)                                                         SLAP........960500
C***BEGIN PROLOGUE  XERSVE                                               SLAP........960600
C***SUBSIDIARY                                                           SLAP........960700
C***PURPOSE  Record that an error has occurred.                          SLAP........960800
C***LIBRARY   SLATEC (XERROR)                                            SLAP........960900
C***CATEGORY  R3                                                         SLAP........961000
C***TYPE      ALL (XERSVE-A)                                             SLAP........961100
C***KEYWORDS  ERROR, XERROR                                              SLAP........961200
C***AUTHOR  Jones, R. E., (SNLA)                                         SLAP........961300
C***DESCRIPTION                                                          SLAP........961400
C                                                                        SLAP........961500
C *Usage:                                                                SLAP........961600
C                                                                        SLAP........961700
C        INTEGER  KFLAG, NERR, LEVEL, ICOUNT                             SLAP........961800
C        CHARACTER * (len) LIBRAR, SUBROU, MESSG                         SLAP........961900
C                                                                        SLAP........962000
C        CALL XERSVE (LIBRAR, SUBROU, MESSG, KFLAG, NERR, LEVEL, ICOUNT) SLAP........962100
C                                                                        SLAP........962200
C *Arguments:                                                            SLAP........962300
C                                                                        SLAP........962400
C        LIBRAR :IN    is the library that the message is from.          SLAP........962500
C        SUBROU :IN    is the subroutine that the message is from.       SLAP........962600
C        MESSG  :IN    is the message to be saved.                       SLAP........962700
C        KFLAG  :IN    indicates the action to be performed.             SLAP........962800
C                      when KFLAG > 0, the message in MESSG is saved.    SLAP........962900
C                      when KFLAG=0 the tables will be dumped and        SLAP........963000
C                      cleared.                                          SLAP........963100
C                      when KFLAG < 0, the tables will be dumped and     SLAP........963200
C                      not cleared.                                      SLAP........963300
C        NERR   :IN    is the error number.                              SLAP........963400
C        LEVEL  :IN    is the error severity.                            SLAP........963500
C        ICOUNT :OUT   the number of times this message has been seen,   SLAP........963600
C                      or zero if the table has overflowed and does not  SLAP........963700
C                      contain this message specifically.  When KFLAG=0, SLAP........963800
C                      ICOUNT will not be altered.                       SLAP........963900
C                                                                        SLAP........964000
C *Description:                                                          SLAP........964100
C                                                                        SLAP........964200
C   Record that this error occurred and possibly dump and clear the      SLAP........964300
C   tables.                                                              SLAP........964400
C                                                                        SLAP........964500
C***REFERENCES  R. E. Jones and D. K. Kahaner, XERROR, the SLATEC        SLAP........964600
C                 Error-handling Package, SAND82-0800, Sandia            SLAP........964700
C                 Laboratories, 1982.                                    SLAP........964800
C***ROUTINES CALLED  I1MACH, XGETUA                                      SLAP........964900
C***REVISION HISTORY  (YYMMDD)                                           SLAP........965000
C   800319  DATE WRITTEN                                                 SLAP........965100
C   861211  REVISION DATE from Version 3.2                               SLAP........965200
C   891214  Prologue converted to Version 4.0 format.  (BAB)             SLAP........965300
C   900413  Routine modified to remove reference to KFLAG.  (WRB)        SLAP........965400
C   900510  Changed to add LIBRARY NAME and SUBROUTINE to calling        SLAP........965500
C           sequence, use IF-THEN-ELSE, make number of saved entries     SLAP........965600
C           easily changeable, changed routine name from XERSAV to       SLAP........965700
C           XERSVE.  (RWC)                                               SLAP........965800
C   910626  Added LIBTAB and SUBTAB to SAVE statement.  (BKS)            SLAP........965900
C   920501  Reformatted the REFERENCES section.  (WRB)                   SLAP........966000
C***END PROLOGUE  XERSVE                                                 SLAP........966100
      PARAMETER (LENTAB=10)                                              SLAP........966200
      INTEGER LUN(5)                                                     SLAP........966300
      CHARACTER*(*) LIBRAR, SUBROU, MESSG                                SLAP........966400
      CHARACTER*8  LIBTAB(LENTAB), SUBTAB(LENTAB), LIB, SUB              SLAP........966500
      CHARACTER*20 MESTAB(LENTAB), MES                                   SLAP........966600
      DIMENSION NERTAB(LENTAB), LEVTAB(LENTAB), KOUNT(LENTAB)            SLAP........966700
      SAVE LIBTAB, SUBTAB, MESTAB, NERTAB, LEVTAB, KOUNT, KOUNTX, NMSG   SLAP........966800
      DATA KOUNTX/0/, NMSG/0/                                            SLAP........966900
C***FIRST EXECUTABLE STATEMENT  XERSVE                                   SLAP........967000
C                                                                        SLAP........967100
      IF (KFLAG.LE.0) THEN                                               SLAP........967200
C                                                                        SLAP........967300
C        Dump the table.                                                 SLAP........967400
C                                                                        SLAP........967500
         IF (NMSG.EQ.0) RETURN                                           SLAP........967600
C                                                                        SLAP........967700
C        Print to each unit.                                             SLAP........967800
C                                                                        SLAP........967900
         CALL XGETUA (LUN, NUNIT)                                        SLAP........968000
         DO 20 KUNIT = 1,NUNIT                                           SLAP........968100
            IUNIT = LUN(KUNIT)                                           SLAP........968200
            IF (IUNIT.EQ.0) IUNIT = I1MACH(4)                            SLAP........968300
C                                                                        SLAP........968400
C           Print the table header.                                      SLAP........968500
C                                                                        SLAP........968600
            WRITE (IUNIT,9000)                                           SLAP........968700
C                                                                        SLAP........968800
C           Print body of table.                                         SLAP........968900
C                                                                        SLAP........969000
            DO 10 I = 1,NMSG                                             SLAP........969100
               WRITE (IUNIT,9010) LIBTAB(I), SUBTAB(I), MESTAB(I),       SLAP........969200
     *            NERTAB(I),LEVTAB(I),KOUNT(I)                           SLAP........969300
   10       CONTINUE                                                     SLAP........969400
C                                                                        SLAP........969500
C           Print number of other errors.                                SLAP........969600
C                                                                        SLAP........969700
            IF (KOUNTX.NE.0) WRITE (IUNIT,9020) KOUNTX                   SLAP........969800
            WRITE (IUNIT,9030)                                           SLAP........969900
   20    CONTINUE                                                        SLAP........970000
C                                                                        SLAP........970100
C        Clear the error tables.                                         SLAP........970200
C                                                                        SLAP........970300
         IF (KFLAG.EQ.0) THEN                                            SLAP........970400
            NMSG = 0                                                     SLAP........970500
            KOUNTX = 0                                                   SLAP........970600
         ENDIF                                                           SLAP........970700
      ELSE                                                               SLAP........970800
C                                                                        SLAP........970900
C        PROCESS A MESSAGE...                                            SLAP........971000
C        SEARCH FOR THIS MESSG, OR ELSE AN EMPTY SLOT FOR THIS MESSG,    SLAP........971100
C        OR ELSE DETERMINE THAT THE ERROR TABLE IS FULL.                 SLAP........971200
C                                                                        SLAP........971300
         LIB = LIBRAR                                                    SLAP........971400
         SUB = SUBROU                                                    SLAP........971500
         MES = MESSG                                                     SLAP........971600
         DO 30 I = 1,NMSG                                                SLAP........971700
            IF (LIB.EQ.LIBTAB(I) .AND. SUB.EQ.SUBTAB(I) .AND.            SLAP........971800
     *         MES.EQ.MESTAB(I) .AND. NERR.EQ.NERTAB(I) .AND.            SLAP........971900
     *         LEVEL.EQ.LEVTAB(I)) THEN                                  SLAP........972000
                  KOUNT(I) = KOUNT(I) + 1                                SLAP........972100
                  ICOUNT = KOUNT(I)                                      SLAP........972200
                  RETURN                                                 SLAP........972300
            ENDIF                                                        SLAP........972400
   30    CONTINUE                                                        SLAP........972500
C                                                                        SLAP........972600
         IF (NMSG.LT.LENTAB) THEN                                        SLAP........972700
C                                                                        SLAP........972800
C           Empty slot found for new message.                            SLAP........972900
C                                                                        SLAP........973000
            NMSG = NMSG + 1                                              SLAP........973100
            LIBTAB(I) = LIB                                              SLAP........973200
            SUBTAB(I) = SUB                                              SLAP........973300
            MESTAB(I) = MES                                              SLAP........973400
            NERTAB(I) = NERR                                             SLAP........973500
            LEVTAB(I) = LEVEL                                            SLAP........973600
            KOUNT (I) = 1                                                SLAP........973700
            ICOUNT    = 1                                                SLAP........973800
         ELSE                                                            SLAP........973900
C                                                                        SLAP........974000
C           Table is full.                                               SLAP........974100
C                                                                        SLAP........974200
            KOUNTX = KOUNTX+1                                            SLAP........974300
            ICOUNT = 0                                                   SLAP........974400
         ENDIF                                                           SLAP........974500
      ENDIF                                                              SLAP........974600
      RETURN                                                             SLAP........974700
C                                                                        SLAP........974800
C     Formats.                                                           SLAP........974900
C                                                                        SLAP........975000
 9000 FORMAT ('0          ERROR MESSAGE SUMMARY' /                       SLAP........975100
     +   ' LIBRARY    SUBROUTINE MESSAGE START             NERR',        SLAP........975200
     +   '     LEVEL     COUNT')                                         SLAP........975300
 9010 FORMAT (1X,A,3X,A,3X,A,3I10)                                       SLAP........975400
 9020 FORMAT ('0OTHER ERRORS NOT INDIVIDUALLY TABULATED = ', I10)        SLAP........975500
 9030 FORMAT (1X)                                                        SLAP........975600
      END                                                                SLAP........975700
*DECK XGETUA                                                             SLAP........975800
      SUBROUTINE XGETUA (IUNITA, N)                                      SLAP........975900
C***BEGIN PROLOGUE  XGETUA                                               SLAP........976000
C***PURPOSE  Return unit number(s) to which error messages are being     SLAP........976100
C            sent.                                                       SLAP........976200
C***LIBRARY   SLATEC (XERROR)                                            SLAP........976300
C***CATEGORY  R3C                                                        SLAP........976400
C***TYPE      ALL (XGETUA-A)                                             SLAP........976500
C***KEYWORDS  ERROR, XERROR                                              SLAP........976600
C***AUTHOR  Jones, R. E., (SNLA)                                         SLAP........976700
C***DESCRIPTION                                                          SLAP........976800
C                                                                        SLAP........976900
C     Abstract                                                           SLAP........977000
C        XGETUA may be called to determine the unit number or numbers    SLAP........977100
C        to which error messages are being sent.                         SLAP........977200
C        These unit numbers may have been set by a call to XSETUN,       SLAP........977300
C        or a call to XSETUA, or may be a default value.                 SLAP........977400
C                                                                        SLAP........977500
C     Description of Parameters                                          SLAP........977600
C      --Output--                                                        SLAP........977700
C        IUNIT - an array of one to five unit numbers, depending         SLAP........977800
C                on the value of N.  A value of zero refers to the       SLAP........977900
C                default unit, as defined by the I1MACH machine          SLAP........978000
C                constant routine.  Only IUNIT(1),...,IUNIT(N) are       SLAP........978100
C                defined by XGETUA.  The values of IUNIT(N+1),...,       SLAP........978200
C                IUNIT(5) are not defined (for N .LT. 5) or altered      SLAP........978300
C                in any way by XGETUA.                                   SLAP........978400
C        N     - the number of units to which copies of the              SLAP........978500
C                error messages are being sent.  N will be in the        SLAP........978600
C                range from 1 to 5.                                      SLAP........978700
C                                                                        SLAP........978800
C***REFERENCES  R. E. Jones and D. K. Kahaner, XERROR, the SLATEC        SLAP........978900
C                 Error-handling Package, SAND82-0800, Sandia            SLAP........979000
C                 Laboratories, 1982.                                    SLAP........979100
C***ROUTINES CALLED  J4SAVE                                              SLAP........979200
C***REVISION HISTORY  (YYMMDD)                                           SLAP........979300
C   790801  DATE WRITTEN                                                 SLAP........979400
C   861211  REVISION DATE from Version 3.2                               SLAP........979500
C   891214  Prologue converted to Version 4.0 format.  (BAB)             SLAP........979600
C   920501  Reformatted the REFERENCES section.  (WRB)                   SLAP........979700
C***END PROLOGUE  XGETUA                                                 SLAP........979800
      DIMENSION IUNITA(5)                                                SLAP........979900
C***FIRST EXECUTABLE STATEMENT  XGETUA                                   SLAP........980000
      N = J4SAVE(5,0,.FALSE.)                                            SLAP........980100
      DO 30 I=1,N                                                        SLAP........980200
         INDEX = I+4                                                     SLAP........980300
         IF (I.EQ.1) INDEX = 3                                           SLAP........980400
         IUNITA(I) = J4SAVE(INDEX,0,.FALSE.)                             SLAP........980500
   30 CONTINUE                                                           SLAP........980600
      RETURN                                                             SLAP........980700
      END                                                                SLAP........980800

C     SUBROUTINE        B  C  T  I  M  E           SUTRA VERSION 2.2     BCTIME.........100
C                                                                        BCTIME.........200
C *** PURPOSE :                                                          BCTIME.........300
C ***  USER-PROGRAMMED SUBROUTINE WHICH ALLOWS THE USER TO SPECIFY:      BCTIME.........400
C ***   (1) TIME-DEPENDENT SPECIFIED PRESSURES AND TIME-DEPENDENT        BCTIME.........500
C ***       CONCENTRATIONS OR TEMPERATURES OF INFLOWS AT THESE POINTS    BCTIME.........600
C ***   (2) TIME-DEPENDENT SPECIFIED CONCENTRATIONS OR TEMPERATURES      BCTIME.........700
C ***   (3) TIME-DEPENDENT FLUID SOURCES AND CONCENTRATIONS              BCTIME.........800
C ***       OR TEMPERATURES OF INFLOWS AT THESE POINTS                   BCTIME.........900
C ***   (4) TIME-DEPENDENT ENERGY OR SOLUTE MASS SOURCES                 BCTIME........1000
C                                                                        BCTIME........1100
      SUBROUTINE BCTIME(IPBC,PBC,IUBC,UBC,QIN,UIN,QUIN,IQSOP,IQSOU,      BCTIME........1200
     1   IPBCT,IUBCT,IQSOPT,IQSOUT,X,Y,Z,IBCPBC,IBCUBC,IBCSOP,IBCSOU,
     2   PITER,UITER,GNUP1,GNUU1,IET,ISEEP,IPRE,IRD,RCIT,SW,VOL1,POR,SM,
     3   NDPT,NREF,WMA,HAREA,VAREA,DFR,PWFR,PCFR,POR1,TPT,ACET,QVYN
     4   ,QVX,QVY,TPT1,NREG)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                BCTIME........1400
      DIMENSION IPBC(NBCN),PBC(NBCN),IUBC(NBCN),UBC(NBCN),               BCTIME........1500
     1   QIN(NN),UIN(NN),QUIN(NN),IQSOP(NSOP),IQSOU(NSOU),               BCTIME........1600
     2   X(NN),Y(NN),Z(NN)                                               BCTIME........1700
      INTEGER(1) IBCPBC(NBCN),IBCUBC(NBCN),IBCSOP(NSOP),IBCSOU(NSOU)     BCTIME........1800
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              BCTIME........1900
     1   NSOP,NSOU,NBCN,NCIDB                                            BCTIME........2000
      COMMON /FUNITS/ K00,K0,K1,K2,K3,K4,K5,K6,K7,K8,K9,                 BCTIME........2100
     1   K10,K11,K12,K13                                                 BCTIME........2200
      COMMON /GRAVEC/ GRAVX,GRAVY,GRAVZ                                  BCTIME........2300
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       BCTIME........2400
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      BCTIME........2500
      COMMON /JCOLS/ NCOLPR,LCOLPR,NCOLS5,NCOLS6,J5COL,J6COL
      COMMON /DEPTH/  MXD,NFY
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,  
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2   
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      INTEGER NDPT(NSOP)
      INTEGER NREF(NSOP)
      DIMENSION DFR(NSOP),PWFR(NSOP),PCFR(NSOP)
      DIMENSION KTYPE(2)
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
      COMMON /DIMX2/ NELTA,NNVEC,NDIMIA,NDIMJA   
      COMMON /TIDE/ TA,TP,TM,RHOST,SC,TH,ITT
      COMMON /ET/ QET,UET,PET,UVM,NGT,ITE,TMA,TMI,ALF,RS,RH,AP,BP,U2,
     1   TSD,SCF
      COMMON /HEATPARA/ HSC,HER,ROUS,HCS
      COMMON /SOLVI/ KSOLVP, KSOLVU, NN1, NN2, NN3
      COMMON /ITERAT/ RPM,RPMAX,RUM,RUMAX,ITER,ITRMAX,IPWORS,IUWORS
      DIMENSION GNUP1(NBCN),GNUU1(NBCN),PITER(NN),UITER(NN),RCIT(NN)
      DIMENSION VOL1(NN),SW(NN),POR(NN),WMA(NN),HAREA(NSOP),POR1(NN)
      DIMENSION TPT(NN),TPT1(NN),NREG(NN)
      DIMENSION SM(NNVEC),VAREA(NSOP)
      DIMENSION QVYN(NN1-1)
      DIMENSION PC1(6),PW1(6)
      DIMENSION IET(3),ISEEP(3),IPRE(3),IRD(2)
      DIMENSION QVX(MXD,NFY-1),QVY(MXD-1,NFY)
      DIMENSION ACET(NFY)
      CHARACTER*80 ERRCOD
      CHARACTER INTFIL*1000
C     MXD---MAXIMUM NO. OF LAYERS AT THE EVAPORATION FRONT
C     NFY---NUMBER OF NODES IN EACH LAYER
C                                                                        BCTIME........2600
C.....DEFINITION OF REQUIRED VARIABLES                                   BCTIME........2700
C . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  BCTIME........2800
C     NN = EXACT NUMBER OF NODES IN MESH                                 BCTIME........2900
C     NPBC = EXACT NUMBER OF SPECIFIED PRESSURE NODES                    BCTIME........3000
C     NUBC = EXACT NUMBER OF SPECIFIED CONCENTRATION                     BCTIME........3100
C            OR TEMPERATURE NODES                                        BCTIME........3200
C . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  BCTIME........3300
C     IT = NUMBER OF CURRENT TIME STEP                                   BCTIME........3400
C . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  BCTIME........3500
C     TSEC = TIME AT END OF CURRENT TIME STEP IN SECONDS                 BCTIME........3600
C     TMIN = TIME AT END OF CURRENT TIME STEP IN MINUTES                 BCTIME........3700
C     THOUR = TIME AT END OF CURRENT TIME STEP IN HOURS                  BCTIME........3800
C     TDAY = TIME AT END OF CURRENT TIME STEP IN DAYS                    BCTIME........3900
C     TWEEK = TIME AT END OF CURRENT TIME STEP IN WEEKS                  BCTIME........4000
C     TMONTH = TIME AT END OF CURRENT TIME STEP IN MONTHS                BCTIME........4100
C     TYEAR = TIME AT END OF CURRENT TIME STEP IN YEARS                  BCTIME........4200
C . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  BCTIME........4300
C     PBC(IP) = SPECIFIED PRESSURE VALUE AT IP(TH) SPECIFIED             BCTIME........4400
C               PRESSURE NODE                                            BCTIME........4500
C     UBC(IP) = SPECIFIED CONCENTRATION OR TEMPERATURE VALUE OF ANY      BCTIME........4600
C               INFLOW OCCURRING AT IP(TH) SPECIFIED PRESSURE NODE       BCTIME........4700
C     IPBC(IP) = ACTUAL NODE NUMBER OF IP(TH) SPECIFIED PRESSURE NODE    BCTIME........4800
C                {WHEN NODE NUMBER I=IPBC(IP) IS NEGATIVE (I<0),         BCTIME........4900
C                VALUES MUST BE SPECIFIED FOR PBC AND UBC.}              BCTIME........5000
C     IBCPBC(IP) = INDICATOR OF WHERE THIS PRESSURE SPECIFICATION        BCTIME........5100
C                  WAS MADE. MUST BE SET TO -1 TO INDICATE THAT THIS     BCTIME........5200
C                  SPECIFICATION WAS MADE IN SUBROUTINE BCTIME.          BCTIME........5300
C . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  BCTIME........5400
C     UBC(IUP) = SPECIFIED CONCENTRATION OR TEMPERATURE VALUE AT         BCTIME........5500
C                IU(TH) SPECIFIED CONCENTRATION OR TEMPERATURE NODE      BCTIME........5600
C                (WHERE IUP=IU+NPBC)                                     BCTIME........5700
C     IUBC(IUP) = ACTUAL NODE NUMBER OF IU(TH) SPECIFIED CONCENTRATION   BCTIME........5800
C                 OR TEMPERATURE NODE (WHERE IUP=IU+NPBC)                BCTIME........5900
C                 {WHEN NODE NUMBER I=IUBC(IU) IS NEGATIVE (I<0),        BCTIME........6000
C                 A VALUE MUST BE SPECIFIED FOR UBC.}                    BCTIME........6100
C     IBCUBC(IUP) = INDICATOR OF WHERE THIS CONCENTRATION OR TEMPERATURE BCTIME........6200
C                  SPECIFICATION WAS MADE. MUST BE SET TO -1 TO INDICATE BCTIME........6300
C                  THAT THIS SPECIFICATION WAS MADE IN SUBROUTINE        BCTIME........6400
C                  BCTIME.                                               BCTIME........6500
C . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  BCTIME........6600
C     IQSOP(IQP) = NODE NUMBER OF IQP(TH) FLUID SOURCE NODE.             BCTIME........6700
C                  {WHEN NODE NUMBER I=IQSOP(IQP) IS NEGATIVE (I<0),     BCTIME........6800
C                  VALUES MUST BE SPECIFIED FOR QIN AND UIN.}            BCTIME........6900
C     QIN(-I) = SPECIFIED FLUID SOURCE VALUE AT NODE (-I)                BCTIME........7000
C     UIN(-I) = SPECIFIED CONCENTRATION OR TEMPERATURE VALUE OF ANY      BCTIME........7100
C               INFLOW OCCURRING AT FLUID SOURCE NODE (-I)               BCTIME........7200
C     IBCSOP(IQP) = INDICATOR OF WHERE THIS FLUID SOURCE SPECIFICATION   BCTIME........7300
C                   WAS MADE. MUST BE SET TO -1 TO INDICATE THAT THIS    BCTIME........7400
C                   SPECIFICATION WAS MADE IN SUBROUTINE BCTIME.         BCTIME........7500
C . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  BCTIME........7600
C     IQSOU(IQU) = NODE NUMBER OF IQU(TH) ENERGY OR                      BCTIME........7700
C                  SOLUTE MASS SOURCE NODE                               BCTIME........7800
C                  {WHEN NODE NUMBER I=IQSOU(IQU) IS NEGATIVE (I<0),     BCTIME........7900
C                  A VALUE MUST BE SPECIFIED FOR QUIN.}                  BCTIME........8000
C     QUIN(-I) = SPECIFIED ENERGY OR SOLUTE MASS SOURCE VALUE            BCTIME........8100
C                AT NODE (-I)                                            BCTIME........8200
C     IBCSOU(IQU) = INDICATOR OF WHERE THIS ENERGY OR SOLUTE MASS        BCTIME........8300
C                   SOURCE SPECIFICATION WAS MADE. MUST BE SET TO -1     BCTIME........8400
C                   TO INDICATE THAT THIS SPECIFICATION WAS MADE IN      BCTIME........8500
C                   SUBROUTINE BCTIME.                                   BCTIME........8600
C . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  BCTIME........8700
C                                                                        BCTIME........8800
C.....ADDITIONAL USEFUL VARIABLES                                        BCTIME........8900
C . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  BCTIME........9000
C     "FUNITS" ARE UNIT NUMBERS FOR INPUT AND OUTPUT FILES               BCTIME........9100
C         AS ASSIGNED IN THE INPUT FILE "SUTRA.FIL"                      BCTIME........9200
C                                                                        BCTIME........9300
C     X(I), Y(I), AND Z(I) ARE THE X-, Y-, AND Z-COORDINATES OF NODE I   BCTIME........9400
C     (FOR 2-D PROBLEMS, Z(I) IS THE MESH THICKNESS AT NODE I)           BCTIME........9500
C                                                                        BCTIME........9600
C     GRAVX, GRAVY AND GRAVZ ARE THE X-, Y-, AND Z-COMPONENTS OF THE     BCTIME........9700
C     GRAVITY VECTOR (FOR 2-D PROBLEMS, GRAVZ = 0)                       BCTIME........9800
C . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  BCTIME........9900
C                                                                        BCTIME.......10000
C                                                                        BCTIME.......10100
C.....NSOPI IS ACTUAL NUMBER OF FLUID SOURCE NODES                       BCTIME.......10200
      NSOPI=NSOP-1                                                       BCTIME.......10300
C.....NSOUI IS ACTUAL NUMBER OF ENERGY OR SOLUTE MASS SOURCE NODES       BCTIME.......10400
      NSOUI=NSOU-1                                                       BCTIME.......10500
C.....INITIALIZE ALL OF THE VALUE THAT IS GOING TO BE CHANGED IN THIS SUBROUTINE
      ETS=0.0
      DO 112 I=1,MXD
       DO 112 J=1,NFY
         IF (I.LT.MXD) QVY(I,J)=0.D0
112         IF (J.LT.NFY) QVX(I,J)=0.D0
      CALL ZERO(QIN,NN,0.D0)
      CALL ZERO(UIN,NN,0.D0)
      CALL ZERO(DFR,NSOP,0.D0)
      CALL ZERO(PWFR,NSOP,0.D0)
      CALL ZERO(PCFR,NSOP,0.D0)
C                                                                        BCTIME.......10600
C                                                                        BCTIME.......10700
C                                                                        BCTIME.......10800
C                                                                        BCTIME.......10900
C                                                                        BCTIME.......11000
C                                                                        BCTIME.......11100
      IF(IPBCT) 50,240,240                                               BCTIME.......11200
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  BCTIME.......11300
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  BCTIME.......11400
C.....SECTION (1):  SET TIME-DEPENDENT SPECIFIED PRESSURES OR            BCTIME.......11500
C     CONCENTRATIONS (TEMPERATURES) OF INFLOWS AT SPECIFIED              BCTIME.......11600
C     PRESSURE NODES                                                     BCTIME.......11700
C                                                                        BCTIME.......11800
   50 CONTINUE                                                           BCTIME.......11900
      DO 200 IP=1,NPBC                                                   BCTIME.......12000
      I=IPBC(IP)                                                         BCTIME.......12100
      IF(I) 100,200,200                                                  BCTIME.......12200
  100 CONTINUE                                                           BCTIME.......12300
C     NOTE: A FLOW AND TRANSPORT SOLUTION MUST OCCUR FOR ANY             BCTIME.......12400
C           TIME STEP IN WHICH PBC( ) CHANGES.                           BCTIME.......12500
C     PBC(IP) =  ((          ))                                          BCTIME.......12600
C     UBC(IP) =  ((          ))                                          BCTIME.......12700
C.....IBCPBC(IP) MUST BE SET TO -1 TO INDICATE THAT PBC(IP)              BCTIME.......12800
C        AND/OR UBC(IP) HAVE BEEN SET BY SUBROUTINE BCTIME.              BCTIME.......12900
      IBCPBC(IP) = -1                                                    BCTIME.......13000
  200 CONTINUE                                                           BCTIME.......13100
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  BCTIME.......13200
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  BCTIME.......13300
C                                                                        BCTIME.......13400
C                                                                        BCTIME.......13500
C                                                                        BCTIME.......13600
C                                                                        BCTIME.......13700
C                                                                        BCTIME.......13800
C                                                                        BCTIME.......13900
  240 IF(IUBCT) 250,440,440                                              BCTIME.......14000
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  BCTIME.......14100
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  BCTIME.......14200
C.....SECTION (2):  SET TIME-DEPENDENT SPECIFIED                         BCTIME.......14300
C     CONCENTRATIONS (TEMPERATURES)                                      BCTIME.......14400
C                                                                        BCTIME.......14500
  250 CONTINUE                                                           BCTIME.......14600
      DO 400 IU=1,NUBC                                                   BCTIME.......14700
      IUP=IU+NPBC                                                        BCTIME.......14800
      I=IUBC(IUP)                                                        BCTIME.......14900
      IF(I) 300,400,400                                                  BCTIME.......15000
  300 CONTINUE                                                           BCTIME.......15100
C     NOTE: A TRANSPORT SOLUTION MUST OCCUR FOR ANY TIME STEP IN WHICH   BCTIME.......15200
C           UBC( ) CHANGES.  IN ADDITION, IF FLUID PROPERTIES ARE        BCTIME.......15300
C           SENSITIVE TO 'U', THEN A FLOW SOLUTION MUST OCCUR AS WELL.   BCTIME.......15400
C     UBC(IUP) =   ((          ))                                        BCTIME.......15500
C.....IBCUBC(IUP) MUST BE SET TO -1 TO INDICATE THAT UBC(IUP)            BCTIME.......15600
C        HAS BEEN SET BY SUBROUTINE BCTIME.                              BCTIME.......15700
      IBCUBC(IUP) = -1                                                   BCTIME.......15800
  400 CONTINUE                                                           BCTIME.......15900
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  BCTIME.......16000
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  BCTIME.......16100
C                                                                        BCTIME.......16200
C                                                                        BCTIME.......16300
C                                                                        BCTIME.......16400
C                                                                        BCTIME.......16500
C                                                                        BCTIME.......16600
C                                                                        BCTIME.......16700
  440 IF(IQSOPT) 450,640,640                                             BCTIME.......16800
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  BCTIME.......16900
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  BCTIME.......17000
C.....SECTION (3):  SET TIME-DEPENDENT FLUID SOURCES/SINKS,              BCTIME.......17100
C      OR CONCENTRATIONS (TEMPERATURES) OF SOURCE FLUID                  BCTIME.......17200
C                                                                        BCTIME.......17300
  450 CONTINUE                                                           BCTIME.......17400
      DO 600 IQP=1,NSOPI                                                 BCTIME.......17500
      I=IQSOP(IQP)                                                       BCTIME.......17600
      IF(I) 500,600,600                                                  BCTIME.......17700
  500 CONTINUE                                                           BCTIME.......17800
C     NOTE: A FLOW AND TRANSPORT SOLUTION MUST OCCUR FOR ANY             BCTIME.......17900
C           TIME STEP IN WHICH QIN( ) CHANGES.                           BCTIME.......18000
C     QIN(-I) =   ((           ))                                        BCTIME.......18100
C     NOTE: A TRANSPORT SOLUTION MUST OCCUR FOR ANY                      BCTIME.......18200
C           TIME STEP IN WHICH UIN( ) CHANGES.                           BCTIME.......18300
C     UIN(-I) =   ((           ))                                        BCTIME.......18400
C.....IBCSOP(IQP) MUST BE SET TO -1 TO INDICATE THAT QIN(-I)             BCTIME.......18500
C        AND/OR UIN(-I) HAVE BEEN SET BY SUBROUTINE BCTIME.              BCTIME.......18600
      IBCSOP(IQP) = -1                                                   BCTIME.......18700
      IF ( PITER(IABS(I)).LT.PET) THEN                                              ! SATURATION
      IF ( NDPT(IQP).EQ.1)THEN                                                  ! FIRST LAYER EVAPORATION
      CALL SALTRESIST(RSC,UVM,UITER(IABS(I)),SM(IABS(I)),HAREA(IQP))
      CALL AEROSIST(RAVT,MAR)
      IF (IT.EQ.1517) THEN
       AAA=1.D0
      ENDIF
      CALL EVAPORATION (AET,PITER(IABS(I)),UITER(IABS(I))
     1,RCIT(IABS(I)),WMA(IABS(I)),SM(IABS(I)),PW,PC,DELL,TAUTH,DFR(IQP)
     2,PWFR(IQP),PCFR(IQP),RSC,TPT(IABS(I)),POR(IABS(I)),SW(IABS(I))
     3,NREG(IABS(I)))
      ACET(NREF(IQP))=AET
      ETS=ETS+AET*3600.*24.*1000.  ! MM/DAY FOR OUTPUT USAGE
      AET=AET*1.D3*HAREA(IQP)       ! M/S * 1000KG/M3 * M2
       QIN(IABS(I))=AET 
       UIN(IABS(I))=UET
      ENDIF                                                                     !FIRSTLAYER EVAPORATION
C     AET IS THE FLUX INDUCED BY EVAPORATION
C     IIQP IS THE SEQUENCE OF THE SOURCE AND SINK NODE. RANGE: 1-ISOPT
C     II IS THE GLOBAL SEQUENCE OF THE NODE. RANGE 1-NN
C     SEE NOTEBOOK3 P103
      AET=0.D0
      IIQP=0
      II=0


      IF (MVT.EQ.0)GOTO 2650                                                        !MVT IS A SWICH FOR OPEN (=1),OR CLOSE THE VAPOR TRANSPORT
      DO 185 J=1,2                                                                    !FIND OUT HORIZONTAL OR VERTICAL NODE J=1 HORIZONTAL J=2 VERTICAL
        CALL NNODE(IIQP,J,IQP,NDPT,NREF,NSOPI)
        IF (IIQP.NE.0.) THEN                                                         ! THE NEXT NODE SHOULD BE EXIST
          II=IQSOP(IIQP)
          IF (PITER(IABS(I)).LT.PET)THEN                                               ! THE NEXT NODE SHOULD NOT BE SATURATED
           IF (J.EQ.1)THEN 
               X1=X(IABS(I))
             X2=X(IABS(II))
           ELSEIF (J.EQ.2)THEN
             X1=Y(IABS(I))
             X2=Y(IABS(II))
           ENDIF
C    ------ CALCULATING THE VAPOR FLUX BETWEEN TWO CELLS.-----
C    IF POR1 IS USED FOR CALCULATING VAPOR FLOW, IT MEANS THE EFFECT OF SALT PRECIPITATION TO
C    VAPOR FLOW IS ACCOUNTED FOR.
      IF (SW(IABS(II)).LE.0.5.AND.J.EQ.2)THEN
       DD=1.D0
      ENDIF
          CALL VAPOR (AET,SW(IABS(I)),SW(IABS(II)),PITER(IABS(I))                     ! VAPOR CALCULATION
     2       ,PITER(IABS(II)),UITER(IABS(I)),UITER(IABS(II)),
     2    POR1(IABS(I)),POR1(IABS(II)),TPT(IABS(I)),TPT(IABS(II)),X1,X2)
C         THE REASON OF HAVING 0.5*(VAREA(IQP)+VAREA(IIQP)) AND 0.5*(HAREA(IQP)+HAREA(IIQP)) IS THAT VAPOR FLOW IS CALCULATED ON THE 
C         CELL BASIS, THE INTERFACE IS ACTUALLY NOT AT THE NODE, BUT INBETWEEN THE NODES. 
          UIN(IABS(I))=UET
          UIN(IABS(II))=UET
            IF (J.EQ.1) THEN                   ! ,HORIZONTAL VAPOR MOVEMENT                                         
C..... STORING VAPOR VELOCITY FOR FURTHER ANALYSIS
            QVX(NDPT(IQP),NREF(IQP))=AET
C .....MULTIPLYING THE ET RATE (M/S) BY THE AREA BETWEEN THE CELL. THIS IS DONE BY THE HALF OF THE SUMMATION BETWEEN THE 
C.....THIS LINE HAS TWO METHODS, ONE IS REGULAR Z METHOD, ANOTHER IS IRREGULAR METHOD
                AET=AET*RHOWP*VAREA(IQP)    !IRREGULAR METHOD WHEN CALLING SINKAREACYLINDRICAL, WHERE VAREA IS THE AREA OF THE RIGHTMOST OF THE CELL
C            AET=0.5*AET*RHOW0*(VAREA(IQP)+VAREA(IIQP))            ! REGULAR METHOD WHEN CALLING SINKAREA(
          QIN(IABS(I))=QIN(IABS(I))-AET                                               ! THE WRONG DIRECTION OF AET IS APPARENT INDUCED BY 
          QIN(IABS(II))=QIN(IABS(II))+AET
          ELSE
            QVY(NDPT(IQP),NREF(IQP))=AET
            AET=0.5*AET*RHOW0*(HAREA(IQP)+HAREA(IIQP))                              !    1D-6 IS THE AREA OF THE CROSS SECTION.
          QIN(IABS(I))=QIN(IABS(I))+AET
          QIN(IABS(II))=QIN(IABS(II))-AET
          ENDIF
                         
          ENDIF                                                                  ! THE NEXT NODE SHOULD NOT BE SATURATED
        ENDIF                                                                    ! THE NEXT NODE SHOULD BE EXIST
185      CONTINUE                                                                      !FINDOUT HORIZONTAL OR VERTICAL NODE
2650      CONTINUE
      ENDIF                                                                   ! SATURATION

  600 CONTINUE                                                           BCTIME.......18800   ! END OF LOOP
      CALL QVCONVERT(QVY,QVYN)


C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  BCTIME.......18900
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  BCTIME.......19000
C                                                                        BCTIME.......19100
C                                                                        BCTIME.......19200
C                                                                        BCTIME.......19300
C                                                                        BCTIME.......19400
C                                                                        BCTIME.......19500
C                                                                        BCTIME.......19600
  640 IF(IQSOUT) 650,840,840                                             BCTIME.......19700
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  BCTIME.......19800
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  BCTIME.......19900
C.....SECTION (4):  SET TIME-DEPENDENT SOURCES/SINKS                     BCTIME.......20000
C     OF SOLUTE MASS OR ENERGY                                           BCTIME.......20100
C                                                                        BCTIME.......20200
  650 CONTINUE                                                           BCTIME.......20300
      DO 800 IQU=1,NSOUI                                                 BCTIME.......20400
      I=IQSOU(IQU)                                                       BCTIME.......20500
      IF(I) 700,800,800                                                  BCTIME.......20600
  700 CONTINUE                                                           BCTIME.......20700
C     NOTE: A TRANSPORT SOLUTION MUST OCCUR FOR ANY                      BCTIME.......20800
C           TIME STEP IN WHICH QUIN( ) CHANGES.                          BCTIME.......20900
C     QUIN(-I) =   ((           ))                                       BCTIME.......21000
C.....IBCSOU(IQU) MUST BE SET TO -1 TO INDICATE THAT QUIN(-I)            BCTIME.......21100
C        HAS BEEN SET BY SUBROUTINE BCTIME.                              BCTIME.......21200
      IBCSOU(IQU) = -1                                                   BCTIME.......21300
  800 CONTINUE                                                           BCTIME.......21400
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  BCTIME.......21500
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  BCTIME.......21600
C                                                                        BCTIME.......21700
C                                                                        BCTIME.......21800
C                                                                        BCTIME.......21900
C                                                                        BCTIME.......22000
C                                                                        BCTIME.......22100
C                                                                        BCTIME.......22200
  840 CONTINUE                                                           BCTIME.......22300
C                                                                        BCTIME.......22400
      RETURN                                                             BCTIME.......22500
      END                                                                BCTIME.......22600



C     SUBROUTINE QVOPT IS TO OUTPUT THE VAPOR FLOW INFORMATION INTO QV.DAT FILE
C     THE DATA RECORD INTERVAL IS MOD(IT,NCOLPR).EQ.0.OR.IT.EQ.1
C     NONE CALLED SUBROUTINE 
      SUBROUTINE QVOPT(QVX,QVY)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                

      INTEGER(1) IBCPBC(NBCN),IBCUBC(NBCN),IBCSOP(NSOP),IBCSOU(NSOU)    
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,              
     1   NSOP,NSOU,NBCN,NCIDB                                            
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      
      COMMON /JCOLS/ NCOLPR,LCOLPR,NCOLS5,NCOLS6,J5COL,J6COL
      COMMON /DEPTH/  MXD,NFY
      INTEGER NDPT(NSOP)
      INTEGER NREF(NSOP)
      DIMENSION QVX(MXD,NFY-1),QVY(MXD-1,NFY)

      IF (IT.EQ.1) THEN  
      OPEN(125,FILE='QV.DAT',STATUS='UNKNOWN') 
      WRITE(125,5) INT(ITMAX/NCOLPR)
5      FORMAT(I10,2X,'OUTPUTS OVERALL')
      ENDIF    
      WRITE (125,8)IT
8     FORMAT('TIME STEP', I10)         
      DO 1 I=1,MXD
1      WRITE (125,4) (QVX(I,J),J=1,NFY-1)
      DO 3 I=1,MXD-1
3      WRITE (125,4) (QVY(I,J),J=1,NFY)
4     FORMAT (30(1PE15.7))
      RETURN 
      END
C    ---CALCULATING VAPOR FLUX BETWEEN TWO NEIGHBOURING NODE--------
C    CALLED SUBROUTINES INCLUDING DV, XX, 
C    SEE NOTEBOOK3 P43,P108, ALSO VERIFIED AT JAN 2013
      SUBROUTINE VAPOR (AET,SW1,SW2,P1,P2,U1,U2,POR1,POR2,T1,T2,X1,X2)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                               
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2,
     2   DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      DIMENSION KTYPE(2)
C     AET  -- ACTUAL EVAPORATION RATE [MM/DAY]
C     P1,P2   -- PRESSURE AT THE SPECIFIED NODE [KG/M/S2]
C     U1,U2   -- CONCENTRATION AT THE SPECIFIED NODE  [KG/KG]
C     T1,T2   -- TEMPERATURE AT EACH NODE
C     ED   -- SATURATED VAPOUR PRESSURE AT DEW POINT [KPA]
C     EO(NOT ZERO)   -- SATURATED VAPOUR PRESSURE AT MEAN DAILY AIR TEMP.  [PA]
C     RC   -- UNIVERSAL GAS CONSTANT [J/MOL/K]
C     WMW   -- MOLECULAR WEIGHT OF WATER [KG/MOL]
C     TSD   -- TEMPERATURE ON THE SIDE OF THE HEAT COLUMN [CELSIUS]
C     STM  -- MOLECULAR WEIGHT OF NACL [KG/MOL]
C     RHOW0   -- INITIAL WATER DENSITY 1000 (KG/M3)
C     G    -- GRAVATIONAL ACCERATION 9.8 (M/S2)

C     TK=TMI+273.15D0                                                ! SOIL SURFACE TEMPERATURE
      SWM=(SW1+SW2)/2.D0
      PM=(P1+P2)/2.D0
      UM=(U1+U2)/2.D0
      PORM=(POR1+POR2)/2.D0
      TM=(T1+T2)/2.D0
      DX=X1-X2
      DTDX=(T1-T2)/DX
      DCDX=(CHI(U1)*U1-CHI(U2)*U2)/DX
      DPDX=(P1-P2)/DX
C ...   HERE THE FIRST ARGUMENT OF YITA DETERMINES THE LOCATION OF YITA 
       AT=DV(PORM,SWM,TM)*PSAT(1,TM)*WMW*
     1  HR(FYM(PM),FYO(UM,TM),TM)/RHOW0/TM/RC
       A1= -YITA(1,SWM)*DPDX*WMW/(RHOW0*RC*TM)
       A2= +YITA(2,SWM)*2.D0*WMW*DCDX/STM
       A3= -YITA(3,SWM)*DTDX*(PSAT(2,TM)/PSAT(1,TM)-1.D0/TM)
       A4= +YITA(4,SWM)*FYM(PM)*GVA*WMW*DTDX/(RC*TM**2.D0)  !RELATIVE HUMIDITY INDUCED BY OSMOTIC IS NOT A FUNCTION OF T SEE NB3P108
       AET=AT*(A1+A2+A3+A4)
      RETURN
      END

C       DIFFUSION OF WATER VAPOR IN THE SOIL, TORTUOSITY AND AIR CONTENT
C       SEE NOTEBOOK3 P44
      DOUBLE PRECISION FUNCTION DV (POR,SW,TK)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      TAO=POR**(1.D0/3.D0)*(1-SW)**(7.D0/3.D0)
      THEA=POR*(1-SW)
      DA=2.29D-5*(TK/273.15D0)**1.75D0
      DV=TAO*THEA*DA
      RETURN
      END

C       DIFFUSION OF WATER VAPOR IN THE AIR
      DOUBLE PRECISION FUNCTION DA (TK)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      DA=2.29D-5*(TK/273.15D0)**1.75D0
      RETURN
      END


      DOUBLE PRECISION FUNCTION CHI (C)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      CHI=.9D0+2.6D-3*(C/(1-C))*1.D3+2.6D-3*((C/(1-C))*1.D3)**5.3D-2           ! EMPIRICAL EQUATION
      RETURN
      END

C     THIS SUB IS TO FIND OUT THE NODE NEXT TO THE NODE IQP SO VAPOR CALCULATION CAN BE 
C     CONDCTED
C     IIQP -- THE RETURN RESULT SHOWING THE SEQUENCE OF THE NODE NEXT TO THAT NODE
C     WHEN J=1 FIND NEXT HORIZONTAL NODE
C     WHEN J=2 FIND NEXT VERTICAL NODE
      SUBROUTINE NNODE(IIQP,J,IQP,NDPT,NREF,NSOPI)
      INTEGER NDPT(NSOP)
      INTEGER NREF(NSOP)
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,
     1   NSOP,NSOU,NBCN,NCIDB
      COMMON /DEPTH/ MXD,NFY
      IIQP=0
      IF (J.EQ.1) THEN      ! HORIZONTAL CHECK
         INRF=NREF(IQP)+1
         INDP=NDPT(IQP)
      ELSEIF (J.EQ.2) THEN ! VERTICAL CHECK
         INRF=NREF(IQP)
         INDP=NDPT(IQP)+1
      ENDIF
      IF (J.EQ.1.AND.NREF(IQP+1).EQ.INRF.AND.NDPT(IQP+1).EQ.INDP)
     1 IIQP=IQP+1
      IF (J.EQ.2.AND.(IQP+NFY).LE.NSOP) THEN
      DO 1 I=IQP+1, IQP+NFY
1      IF (NREF(I).EQ.INRF.AND.NDPT(I).EQ.INDP)  IIQP=I
      ENDIF
      RETURN 
      END

C *** PURPOSE 
C ***  TO CALCULATE THE WATER AND SOLUTE MASS IN EACH NODE  
C ***  WMA INCLUDES ALL THE SOLUTE IN LIQUID AND SOLID FORM
C ***  SM  IS SOLUTE IN SOLID FORM
C ***  SEE NOTEBOOK3 
      SUBROUTINE WSMASS(WMA,SMA,VOL,POR,SW,RHO,SOP,DSWDP,PVEC,
     1   PM1,UM1,UM2,CS1,CS2,CS3,SL,SR,DPDTITR,UVEC,ITER,POR1,SM,QPLITR,
     2   QIN,QINITR,UIN,IPBC,GNUP1,PBC,UBC,ISTOP,QSB,USB,QPB,UPB,NWS,
     3   WMAM,DWMADT,NDPT,IQSOP)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,
     1   NSOP,NSOU,NBCN,NCIDB
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
      COMMON /DIMX2/ NELTA, NNVEC, NDIMIA, NDIMJA
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2,
     2   DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /ET/ QET,UET,PET,UVM,NGT,ITE,TMA,TMI,ALF,RS,RH,AP,BP,U2,
     1   TSD,SCF
      DIMENSION KTYPE(2)
      DIMENSION WMA(NN),SMA(NN),VOL(NN),POR(NN),SW(NN),RHO(NN),UM1(NN),
     1   SOP(NN),DSWDP(NN),PM1(NN),UM2(NN),CS1(NN),
     1   CS2(NN),CS3(NN),SL(NN),SR(NN),DPDTITR(NN),POR1(NN)
      DIMENSION PVEC(NNVEC),UVEC(NNVEC),SM(NNVEC),QPLITR(NBCN)
      DIMENSION QIN(NN),QINITR(NN),UIN(NN),IPBC(NBCN),
     1   GNUP1(NBCN),PBC(NBCN),UBC(NBCN),IQSOP(NSOP)
      DIMENSION QSB(NN), USB(NN), QPB(NPBC), UPB(NPBC),NDPT(NSOP)
      DIMENSION WMA1(NN), SMA1(NN),WMAM(NN),DWMADT(NN)
      LOGICAL NWS
      DOUBLE PRECISION RHOST
      INTEGER,DIMENSION(8) :: IBTIME  !BEGIN TIME
      INTEGER,DIMENSION(8) :: IETIME  !END TIME
      REAL, DIMENSION(2) :: TIMEP  ! TIMEP(1)-USER TIME; TIMEP(2)-SYSTEM TIME
      DATA RHOST/2.165D3/
      SAVE RHOST,WMAI,SMAI,IBTIME
C     RHOST -- CRYSTAL SALT DENSITY (KG/M3)
C     WMA1 -- WATER MASS IN THE PREVIOUS TIME STEP  (KG)
C     SMA1 -- SOLUTE MASS IN THE PREVIOUS TIME STEP (KG)
C     WMAM -- WATER MASS IN THE MIDDLE TIME STEP (KG) DUE TO THE CENTRAL DIFFERENCIAL 
C             EQUATION USED FOR HEAT BALANCE    VOL(I)*ROU(I)*POR(I)*SW(I)
C     DWMADT -D(VOL(I)*ROU(I)*POR(I)*SW(I))/DT, USED FOR CENTRAL DIFFERENCIAL EQUATION
C      QST  -- TOTAL WATER SOURCE AND SINK 
C      UST  -- TOTAL SOLUTE SOURCE AND SINK
C      QPT  -- TOTAL WATER IN/OUT PUT DUE TO PRESSURE
C      SPT  -- TOTAL SOLUTE IN/OUT PUT DUE TO PRESSURE
C     WMAT -- INITIAL OVERALL WATER MASS IN DOMAIN
C     SMAT -- INITIAL OVERALL SOLUTE MASS IN DOMAIN 

C     FIRST TIME COMING TO THIS SUBROUTINE
      IF (.NOT.NWS) THEN                           ! IF IT IS THE FIRST TIME TO COME TO THIS SUB
         CALL DATE_AND_TIME(VALUES=IBTIME)    ! SETS THE BEGINNING TIME
            WMAI=0.D0
            SMAI=0.D0
            WMAF=0.D0
            SMAF=0.D0
            QST=0.D0
            UST=0.D0
            QPT=0.D0
            SPT=0.D0
          CALL ZERO(WMAM,NN,0.0D0)
          CALL ZERO(DWMADT,NN,0.0D0)
          CALL ZERO(QSB,NN,0.0D0)
          CALL ZERO(USB,NN,0.0D0)
          CALL ZERO(QPB,NPBC,0.0D0)
          CALL ZERO(UPB,NPBC,0.0D0)
        DO 1 I=1,NN
          WMA(I)=VOL(I)*POR(I)*SW(I)*RHO(I)
          SMA(I)=WMA(I)*UM1(I)
          WMAI=WMAI+WMA(I)                           !INITIAL OVERALL WATER MASS
          SMAI=SMAI+SMA(I)                           !INITIAL OVERALL SOLUTE MASS
1        CONTINUE
C     SECOND TIME CALLING SWMASS
      ELSEIF (NWS) THEN                              ! NOT THE FIRST TIME TO COME TO THIS SUB
        DO 2 I=1,NN
            WMA1(I)=WMA(I)                             !LAST WATER MASS
          SMA1(I)=SMA(I)                             !LAST SOLUTE MASS
C       RATE OF CHANGE IN TOTAL STORED FLUID DUE TO PRESSURE CHANGE
          TMP1=(1-ISSFLO/2)*RHO(I)*VOL(I)*
     1     (SW(I)*SOP(I)+POR(I)*DSWDP(I))*(PVEC(I)-PM1(I))   !/DELTP
C       RATE OF CHANGE IN TOTAL STORED FLUID DUE TO CONCENTRATION CHANGE
          TMP2=(1-ISSFLO/2)*POR(I)*SW(I)*DRWDU*VOL(I)*
     1     (UM1(I)-UM2(I))                                   !/DLTUM1
          WMA(I)=WMA(I)+TMP1+TMP2
          DWMADT(I)=TMP1/DELTP+TMP2/DLTUM1             !ONE TERM

C       RATE OF CHANGE IN SOLUTE DUE TO CONCENTRATION CHANGE
          ESRV=POR(I)*SW(I)*RHO(I)*VOL(I)
          EPRSV=(1.D0-POR(I))*RHOS*VOL(I)
          DUDT=(1-ISSTRA)*(UVEC(I)-UM1(I))      ! HERE IT IS DU NOT DUDT
          SMA(I)=SMA(I)+ESRV*CW*DUDT
C         RATE OF CHANGE OF ADSORBATE
          ADSP=EPRSV*CS1(I)*DUDT
          SMA(I)=SMA(I)+ADSP
          
C         RATE OF CHANGE IN SOLUTE DUE TO CHANGE IN MASS OF FLUID
          SMA(I)=SMA(I)+CW*UVEC(I)*(1-ISSFLO/2)*VOL(I)*
     1     (RHO(I)*(SW(I)*SOP(I)+POR(I)*DSWDP(I))*DPDTITR(I)*DELTP
     2     +POR(I)*SW(I)*DRWDU*(UM1(I)-UM2(I)))
C         FIRST-ORDER PRODUCTION/DECAY OF SOLUTE
          SMA(I)=SMA(I)+ESRV*PRODF1*UVEC(I)
C         FIRST-ORDER PRODUCTION/DECAY OF ADSORBATE
          SMA(I)=SMA(I)+EPRSV*PRODS1*(SL(I)*UVEC(I)+SR(I))
C         ZERO-ORDER PRODUCTION/DECAY OF SOLUTE
        SMA(I)=SMA(I)+ESRV*PRODF0
C         ZERO-ORDER PRODUCTION/DECAY OF ADSORBATE
        SMA(I)=SMA(I)+EPRSV*PRODS0

C      CALCULATING SOLID SALT SM (KG) AND 
          IF (UVEC(I).LE.UVM)THEN
            SM(I)=0.0
          ELSE
            SM(I)=SMA(I)-UVM*ESRV
          ENDIF

C         GAIN/LOSS OF FLUID THROUGH FLUID SOURCES AND SINKS
          QSB(I)=QSB(I)+QIN(I)*DELTP
C          GAIN/LOSS OF SOLUTE THROUGH FLUID SOURCES AND SINKS
          USB(I)=USB(I)+QINITR(I)*CW*UIN(I)*DELTU
2        CONTINUE

C     CALCULATING PRECIPITATION INDUCED POROSITY CHANGE POR1
C     BY THIS METHOD, WE ASSUME THE SALT PRECIPTED AT THE SURFACE NODE
C     WILL BE MULCHED ON THE SURFACE, RATHER THAN CHANGING THE POROSITY.
C     INSTEAD, IF PRECIPITATION IS HAPPENED IN THE SOIL, POROSITY WILL BE CHANGED
C     HOWEVER, THE POROSITY CHANGE HERE WILL ONLY AFFECT THE WATER VAPOR
C     FLOW, NOT RATHER FORE WATER RETENTION CURVE, RELATIVE K, AND SO ON. 
      DO 600 IQP=1,NSOP-1
            I=IQSOP(IQP)    
      IF (SM(IABS(I)).EQ.0.0)THEN
          POR1(IABS(I))=POR(IABS(I))
      ELSE 
         IF (NDPT(IQP).EQ.1)THEN
           POR1(IABS(I))=POR(IABS(I))
         ELSE
             POR1(IABS(I))=POR(IABS(I))-SM(IABS(I))/VOL(IABS(I))/RHOST
         ENDIF
      ENDIF
600      CONTINUE


      DO 200 IP=1,NPBC 
      I=IABS(IPBC(IP))
      QPB(IP)=QPB(IP)+GNUP1(IP)*(PBC(IP)-PVEC(I))*DELTP
      IF (QPLITR(IP).LE.0D0) THEN
         UPB(IP) = UPB(IP)+ QPLITR(IP)*CW*UVEC(I)*DELTU
      ELSE                                                    
         UPB(IP) = UPB(IP)+ QPLITR(IP)*CW*UBC(IP)*DELTU
      ENDIF
  200 CONTINUE 
 1500 CONTINUE
      ENDIF
      
      IF (ISTOP.EQ.1)THEN
      DO 5 I=1,NN
      QST=QST+QSB(I)
      UST=UST+USB(I)
      WMAF=WMAF+WMA(I)
      SMAF=SMAF+SMA(I)
5      CONTINUE
      DO 6 I=1,NPBC
      QPT=QPT+QPB(I)
      UPT=UPT+UPB(I)
6      CONTINUE
      WRITE(21,7)
7      FORMAT(/,'MASS BALANCE')
      WRITE(21,3)WMAI,WMAF,QPT,QST,(WMAF-WMAI),QST+QPT
     1, -(WMAF-WMAI)+QST+QPT,(-(WMAF-WMAI)+QST+QPT)/(QST+QPT)
3      FORMAT('INITIAL WATER STORAGE IS',18X,':',3X,1PE15.8,/
     6,'FINAL WATER STORAGE IS',20X,':',3X,1PE15.8,/
     2,'TOTAL PRESSURE BOUNDARY IN(+)/OUT(-) IS   :',3X,1PE15.8,/
     3,'TOTAL WATER SOURCE(+)/SINK(-) BOUDARY IS  :',3X,1PE15.8,/
     1,'WATER STORAGE DIFF. GAIN(+)/LOSS(-) IS    :',3X,1PE15.8,/
     1,'TOTAL WATER GAIN(+)/LOSS(-) FROM BDY. IS  :',3X,1PE15.8,/
     4,'ABSOLUTE MASS DIF. BTW STORAGE AND IN&OUT :',3X,1PE15.8,/
     5,'RELATIVE MASS DIF. BTW STORAGE AND IN&OUT :',3X,1PE15.8,/)
      WRITE(21,8)
8      FORMAT(/,'SOLUTE BALANCE')
      WRITE(21,4)SMAI,SMAF,UPT,UST,SMAF-SMAI
     1,UPT+UST,-(SMAF-SMAI)+UST+UPT,(-(SMAF-SMAI)+UST+UPT)/(UST+UPT)
4      FORMAT('INITIAL SOLUTE STORAGE IS',17X,':',3X,1PE15.8,/
     6,'FINAL SOLUTE STORAGE IS',19X,':',3X,1PE15.8,/
     2,'TOTAL PRESSURE BOUNDARY IN(+)/OUT(-) IS   :',3X,1PE15.8,/
     3,'TOTAL SOLUTE SOURCE(+)/SINK(-) BOUDARY IS :',3X,1PE15.8,/
     1,'SOLUTE STORAGE DIFF. GAIN(+)/LOSS(-) IS   :',3X,1PE15.8,/
     1,'TOTAL SOLUTE GAIN(+)/LOSS(-) FROM BDY. IS :',3X,1PE15.8,/
     4,'ABSOLUTE MASS DIF. BTW STORAGE AND IN&OUT :',3X,1PE15.8,/
     5,'RELATIVE MASS DIF. BTW STORAGE AND IN&OUT :',3X,1PE15.8,/)
C ......CALCULATE HOW MUCH TIME IS SPENT FOR FINISHING THE PROGRAM
        CALL DATE_AND_TIME(VALUES=IETIME) ! SETS THE FINISHING TIME
        CALL ETIME(TIMEP)  !TIMEP(1)-USER TIME; TIMEP(2)-SYSTEM TIME
        WRITE(21,10)IBTIME(3),IBTIME(2),IBTIME(1),IBTIME(5),IBTIME(6)
     1,IBTIME(7),IETIME(3),IETIME(2),IETIME(1),IETIME(5),IETIME(6)
     2,IETIME(7)
 10     FORMAT('PROGRAM STARTS AT:',3X,I2,'/',I2,'/',I4,3X
     1,I2,':',I2,':',I2,/,'PROGRAM FINISHES AT:',1X,I2,'/',I2,'/',I4
     2,3X,I2,':',I2,':',I2,/)
        
        IH=INT(TIMEP(1)/3600.)
        IM=INT((TIMEP(1)-3600.*IH)/60.)
        IS=TIMEP(1)-3600.*IH-60.*IM
        WRITE(21,11)IH,IM,IS
 11     FORMAT('USER TIME:',4X,I4,'H',I3,'M',I3,'S')

        IH=INT(TIMEP(2)/3600.)
        IM=INT((TIMEP(2)-3600.*IH)/60.)
        IS=TIMEP(2)-3600.*IH-60.*IM
        WRITE(21,12)IH,IM,IS
 12     FORMAT('SYSTEM TIME:',2X,I4,'H',I3,'M',I3,'S')

        IH=INT((TIMEP(1)+TIMEP(2))/3600.)
        IM=INT(((TIMEP(1)+TIMEP(2))-3600.*IH)/60.)
        IS=(TIMEP(1)+TIMEP(2))-3600.*IH-60.*IM
        WRITE(21,13)IH,IM,IS
 13     FORMAT('OVERALL TIME:',1X,I4,'H',I3,'M',I3,'S')
        ENDIF
      RETURN
      END
C ......






      SUBROUTINE EDEP(AET,NDPT,Y,NN,I,TSEC,ITER,IQP,DFR)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      INTEGER(1) NDPT
      DIMENSION Y(NN)
C      YPN Y
C      V -- THE VELOCITY OF TEMPERATURE PROPAGATION
C      A -- EVAPORATION PARAMETER EXP(-A*Y)
C      B -- HIGHEST DEPTH FOR EVAPORATION
C     C -- THE DISTANCE BETWEEN EACH NODE
C     YP-- THE DEPTH OF THE EVAPORATION FRONT
      A=10.
      B=0.3
      C=0.01
C      V=3.4722E-07*2
C      YP=V*TSEC
      YP=(1-EXP(-6.5*TSEC))/6.5

C     THIS PART SEE NOTEBOOK 96
       DIST=YP-(B-Y(IABS(I)))
       IF (DIST.LT.C/2.0.AND.DIST.GT.-C/2.0) THEN     !LEADING NODE BUT YP HAS PASSED ITS POSITION
         WID=DIST+C/2.0
       ELSEIF (DIST.GE.C/2.0)THEN  !NOT A LEADING NODE
         IF (NDPT.EQ.1)THEN
           WID=(Y(IABS(I))-Y(IABS(I)-1))/2.0
         ELSE
           WID=(Y(IABS(I)+1)-Y(IABS(I)-1))/2.0
         ENDIF
       ELSEIF  (DIST.LE.-C/2.0)THEN
           WID=0.
       ENDIF

      IF (ITER.EQ.1.AND.IQP.EQ.1)THEN
      DINT=-(EXP(-A*YP)-1)/A
      ENDIF
      
      DFR=WID*EXP(-A*(B-Y(IABS(I))))/DINT
      AET=AET*DFR
      RETURN
      END

C *** RSC--SALT RESISTANCE
C *** UVM
      SUBROUTINE SALTRESIST(RSC,UM,C,SM,A)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      COMMON /SALTRESIS/ AR,BR 
      COMMON /AERORESIS/ RAVT,RAVS,SWRAT
      IF (C.LE.UM)THEN
      RSC=0.D0
      ELSE
      RSC=(AR*LOG(SM/A*1.D2+EXP(-BR/AR))+BR)*1.D2
      ENDIF
      RETURN
      END


      SUBROUTINE AEROSIST(RAVT,MAR)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      RETURN
      END


C     HEAT TO CALCULATE THE HEAT TRANSPORT EQUATION
      SUBROUTINE HEAT (TPT,NDPT,NREF,DWMADT,WMAM,WMA,HAREA,FAREA,ACET
     1 ,IQSOP,VOL,POR,Y,YY,XX,QVYN,QLY,SW,RHO,TPT1,RHVS)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      INTEGER NDPT(NSOP)
      INTEGER NREF(NSOP)
      COMMON /SOLVI/ KSOLVP, KSOLVU, NN1, NN2, NN3
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,
     1   NSOP,NSOU,NBCN,NCIDB
      COMMON /AERORESIS/ RAVT,RAVS,SWRAT
      COMMON /DEPTH/ MXD,NFY
      COMMON /ET/ QET,UET,PET,UVM,NGT,ITE,TMA,TMI,ALF,RS,RH,AP,BP,U2,
     1   TSD,SCF
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,     
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2 
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART
      COMMON /HEATPARA/ HSC,HER,ROUS,HCS
      DIMENSION KTYPE(2)
      DIMENSION TWMAM(NFY),TDWMADT(NFY),TFAREA(NFY)
      DIMENSION DWMADT(NN),WMAM(NN),HAREA(NSOP),FAREA(NSOP),TPT(NN)
     1  ,IQSOP(NSOP),VOL(NN),POR(NN),Y(NN),SW(NN),WMA(NN),RHO(NN)
      DIMENSION T2(NFY),SH(NFY),ACET(NFY),TVOL(NFY)
      DIMENSION QLY(NE),YY(NN),XX(NN)
      DIMENSION QVYN(NN1-1),RHVS(NN1)
      DIMENSION HC(NN1-1),TPT1(NN)
      DIMENSION RHSWN(NN1),DRSNDT(NN1)
      DIMENSION AA(NN1),BB(NN1),CC(NN1),ANS(NN1),UU(NN1)
C      DATA CL/4.186D3/, CP/2.D3/, CA/1.01D3/,DMAIR /2.897D-2/,
C     1     RC/8.314472D+0/,SATM /101.325D+3/
C      SAVE CL,CP,CA,DMAIR,RC,SATM
C     DRSNDT(NN1)-- D(RHO*SW*POR)/DT
C     RHSWN(NN1) -- RHO*SW*POR AT TIME STEP N+1
C     DMAIR -- MOLECULAR WEIGHT OF AIR 0.02897 [KG/MOL]
C     RC    -- GAS CONSTANT 8.314
C     SATM  -- STANDARD ATMOSPHERE PRESSURE [PA OR KG/M/S2 ]
C     HER -- LAYERS THAT CONSIDERS FOR THE HEAT BALANCE
C     ROUS -- SOIL DENSITY  [KG/M3]
C     HCS   -- HEAT CAPACITY OF THE SOIL 900 [J/KG/K]
C     CL   -- HEAT CAPACITY OF LIQUID WATER 4186  [J/KG/K]
C     CP   -- HEAT CAPACITY OF WATER VAPOR 2000 [J/KG/K]
      NSOPI=NSOP-1
      IF (MHT.EQ.1)THEN       !USING THE PREVIOUS BULK METHOD. IT IS DELETED DUE TO STUIPITY
C----------------------------------------------------------------------------------------------
      ELSEIF (MHT.EQ.2)THEN ! CALCULATING THE ONE DIMENSIONAL ENERGY TRANSPORT EQUATION USING IMPLICIT FINITE DIFFERENCE SCHEME.
C    REFER TO SUMMERSCHOOL BOOK 1-8 AS WELL AS FILE /SALTMARSH/CODEBOOK/HEATTRANSPORTALGORITHM.DOCX

C     CONVERTING VLY(NE) INTO QLY(NE)
C      CALL QLCONVERT(QLY,VLY,SW,POR)
C      CALCULATING HEAT CONDUCTANCE
      CALL HEATCOND(HC, POR,SW)
      DO 10 I=1,NN1
      RHSWN(I)=WMA(I)/VOL(I)
      DRSNDT(I)=DWMADT(I)/VOL(I)
10      CONTINUE
C     VLH  - LATENT HEAT FOR VAPORIZATION [J/KG]
C     TMAK - ATMOSPHEREIC TEMPERATURE IN [K]
C     TIK  - INITIAL SOIL TEMPERATURE [K]
C     TSDK - TEMPERATURE ON THE SIDE OF THE COLUMN [K]
      VLH=(2.50025-0.002365*(TMA))*1.D6 
      TMAK=TMA+273.15 
      TIK=TMI+273.15                  
        TSDK=TSD+273.15                 
C     MATRIX CALCULATION
      DO 11 I=2,NN1-1

      C1  =-HC(I-1)/YY(I)/(Y(I)-Y(I-1))
      QV1 =-CP*RHOW0*QVYN(I-1)/2.D0/YY(I)
      QL1 =-CL*QLY(I-1)*(RHO(I)+RHO(I-1))/4/YY(I)
      AA(I)=C1+QV1+QL1

      S2  =+(HCS*ROUS+CL*RHSWN(I))/DELT
      DT2 =+CL*DRSNDT(I)
      C2  =+(HC(I)/(Y(I+1)-Y(I))+HC(I-1)/(Y(I)-Y(I-1)))/YY(I)
      QV2 =+CP*RHOW0*(QVYN(I)-QVYN(I-1))/2.D0/YY(I)
      QL2 =+CL*(QLY(I)*(RHO(I+1)+RHO(I))-QLY(I-1)*(RHO(I)+RHO(I-1)))
     4        /4.D0/YY(I)
      HS2 =+SCF*CA*SATM*DMAIR/RC/TSDK/RHVS(I)/XX(I) ! XX(I) IS HEAT EMMISION IS FROM SIDE (YZ PLANE).SEE PAGE68 OF BOOK2012
      BB(I)=S2+DT2+C2+QV2+QL2+HS2

      QV3 =+CP*RHOW0*QVYN(I)/2.D0/YY(I)
      QL3 =+CL*QLY(I)*(RHO(I+1)+RHO(I))/4.D0/YY(I)
      C3  =-HC(I)/YY(I)/(Y(I+1)-Y(I))
      CC(I)=QV3+QL3+C3

      SR  =+(HCS*ROUS+CL*RHSWN(I))/DELT*TPT(I)
      QVR =-RHOW0*(VLH-CP*TIK)*(QVYN(I)-QVYN(I-1))/YY(I)
      QLR =+CL*(QLY(I)*(RHO(I+1)+RHO(I))-QLY(I-1)*(RHO(I)+RHO(I-1))) 
     4        *TIK/2.D0/YY(I)
      DTR =+CL*TIK*DRSNDT(I)
      HSR =+SCF*CA*SATM*DMAIR/RC/RHVS(I)/XX(I) !XX(I) IS DUE TO HEAT EMMISION IS FROM SIDE (YZ PLANE)
      UU(I)=SR+QVR+QLR+DTR+HSR
11      CONTINUE
C-----------BOTTOM CELL ---------------
      I=1
      AA(I)=0.D0

      S2  = +(HCS*ROUS+CL*RHSWN(I))/DELT
      DT2 = +CL*DRSNDT(I)
      C2  = +(HC(I)/(Y(I+1)-Y(I)))/YY(I)         
      QV2 = +CP*RHOW0*(QVYN(I))/2.D0/YY(I)      
      QL2 = +CL*(QLY(I)*(RHO(I+1)+RHO(I)))/4.D0/YY(I)
      HS2 = +SCF*CA*SATM*DMAIR/RC/TSDK/RHVS(I)/XX(I)   ! THE XX(I)HEAT EMMISION IS FROM SIDE (YZ PLANE) RATHER THAN TOP (XY PLANE)
      BB(I)=S2+DT2+C2+QV2+QL2+HS2

      QV3 = +CP*RHOW0*QVYN(I)/2.D0/YY(I)           
      QL3 = +CL*QLY(I)*(RHO(I+1)+RHO(I))/4.D0/YY(I)
      C3  = -HC(I)/YY(I)/(Y(I+1)-Y(I))            
      CC(I)=QV3+QL3+C3

      SR  = +(HCS*ROUS+CL*RHSWN(I))/DELT*TPT(I) 
      QVR = -RHOW0*(VLH-CP*TIK)*(QVYN(I))/YY(I) 
      QLR = +CL*(QLY(I)*(RHO(I+1)+RHO(I)))*TIK/2.D0/YY(I)                    
      DTR = +CL*TIK*DRSNDT(I)                   
      HSR = +SCF*CA*SATM*DMAIR/RC/RHVS(I)/XX(I)   !THE XX(I) HEAT EMMISION IS FROM SIDE (YZ PLANE) RATHER THAN TOP (XY PLANE)
      UU(I)=SR+QVR+QLR+DTR+HSR

C-----------TOP CELL ---------------
      I=NN1
     
      C1  = -HC(I-1)/YY(I)/(Y(I)-Y(I-1))    
      QV1 = -CP*RHOW0*QVYN(I-1)/2.D0/YY(I)  
      QL1 = -CL*QLY(I-1)*(RHO(I)+RHO(I-1))/4/YY(I)
      AA(I)=C1+QV1+QL1

      S2  = +(HCS*ROUS+CL*RHSWN(I))/DELT     
      DT2 = +CL*DRSNDT(I)                    
      C2  = +(HC(I-1)/(Y(I)-Y(I-1)))/YY(I)   
      QV2 = +CP*RHOW0*(-QVYN(I-1))/2.D0/YY(I)
      QL2 = +CL*(-QLY(I-1)*(RHO(I)+RHO(I-1)))/4.D0/YY(I)            
      HS2 = +SCF*CA*SATM*DMAIR/RC/TSDK/RHVS(I)/XX(I) !SCF--SCALING EFFECT H2
      HT2 = +SWRAT*CA*SATM*DMAIR/RC/TMAK/RAVT/YY(I)        ! HEAT EXCHANGE FROM THE TOP
      BB(I)=S2+DT2+C2+QV2+QL2+HS2+HT2

      CC(I)=0.D0

      SR  = +(HCS*ROUS+CL*RHSWN(I))/DELT*TPT(I)
      QVR = -RHOW0*(VLH-CP*TIK)*(-QVYN(I-1))/YY(I)
      QLR = +CL*(-QLY(I-1)*(RHO(I)+RHO(I-1)))*TIK/2.D0/YY(I)
      DTR = +CL*TIK*DRSNDT(I)                     
      HSR = +SCF*CA*SATM*DMAIR/RC/RHVS(I)/XX(I)    !THE XX(I) THE HEAT EMMISION IS FROM SIDE (YZ PLANE) RATHER THAN TOP (XY PLANE)
      HTR = +SWRAT*CA*SATM*DMAIR/RC/RAVT/YY(I)
      HRTR= +HSC/YY(I)                             !HEAT SOURCE HSC IS ADDED， WARNING, HERE HEAT SOURCE IS CALCULATED EXPLICITELY!
      LHTR= +ACET(1)*VLH*RHOW0/YY(I)               !LHTR!EVAPORATION INDUCED LATENT HEAT, ACET IS NEGATIVE
      UU(I)=SR+QVR+QLR+DTR+HSR+HTR+HRTR+LHTR

      CALL TRIDAG(AA,BB,CC,UU,ANS,NN1)
      
C     RETURN THE VALUE BACK INTO TPT MATRIX AND STORE THE LAST TEMPERATURE VALUE INTO TPT1
      K=0
      DO 15 J=1,NN2 !LOOP ON X
      DO 7 I=1,NN1  !LOOP ON Y
      K=K+1
      TPT1(K)=TPT(K)
      TPT(K)=ANS(I)


7      CONTINUE
15      CONTINUE
C-----------------------------------------------------
      ELSEIF (MHT.EQ.3)THEN ! USING THE INITIAL TEMPATURE
      
      ENDIF

      RETURN
      END

C     CALCULATING SENSIBLE HEAT THAT MOVES OUT FROM SOLID TO THE ATMOSPHERE.
C     WHEN >0 ATMOSPHERE IS HEATING UP SOIL SURFACE
C     WHEN <0 SOIL SURFACE IS HEATING UP ATMOSPHERE
C     THE CALCULATION METHOD IS FROM MICHAEL (2010) AGRICULTRUAL AND FOREST METEOROLOGY 
      DOUBLE PRECISION FUNCTION SENHEAT(TS,TA,RAVT)      
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      DOUBLE PRECISION DMAIR,RC,SATM,CP
C      DATA  DMAIR /2.897D-2/, RC/8.314472D+0/,SATM /101.325D+3/
C     1 CP /1.01D+3/
C      SAVE DMAIR,RC,SATM,CP
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2,
     2   DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
C     RAVT   -- AERODYNAMIC RESISTANCE [S/M]
C      DMAIR -- MOLECULAR WEIGHT OF AIR 0.02897 [KG/MOL]
C     RC    -- GAS CONSTANT 8.314
C     SATM  -- STANDARD ATMOSPHERE PRESSURE [PA OR KG/M/S2 ]
C     CP    -- HEAT CAPACITY OF AIR   1010  [J/KG/K]
      a=-SATM*DMAIR*CP/RC/TA/RAVT
      SENHEAT=-SATM*DMAIR*CP/RC/TA*(TS-TA)/RAVT

      RETURN
      END

C     FUNCTION TO CALCULATE SURFACE RESISTANCE 
C     WHEN MSR=0, SYRFSIS=0
C     WHEN MSR=1, USING CAMILO(1986) FORMULAR
C     WHEN MSR=2, USING SUN (1982) FORMULAR
C     WHEN MSR=3, USING DAAMEN (1996) FORMULAR
C     WHEN MSR=4, USING VAN DER GRIEND (1994) FORMULAR
C     WHEN MSR=5, USING HYPERGEOMETRIC FUNCTIONS SEE PAGE 142 OF BLUEBOOK, 98(5)
C     WHEN MSR=6, USING APPROXIMATED EQUATION GIVEN BY PAPER 2
      DOUBLE PRECISION FUNCTION SURFRSIS(PP,POR,SW,MSR,KREG,TSK)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      COMMON /UNSA/ SWRES1,AA1,VN1,SWRES2,AA2,VN2,SWRES3,DLAM3,PHICB3,
     1SWRES4,DLAM4,PHICB4,PHIC0,ECTO
      COMMON /SURFR/ TAL,EC,ETR 
      COMMON /AERORESIS/ RAVT,RAVS,SWRAT
C     ZETA -- =2 SIGMA / ROWH0/G WHERE SIGMA IS 0.072 J/M2 SURFACE TENTION
      DOUBLE PRECISION ZETA
      DATA ZETA/1.46789D-5/
      SAVE ZETA
C    PP --PORE WATER PRESSURE
      IF (MSR.EQ.0) THEN
      SURFRSIS=0.D0
      ELSEIF(MSR.EQ.1)THEN
      SURFRSIS=-8.05D2+4.14D3*POR*(1-SW)
      ELSEIF(MSR.EQ.2)THEN
      SURFRSIS=3.5D0*SW**(-2.3D0)+33.5D0
      ELSEIF(MSR.EQ.3)THEN
      SURFRSIS=3.D10*(POR*(1-SW))**16.6D0
      ELSEIF(MSR.EQ.4)THEN
      SURFRSIS=10.D0*EXP(35.63D0*POR*(0.375D0-SW))
C     SEE PAGE 98(4) FOR REFERENCE
      ELSEIF(MSR.EQ.5)THEN
C       AA IS THE FIRST ARGUMENT OF THE HYPERGEOMETRIC FUNCTION WARNING: ONE SHOULD INPUT A VARIABLE IN
C       FUNCTION HYGFX RATHER THAN A VALUE!!!
        AA=1.D0
C       CONVERT PORE WATER PRESSURE (NEGATIVE) [PP] INTO CAPLIIARY HEAD (M)
        PHIC=-PP/9.8D3
C       CHECKING THE SOIL CHARACTERISTIC PARAMETERS
        IF(KREG.EQ.3)THEN
          DLAM=DLAM3
          PHICB=PHICB3
        ELSEIF(KERG.EQ.4)THEN
          DLAM=DLAM4   
          PHICB=PHICB4   
        ENDIF
C       EVALUATING RS BY DIFFERENT PHIC VALUE
        IF (PHIC.LE.PHICB)THEN
          SURFRSIS=0.D0
        ELSEIF (PHIC.GT.PHICB)THEN
          ETI=ETR*DLOG(PHIC0/PHIC)/DLOG(PHIC0)
          ETRMS=1.D0-ETI
          ETB=ETR*DLOG(PHIC0/PHICB)/DLOG(PHIC0)
          ETBMS=1.D0-ETB
C         (E)FFECTIVE (S)ATURATION
          SE=(PHICB/PHIC)**DLAM
C         PORSE
          PORSE=POR*SE
C         PARAMETER IN THE HYPERGEOMETRIC
          C=(1/PORSE-1/SQRT(PORSE))/2.D0/TAL
C         PARAMETER WHEN SE=1
          C0=(1/POR-1/SQRT(POR))/2.D0/TAL
          DNUM=SE**EC*HYGFX(AA,DLAM,1+DLAM,-C*ZETA/PHIC)*ETRMS+ETI
          DNOM=HYGFX(AA,DLAM,1+DLAM,-C0*ZETA/PHICB)*ETBMS+ETB
          DNET=DNUM/DNOM
C IT IS A QUESTION WHY THE EQUATION IS FORMULATED AS THIS?
          SURFRSIS=RAVT/DNET-RAVT
        ENDIF
C    SURFACE RESISTANCE AFTER THE APPROXIMATION SEE PAGE 
      ELSEIF(MSR.EQ.6)THEN
C       CONVERT PORE WATER PRESSURE (NEGATIVE) [PP] INTO CAPLIIARY HEAD (M)
        PHIC=-PP/9.8D3
C       CHECKING THE SOIL CHARACTERISTIC PARAMETERS
        IF(KREG.EQ.3)THEN
          DLAM=DLAM3
          PHICB=PHICB3
        ELSEIF(KERG.EQ.4)THEN
          DLAM=DLAM4   
          PHICB=PHICB4   
        ENDIF
C       EVALUATING RS BY DIFFERENT PHIC VALUE
        IF (PHIC.LE.PHICB)THEN
          SURFRSIS=0.D0
        ELSEIF (PHIC.GT.PHICB)THEN
          ETI=ETR*DLOG(PHIC0/PHIC)/DLOG(PHIC0)
          ETRMS=1.D0-ETI
C         (E)FFECTIVE (S)ATURATION AFTER G FUNCTION
          SET=(PHICB/PHIC)**(DLAM*(1+EC))
C         POR*SET
          PORSE=POR*SET
C         PARAMETER IN THE HYPERGEOMETRIC
          C=(1/PORSE-1/SQRT(PORSE))/2.D0/TAL
C         EXPECTANT VALUE OF R1 AT GIVEN MATRIC POTENTIAL (UNDER BROOKS&COREY)
C         SEE EQUATION (A1) OF PAPER 2
          R1EFF=DLAM*ZETA/(DLAM+1)/PHIC
          RELKV=1/(1+C*R1EFF)*ETRMS+ETI
          SURFRSIS=TAL/DA(TSK)/RELKV
        ENDIF


      ENDIF


      IF (SURFRSIS.LT.0.D0) SURFRSIS=0.D0
      RETURN 
      END



C      QVCONVERT SUB IS USED FOR COVERTING MATRIX QVY (MXD-1,NFY) INTO QVYN(NN1-1)
C      THE MAIN REASON OF HAVING THIS SUB IS DUE TO THE WRONG DIRECTION OF MATRICES 
C      NREF AND NDPT WHICH IS AGAINST THE DIRECTION OF X AND Y. IN THE FUTURE THIS KIND
C      OF PROBLEM SHOULD ALWAYS BE AVOID
      SUBROUTINE QVCONVERT(QVY,QVYN)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      COMMON /DEPTH/  MXD,NFY
      DIMENSION QVY(MXD-1,NFY),QVYN(NN1-1)
      COMMON /SOLVI/ KSOLVP, KSOLVU, NN1, NN2, NN3

      DO 1 I=1,NN1-1
      QVYN(I)=QVY(MXD-I,1)
1      CONTINUE
      RETURN
      END

C      QLCONVERT IS TO CONVERT PORE WATER VELOCITY QLY INTO DARCY VELOCITY
C      WHICH IS QLY=SW*POR*VLY. HOWEVER, SINCE THE CURRENT HEAT BALANCE IS ONLY CONDUCTED IN 1D
C      ONLY THE FIRST COLUMN IS CONVERTED
      SUBROUTINE QLCONVERT(QLY,VLY,SW,POR)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC, 
     1   NSOP,NSOU,NBCN,NCIDB 
      COMMON /SOLVI/ KSOLVP, KSOLVU, NN1, NN2, NN3
      DIMENSION QLY(NN1-1),VLY(NE),SW(NN),POR(NN)
      DO 1 I=1,NN1-1
       QLY(I)=VLY(I)*(SW(I)+SW(I+1))*(POR(I)+POR(I+1))/4.D0
1      CONTINUE
      RETURN
      END


C      HEATCOND IS TO CALCULATE THE HEAT CONDUCTANCE
C  DATASET 13J: THERMAL CONDUCTIVITIES OF WATER AND LIQUID
C   NTC -- TYPE OF (T)HERMAL (C)ONDUCTIVITIES EQUATION: 
C              NTC=1, USING EQUATIONS FROM SUTRA MANUAL, THEN [TCS] AND [TCL] HAS TO BE INPUT 
C                     TCS -- THERMAL CONDUCTIVITY OF SOIL  USUALLY BETWEEN 2-4 W/M/K
C                     TCL -- THERMAL CONDUCTIVITY OF LIQUID WATER, 0.6      W/M/K
C              NTC=2, USING EQUATION FROM CHUNG AND HORTON (1987) THREE PARAMETERS [B1] [B2] [B3] IS REQUIRED 
      SUBROUTINE HEATCOND(HC, POR,SW)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
        COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC, 
     1   NSOP,NSOU,NBCN,NCIDB 
      COMMON /SOLVI/ KSOLVP, KSOLVU, NN1, NN2, NN3
        COMMON /TC/ TCS,TCL,B1,B2,B3,NTC
      DIMENSION HC(NN1-1),SW(NN),POR(NN)
        IF (NTC.EQ.1)THEN
        DO 1 I=1,NN1-1
            SWM=(SW(I)+SW(I+1))/2.D0
            PORM=(POR(I)+POR(I+1))/2.D0
           HC(I)=TCL*SWM*PORM+(1.0D0-PORM)*TCS
1        CONTINUE
        ELSEIF(NTC.EQ.2)THEN
        DO 2 I=1,NN1-1
            SWM=(SW(I)+SW(I+1))/2.D0
            PORM=(POR(I)+POR(I+1))/2.D0
            HC(I)=B1+B2*SWM*PORM+B3*(SWM*PORM)**0.5D0
 2        CONTINUE   
        ENDIF
      RETURN
      END



C     TRIDIAG IS TO SOLVE TRADIAGNAL MATRIX
C     THIS IS OBTAINED FROM NUMERICAL RECIPIE
      SUBROUTINE TRIDAG(A,B,C,R,U,N)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      INTEGER N,NMAX
      DIMENSION A(N),B(N),C(N),R(N),U(N)
      PARAMETER (NMAX=500)
C      SOLVES FOR A VECTOR U(1:N) OF LENGTH N THE TRIDIAGONAL LINEAR SET GIVEN BY EQUATION (2.4.1).
C      A(1:N), B(1:N), C(1:N), AND R(1:N) ARE INPUT VECTORS AND ARE NOT MODIFED.
C      PARAMETER: NMAX IS THE MAXIMUM EXPECTED VALUE OF N.
      INTEGER J
      DIMENSION GAM(NMAX) !ONE VECTOR OF WORKSPACE, GAM IS NEEDED.
C      IF(B(1).EQ.0.)PAUSE !TRIDAG: REWRITE EQUATIONS'
C     IF THIS HAPPENS THEN YOU SHOULD REWRITE YOUR EQUATIONS AS A SET OF ORDER N - 1, WITH U2
C     TRIVIALLY ELIMINATED.
      BET=B(1)
      U(1)=R(1)/BET
      DO 11 J=2,N !DECOMPOSITION AND FORWARD SUBSTITUTION.
      GAM(J)=C(J-1)/BET
      BET=B(J)-A(J)*GAM(J)
C      IF(BET.EQ.0.)PAUSE !TRIDAG FAILED' ALGORITHM FAILS; SEE BELOW.
      U(J)=(R(J)-A(J)*U(J-1))/BET
11      ENDDO 
      DO 12 J=N-1,1,-1 !BACKSUBSTITUTION.
      U(J)=U(J)-GAM(J+1)*U(J+1)
12    ENDDO
      RETURN
      END

C      FUNCTION FYM IS TO CALCULATE THE OSMOTICAL POTENTIAL FROM PORE WATER PRESSURE
C     INPUT CONDITIONS 
C      P -- PORE WATER PRESSURE [PA]
C     ROU - PURE WATER DENSITY [KG/M3]
C     G  -- GRAVATIONAL ACCERATION [M/S2]
      DOUBLE PRECISION FUNCTION FYM(P)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      DATA  ROU/1.D3/, G/9.8D0/
      SAVE ROU,G
      FYM=P/ROU/G
      RETURN 
      END
C      FUNCTION FYO IS TO CALCULATE THE OSMOTICAL POTENTIAL FROM PORE WATER PRESSURE
C     CALLED FUNCTION AND SUBROUTINES:
C     CHI(C) TO GET OSMOTIC COEFFICIENTS, BASED ON ROBINSON AND STOKES (1965)
      DOUBLE PRECISION FUNCTION FYO(C,T)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      DATA  RC/8.314472D+0/,G/9.8D0/,STM/5.85D-2/
      SAVE RC,G,STM
      FYO=-2.D0*CHI(C)*C*RC*T/G/STM
      RETURN 
      END

C     FUNCTION HR IS TO CALCULATE THE RELATIVE HUMIDITY ACCORDING TO KELVEN'S EQUATION
      DOUBLE PRECISION FUNCTION HR(FM,FO,T)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      DATA  RC/8.314472D+0/,G/9.8D0/,WMW/1.8D-2/
      SAVE RC,G,WMW
      HR=EXP((FM+FO)*G*WMW/RC/T)
      RETURN 
      END

C     FUNCTION YITA IS TO CALCULATE ENHANCEMENT FACTOR PROPOSED BY CASS (1981)
C     THE FIRST INPUT NL, DETERMINES THE LOCATION OF THE ENHANCEMENT FACTOR AT WATER VAPOR CALCULATION
C   NEF -- THE SWITCH TO THE ENHANCEMENT FACTOR
C            =0, ENHANCEMENT FACTOR EQUALS TO 1
C            =1, APPLY ENHANCEMENT FACTOR TO THE TEMPERATURE GRADIENT TERM ONLY
C            =2, APPLY ENHANCEMENT FACTOR TO ALL OF THE TERMS
      DOUBLE PRECISION FUNCTION YITA(NL,SW)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      COMMON /ENHFAC/ YA,YB,YC,YD,YE,FC,NEF
        IF (NEF.EQ.0)THEN 
           YITA=1.D0
        ELSEIF (NEF.EQ.1)THEN
          IF ((NL.EQ.1).OR.(NL.EQ.2).OR.(NL.EQ.4)) THEN !DPDX
           YITA=1.D0
          ELSEIF(NL.EQ.3)THEN
C            YITA=9.5D0+3.D0*SW-8.5*EXP(-((1.D0+2.6D0/SQRT(F))*SW)**4.D0)
            YITA=YA+YB*SW-(YA-YD)*EXP(-( (1.D0+YC/SQRT(FC)) *SW) **YE)
          ENDIF
        ELSEIF (NEF.EQ.2)THEN
C            YITA=9.5D0+3.D0*SW-8.5*EXP(-((1.D0+2.6D0/SQRT(F))*SW)**4.D0)
            YITA=YA+YB*SW-(YA-YD)*EXP(-( (1.D0+YC/SQRT(FC)) *SW) **YE)
        ENDIF
      RETURN 
      END


C
      SUBROUTINE ETOPT(IT,DELT,NFY,ACET)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      DIMENSION ACET(NFY)
      IF (IT.EQ.1) THEN                                         ! OUTPUT EVAPORATION RATE TO BCO.DAT
      OPEN(21,FILE='BCO.DAT',STATUS='OLD',POSITION='APPEND')                  ! SHOUD IT BE APPENDED?
      WRITE(21,98)
98      FORMAT('  IT',4X,'TIME(DAY)',3X,'ETRATE(M/S)')
      ENDIF
      WRITE(21,99) IT, DBLE(IT)*DELT/3600./24. ,(ACET(I),I=1,NFY)
99      FORMAT(I7,(1PE10.2,2X),500(1PE10.3,1X))
      RETURN
      END

C       OUTPUT HEAT BOUNDARY CONDITIONS
      SUBROUTINE OUTHEAT (X,Y,Z,HANN,VANN,
     1   XX,YY,TPT,HSS,HST,HET,HGT)       
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      COMMON /ET/ QET,UET,PET,UVM,NGT,ITE,TMA,TMI,ALF,RS,RH,AP,BP,U2,
     1   TSD,SCF
      COMMON /SOLVI/ KSOLVP, KSOLVU, NN1, NN2, NN3
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,
     1   NSOP,NSOU,NBCN,NCIDB
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2,
     2   DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      DIMENSION X(NN),Y(NN),Z(NN),XX(NN),YY(NN),TPT(NN)
      DIMENSION HANN(NN),VANN(NN),HSS(NN1)
      DIMENSION HLS(NN1),RHVS(NN1)
C      DATA CL/4.186D3/, CP/2.D3/, CA/1.01D3/,DMAIR /2.897D-2/,
C     1     RC/8.314472D+0/,SATM /101.325D+3/
C      SAVE CL,CP,CA,DMAIR,RC,SATM
         NSOPI=NSOP-1
C-----IF IT IS THE FIRST TIME, OUTPUT THE CROSS SECTION OF THE HEAT AREA
      IF (IT.EQ.1) THEN
        OPEN(22,FILE='HEAT.DAT',STATUS='UNKNOWN')           
        WRITE(22,2)
2       FORMAT('NODE',13X,'X',12X,'Y',12X,'Z',8X,'XX',11X,'YY',
     1  11X,'HAREA',8X,'VAREA')
       DO 1 I=1,NN1
            WRITE(22,3) IABS(I), X(I),Y(I),Z(I),
     1       XX(I),YY(I),HANN(I),VANN(I)*SCF
1        CONTINUE
3      FORMAT(I5,1X,9(1PE12.5,1X))
C       HEADERS FOR HEAT RESULT
      WRITE(22,98)
98      FORMAT('  IT',4X,'TIME(DAY)',3X,'G TOP (J)',2X,'ET TOP (J)',
     1       1X,'SEN. TOP (J)','SEN.SIDE',2X,'SEN. SIDE DETAIL.'
     2  ,6X'TPT (K)')
        CLOSE(22)
      ENDIF

      OPEN(22,FILE='HEAT.DAT',STATUS='OLD',POSITION='APPEND')
      WRITE(22,99) IT, DBLE(IT)*DELT/3600./24.,HGT,HET,HST,
     1(HSS(I),I=1,NN1)   !,(TPT(I),I=1,NN1)
99      FORMAT(I7,(1PE10.2,2X),500(1PE10.3,1X))
        CLOSE(22)
        RETURN
        END

C     HEATBALANCE IS TO CALCULATE THE MASS BALANCE OF THE HEAT EQUATION
C     SEE PAGE 125 (BLUECOVER) FOR REFERENCE
      SUBROUTINE  HEATBALANCE (NHEAT,HSS,HST,HET,HGT,HANN,VANN,TPT,TPT1
     1 ,VOL,WMA,RHVS,ACET,DWMADT,HMA,ISTOP)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,   
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2     
     2   ,DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /TIMES/ DELT,TSEC,TMIN,THOUR,TDAY,TWEEK,TMONTH,TYEAR,       
     1   TMAX,DELTP,DELTU,DLTPM1,DLTUM1,IT,ITBCS,ITRST,ITMAX,TSTART      

      COMMON /HEATPARA/ HSC,HER,ROUS,HCS
      COMMON /DIMS/ NN,NE,NIN,NBI,NCBI,NB,NBHALF,NPBC,NUBC,    
     1   NSOP,NSOU,NBCN,NCIDB
      COMMON /DEPTH/ MXD,NFY
      COMMON /AERORESIS/ RAVT,RAVS,SWRAT
      DIMENSION ACET(NFY),DWMADT(NN)
      COMMON /SOLVI/ KSOLVP,KSOLVU,NN1,NN2,NN3                          
      DIMENSION HMA(NN1),RHVS(NN1)
      DIMENSION HANN(NN),VANN(NN),HSS(NN1)
      DIMENSION TPT(NN),TPT1(NN),VOL(NN),WMA(NN)

C      DATA CL/4.186D3/, CP/2.D3/, CA/1.01D3/,DMAIR /2.897D-2/,
C     1     RC/8.314472D+0/,SATM /101.325D+3/
C      SAVE CL,CP,CA,DMAIR,RC,SATM,HMAI,THET,THGT,THSS,THST
C     HMAI-- (I)NITIAL (H)EAT (MA)SS FOR ALL THE NODES
C     HMA -- (H)EAT (MA)SS IN THE CURRENT TIME STEP
C     VLH  - LATENT HEAT FOR VAPORIZATION [J/KG]
C     TMAK - ATMOSPHEREIC TEMPERATURE IN [K]
C     TIK  - INITIAL SOIL TEMPERATURE [K]
C     TSDK - TEMPERATURE ON THE SIDE OF THE COLUMN [K]
      VLH=(2.50025-0.002365*(TMA))*1.D6 
      TMAK=TMA+273.15 
      TIK=TMI+273.15                  
      TSDK=TSD+273.15                 
C-------INITIALIZE THE MATRIX AT THE FIRST TIME TO CALL HEATBALANCE-----
      IF (.NOT.NHEAT)THEN
C         THE INITIALIZATION OF HSS,HST,HET,HGT ARE IN SUB SUTRA BECAUSE THEY NEED TO BE TRANSFERED
        HMAI=0.D0
        THET=0.D0
        THGT=0.D0
        THSS=0.D0
        THST=0.D0
        DO 1 I=1,NN1
          HMA(I)=(HCS*ROUS*VOL(I)+CL*WMA(I))*(TPT(I)-TIK)
          HMAI=HMAI+HMA(I)
 1      CONTINUE
C-------CALCULATE HEAT BALANCE FOR THE OTHER TIME CALLING HEATBALANCE----
      ELSEIF(NHEAT)THEN
        DO 2 I=1,NN1
C       HEAT GAIN/LOSS DUE TO TEMPERATURE CHANGE          
          HMA(I)=HMA(I)+(HCS*ROUS*VOL(I)+CL*WMA(I))*(TPT(I)-TPT1(I))
C       HEAT GAIN/LOSS DUE TO WATER CHANGE
          HMA(I)=HMA(I)+CL*DWMADT(I)*DELTP*(TPT(I)-TIK)
C       (H)EAT GAIN/LOSS DUE TO (S)ENSIBLE HEAT EXCHANGE FROM (S)IDE
          HSS(I)=-SCF*CA*SATM*DMAIR/RC/TSDK/RHVS(I)*(TPT(I)-TSDK)
     1        *VANN(I)*DELTP
C       (T)OTAL (H)EAT GAIN/LOSS DUE TO (S)ENSIBLE HEAT EXCHANGE FROM (S)IDE
          THSS=THSS+HSS(I) 
 2         CONTINUE

C       (H)EAT GAIN/LOSS DUE TO (E)VAPORA(T)ION
          HET=+ACET(1)*VLH*RHOW0*HANN(NN1)*DELTP
C       (T)OTAL (H)EAT GAIN/LOSS DUE TO (E)VAPORA(T)ION
          THET=THET+HET
C       (H)EAT GAIN/LOSS DUE TO (S)ENSIBLE HEAT EXCHANGE FROM (T)OP
          HST=-SWRAT*CA*SATM*DMAIR/RC/TMAK/RAVT*(TPT(NN1)-TMAK)
     1        *HANN(NN1)*DELTP
C       (T)OTAL (H)EAT GAIN/LOSS DUE TO (S)ENSIBLE HEAT EXCHANGE FROM (T)OP
          THST=THST+HST
C       (H)EAT (G)AIN FROM THE (T)OP
          HGT=HSC*HANN(NN1)*DELTP
C       (T)OTAL (H)EAT (G)AIN FROM THE (T)OP
          THGT=THGT+HGT
        ENDIF
        
      IF (ISTOP.EQ.1)THEN
       HMAF=0.D0
       DO 3 I=1,NN
C      (H)EAT (M)ASS IN THE DOMAIN AT (F)INAL STEP
         HMAF=HMAF+HMA(I)
3      CONTINUE
      OPEN(22,FILE='HEAT.DAT',STATUS='OLD',POSITION='APPEND')
      WRITE(22,7)
C       NET (H)EAT (S)TORAGE IN THE (D)OMAIN
        HSD=HMAF-HMAI
C       NET (H)EAT (E)XCHANGE FROM (B)OUNDARY
        HEB=THET+THST+THSS+THGT
 7      FORMAT(/,'HEAT BALANCE')
        WRITE(22,8)HMAI,HMAF,THET,THST,THSS,THGT,HSD,
     1 HEB,HSD-HEB,(HSD-HEB)/HEB
 8      FORMAT('INITIAL HEAT STORAGE IS (J)',18X,':',3X,1PE15.8,/
     6,'FINAL HEAT STORAGE IS',24X,':',3X,1PE15.8,/
     2,'TOTAL HEAT LOSS(-) BY EVAPORATIONT  IS (J)   :',3X,1PE15.8,/
     3,'TOTAL SENSIBLE HEAT GAIN(+)/LOSS(-) AT TOP   :',3X,1PE15.8,/
     1,'TOTAL SENSIBLE HEAT GAIN(+)/LOSS(-) AT SIDE  :',3X,1PE15.8,/
     1,'TOTAL HEAT INPUT(+) FROM TOP IS   (J)        :',3X,1PE15.8,//
     4,'NET HEAT STORAGE IN THE DOMAIN IS (J)        :',3X,1PE15.8,/
     5,'NET HEAT GAIN(+)/LOSS(-) FROM BOUNDARY IS (J):',3X,1PE15.8,//
     4,'ABSOLUTE HEAT DIF. BTW STORAGE AND IN&OUT (J):',3X,1PE15.8,/
     5,'RELATIVE HEAT DIF. BTW STORAGE AND IN&OUT (-):',3X,1PE15.8,/)
        CLOSE(22)
        ENDIF
        RETURN
        END


C     CALCULATE THE HYPERGEOMETRIC FUNCTION RESULT
C       WARNING: ONE SHOULD INPUT A VARIABLE IN
C       FUNCTION HYGFX RATHER THAN A VALUE!!!
      DOUBLE PRECISION FUNCTION HYGFX(A,B,C,X)
C
C       ====================================================
C       Purpose: Compute hypergeometric function F(a,b,c,x)
C       Input :  a --- Parameter
C                b --- Parameter
C                c --- Parameter, c <> 0,-1,-2,...
C                x --- Argument   ( x < 1 )
C       Output:  HYGFX --- F(a,b,c,x)
C       Routines called:
C            (1) GAMMA for computing gamma function
C            (2) PSI for computing psi function
C       ====================================================
C
        IMPLICIT DOUBLE PRECISION (A-H,O-Z)
        LOGICAL L0,L1,L2,L3,L4,L5
        PI=3.141592653589793D0
        EL=.5772156649015329D0
        L0=C.EQ.INT(C).AND.C.LT.0.0
        L1=1.0D0-X.LT.1.0D-15.AND.C-A-B.LE.0.0
        L2=A.EQ.INT(A).AND.A.LT.0.0
        L3=B.EQ.INT(B).AND.B.LT.0.0
        L4=C-A.EQ.INT(C-A).AND.C-A.LE.0.0
        L5=C-B.EQ.INT(C-B).AND.C-B.LE.0.0
        IF (L0.OR.L1) THEN
           WRITE(*,*)'The hypergeometric series is divergent'
           RETURN
        ENDIF
        EPS=1.0D-15
        IF (X.GT.0.95) EPS=1.0D-8
        IF (X.EQ.0.0.OR.A.EQ.0.0.OR.B.EQ.0.0) THEN
           HYGFX=1.0D0
           RETURN
        ELSE IF (1.0D0-X.EQ.EPS.AND.C-A-B.GT.0.0) THEN
           CALL GAMMA(C,GC)
           CALL GAMMA(C-A-B,GCAB)
           CALL GAMMA(C-A,GCA)
           CALL GAMMA(C-B,GCB)
           HYGFX=GC*GCAB/(GCA*GCB)
           RETURN
        ELSE IF (1.0D0+X.LE.EPS.AND.DABS(C-A+B-1.0).LE.EPS) THEN
           G0=DSQRT(PI)*2.0D0**(-A)
           CALL GAMMA(C,G1)
           CALL GAMMA(1.0D0+A/2.0-B,G2)
           CALL GAMMA(0.5D0+0.5*A,G3)
           HYGFX=G0*G1/(G2*G3)
           RETURN
        ELSE IF (L2.OR.L3) THEN
           IF (L2) NM=INT(ABS(A))
           IF (L3) NM=INT(ABS(B))
           HYGFX=1.0D0
           R=1.0D0
           DO 10 K=1,NM
              R=R*(A+K-1.0D0)*(B+K-1.0D0)/(K*(C+K-1.0D0))*X
10            HYGFX=HYGFX+R
           RETURN
        ELSE IF (L4.OR.L5) THEN
           IF (L4) NM=INT(ABS(C-A))
           IF (L5) NM=INT(ABS(C-B))
           HYGFX=1.0D0
           R=1.0D0
           DO 15 K=1,NM
              R=R*(C-A+K-1.0D0)*(C-B+K-1.0D0)/(K*(C+K-1.0D0))*X
15            HYGFX=HYGFX+R
           HYGFX=(1.0D0-X)**(C-A-B)*HYGFX
           RETURN
        ENDIF
        AA=A
        BB=B
        X1=X
        IF (X.LT.0.0D0) THEN
           X=X/(X-1.0D0)
           IF (C.GT.A.AND.B.LT.A.AND.B.GT.0.0) THEN
              A=BB
              B=AA
           ENDIF
           B=C-B
        ENDIF
        IF (X.GE.0.75D0) THEN
           GM=0.0D0
           IF (DABS(C-A-B-INT(C-A-B)).LT.1.0D-15) THEN
              M=INT(C-A-B)
              CALL GAMMA(A,GA)
              CALL GAMMA(B,GB)
              CALL GAMMA(C,GC)
              CALL GAMMA(A+M,GAM)
              CALL GAMMA(B+M,GBM)
              CALL PSI(A,PA)
              CALL PSI(B,PB)
              IF (M.NE.0) GM=1.0D0
              DO 30 J=1,ABS(M)-1
30               GM=GM*J
              RM=1.0D0
              DO 35 J=1,ABS(M)
35               RM=RM*J
              F0=1.0D0
              R0=1.0D0
              R1=1.0D0
              SP0=0.D0
              SP=0.0D0
              IF (M.GE.0) THEN
                 C0=GM*GC/(GAM*GBM)
                 C1=-GC*(X-1.0D0)**M/(GA*GB*RM)
                 DO 40 K=1,M-1
                    R0=R0*(A+K-1.0D0)*(B+K-1.0)/(K*(K-M))*(1.0-X)
40                  F0=F0+R0
                 DO 45 K=1,M
45                  SP0=SP0+1.0D0/(A+K-1.0)+1.0/(B+K-1.0)-1.0/K
                 F1=PA+PB+SP0+2.0D0*EL+DLOG(1.0D0-X)
                 DO 55 K=1,250
                    SP=SP+(1.0D0-A)/(K*(A+K-1.0))+(1.0-B)/(K*(B+K-1.0))
                    SM=0.0D0
                    DO 50 J=1,M
50                     SM=SM+(1.0D0-A)/((J+K)*(A+J+K-1.0))+1.0/
     &                    (B+J+K-1.0)
                    RP=PA+PB+2.0D0*EL+SP+SM+DLOG(1.0D0-X)
                    R1=R1*(A+M+K-1.0D0)*(B+M+K-1.0)/(K*(M+K))*(1.0-X)
                    F1=F1+R1*RP
                    IF (DABS(F1-HW).LT.DABS(F1)*EPS) GO TO 60
55                  HW=F1
60               HYGFX=F0*C0+F1*C1
              ELSE IF (M.LT.0) THEN
                 M=-M
                 C0=GM*GC/(GA*GB*(1.0D0-X)**M)
                 C1=-(-1)**M*GC/(GAM*GBM*RM)
                 DO 65 K=1,M-1
                    R0=R0*(A-M+K-1.0D0)*(B-M+K-1.0)/(K*(K-M))*(1.0-X)
65                  F0=F0+R0
                 DO 70 K=1,M
70                  SP0=SP0+1.0D0/K
                 F1=PA+PB-SP0+2.0D0*EL+DLOG(1.0D0-X)
                 DO 80 K=1,250
                    SP=SP+(1.0D0-A)/(K*(A+K-1.0))+(1.0-B)/(K*(B+K-1.0))
                    SM=0.0D0
                    DO 75 J=1,M
75                     SM=SM+1.0D0/(J+K)
                    RP=PA+PB+2.0D0*EL+SP-SM+DLOG(1.0D0-X)
                    R1=R1*(A+K-1.0D0)*(B+K-1.0)/(K*(M+K))*(1.0-X)
                    F1=F1+R1*RP
                    IF (DABS(F1-HW).LT.DABS(F1)*EPS) GO TO 85
80                  HW=F1
85               HYGFX=F0*C0+F1*C1
              ENDIF
           ELSE
              CALL GAMMA(A,GA)
              CALL GAMMA(B,GB)
              CALL GAMMA(C,GC)
              CALL GAMMA(C-A,GCA)
              CALL GAMMA(C-B,GCB)
              CALL GAMMA(C-A-B,GCAB)
              CALL GAMMA(A+B-C,GABC)
              C0=GC*GCAB/(GCA*GCB)
              C1=GC*GABC/(GA*GB)*(1.0D0-X)**(C-A-B)
              HYGFX=0.0D0
              R0=C0
              R1=C1
              DO 90 K=1,250
                 R0=R0*(A+K-1.0D0)*(B+K-1.0)/(K*(A+B-C+K))*(1.0-X)
                 R1=R1*(C-A+K-1.0D0)*(C-B+K-1.0)/(K*(C-A-B+K))
     &              *(1.0-X)
                 HYGFX=HYGFX+R0+R1
                 IF (DABS(HYGFX-HW).LT.DABS(HYGFX)*EPS) GO TO 95
90               HW=HYGFX
95            HYGFX=HYGFX+C0+C1
           ENDIF
        ELSE
           A0=1.0D0
           IF (C.GT.A.AND.C.LT.2.0D0*A.AND.
     &         C.GT.B.AND.C.LT.2.0D0*B) THEN
              A0=(1.0D0-X)**(C-A-B)
              A=C-A
              B=C-B
           ENDIF
           HYGFX=1.0D0
           R=1.0D0
           DO 100 K=1,250
              R=R*(A+K-1.0D0)*(B+K-1.0D0)/(K*(C+K-1.0D0))*X
              HYGFX=HYGFX+R
              IF (DABS(HYGFX-HW).LE.DABS(HYGFX)*EPS) GO TO 105
100           HW=HYGFX
105        HYGFX=A0*HYGFX
        ENDIF
        IF (X1.LT.0.0D0) THEN
           X=X1
           C0=1.0D0/(1.0D0-X)**AA
           HYGFX=C0*HYGFX
        ENDIF
        A=AA
        B=BB
        IF (K.GT.120) WRITE(*,115)
115     FORMAT(1X,'Warning! You should check the accuracy')
        RETURN
        END


        SUBROUTINE GAMMA(X,GA)
C
C       ==================================================
C       Purpose: Compute gamma function â(x)
C       Input :  x  --- Argument of â(x)
C                       ( x is not equal to 0,-1,-2,úúú)
C       Output:  GA --- â(x)
C       ==================================================
C
        IMPLICIT DOUBLE PRECISION (A-H,O-Z)
        DIMENSION G(26)
        PI=3.141592653589793D0
        IF (X.EQ.INT(X)) THEN
           IF (X.GT.0.0D0) THEN
              GA=1.0D0
              M1=X-1
              DO 10 K=2,M1
10               GA=GA*K
           ELSE
              GA=1.0D+300
           ENDIF
        ELSE
           IF (DABS(X).GT.1.0D0) THEN
              Z=DABS(X)
              M=INT(Z)
              R=1.0D0
              DO 15 K=1,M
15               R=R*(Z-K)
              Z=Z-M
           ELSE
              Z=X
           ENDIF
           DATA G/1.0D0,0.5772156649015329D0,
     &          -0.6558780715202538D0, -0.420026350340952D-1,
     &          0.1665386113822915D0,-.421977345555443D-1,
     &          -.96219715278770D-2, .72189432466630D-2,
     &          -.11651675918591D-2, -.2152416741149D-3,
     &          .1280502823882D-3, -.201348547807D-4,
     &          -.12504934821D-5, .11330272320D-5,
     &          -.2056338417D-6, .61160950D-8,
     &          .50020075D-8, -.11812746D-8,
     &          .1043427D-9, .77823D-11,
     &          -.36968D-11, .51D-12,
     &          -.206D-13, -.54D-14, .14D-14, .1D-15/
           GR=G(26)
           DO 20 K=25,1,-1
20            GR=GR*Z+G(K)
           GA=1.0D0/(GR*Z)
           IF (DABS(X).GT.1.0D0) THEN
              GA=GA*R
              IF (X.LT.0.0D0) GA=-PI/(X*GA*DSIN(PI*X))
           ENDIF
        ENDIF
        RETURN
        END


        SUBROUTINE PSI(X,PS)
C
C       ======================================
C       Purpose: Compute Psi function
C       Input :  x  --- Argument of psi(x)
C       Output:  PS --- psi(x)
C       ======================================
C
        IMPLICIT DOUBLE PRECISION (A-H,O-Z)
        XA=DABS(X)
        PI=3.141592653589793D0
        EL=.5772156649015329D0
        S=0.0D0
        IF (X.EQ.INT(X).AND.X.LE.0.0) THEN
           PS=1.0D+300
           RETURN
        ELSE IF (XA.EQ.INT(XA)) THEN
           N=XA
           DO 10 K=1 ,N-1
10            S=S+1.0D0/K
           PS=-EL+S
        ELSE IF (XA+.5.EQ.INT(XA+.5)) THEN
           N=XA-.5
           DO 20 K=1,N
20            S=S+1.0/(2.0D0*K-1.0D0)
           PS=-EL+2.0D0*S-1.386294361119891D0
        ELSE
           IF (XA.LT.10.0) THEN
              N=10-INT(XA)
              DO 30 K=0,N-1
30               S=S+1.0D0/(XA+K)
              XA=XA+N
           ENDIF
           X2=1.0D0/(XA*XA)
           A1=-.8333333333333D-01
           A2=.83333333333333333D-02
           A3=-.39682539682539683D-02
           A4=.41666666666666667D-02
           A5=-.75757575757575758D-02
           A6=.21092796092796093D-01
           A7=-.83333333333333333D-01
           A8=.4432598039215686D0
           PS=DLOG(XA)-.5D0/XA+X2*(((((((A8*X2+A7)*X2+
     &        A6)*X2+A5)*X2+A4)*X2+A3)*X2+A2)*X2+A1)
           PS=PS-S
        ENDIF
        IF (X.LT.0.0) PS=PS-PI*DCOS(PI*X)/DSIN(PI*X)-1.0D0/X
        RETURN
        END



      SUBROUTINE UNSAT(SW,DSWDP,RELK,PRES,KREG)                          UNSAT.........1900
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)                                UNSAT.........2000
      DIMENSION KTYPE(2)                                                 UNSAT.........2100
      COMMON /CONTRL/ GNUP,GNUU,UP,DTMULT,DTMAX,ME,ISSFLO,ISSTRA,ITCYC,  UNSAT.........2200
     1   NPCYC,NUCYC,NPRINT,NBCFPR,NBCSPR,NBCPPR,NBCUPR,IREAD,           UNSAT.........2300
     2   ISTORE,NOUMAT,IUNSAT,KTYPE,MET,MAR,MSR,MSC,MHT,MVT,MFT,MRK
C     2   ISTORE,NOUMAT,IUNSAT,KTYPE                                      UNSAT.........2400
C                                                                        UNSAT.........2500
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -- UNSAT.........2600
C     E X A M P L E   C O D I N G   FOR                                  UNSAT.........2700
C     MESH WITH TWO REGIONS OF UNSATURATED PROPERTIES USING              UNSAT.........2800
C     THREE PARAMETER-UNSATURATED FLOW RELATIONSHIPS OF                  UNSAT.........2900
C     VAN GENUCHTEN(1980)                                                UNSAT.........3000
C        RESIDUAL SATURATION, SWRES, GIVEN IN UNITS {L**0}               UNSAT.........3100
C        PARAMETER, AA, GIVEN IN INVERSE PRESSURE UNITS {m*(s**2)/kg}    UNSAT.........3200
C        PARAMETER, VN, GIVEN IN UNITS {L**0}                            UNSAT.........3300
C                                                                        UNSAT.........3400
C      REAL SWRES,AA,VN,SWRM1,AAPVN,VNF,AAPVNN,DNUM,DNOM,SWSTAR           UNSAT.........3500
C   WARNING !!!!!!!!!!
C     THIS WATER RETENTION CURVE FUNCTION HAS BEEN MODIFIED SO THAT
C  1. ALL OF THE PARAMETERS ARE STORED IN THE PROGRAM RATHER THAN .INP FILE. THEN WE DICIDED TO
C LET IT MOVE BACK INTO .INP FILE BECAUSE 1. SUBROUTINE FOR SURFACE RESISTANCE ALSO REQUIRES
C SOIL CHARACTERISTICS PARAMETERS 
C  2. THE UNIT OF ALPHA IS [M-1] RATHER THAN [MS2KG-1]
      COMMON /UNSA/ SWRES1,AA1,VN1,SWRES2,AA2,VN2,SWRES3,DLAM3,PHICB3,
     1   SWRES4,DLAM4,PHICB4,PHIC0,ECTO
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2,
     2   DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
C	DOUBLE PRECISION SWRES,AA,VN,SWRM1,AAPVN,VNF,AAPVNN,DNUM,DNOM
C     1,SWSTAR
C        DOUBLE PRECISION PHIC0
C        DATA PMM/-5.D9/
C        SAVE PMM
C                                                                       UNSAT.........3700
C       DATA FOR REGION 1:                                              UNSAT.........3800
C       THIS DATA IS FOR 7C SAND, OBTAINED BY EVAPORATION PROCESS
C       CKECK FILE WRC.GNUMERIC->7C FOR REFERENCE
C        DATA   SWRES1/0.1/,   AA1/15.E0/,   VN1/4.2E0/
C        SAVE SWRES1, AA1, VN1                                           UNSAT.........4000
CC       DATA FOR REGION 2:                                              UNSAT.........4100
C        DATA   SWRES2/0.06/,   AA2/15/,   VN2/9.2/
C        SAVE SWRES2, AA2, VN2                                            UNSAT.........4300
CC       DATA FOR REGION 3:
C
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -- UNSAT.........4400
C                                                                        UNSAT.........4500
C *** BECAUSE THIS ROUTINE IS CALLED OFTEN FOR UNSATURATED FLOW RUNS,    UNSAT.........4600
C *** EXECUTION TIME MAY BE SAVED BY CAREFUL CODING OF DESIRED           UNSAT.........4700
C *** RELATIONSHIPS USING ONLY INTEGER AND SINGLE PRECISION VARIABLES!   UNSAT.........4800
C *** RESULTS OF THE CALCULATIONS MUST THEN BE PLACED INTO DOUBLE        UNSAT.........4900
C *** PRECISION VARIABLES SW, DSWDP AND RELK BEFORE LEAVING              UNSAT.........5000
C *** THIS SUBROUTINE.                                                   UNSAT.........5100
C                                                                        UNSAT.........5200
C                                                                        UNSAT.........5300
C*********************************************************************** UNSAT.........5400
C*********************************************************************** UNSAT.........5500
C                                                                        UNSAT.........5600
C     SET PARAMETERS FOR CURRENT REGION, KREG                            UNSAT.........5700
      IF(KREG.EQ.0)THEN                                                   UNSAT.........5800
      SWRES=SWRES1                                                       UNSAT.........5900
      AA=AA1                                                             UNSAT.........6000
      VN=VN1                                                             UNSAT.........6100
      ELSEIF(KREG.EQ.1)THEN                                                           
      SWRES=SWRES2                                                       UNSAT.........6300
      AA=AA2                                                             UNSAT.........6400
      VN=VN2                                                             UNSAT.........6500
      ELSEIF(KREG.EQ.3)THEN
      DLAM=DLAM3
      PHICB=PHICB3
      SWRES=SWRES3
      ELSEIF(KREG.EQ.4)THEN
      DLAM=DLAM4   
      PHICB=PHICB4   
      SWRES=SWRES4
      ENDIF          
C  CHANGE THE PORE WATER PRESSURE (NEGATIVE) INTO CAPILLARY HEAD (POSITIVE) 
      PHIC=-PRES/9.8D3
      SI=SWRES*DLOG(PHIC0/PHIC)/DLOG(PHIC0)
      SWRMS1=1.D0-SI

C  USING VAN GENUCHTEN WATER RETENTION CURVE WITH FAYER EXTENTION
      IF (KREG.EQ.0.OR.EKRG.EQ.1)THEN
C                                                                        UNSAT.........6700
C                                                                        UNSAT.........6800
C*********************************************************************** UNSAT.........6900
C*********************************************************************** UNSAT.........7000
C.....SECTION (1):                                                       UNSAT.........7100
C     SW VS. PRES   (VALUE CALCULATED ON EACH CALL TO UNSAT)             UNSAT.........7200
C     CODING MUST GIVE A VALUE TO SATURATION, SW.                        UNSAT.........7300
C                                                                        UNSAT.........7400
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  UNSAT.........7500
C     THREE PARAMETER MODEL OF VAN GENUCHTEN(1980)                       UNSAT.........7600
C      SWRM1=1.E0-SWRES                                                   UNSAT.........7700
C      AAPVN=1.E0+(AA*(-PRES))**VN                                        UNSAT.........7800
C      VNF=(VN-1.E0)/VN                                                   UNSAT.........7900
C      AAPVNN=AAPVN**VNF                                                  UNSAT.........8000
C      S W   =   DBLE (SWRES+SWRM1/AAPVNN)                                UNSAT.........8100
      AAPVN=1.D0+(AA*PHIC)**VN
      VNF=(VN-1.D0)/VN                                                   UNSAT.........7900
      AAPVNN=AAPVN**VNF                                                  UNSAT.........8000
      SW=SI+SWRMS1/AAPVNN
C      IF(SW.GT.1.D0) SW=1.D0
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  UNSAT.........8200
C*********************************************************************** UNSAT.........8300
C*********************************************************************** UNSAT.........8400
C                                                                        UNSAT.........8500
C                                                                        UNSAT.........8600
C                                                                        UNSAT.........8700
C                                                                        UNSAT.........8800
C                                                                        UNSAT.........8900
C                                                                        UNSAT.........9000
      IF(IUNSAT-2) 600,1200,1800                                         UNSAT.........9100
C*********************************************************************** UNSAT.........9200
C*********************************************************************** UNSAT.........9300
C.....SECTION (2):                                                       UNSAT.........9400
C     DSWDP VS. PRES, OR DSWDP VS. SW   (CALCULATED ONLY WHEN IUNSAT=1)  UNSAT.........9500
C     CODING MUST GIVE A VALUE TO DERIVATIVE OF SATURATION WITH          UNSAT.........9600
C     RESPECT TO PRESSURE, DSWDP.                                        UNSAT.........9700
C                                                                        UNSAT.........9800
  600 CONTINUE                                                           UNSAT.........9900
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  UNSAT........10000
C      DNUM=AA*(VN-1.E0)*SWRM1*(AA*(-PRES))**(VN-1.E0)                    UNSAT........10100
C	DNUM=AA*(VN-1.D0)*SWRMS1*(AA*(-PRES)/9.8D3)**(VN-1.D0)
C      DNUM=AA*(VN-1.D0)*SWRMS1*(AA*(-PRES)/9.8D3)**(VN-1.D0)/9.8D3
      DNUM=AA*(1.D0-VN)*SWRMS1*(AA*PHIC)**(VN-1.D0)
C      DSIDP=-SWRES/LOG(-PHIC0/9.8D3)/PRES
      DSIDP=-SWRES/LOG(PHIC0)/PHIC
      DNOM=AAPVN*AAPVNN                                                  UNSAT........10200
C      D S W D P   =   DBLE (DNUM/DNOM)                                   UNSAT........10300
C      HERE DSWDP=DSW/DPHIC * DPHIC/DP AND DPHIC/DP=-/9800
	DSWDP = ( -DSIDP+DSIDP/AAPVNN-DNUM/DNOM)/9.8D3
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  UNSAT........10400
      GOTO 1800                                                          UNSAT........10500
C*********************************************************************** UNSAT........10600
C*********************************************************************** UNSAT........10700
C                                                                        UNSAT........10800
C                                                                        UNSAT........10900
C                                                                        UNSAT........11000
C                                                                        UNSAT........11100
C                                                                        UNSAT........11200
C                                                                        UNSAT........11300
C*********************************************************************** UNSAT........11400
C*********************************************************************** UNSAT........11500
C.....SECTION (3):                                                       UNSAT........11600
C     RELK VS. P, OR RELK VS. SW   (CALCULATED ONLY WHEN IUNSAT=2)       UNSAT........11700
C     CODING MUST GIVE A VALUE TO RELATIVE PERMEABILITY, RELK.           UNSAT........11800
C                                                                        UNSAT........11900
 1200 CONTINUE                                                           UNSAT........12000
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  UNSAT........12100
C     GENERAL RELATIVE PERMEABILITY MODEL FROM VAN GENUCHTEN(1980)       UNSAT........12200
C      SWSTAR=(SW-SWRES)/SWRM1                                            UNSAT........12300
C THE FOLLOWING APPROACH MAY NOT BE CORRECT. JUST TRY TO USE THE ORIGINAL
C EQUATION 
C      SWSTAR=(SW-SI)/SWRMS1
C WARNING: USING SWSTAR=(SW-SI)/SWRMS1 TO CALCULATE EFFECTIVE SATURATION IS NOT CORRECT WHEN
C SW IS CALCULATED BY FAYER RETENTION CURVE BECAUSE SW CAN GO TO NEGATIVE IN THAT CASE. 
C THE APPROPRICATE WAY IS TO USE 1.D0/AAPVNN
C THROUGH THIS APPROACH, IT IS ASSUMED THAT LIQUID WATER MOVEMENT IS INDUCED BY FREE WATER
C MOVEMENT THAT FORMS THE MENISCI IN BETWEEN THE PORE SPACE, THE WATER BELOW RESIDUAL IS 
C JUST FILM WATER THAT IS BOUNDED BY VAN DER WAAL FORCE
C    SEE RELATIVEK.SAGE FOR REFERENCE
      SWSTAR=1.D0/AAPVNN
      R E L K   =   DBLE (SQRT(SWSTAR)*                                  UNSAT........12400
     1                   (1.D0-(1.D0-SWSTAR**(1.D0/VNF))**(VNF))**2.D0)  UNSAT........12500

C	IF (RELK.LT.1D-20) RELK=0.D0
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  UNSAT........12600
C                                                                        UNSAT........12700
C*********************************************************************** UNSAT........12800
C*********************************************************************** UNSAT........12900
C                                                                        UNSAT........13000
C                                                                        UNSAT........13100
C                                                                        UNSAT........13200
C                                                                        UNSAT........13300
C                                                                        UNSAT........13400
C                                                                        UNSAT........13500


C USING BROOKES AND COREY WATER RETENTION CURVE SEE PAGE 143 OF THE BLUEBOOK
      ELSEIF(KREG.EQ.3.OR.KREG.EQ.4)THEN
       IF (PHIC.LE.PHICB)THEN
        SW=1.D0
        DSWDP=0.D0
        RELK=1.D0
       ELSEIF (PHIC.GT.PHICB)THEN
C       (E)FFECTIVE (S)ATURATION
        SE=(PHICB/PHIC)**DLAM
C       (S)ATURATION
        SW=SWRMS1*SE+SI
C       WHEN IUNSAT=1 DERIVATIVE OF SATURATION WITH RESPECTIVE TO PHI (PORE WHATER PRESSURE) IS
C       REQUIRED
         IF (IUNSAT.EQ.1)THEN
          DSIDP=-SWRES/LOG(PHIC0)/PHIC
          DSWDP=(-DSIDP+DSIDP*SE+DLAM*SWRMS1*SE/PHIC)/9.8D3
C         WHEN IUNSAT=2 RELATIVE HYDRAULIC CONDUCTIVITY IS REQUIRED. SEE MUALEM PAPER, PAGE 153
C         AND PAGE 143 OF THE BLUEBOOK FOR REFERENCE
C         HERE THE RELATIVE K EQUATION BY FAYER IS NOT USED BECAUSE WE STRICTLY ASSUME RELATIVE K 
C         IS INDUCED BY MOVEABLE WATER RATHER THAN BOUNDED WATER
         ELSEIF(IUNSAT.EQ.2)THEN
C         USE ACTUAL SATURATION AS MENISCUS PORES SEE PAGE 170, FAYER (1995)
C         AND GRANSANDU1.NB IN MATHEMATICA AND RELATIVE K IN SAGE
          IF (MFT.EQ.2)THEN
C         TERM1 IS NOT NEEDED SEE PAGE 170
C          ZETA=2.D0*SURFT/RHOW0/GVA
          DLAMP1=DLAM+1.D0
          DLAM1P1=DLAM*DLAMP1
          DLAMP12=DLAMP1**2.D0
          DLPHIC0=DLOG(PHIC0)
          DLPHICB=DLOG(PHICB)
          DLPHIC =DLOG(PHIC)
          SE0=(PHICB/PHIC0)**DLAM
C          TERM1=ZETA/DLAMP12/DLPHIC0
          TERM2=DLAM*DLAMP1*DLPHIC0


C          GAMC=TERM1*SE/PHIC*(TERM2+SWRES*(-1+DLAMP12/SE-DLAM*DLAMP1*(DLPHIC0-DLPHIC)))
C         TERM1 IS CROSSED OUT IN ALL OF THE GAMAS
        GAMC=SE/PHIC*(TERM2+SWRES*(-1.D0+DLAMP12/SE-
     1        (TERM2-DLAM1P1*DLPHIC)))
        GAM0=SE0/PHIC0*(TERM2+SWRES*(-1.D0+DLAMP12/SE0))
        GAMB=(TERM2+SWRES*(-1.D0+DLAMP12-(TERM2-DLAM1P1*DLPHICB)))/PHICB
        RELK=SW**ECTO*((GAMC-GAM0)/(GAMB-GAM0) )**2.D0
C         USE EFFECTIVE SATURATION AS MENISCUS PORES
          ELSE
          RELK=SE**(2.D0+2.D0/DLAM+ECTO)          
          ENDIF
         ENDIF  !IUNSAT
        ENDIF   !PHIC AND PHICB
      ENDIF     !KREG
 1800 RETURN                                                             UNSAT........13600
C                                                                        UNSAT........13700
      END                                                                UNSAT........13800



C SUBROUTINE PERFILM IS TO CALCULATE THE SATURATED PERMEABILITY (M2) OF THE SOIL. IT IS A FUNCTION OF TEMPER
C ONLY BUT AT THIS STAGE WE ASSUME IT IS ONLY A FUNCTION OF INITIAL TEMPERATURE SEE PAGE 165
      SUBROUTINE PERFILM (SPF,RPF,POR,TPT,PRES,SWG,KREG,MFT)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2,
     2   DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
      COMMON /FILMFLOW/ CORF,AGR,SWM3,SWM4,PHICM,ASVL
C     ZETA -- =2 SIGMA / ROWH0/G WHERE SIGMA IS 0.072 J/M2 SURFACE TENTION
      DOUBLE PRECISION BP,ZETA
      DATA BP/3.00061397378356D-24/, ZETA/1.46789D-5/
      SAVE BP,ZETA
C.....MFT=1, FILM TRANSPORT IS ENABLED BASED ON TOKUNAKA (2009) AND ZHANG(2010) 
      IF (MFT.EQ.1)THEN
C   A PARAMETER IN B SEE PAGE 165
C     BP=2.D0**5.D-1*PI**2*(RELPW*PERMVAC/2.D0/SURFT)**1.5*(BOTZ/ECECTR)**3
C     B=BP*(TPT)**3.D0
C     NOW ASSUMING FILM TEMPERATURE IS CONSTANT
      B=BP*(298.15D0)**3.D0
C     (S)ATURATED (P)ERMEABILITY DUE TO (F)ILM FLOW (SPF) [M2]
      SPF=CORF*B*(1-POR)*(2*AGR)**5.D-1

      IF(PRES.LE.0)THEN
C     CAPILLARY PRESSURE HEAD
      PHIC=-PRES/RHOW0/GVA
C    （R)ELATIVE (P)ERMEABILITY DUE TO (F)ILM FLOW (RPF) [-]
      RPF=(1+AGR*2.D0*PHIC/ZETA)**(-1.5D0)
      ELSE
      RPF=1.D0
      ENDIF
C.....MFT=3, FILM TRANSPORT IS ENABLED BASED ON LEBEAU AND KONRAD (2010) SEE PAGE 178-179
      ELSEIF (MFT.EQ.3) THEN
      IF (KREG.EQ.3)THEN
      SWM=SWM3
      ELSEIF (KREG.EQ.4)THEN
      SWM=SWM4
      ENDIF
C.....EFFECTIVE DIAMETER 
      ED=6.D0*(1-POR)* (-ASVL/(6.D0*PI*RHOW0*GVA*PHICM))**(1.D0/3.D0)
     1 /POR/SWM
C.....FILM THICKNESS (WARNING) THIS IS NOT THE FULL PART
      DEL=(RELPW*PERMVAC/(2*RHOW0*GVA))**.5D0*(PI*BOTZC*298.15/ELECTRC)
      SPF=4.D0*(1-POR)*DEL**3.D0/PI/ED

C.....RELATIVE PERMEABILITY DUE TO FILM FLOW
      IF (PRES.LT.0)THEN
C     CAPILLARY PRESSURE HEAD
      PHIC=-PRES/RHOW0/GVA           
      RPF=(1-SWG)*PHIC**(-1.5D0)
C.....FOR CHECKING THE SPF AND RPF VALUE SEE PAGE 179 AND RELATIVEK.SAGE
C      IF (PHIC.GT.1.D3)THEN
C        REAPL=SPF*RPF
C      ENDIF
      ELSEIF (PRES.GE.0)THEN
      RPF=0.D0
      ENDIF
      ENDIF
      RETURN 
      END

C STORE THE INITIAL CONSTANTS
      SUBROUTINE INITCONS()
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      COMMON /PARAMS/ COMPFL,COMPMA,DRWDU,CW,CS,RHOS,SIGMAW,SIGMAS,
     1   RHOW0,URHOW0,VISC0,PRODF1,PRODS1,PRODF0,PRODS0,CHI1,CHI2,
     2   DVIDU,RELPW,PERMVAC,SURFT,PI,ELECTRC,BOTZC,CL,CA,DMAIR,
     3   RC,SATM,STM,GVA,WMW
C     (VAC)CUM (PERM)EABILITY [PERMFS] [C2J-1M-1 OR F/M OR S4A2/KG/M3] SEE PAGE 165
       PERMVAC=8.854D-12
C     (R)ELATIVE (PERM)EABILITY OF (W)ATER (RELPW)  [-]
       RELPW=78.54D0
C     (SURF)ACE (T)ENTION AT 20 CELSIUST [J/M2 OR N/M]
       SURFT=0.072D0
C      PI
       PI=3.141592653589793D0
C      (ELECTR)ON (C)HARGE   (ELECTRC) [COULOMBS OR AS]
       ELECTRC=1.602D-19
C      (BOTZ)MANN (C)ONSTANT (BOTZC)  [J/K]
       BOTZC=1.381D-23
C      HEAT (C)APACITY OF (L)IQUID WATER (CL) [J/KG/K]
       CL=4.186D3
C      HEAT (C)APACITY OF WATER VA(P)OR (CP) [J/KG/K]
       CP=2.0D3
C      HEAT (C)APACITY OF (A)IR (CA)  [J/KG/K]
       CA=1.01D3
C      (M)OLECULAR WEIGHT OF (AIR) (DMAIR) 
       DMAIR=2.897D-2
C      (C)ONSTANT OF IDEALIZED GAS (RC) [J/MOL/K]
       RC=8.314472D+0
C      (S)TANDARD (ATM)OSPHERE PRESSURE (SATM) [PA]
       SATM=1.01325D5
C      (M)OLECULAR WEIGHT OF (S)AL(T) (MST)
       STM=5.85D-2
C      (G)RAVITIONAL (A)CCERLATION
       GVA=9.8D0
C      (W)ATER (M)OLECULAR (W)EIGHT
       WMW=1.8D-2
       RETURN
       END





C SUTRA.5.6BUILD0007....CHANGE THE ET OUTPUT AS TIMESTEP BASIS. THIS IS NEEDED BECAUSE EACH OUTPUT OF ET IS NEED FOR EVAPORATION ANALYSIS.
C SUTRA.5.6BUILD0008....20/09/2012....THIS IS DEVELOPED TO ADJUST THE SURFACE AREA USED FOR EVAPORATION WHEN USING CIRCULAR COORDINATES.
C                                     IT WAS FOUND THAT THE SEPARATING LINES THAT DEVIDE ONE ELEMENT INTO DIFFERENT CELLS ARE NOT ALWAYS IN
C                                     THE MIDDLE OF THE ELEMENTS. THIS PHENOMENON IS INDUCED BY USING GAUSSIAN QUADRATURE TO CALCULATE THE 
C                                     VOLUME.
C SUTRA.5.6BUILD0009...26/09/2012....QVX AND QVY ARE INITIALIZED TO BE ZERO BEFORE THE TIME LOOP. THIS MODIFICATION IS REQUIRED BECAUSE THE
C                                    BCTIME IS NO LONGER CALLED AT THE FIRST TIME STEP, SO THE INITIALIZATION OF THE QVX AND QVY IS NOT USED
C                                    AT THE BEGINNING
C SUTRA5.6BUILD0010...27/09/2012....IT WAS FOUND THAT THE METHOD OF SINK AREA HAS TO BE CHANGED BASED ON THE GEOMETRY OF THE DOMAIN. THEREFORE,
C                                   HAS BEEN FACTORED OUT AS SINGLE FILE SO THAT SUTRA5.6BUILD0010 HAS NO HARD CODING IN IT.
C SUTRA5.6BUILD0011...30/09/2012.... THE PROBLEM OF GRAVITY HAS BEEN DEBUGGED
C SUTRA5.6BUILD0012...17/09/2012... ADD A TEMPERATURE INPUT ON THE SIDE OF THE 1-D HEAT BALANCE EQUATION. THIS IS USEFUL ONCE THE HEAT LOSS ON
C                                    THE SIDE IS INSULATED
C SUTRA5.6BUILD0013...29/01/2013.....FIX THE BUG OF NO SCF INPUT FOR 2D CASE.
C SUTRA5.6BUILD0015...29/01/2013.....VERIFIIED THE WATER VAPOR CALCULATION PROCESS
C SUTRA5.6BUILD0016...01/02/2013.....ADD HEAT CONDUCTIVITY FROM CHUNG AND HORTON (1987), THE ENHANCEMENT FACTOR HAS BEEN IMPOSED ON BOTH TEMPERATURE
C                                     TERM AND NONE- TEMPERATURE TERM
C SUTRA5.6BUILD0018...12/02/2013....FIND A BUG IN  HR  = +SCF*CA*SATM*DMAIR*RC/TSDK/TMAK/RHVS(I)/XX(I). IT SHOULD BE  HR  = +SCF*CA*SATM*DMAIR*RC*TSDK/TMAK/RHVS(I)/XX(I)
C SUTRA5.7BUILD0001...14/02/2013....ADD SUBROUTINE HEATBALANCE, OUTHEAT AND THE HEATBALANCE IS WELL CALIBRATED ALL THE WRITE SPACE HAS BEEN DELETED
C SUTRA5.8UILD00001...03/03/2013....THE PARAMETERS OF ENHANCEMENT FACTOR IS ADDED IN THE DATASET 13K
C SUTRA5.8UILD00002...19/03/2013....THE HYPERGEOMETRIC FUNCTION IS ADDED FOR EVAPORATION CASE
C SUTRA5.9            20/03/2013....UNSAT COMES BACK INTO SUTRA MAIN PROGRAM. THE REASON IS SOIL CHARACTERISTIC PARAMETERS ARE ALSO NEED BY OTHER SUB
C SUTRA6.0            29/03/2013....THE ECCENTRICITY AND TORTUOSITY IN RELATIVE K HAS BEEN LISTED IN INP FILE.
C SUTRA6.1             2/04/2013....ADD INPUT FOR FILM FLOW EQUATION SO THAT THE LIQUID WATER FLOW DUE TO FILM FLOW IS INCORPORATED
C SUTRA6.1BUILD0002... 2/04/2013....DELETE SEVERAL LINES IN SUBROUTINE PTRSET
C SUTRA6.1BUILD0005    4/04/2013....MORE OUTPUT IS ADDED IN FORT48
C SUTRA6.2BUILD0001    9/04/2013....INPUT THE RELATIVE K BASED ON FAYER'S MODEL, A EXTRA OUTPUT IS ADDED TO WORKOUT THE HYDRAULIC K IN ONE ELEMENT
C SUTRA6.3            12/04/2013....THE RELATIVE K DUE TO FILM FLOW HAS BEEN ADDED. SOME MINOR MISTAKE FOR KREG HAS BEEN CORRECTED.
C SUTRA6.3BUILD0002   12/04/2013....CHANGE THE MFT CRITERIA FROM AND TO OR. A SERIOUS BUG IS FIXED 
C SUTRA6.4            29/07/2013....CHANGE THE RESISTANCE MODEL IN ACCORDANCE TO THE FORMULATION BY PAPER 2
C                                   NOW THE UPDATES HAS BEEN TRACKED BY MERCURIAL
C LET ME TRY WHETHER THERE IS ANY DIFFERENCE.
